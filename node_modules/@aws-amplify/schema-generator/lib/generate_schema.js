import { EmptySchemaError, InvalidSchemaError, TypescriptDataSchemaGenerator, } from '@aws-amplify/graphql-schema-generator';
import fs from 'fs/promises';
import { AmplifyUserError } from '@aws-amplify/platform-core';
/**
 * Schema generator class.
 */
export class SchemaGenerator {
    generate = async (props) => {
        const dbConfig = parseDatabaseUrl(props.connectionUri.value);
        try {
            const schema = await TypescriptDataSchemaGenerator.generate({
                ...dbConfig,
                connectionUriSecretName: props.connectionUri.secretName,
                ...(props.sslCert &&
                    props.sslCert.secretName && {
                    sslCertificateSecretName: props.sslCert.secretName,
                    sslCertificate: props.sslCert.value,
                }),
            });
            await fs.writeFile(props.out, schema);
        }
        catch (err) {
            if (err instanceof EmptySchemaError ||
                err instanceof InvalidSchemaError) {
                throw new AmplifyUserError('DatabaseSchemaError', {
                    // the message already contains descriptive error.
                    message: err.message,
                    resolution: 'Check the database schema.',
                }, err);
            }
            const databaseError = err;
            if (databaseError.code === 'ETIMEDOUT') {
                throw new AmplifyUserError('DatabaseConnectionError', {
                    message: `Unable to connect to the database at ${dbConfig.host}:${dbConfig.port}. `,
                    resolution: 'Check if the credentials are correct. Also, check if the database is running and accessible from the network.',
                }, databaseError);
            }
            throw err;
        }
    };
}
const DEFAULT_ENGINE = 'mysql';
/**
 * Error for database connection failures.
 * This class is intended to be used for casting database connection errors.
 * Do not create instances of this class directly.
 */
class DatabaseConnectError extends Error {
    code;
    /**
     * Creates database connection error.
     */
    constructor(code) {
        super(`Database connection error: ${code}`);
        this.code = code;
    }
}
/**
 * Parses database URL into a configuration object.
 */
export const parseDatabaseUrl = (databaseUrl) => {
    try {
        const parsedDatabaseUrl = new URL(databaseUrl);
        const { username: encodedUsername, password: encodedPassword, hostname: encodedHost, } = parsedDatabaseUrl;
        const username = decodeURIComponent(encodedUsername);
        const password = decodeURIComponent(encodedPassword);
        const host = decodeURIComponent(encodedHost);
        const database = decodeURIComponent(parsedDatabaseUrl?.pathname?.slice(1));
        // Default engine is MySQL
        const engine = constructDBEngine(parsedDatabaseUrl?.protocol?.slice(0, -1) ?? DEFAULT_ENGINE);
        const port = parsedDatabaseUrl?.port
            ? parseInt(parsedDatabaseUrl?.port, 10)
            : getDefaultPort(engine);
        const config = {
            engine,
            username,
            password,
            database,
            host,
            port,
        };
        const missingParts = Object.keys(config).filter((part) => !config[part]);
        if (missingParts.length > 0) {
            throw new AmplifyUserError('DatabaseUrlParseError', {
                message: `One or more parts of the database URL is missing. Missing [${missingParts.join(', ')}].`,
                resolution: 'Ensure the database URL follows the pattern "[mysql|postgresql]://username:password@hostname:port/database".',
            });
        }
        return config;
    }
    catch (err) {
        const error = err;
        throw new AmplifyUserError('DatabaseUrlParseError', {
            message: `Unable to parse the database URL. ${error.message}`,
            resolution: 'Check if the database URL is correct and accessible.',
        }, error);
    }
};
const constructDBEngine = (engine) => {
    switch (engine) {
        case 'mysql':
            return 'mysql';
        case 'postgresql':
        case 'postgres':
            return 'postgresql';
        default:
            throw new AmplifyUserError('DatabaseUnsupportedEngineError', {
                message: `Unsupported database engine: ${engine}`,
                resolution: 'Ensure that database URL specifies supported engine. Supported engines are "mysql", "postgresql", "postgres".',
            });
    }
};
const getDefaultPort = (engine) => {
    switch (engine) {
        case 'mysql':
            return 3306;
        case 'postgresql':
            return 5432;
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGVfc2NoZW1hLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2dlbmVyYXRlX3NjaGVtYS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsZ0JBQWdCLEVBQ2hCLGtCQUFrQixFQUNsQiw2QkFBNkIsR0FDOUIsTUFBTSx1Q0FBdUMsQ0FBQztBQUMvQyxPQUFPLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDN0IsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFvQjlEOztHQUVHO0FBQ0gsTUFBTSxPQUFPLGVBQWU7SUFDMUIsUUFBUSxHQUFHLEtBQUssRUFBRSxLQUE0QixFQUFFLEVBQUU7UUFDaEQsTUFBTSxRQUFRLEdBQUcsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUU3RCxJQUFJLENBQUM7WUFDSCxNQUFNLE1BQU0sR0FBRyxNQUFNLDZCQUE2QixDQUFDLFFBQVEsQ0FBQztnQkFDMUQsR0FBRyxRQUFRO2dCQUNYLHVCQUF1QixFQUFFLEtBQUssQ0FBQyxhQUFhLENBQUMsVUFBVTtnQkFDdkQsR0FBRyxDQUFDLEtBQUssQ0FBQyxPQUFPO29CQUNmLEtBQUssQ0FBQyxPQUFPLENBQUMsVUFBVSxJQUFJO29CQUMxQix3QkFBd0IsRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLFVBQVU7b0JBQ2xELGNBQWMsRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUs7aUJBQ3BDLENBQUM7YUFDTCxDQUFDLENBQUM7WUFDSCxNQUFNLEVBQUUsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUN4QyxDQUFDO1FBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztZQUNiLElBQ0UsR0FBRyxZQUFZLGdCQUFnQjtnQkFDL0IsR0FBRyxZQUFZLGtCQUFrQixFQUNqQyxDQUFDO2dCQUNELE1BQU0sSUFBSSxnQkFBZ0Is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UUFDYixNQUFNLEtBQUssR0FBRyxHQUFZLENBQUM7UUFDM0IsTUFBTSxJQUFJLGdCQUFnQixDQUN4Qix1QkFBdUIsRUFDdkI7WUFDRSxPQUFPLEVBQUUscUNBQXFDLEtBQUssQ0FBQyxPQUFPLEVBQUU7WUFDN0QsVUFBVSxFQUFFLHNEQUFzRDtTQUNuRSxFQUNELEtBQUssQ0FDTixDQUFDO0lBQ0osQ0FBQztBQUNILENBQUMsQ0FBQztBQUVGLE1BQU0saUJBQWlCLEdBQUcsQ0FBQyxNQUFjLEVBQWEsRUFBRTtJQUN0RCxRQUFRLE1BQU0sRUFBRSxDQUFDO1FBQ2YsS0FBSyxPQUFPO1lBQ1YsT0FBTyxPQUFPLENBQUM7UUFDakIsS0FBSyxZQUFZLENBQUM7UUFDbEIsS0FBSyxVQUFVO1lBQ2IsT0FBTyxZQUFZLENBQUM7UUFDdEI7WUFDRSxNQUFNLElBQUksZ0JBQWdCLENBQ3hCLGdDQUFnQyxFQUNoQztnQkFDRSxPQUFPLEVBQUUsZ0NBQWdDLE1BQU0sRUFBRTtnQkFDakQsVUFBVSxFQUNSLCtHQUErRzthQUNsSCxDQUNGLENBQUM7SUFDTixDQUFDO0FBQ0gsQ0FBQyxDQUFDO0FBRUYsTUFBTSxjQUFjLEdBQUcsQ0FBQyxNQUFpQixFQUFVLEVBQUU7SUFDbkQsUUFBUSxNQUFNLEVBQUUsQ0FBQztRQUNmLEtBQUssT0FBTztZQUNWLE9BQU8sSUFBSSxDQUFDO1FBQ2QsS0FBSyxZQUFZO1lBQ2YsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztBQUNILENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEVtcHR5U2NoZW1hRXJyb3IsXG4gIEludmFsaWRTY2hlbWFFcnJvcixcbiAgVHlwZXNjcmlwdERhdGFTY2hlbWFHZW5lcmF0b3IsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9ncmFwaHFsLXNjaGVtYS1nZW5lcmF0b3InO1xuaW1wb3J0IGZzIGZyb20gJ2ZzL3Byb21pc2VzJztcbmltcG9ydCB7IEFtcGxpZnlVc2VyRXJyb3IgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5cbmV4cG9ydCB0eXBlIFNjaGVtYUdlbmVyYXRvckNvbmZpZyA9IHtcbiAgY29ubmVjdGlvblVyaToge1xuICAgIHNlY3JldE5hbWU6IHN0cmluZztcbiAgICB2YWx1ZTogc3RyaW5nO1xuICB9O1xuICBzc2xDZXJ0Pzoge1xuICAgIHNlY3JldE5hbWU6IHN0cmluZztcbiAgICB2YWx1ZTogc3RyaW5nO1xuICB9O1xuICBvdXQ6IHN0cmluZztcbn07XG5cbnR5cGUgQW1wbGlmeUdlbmVyYXRlU2NoZW1hRXJyb3IgPVxuICB8ICdEYXRhYmFzZUNvbm5lY3Rpb25FcnJvcidcbiAgfCAnRGF0YWJhc2VTY2hlbWFFcnJvcidcbiAgfCAnRGF0YWJhc2VVbnN1cHBvcnRlZEVuZ2luZUVycm9yJ1xuICB8ICdEYXRhYmFzZVVybFBhcnNlRXJyb3InO1xuXG4vKipcbiAqIFNjaGVtYSBnZW5lcmF0b3IgY2xhc3MuXG4gKi9cbmV4cG9ydCBjbGFzcyBTY2hlbWFHZW5lcmF0b3Ige1xuICBnZW5lcmF0ZSA9IGFzeW5jIChwcm9wczogU2NoZW1hR2VuZXJhdG9yQ29uZmlnKSA9PiB7XG4gICAgY29uc3QgZGJDb25maWcgPSBwYXJzZURhdGFiYXNlVXJsKHByb3BzLmNvbm5lY3Rpb25VcmkudmFsdWUpO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHNjaGVtYSA9IGF3YWl0IFR5cGVzY3JpcHREYXRhU2NoZW1hR2VuZXJhdG9yLmdlbmVyYXRlKHtcbiAgICAgICAgLi4uZGJDb25maWcsXG4gICAgICAgIGNvbm5lY3Rpb25VcmlTZWNyZXROYW1lOiBwcm9wcy5jb25uZWN0aW9uVXJpLnNlY3JldE5hbWUsXG4gICAgICAgIC4uLihwcm9wcy5zc2xDZXJ0ICYmXG4gICAgICAgICAgcHJvcHMuc3NsQ2VydC5zZWNyZXROYW1lICYmIHtcbiAgICAgICAgICAgIHNzbENlcnRpZmljYXRlU2VjcmV0TmFtZTogcHJvcHMuc3NsQ2VydC5zZWNyZXROYW1lLFxuICAgICAgICAgICAgc3NsQ2VydGlmaWNhdGU6IHByb3BzLnNzbENlcnQudmFsdWUsXG4gICAgICAgICAgfSksXG4gICAgICB9KTtcbiAgICAgIGF3YWl0IGZzLndyaXRlRmlsZShwcm9wcy5vdXQsIHNjaGVtYSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoXG4gICAgICAgIGVyciBpbnN0YW5jZW9mIEVtcHR5U2NoZW1hRXJyb3IgfHxcbiAgICAgICAgZXJyIGluc3RhbmNlb2YgSW52YWxpZFNjaGVtYUVycm9yXG4gICAgICApIHtcbiAgICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3I8QW1wbGlmeUdlbmVyYXRlU2NoZW1hRXJyb3I+KFxuICAgICAgICAgICdEYXRhYmFzZVNjaGVtYUVycm9yJyxcbiAgICAgICAgICB7XG4gICAgICAgICAgICAvLyB0aGUgbWVzc2FnZSBhbHJlYWR5IGNvbnRhaW5zIGRlc2NyaXB0aXZlIGVycm9yLlxuICAgICAgICAgICAgbWVzc2FnZTogZXJyLm1lc3NhZ2UsXG4gICAgICAgICAgICByZXNvbHV0aW9uOiAnQ2hlY2sgdGhlIGRhdGFiYXNlIHNjaGVtYS4nLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgZXJyLFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgY29uc3QgZGF0YWJhc2VFcnJvciA9IGVyciBhcyBEYXRhYmFzZUNvbm5lY3RFcnJvcjtcbiAgICAgIGlmIChkYXRhYmFzZUVycm9yLmNvZGUgPT09ICdFVElNRURPVVQnKSB7XG4gICAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yPEFtcGxpZnlHZW5lcmF0ZVNjaGVtYUVycm9yPihcbiAgICAgICAgICAnRGF0YWJhc2VDb25uZWN0aW9uRXJyb3InLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIG1lc3NhZ2U6IGBVbmFibGUgdG8gY29ubmVjdCB0byB0aGUgZGF0YWJhc2UgYXQgJHtkYkNvbmZpZy5ob3N0fToke2RiQ29uZmlnLnBvcnR9LiBgLFxuICAgICAgICAgICAgcmVzb2x1dGlvbjpcbiAgICAgICAgICAgICAgJ0NoZWNrIGlmIHRoZSBjcmVkZW50aWFscyBhcmUgY29ycmVjdC4gQWxzbywgY2hlY2sgaWYgdGhlIGRhdGFiYXNlIGlzIHJ1bm5pbmcgYW5kIGFjY2Vzc2libGUgZnJvbSB0aGUgbmV0d29yay4nLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgZGF0YWJhc2VFcnJvcixcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHRocm93IGVycjtcbiAgICB9XG4gIH07XG59XG5cbmV4cG9ydCB0eXBlIFNRTEVuZ2luZSA9ICdteXNxbCcgfCAncG9zdGdyZXNxbCc7XG5jb25zdCBERUZBVUxUX0VOR0lORSA9ICdteXNxbCc7XG5cbmV4cG9ydCB0eXBlIFNRTERhdGFTb3VyY2VDb25maWcgPSB7XG4gIGVuZ2luZTogU1FMRW5naW5lO1xuICB1c2VybmFtZTogc3RyaW5nO1xuICBwYXNzd29yZDogc3RyaW5nO1xuICBob3N0OiBzdHJpbmc7XG4gIGRhdGFiYXNlOiBzdHJpbmc7XG4gIHBvcnQ6IG51bWJlcjtcbn07XG5cbi8qKlxuICogRXJyb3IgZm9yIGRhdGFiYXNlIGNvbm5lY3Rpb24gZmFpbHVyZXMuXG4gKiBUaGlzIGNsYXNzIGlzIGludGVuZGVkIHRvIGJlIHVzZWQgZm9yIGNhc3RpbmcgZGF0YWJhc2UgY29ubmVjdGlvbiBlcnJvcnMuXG4gKiBEbyBub3QgY3JlYXRlIGluc3RhbmNlcyBvZiB0aGlzIGNsYXNzIGRpcmVjdGx5LlxuICovXG5hYnN0cmFjdCBjbGFzcyBEYXRhYmFzZUNvbm5lY3RFcnJvciBleHRlbmRzIEVycm9yIHtcbiAgLyoqXG4gICAqIENyZWF0ZXMgZGF0YWJhc2UgY29ubmVjdGlvbiBlcnJvci5cbiAgICovXG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IGNvZGU/OiBzdHJpbmcpIHtcbiAgICBzdXBlcihgRGF0YWJhc2UgY29ubmVjdGlvbiBlcnJvcjogJHtjb2RlfWApO1xuICB9XG59XG5cbi8qKlxuICogUGFyc2VzIGRhdGFiYXNlIFVSTCBpbnRvIGEgY29uZmlndXJhdGlvbiBvYmplY3QuXG4gKi9cbmV4cG9ydCBjb25zdCBwYXJzZURhdGFiYXNlVXJsID0gKGRhdGFiYXNlVXJsOiBzdHJpbmcpOiBTUUxEYXRhU291cmNlQ29uZmlnID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBwYXJzZWREYXRhYmFzZVVybCA9IG5ldyBVUkwoZGF0YWJhc2VVcmwpO1xuICAgIGNvbnN0IHtcbiAgICAgIHVzZXJuYW1lOiBlbmNvZGVkVXNlcm5hbWUsXG4gICAgICBwYXNzd29yZDogZW5jb2RlZFBhc3N3b3JkLFxuICAgICAgaG9zdG5hbWU6IGVuY29kZWRIb3N0LFxuICAgIH0gPSBwYXJzZWREYXRhYmFzZVVybDtcbiAgICBjb25zdCB1c2VybmFtZSA9IGRlY29kZVVSSUNvbXBvbmVudChlbmNvZGVkVXNlcm5hbWUpO1xuICAgIGNvbnN0IHBhc3N3b3JkID0gZGVjb2RlVVJJQ29tcG9uZW50KGVuY29kZWRQYXNzd29yZCk7XG4gICAgY29uc3QgaG9zdCA9IGRlY29kZVVSSUNvbXBvbmVudChlbmNvZGVkSG9zdCk7XG4gICAgY29uc3QgZGF0YWJhc2UgPSBkZWNvZGVVUklDb21wb25lbnQocGFyc2VkRGF0YWJhc2VVcmw/LnBhdGhuYW1lPy5zbGljZSgxKSk7XG4gICAgLy8gRGVmYXVsdCBlbmdpbmUgaXMgTXlTUUxcbiAgICBjb25zdCBlbmdpbmUgPSBjb25zdHJ1Y3REQkVuZ2luZShcbiAgICAgIHBhcnNlZERhdGFiYXNlVXJsPy5wcm90b2NvbD8uc2xpY2UoMCwgLTEpID8/IERFRkFVTFRfRU5HSU5FLFxuICAgICk7XG4gICAgY29uc3QgcG9ydCA9IHBhcnNlZERhdGFiYXNlVXJsPy5wb3J0XG4gICAgICA/IHBhcnNlSW50KHBhcnNlZERhdGFiYXNlVXJsPy5wb3J0LCAxMClcbiAgICAgIDogZ2V0RGVmYXVsdFBvcnQoZW5naW5lKTtcblxuICAgIGNvbnN0IGNvbmZpZyA9IHtcbiAgICAgIGVuZ2luZSxcbiAgICAgIHVzZXJuYW1lLFxuICAgICAgcGFzc3dvcmQsXG4gICAgICBkYXRhYmFzZSxcbiAgICAgIGhvc3QsXG4gICAgICBwb3J0LFxuICAgIH0gYXMgU1FMRGF0YVNvdXJjZUNvbmZpZztcblxuICAgIGNvbnN0IG1pc3NpbmdQYXJ0cyA9IChcbiAgICAgIE9iamVjdC5rZXlzKGNvbmZpZykgYXMgQXJyYXk8a2V5b2YgU1FMRGF0YVNvdXJjZUNvbmZpZz5cbiAgICApLmZpbHRlcigocGFydCkgPT4gIWNvbmZpZ1twYXJ0XSk7XG5cbiAgICBpZiAobWlzc2luZ1BhcnRzLmxlbmd0aCA+IDApIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yPEFtcGxpZnlHZW5lcmF0ZVNjaGVtYUVycm9yPihcbiAgICAgICAgJ0RhdGFiYXNlVXJsUGFyc2VFcnJvcicsXG4gICAgICAgIHtcbiAgICAgICAgICBtZXNzYWdlOiBgT25lIG9yIG1vcmUgcGFydHMgb2YgdGhlIGRhdGFiYXNlIFVSTCBpcyBtaXNzaW5nLiBNaXNzaW5nIFske21pc3NpbmdQYXJ0cy5qb2luKFxuICAgICAgICAgICAgJywgJyxcbiAgICAgICAgICApfV0uYCxcbiAgICAgICAgICByZXNvbHV0aW9uOlxuICAgICAgICAgICAgJ0Vuc3VyZSB0aGUgZGF0YWJhc2UgVVJMIGZvbGxvd3MgdGhlIHBhdHRlcm4gXCJbbXlzcWx8cG9zdGdyZXNxbF06Ly91c2VybmFtZTpwYXNzd29yZEBob3N0bmFtZTpwb3J0L2RhdGFiYXNlXCIuJyxcbiAgICAgICAgfSxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNvbmZpZztcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgY29uc3QgZXJyb3IgPSBlcnIgYXMgRXJyb3I7XG4gICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3I8QW1wbGlmeUdlbmVyYXRlU2NoZW1hRXJyb3I+KFxuICAgICAgJ0RhdGFiYXNlVXJsUGFyc2VFcnJvcicsXG4gICAgICB7XG4gICAgICAgIG1lc3NhZ2U6IGBVbmFibGUgdG8gcGFyc2UgdGhlIGRhdGFiYXNlIFVSTC4gJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICAgIHJlc29sdXRpb246ICdDaGVjayBpZiB0aGUgZGF0YWJhc2UgVVJMIGlzIGNvcnJlY3QgYW5kIGFjY2Vzc2libGUuJyxcbiAgICAgIH0sXG4gICAgICBlcnJvcixcbiAgICApO1xuICB9XG59O1xuXG5jb25zdCBjb25zdHJ1Y3REQkVuZ2luZSA9IChlbmdpbmU6IHN0cmluZyk6IFNRTEVuZ2luZSA9PiB7XG4gIHN3aXRjaCAoZW5naW5lKSB7XG4gICAgY2FzZSAnbXlzcWwnOlxuICAgICAgcmV0dXJuICdteXNxbCc7XG4gICAgY2FzZSAncG9zdGdyZXNxbCc6XG4gICAgY2FzZSAncG9zdGdyZXMnOlxuICAgICAgcmV0dXJuICdwb3N0Z3Jlc3FsJztcbiAgICBkZWZhdWx0OlxuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3I8QW1wbGlmeUdlbmVyYXRlU2NoZW1hRXJyb3I+KFxuICAgICAgICAnRGF0YWJhc2VVbnN1cHBvcnRlZEVuZ2luZUVycm9yJyxcbiAgICAgICAge1xuICAgICAgICAgIG1lc3NhZ2U6IGBVbnN1cHBvcnRlZCBkYXRhYmFzZSBlbmdpbmU6ICR7ZW5naW5lfWAsXG4gICAgICAgICAgcmVzb2x1dGlvbjpcbiAgICAgICAgICAgICdFbnN1cmUgdGhhdCBkYXRhYmFzZSBVUkwgc3BlY2lmaWVzIHN1cHBvcnRlZCBlbmdpbmUuIFN1cHBvcnRlZCBlbmdpbmVzIGFyZSBcIm15c3FsXCIsIFwicG9zdGdyZXNxbFwiLCBcInBvc3RncmVzXCIuJyxcbiAgICAgICAgfSxcbiAgICAgICk7XG4gIH1cbn07XG5cbmNvbnN0IGdldERlZmF1bHRQb3J0ID0gKGVuZ2luZTogU1FMRW5naW5lKTogbnVtYmVyID0+IHtcbiAgc3dpdGNoIChlbmdpbmUpIHtcbiAgICBjYXNlICdteXNxbCc6XG4gICAgICByZXR1cm4gMzMwNjtcbiAgICBjYXNlICdwb3N0Z3Jlc3FsJzpcbiAgICAgIHJldHVybiA1NDMyO1xuICB9XG59O1xuIl19