"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SpanMaker = void 0;
const util = require("node:util");
const uuid = require("uuid");
const util_1 = require("../../../util");
/**
 * Helper class to make spans around blocks of work
 *
 * Blocks are enclosed by a start and end message.
 * All messages of the span share a unique id.
 * The end message contains the time passed between start and end.
 */
class SpanMaker {
    definition;
    ioHelper;
    makeHelper;
    constructor(ioHelper, definition, makeHelper) {
        this.definition = definition;
        this.ioHelper = ioHelper;
        this.makeHelper = makeHelper;
    }
    async begin(a, b) {
        const span = new MessageSpan(this.ioHelper, this.definition, this.makeHelper);
        const startInput = parseArgs(a, b);
        const startMsg = startInput.message ?? `Starting ${this.definition.name} ...`;
        const startPayload = startInput.payload;
        await span.notify(this.definition.start.msg(startMsg, startPayload));
        return span;
    }
}
exports.SpanMaker = SpanMaker;
class MessageSpan {
    asHelper;
    definition;
    ioHelper;
    spanId;
    startTime;
    timingMsgTemplate;
    constructor(ioHelper, definition, makeHelper) {
        this.definition = definition;
        this.ioHelper = ioHelper;
        this.spanId = uuid.v4();
        this.startTime = new Date().getTime();
        this.timingMsgTemplate = '\nâœ¨  %s time: %ds\n';
        this.asHelper = makeHelper(this);
    }
    get defaults() {
        return this.asHelper.defaults;
    }
    async elapsedTime() {
        return this.time();
    }
    async timing(maker, message) {
        const duration = this.time();
        const timingMsg = message ? message : util.format(this.timingMsgTemplate, this.definition.name, duration.asSec);
        await this.notify(maker.msg(timingMsg, {
            duration: duration.asMs,
        }));
        return duration;
    }
    async notify(msg) {
        return this.ioHelper.notify(withSpanId(this.spanId, msg));
    }
    async end(x, y) {
        const duration = this.time();
        const endInput = parseArgs(x, y);
        const endMsg = endInput.message ?? util.format(this.timingMsgTemplate, this.definition.name, duration.asSec);
        const endPayload = endInput.payload;
        await this.notify(this.definition.end.msg(endMsg, {
            duration: duration.asMs,
            ...endPayload,
        }));
        return duration;
    }
    async requestResponse(msg) {
        return this.ioHelper.requestResponse(withSpanId(this.spanId, msg));
    }
    time() {
        const elapsedTime = new Date().getTime() - this.startTime;
        return {
            asMs: elapsedTime,
            asSec: (0, util_1.formatTime)(elapsedTime),
        };
    }
}
function parseArgs(first, second) {
    const firstIsMessage = typeof first === 'string';
    // When the first argument is a string or we have a second argument, then the first arg is the message
    const message = (firstIsMessage || second) ? first : undefined;
    // When the first argument is a string or we have a second argument,
    // then the second arg is the payload, otherwise the first arg is the payload
    const payload = (firstIsMessage || second) ? second : first;
    return {
        message,
        payload,
    };
}
function withSpanId(span, message) {
    return {
        ...message,
        span,
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3Bhbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNwYW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsa0NBQWtDO0FBQ2xDLDZCQUE2QjtBQUk3Qix3Q0FBMkM7QUF1RjNDOzs7Ozs7R0FNRztBQUNILE1BQWEsU0FBUztJQUNILFVBQVUsQ0FBdUI7SUFDakMsUUFBUSxDQUFXO0lBQzVCLFVBQVUsQ0FBMkM7SUFFN0QsWUFBbUIsUUFBa0IsRUFBRSxVQUFnQyxFQUFFLFVBQW9EO1FBQzNILElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO0lBQy9CLENBQUM7SUFRTSxLQUFLLENBQUMsS0FBSyxDQUFDLENBQU0sRUFBRSxDQUFLO1FBQzlCLE1BQU0sSUFBSSxHQUFHLElBQUksV0FBVyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDOUUsTUFBTSxVQUFVLEdBQUcsU0FBUyxDQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN0QyxNQUFNLFFBQVEsR0FBRyxVQUFVLENBQUMsT0FBTyxJQUFJLFlBQVksSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLE1BQU0sQ0FBQztRQUM5RSxNQUFNLFlBQVksR0FBRyxVQUFVLENBQUMsT0FBTyxDQUFDO1FBQ3hDLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLFlBQVksQ0FBQyxDQUFDLENBQUM7UUFFckUsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0NBQ0Y7QUExQkQsOEJBMEJDO0FBRUQsTUFBTSxXQUFXO0lBQ0MsUUFBUSxDQUFXO0lBRWxCLFVBQVUsQ0FBdUI7SUFDakMsUUFBUSxD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QUUsSUFBQSxpQkFBVSxFQUFDLFdBQVcsQ0FBQztTQUMvQixDQUFDO0lBQ0osQ0FBQztDQUNGO0FBRUQsU0FBUyxTQUFTLENBQW1CLEtBQVUsRUFBRSxNQUFVO0lBQ3pELE1BQU0sY0FBYyxHQUFHLE9BQU8sS0FBSyxLQUFLLFFBQVEsQ0FBQztJQUVqRCxzR0FBc0c7SUFDdEcsTUFBTSxPQUFPLEdBQUcsQ0FBQyxjQUFjLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO0lBRS9ELG9FQUFvRTtJQUNwRSw2RUFBNkU7SUFDN0UsTUFBTSxPQUFPLEdBQUcsQ0FBQyxjQUFjLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO0lBRTVELE9BQU87UUFDTCxPQUFPO1FBQ1AsT0FBTztLQUNSLENBQUM7QUFDSixDQUFDO0FBRUQsU0FBUyxVQUFVLENBQW1CLElBQVksRUFBRSxPQUFVO0lBQzVELE9BQU87UUFDTCxHQUFHLE9BQU87UUFDVixJQUFJO0tBQ0wsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyB1dGlsIGZyb20gJ25vZGU6dXRpbCc7XG5pbXBvcnQgKiBhcyB1dWlkIGZyb20gJ3V1aWQnO1xuaW1wb3J0IHR5cGUgeyBBY3Rpb25MZXNzTWVzc2FnZSwgQWN0aW9uTGVzc1JlcXVlc3QsIElvSGVscGVyIH0gZnJvbSAnLi9pby1oZWxwZXInO1xuaW1wb3J0IHR5cGUgKiBhcyBtYWtlIGZyb20gJy4vbWVzc2FnZS1tYWtlcic7XG5pbXBvcnQgdHlwZSB7IER1cmF0aW9uIH0gZnJvbSAnLi4vLi4vLi4vcGF5bG9hZHMvdHlwZXMnO1xuaW1wb3J0IHsgZm9ybWF0VGltZSB9IGZyb20gJy4uLy4uLy4uL3V0aWwnO1xuaW1wb3J0IHR5cGUgeyBJQWN0aW9uQXdhcmVJb0hvc3QgfSBmcm9tICcuLi9pby1ob3N0JztcbmltcG9ydCB0eXBlIHsgSW9EZWZhdWx0TWVzc2FnZXMgfSBmcm9tICcuL2lvLWRlZmF1bHQtbWVzc2FnZXMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIFNwYW5FbmQge1xuICByZWFkb25seSBkdXJhdGlvbjogbnVtYmVyO1xufVxuXG4vKipcbiAqIERlc2NyaWJlcyBhIHNwZWNpZmljIHNwYW5cbiAqXG4gKiBBIHNwYW4gZGVmaW5pdGlvbiBpcyBhIHBhaXIgb2YgYElvTWVzc2FnZU1ha2VyYHMgdG8gY3JlYXRlIGEgc3RhcnQgYW5kIGVuZCBtZXNzYWdlIG9mIHRoZSBzcGFuIHJlc3BlY3RpdmVseS5cbiAqIEl0IGFsc28gaGFzIGEgZGlzcGxheSBuYW1lLCB0aGF0IGlzIHVzZWQgZm9yIGF1dG8tZ2VuZXJhdGVkIG1lc3NhZ2UgdGV4dCB3aGVuIHRoZXkgYXJlIG5vdCBwcm92aWRlZC5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBTcGFuRGVmaW5pdGlvbjxTIGV4dGVuZHMgb2JqZWN0LCBFIGV4dGVuZHMgU3BhbkVuZD4ge1xuICByZWFkb25seSBuYW1lOiBzdHJpbmc7XG4gIHJlYWRvbmx5IHN0YXJ0OiBtYWtlLklvTWVzc2FnZU1ha2VyPFM+O1xuICByZWFkb25seSBlbmQ6IG1ha2UuSW9NZXNzYWdlTWFrZXI8RT47XG59XG5cbi8qKlxuICogVXNlZCBpbiBjb25kaXRpb25hbCB0eXBlcyB0byBjaGVjayBpZiBhIHR5cGUgKGUuZy4gYWZ0ZXIgb21pdHRpbmcgZmllbGRzKSBpcyBhbiBlbXB0eSBvYmplY3RcbiAqIFRoaXMgaXMgbmVlZGVkIGJlY2F1c2UgY291bnRlci1pbnR1aXRpdmUgbmVpdGhlciBgb2JqZWN0YCBub3IgYHt9YCByZXByZXNlbnQgdGhhdC5cbiAqL1xudHlwZSBFbXB0eU9iamVjdCA9IHtcbiAgW2luZGV4OiBzdHJpbmcgfCBudW1iZXIgfCBzeW1ib2xdOiBuZXZlcjtcbn07XG5cbi8qKlxuICogSGVscGVyIHR5cGUgdG8gZm9yY2UgYSBwYXJhbWV0ZXIgdG8gYmUgbm90IHByZXNlbnQgb2YgdGhlIGNvbXB1dGVkIHR5cGUgaXMgYW4gZW1wdHkgb2JqZWN0XG4gKi9cbnR5cGUgVm9pZFdoZW5FbXB0eTxUPiA9IFQgZXh0ZW5kcyBFbXB0eU9iamVjdCA/IHZvaWQgOiBUO1xuXG4vKipcbiAqIEhlbHBlciB0eXBlIHRvIGZvcmNlIGEgcGFyYW1ldGVyIHRvIGJlIGFuIGVtcHR5IG9iamVjdCBpZiB0aGUgY29tcHV0ZWQgdHlwZSBpcyBhbiBlbXB0eSBvYmplY3RcbiAqIFRoaXMgaXMgd2VpcmQsIGJ1dCBzb21lIGNvbXB1dGVkIHR5cGVzIChlLmcuIHVzaW5nIGBPbWl0YCkgZG9uJ3QgZW5kIHVwIGVuZm9yY2luZyB0aGlzLlxuICovXG50eXBlIEZvcmNlRW1wdHk8VD4gPSBUIGV4dGVuZHMgRW1wdHlPYmplY3QgPyBFbXB0eU9iamVjdCA6IFQ7XG5cbi8qKlxuICogTWFrZSBzb21lIHByb3BlcnRpZXMgb3B0aW9uYWxcbiAqL1xudHlwZSBPcHRpb25hbDxULCBLIGV4dGVuZHMga2V5b2YgVD4gPSBQaWNrPFBhcnRpYWw8VD4sIEs+ICYgT21pdDxULCBLPjtcblxuLyoqXG4gKiBFbmRpbmcgdGhlIHNwYW4gcmV0dXJucyB0aGUgb2JzZXJ2ZWQgZHVyYXRpb25cbiAqL1xuaW50ZXJmYWNlIEVsYXBzZWRUaW1lIHtcbiAgcmVhZG9ubHkgYXNNczogbnVtYmVyO1xuICByZWFkb25seSBhc1NlYzogbnVtYmVyO1xufVxuXG4vKipcbiAqIEEgbWVzc2FnZSBzcGFuIHRoYXQgY2FuIGJlIGVuZGVkIGFuZCByZWFkIHRpbWVzIGZyb21cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBJTWVzc2FnZVNwYW48RSBleHRlbmRzIFNwYW5FbmQ+IGV4dGVuZHMgSUFjdGlvbkF3YXJlSW9Ib3N0IHtcbiAgLyoqXG4gICAqIEFuIElvSGVscGVyIHdyYXBwZWQgYXJvdW5kIHRoZSBzcGFuLlxuICAgKi9cbiAgcmVhZG9ubHkgYXNIZWxwZXI6IElvSGVscGVyO1xuICAvKipcbiAgICogQW4gSW9EZWZhdWx0TWVzc2FnZXMgd3JhcHBlZCBhcm91bmQgdGhlIHNwYW4uXG4gICAqL1xuICByZWFkb25seSBkZWZhdWx0czogSW9EZWZhdWx0TWVzc2FnZXM7XG4gIC8qKlxuICAgKiBHZXQgdGhlIHRpbWUgZWxhcHNlZCBzaW5jZSB0aGUgc3RhcnRcbiAgICovXG4gIGVsYXBzZWRUaW1lKCk6IFByb21pc2U8RWxhcHNlZFRpbWU+O1xuICAvKipcbiAgICogU2VuZHMgYSBzaW1wbGUsIGdlbmVyaWMgbWVzc2FnZSB3aXRoIHRoZSBjdXJyZW50IHRpbWluZ1xuICAgKiBGb3IgbW9yZSBjb21wbGV4IGludGVybWVkaWF0ZSBtZXNzYWdlcywgZ2V0IHRoZSBgZWxhcHNlZFRpbWVgIGFuZCB1c2UgYG5vdGlmeWBcbiAgICovXG4gIHRpbWluZyhtYWtlcjogbWFrZS5Jb01lc3NhZ2VNYWtlcjxEdXJhdGlvbj4sIG1lc3NhZ2U/OiBzdHJpbmcpOiBQcm9taXNlPEVsYXBzZWRUaW1lPjtcbiAgLyoqXG4gICAqIEVuZCB0aGUgc3BhbiB3aXRoIGEgcGF5bG9hZFxuICAgKi9cbiAgZW5kKHBheWxvYWQ6IFZvaWRXaGVuRW1wdHk8T21pdDxFLCBrZXlvZiBTcGFuRW5kPj4pOiBQcm9taXNlPEVsYXBzZWRUaW1lPjtcbiAgLyoqXG4gICAqIEVuZCB0aGUgc3BhbiB3aXRoIGEgcGF5bG9hZCwgb3ZlcndyaXRpbmdcbiAgICovXG4gIGVuZChwYXlsb2FkOiBWb2lkV2hlbkVtcHR5PE9wdGlvbmFsPEUsIGtleW9mIFNwYW5FbmQ+Pik6IFByb21pc2U8RWxhcHNlZFRpbWU+O1xuICAvKipcbiAgICogRW5kIHRoZSBzcGFuIHdpdGggYSBtZXNzYWdlIGFuZCBwYXlsb2FkXG4gICAqL1xuICBlbmQobWVzc2FnZTogc3RyaW5nLCBwYXlsb2FkOiBGb3JjZUVtcHR5PE9wdGlvbmFsPEUsIGtleW9mIFNwYW5FbmQ+Pik6IFByb21pc2U8RWxhcHNlZFRpbWU+O1xufVxuXG4vKipcbiAqIEhlbHBlciBjbGFzcyB0byBtYWtlIHNwYW5zIGFyb3VuZCBibG9ja3Mgb2Ygd29ya1xuICpcbiAqIEJsb2NrcyBhcmUgZW5jbG9zZWQgYnkgYSBzdGFydCBhbmQgZW5kIG1lc3NhZ2UuXG4gKiBBbGwgbWVzc2FnZXMgb2YgdGhlIHNwYW4gc2hhcmUgYSB1bmlxdWUgaWQuXG4gKiBUaGUgZW5kIG1lc3NhZ2UgY29udGFpbnMgdGhlIHRpbWUgcGFzc2VkIGJldHdlZW4gc3RhcnQgYW5kIGVuZC5cbiAqL1xuZXhwb3J0IGNsYXNzIFNwYW5NYWtlcjxTIGV4dGVuZHMgb2JqZWN0LCBFIGV4dGVuZHMgU3BhbkVuZD4ge1xuICBwcml2YXRlIHJlYWRvbmx5IGRlZmluaXRpb246IFNwYW5EZWZpbml0aW9uPFMsIEU+O1xuICBwcml2YXRlIHJlYWRvbmx5IGlvSGVscGVyOiBJb0hlbHBlcjtcbiAgcHJpdmF0ZSBtYWtlSGVscGVyOiAoaW9Ib3N0OiBJQWN0aW9uQXdhcmVJb0hvc3QpID0+IElvSGVscGVyO1xuXG4gIHB1YmxpYyBjb25zdHJ1Y3Rvcihpb0hlbHBlcjogSW9IZWxwZXIsIGRlZmluaXRpb246IFNwYW5EZWZpbml0aW9uPFMsIEU+LCBtYWtlSGVscGVyOiAoaW9Ib3N0OiBJQWN0aW9uQXdhcmVJb0hvc3QpID0+IElvSGVscGVyKSB7XG4gICAgdGhpcy5kZWZpbml0aW9uID0gZGVmaW5pdGlvbjtcbiAgICB0aGlzLmlvSGVscGVyID0gaW9IZWxwZXI7XG4gICAgdGhpcy5tYWtlSGVscGVyID0gbWFrZUhlbHBlcjtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdGFydHMgdGhlIHNwYW4gYW5kIGluaXRpYWxseSBub3RpZmllcyB0aGUgSW9Ib3N0XG4gICAqIEByZXR1cm5zIGEgbWVzc2FnZSBzcGFuXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgYmVnaW4ocGF5bG9hZDogVm9pZFdoZW5FbXB0eTxTPik6IFByb21pc2U8SU1lc3NhZ2VTcGFuPEU+PjtcbiAgcHVibGljIGFzeW5jIGJlZ2luKG1lc3NhZ2U6IHN0cmluZywgcGF5bG9hZDogUyk6IFByb21pc2U8SU1lc3NhZ2VTcGFuPEU+PjtcbiAgcHVibGljIGFzeW5jIGJlZ2luKGE6IGFueSwgYj86IFMpOiBQcm9taXNlPElNZXNzYWdlU3BhbjxFPj4ge1xuICAgIGNvbnN0IHNwYW4gPSBuZXcgTWVzc2FnZVNwYW4odGhpcy5pb0hlbHBlciwgdGhpcy5kZWZpbml0aW9uLCB0aGlzLm1ha2VIZWxwZXIpO1xuICAgIGNvbnN0IHN0YXJ0SW5wdXQgPSBwYXJzZUFyZ3M8Uz4oYSwgYik7XG4gICAgY29uc3Qgc3RhcnRNc2cgPSBzdGFydElucHV0Lm1lc3NhZ2UgPz8gYFN0YXJ0aW5nICR7dGhpcy5kZWZpbml0aW9uLm5hbWV9IC4uLmA7XG4gICAgY29uc3Qgc3RhcnRQYXlsb2FkID0gc3RhcnRJbnB1dC5wYXlsb2FkO1xuICAgIGF3YWl0IHNwYW4ubm90aWZ5KHRoaXMuZGVmaW5pdGlvbi5zdGFydC5tc2coc3RhcnRNc2csIHN0YXJ0UGF5bG9hZCkpO1xuXG4gICAgcmV0dXJuIHNwYW47XG4gIH1cbn1cblxuY2xhc3MgTWVzc2FnZVNwYW48UyBleHRlbmRzIG9iamVjdCwgRSBleHRlbmRzIFNwYW5FbmQ+IGltcGxlbWVudHMgSU1lc3NhZ2VTcGFuPEU+IHtcbiAgcHVibGljIHJlYWRvbmx5IGFzSGVscGVyOiBJb0hlbHBlcjtcblxuICBwcml2YXRlIHJlYWRvbmx5IGRlZmluaXRpb246IFNwYW5EZWZpbml0aW9uPFMsIEU+O1xuICBwcml2YXRlIHJlYWRvbmx5IGlvSGVscGVyOiBJb0hlbHBlcjtcbiAgcHJpdmF0ZSByZWFkb25seSBzcGFuSWQ6IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSBzdGFydFRpbWU6IG51bWJlcjtcbiAgcHJpdmF0ZSByZWFkb25seSB0aW1pbmdNc2dUZW1wbGF0ZTogc3RyaW5nO1xuXG4gIHB1YmxpYyBjb25zdHJ1Y3Rvcihpb0hlbHBlcjogSW9IZWxwZXIsIGRlZmluaXRpb246IFNwYW5EZWZpbml0aW9uPFMsIEU+LCBtYWtlSGVscGVyOiAoaW9Ib3N0OiBJQWN0aW9uQXdhcmVJb0hvc3QpID0+IElvSGVscGVyKSB7XG4gICAgdGhpcy5kZWZpbml0aW9uID0gZGVmaW5pdGlvbjtcbiAgICB0aGlzLmlvSGVscGVyID0gaW9IZWxwZXI7XG4gICAgdGhpcy5zcGFuSWQgPSB1dWlkLnY0KCk7XG4gICAgdGhpcy5zdGFydFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICB0aGlzLnRpbWluZ01zZ1RlbXBsYXRlID0gJ1xcbuKcqCAgJXMgdGltZTogJWRzXFxuJztcbiAgICB0aGlzLmFzSGVscGVyID0gbWFrZUhlbHBlcih0aGlzKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgZGVmYXVsdHMoKTogSW9EZWZhdWx0TWVzc2FnZXMge1xuICAgIHJldHVybiB0aGlzLmFzSGVscGVyLmRlZmF1bHRzO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGVsYXBzZWRUaW1lKCk6IFByb21pc2U8RWxhcHNlZFRpbWU+IHtcbiAgICByZXR1cm4gdGhpcy50aW1lKCk7XG4gIH1cbiAgcHVibGljIGFzeW5jIHRpbWluZyhtYWtlcjogbWFrZS5Jb01lc3NhZ2VNYWtlcjxEdXJhdGlvbj4sIG1lc3NhZ2U/OiBzdHJpbmcpOiBQcm9taXNlPEVsYXBzZWRUaW1lPiB7XG4gICAgY29uc3QgZHVyYXRpb24gPSB0aGlzLnRpbWUoKTtcbiAgICBjb25zdCB0aW1pbmdNc2cgPSBtZXNzYWdlID8gbWVzc2FnZSA6IHV0aWwuZm9ybWF0KHRoaXMudGltaW5nTXNnVGVtcGxhdGUsIHRoaXMuZGVmaW5pdGlvbi5uYW1lLCBkdXJhdGlvbi5hc1NlYyk7XG4gICAgYXdhaXQgdGhpcy5ub3RpZnkobWFrZXIubXNnKHRpbWluZ01zZywge1xuICAgICAgZHVyYXRpb246IGR1cmF0aW9uLmFzTXMsXG4gICAgfSkpO1xuICAgIHJldHVybiBkdXJhdGlvbjtcbiAgfVxuICBwdWJsaWMgYXN5bmMgbm90aWZ5KG1zZzogQWN0aW9uTGVzc01lc3NhZ2U8dW5rbm93bj4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gdGhpcy5pb0hlbHBlci5ub3RpZnkod2l0aFNwYW5JZCh0aGlzLnNwYW5JZCwgbXNnKSk7XG4gIH1cbiAgcHVibGljIGFzeW5jIGVuZCh4OiBhbnksIHk/OiBGb3JjZUVtcHR5PE9wdGlvbmFsPEUsIGtleW9mIFNwYW5FbmQ+Pik6IFByb21pc2U8RWxhcHNlZFRpbWU+IHtcbiAgICBjb25zdCBkdXJhdGlvbiA9IHRoaXMudGltZSgpO1xuXG4gICAgY29uc3QgZW5kSW5wdXQgPSBwYXJzZUFyZ3M8Rm9yY2VFbXB0eTxPcHRpb25hbDxFLCBrZXlvZiBTcGFuRW5kPj4+KHgsIHkpO1xuICAgIGNvbnN0IGVuZE1zZyA9IGVuZElucHV0Lm1lc3NhZ2UgPz8gdXRpbC5mb3JtYXQodGhpcy50aW1pbmdNc2dUZW1wbGF0ZSwgdGhpcy5kZWZpbml0aW9uLm5hbWUsIGR1cmF0aW9uLmFzU2VjKTtcbiAgICBjb25zdCBlbmRQYXlsb2FkID0gZW5kSW5wdXQucGF5bG9hZDtcblxuICAgIGF3YWl0IHRoaXMubm90aWZ5KHRoaXMuZGVmaW5pdGlvbi5lbmQubXNnKFxuICAgICAgZW5kTXNnLCB7XG4gICAgICAgIGR1cmF0aW9uOiBkdXJhdGlvbi5hc01zLFxuICAgICAgICAuLi5lbmRQYXlsb2FkLFxuICAgICAgfSBhcyBFKSk7XG5cbiAgICByZXR1cm4gZHVyYXRpb247XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcmVxdWVzdFJlc3BvbnNlPFQ+KG1zZzogQWN0aW9uTGVzc1JlcXVlc3Q8dW5rbm93biwgVD4pOiBQcm9taXNlPFQ+IHtcbiAgICByZXR1cm4gdGhpcy5pb0hlbHBlci5yZXF1ZXN0UmVzcG9uc2Uod2l0aFNwYW5JZCh0aGlzLnNwYW5JZCwgbXNnKSk7XG4gIH1cblxuICBwcml2YXRlIHRpbWUoKSB7XG4gICAgY29uc3QgZWxhcHNlZFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHRoaXMuc3RhcnRUaW1lO1xuICAgIHJldHVybiB7XG4gICAgICBhc01zOiBlbGFwc2VkVGltZSxcbiAgICAgIGFzU2VjOiBmb3JtYXRUaW1lKGVsYXBzZWRUaW1lKSxcbiAgICB9O1xuICB9XG59XG5cbmZ1bmN0aW9uIHBhcnNlQXJnczxTIGV4dGVuZHMgb2JqZWN0PihmaXJzdDogYW55LCBzZWNvbmQ/OiBTKTogeyBtZXNzYWdlOiBzdHJpbmcgfCB1bmRlZmluZWQ7IHBheWxvYWQ6IFMgfSB7XG4gIGNvbnN0IGZpcnN0SXNNZXNzYWdlID0gdHlwZW9mIGZpcnN0ID09PSAnc3RyaW5nJztcblxuICAvLyBXaGVuIHRoZSBmaXJzdCBhcmd1bWVudCBpcyBhIHN0cmluZyBvciB3ZSBoYXZlIGEgc2Vjb25kIGFyZ3VtZW50LCB0aGVuIHRoZSBmaXJzdCBhcmcgaXMgdGhlIG1lc3NhZ2VcbiAgY29uc3QgbWVzc2FnZSA9IChmaXJzdElzTWVzc2FnZSB8fCBzZWNvbmQpID8gZmlyc3QgOiB1bmRlZmluZWQ7XG5cbiAgLy8gV2hlbiB0aGUgZmlyc3QgYXJndW1lbnQgaXMgYSBzdHJpbmcgb3Igd2UgaGF2ZSBhIHNlY29uZCBhcmd1bWVudCxcbiAgLy8gdGhlbiB0aGUgc2Vjb25kIGFyZyBpcyB0aGUgcGF5bG9hZCwgb3RoZXJ3aXNlIHRoZSBmaXJzdCBhcmcgaXMgdGhlIHBheWxvYWRcbiAgY29uc3QgcGF5bG9hZCA9IChmaXJzdElzTWVzc2FnZSB8fCBzZWNvbmQpID8gc2Vjb25kIDogZmlyc3Q7XG5cbiAgcmV0dXJuIHtcbiAgICBtZXNzYWdlLFxuICAgIHBheWxvYWQsXG4gIH07XG59XG5cbmZ1bmN0aW9uIHdpdGhTcGFuSWQ8VCBleHRlbmRzIG9iamVjdD4oc3Bhbjogc3RyaW5nLCBtZXNzYWdlOiBUKTogVCAmIHsgc3Bhbjogc3RyaW5nIH0ge1xuICByZXR1cm4ge1xuICAgIC4uLm1lc3NhZ2UsXG4gICAgc3BhbixcbiAgfTtcbn1cbiJdfQ==