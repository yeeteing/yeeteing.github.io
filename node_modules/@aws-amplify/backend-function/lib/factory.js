import { AmplifyUserError, CallerDirectoryExtractor, TagName, } from '@aws-amplify/platform-core';
import { Duration, Size, Stack, Tags } from 'aws-cdk-lib';
import { Rule } from 'aws-cdk-lib/aws-events';
import * as targets from 'aws-cdk-lib/aws-events-targets';
import { Architecture, LayerVersion, Runtime, } from 'aws-cdk-lib/aws-lambda';
import { LogLevel as EsBuildLogLevel, NodejsFunction, OutputFormat, } from 'aws-cdk-lib/aws-lambda-nodejs';
import { readFileSync } from 'fs';
import { createRequire } from 'module';
import { EOL } from 'os';
import * as path from 'path';
import { FunctionEnvironmentTranslator } from './function_env_translator.js';
import { FunctionEnvironmentTypeGenerator } from './function_env_type_generator.js';
import { FunctionLayerArnParser } from './layer_parser.js';
import { convertLoggingOptionsToCDK } from './logging_options_parser.js';
import { convertFunctionSchedulesToRuleSchedules } from './schedule_parser.js';
import { ProvidedFunctionFactory, } from './provided_function_factory.js';
import { AmplifyFunctionBase } from './function_construct_base.js';
import { FunctionResourceAccessAcceptor } from './resource_access_acceptor.js';
/**
 * Entry point for defining a function in the Amplify ecosystem
 */
// This is the "implementation overload", it's not visible in public api.
// We have to use function notation instead of arrow notation.
// Arrow notation does not support overloads.
// eslint-disable-next-line no-restricted-syntax
export function defineFunction(propsOrProvider = {}, providerProps) {
    if (propsOrProvider && typeof propsOrProvider === 'function') {
        return new ProvidedFunctionFactory(propsOrProvider, providerProps);
    }
    return new FunctionFactory(propsOrProvider, new Error().stack);
}
/**
 * Create Lambda functions in the context of an Amplify backend definition
 */
class FunctionFactory {
    props;
    callerStack;
    generator;
    /**
     * Create a new AmplifyFunctionFactory
     */
    constructor(props, callerStack) {
        this.props = props;
        this.callerStack = callerStack;
    }
    /**
     * Creates an instance of AmplifyFunction within the provided Amplify context
     */
    getInstance = ({ constructContainer, outputStorageStrategy, resourceNameValidator, }) => {
        if (!this.generator) {
            this.generator = new FunctionGenerator(this.hydrateDefaults(resourceNameValidator), outputStorageStrategy);
        }
        return constructContainer.getOrCompute(this.generator);
    };
    hydrateDefaults = (resourceNameValidator) => {
        const name = this.resolveName();
        resourceNameValidator?.validate(name);
        return {
            name,
            entry: this.resolveEntry(),
            timeoutSeconds: this.resolveTimeout(),
            memoryMB: this.resolveMemory(),
            ephemeralStorageSizeMB: this.resolveEphemeralStorageSize(),
            environment: this.resolveEnvironment(),
            runtime: this.resolveRuntime(),
            architecture: this.resolveArchitecture(),
            schedule: this.resolveSchedule(),
            bundling: this.resolveBundling(),
            layers: this.props.layers ?? {},
            resourceGroupName: this.props.resourceGroupName ?? 'function',
            logging: this.props.logging ?? {},
        };
    };
    resolveName = () => {
        // If name is set explicitly, use that
        if (this.props.name) {
            return this.props.name;
        }
        // If entry is set, use the basename of the entry path
        if (this.props.entry) {
            return path.parse(this.props.entry).name;
        }
        // Otherwise, use the directory name where the function is defined
        return path.basename(new CallerDirectoryExtractor(this.callerStack).extract());
    };
    resolveEntry = () => {
        // if entry is not set, default to handler.ts
        if (!this.props.entry) {
            return path.join(new CallerDirectoryExtractor(this.callerStack).extract(), 'handler.ts');
        }
        // if entry is absolute use that
        if (path.isAbsolute(this.props.entry)) {
            return this.props.entry;
        }
        // if entry is relative, compute with respect to the caller directory
        return path.join(new CallerDirectoryExtractor(this.callerStack).extract(), this.props.entry);
    };
    resolveTimeout = () => {
        const timeoutMin = 1;
        const timeoutMax = 60 * 15; // 15 minutes in seconds
        const timeoutDefault = 3;
        if (this.props.timeoutSeconds === undefined) {
            return timeoutDefault;
        }
        if (!isWholeNumberBetweenInclusive(this.props.timeoutSeconds, timeoutMin, timeoutMax)) {
            throw new AmplifyUserError('InvalidTimeoutError', {
                message: `Invalid function timeout of ${this.props.timeoutSeconds}`,
                resolution: `timeoutSeconds must be a whole number between ${timeoutMin} and ${timeoutMax} inclusive`,
            });
        }
        return this.props.timeoutSeconds;
    };
    resolveMemory = () => {
        const memoryMin = 128;
        const memoryMax = 10240;
        const memoryDefault = 512;
        if (this.props.memoryMB === undefined) {
            return memoryDefault;
        }
        if (!isWholeNumberBetweenInclusive(this.props.memoryMB, memoryMin, memoryMax)) {
            throw new AmplifyUserError('InvalidMemoryMBError', {
                message: `Invalid function memoryMB of ${this.props.memoryMB}`,
                resolution: `memoryMB must be a whole number between ${memoryMin} and ${memoryMax} inclusive`,
            });
        }
        return this.props.memoryMB;
    };
    resolveEphemeralStorageSize = () => {
        const ephemeralStorageSizeMin = 512;
        const ephemeralStorageSizeMax = 10240;
        const ephemeralStorageSizeDefault = 512;
        if (this.props.ephemeralStorageSizeMB === undefined) {
            return ephemeralStorageSizeDefault;
        }
        if (!isWholeNumberBetweenInclusive(this.props.ephemeralStorageSizeMB, ephemeralStorageSizeMin, ephemeralStorageSizeMax)) {
            throw new AmplifyUserError('InvalidEphemeralStorageSizeMBError', {
                message: `Invalid function ephemeralStorageSizeMB of ${this.props.ephemeralStorageSizeMB}`,
                resolution: `ephemeralStorageSizeMB must be a whole number between ${ephemeralStorageSizeMin} and ${ephemeralStorageSizeMax} inclusive`,
            });
        }
        return this.props.ephemeralStorageSizeMB;
    };
    resolveEnvironment = () => {
        if (this.props.environment === undefined) {
            return {};
        }
        const invalidKeys = [];
        Object.keys(this.props.environment).forEach((key) => {
            // validate using key pattern from https://docs.aws.amazon.com/lambda/latest/api/API_Environment.html
            if (!key.match(/^[a-zA-Z]([a-zA-Z0-9_])+$/)) {
                invalidKeys.push(key);
            }
        });
        if (invalidKeys.length > 0) {
            throw new AmplifyUserError('InvalidEnvironmentKeyError', {
                message: `Invalid function environment key(s): ${invalidKeys.join(', ')}`,
                resolution: 'Environment keys must match [a-zA-Z]([a-zA-Z0-9_])+ and be at least 2 characters',
            });
        }
        return this.props.environment;
    };
    resolveRuntime = () => {
        const runtimeDefault = 20;
        // if runtime is not set, default to the oldest LTS
        if (!this.props.runtime) {
            return runtimeDefault;
        }
        if (!(this.props.runtime in nodeVersionMap)) {
            throw new AmplifyUserError('InvalidRuntimeError', {
                message: `Invalid function runtime of ${this.props.runtime}`,
                resolution: `runtime must be one of the following: ${Object.keys(nodeVersionMap).join(', ')}`,
            });
        }
        return this.props.runtime;
    };
    resolveArchitecture = () => {
        const architectureDefault = 'x86_64';
        if (!this.props.architecture) {
            return architectureDefault;
        }
        if (!(this.props.architecture in architectureMap)) {
            throw new AmplifyUserError('InvalidArchitectureError', {
                message: `Invalid function architecture of ${this.props.architecture}`,
                resolution: `architecture must be one of the following: ${Object.keys(architectureMap).join(', ')}`,
            });
        }
        return this.props.architecture;
    };
    resolveSchedule = () => {
        if (!this.props.schedule) {
            return [];
        }
        return this.props.schedule;
    };
    resolveBundling = () => {
        const bundlingDefault = {
            format: OutputFormat.ESM,
            bundleAwsSDK: true,
            loader: {
                '.node': 'file',
            },
            minify: true,
            sourceMap: true,
        };
        return {
            ...bundlingDefault,
            minify: this.resolveMinify(this.props.bundling),
        };
    };
    resolveMinify = (bundling) => {
        return bundling?.minify === undefined ? true : bundling.minify;
    };
}
class FunctionGenerator {
    props;
    outputStorageStrategy;
    resourceGroupName;
    constructor(props, outputStorageStrategy) {
        this.props = props;
        this.outputStorageStrategy = outputStorageStrategy;
        this.resourceGroupName = props.resourceGroupName;
    }
    generateContainerEntry = ({ scope, backendSecretResolver, }) => {
        // Move layer resolution here where we have access to scope
        const parser = new FunctionLayerArnParser(Stack.of(scope).region, Stack.of(scope).account);
        const resolvedLayerArns = parser.parseLayers(this.props.layers ?? {}, this.props.name);
        // resolve layers to LayerVersion objects for the NodejsFunction constructor
        const resolvedLayers = Object.entries(resolvedLayerArns).map(([key, arn]) => LayerVersion.fromLayerVersionArn(scope, `${this.props.name}-${key}-layer`, arn));
        return new AmplifyFunction(scope, this.props.name, { ...this.props, resolvedLayers }, backendSecretResolver, this.outputStorageStrategy);
    };
}
class AmplifyFunction extends AmplifyFunctionBase {
    resources;
    functionEnvironmentTranslator;
    constructor(scope, id, props, backendSecretResolver, outputStorageStrategy) {
        super(scope, id, outputStorageStrategy);
        const runtime = nodeVersionMap[props.runtime];
        const require = createRequire(import.meta.url);
        const shims = runtime === Runtime.NODEJS_16_X
            ? []
            : [require.resolve('./lambda-shims/cjs_shim')];
        const ssmResolverFile = runtime === Runtime.NODEJS_16_X
            ? require.resolve('./lambda-shims/resolve_ssm_params_sdk_v2') // use aws cdk v2 in node 16
            : require.resolve('./lambda-shims/resolve_ssm_params');
        const invokeSsmResolverFile = require.resolve('./lambda-shims/invoke_ssm_shim');
        /**
         * This code concatenates the contents of the ssm resolver and invoker into a single line that can be used as the esbuild banner content
         * This banner is responsible for resolving the customer's SSM parameters at runtime
         */
        const bannerCode = readFileSync(ssmResolverFile, 'utf-8')
            .concat(readFileSync(invokeSsmResolverFile, 'utf-8'))
            .split(new RegExp(`${EOL}|\n|\r`, 'g'))
            .map((line) => line.replace(/\/\/.*$/, '')) // strip out inline comments because the banner is going to be flattened into a single line
            .join('');
        const functionEnvironmentTypeGenerator = new FunctionEnvironmentTypeGenerator(id);
        // esbuild runs as part of the NodejsFunction constructor, so we eagerly generate the process env shim without types so it can be included in the function bundle.
        // This will be overwritten with the typed file at the end of synthesis
        functionEnvironmentTypeGenerator.generateProcessEnvShim();
        let functionLambda;
        const cdkLoggingOptions = convertLoggingOptionsToCDK(props.logging);
        try {
            functionLambda = new NodejsFunction(scope, `${id}-lambda`, {
                entry: props.entry,
                timeout: Duration.seconds(props.timeoutSeconds),
                memorySize: props.memoryMB,
                architecture: architectureMap[props.architecture],
                ephemeralStorageSize: Size.mebibytes(props.ephemeralStorageSizeMB),
                runtime: nodeVersionMap[props.runtime],
                layers: props.resolvedLayers,
                bundling: {
                    ...props.bundling,
                    banner: bannerCode,
                    inject: shims,
                    externalModules: Object.keys(props.layers),
                    logLevel: EsBuildLogLevel.ERROR,
                },
                logRetention: cdkLoggingOptions.retention,
                applicationLogLevelV2: cdkLoggingOptions.level,
                loggingFormat: cdkLoggingOptions.format,
            });
        }
        catch (error) {
            // If the error is from ES Bundler which is executed as a child process by CDK,
            // then the error from CDK contains the command that was executed along with the exit status.
            // Wrapping it here  would cause the cdk_deployer to re-throw this wrapped exception
            // instead of scraping the stderr for actual ESBuild error.
            if (error instanceof Error &&
                error.message.match(/Failed to bundle asset.*exited with status/)) {
                throw error;
            }
            throw new AmplifyUserError('NodeJSFunctionConstructInitializationError', {
                message: 'Failed to instantiate nodejs function construct',
                resolution: 'See the underlying error message for more details. Use `--debug` for additional debugging information.',
            }, error);
        }
        try {
            const schedules = convertFunctionSchedulesToRuleSchedules(functionLambda, props.schedule);
            const lambdaTarget = new targets.LambdaFunction(functionLambda);
            schedules.forEach((schedule, index) => {
                // Lambda name will be prepended to rule id, so only using index here for uniqueness
                const rule = new Rule(functionLambda, `schedule${index}`, {
                    schedule,
                });
                rule.addTarget(lambdaTarget);
            });
        }
        catch (error) {
            throw new AmplifyUserError('FunctionScheduleInitializationError', {
                message: 'Failed to instantiate schedule for nodejs function',
                resolution: 'See the underlying error message for more details.',
            }, error);
        }
        Tags.of(functionLambda).add(TagName.FRIENDLY_NAME, id);
        this.functionEnvironmentTranslator = new FunctionEnvironmentTranslator(functionLambda, props.environment, backendSecretResolver, functionEnvironmentTypeGenerator);
        this.resources = {
            lambda: functionLambda,
            cfnResources: {
                cfnFunction: functionLambda.node.findChild('Resource'),
            },
        };
        this.storeOutput();
    }
    addEnvironment = (key, value) => {
        this.functionEnvironmentTranslator.addEnvironmentEntry(key, value);
    };
    getResourceAccessAcceptor = () => new FunctionResourceAccessAcceptor(this, this.functionEnvironmentTranslator);
}
const isWholeNumberBetweenInclusive = (test, min, max) => min <= test && test <= max && test % 1 === 0;
const nodeVersionMap = {
    16: Runtime.NODEJS_16_X,
    18: Runtime.NODEJS_18_X,
    20: Runtime.NODEJS_20_X,
    22: Runtime.NODEJS_22_X,
};
const architectureMap = {
    arm64: Architecture.ARM_64,
    x86_64: Architecture.X86_64,
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFDTCxnQkFBZ0IsRUFDaEIsd0JBQXdCLEVBQ3hCLE9BQU8sR0FDUixNQUFNLDRCQUE0QixDQUFDO0FBbUJwQyxPQUFPLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQzFELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUM5QyxPQUFPLEtBQUssT0FBTyxNQUFNLGdDQUFnQyxDQUFDO0FBQzFELE9BQU8sRUFDTCxZQUFZLEVBSVosWUFBWSxFQUNaLE9BQU8sR0FDUixNQUFNLHdCQUF3QixDQUFDO0FBQ2hDLE9BQU8sRUFDTCxRQUFRLElBQUksZUFBZSxFQUMzQixjQUFjLEVBQ2QsWUFBWSxHQUNiLE1BQU0sK0JBQStCLENBQUM7QUFFdkMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLElBQUksQ0FBQztBQUNsQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDekIsT0FBTyxLQUFLLElBQUksTUFBTSxNQUFNLENBQUM7QUFDN0IsT0FBTyxFQUFFLDZCQUE2QixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDN0UsT0FBTyxFQUFFLGdDQUFnQyxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDcEYsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDM0QsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDekUsT0FBTyxFQUFFLHVDQUF1QyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDL0UsT0FBTyxFQUNMLHVCQUF1QixHQUV4QixNQUFNLGdDQUFnQyxDQUFDO0FBQ3hDLE9B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QUFZLENBQUMsTUFBTTtDQUM1QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRnVuY3Rpb25PdXRwdXQgfSBmcm9tICdAYXdzLWFtcGxpZnkvYmFja2VuZC1vdXRwdXQtc2NoZW1hcyc7XG5pbXBvcnQge1xuICBBbXBsaWZ5VXNlckVycm9yLFxuICBDYWxsZXJEaXJlY3RvcnlFeHRyYWN0b3IsXG4gIFRhZ05hbWUsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcbmltcG9ydCB7XG4gIEFtcGxpZnlSZXNvdXJjZUdyb3VwTmFtZSxcbiAgQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneSxcbiAgQmFja2VuZFNlY3JldCxcbiAgQmFja2VuZFNlY3JldFJlc29sdmVyLFxuICBDb25zdHJ1Y3RDb250YWluZXJFbnRyeUdlbmVyYXRvcixcbiAgQ29uc3RydWN0RmFjdG9yeSxcbiAgQ29uc3RydWN0RmFjdG9yeUdldEluc3RhbmNlUHJvcHMsXG4gIEZ1bmN0aW9uUmVzb3VyY2VzLFxuICBHZW5lcmF0ZUNvbnRhaW5lckVudHJ5UHJvcHMsXG4gIExvZ0xldmVsLFxuICBMb2dSZXRlbnRpb24sXG4gIFJlc291cmNlQWNjZXNzQWNjZXB0b3IsXG4gIFJlc291cmNlQWNjZXNzQWNjZXB0b3JGYWN0b3J5LFxuICBSZXNvdXJjZU5hbWVWYWxpZGF0b3IsXG4gIFJlc291cmNlUHJvdmlkZXIsXG4gIFN0YWNrUHJvdmlkZXIsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHsgRHVyYXRpb24sIFNpemUsIFN0YWNrLCBUYWdzIH0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgUnVsZSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1ldmVudHMnO1xuaW1wb3J0ICogYXMgdGFyZ2V0cyBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZXZlbnRzLXRhcmdldHMnO1xuaW1wb3J0IHtcbiAgQXJjaGl0ZWN0dXJlLFxuICBDZm5GdW5jdGlvbixcbiAgSUZ1bmN0aW9uLFxuICBJTGF5ZXJWZXJzaW9uLFxuICBMYXllclZlcnNpb24sXG4gIFJ1bnRpbWUsXG59IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEnO1xuaW1wb3J0IHtcbiAgTG9nTGV2ZWwgYXMgRXNCdWlsZExvZ0xldmVsLFxuICBOb2RlanNGdW5jdGlvbixcbiAgT3V0cHV0Rm9ybWF0LFxufSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbGFtYmRhLW5vZGVqcyc7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IHJlYWRGaWxlU3luYyB9IGZyb20gJ2ZzJztcbmltcG9ydCB7IGNyZWF0ZVJlcXVpcmUgfSBmcm9tICdtb2R1bGUnO1xuaW1wb3J0IHsgRU9MIH0gZnJvbSAnb3MnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IEZ1bmN0aW9uRW52aXJvbm1lbnRUcmFuc2xhdG9yIH0gZnJvbSAnLi9mdW5jdGlvbl9lbnZfdHJhbnNsYXRvci5qcyc7XG5pbXBvcnQgeyBGdW5jdGlvbkVudmlyb25tZW50VHlwZUdlbmVyYXRvciB9IGZyb20gJy4vZnVuY3Rpb25fZW52X3R5cGVfZ2VuZXJhdG9yLmpzJztcbmltcG9ydCB7IEZ1bmN0aW9uTGF5ZXJBcm5QYXJzZXIgfSBmcm9tICcuL2xheWVyX3BhcnNlci5qcyc7XG5pbXBvcnQgeyBjb252ZXJ0TG9nZ2luZ09wdGlvbnNUb0NESyB9IGZyb20gJy4vbG9nZ2luZ19vcHRpb25zX3BhcnNlci5qcyc7XG5pbXBvcnQgeyBjb252ZXJ0RnVuY3Rpb25TY2hlZHVsZXNUb1J1bGVTY2hlZHVsZXMgfSBmcm9tICcuL3NjaGVkdWxlX3BhcnNlci5qcyc7XG5pbXBvcnQge1xuICBQcm92aWRlZEZ1bmN0aW9uRmFjdG9yeSxcbiAgUHJvdmlkZWRGdW5jdGlvblByb3BzLFxufSBmcm9tICcuL3Byb3ZpZGVkX2Z1bmN0aW9uX2ZhY3RvcnkuanMnO1xuaW1wb3J0IHsgQW1wbGlmeUZ1bmN0aW9uQmFzZSB9IGZyb20gJy4vZnVuY3Rpb25fY29uc3RydWN0X2Jhc2UuanMnO1xuaW1wb3J0IHsgRnVuY3Rpb25SZXNvdXJjZUFjY2Vzc0FjY2VwdG9yIH0gZnJvbSAnLi9yZXNvdXJjZV9hY2Nlc3NfYWNjZXB0b3IuanMnO1xuXG5leHBvcnQgdHlwZSBBZGRFbnZpcm9ubWVudEZhY3RvcnkgPSB7XG4gIGFkZEVudmlyb25tZW50OiAoa2V5OiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcgfCBCYWNrZW5kU2VjcmV0KSA9PiB2b2lkO1xufTtcblxuZXhwb3J0IHR5cGUgQ3JvblNjaGVkdWxlID1cbiAgfCBgJHtzdHJpbmd9ICR7c3RyaW5nfSAke3N0cmluZ30gJHtzdHJpbmd9ICR7c3RyaW5nfWBcbiAgfCBgJHtzdHJpbmd9ICR7c3RyaW5nfSAke3N0cmluZ30gJHtzdHJpbmd9ICR7c3RyaW5nfSAke3N0cmluZ31gO1xuZXhwb3J0IHR5cGUgVGltZUludGVydmFsID1cbiAgfCBgZXZlcnkgJHtudW1iZXJ9bWBcbiAgfCBgZXZlcnkgJHtudW1iZXJ9aGBcbiAgfCBgZXZlcnkgZGF5YFxuICB8IGBldmVyeSB3ZWVrYFxuICB8IGBldmVyeSBtb250aGBcbiAgfCBgZXZlcnkgeWVhcmA7XG5leHBvcnQgdHlwZSBGdW5jdGlvblNjaGVkdWxlID0gVGltZUludGVydmFsIHwgQ3JvblNjaGVkdWxlO1xuXG5leHBvcnQgdHlwZSBGdW5jdGlvbkxvZ0xldmVsID0gRXh0cmFjdDxcbiAgTG9nTGV2ZWwsXG4gICdpbmZvJyB8ICdkZWJ1ZycgfCAnd2FybicgfCAnZXJyb3InIHwgJ2ZhdGFsJyB8ICd0cmFjZSdcbj47XG5leHBvcnQgdHlwZSBGdW5jdGlvbkxvZ1JldGVudGlvbiA9IExvZ1JldGVudGlvbjtcblxuZXhwb3J0IGZ1bmN0aW9uIGRlZmluZUZ1bmN0aW9uKFxuICBwcm9wcz86IEZ1bmN0aW9uUHJvcHMsXG4pOiBDb25zdHJ1Y3RGYWN0b3J5PFxuICBSZXNvdXJjZVByb3ZpZGVyPEZ1bmN0aW9uUmVzb3VyY2VzPiAmXG4gICAgUmVzb3VyY2VBY2Nlc3NBY2NlcHRvckZhY3RvcnkgJlxuICAgIEFkZEVudmlyb25tZW50RmFjdG9yeSAmXG4gICAgU3RhY2tQcm92aWRlclxuPjtcbmV4cG9ydCBmdW5jdGlvbiBkZWZpbmVGdW5jdGlvbihcbiAgcHJvdmlkZXI6IChzY29wZTogQ29uc3RydWN0KSA9PiBJRnVuY3Rpb24sXG4gIHByb3ZpZGVyUHJvcHM/OiBQcm92aWRlZEZ1bmN0aW9uUHJvcHMsXG4pOiBDb25zdHJ1Y3RGYWN0b3J5PFxuICBSZXNvdXJjZVByb3ZpZGVyPEZ1bmN0aW9uUmVzb3VyY2VzPiAmXG4gICAgUmVzb3VyY2VBY2Nlc3NBY2NlcHRvckZhY3RvcnkgJlxuICAgIEFkZEVudmlyb25tZW50RmFjdG9yeSAmXG4gICAgU3RhY2tQcm92aWRlclxuPjtcbi8qKlxuICogRW50cnkgcG9pbnQgZm9yIGRlZmluaW5nIGEgZnVuY3Rpb24gaW4gdGhlIEFtcGxpZnkgZWNvc3lzdGVtXG4gKi9cbi8vIFRoaXMgaXMgdGhlIFwiaW1wbGVtZW50YXRpb24gb3ZlcmxvYWRcIiwgaXQncyBub3QgdmlzaWJsZSBpbiBwdWJsaWMgYXBpLlxuLy8gV2UgaGF2ZSB0byB1c2UgZnVuY3Rpb24gbm90YXRpb24gaW5zdGVhZCBvZiBhcnJvdyBub3RhdGlvbi5cbi8vIEFycm93IG5vdGF0aW9uIGRvZXMgbm90IHN1cHBvcnQgb3ZlcmxvYWRzLlxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXJlc3RyaWN0ZWQtc3ludGF4XG5leHBvcnQgZnVuY3Rpb24gZGVmaW5lRnVuY3Rpb24oXG4gIHByb3BzT3JQcm92aWRlcjogRnVuY3Rpb25Qcm9wcyB8ICgoc2NvcGU6IENvbnN0cnVjdCkgPT4gSUZ1bmN0aW9uKSA9IHt9LFxuICBwcm92aWRlclByb3BzPzogUHJvdmlkZWRGdW5jdGlvblByb3BzLFxuKTogdW5rbm93biB7XG4gIGlmIChwcm9wc09yUHJvdmlkZXIgJiYgdHlwZW9mIHByb3BzT3JQcm92aWRlciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIHJldHVybiBuZXcgUHJvdmlkZWRGdW5jdGlvbkZhY3RvcnkocHJvcHNPclByb3ZpZGVyLCBwcm92aWRlclByb3BzKTtcbiAgfVxuICByZXR1cm4gbmV3IEZ1bmN0aW9uRmFjdG9yeShwcm9wc09yUHJvdmlkZXIsIG5ldyBFcnJvcigpLnN0YWNrKTtcbn1cblxuZXhwb3J0IHR5cGUgRnVuY3Rpb25Qcm9wcyA9IHtcbiAgLyoqXG4gICAqIEEgbmFtZSBmb3IgdGhlIGZ1bmN0aW9uLlxuICAgKiBEZWZhdWx0cyB0byB0aGUgYmFzZW5hbWUgb2YgdGhlIGVudHJ5IHBhdGggaWYgc3BlY2lmaWVkLlxuICAgKiBJZiBubyBlbnRyeSBpcyBzcGVjaWZpZWQsIGRlZmF1bHRzIHRvIHRoZSBkaXJlY3RvcnkgbmFtZSBpbiB3aGljaCB0aGlzIGZ1bmN0aW9uIGlzIGRlZmluZWQuXG4gICAqXG4gICAqIEV4YW1wbGU6XG4gICAqIElmIGVudHJ5IGlzIGAuL3NjaGVkdWxlZC1kYi1iYWNrdXAudHNgIHRoZSBuYW1lIHdpbGwgZGVmYXVsdCB0byBcInNjaGVkdWxlZC1kYi1iYWNrdXBcIlxuICAgKiBJZiBlbnRyeSBpcyBub3Qgc2V0IGFuZCB0aGUgZnVuY3Rpb24gaXMgZGVmaW5lZCBpbiBgYW1wbGlmeS9mdW5jdGlvbnMvZGItYmFja3VwL3Jlc291cmNlLnRzYCB0aGUgbmFtZSB3aWxsIGRlZmF1bHQgdG8gXCJkYi1iYWNrdXBcIlxuICAgKi9cbiAgbmFtZT86IHN0cmluZztcbiAgLyoqXG4gICAqIFRoZSBwYXRoIHRvIHRoZSBmaWxlIHRoYXQgY29udGFpbnMgdGhlIGZ1bmN0aW9uIGVudHJ5IHBvaW50LlxuICAgKiBJZiB0aGlzIGlzIGEgcmVsYXRpdmUgcGF0aCwgaXQgaXMgY29tcHV0ZWQgcmVsYXRpdmUgdG8gdGhlIGZpbGUgd2hlcmUgdGhpcyBmdW5jdGlvbiBpcyBkZWZpbmVkXG4gICAqXG4gICAqIERlZmF1bHRzIHRvICcuL2hhbmRsZXIudHMnXG4gICAqL1xuICBlbnRyeT86IHN0cmluZztcblxuICAvKipcbiAgICogQW4gYW1vdW50IG9mIHRpbWUgaW4gc2Vjb25kcyBiZXR3ZWVuIDEgc2Vjb25kIGFuZCAxNSBtaW51dGVzLlxuICAgKiBNdXN0IGJlIGEgd2hvbGUgbnVtYmVyLlxuICAgKiBEZWZhdWx0IGlzIDMgc2Vjb25kcy5cbiAgICovXG4gIHRpbWVvdXRTZWNvbmRzPzogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBBbiBhbW91bnQgb2YgbWVtb3J5IChSQU0pIHRvIGFsbG9jYXRlIHRvIHRoZSBmdW5jdGlvbiBiZXR3ZWVuIDEyOCBhbmQgMTAyNDAgTUIuXG4gICAqIE11c3QgYmUgYSB3aG9sZSBudW1iZXIuXG4gICAqIERlZmF1bHQgaXMgNTEyTUIuXG4gICAqL1xuICBtZW1vcnlNQj86IG51bWJlcjtcblxuICAvKipcbiAgICogVGhlIHNpemUgb2YgdGhlIGZ1bmN0aW9uJ3MgL3RtcCBkaXJlY3RvcnkgaW4gTUIuXG4gICAqIE11c3QgYmUgYSB3aG9sZSBudW1iZXIuXG4gICAqIEBkZWZhdWx0IDUxMlxuICAgKi9cbiAgZXBoZW1lcmFsU3RvcmFnZVNpemVNQj86IG51bWJlcjtcblxuICAvKipcbiAgICogRW52aXJvbm1lbnQgdmFyaWFibGVzIHRoYXQgd2lsbCBiZSBhdmFpbGFibGUgZHVyaW5nIGZ1bmN0aW9uIGV4ZWN1dGlvblxuICAgKi9cbiAgZW52aXJvbm1lbnQ/OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmcgfCBCYWNrZW5kU2VjcmV0PjtcblxuICAvKipcbiAgICogTm9kZSBydW50aW1lIHZlcnNpb24gZm9yIHRoZSBsYW1iZGEgZW52aXJvbm1lbnQuXG4gICAqXG4gICAqIERlZmF1bHRzIHRvIHRoZSBvbGRlc3QgTm9kZUpTIExUUyB2ZXJzaW9uLiBTZWUgaHR0cHM6Ly9ub2RlanMub3JnL2VuL2Fib3V0L3ByZXZpb3VzLXJlbGVhc2VzXG4gICAqL1xuICBydW50aW1lPzogTm9kZVZlcnNpb247XG5cbiAgLyoqXG4gICAqIFRoZSBhcmNoaXRlY3R1cmUgb2YgdGhlIHRhcmdldCBwbGF0Zm9ybSBmb3IgdGhlIGxhbWJkYSBlbnZpcm9ubWVudC5cbiAgICogRGVmYXVsdHMgdG8gWDg2XzY0LlxuICAgKi9cbiAgYXJjaGl0ZWN0dXJlPzogRnVuY3Rpb25BcmNoaXRlY3R1cmU7XG5cbiAgLyoqXG4gICAqIEEgdGltZSBpbnRlcnZhbCBzdHJpbmcgdG8gcGVyaW9kaWNhbGx5IHJ1biB0aGUgZnVuY3Rpb24uXG4gICAqIFRoaXMgY2FuIGJlIGVpdGhlciBhIHN0cmluZyBvZiBgXCJldmVyeSA8cG9zaXRpdmUgd2hvbGUgbnVtYmVyPjxtIChtaW51dGUpIG9yIGggKGhvdXIpPlwiYCwgYFwiZXZlcnkgZGF5fHdlZWt8bW9udGh8eWVhclwiYCBvciBjcm9uIGV4cHJlc3Npb24uXG4gICAqIERlZmF1bHRzIHRvIG5vIHNjaGVkdWxpbmcgZm9yIHRoZSBmdW5jdGlvbi5cbiAgICogQGV4YW1wbGVcbiAgICogc2NoZWR1bGU6IFwiZXZlcnkgNW1cIlxuICAgKiBAZXhhbXBsZVxuICAgKiBzY2hlZHVsZTogXCJldmVyeSB3ZWVrXCJcbiAgICogQGV4YW1wbGVcbiAgICogc2NoZWR1bGU6IFwiMCA5ID8gKiAyICpcIiAvLyBldmVyeSBNb25kYXkgYXQgOWFtXG4gICAqL1xuICBzY2hlZHVsZT86IEZ1bmN0aW9uU2NoZWR1bGUgfCBGdW5jdGlvblNjaGVkdWxlW107XG5cbiAgLyoqXG4gICAqIEF0dGFjaCBMYW1iZGEgbGF5ZXJzIHRvIGEgZnVuY3Rpb25cbiAgICogLSBBIExhbWJkYSBsYXllciBpcyByZXByZXNlbnRlZCBieSBhbiBvYmplY3Qgb2Yga2V5L3ZhbHVlIHBhaXIgd2hlcmUgdGhlIGtleSBpcyB0aGUgbW9kdWxlIG5hbWUgdGhhdCBpcyBleHBvcnRlZCBmcm9tIHlvdXIgbGF5ZXIgYW5kIHRoZSB2YWx1ZSBpcyB0aGUgQVJOIG9mIHRoZSBsYXllci4gVGhlIGtleSAobW9kdWxlIG5hbWUpIGlzIHVzZWQgdG8gZXh0ZXJuYWxpemUgdGhlIG1vZHVsZSBkZXBlbmRlbmN5IHNvIGl0IGRvZXNuJ3QgZ2V0IGJ1bmRsZWQgd2l0aCB5b3VyIGxhbWJkYSBmdW5jdGlvblxuICAgKiAtIE1heGltdW0gb2YgNSBsYXllcnMgY2FuIGJlIGF0dGFjaGVkIHRvIGEgZnVuY3Rpb24gYW5kIG11c3QgYmUgaW4gdGhlIHNhbWUgcmVnaW9uIGFzIHRoZSBmdW5jdGlvbi5cbiAgICogQGV4YW1wbGVcbiAgICogbGF5ZXJzOiB7XG4gICAqICAgIFwiQGF3cy1sYW1iZGEtcG93ZXJ0b29scy9sb2dnZXJcIjogXCJhcm46YXdzOmxhbWJkYTo8Y3VycmVudC1yZWdpb24+OjA5NDI3NDEwNTkxNTpsYXllcjpBV1NMYW1iZGFQb3dlcnRvb2xzVHlwZVNjcmlwdFYyOjExXCJcbiAgICogfSxcbiAgICogb3JcbiAgICogQGV4YW1wbGVcbiAgICogbGF5ZXJzOiB7XG4gICAqICAgIFwiU2hhcnBcIjogXCJTaGFycExheWVyOjFcIlxuICAgKiB9LFxuICAgKiBAc2VlIFtBbXBsaWZ5IGRvY3VtZW50YXRpb24gZm9yIExhbWJkYSBsYXllcnNdKGh0dHBzOi8vZG9jcy5hbXBsaWZ5LmF3cy9yZWFjdC9idWlsZC1hLWJhY2tlbmQvZnVuY3Rpb25zL2FkZC1sYW1iZGEtbGF5ZXJzKVxuICAgKiBAc2VlIFtBV1MgZG9jdW1lbnRhdGlvbiBmb3IgTGFtYmRhIGxheWVyc10oaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2xhbWJkYS9sYXRlc3QvZGcvY2hhcHRlci1sYXllcnMuaHRtbClcbiAgICovXG4gIGxheWVycz86IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG5cbiAgLypcbiAgICogT3B0aW9ucyBmb3IgYnVuZGxpbmcgdGhlIGZ1bmN0aW9uIGNvZGUuXG4gICAqL1xuICBidW5kbGluZz86IEZ1bmN0aW9uQnVuZGxpbmdPcHRpb25zO1xuXG4gIC8qKlxuICAgKiBHcm91cCB0aGUgZnVuY3Rpb24gd2l0aCBleGlzdGluZyBBbXBsaWZ5IHJlc291cmNlcyBvciBzZXBhcmF0ZSB0aGUgZnVuY3Rpb24gaW50byBpdHMgb3duIGdyb3VwLlxuICAgKiBAZGVmYXVsdCAnZnVuY3Rpb24nIC8vIGdyb3VwaW5nIHdpdGggb3RoZXIgQW1wbGlmeSBmdW5jdGlvbnNcbiAgICogQGV4YW1wbGVcbiAgICogcmVzb3VyY2VHcm91cE5hbWU6ICdhdXRoJyAvLyB0byBncm91cCBhbiBhdXRoIHRyaWdnZXIgd2l0aCBhbiBhdXRoIHJlc291cmNlXG4gICAqL1xuICByZXNvdXJjZUdyb3VwTmFtZT86IEFtcGxpZnlSZXNvdXJjZUdyb3VwTmFtZTtcblxuICBsb2dnaW5nPzogRnVuY3Rpb25Mb2dnaW5nT3B0aW9ucztcbn07XG5cbmV4cG9ydCB0eXBlIEZ1bmN0aW9uQnVuZGxpbmdPcHRpb25zID0ge1xuICAvKipcbiAgICogV2hldGhlciB0byBtaW5pZnkgdGhlIGZ1bmN0aW9uIGNvZGUuXG4gICAqXG4gICAqIERlZmF1bHRzIHRvIHRydWUuXG4gICAqL1xuICBtaW5pZnk/OiBib29sZWFuO1xufTtcblxuZXhwb3J0IHR5cGUgRnVuY3Rpb25Mb2dnaW5nT3B0aW9ucyA9IChcbiAgfCB7XG4gICAgICBmb3JtYXQ6ICdqc29uJztcbiAgICAgIGxldmVsPzogRnVuY3Rpb25Mb2dMZXZlbDtcbiAgICB9XG4gIHwge1xuICAgICAgZm9ybWF0PzogJ3RleHQnO1xuICAgIH1cbikgJiB7XG4gIHJldGVudGlvbj86IEZ1bmN0aW9uTG9nUmV0ZW50aW9uO1xufTtcblxuLyoqXG4gKiBDcmVhdGUgTGFtYmRhIGZ1bmN0aW9ucyBpbiB0aGUgY29udGV4dCBvZiBhbiBBbXBsaWZ5IGJhY2tlbmQgZGVmaW5pdGlvblxuICovXG5jbGFzcyBGdW5jdGlvbkZhY3RvcnkgaW1wbGVtZW50cyBDb25zdHJ1Y3RGYWN0b3J5PEFtcGxpZnlGdW5jdGlvbj4ge1xuICBwcml2YXRlIGdlbmVyYXRvcjogQ29uc3RydWN0Q29udGFpbmVyRW50cnlHZW5lcmF0b3I7XG4gIC8qKlxuICAgKiBDcmVhdGUgYSBuZXcgQW1wbGlmeUZ1bmN0aW9uRmFjdG9yeVxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcm9wczogRnVuY3Rpb25Qcm9wcyxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNhbGxlclN0YWNrPzogc3RyaW5nLFxuICApIHt9XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgYW4gaW5zdGFuY2Ugb2YgQW1wbGlmeUZ1bmN0aW9uIHdpdGhpbiB0aGUgcHJvdmlkZWQgQW1wbGlmeSBjb250ZXh0XG4gICAqL1xuICBnZXRJbnN0YW5jZSA9ICh7XG4gICAgY29uc3RydWN0Q29udGFpbmVyLFxuICAgIG91dHB1dFN0b3JhZ2VTdHJhdGVneSxcbiAgICByZXNvdXJjZU5hbWVWYWxpZGF0b3IsXG4gIH06IENvbnN0cnVjdEZhY3RvcnlHZXRJbnN0YW5jZVByb3BzKTogQW1wbGlmeUZ1bmN0aW9uID0+IHtcbiAgICBpZiAoIXRoaXMuZ2VuZXJhdG9yKSB7XG4gICAgICB0aGlzLmdlbmVyYXRvciA9IG5ldyBGdW5jdGlvbkdlbmVyYXRvcihcbiAgICAgICAgdGhpcy5oeWRyYXRlRGVmYXVsdHMocmVzb3VyY2VOYW1lVmFsaWRhdG9yKSxcbiAgICAgICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5LFxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbnN0cnVjdENvbnRhaW5lci5nZXRPckNvbXB1dGUodGhpcy5nZW5lcmF0b3IpIGFzIEFtcGxpZnlGdW5jdGlvbjtcbiAgfTtcblxuICBwcml2YXRlIGh5ZHJhdGVEZWZhdWx0cyA9IChcbiAgICByZXNvdXJjZU5hbWVWYWxpZGF0b3I/OiBSZXNvdXJjZU5hbWVWYWxpZGF0b3IsXG4gICk6IEh5ZHJhdGVkRnVuY3Rpb25Qcm9wcyA9PiB7XG4gICAgY29uc3QgbmFtZSA9IHRoaXMucmVzb2x2ZU5hbWUoKTtcbiAgICByZXNvdXJjZU5hbWVWYWxpZGF0b3I/LnZhbGlkYXRlKG5hbWUpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWUsXG4gICAgICBlbnRyeTogdGhpcy5yZXNvbHZlRW50cnkoKSxcbiAgICAgIHRpbWVvdXRTZWNvbmRzOiB0aGlzLnJlc29sdmVUaW1lb3V0KCksXG4gICAgICBtZW1vcnlNQjogdGhpcy5yZXNvbHZlTWVtb3J5KCksXG4gICAgICBlcGhlbWVyYWxTdG9yYWdlU2l6ZU1COiB0aGlzLnJlc29sdmVFcGhlbWVyYWxTdG9yYWdlU2l6ZSgpLFxuICAgICAgZW52aXJvbm1lbnQ6IHRoaXMucmVzb2x2ZUVudmlyb25tZW50KCksXG4gICAgICBydW50aW1lOiB0aGlzLnJlc29sdmVSdW50aW1lKCksXG4gICAgICBhcmNoaXRlY3R1cmU6IHRoaXMucmVzb2x2ZUFyY2hpdGVjdHVyZSgpLFxuICAgICAgc2NoZWR1bGU6IHRoaXMucmVzb2x2ZVNjaGVkdWxlKCksXG4gICAgICBidW5kbGluZzogdGhpcy5yZXNvbHZlQnVuZGxpbmcoKSxcbiAgICAgIGxheWVyczogdGhpcy5wcm9wcy5sYXllcnMgPz8ge30sXG4gICAgICByZXNvdXJjZUdyb3VwTmFtZTogdGhpcy5wcm9wcy5yZXNvdXJjZUdyb3VwTmFtZSA/PyAnZnVuY3Rpb24nLFxuICAgICAgbG9nZ2luZzogdGhpcy5wcm9wcy5sb2dnaW5nID8/IHt9LFxuICAgIH07XG4gIH07XG5cbiAgcHJpdmF0ZSByZXNvbHZlTmFtZSA9ICgpID0+IHtcbiAgICAvLyBJZiBuYW1lIGlzIHNldCBleHBsaWNpdGx5LCB1c2UgdGhhdFxuICAgIGlmICh0aGlzLnByb3BzLm5hbWUpIHtcbiAgICAgIHJldHVybiB0aGlzLnByb3BzLm5hbWU7XG4gICAgfVxuICAgIC8vIElmIGVudHJ5IGlzIHNldCwgdXNlIHRoZSBiYXNlbmFtZSBvZiB0aGUgZW50cnkgcGF0aFxuICAgIGlmICh0aGlzLnByb3BzLmVudHJ5KSB7XG4gICAgICByZXR1cm4gcGF0aC5wYXJzZSh0aGlzLnByb3BzLmVudHJ5KS5uYW1lO1xuICAgIH1cblxuICAgIC8vIE90aGVyd2lzZSwgdXNlIHRoZSBkaXJlY3RvcnkgbmFtZSB3aGVyZSB0aGUgZnVuY3Rpb24gaXMgZGVmaW5lZFxuICAgIHJldHVybiBwYXRoLmJhc2VuYW1lKFxuICAgICAgbmV3IENhbGxlckRpcmVjdG9yeUV4dHJhY3Rvcih0aGlzLmNhbGxlclN0YWNrKS5leHRyYWN0KCksXG4gICAgKTtcbiAgfTtcblxuICBwcml2YXRlIHJlc29sdmVFbnRyeSA9ICgpID0+IHtcbiAgICAvLyBpZiBlbnRyeSBpcyBub3Qgc2V0LCBkZWZhdWx0IHRvIGhhbmRsZXIudHNcbiAgICBpZiAoIXRoaXMucHJvcHMuZW50cnkpIHtcbiAgICAgIHJldHVybiBwYXRoLmpvaW4oXG4gICAgICAgIG5ldyBDYWxsZXJEaXJlY3RvcnlFeHRyYWN0b3IodGhpcy5jYWxsZXJTdGFjaykuZXh0cmFjdCgpLFxuICAgICAgICAnaGFuZGxlci50cycsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIGlmIGVudHJ5IGlzIGFic29sdXRlIHVzZSB0aGF0XG4gICAgaWYgKHBhdGguaXNBYnNvbHV0ZSh0aGlzLnByb3BzLmVudHJ5KSkge1xuICAgICAgcmV0dXJuIHRoaXMucHJvcHMuZW50cnk7XG4gICAgfVxuXG4gICAgLy8gaWYgZW50cnkgaXMgcmVsYXRpdmUsIGNvbXB1dGUgd2l0aCByZXNwZWN0IHRvIHRoZSBjYWxsZXIgZGlyZWN0b3J5XG4gICAgcmV0dXJuIHBhdGguam9pbihcbiAgICAgIG5ldyBDYWxsZXJEaXJlY3RvcnlFeHRyYWN0b3IodGhpcy5jYWxsZXJTdGFjaykuZXh0cmFjdCgpLFxuICAgICAgdGhpcy5wcm9wcy5lbnRyeSxcbiAgICApO1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZVRpbWVvdXQgPSAoKSA9PiB7XG4gICAgY29uc3QgdGltZW91dE1pbiA9IDE7XG4gICAgY29uc3QgdGltZW91dE1heCA9IDYwICogMTU7IC8vIDE1IG1pbnV0ZXMgaW4gc2Vjb25kc1xuICAgIGNvbnN0IHRpbWVvdXREZWZhdWx0ID0gMztcbiAgICBpZiAodGhpcy5wcm9wcy50aW1lb3V0U2Vjb25kcyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gdGltZW91dERlZmF1bHQ7XG4gICAgfVxuXG4gICAgaWYgKFxuICAgICAgIWlzV2hvbGVOdW1iZXJCZXR3ZWVuSW5jbHVzaXZlKFxuICAgICAgICB0aGlzLnByb3BzLnRpbWVvdXRTZWNvbmRzLFxuICAgICAgICB0aW1lb3V0TWluLFxuICAgICAgICB0aW1lb3V0TWF4LFxuICAgICAgKVxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoJ0ludmFsaWRUaW1lb3V0RXJyb3InLCB7XG4gICAgICAgIG1lc3NhZ2U6IGBJbnZhbGlkIGZ1bmN0aW9uIHRpbWVvdXQgb2YgJHt0aGlzLnByb3BzLnRpbWVvdXRTZWNvbmRzfWAsXG4gICAgICAgIHJlc29sdXRpb246IGB0aW1lb3V0U2Vjb25kcyBtdXN0IGJlIGEgd2hvbGUgbnVtYmVyIGJldHdlZW4gJHt0aW1lb3V0TWlufSBhbmQgJHt0aW1lb3V0TWF4fSBpbmNsdXNpdmVgLFxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnByb3BzLnRpbWVvdXRTZWNvbmRzO1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZU1lbW9yeSA9ICgpID0+IHtcbiAgICBjb25zdCBtZW1vcnlNaW4gPSAxMjg7XG4gICAgY29uc3QgbWVtb3J5TWF4ID0gMTAyNDA7XG4gICAgY29uc3QgbWVtb3J5RGVmYXVsdCA9IDUxMjtcbiAgICBpZiAodGhpcy5wcm9wcy5tZW1vcnlNQiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gbWVtb3J5RGVmYXVsdDtcbiAgICB9XG4gICAgaWYgKFxuICAgICAgIWlzV2hvbGVOdW1iZXJCZXR3ZWVuSW5jbHVzaXZlKHRoaXMucHJvcHMubWVtb3J5TUIsIG1lbW9yeU1pbiwgbWVtb3J5TWF4KVxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoJ0ludmFsaWRNZW1vcnlNQkVycm9yJywge1xuICAgICAgICBtZXNzYWdlOiBgSW52YWxpZCBmdW5jdGlvbiBtZW1vcnlNQiBvZiAke3RoaXMucHJvcHMubWVtb3J5TUJ9YCxcbiAgICAgICAgcmVzb2x1dGlvbjogYG1lbW9yeU1CIG11c3QgYmUgYSB3aG9sZSBudW1iZXIgYmV0d2VlbiAke21lbW9yeU1pbn0gYW5kICR7bWVtb3J5TWF4fSBpbmNsdXNpdmVgLFxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnByb3BzLm1lbW9yeU1CO1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZUVwaGVtZXJhbFN0b3JhZ2VTaXplID0gKCkgPT4ge1xuICAgIGNvbnN0IGVwaGVtZXJhbFN0b3JhZ2VTaXplTWluID0gNTEyO1xuICAgIGNvbnN0IGVwaGVtZXJhbFN0b3JhZ2VTaXplTWF4ID0gMTAyNDA7XG4gICAgY29uc3QgZXBoZW1lcmFsU3RvcmFnZVNpemVEZWZhdWx0ID0gNTEyO1xuICAgIGlmICh0aGlzLnByb3BzLmVwaGVtZXJhbFN0b3JhZ2VTaXplTUIgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIGVwaGVtZXJhbFN0b3JhZ2VTaXplRGVmYXVsdDtcbiAgICB9XG4gICAgaWYgKFxuICAgICAgIWlzV2hvbGVOdW1iZXJCZXR3ZWVuSW5jbHVzaXZlKFxuICAgICAgICB0aGlzLnByb3BzLmVwaGVtZXJhbFN0b3JhZ2VTaXplTUIsXG4gICAgICAgIGVwaGVtZXJhbFN0b3JhZ2VTaXplTWluLFxuICAgICAgICBlcGhlbWVyYWxTdG9yYWdlU2l6ZU1heCxcbiAgICAgIClcbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKCdJbnZhbGlkRXBoZW1lcmFsU3RvcmFnZVNpemVNQkVycm9yJywge1xuICAgICAgICBtZXNzYWdlOiBgSW52YWxpZCBmdW5jdGlvbiBlcGhlbWVyYWxTdG9yYWdlU2l6ZU1CIG9mICR7dGhpcy5wcm9wcy5lcGhlbWVyYWxTdG9yYWdlU2l6ZU1CfWAsXG4gICAgICAgIHJlc29sdXRpb246IGBlcGhlbWVyYWxTdG9yYWdlU2l6ZU1CIG11c3QgYmUgYSB3aG9sZSBudW1iZXIgYmV0d2VlbiAke2VwaGVtZXJhbFN0b3JhZ2VTaXplTWlufSBhbmQgJHtlcGhlbWVyYWxTdG9yYWdlU2l6ZU1heH0gaW5jbHVzaXZlYCxcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5wcm9wcy5lcGhlbWVyYWxTdG9yYWdlU2l6ZU1CO1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZUVudmlyb25tZW50ID0gKCkgPT4ge1xuICAgIGlmICh0aGlzLnByb3BzLmVudmlyb25tZW50ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiB7fTtcbiAgICB9XG5cbiAgICBjb25zdCBpbnZhbGlkS2V5czogc3RyaW5nW10gPSBbXTtcblxuICAgIE9iamVjdC5rZXlzKHRoaXMucHJvcHMuZW52aXJvbm1lbnQpLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgLy8gdmFsaWRhdGUgdXNpbmcga2V5IHBhdHRlcm4gZnJvbSBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vbGFtYmRhL2xhdGVzdC9hcGkvQVBJX0Vudmlyb25tZW50Lmh0bWxcbiAgICAgIGlmICgha2V5Lm1hdGNoKC9eW2EtekEtWl0oW2EtekEtWjAtOV9dKSskLykpIHtcbiAgICAgICAgaW52YWxpZEtleXMucHVzaChrZXkpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgaWYgKGludmFsaWRLZXlzLmxlbmd0aCA+IDApIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKCdJbnZhbGlkRW52aXJvbm1lbnRLZXlFcnJvcicsIHtcbiAgICAgICAgbWVzc2FnZTogYEludmFsaWQgZnVuY3Rpb24gZW52aXJvbm1lbnQga2V5KHMpOiAke2ludmFsaWRLZXlzLmpvaW4oXG4gICAgICAgICAgJywgJyxcbiAgICAgICAgKX1gLFxuICAgICAgICByZXNvbHV0aW9uOlxuICAgICAgICAgICdFbnZpcm9ubWVudCBrZXlzIG11c3QgbWF0Y2ggW2EtekEtWl0oW2EtekEtWjAtOV9dKSsgYW5kIGJlIGF0IGxlYXN0IDIgY2hhcmFjdGVycycsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5wcm9wcy5lbnZpcm9ubWVudDtcbiAgfTtcblxuICBwcml2YXRlIHJlc29sdmVSdW50aW1lID0gKCkgPT4ge1xuICAgIGNvbnN0IHJ1bnRpbWVEZWZhdWx0ID0gMjA7XG5cbiAgICAvLyBpZiBydW50aW1lIGlzIG5vdCBzZXQsIGRlZmF1bHQgdG8gdGhlIG9sZGVzdCBMVFNcbiAgICBpZiAoIXRoaXMucHJvcHMucnVudGltZSkge1xuICAgICAgcmV0dXJuIHJ1bnRpbWVEZWZhdWx0O1xuICAgIH1cblxuICAgIGlmICghKHRoaXMucHJvcHMucnVudGltZSBpbiBub2RlVmVyc2lvbk1hcCkpIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKCdJbnZhbGlkUnVudGltZUVycm9yJywge1xuICAgICAgICBtZXNzYWdlOiBgSW52YWxpZCBmdW5jdGlvbiBydW50aW1lIG9mICR7dGhpcy5wcm9wcy5ydW50aW1lfWAsXG4gICAgICAgIHJlc29sdXRpb246IGBydW50aW1lIG11c3QgYmUgb25lIG9mIHRoZSBmb2xsb3dpbmc6ICR7T2JqZWN0LmtleXMoXG4gICAgICAgICAgbm9kZVZlcnNpb25NYXAsXG4gICAgICAgICkuam9pbignLCAnKX1gLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMucHJvcHMucnVudGltZTtcbiAgfTtcblxuICBwcml2YXRlIHJlc29sdmVBcmNoaXRlY3R1cmUgPSAoKSA9PiB7XG4gICAgY29uc3QgYXJjaGl0ZWN0dXJlRGVmYXVsdCA9ICd4ODZfNjQnO1xuXG4gICAgaWYgKCF0aGlzLnByb3BzLmFyY2hpdGVjdHVyZSkge1xuICAgICAgcmV0dXJuIGFyY2hpdGVjdHVyZURlZmF1bHQ7XG4gICAgfVxuXG4gICAgaWYgKCEodGhpcy5wcm9wcy5hcmNoaXRlY3R1cmUgaW4gYXJjaGl0ZWN0dXJlTWFwKSkge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoJ0ludmFsaWRBcmNoaXRlY3R1cmVFcnJvcicsIHtcbiAgICAgICAgbWVzc2FnZTogYEludmFsaWQgZnVuY3Rpb24gYXJjaGl0ZWN0dXJlIG9mICR7dGhpcy5wcm9wcy5hcmNoaXRlY3R1cmV9YCxcbiAgICAgICAgcmVzb2x1dGlvbjogYGFyY2hpdGVjdHVyZSBtdXN0IGJlIG9uZSBvZiB0aGUgZm9sbG93aW5nOiAke09iamVjdC5rZXlzKFxuICAgICAgICAgIGFyY2hpdGVjdHVyZU1hcCxcbiAgICAgICAgKS5qb2luKCcsICcpfWAsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5wcm9wcy5hcmNoaXRlY3R1cmU7XG4gIH07XG5cbiAgcHJpdmF0ZSByZXNvbHZlU2NoZWR1bGUgPSAoKSA9PiB7XG4gICAgaWYgKCF0aGlzLnByb3BzLnNjaGVkdWxlKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMucHJvcHMuc2NoZWR1bGU7XG4gIH07XG5cbiAgcHJpdmF0ZSByZXNvbHZlQnVuZGxpbmcgPSAoKSA9PiB7XG4gICAgY29uc3QgYnVuZGxpbmdEZWZhdWx0ID0ge1xuICAgICAgZm9ybWF0OiBPdXRwdXRGb3JtYXQuRVNNLFxuICAgICAgYnVuZGxlQXdzU0RLOiB0cnVlLFxuICAgICAgbG9hZGVyOiB7XG4gICAgICAgICcubm9kZSc6ICdmaWxlJyxcbiAgICAgIH0sXG4gICAgICBtaW5pZnk6IHRydWUsXG4gICAgICBzb3VyY2VNYXA6IHRydWUsXG4gICAgfTtcblxuICAgIHJldHVybiB7XG4gICAgICAuLi5idW5kbGluZ0RlZmF1bHQsXG4gICAgICBtaW5pZnk6IHRoaXMucmVzb2x2ZU1pbmlmeSh0aGlzLnByb3BzLmJ1bmRsaW5nKSxcbiAgICB9O1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZU1pbmlmeSA9IChidW5kbGluZz86IEZ1bmN0aW9uQnVuZGxpbmdPcHRpb25zKSA9PiB7XG4gICAgcmV0dXJuIGJ1bmRsaW5nPy5taW5pZnkgPT09IHVuZGVmaW5lZCA/IHRydWUgOiBidW5kbGluZy5taW5pZnk7XG4gIH07XG59XG5cbnR5cGUgSHlkcmF0ZWRGdW5jdGlvblByb3BzID0gUmVxdWlyZWQ8RnVuY3Rpb25Qcm9wcz47XG5cbmNsYXNzIEZ1bmN0aW9uR2VuZXJhdG9yIGltcGxlbWVudHMgQ29uc3RydWN0Q29udGFpbmVyRW50cnlHZW5lcmF0b3Ige1xuICByZWFkb25seSByZXNvdXJjZUdyb3VwTmFtZTogQW1wbGlmeVJlc291cmNlR3JvdXBOYW1lO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJvcHM6IEh5ZHJhdGVkRnVuY3Rpb25Qcm9wcyxcbiAgICBwcml2YXRlIHJlYWRvbmx5IG91dHB1dFN0b3JhZ2VTdHJhdGVneTogQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneTxGdW5jdGlvbk91dHB1dD4sXG4gICkge1xuICAgIHRoaXMucmVzb3VyY2VHcm91cE5hbWUgPSBwcm9wcy5yZXNvdXJjZUdyb3VwTmFtZTtcbiAgfVxuXG4gIGdlbmVyYXRlQ29udGFpbmVyRW50cnkgPSAoe1xuICAgIHNjb3BlLFxuICAgIGJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgfTogR2VuZXJhdGVDb250YWluZXJFbnRyeVByb3BzKSA9PiB7XG4gICAgLy8gTW92ZSBsYXllciByZXNvbHV0aW9uIGhlcmUgd2hlcmUgd2UgaGF2ZSBhY2Nlc3MgdG8gc2NvcGVcbiAgICBjb25zdCBwYXJzZXIgPSBuZXcgRnVuY3Rpb25MYXllckFyblBhcnNlcihcbiAgICAgIFN0YWNrLm9mKHNjb3BlKS5yZWdpb24sXG4gICAgICBTdGFjay5vZihzY29wZSkuYWNjb3VudCxcbiAgICApO1xuICAgIGNvbnN0IHJlc29sdmVkTGF5ZXJBcm5zID0gcGFyc2VyLnBhcnNlTGF5ZXJzKFxuICAgICAgdGhpcy5wcm9wcy5sYXllcnMgPz8ge30sXG4gICAgICB0aGlzLnByb3BzLm5hbWUsXG4gICAgKTtcblxuICAgIC8vIHJlc29sdmUgbGF5ZXJzIHRvIExheWVyVmVyc2lvbiBvYmplY3RzIGZvciB0aGUgTm9kZWpzRnVuY3Rpb24gY29uc3RydWN0b3JcbiAgICBjb25zdCByZXNvbHZlZExheWVycyA9IE9iamVjdC5lbnRyaWVzKHJlc29sdmVkTGF5ZXJBcm5zKS5tYXAoKFtrZXksIGFybl0pID0+XG4gICAgICBMYXllclZlcnNpb24uZnJvbUxheWVyVmVyc2lvbkFybihcbiAgICAgICAgc2NvcGUsXG4gICAgICAgIGAke3RoaXMucHJvcHMubmFtZX0tJHtrZXl9LWxheWVyYCxcbiAgICAgICAgYXJuLFxuICAgICAgKSxcbiAgICApO1xuXG4gICAgcmV0dXJuIG5ldyBBbXBsaWZ5RnVuY3Rpb24oXG4gICAgICBzY29wZSxcbiAgICAgIHRoaXMucHJvcHMubmFtZSxcbiAgICAgIHsgLi4udGhpcy5wcm9wcywgcmVzb2x2ZWRMYXllcnMgfSxcbiAgICAgIGJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgICAgIHRoaXMub3V0cHV0U3RvcmFnZVN0cmF0ZWd5LFxuICAgICk7XG4gIH07XG59XG5cbmNsYXNzIEFtcGxpZnlGdW5jdGlvblxuICBleHRlbmRzIEFtcGxpZnlGdW5jdGlvbkJhc2VcbiAgaW1wbGVtZW50cyBBZGRFbnZpcm9ubWVudEZhY3RvcnlcbntcbiAgcmVhZG9ubHkgcmVzb3VyY2VzOiBGdW5jdGlvblJlc291cmNlcztcbiAgcHJpdmF0ZSByZWFkb25seSBmdW5jdGlvbkVudmlyb25tZW50VHJhbnNsYXRvcjogRnVuY3Rpb25FbnZpcm9ubWVudFRyYW5zbGF0b3I7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgaWQ6IHN0cmluZyxcbiAgICBwcm9wczogSHlkcmF0ZWRGdW5jdGlvblByb3BzICYgeyByZXNvbHZlZExheWVyczogSUxheWVyVmVyc2lvbltdIH0sXG4gICAgYmFja2VuZFNlY3JldFJlc29sdmVyOiBCYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5OiBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5PEZ1bmN0aW9uT3V0cHV0PixcbiAgKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCBvdXRwdXRTdG9yYWdlU3RyYXRlZ3kpO1xuXG4gICAgY29uc3QgcnVudGltZSA9IG5vZGVWZXJzaW9uTWFwW3Byb3BzLnJ1bnRpbWVdO1xuXG4gICAgY29uc3QgcmVxdWlyZSA9IGNyZWF0ZVJlcXVpcmUoaW1wb3J0Lm1ldGEudXJsKTtcblxuICAgIGNvbnN0IHNoaW1zID1cbiAgICAgIHJ1bnRpbWUgPT09IFJ1bnRpbWUuTk9ERUpTXzE2X1hcbiAgICAgICAgPyBbXVxuICAgICAgICA6IFtyZXF1aXJlLnJlc29sdmUoJy4vbGFtYmRhLXNoaW1zL2Nqc19zaGltJyldO1xuXG4gICAgY29uc3Qgc3NtUmVzb2x2ZXJGaWxlID1cbiAgICAgIHJ1bnRpbWUgPT09IFJ1bnRpbWUuTk9ERUpTXzE2X1hcbiAgICAgICAgPyByZXF1aXJlLnJlc29sdmUoJy4vbGFtYmRhLXNoaW1zL3Jlc29sdmVfc3NtX3BhcmFtc19zZGtfdjInKSAvLyB1c2UgYXdzIGNkayB2MiBpbiBub2RlIDE2XG4gICAgICAgIDogcmVxdWlyZS5yZXNvbHZlKCcuL2xhbWJkYS1zaGltcy9yZXNvbHZlX3NzbV9wYXJhbXMnKTtcblxuICAgIGNvbnN0IGludm9rZVNzbVJlc29sdmVyRmlsZSA9IHJlcXVpcmUucmVzb2x2ZShcbiAgICAgICcuL2xhbWJkYS1zaGltcy9pbnZva2Vfc3NtX3NoaW0nLFxuICAgICk7XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIGNvZGUgY29uY2F0ZW5hdGVzIHRoZSBjb250ZW50cyBvZiB0aGUgc3NtIHJlc29sdmVyIGFuZCBpbnZva2VyIGludG8gYSBzaW5nbGUgbGluZSB0aGF0IGNhbiBiZSB1c2VkIGFzIHRoZSBlc2J1aWxkIGJhbm5lciBjb250ZW50XG4gICAgICogVGhpcyBiYW5uZXIgaXMgcmVzcG9uc2libGUgZm9yIHJlc29sdmluZyB0aGUgY3VzdG9tZXIncyBTU00gcGFyYW1ldGVycyBhdCBydW50aW1lXG4gICAgICovXG4gICAgY29uc3QgYmFubmVyQ29kZSA9IHJlYWRGaWxlU3luYyhzc21SZXNvbHZlckZpbGUsICd1dGYtOCcpXG4gICAgICAuY29uY2F0KHJlYWRGaWxlU3luYyhpbnZva2VTc21SZXNvbHZlckZpbGUsICd1dGYtOCcpKVxuICAgICAgLnNwbGl0KG5ldyBSZWdFeHAoYCR7RU9MfXxcXG58XFxyYCwgJ2cnKSlcbiAgICAgIC5tYXAoKGxpbmUpID0+IGxpbmUucmVwbGFjZSgvXFwvXFwvLiokLywgJycpKSAvLyBzdHJpcCBvdXQgaW5saW5lIGNvbW1lbnRzIGJlY2F1c2UgdGhlIGJhbm5lciBpcyBnb2luZyB0byBiZSBmbGF0dGVuZWQgaW50byBhIHNpbmdsZSBsaW5lXG4gICAgICAuam9pbignJyk7XG5cbiAgICBjb25zdCBmdW5jdGlvbkVudmlyb25tZW50VHlwZUdlbmVyYXRvciA9XG4gICAgICBuZXcgRnVuY3Rpb25FbnZpcm9ubWVudFR5cGVHZW5lcmF0b3IoaWQpO1xuXG4gICAgLy8gZXNidWlsZCBydW5zIGFzIHBhcnQgb2YgdGhlIE5vZGVqc0Z1bmN0aW9uIGNvbnN0cnVjdG9yLCBzbyB3ZSBlYWdlcmx5IGdlbmVyYXRlIHRoZSBwcm9jZXNzIGVudiBzaGltIHdpdGhvdXQgdHlwZXMgc28gaXQgY2FuIGJlIGluY2x1ZGVkIGluIHRoZSBmdW5jdGlvbiBidW5kbGUuXG4gICAgLy8gVGhpcyB3aWxsIGJlIG92ZXJ3cml0dGVuIHdpdGggdGhlIHR5cGVkIGZpbGUgYXQgdGhlIGVuZCBvZiBzeW50aGVzaXNcbiAgICBmdW5jdGlvbkVudmlyb25tZW50VHlwZUdlbmVyYXRvci5nZW5lcmF0ZVByb2Nlc3NFbnZTaGltKCk7XG5cbiAgICBsZXQgZnVuY3Rpb25MYW1iZGE6IE5vZGVqc0Z1bmN0aW9uO1xuICAgIGNvbnN0IGNka0xvZ2dpbmdPcHRpb25zID0gY29udmVydExvZ2dpbmdPcHRpb25zVG9DREsocHJvcHMubG9nZ2luZyk7XG4gICAgdHJ5IHtcbiAgICAgIGZ1bmN0aW9uTGFtYmRhID0gbmV3IE5vZGVqc0Z1bmN0aW9uKHNjb3BlLCBgJHtpZH0tbGFtYmRhYCwge1xuICAgICAgICBlbnRyeTogcHJvcHMuZW50cnksXG4gICAgICAgIHRpbWVvdXQ6IER1cmF0aW9uLnNlY29uZHMocHJvcHMudGltZW91dFNlY29uZHMpLFxuICAgICAgICBtZW1vcnlTaXplOiBwcm9wcy5tZW1vcnlNQixcbiAgICAgICAgYXJjaGl0ZWN0dXJlOiBhcmNoaXRlY3R1cmVNYXBbcHJvcHMuYXJjaGl0ZWN0dXJlXSxcbiAgICAgICAgZXBoZW1lcmFsU3RvcmFnZVNpemU6IFNpemUubWViaWJ5dGVzKHByb3BzLmVwaGVtZXJhbFN0b3JhZ2VTaXplTUIpLFxuICAgICAgICBydW50aW1lOiBub2RlVmVyc2lvbk1hcFtwcm9wcy5ydW50aW1lXSxcbiAgICAgICAgbGF5ZXJzOiBwcm9wcy5yZXNvbHZlZExheWVycyxcbiAgICAgICAgYnVuZGxpbmc6IHtcbiAgICAgICAgICAuLi5wcm9wcy5idW5kbGluZyxcbiAgICAgICAgICBiYW5uZXI6IGJhbm5lckNvZGUsXG4gICAgICAgICAgaW5qZWN0OiBzaGltcyxcbiAgICAgICAgICBleHRlcm5hbE1vZHVsZXM6IE9iamVjdC5rZXlzKHByb3BzLmxheWVycyksXG4gICAgICAgICAgbG9nTGV2ZWw6IEVzQnVpbGRMb2dMZXZlbC5FUlJPUixcbiAgICAgICAgfSxcbiAgICAgICAgbG9nUmV0ZW50aW9uOiBjZGtMb2dnaW5nT3B0aW9ucy5yZXRlbnRpb24sXG4gICAgICAgIGFwcGxpY2F0aW9uTG9nTGV2ZWxWMjogY2RrTG9nZ2luZ09wdGlvbnMubGV2ZWwsXG4gICAgICAgIGxvZ2dpbmdGb3JtYXQ6IGNka0xvZ2dpbmdPcHRpb25zLmZvcm1hdCxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAvLyBJZiB0aGUgZXJyb3IgaXMgZnJvbSBFUyBCdW5kbGVyIHdoaWNoIGlzIGV4ZWN1dGVkIGFzIGEgY2hpbGQgcHJvY2VzcyBieSBDREssXG4gICAgICAvLyB0aGVuIHRoZSBlcnJvciBmcm9tIENESyBjb250YWlucyB0aGUgY29tbWFuZCB0aGF0IHdhcyBleGVjdXRlZCBhbG9uZyB3aXRoIHRoZSBleGl0IHN0YXR1cy5cbiAgICAgIC8vIFdyYXBwaW5nIGl0IGhlcmUgIHdvdWxkIGNhdXNlIHRoZSBjZGtfZGVwbG95ZXIgdG8gcmUtdGhyb3cgdGhpcyB3cmFwcGVkIGV4Y2VwdGlvblxuICAgICAgLy8gaW5zdGVhZCBvZiBzY3JhcGluZyB0aGUgc3RkZXJyIGZvciBhY3R1YWwgRVNCdWlsZCBlcnJvci5cbiAgICAgIGlmIChcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciAmJlxuICAgICAgICBlcnJvci5tZXNzYWdlLm1hdGNoKC9GYWlsZWQgdG8gYnVuZGxlIGFzc2V0LipleGl0ZWQgd2l0aCBzdGF0dXMvKVxuICAgICAgKSB7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfVxuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICdOb2RlSlNGdW5jdGlvbkNvbnN0cnVjdEluaXRpYWxpemF0aW9uRXJyb3InLFxuICAgICAgICB7XG4gICAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBpbnN0YW50aWF0ZSBub2RlanMgZnVuY3Rpb24gY29uc3RydWN0JyxcbiAgICAgICAgICByZXNvbHV0aW9uOlxuICAgICAgICAgICAgJ1NlZSB0aGUgdW5kZXJseWluZyBlcnJvciBtZXNzYWdlIGZvciBtb3JlIGRldGFpbHMuIFVzZSBgLS1kZWJ1Z2AgZm9yIGFkZGl0aW9uYWwgZGVidWdnaW5nIGluZm9ybWF0aW9uLicsXG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yIGFzIEVycm9yLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgY29uc3Qgc2NoZWR1bGVzID0gY29udmVydEZ1bmN0aW9uU2NoZWR1bGVzVG9SdWxlU2NoZWR1bGVzKFxuICAgICAgICBmdW5jdGlvbkxhbWJkYSxcbiAgICAgICAgcHJvcHMuc2NoZWR1bGUsXG4gICAgICApO1xuICAgICAgY29uc3QgbGFtYmRhVGFyZ2V0ID0gbmV3IHRhcmdldHMuTGFtYmRhRnVuY3Rpb24oZnVuY3Rpb25MYW1iZGEpO1xuXG4gICAgICBzY2hlZHVsZXMuZm9yRWFjaCgoc2NoZWR1bGUsIGluZGV4KSA9PiB7XG4gICAgICAgIC8vIExhbWJkYSBuYW1lIHdpbGwgYmUgcHJlcGVuZGVkIHRvIHJ1bGUgaWQsIHNvIG9ubHkgdXNpbmcgaW5kZXggaGVyZSBmb3IgdW5pcXVlbmVzc1xuICAgICAgICBjb25zdCBydWxlID0gbmV3IFJ1bGUoZnVuY3Rpb25MYW1iZGEsIGBzY2hlZHVsZSR7aW5kZXh9YCwge1xuICAgICAgICAgIHNjaGVkdWxlLFxuICAgICAgICB9KTtcblxuICAgICAgICBydWxlLmFkZFRhcmdldChsYW1iZGFUYXJnZXQpO1xuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAnRnVuY3Rpb25TY2hlZHVsZUluaXRpYWxpemF0aW9uRXJyb3InLFxuICAgICAgICB7XG4gICAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBpbnN0YW50aWF0ZSBzY2hlZHVsZSBmb3Igbm9kZWpzIGZ1bmN0aW9uJyxcbiAgICAgICAgICByZXNvbHV0aW9uOiAnU2VlIHRoZSB1bmRlcmx5aW5nIGVycm9yIG1lc3NhZ2UgZm9yIG1vcmUgZGV0YWlscy4nLFxuICAgICAgICB9LFxuICAgICAgICBlcnJvciBhcyBFcnJvcixcbiAgICAgICk7XG4gICAgfVxuXG4gICAgVGFncy5vZihmdW5jdGlvbkxhbWJkYSkuYWRkKFRhZ05hbWUuRlJJRU5ETFlfTkFNRSwgaWQpO1xuXG4gICAgdGhpcy5mdW5jdGlvbkVudmlyb25tZW50VHJhbnNsYXRvciA9IG5ldyBGdW5jdGlvbkVudmlyb25tZW50VHJhbnNsYXRvcihcbiAgICAgIGZ1bmN0aW9uTGFtYmRhLFxuICAgICAgcHJvcHMuZW52aXJvbm1lbnQsXG4gICAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gICAgICBmdW5jdGlvbkVudmlyb25tZW50VHlwZUdlbmVyYXRvcixcbiAgICApO1xuXG4gICAgdGhpcy5yZXNvdXJjZXMgPSB7XG4gICAgICBsYW1iZGE6IGZ1bmN0aW9uTGFtYmRhLFxuICAgICAgY2ZuUmVzb3VyY2VzOiB7XG4gICAgICAgIGNmbkZ1bmN0aW9uOiBmdW5jdGlvbkxhbWJkYS5ub2RlLmZpbmRDaGlsZCgnUmVzb3VyY2UnKSBhcyBDZm5GdW5jdGlvbixcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIHRoaXMuc3RvcmVPdXRwdXQoKTtcbiAgfVxuXG4gIGFkZEVudmlyb25tZW50ID0gKGtleTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nIHwgQmFja2VuZFNlY3JldCkgPT4ge1xuICAgIHRoaXMuZnVuY3Rpb25FbnZpcm9ubWVudFRyYW5zbGF0b3IuYWRkRW52aXJvbm1lbnRFbnRyeShrZXksIHZhbHVlKTtcbiAgfTtcblxuICBnZXRSZXNvdXJjZUFjY2Vzc0FjY2VwdG9yID0gKCk6IFJlc291cmNlQWNjZXNzQWNjZXB0b3IgPT5cbiAgICBuZXcgRnVuY3Rpb25SZXNvdXJjZUFjY2Vzc0FjY2VwdG9yKFxuICAgICAgdGhpcyxcbiAgICAgIHRoaXMuZnVuY3Rpb25FbnZpcm9ubWVudFRyYW5zbGF0b3IsXG4gICAgKTtcbn1cblxuY29uc3QgaXNXaG9sZU51bWJlckJldHdlZW5JbmNsdXNpdmUgPSAoXG4gIHRlc3Q6IG51bWJlcixcbiAgbWluOiBudW1iZXIsXG4gIG1heDogbnVtYmVyLFxuKSA9PiBtaW4gPD0gdGVzdCAmJiB0ZXN0IDw9IG1heCAmJiB0ZXN0ICUgMSA9PT0gMDtcblxuZXhwb3J0IHR5cGUgTm9kZVZlcnNpb24gPSAxNiB8IDE4IHwgMjAgfCAyMjtcblxuY29uc3Qgbm9kZVZlcnNpb25NYXA6IFJlY29yZDxOb2RlVmVyc2lvbiwgUnVudGltZT4gPSB7XG4gIDE2OiBSdW50aW1lLk5PREVKU18xNl9YLFxuICAxODogUnVudGltZS5OT0RFSlNfMThfWCxcbiAgMjA6IFJ1bnRpbWUuTk9ERUpTXzIwX1gsXG4gIDIyOiBSdW50aW1lLk5PREVKU18yMl9YLFxufTtcblxuZXhwb3J0IHR5cGUgRnVuY3Rpb25BcmNoaXRlY3R1cmUgPSAneDg2XzY0JyB8ICdhcm02NCc7XG5cbmNvbnN0IGFyY2hpdGVjdHVyZU1hcDogUmVjb3JkPEZ1bmN0aW9uQXJjaGl0ZWN0dXJlLCBBcmNoaXRlY3R1cmU+ID0ge1xuICBhcm02NDogQXJjaGl0ZWN0dXJlLkFSTV82NCxcbiAgeDg2XzY0OiBBcmNoaXRlY3R1cmUuWDg2XzY0LFxufTtcbiJdfQ==