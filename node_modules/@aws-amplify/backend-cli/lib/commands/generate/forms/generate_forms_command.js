import path from 'path';
import { BackendOutputClientError, BackendOutputClientErrorType, } from '@aws-amplify/deployed-backend-client';
import { graphqlOutputKey } from '@aws-amplify/backend-output-schemas';
import { DEFAULT_UI_PATH } from '../../../form-generation/default_form_generation_output_paths.js';
import { AmplifyUserError } from '@aws-amplify/platform-core';
/**
 * Command that generates UI forms.
 */
export class GenerateFormsCommand {
    backendIdentifierResolver;
    backendOutputClientBuilder;
    formGenerationHandler;
    /**
     * @inheritDoc
     */
    command;
    /**
     * @inheritDoc
     */
    describe;
    /**
     * Creates UI forms generation command.
     */
    constructor(backendIdentifierResolver, backendOutputClientBuilder, formGenerationHandler) {
        this.backendIdentifierResolver = backendIdentifierResolver;
        this.backendOutputClientBuilder = backendOutputClientBuilder;
        this.formGenerationHandler = formGenerationHandler;
        this.command = 'forms';
        this.describe = 'Generates UI forms';
    }
    getBackendIdentifier = async (args) => {
        return await this.backendIdentifierResolver.resolveDeployedBackendIdentifier(args);
    };
    /**
     * @inheritDoc
     */
    handler = async (args) => {
        const backendIdentifier = await this.backendIdentifierResolver.resolveDeployedBackendIdentifier(args);
        if (!backendIdentifier) {
            throw new AmplifyUserError('BackendIdentifierResolverError', {
                message: 'Could not resolve the backend identifier.',
                resolution: 'Ensure stack name or Amplify App ID and branch specified are correct and exists, then re-run this command.',
            });
        }
        const backendOutputClient = this.backendOutputClientBuilder();
        let output;
        try {
            output = await backendOutputClient.getOutput(backendIdentifier);
        }
        catch (error) {
            if (BackendOutputClientError.isBackendOutputClientError(error)) {
                switch (error.code) {
                    case BackendOutputClientErrorType.DEPLOYMENT_IN_PROGRESS:
                        throw new AmplifyUserError('DeploymentInProgressError', {
                            message: 'Deployment is currently in progress.',
                            resolution: 'Re-run this command once the deployment completes.',
                        }, error);
                    case BackendOutputClientErrorType.NO_STACK_FOUND:
                        throw new AmplifyUserError('StackDoesNotExistError', {
                            message: 'Stack does not exist.',
                            resolution: 'Ensure the CloudFormation stack ID or Amplify App ID and branch specified are correct and exists, then re-run this command.',
                        }, error);
                    case BackendOutputClientErrorType.NO_OUTPUTS_FOUND:
                        throw new AmplifyUserError('AmplifyOutputsNotFoundError', {
                            message: 'Amplify outputs not found in stack metadata',
                            resolution: `Ensure the CloudFormation stack ID or Amplify App ID and branch specified are correct and exists.
        If this is a new sandbox or branch deployment, wait for the deployment to be successfully finished and try again.`,
                        }, error);
                    case BackendOutputClientErrorType.CREDENTIALS_ERROR:
                        throw new AmplifyUserError('CredentialsError', {
                            message: 'Unable to get backend outputs due to invalid credentials.',
                            resolution: 'Ensure your AWS credentials are correctly set and refreshed.',
                        }, error);
                    case BackendOutputClientErrorType.ACCESS_DENIED:
                        throw new AmplifyUserError('AccessDeniedError', {
                            message: 'Unable to get backend outputs due to insufficient permissions.',
                            resolution: 'Ensure you have permissions to call cloudformation:GetTemplateSummary.',
                        }, error);
                    default:
                        throw error;
                }
            }
            throw error;
        }
        if (!(graphqlOutputKey in output) || !output[graphqlOutputKey]) {
            throw new Error('No GraphQL API configured for this backend.');
        }
        const apiUrl = output[graphqlOutputKey].payload.amplifyApiModelSchemaS3Uri;
        if (!args.outDir) {
            throw new Error('out-dir must be defined');
        }
        const outDir = args.outDir;
        await this.formGenerationHandler.generate({
            modelsOutDir: path.join(outDir, 'graphql'),
            backendIdentifier,
            uiOutDir: outDir,
            apiUrl,
            modelsFilter: args.models,
        });
    };
    /**
     * @inheritDoc
     */
    builder = (yargs) => {
        return yargs
            .option('stack', {
            conflicts: ['app-id', 'branch'],
            describe: 'A stack name that contains an Amplify backend',
            type: 'string',
            array: false,
            group: 'Stack identifier',
        })
            .option('app-id', {
            conflicts: ['stack'],
            describe: 'The Amplify App ID of the project',
            type: 'string',
            array: false,
            implies: 'branch',
            group: 'Project identifier',
        })
            .option('branch', {
            conflicts: ['stack'],
            describe: 'A git branch of the Amplify project',
            type: 'string',
            array: false,
            group: 'Project identifier',
            implies: 'app-id',
        })
            .option('out-dir', {
            describe: 'A path to directory where generated forms are written.',
            default: DEFAULT_UI_PATH,
            type: 'string',
            array: false,
            group: 'Form Generation',
        })
            .option('models', {
            describe: 'Model name to generate',
            type: 'string',
            array: true,
            group: 'Form Generation',
        });
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGVfZm9ybXNfY29tbWFuZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21tYW5kcy9nZW5lcmF0ZS9mb3Jtcy9nZW5lcmF0ZV9mb3Jtc19jb21tYW5kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUV4QixPQUFPLEVBRUwsd0JBQXdCLEVBQ3hCLDRCQUE0QixHQUM3QixNQUFNLHNDQUFzQyxDQUFDO0FBQzlDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBRXZFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxrRUFBa0UsQ0FBQztBQUduRyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQWE5RDs7R0FFRztBQUNILE1BQU0sT0FBTyxvQkFBb0I7SUFpQlo7SUFDQTtJQUNBO0lBaEJuQjs7T0FFRztJQUNNLE9BQU8sQ0FBUztJQUV6Qjs7T0FFRztJQUNNLFFBQVEsQ0FBUztJQUUxQjs7T0FFRztJQUNILFlBQ21CLHlCQUFvRCxFQUNwRCwwQkFBcUQsRUFDckQscUJBQTRDO1FBRjVDLDhCQUF5QixHQUF6Qix5QkFBeUIsQ0FBMkI7UUFDcEQsK0JBQTBCLEdBQTFCLDBCQUEwQixDQUEyQjtRQUNyRCwwQkFBcUIsR0FBckIscUJBQXFCLENBQXVCO1FBRTdELElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxRQUFRLEdBQUcsb0JBQW9CLENBQUM7SUFDdkMsQ0FBQztJQUVELG9CQUFvQixHQUFHLEtBQUssRUFBRSxJQUFpQyxFQUFFLEVBQUU7UUFDakUsT0FBTyxNQUFNLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxnQ0FBZ0MsQ0FDMUUsSUFBSSxDQUNMLENBQUM7SUFDSixDQUFDLENBQUM7SUFFRjs7T0FFRztJQUNILE9BQU8sR0FBRyxLQUFLLEVBQ2IsSUFBcUQsRUFD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Q0FBQztJQUNQLENBQUMsQ0FBQztDQUNIIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBBcmd1bWVudHNDYW1lbENhc2UsIEFyZ3YsIENvbW1hbmRNb2R1bGUgfSBmcm9tICd5YXJncyc7XG5pbXBvcnQge1xuICBCYWNrZW5kT3V0cHV0Q2xpZW50LFxuICBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3IsXG4gIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvclR5cGUsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9kZXBsb3llZC1iYWNrZW5kLWNsaWVudCc7XG5pbXBvcnQgeyBncmFwaHFsT3V0cHV0S2V5IH0gZnJvbSAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQtb3V0cHV0LXNjaGVtYXMnO1xuaW1wb3J0IHsgQmFja2VuZElkZW50aWZpZXJSZXNvbHZlciB9IGZyb20gJy4uLy4uLy4uL2JhY2tlbmQtaWRlbnRpZmllci9iYWNrZW5kX2lkZW50aWZpZXJfcmVzb2x2ZXIuanMnO1xuaW1wb3J0IHsgREVGQVVMVF9VSV9QQVRIIH0gZnJvbSAnLi4vLi4vLi4vZm9ybS1nZW5lcmF0aW9uL2RlZmF1bHRfZm9ybV9nZW5lcmF0aW9uX291dHB1dF9wYXRocy5qcyc7XG5pbXBvcnQgeyBGb3JtR2VuZXJhdGlvbkhhbmRsZXIgfSBmcm9tICcuLi8uLi8uLi9mb3JtLWdlbmVyYXRpb24vZm9ybV9nZW5lcmF0aW9uX2hhbmRsZXIuanMnO1xuaW1wb3J0IHsgQXJndW1lbnRzS2ViYWJDYXNlIH0gZnJvbSAnLi4vLi4vLi4va2ViYWJfY2FzZS5qcyc7XG5pbXBvcnQgeyBBbXBsaWZ5VXNlckVycm9yIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsYXRmb3JtLWNvcmUnO1xuXG5leHBvcnQgdHlwZSBHZW5lcmF0ZUZvcm1zQ29tbWFuZE9wdGlvbnMgPVxuICBBcmd1bWVudHNLZWJhYkNhc2U8R2VuZXJhdGVGb3Jtc0NvbW1hbmRPcHRpb25zQ2FtZWxDYXNlPjtcblxudHlwZSBHZW5lcmF0ZUZvcm1zQ29tbWFuZE9wdGlvbnNDYW1lbENhc2UgPSB7XG4gIHN0YWNrOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIGFwcElkOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIGJyYW5jaDogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBvdXREaXI6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgbW9kZWxzOiBzdHJpbmdbXSB8IHVuZGVmaW5lZDtcbn07XG5cbi8qKlxuICogQ29tbWFuZCB0aGF0IGdlbmVyYXRlcyBVSSBmb3Jtcy5cbiAqL1xuZXhwb3J0IGNsYXNzIEdlbmVyYXRlRm9ybXNDb21tYW5kXG4gIGltcGxlbWVudHMgQ29tbWFuZE1vZHVsZTxvYmplY3QsIEdlbmVyYXRlRm9ybXNDb21tYW5kT3B0aW9ucz5cbntcbiAgLyoqXG4gICAqIEBpbmhlcml0RG9jXG4gICAqL1xuICByZWFkb25seSBjb21tYW5kOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0RG9jXG4gICAqL1xuICByZWFkb25seSBkZXNjcmliZTogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBDcmVhdGVzIFVJIGZvcm1zIGdlbmVyYXRpb24gY29tbWFuZC5cbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYmFja2VuZElkZW50aWZpZXJSZXNvbHZlcjogQmFja2VuZElkZW50aWZpZXJSZXNvbHZlcixcbiAgICBwcml2YXRlIHJlYWRvbmx5IGJhY2tlbmRPdXRwdXRDbGllbnRCdWlsZGVyOiAoKSA9PiBCYWNrZW5kT3V0cHV0Q2xpZW50LFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZm9ybUdlbmVyYXRpb25IYW5kbGVyOiBGb3JtR2VuZXJhdGlvbkhhbmRsZXIsXG4gICkge1xuICAgIHRoaXMuY29tbWFuZCA9ICdmb3Jtcyc7XG4gICAgdGhpcy5kZXNjcmliZSA9ICdHZW5lcmF0ZXMgVUkgZm9ybXMnO1xuICB9XG5cbiAgZ2V0QmFja2VuZElkZW50aWZpZXIgPSBhc3luYyAoYXJnczogR2VuZXJhdGVGb3Jtc0NvbW1hbmRPcHRpb25zKSA9PiB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuYmFja2VuZElkZW50aWZpZXJSZXNvbHZlci5yZXNvbHZlRGVwbG95ZWRCYWNrZW5kSWRlbnRpZmllcihcbiAgICAgIGFyZ3MsXG4gICAgKTtcbiAgfTtcblxuICAvKipcbiAgICogQGluaGVyaXREb2NcbiAgICovXG4gIGhhbmRsZXIgPSBhc3luYyAoXG4gICAgYXJnczogQXJndW1lbnRzQ2FtZWxDYXNlPEdlbmVyYXRlRm9ybXNDb21tYW5kT3B0aW9ucz4sXG4gICk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIGNvbnN0IGJhY2tlbmRJZGVudGlmaWVyID1cbiAgICAgIGF3YWl0IHRoaXMuYmFja2VuZElkZW50aWZpZXJSZXNvbHZlci5yZXNvbHZlRGVwbG95ZWRCYWNrZW5kSWRlbnRpZmllcihcbiAgICAgICAgYXJncyxcbiAgICAgICk7XG5cbiAgICBpZiAoIWJhY2tlbmRJZGVudGlmaWVyKSB7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcignQmFja2VuZElkZW50aWZpZXJSZXNvbHZlckVycm9yJywge1xuICAgICAgICBtZXNzYWdlOiAnQ291bGQgbm90IHJlc29sdmUgdGhlIGJhY2tlbmQgaWRlbnRpZmllci4nLFxuICAgICAgICByZXNvbHV0aW9uOlxuICAgICAgICAgICdFbnN1cmUgc3RhY2sgbmFtZSBvciBBbXBsaWZ5IEFwcCBJRCBhbmQgYnJhbmNoIHNwZWNpZmllZCBhcmUgY29ycmVjdCBhbmQgZXhpc3RzLCB0aGVuIHJlLXJ1biB0aGlzIGNvbW1hbmQuJyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IGJhY2tlbmRPdXRwdXRDbGllbnQgPSB0aGlzLmJhY2tlbmRPdXRwdXRDbGllbnRCdWlsZGVyKCk7XG5cbiAgICBsZXQgb3V0cHV0O1xuICAgIHRyeSB7XG4gICAgICBvdXRwdXQgPSBhd2FpdCBiYWNrZW5kT3V0cHV0Q2xpZW50LmdldE91dHB1dChiYWNrZW5kSWRlbnRpZmllcik7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGlmIChCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3IuaXNCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3IoZXJyb3IpKSB7XG4gICAgICAgIHN3aXRjaCAoZXJyb3IuY29kZSkge1xuICAgICAgICAgIGNhc2UgQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZS5ERVBMT1lNRU5UX0lOX1BST0dSRVNTOlxuICAgICAgICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICAgICAgICdEZXBsb3ltZW50SW5Qcm9ncmVzc0Vycm9yJyxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdEZXBsb3ltZW50IGlzIGN1cnJlbnRseSBpbiBwcm9ncmVzcy4nLFxuICAgICAgICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAgICAgICAnUmUtcnVuIHRoaXMgY29tbWFuZCBvbmNlIHRoZSBkZXBsb3ltZW50IGNvbXBsZXRlcy4nLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBlcnJvcixcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgY2FzZSBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3JUeXBlLk5PX1NUQUNLX0ZPVU5EOlxuICAgICAgICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICAgICAgICdTdGFja0RvZXNOb3RFeGlzdEVycm9yJyxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdTdGFjayBkb2VzIG5vdCBleGlzdC4nLFxuICAgICAgICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAgICAgICAnRW5zdXJlIHRoZSBDbG91ZEZvcm1hdGlvbiBzdGFjayBJRCBvciBBbXBsaWZ5IEFwcCBJRCBhbmQgYnJhbmNoIHNwZWNpZmllZCBhcmUgY29ycmVjdCBhbmQgZXhpc3RzLCB0aGVuIHJlLXJ1biB0aGlzIGNvbW1hbmQuJyxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgZXJyb3IsXG4gICAgICAgICAgICApO1xuICAgICAgICAgIGNhc2UgQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZS5OT19PVVRQVVRTX0ZPVU5EOlxuICAgICAgICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICAgICAgICdBbXBsaWZ5T3V0cHV0c05vdEZvdW5kRXJyb3InLFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZTogJ0FtcGxpZnkgb3V0cHV0cyBub3QgZm91bmQgaW4gc3RhY2sgbWV0YWRhdGEnLFxuICAgICAgICAgICAgICAgIHJlc29sdXRpb246IGBFbnN1cmUgdGhlIENsb3VkRm9ybWF0aW9uIHN0YWNrIElEIG9yIEFtcGxpZnkgQXBwIElEIGFuZCBicmFuY2ggc3BlY2lmaWVkIGFyZSBjb3JyZWN0IGFuZCBleGlzdHMuXG4gICAgICAgIElmIHRoaXMgaXMgYSBuZXcgc2FuZGJveCBvciBicmFuY2ggZGVwbG95bWVudCwgd2FpdCBmb3IgdGhlIGRlcGxveW1lbnQgdG8gYmUgc3VjY2Vzc2Z1bGx5IGZpbmlzaGVkIGFuZCB0cnkgYWdhaW4uYCxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgZXJyb3IsXG4gICAgICAgICAgICApO1xuICAgICAgICAgIGNhc2UgQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZS5DUkVERU5USUFMU19FUlJPUjpcbiAgICAgICAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAgICAgICAnQ3JlZGVudGlhbHNFcnJvcicsXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBtZXNzYWdlOlxuICAgICAgICAgICAgICAgICAgJ1VuYWJsZSB0byBnZXQgYmFja2VuZCBvdXRwdXRzIGR1ZSB0byBpbnZhbGlkIGNyZWRlbnRpYWxzLicsXG4gICAgICAgICAgICAgICAgcmVzb2x1dGlvbjpcbiAgICAgICAgICAgICAgICAgICdFbnN1cmUgeW91ciBBV1MgY3JlZGVudGlhbHMgYXJlIGNvcnJlY3RseSBzZXQgYW5kIHJlZnJlc2hlZC4nLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBlcnJvcixcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgY2FzZSBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3JUeXBlLkFDQ0VTU19ERU5JRUQ6XG4gICAgICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgICAgICAgJ0FjY2Vzc0RlbmllZEVycm9yJyxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIG1lc3NhZ2U6XG4gICAgICAgICAgICAgICAgICAnVW5hYmxlIHRvIGdldCBiYWNrZW5kIG91dHB1dHMgZHVlIHRvIGluc3VmZmljaWVudCBwZXJtaXNzaW9ucy4nLFxuICAgICAgICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAgICAgICAnRW5zdXJlIHlvdSBoYXZlIHBlcm1pc3Npb25zIHRvIGNhbGwgY2xvdWRmb3JtYXRpb246R2V0VGVtcGxhdGVTdW1tYXJ5LicsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIGVycm9yLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cblxuICAgIGlmICghKGdyYXBocWxPdXRwdXRLZXkgaW4gb3V0cHV0KSB8fCAhb3V0cHV0W2dyYXBocWxPdXRwdXRLZXldKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIEdyYXBoUUwgQVBJIGNvbmZpZ3VyZWQgZm9yIHRoaXMgYmFja2VuZC4nKTtcbiAgICB9XG5cbiAgICBjb25zdCBhcGlVcmwgPSBvdXRwdXRbZ3JhcGhxbE91dHB1dEtleV0ucGF5bG9hZC5hbXBsaWZ5QXBpTW9kZWxTY2hlbWFTM1VyaTtcblxuICAgIGlmICghYXJncy5vdXREaXIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignb3V0LWRpciBtdXN0IGJlIGRlZmluZWQnKTtcbiAgICB9XG5cbiAgICBjb25zdCBvdXREaXIgPSBhcmdzLm91dERpcjtcblxuICAgIGF3YWl0IHRoaXMuZm9ybUdlbmVyYXRpb25IYW5kbGVyLmdlbmVyYXRlKHtcbiAgICAgIG1vZGVsc091dERpcjogcGF0aC5qb2luKG91dERpciwgJ2dyYXBocWwnKSxcbiAgICAgIGJhY2tlbmRJZGVudGlmaWVyLFxuICAgICAgdWlPdXREaXI6IG91dERpcixcbiAgICAgIGFwaVVybCxcbiAgICAgIG1vZGVsc0ZpbHRlcjogYXJncy5tb2RlbHMsXG4gICAgfSk7XG4gIH07XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0RG9jXG4gICAqL1xuICBidWlsZGVyID0gKHlhcmdzOiBBcmd2KTogQXJndjxHZW5lcmF0ZUZvcm1zQ29tbWFuZE9wdGlvbnM+ID0+IHtcbiAgICByZXR1cm4geWFyZ3NcbiAgICAgIC5vcHRpb24oJ3N0YWNrJywge1xuICAgICAgICBjb25mbGljdHM6IFsnYXBwLWlkJywgJ2JyYW5jaCddLFxuICAgICAgICBkZXNjcmliZTogJ0Egc3RhY2sgbmFtZSB0aGF0IGNvbnRhaW5zIGFuIEFtcGxpZnkgYmFja2VuZCcsXG4gICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICBhcnJheTogZmFsc2UsXG4gICAgICAgIGdyb3VwOiAnU3RhY2sgaWRlbnRpZmllcicsXG4gICAgICB9KVxuICAgICAgLm9wdGlvbignYXBwLWlkJywge1xuICAgICAgICBjb25mbGljdHM6IFsnc3RhY2snXSxcbiAgICAgICAgZGVzY3JpYmU6ICdUaGUgQW1wbGlmeSBBcHAgSUQgb2YgdGhlIHByb2plY3QnLFxuICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgYXJyYXk6IGZhbHNlLFxuICAgICAgICBpbXBsaWVzOiAnYnJhbmNoJyxcbiAgICAgICAgZ3JvdXA6ICdQcm9qZWN0IGlkZW50aWZpZXInLFxuICAgICAgfSlcbiAgICAgIC5vcHRpb24oJ2JyYW5jaCcsIHtcbiAgICAgICAgY29uZmxpY3RzOiBbJ3N0YWNrJ10sXG4gICAgICAgIGRlc2NyaWJlOiAnQSBnaXQgYnJhbmNoIG9mIHRoZSBBbXBsaWZ5IHByb2plY3QnLFxuICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgYXJyYXk6IGZhbHNlLFxuICAgICAgICBncm91cDogJ1Byb2plY3QgaWRlbnRpZmllcicsXG4gICAgICAgIGltcGxpZXM6ICdhcHAtaWQnLFxuICAgICAgfSlcbiAgICAgIC5vcHRpb24oJ291dC1kaXInLCB7XG4gICAgICAgIGRlc2NyaWJlOiAnQSBwYXRoIHRvIGRpcmVjdG9yeSB3aGVyZSBnZW5lcmF0ZWQgZm9ybXMgYXJlIHdyaXR0ZW4uJyxcbiAgICAgICAgZGVmYXVsdDogREVGQVVMVF9VSV9QQVRILFxuICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgYXJyYXk6IGZhbHNlLFxuICAgICAgICBncm91cDogJ0Zvcm0gR2VuZXJhdGlvbicsXG4gICAgICB9KVxuICAgICAgLm9wdGlvbignbW9kZWxzJywge1xuICAgICAgICBkZXNjcmliZTogJ01vZGVsIG5hbWUgdG8gZ2VuZXJhdGUnLFxuICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgYXJyYXk6IHRydWUsXG4gICAgICAgIGdyb3VwOiAnRm9ybSBHZW5lcmF0aW9uJyxcbiAgICAgIH0pO1xuICB9O1xufVxuIl19