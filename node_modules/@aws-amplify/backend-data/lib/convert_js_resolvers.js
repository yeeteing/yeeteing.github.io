import { CfnFunctionConfiguration, CfnResolver } from 'aws-cdk-lib/aws-appsync';
import { resolve } from 'path';
import { fileURLToPath } from 'node:url';
import { readFileSync } from 'fs';
import { Asset } from 'aws-cdk-lib/aws-s3-assets';
import { resolveEntryPath } from './resolve_entry_path.js';
import { CDKContextKey } from '@aws-amplify/platform-core';
const APPSYNC_PIPELINE_RESOLVER = 'PIPELINE';
const APPSYNC_JS_RUNTIME_NAME = 'APPSYNC_JS';
const APPSYNC_JS_RUNTIME_VERSION = '1.0.0';
const JS_PIPELINE_RESOLVER_HANDLER = './assets/js_resolver_handler.js';
/**
 *
 * This returns the top-level passthrough resolver request/response handler (see: https://docs.aws.amazon.com/appsync/latest/devguide/resolver-reference-overview-js.html#anatomy-of-a-pipeline-resolver-js)
 * It's required for defining a pipeline resolver. The only purpose it serves is returning the output of the last function in the pipeline back to the client.
 *
 * Customer-provided handlers are added as a Functions list in `pipelineConfig.functions`
 *
 * Add Amplify API ID and environment name to the context stash for use in the customer-provided handlers.
 */
export const defaultJsResolverCode = (amplifyApiId, amplifyApiEnvironmentName) => {
    const resolvedTemplatePath = resolve(fileURLToPath(import.meta.url), '../../lib', JS_PIPELINE_RESOLVER_HANDLER);
    return readFileSync(resolvedTemplatePath, 'utf-8')
        .replace(new RegExp(/\$\{amplifyApiId\}/, 'g'), amplifyApiId)
        .replace(new RegExp(/\$\{amplifyApiEnvironmentName\}/, 'g'), amplifyApiEnvironmentName);
};
/**
 * Converts JS Resolver definition emitted by data-schema into AppSync pipeline
 * resolvers via L1 construct
 */
export const convertJsResolverDefinition = (scope, amplifyApi, jsResolvers) => {
    if (!jsResolvers || jsResolvers.length < 1) {
        return;
    }
    for (const resolver of jsResolvers) {
        const functions = resolver.handlers.map((handler, idx) => {
            const fnName = `Fn_${resolver.typeName}_${resolver.fieldName}_${idx + 1}`;
            const s3AssetName = `${fnName}_asset`;
            const asset = new Asset(scope, s3AssetName, {
                path: resolveEntryPath(handler.entry),
            });
            const fn = new CfnFunctionConfiguration(scope, fnName, {
                apiId: amplifyApi.apiId,
                dataSourceName: handler.dataSource,
                name: fnName,
                codeS3Location: asset.s3ObjectUrl,
                runtime: {
                    name: APPSYNC_JS_RUNTIME_NAME,
                    runtimeVersion: APPSYNC_JS_RUNTIME_VERSION,
                },
            });
            fn.node.addDependency(amplifyApi);
            return fn.attrFunctionId;
        });
        const resolverName = `Resolver_${resolver.typeName}_${resolver.fieldName}`;
        const isSandboxDeployment = scope.node.tryGetContext(CDKContextKey.DEPLOYMENT_TYPE) === 'sandbox';
        const amplifyApiEnvironmentName = isSandboxDeployment
            ? 'NONE'
            : scope.node.tryGetContext(CDKContextKey.BACKEND_NAME);
        new CfnResolver(scope, resolverName, {
            apiId: amplifyApi.apiId,
            fieldName: resolver.fieldName,
            typeName: resolver.typeName,
            kind: APPSYNC_PIPELINE_RESOLVER,
            // Uses synth-time inline code to avoid circular dependency when adding the API ID as an environment variable.
            code: defaultJsResolverCode(amplifyApi.apiId, amplifyApiEnvironmentName),
            runtime: {
                name: APPSYNC_JS_RUNTIME_NAME,
                runtimeVersion: APPSYNC_JS_RUNTIME_VERSION,
            },
            pipelineConfig: {
                functions,
            },
        }).node.addDependency(amplifyApi);
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udmVydF9qc19yZXNvbHZlcnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvY29udmVydF9qc19yZXNvbHZlcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFFLHdCQUF3QixFQUFFLFdBQVcsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBRWhGLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUN6QyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQ2xDLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUNsRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFFM0QsTUFBTSx5QkFBeUIsR0FBRyxVQUFVLENBQUM7QUFDN0MsTUFBTSx1QkFBdUIsR0FBRyxZQUFZLENBQUM7QUFDN0MsTUFBTSwwQkFBMEIsR0FBRyxPQUFPLENBQUM7QUFDM0MsTUFBTSw0QkFBNEIsR0FBRyxpQ0FBaUMsQ0FBQztBQUV2RTs7Ozs7Ozs7R0FRRztBQUNILE1BQU0sQ0FBQyxNQUFNLHFCQUFxQixHQUFHLENBQ25DLFlBQW9CLEVBQ3BCLHlCQUFpQyxFQUN6QixFQUFFO0lBQ1YsTUFBTSxvQkFBb0IsR0FBRyxPQUFPLENBQ2xDLGFBQWEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUM5QixXQUFXLEVBQ1gsNEJBQTRCLENBQzdCLENBQUM7SUFFRixPQUFPLFlBQVksQ0FBQyxvQkFBb0IsRUFBRSxPQUFPLENBQUM7U0FDL0MsT0FBTyxDQUFDLElBQUksTUFBTSxDQUFDLG9CQUFvQixFQUFFLEdBQUcsQ0FBQyxFQUFFLFlBQVksQ0FBQztTQUM1RCxPQUFPLENBQ04sSUFBSSxNQUFNLENBQUMsaUNBQWlDLEVBQUUsR0FBRyxDQUFDLEVBQ2xELHlCQUF5QixDQUMxQixDQUFDO0FBQ04sQ0FBQyxDQUFDO0FBRUY7OztHQUdHO0FBQ0gsTUFBTSxDQUFDLE1BQU0sMkJBQTJCLEdBQUcsQ0FDekMsS0FBZ0IsRUFDaEIsVUFBdUIsRUFDdkIsV0FBcUMsRUFDL0IsRUFBRTtJQUNSLElBQUksQ0FBQyxXQUFXLElBQUksV0FBVyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztRQUMzQyxPQUFPO0lBQ1QsQ0FBQztJQUVELEtBQUssTUFBTSxRQUFRLElBQUksV0FBVyxFQUFFLENBQUM7UUFDbkMsTUFBTSxTQUFTLEdBQWEsUUFBUSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLEVBQUU7WUFDakUsTUFBTSxNQUFNLEdBQUcsTUFBTSxRQUFRLENBQUMsUUFBUSxJQUFJLFFBQVEsQ0FBQyxTQUFTLElBQUksR0FBRyxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQzFFLE1BQU0sV0FBVyxHQUFHLEdBQUcsTUFBTSxRQUFRLENBQUM7WUFFdEMsTUFBTSxLQUFLLEdBQUcsSUFBSSxLQUFLLENBQUMsS0FBSyxFQUFFLFdBQVcsRUFBRTtnQkFDMUMsSUFBSSxFQUFFLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUM7YUFDdEMsQ0FBQyxDQUFDO1lBRUgsTUFBTSxFQUFFLEdBQUcsSUFBSSx3QkFBd0IsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFO2dCQUNyRCxLQUFLLEVBQUUsVUFBVSxDQUFDLEtBQUs7Z0JBQ3ZCLGNBQWMsRUFBRSxPQUFPLENBQUMsVUFBVTtnQkFDbEMsSUFBSSxFQUFFLE1BQU07Z0JBQ1osY0FBYyxFQUFFLEtBQUssQ0FBQyxXQUFXO2dCQUNqQyxPQUFPLEVBQUU7b0JBQ1AsSUFBSSxFQUFFLHVCQUF1QjtvQkFDN0IsY0FBYyxFQUFFLDBCQUEwQjtpQkFDM0M7YUFDRixDQUFDLENBQUM7WUFDSCxFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUNsQyxPQUFPLEVBQUUsQ0FBQyxjQUFjLENBQUM7UUFDM0IsQ0FBQyxDQUFDLENBQUM7UUFFSCxNQUFNLFlBQVksR0FBRyxZQUFZLFFBQVEsQ0FBQyxRQUFRLElBQUksUUFBUSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBRTNFLE1BQU0sbUJBQW1CLEdBQ3ZCLEtBQUssQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQyxlQUFlLENBQUMsS0FBSyxTQUFTLENBQUM7UUFDeEUsTUFBTSx5QkFBeUIsR0FBRyxtQkFBbUI7WUFDbkQsQ0FBQyxDQUFDLE1BQU07WUFDUixDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ3pELElBQUksV0FBVyxDQUFDLEtBQUssRUFBRSxZQUFZLEVBQUU7WUFDbkMsS0FBSyxFQUFFLFVBQVUsQ0FBQyxLQUFLO1lBQ3ZCLFNBQVMsRUFBRSxRQUFRLENBQUMsU0FBUztZQUM3QixRQUFRLEVBQUUsUUFBUSxDQUFDLFFBQVE7WUFDM0IsSUFBSSxFQUFFLHlCQUF5QjtZQUMvQiw4R0FBOEc7WUFDOUcsSUFBSSxFQUFFLHFCQUFxQixDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUseUJBQXlCLENBQUM7WUFDeEUsT0FBTyxFQUFFO2dCQUNQLElBQUksRUFBRSx1QkFBdUI7Z0JBQzdCLGNBQWMsRUFBRSwwQkFBMEI7YUFDM0M7WUFDRCxjQUFjLEVBQUU7Z0JBQ2QsU0FBUzthQUNWO1NBQ0YsQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDcEMsQ0FBQztBQUNILENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgQW1wbGlmeURhdGEgfSBmcm9tICdAYXdzLWFtcGxpZnkvZGF0YS1jb25zdHJ1Y3QnO1xuaW1wb3J0IHsgQ2ZuRnVuY3Rpb25Db25maWd1cmF0aW9uLCBDZm5SZXNvbHZlciB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1hcHBzeW5jJztcbmltcG9ydCB7IEpzUmVzb2x2ZXIgfSBmcm9tICdAYXdzLWFtcGxpZnkvZGF0YS1zY2hlbWEtdHlwZXMnO1xuaW1wb3J0IHsgcmVzb2x2ZSB9IGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZmlsZVVSTFRvUGF0aCB9IGZyb20gJ25vZGU6dXJsJztcbmltcG9ydCB7IHJlYWRGaWxlU3luYyB9IGZyb20gJ2ZzJztcbmltcG9ydCB7IEFzc2V0IH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLXMzLWFzc2V0cyc7XG5pbXBvcnQgeyByZXNvbHZlRW50cnlQYXRoIH0gZnJvbSAnLi9yZXNvbHZlX2VudHJ5X3BhdGguanMnO1xuaW1wb3J0IHsgQ0RLQ29udGV4dEtleSB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcblxuY29uc3QgQVBQU1lOQ19QSVBFTElORV9SRVNPTFZFUiA9ICdQSVBFTElORSc7XG5jb25zdCBBUFBTWU5DX0pTX1JVTlRJTUVfTkFNRSA9ICdBUFBTWU5DX0pTJztcbmNvbnN0IEFQUFNZTkNfSlNfUlVOVElNRV9WRVJTSU9OID0gJzEuMC4wJztcbmNvbnN0IEpTX1BJUEVMSU5FX1JFU09MVkVSX0hBTkRMRVIgPSAnLi9hc3NldHMvanNfcmVzb2x2ZXJfaGFuZGxlci5qcyc7XG5cbi8qKlxuICpcbiAqIFRoaXMgcmV0dXJucyB0aGUgdG9wLWxldmVsIHBhc3N0aHJvdWdoIHJlc29sdmVyIHJlcXVlc3QvcmVzcG9uc2UgaGFuZGxlciAoc2VlOiBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vYXBwc3luYy9sYXRlc3QvZGV2Z3VpZGUvcmVzb2x2ZXItcmVmZXJlbmNlLW92ZXJ2aWV3LWpzLmh0bWwjYW5hdG9teS1vZi1hLXBpcGVsaW5lLXJlc29sdmVyLWpzKVxuICogSXQncyByZXF1aXJlZCBmb3IgZGVmaW5pbmcgYSBwaXBlbGluZSByZXNvbHZlci4gVGhlIG9ubHkgcHVycG9zZSBpdCBzZXJ2ZXMgaXMgcmV0dXJuaW5nIHRoZSBvdXRwdXQgb2YgdGhlIGxhc3QgZnVuY3Rpb24gaW4gdGhlIHBpcGVsaW5lIGJhY2sgdG8gdGhlIGNsaWVudC5cbiAqXG4gKiBDdXN0b21lci1wcm92aWRlZCBoYW5kbGVycyBhcmUgYWRkZWQgYXMgYSBGdW5jdGlvbnMgbGlzdCBpbiBgcGlwZWxpbmVDb25maWcuZnVuY3Rpb25zYFxuICpcbiAqIEFkZCBBbXBsaWZ5IEFQSSBJRCBhbmQgZW52aXJvbm1lbnQgbmFtZSB0byB0aGUgY29udGV4dCBzdGFzaCBmb3IgdXNlIGluIHRoZSBjdXN0b21lci1wcm92aWRlZCBoYW5kbGVycy5cbiAqL1xuZXhwb3J0IGNvbnN0IGRlZmF1bHRKc1Jlc29sdmVyQ29kZSA9IChcbiAgYW1wbGlmeUFwaUlkOiBzdHJpbmcsXG4gIGFtcGxpZnlBcGlFbnZpcm9ubWVudE5hbWU6IHN0cmluZyxcbik6IHN0cmluZyA9PiB7XG4gIGNvbnN0IHJlc29sdmVkVGVtcGxhdGVQYXRoID0gcmVzb2x2ZShcbiAgICBmaWxlVVJMVG9QYXRoKGltcG9ydC5tZXRhLnVybCksXG4gICAgJy4uLy4uL2xpYicsXG4gICAgSlNfUElQRUxJTkVfUkVTT0xWRVJfSEFORExFUixcbiAgKTtcblxuICByZXR1cm4gcmVhZEZpbGVTeW5jKHJlc29sdmVkVGVtcGxhdGVQYXRoLCAndXRmLTgnKVxuICAgIC5yZXBsYWNlKG5ldyBSZWdFeHAoL1xcJFxce2FtcGxpZnlBcGlJZFxcfS8sICdnJyksIGFtcGxpZnlBcGlJZClcbiAgICAucmVwbGFjZShcbiAgICAgIG5ldyBSZWdFeHAoL1xcJFxce2FtcGxpZnlBcGlFbnZpcm9ubWVudE5hbWVcXH0vLCAnZycpLFxuICAgICAgYW1wbGlmeUFwaUVudmlyb25tZW50TmFtZSxcbiAgICApO1xufTtcblxuLyoqXG4gKiBDb252ZXJ0cyBKUyBSZXNvbHZlciBkZWZpbml0aW9uIGVtaXR0ZWQgYnkgZGF0YS1zY2hlbWEgaW50byBBcHBTeW5jIHBpcGVsaW5lXG4gKiByZXNvbHZlcnMgdmlhIEwxIGNvbnN0cnVjdFxuICovXG5leHBvcnQgY29uc3QgY29udmVydEpzUmVzb2x2ZXJEZWZpbml0aW9uID0gKFxuICBzY29wZTogQ29uc3RydWN0LFxuICBhbXBsaWZ5QXBpOiBBbXBsaWZ5RGF0YSxcbiAganNSZXNvbHZlcnM6IEpzUmVzb2x2ZXJbXSB8IHVuZGVmaW5lZCxcbik6IHZvaWQgPT4ge1xuICBpZiAoIWpzUmVzb2x2ZXJzIHx8IGpzUmVzb2x2ZXJzLmxlbmd0aCA8IDEpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBmb3IgKGNvbnN0IHJlc29sdmVyIG9mIGpzUmVzb2x2ZXJzKSB7XG4gICAgY29uc3QgZnVuY3Rpb25zOiBzdHJpbmdbXSA9IHJlc29sdmVyLmhhbmRsZXJzLm1hcCgoaGFuZGxlciwgaWR4KSA9PiB7XG4gICAgICBjb25zdCBmbk5hbWUgPSBgRm5fJHtyZXNvbHZlci50eXBlTmFtZX1fJHtyZXNvbHZlci5maWVsZE5hbWV9XyR7aWR4ICsgMX1gO1xuICAgICAgY29uc3QgczNBc3NldE5hbWUgPSBgJHtmbk5hbWV9X2Fzc2V0YDtcblxuICAgICAgY29uc3QgYXNzZXQgPSBuZXcgQXNzZXQoc2NvcGUsIHMzQXNzZXROYW1lLCB7XG4gICAgICAgIHBhdGg6IHJlc29sdmVFbnRyeVBhdGgoaGFuZGxlci5lbnRyeSksXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgZm4gPSBuZXcgQ2ZuRnVuY3Rpb25Db25maWd1cmF0aW9uKHNjb3BlLCBmbk5hbWUsIHtcbiAgICAgICAgYXBpSWQ6IGFtcGxpZnlBcGkuYXBpSWQsXG4gICAgICAgIGRhdGFTb3VyY2VOYW1lOiBoYW5kbGVyLmRhdGFTb3VyY2UsXG4gICAgICAgIG5hbWU6IGZuTmFtZSxcbiAgICAgICAgY29kZVMzTG9jYXRpb246IGFzc2V0LnMzT2JqZWN0VXJsLFxuICAgICAgICBydW50aW1lOiB7XG4gICAgICAgICAgbmFtZTogQVBQU1lOQ19KU19SVU5USU1FX05BTUUsXG4gICAgICAgICAgcnVudGltZVZlcnNpb246IEFQUFNZTkNfSlNfUlVOVElNRV9WRVJTSU9OLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgICBmbi5ub2RlLmFkZERlcGVuZGVuY3koYW1wbGlmeUFwaSk7XG4gICAgICByZXR1cm4gZm4uYXR0ckZ1bmN0aW9uSWQ7XG4gICAgfSk7XG5cbiAgICBjb25zdCByZXNvbHZlck5hbWUgPSBgUmVzb2x2ZXJfJHtyZXNvbHZlci50eXBlTmFtZX1fJHtyZXNvbHZlci5maWVsZE5hbWV9YDtcblxuICAgIGNvbnN0IGlzU2FuZGJveERlcGxveW1lbnQgPVxuICAgICAgc2NvcGUubm9kZS50cnlHZXRDb250ZXh0KENES0NvbnRleHRLZXkuREVQTE9ZTUVOVF9UWVBFKSA9PT0gJ3NhbmRib3gnO1xuICAgIGNvbnN0IGFtcGxpZnlBcGlFbnZpcm9ubWVudE5hbWUgPSBpc1NhbmRib3hEZXBsb3ltZW50XG4gICAgICA/ICdOT05FJ1xuICAgICAgOiBzY29wZS5ub2RlLnRyeUdldENvbnRleHQoQ0RLQ29udGV4dEtleS5CQUNLRU5EX05BTUUpO1xuICAgIG5ldyBDZm5SZXNvbHZlcihzY29wZSwgcmVzb2x2ZXJOYW1lLCB7XG4gICAgICBhcGlJZDogYW1wbGlmeUFwaS5hcGlJZCxcbiAgICAgIGZpZWxkTmFtZTogcmVzb2x2ZXIuZmllbGROYW1lLFxuICAgICAgdHlwZU5hbWU6IHJlc29sdmVyLnR5cGVOYW1lLFxuICAgICAga2luZDogQVBQU1lOQ19QSVBFTElORV9SRVNPTFZFUixcbiAgICAgIC8vIFVzZXMgc3ludGgtdGltZSBpbmxpbmUgY29kZSB0byBhdm9pZCBjaXJjdWxhciBkZXBlbmRlbmN5IHdoZW4gYWRkaW5nIHRoZSBBUEkgSUQgYXMgYW4gZW52aXJvbm1lbnQgdmFyaWFibGUuXG4gICAgICBjb2RlOiBkZWZhdWx0SnNSZXNvbHZlckNvZGUoYW1wbGlmeUFwaS5hcGlJZCwgYW1wbGlmeUFwaUVudmlyb25tZW50TmFtZSksXG4gICAgICBydW50aW1lOiB7XG4gICAgICAgIG5hbWU6IEFQUFNZTkNfSlNfUlVOVElNRV9OQU1FLFxuICAgICAgICBydW50aW1lVmVyc2lvbjogQVBQU1lOQ19KU19SVU5USU1FX1ZFUlNJT04sXG4gICAgICB9LFxuICAgICAgcGlwZWxpbmVDb25maWc6IHtcbiAgICAgICAgZnVuY3Rpb25zLFxuICAgICAgfSxcbiAgICB9KS5ub2RlLmFkZERlcGVuZGVuY3koYW1wbGlmeUFwaSk7XG4gIH1cbn07XG4iXX0=