import { AmplifyFault } from '@aws-amplify/platform-core';
/**
 * Converts unified client config to the legacy format.
 */
export class ClientConfigLegacyConverter {
    /**
     * Converts client config to a shape consumable by legacy libraries.
     */
    convertToLegacyConfig = (clientConfig) => {
        // We can only convert from V1.4 of ClientConfig. For everything else, throw
        if (!this.isClientConfigV1_4(clientConfig)) {
            throw new AmplifyFault('UnsupportedClientConfigVersionFault', {
                message: 'Only version 1.4 of ClientConfig is supported.',
            });
        }
        let legacyConfig = {};
        // Gen2 backend constructs use the Stack's region and is identical. We use these to
        // populate the root level aws_project_region in legacy config.
        if (clientConfig.auth || clientConfig.data || clientConfig.storage) {
            legacyConfig.aws_project_region =
                clientConfig.auth?.aws_region ??
                    clientConfig.data?.aws_region ??
                    clientConfig.storage?.aws_region;
        }
        // Auth
        if (clientConfig.auth) {
            const authClientConfig = {
                aws_user_pools_id: clientConfig.auth.user_pool_id,
                aws_cognito_region: clientConfig.auth.aws_region,
                aws_user_pools_web_client_id: clientConfig.auth.user_pool_client_id,
                aws_cognito_identity_pool_id: clientConfig.auth.identity_pool_id,
            };
            if (clientConfig.auth.unauthenticated_identities_enabled) {
                authClientConfig.allowUnauthenticatedIdentities = clientConfig.auth
                    .unauthenticated_identities_enabled
                    ? 'true'
                    : 'false';
            }
            if (clientConfig.auth.mfa_methods) {
                authClientConfig.aws_cognito_mfa_types = clientConfig.auth.mfa_methods;
            }
            if (clientConfig.auth.mfa_configuration) {
                switch (clientConfig.auth.mfa_configuration) {
                    case 'NONE': {
                        authClientConfig.aws_cognito_mfa_configuration = 'OFF';
                        break;
                    }
                    case 'OPTIONAL': {
                        authClientConfig.aws_cognito_mfa_configuration = 'OPTIONAL';
                        break;
                    }
                    case 'REQUIRED': {
                        authClientConfig.aws_cognito_mfa_configuration = 'ON';
                    }
                }
            }
            if (clientConfig.auth.standard_required_attributes) {
                authClientConfig.aws_cognito_signup_attributes =
                    clientConfig.auth.standard_required_attributes?.map((attribute) => attribute.toUpperCase());
            }
            if (clientConfig.auth.username_attributes) {
                authClientConfig.aws_cognito_username_attributes =
                    clientConfig.auth.username_attributes?.map((attribute) => attribute.toUpperCase());
            }
            authClientConfig.aws_cognito_verification_mechanisms =
                clientConfig.auth.user_verification_types?.map((attribute) => attribute.toUpperCase());
            if (clientConfig.auth.password_policy) {
                authClientConfig.aws_cognito_password_protection_settings = {};
                if (clientConfig.auth.password_policy.min_length) {
                    authClientConfig.aws_cognito_password_protection_settings = {
                        passwordPolicyMinLength: clientConfig.auth.password_policy.min_length,
                    };
                }
                const requirements = [];
                if (clientConfig.auth.password_policy.require_numbers) {
                    requirements.push('REQUIRES_NUMBERS');
                }
                if (clientConfig.auth.password_policy.require_lowercase) {
                    requirements.push('REQUIRES_LOWERCASE');
                }
                if (clientConfig.auth.password_policy.require_uppercase) {
                    requirements.push('REQUIRES_UPPERCASE');
                }
                if (clientConfig.auth.password_policy.require_symbols) {
                    requirements.push('REQUIRES_SYMBOLS');
                }
                authClientConfig.aws_cognito_password_protection_settings.passwordPolicyCharacters =
                    requirements;
            }
            if (clientConfig.auth.oauth) {
                authClientConfig.oauth = {};
                authClientConfig.aws_cognito_social_providers =
                    clientConfig.auth.oauth.identity_providers.map((provider) => {
                        if (provider === 'SIGN_IN_WITH_APPLE') {
                            return 'APPLE';
                        }
                        if (provider === 'LOGIN_WITH_AMAZON') {
                            return 'AMAZON';
                        }
                        return provider;
                    });
                authClientConfig.oauth.domain = clientConfig.auth.oauth.domain;
                authClientConfig.oauth.scope = clientConfig.auth.oauth.scopes;
                authClientConfig.oauth.redirectSignIn =
                    clientConfig.auth.oauth.redirect_sign_in_uri.join(',');
                authClientConfig.oauth.redirectSignOut =
                    clientConfig.auth.oauth.redirect_sign_out_uri.join(',');
                authClientConfig.oauth.responseType =
                    clientConfig.auth.oauth.response_type;
            }
            legacyConfig = { ...legacyConfig, ...authClientConfig };
        }
        // Data category
        if (clientConfig.data) {
            const dataConfig = {
                aws_appsync_authenticationType: clientConfig.data.default_authorization_type,
                aws_appsync_region: clientConfig.data.aws_region,
                aws_appsync_graphqlEndpoint: clientConfig.data.url,
                modelIntrospection: clientConfig.data.model_introspection,
            };
            if (clientConfig.data.api_key) {
                dataConfig.aws_appsync_apiKey = clientConfig.data.api_key;
            }
            if (clientConfig.data.authorization_types) {
                dataConfig.aws_appsync_additionalAuthenticationTypes =
                    clientConfig.data.authorization_types.join(',');
            }
            legacyConfig = { ...legacyConfig, ...dataConfig };
        }
        // Storage category
        if (clientConfig.storage) {
            const storageConfig = {
                aws_user_files_s3_bucket: clientConfig.storage.bucket_name,
                aws_user_files_s3_bucket_region: clientConfig.storage.aws_region,
            };
            legacyConfig = { ...legacyConfig, ...storageConfig };
        }
        // Analytics category
        if (clientConfig.analytics && clientConfig.analytics.amazon_pinpoint) {
            const analyticsConfig = {
                Analytics: {
                    Pinpoint: {
                        appId: clientConfig.analytics.amazon_pinpoint.app_id,
                        region: clientConfig.analytics.amazon_pinpoint.aws_region,
                    },
                },
            };
            legacyConfig = { ...legacyConfig, ...analyticsConfig };
            legacyConfig.aws_mobile_analytics_app_id =
                clientConfig.analytics.amazon_pinpoint.app_id;
            legacyConfig.aws_mobile_analytics_app_region =
                clientConfig.analytics.amazon_pinpoint.aws_region;
        }
        // Geo category
        if (clientConfig.geo) {
            const geoConfig = {
                geo: {
                    amazon_location_service: {
                        region: clientConfig.geo.aws_region,
                    },
                },
            };
            if (clientConfig.geo.maps) {
                const mapsLegacyConfig = {};
                for (const mapName in clientConfig.geo.maps.items) {
                    if (clientConfig.geo.maps.items[mapName].style) {
                        mapsLegacyConfig[mapName] = {
                            style: clientConfig.geo.maps.items[mapName].style,
                        };
                    }
                }
                geoConfig.geo.amazon_location_service.maps = {
                    default: clientConfig.geo.maps.default,
                    items: mapsLegacyConfig,
                };
            }
            if (clientConfig.geo.search_indices) {
                geoConfig.geo.amazon_location_service.search_indices =
                    clientConfig.geo.search_indices;
            }
            if (clientConfig.geo.geofence_collections) {
                geoConfig.geo.amazon_location_service.geofenceCollections =
                    clientConfig.geo.geofence_collections;
            }
            legacyConfig = { ...legacyConfig, ...geoConfig };
        }
        // Notifications
        if (clientConfig.notifications) {
            const pinPointConfig = {
                AWSPinpoint: {
                    appId: clientConfig.notifications.amazon_pinpoint_app_id,
                    region: clientConfig.notifications.aws_region,
                },
            };
            const notificationConfig = {};
            notificationConfig.Notifications = {};
            for (const notificationChannel of clientConfig.notifications.channels) {
                switch (notificationChannel) {
                    case 'IN_APP_MESSAGING':
                        notificationConfig.Notifications.InAppMessaging = pinPointConfig;
                        break;
                    case 'FCM':
                        notificationConfig.Notifications.Push = pinPointConfig;
                        break;
                    case 'APNS':
                        // It's fine to overwrite APNS over FCM since they are the exact same config.
                        notificationConfig.Notifications.Push = pinPointConfig;
                        break;
                    case 'EMAIL':
                        notificationConfig.Notifications.EMAIL = pinPointConfig;
                        break;
                    case 'SMS':
                        notificationConfig.Notifications.SMS = pinPointConfig;
                        break;
                }
            }
            legacyConfig = { ...legacyConfig, ...notificationConfig };
        }
        // Custom
        if (clientConfig.custom) {
            legacyConfig.custom = clientConfig.custom;
        }
        return legacyConfig;
    };
    // eslint-disable-next-line @typescript-eslint/naming-convention
    isClientConfigV1_4 = (clientConfig) => {
        return clientConfig.version === '1.4';
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50X2NvbmZpZ190b19sZWdhY3lfY29udmVydGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NsaWVudC1jb25maWctd3JpdGVyL2NsaWVudF9jb25maWdfdG9fbGVnYWN5X2NvbnZlcnRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFnQjFEOztHQUVHO0FBQ0gsTUFBTSxPQUFPLDJCQUEyQjtJQUN0Qzs7T0FFRztJQUNILHFCQUFxQixHQUFHLENBQUMsWUFBMEIsRUFBc0IsRUFBRTtRQUN6RSw0RUFBNEU7UUFDNUUsSUFBSSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDO1lBQzNDLE1BQU0sSUFBSSxZQUFZLENBQUMscUNBQXFDLEVBQUU7Z0JBQzVELE9BQU8sRUFBRSxnREFBZ0Q7YUFDMUQsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELElBQUksWUFBWSxHQUF1QixFQUFFLENBQUM7UUFFMUMsbUZBQW1GO1FBQ25GLCtEQUErRDtRQUMvRCxJQUFJLFlBQVksQ0FBQyxJQUFJLElBQUksWUFBWSxDQUFDLElBQUksSUFBSSxZQUFZLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDbkUsWUFBWSxDQUFDLGtCQUFrQjtnQkFDN0IsWUFBWSxDQUFDLElBQUksRUFBRSxVQUFVO29CQUM3QixZQUFZLENBQUMsSUFBSSxFQUFFLFVBQVU7b0JBQzdCLFlBQVksQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDO1FBQ3JDLENBQUM7UUFFRCxPQUFPO1FBQ1AsSUFBSSxZQUFZLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDdEIsTUFBTSxnQkFBZ0IsR0FBcUI7Z0JBQ3pDLGlCQUFpQixFQUFFLFlBQVksQ0FBQyxJQUFJLENBQUMsWUFBWTtnQkFDakQsa0JBQWtCLEVBQUUsWUFBWSxDQUFDLElBQUksQ0FBQyxVQUFVO2dCQUNoRCw0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RTtJQUNoRSxrQkFBa0IsR0FBRyxDQUNuQixZQUEwQixFQUNzQyxFQUFFO1FBQ2xFLE9BQU8sWUFBWSxDQUFDLE9BQU8sS0FBSyxLQUFLLENBQUM7SUFDeEMsQ0FBQyxDQUFDO0NBQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBbXBsaWZ5RmF1bHQgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5pbXBvcnQge1xuICBDbGllbnRDb25maWcsXG4gIENsaWVudENvbmZpZ0xlZ2FjeSxcbiAgY2xpZW50Q29uZmlnVHlwZXNWMV80LFxufSBmcm9tICcuLi9jbGllbnQtY29uZmlnLXR5cGVzL2NsaWVudF9jb25maWcuanMnO1xuXG5pbXBvcnQge1xuICBBbmFseXRpY3NDbGllbnRDb25maWcsXG4gIEF1dGhDbGllbnRDb25maWcsXG4gIEdlb0NsaWVudENvbmZpZyxcbiAgR3JhcGhxbENsaWVudENvbmZpZyxcbiAgTm90aWZpY2F0aW9uc0NsaWVudENvbmZpZyxcbiAgU3RvcmFnZUNsaWVudENvbmZpZyxcbn0gZnJvbSAnLi4vaW5kZXguanMnO1xuXG4vKipcbiAqIENvbnZlcnRzIHVuaWZpZWQgY2xpZW50IGNvbmZpZyB0byB0aGUgbGVnYWN5IGZvcm1hdC5cbiAqL1xuZXhwb3J0IGNsYXNzIENsaWVudENvbmZpZ0xlZ2FjeUNvbnZlcnRlciB7XG4gIC8qKlxuICAgKiBDb252ZXJ0cyBjbGllbnQgY29uZmlnIHRvIGEgc2hhcGUgY29uc3VtYWJsZSBieSBsZWdhY3kgbGlicmFyaWVzLlxuICAgKi9cbiAgY29udmVydFRvTGVnYWN5Q29uZmlnID0gKGNsaWVudENvbmZpZzogQ2xpZW50Q29uZmlnKTogQ2xpZW50Q29uZmlnTGVnYWN5ID0+IHtcbiAgICAvLyBXZSBjYW4gb25seSBjb252ZXJ0IGZyb20gVjEuNCBvZiBDbGllbnRDb25maWcuIEZvciBldmVyeXRoaW5nIGVsc2UsIHRocm93XG4gICAgaWYgKCF0aGlzLmlzQ2xpZW50Q29uZmlnVjFfNChjbGllbnRDb25maWcpKSB7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeUZhdWx0KCdVbnN1cHBvcnRlZENsaWVudENvbmZpZ1ZlcnNpb25GYXVsdCcsIHtcbiAgICAgICAgbWVzc2FnZTogJ09ubHkgdmVyc2lvbiAxLjQgb2YgQ2xpZW50Q29uZmlnIGlzIHN1cHBvcnRlZC4nLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgbGV0IGxlZ2FjeUNvbmZpZzogQ2xpZW50Q29uZmlnTGVnYWN5ID0ge307XG5cbiAgICAvLyBHZW4yIGJhY2tlbmQgY29uc3RydWN0cyB1c2UgdGhlIFN0YWNrJ3MgcmVnaW9uIGFuZCBpcyBpZGVudGljYWwuIFdlIHVzZSB0aGVzZSB0b1xuICAgIC8vIHBvcHVsYXRlIHRoZSByb290IGxldmVsIGF3c19wcm9qZWN0X3JlZ2lvbiBpbiBsZWdhY3kgY29uZmlnLlxuICAgIGlmIChjbGllbnRDb25maWcuYXV0aCB8fCBjbGllbnRDb25maWcuZGF0YSB8fCBjbGllbnRDb25maWcuc3RvcmFnZSkge1xuICAgICAgbGVnYWN5Q29uZmlnLmF3c19wcm9qZWN0X3JlZ2lvbiA9XG4gICAgICAgIGNsaWVudENvbmZpZy5hdXRoPy5hd3NfcmVnaW9uID8/XG4gICAgICAgIGNsaWVudENvbmZpZy5kYXRhPy5hd3NfcmVnaW9uID8/XG4gICAgICAgIGNsaWVudENvbmZpZy5zdG9yYWdlPy5hd3NfcmVnaW9uO1xuICAgIH1cblxuICAgIC8vIEF1dGhcbiAgICBpZiAoY2xpZW50Q29uZmlnLmF1dGgpIHtcbiAgICAgIGNvbnN0IGF1dGhDbGllbnRDb25maWc6IEF1dGhDbGllbnRDb25maWcgPSB7XG4gICAgICAgIGF3c191c2VyX3Bvb2xzX2lkOiBjbGllbnRDb25maWcuYXV0aC51c2VyX3Bvb2xfaWQsXG4gICAgICAgIGF3c19jb2duaXRvX3JlZ2lvbjogY2xpZW50Q29uZmlnLmF1dGguYXdzX3JlZ2lvbixcbiAgICAgICAgYXdzX3VzZXJfcG9vbHNfd2ViX2NsaWVudF9pZDogY2xpZW50Q29uZmlnLmF1dGgudXNlcl9wb29sX2NsaWVudF9pZCxcbiAgICAgICAgYXdzX2NvZ25pdG9faWRlbnRpdHlfcG9vbF9pZDogY2xpZW50Q29uZmlnLmF1dGguaWRlbnRpdHlfcG9vbF9pZCxcbiAgICAgIH07XG5cbiAgICAgIGlmIChjbGllbnRDb25maWcuYXV0aC51bmF1dGhlbnRpY2F0ZWRfaWRlbnRpdGllc19lbmFibGVkKSB7XG4gICAgICAgIGF1dGhDbGllbnRDb25maWcuYWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzID0gY2xpZW50Q29uZmlnLmF1dGhcbiAgICAgICAgICAudW5hdXRoZW50aWNhdGVkX2lkZW50aXRpZXNfZW5hYmxlZFxuICAgICAgICAgID8gJ3RydWUnXG4gICAgICAgICAgOiAnZmFsc2UnO1xuICAgICAgfVxuXG4gICAgICBpZiAoY2xpZW50Q29uZmlnLmF1dGgubWZhX21ldGhvZHMpIHtcbiAgICAgICAgYXV0aENsaWVudENvbmZpZy5hd3NfY29nbml0b19tZmFfdHlwZXMgPSBjbGllbnRDb25maWcuYXV0aC5tZmFfbWV0aG9kcztcbiAgICAgIH1cblxuICAgICAgaWYgKGNsaWVudENvbmZpZy5hdXRoLm1mYV9jb25maWd1cmF0aW9uKSB7XG4gICAgICAgIHN3aXRjaCAoY2xpZW50Q29uZmlnLmF1dGgubWZhX2NvbmZpZ3VyYXRpb24pIHtcbiAgICAgICAgICBjYXNlICdOT05FJzoge1xuICAgICAgICAgICAgYXV0aENsaWVudENvbmZpZy5hd3NfY29nbml0b19tZmFfY29uZmlndXJhdGlvbiA9ICdPRkYnO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICAgIGNhc2UgJ09QVElPTkFMJzoge1xuICAgICAgICAgICAgYXV0aENsaWVudENvbmZpZy5hd3NfY29nbml0b19tZmFfY29uZmlndXJhdGlvbiA9ICdPUFRJT05BTCc7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgICAgY2FzZSAnUkVRVUlSRUQnOiB7XG4gICAgICAgICAgICBhdXRoQ2xpZW50Q29uZmlnLmF3c19jb2duaXRvX21mYV9jb25maWd1cmF0aW9uID0gJ09OJztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKGNsaWVudENvbmZpZy5hdXRoLnN0YW5kYXJkX3JlcXVpcmVkX2F0dHJpYnV0ZXMpIHtcbiAgICAgICAgYXV0aENsaWVudENvbmZpZy5hd3NfY29nbml0b19zaWdudXBfYXR0cmlidXRlcyA9XG4gICAgICAgICAgY2xpZW50Q29uZmlnLmF1dGguc3RhbmRhcmRfcmVxdWlyZWRfYXR0cmlidXRlcz8ubWFwKChhdHRyaWJ1dGUpID0+XG4gICAgICAgICAgICBhdHRyaWJ1dGUudG9VcHBlckNhc2UoKSxcbiAgICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBpZiAoY2xpZW50Q29uZmlnLmF1dGgudXNlcm5hbWVfYXR0cmlidXRlcykge1xuICAgICAgICBhdXRoQ2xpZW50Q29uZmlnLmF3c19jb2duaXRvX3VzZXJuYW1lX2F0dHJpYnV0ZXMgPVxuICAgICAgICAgIGNsaWVudENvbmZpZy5hdXRoLnVzZXJuYW1lX2F0dHJpYnV0ZXM/Lm1hcCgoYXR0cmlidXRlKSA9PlxuICAgICAgICAgICAgYXR0cmlidXRlLnRvVXBwZXJDYXNlKCksXG4gICAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgYXV0aENsaWVudENvbmZpZy5hd3NfY29nbml0b192ZXJpZmljYXRpb25fbWVjaGFuaXNtcyA9XG4gICAgICAgIGNsaWVudENvbmZpZy5hdXRoLnVzZXJfdmVyaWZpY2F0aW9uX3R5cGVzPy5tYXAoKGF0dHJpYnV0ZSkgPT5cbiAgICAgICAgICBhdHRyaWJ1dGUudG9VcHBlckNhc2UoKSxcbiAgICAgICAgKTtcblxuICAgICAgaWYgKGNsaWVudENvbmZpZy5hdXRoLnBhc3N3b3JkX3BvbGljeSkge1xuICAgICAgICBhdXRoQ2xpZW50Q29uZmlnLmF3c19jb2duaXRvX3Bhc3N3b3JkX3Byb3RlY3Rpb25fc2V0dGluZ3MgPSB7fTtcbiAgICAgICAgaWYgKGNsaWVudENvbmZpZy5hdXRoLnBhc3N3b3JkX3BvbGljeS5taW5fbGVuZ3RoKSB7XG4gICAgICAgICAgYXV0aENsaWVudENvbmZpZy5hd3NfY29nbml0b19wYXNzd29yZF9wcm90ZWN0aW9uX3NldHRpbmdzID0ge1xuICAgICAgICAgICAgcGFzc3dvcmRQb2xpY3lNaW5MZW5ndGg6XG4gICAgICAgICAgICAgIGNsaWVudENvbmZpZy5hdXRoLnBhc3N3b3JkX3BvbGljeS5taW5fbGVuZ3RoLFxuICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcmVxdWlyZW1lbnRzID0gW107XG4gICAgICAgIGlmIChjbGllbnRDb25maWcuYXV0aC5wYXNzd29yZF9wb2xpY3kucmVxdWlyZV9udW1iZXJzKSB7XG4gICAgICAgICAgcmVxdWlyZW1lbnRzLnB1c2goJ1JFUVVJUkVTX05VTUJFUlMnKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoY2xpZW50Q29uZmlnLmF1dGgucGFzc3dvcmRfcG9saWN5LnJlcXVpcmVfbG93ZXJjYXNlKSB7XG4gICAgICAgICAgcmVxdWlyZW1lbnRzLnB1c2goJ1JFUVVJUkVTX0xPV0VSQ0FTRScpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjbGllbnRDb25maWcuYXV0aC5wYXNzd29yZF9wb2xpY3kucmVxdWlyZV91cHBlcmNhc2UpIHtcbiAgICAgICAgICByZXF1aXJlbWVudHMucHVzaCgnUkVRVUlSRVNfVVBQRVJDQVNFJyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGNsaWVudENvbmZpZy5hdXRoLnBhc3N3b3JkX3BvbGljeS5yZXF1aXJlX3N5bWJvbHMpIHtcbiAgICAgICAgICByZXF1aXJlbWVudHMucHVzaCgnUkVRVUlSRVNfU1lNQk9MUycpO1xuICAgICAgICB9XG4gICAgICAgIGF1dGhDbGllbnRDb25maWcuYXdzX2NvZ25pdG9fcGFzc3dvcmRfcHJvdGVjdGlvbl9zZXR0aW5ncy5wYXNzd29yZFBvbGljeUNoYXJhY3RlcnMgPVxuICAgICAgICAgIHJlcXVpcmVtZW50cztcbiAgICAgIH1cblxuICAgICAgaWYgKGNsaWVudENvbmZpZy5hdXRoLm9hdXRoKSB7XG4gICAgICAgIGF1dGhDbGllbnRDb25maWcub2F1dGggPSB7fTtcbiAgICAgICAgYXV0aENsaWVudENvbmZpZy5hd3NfY29nbml0b19zb2NpYWxfcHJvdmlkZXJzID1cbiAgICAgICAgICBjbGllbnRDb25maWcuYXV0aC5vYXV0aC5pZGVudGl0eV9wcm92aWRlcnMubWFwKChwcm92aWRlcikgPT4ge1xuICAgICAgICAgICAgaWYgKHByb3ZpZGVyID09PSAnU0lHTl9JTl9XSVRIX0FQUExFJykge1xuICAgICAgICAgICAgICByZXR1cm4gJ0FQUExFJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChwcm92aWRlciA9PT0gJ0xPR0lOX1dJVEhfQU1BWk9OJykge1xuICAgICAgICAgICAgICByZXR1cm4gJ0FNQVpPTic7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcHJvdmlkZXI7XG4gICAgICAgICAgfSk7XG4gICAgICAgIGF1dGhDbGllbnRDb25maWcub2F1dGguZG9tYWluID0gY2xpZW50Q29uZmlnLmF1dGgub2F1dGguZG9tYWluO1xuICAgICAgICBhdXRoQ2xpZW50Q29uZmlnLm9hdXRoLnNjb3BlID0gY2xpZW50Q29uZmlnLmF1dGgub2F1dGguc2NvcGVzO1xuICAgICAgICBhdXRoQ2xpZW50Q29uZmlnLm9hdXRoLnJlZGlyZWN0U2lnbkluID1cbiAgICAgICAgICBjbGllbnRDb25maWcuYXV0aC5vYXV0aC5yZWRpcmVjdF9zaWduX2luX3VyaS5qb2luKCcsJyk7XG4gICAgICAgIGF1dGhDbGllbnRDb25maWcub2F1dGgucmVkaXJlY3RTaWduT3V0ID1cbiAgICAgICAgICBjbGllbnRDb25maWcuYXV0aC5vYXV0aC5yZWRpcmVjdF9zaWduX291dF91cmkuam9pbignLCcpO1xuICAgICAgICBhdXRoQ2xpZW50Q29uZmlnLm9hdXRoLnJlc3BvbnNlVHlwZSA9XG4gICAgICAgICAgY2xpZW50Q29uZmlnLmF1dGgub2F1dGgucmVzcG9uc2VfdHlwZTtcbiAgICAgIH1cblxuICAgICAgbGVnYWN5Q29uZmlnID0geyAuLi5sZWdhY3lDb25maWcsIC4uLmF1dGhDbGllbnRDb25maWcgfTtcbiAgICB9XG5cbiAgICAvLyBEYXRhIGNhdGVnb3J5XG4gICAgaWYgKGNsaWVudENvbmZpZy5kYXRhKSB7XG4gICAgICBjb25zdCBkYXRhQ29uZmlnOiBHcmFwaHFsQ2xpZW50Q29uZmlnID0ge1xuICAgICAgICBhd3NfYXBwc3luY19hdXRoZW50aWNhdGlvblR5cGU6XG4gICAgICAgICAgY2xpZW50Q29uZmlnLmRhdGEuZGVmYXVsdF9hdXRob3JpemF0aW9uX3R5cGUsXG4gICAgICAgIGF3c19hcHBzeW5jX3JlZ2lvbjogY2xpZW50Q29uZmlnLmRhdGEuYXdzX3JlZ2lvbixcbiAgICAgICAgYXdzX2FwcHN5bmNfZ3JhcGhxbEVuZHBvaW50OiBjbGllbnRDb25maWcuZGF0YS51cmwsXG4gICAgICAgIG1vZGVsSW50cm9zcGVjdGlvbjogY2xpZW50Q29uZmlnLmRhdGEubW9kZWxfaW50cm9zcGVjdGlvbixcbiAgICAgIH07XG5cbiAgICAgIGlmIChjbGllbnRDb25maWcuZGF0YS5hcGlfa2V5KSB7XG4gICAgICAgIGRhdGFDb25maWcuYXdzX2FwcHN5bmNfYXBpS2V5ID0gY2xpZW50Q29uZmlnLmRhdGEuYXBpX2tleTtcbiAgICAgIH1cblxuICAgICAgaWYgKGNsaWVudENvbmZpZy5kYXRhLmF1dGhvcml6YXRpb25fdHlwZXMpIHtcbiAgICAgICAgZGF0YUNvbmZpZy5hd3NfYXBwc3luY19hZGRpdGlvbmFsQXV0aGVudGljYXRpb25UeXBlcyA9XG4gICAgICAgICAgY2xpZW50Q29uZmlnLmRhdGEuYXV0aG9yaXphdGlvbl90eXBlcy5qb2luKCcsJyk7XG4gICAgICB9XG5cbiAgICAgIGxlZ2FjeUNvbmZpZyA9IHsgLi4ubGVnYWN5Q29uZmlnLCAuLi5kYXRhQ29uZmlnIH07XG4gICAgfVxuXG4gICAgLy8gU3RvcmFnZSBjYXRlZ29yeVxuICAgIGlmIChjbGllbnRDb25maWcuc3RvcmFnZSkge1xuICAgICAgY29uc3Qgc3RvcmFnZUNvbmZpZzogU3RvcmFnZUNsaWVudENvbmZpZyA9IHtcbiAgICAgICAgYXdzX3VzZXJfZmlsZXNfczNfYnVja2V0OiBjbGllbnRDb25maWcuc3RvcmFnZS5idWNrZXRfbmFtZSxcbiAgICAgICAgYXdzX3VzZXJfZmlsZXNfczNfYnVja2V0X3JlZ2lvbjogY2xpZW50Q29uZmlnLnN0b3JhZ2UuYXdzX3JlZ2lvbixcbiAgICAgIH07XG4gICAgICBsZWdhY3lDb25maWcgPSB7IC4uLmxlZ2FjeUNvbmZpZywgLi4uc3RvcmFnZUNvbmZpZyB9O1xuICAgIH1cblxuICAgIC8vIEFuYWx5dGljcyBjYXRlZ29yeVxuICAgIGlmIChjbGllbnRDb25maWcuYW5hbHl0aWNzICYmIGNsaWVudENvbmZpZy5hbmFseXRpY3MuYW1hem9uX3BpbnBvaW50KSB7XG4gICAgICBjb25zdCBhbmFseXRpY3NDb25maWc6IEFuYWx5dGljc0NsaWVudENvbmZpZyA9IHtcbiAgICAgICAgQW5hbHl0aWNzOiB7XG4gICAgICAgICAgUGlucG9pbnQ6IHtcbiAgICAgICAgICAgIGFwcElkOiBjbGllbnRDb25maWcuYW5hbHl0aWNzLmFtYXpvbl9waW5wb2ludC5hcHBfaWQsXG4gICAgICAgICAgICByZWdpb246IGNsaWVudENvbmZpZy5hbmFseXRpY3MuYW1hem9uX3BpbnBvaW50LmF3c19yZWdpb24sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH07XG4gICAgICBsZWdhY3lDb25maWcgPSB7IC4uLmxlZ2FjeUNvbmZpZywgLi4uYW5hbHl0aWNzQ29uZmlnIH07XG4gICAgICBsZWdhY3lDb25maWcuYXdzX21vYmlsZV9hbmFseXRpY3NfYXBwX2lkID1cbiAgICAgICAgY2xpZW50Q29uZmlnLmFuYWx5dGljcy5hbWF6b25fcGlucG9pbnQuYXBwX2lkO1xuICAgICAgbGVnYWN5Q29uZmlnLmF3c19tb2JpbGVfYW5hbHl0aWNzX2FwcF9yZWdpb24gPVxuICAgICAgICBjbGllbnRDb25maWcuYW5hbHl0aWNzLmFtYXpvbl9waW5wb2ludC5hd3NfcmVnaW9uO1xuICAgIH1cblxuICAgIC8vIEdlbyBjYXRlZ29yeVxuICAgIGlmIChjbGllbnRDb25maWcuZ2VvKSB7XG4gICAgICBjb25zdCBnZW9Db25maWc6IEdlb0NsaWVudENvbmZpZyA9IHtcbiAgICAgICAgZ2VvOiB7XG4gICAgICAgICAgYW1hem9uX2xvY2F0aW9uX3NlcnZpY2U6IHtcbiAgICAgICAgICAgIHJlZ2lvbjogY2xpZW50Q29uZmlnLmdlby5hd3NfcmVnaW9uLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9O1xuXG4gICAgICBpZiAoY2xpZW50Q29uZmlnLmdlby5tYXBzKSB7XG4gICAgICAgIGNvbnN0IG1hcHNMZWdhY3lDb25maWc6IFJlY29yZDxzdHJpbmcsIHsgc3R5bGU6IHN0cmluZyB9PiA9IHt9O1xuICAgICAgICBmb3IgKGNvbnN0IG1hcE5hbWUgaW4gY2xpZW50Q29uZmlnLmdlby5tYXBzLml0ZW1zKSB7XG4gICAgICAgICAgaWYgKGNsaWVudENvbmZpZy5nZW8ubWFwcy5pdGVtc1ttYXBOYW1lXS5zdHlsZSkge1xuICAgICAgICAgICAgbWFwc0xlZ2FjeUNvbmZpZ1ttYXBOYW1lXSA9IHtcbiAgICAgICAgICAgICAgc3R5bGU6IGNsaWVudENvbmZpZy5nZW8ubWFwcy5pdGVtc1ttYXBOYW1lXS5zdHlsZSEsXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBnZW9Db25maWcuZ2VvIS5hbWF6b25fbG9jYXRpb25fc2VydmljZS5tYXBzID0ge1xuICAgICAgICAgIGRlZmF1bHQ6IGNsaWVudENvbmZpZy5nZW8ubWFwcy5kZWZhdWx0LFxuICAgICAgICAgIGl0ZW1zOiBtYXBzTGVnYWN5Q29uZmlnLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICBpZiAoY2xpZW50Q29uZmlnLmdlby5zZWFyY2hfaW5kaWNlcykge1xuICAgICAgICBnZW9Db25maWcuZ2VvIS5hbWF6b25fbG9jYXRpb25fc2VydmljZS5zZWFyY2hfaW5kaWNlcyA9XG4gICAgICAgICAgY2xpZW50Q29uZmlnLmdlby5zZWFyY2hfaW5kaWNlcztcbiAgICAgIH1cblxuICAgICAgaWYgKGNsaWVudENvbmZpZy5nZW8uZ2VvZmVuY2VfY29sbGVjdGlvbnMpIHtcbiAgICAgICAgZ2VvQ29uZmlnLmdlbyEuYW1hem9uX2xvY2F0aW9uX3NlcnZpY2UuZ2VvZmVuY2VDb2xsZWN0aW9ucyA9XG4gICAgICAgICAgY2xpZW50Q29uZmlnLmdlby5nZW9mZW5jZV9jb2xsZWN0aW9ucztcbiAgICAgIH1cblxuICAgICAgbGVnYWN5Q29uZmlnID0geyAuLi5sZWdhY3lDb25maWcsIC4uLmdlb0NvbmZpZyB9O1xuICAgIH1cblxuICAgIC8vIE5vdGlmaWNhdGlvbnNcbiAgICBpZiAoY2xpZW50Q29uZmlnLm5vdGlmaWNhdGlvbnMpIHtcbiAgICAgIGNvbnN0IHBpblBvaW50Q29uZmlnID0ge1xuICAgICAgICBBV1NQaW5wb2ludDoge1xuICAgICAgICAgIGFwcElkOiBjbGllbnRDb25maWcubm90aWZpY2F0aW9ucy5hbWF6b25fcGlucG9pbnRfYXBwX2lkLFxuICAgICAgICAgIHJlZ2lvbjogY2xpZW50Q29uZmlnLm5vdGlmaWNhdGlvbnMuYXdzX3JlZ2lvbixcbiAgICAgICAgfSxcbiAgICAgIH07XG4gICAgICBjb25zdCBub3RpZmljYXRpb25Db25maWc6IE5vdGlmaWNhdGlvbnNDbGllbnRDb25maWcgPSB7fTtcbiAgICAgIG5vdGlmaWNhdGlvbkNvbmZpZy5Ob3RpZmljYXRpb25zID0ge307XG4gICAgICBmb3IgKGNvbnN0IG5vdGlmaWNhdGlvbkNoYW5uZWwgb2YgY2xpZW50Q29uZmlnLm5vdGlmaWNhdGlvbnMuY2hhbm5lbHMpIHtcbiAgICAgICAgc3dpdGNoIChub3RpZmljYXRpb25DaGFubmVsKSB7XG4gICAgICAgICAgY2FzZSAnSU5fQVBQX01FU1NBR0lORyc6XG4gICAgICAgICAgICBub3RpZmljYXRpb25Db25maWcuTm90aWZpY2F0aW9ucy5JbkFwcE1lc3NhZ2luZyA9IHBpblBvaW50Q29uZmlnO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAnRkNNJzpcbiAgICAgICAgICAgIG5vdGlmaWNhdGlvbkNvbmZpZy5Ob3RpZmljYXRpb25zLlB1c2ggPSBwaW5Qb2ludENvbmZpZztcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ0FQTlMnOlxuICAgICAgICAgICAgLy8gSXQncyBmaW5lIHRvIG92ZXJ3cml0ZSBBUE5TIG92ZXIgRkNNIHNpbmNlIHRoZXkgYXJlIHRoZSBleGFjdCBzYW1lIGNvbmZpZy5cbiAgICAgICAgICAgIG5vdGlmaWNhdGlvbkNvbmZpZy5Ob3RpZmljYXRpb25zLlB1c2ggPSBwaW5Qb2ludENvbmZpZztcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ0VNQUlMJzpcbiAgICAgICAgICAgIG5vdGlmaWNhdGlvbkNvbmZpZy5Ob3RpZmljYXRpb25zLkVNQUlMID0gcGluUG9pbnRDb25maWc7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlICdTTVMnOlxuICAgICAgICAgICAgbm90aWZpY2F0aW9uQ29uZmlnLk5vdGlmaWNhdGlvbnMuU01TID0gcGluUG9pbnRDb25maWc7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBsZWdhY3lDb25maWcgPSB7IC4uLmxlZ2FjeUNvbmZpZywgLi4ubm90aWZpY2F0aW9uQ29uZmlnIH07XG4gICAgfVxuXG4gICAgLy8gQ3VzdG9tXG4gICAgaWYgKGNsaWVudENvbmZpZy5jdXN0b20pIHtcbiAgICAgIGxlZ2FjeUNvbmZpZy5jdXN0b20gPSBjbGllbnRDb25maWcuY3VzdG9tO1xuICAgIH1cblxuICAgIHJldHVybiBsZWdhY3lDb25maWc7XG4gIH07XG5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uYW1pbmctY29udmVudGlvblxuICBpc0NsaWVudENvbmZpZ1YxXzQgPSAoXG4gICAgY2xpZW50Q29uZmlnOiBDbGllbnRDb25maWcsXG4gICk6IGNsaWVudENvbmZpZyBpcyBjbGllbnRDb25maWdUeXBlc1YxXzQuQVdTQW1wbGlmeUJhY2tlbmRPdXRwdXRzID0+IHtcbiAgICByZXR1cm4gY2xpZW50Q29uZmlnLnZlcnNpb24gPT09ICcxLjQnO1xuICB9O1xufVxuIl19