import { NamingConverter } from '@aws-amplify/platform-core';
import { GetObjectCommand, NoSuchKey, S3Client, S3ServiceException, } from '@aws-sdk/client-s3';
const dataKeyNameContent = '_MODEL_INTROSPECTION_SCHEMA_KEY';
const dataBucketNameContent = '_MODEL_INTROSPECTION_SCHEMA_BUCKET_NAME';
const dataEndpointNameContent = '_GRAPHQL_ENDPOINT';
/* eslint-enable @typescript-eslint/naming-convention */
const getResourceConfig = (env, modelIntrospectionSchema) => {
    return {
        API: {
            GraphQL: {
                endpoint: env.dataEndpoint,
                region: env.AWS_REGION,
                defaultAuthMode: 'iam',
                modelIntrospection: modelIntrospectionSchema,
            },
        },
    };
};
const getLibraryOptions = (env) => {
    return {
        Auth: {
            credentialsProvider: {
                getCredentialsAndIdentityId: async () => ({
                    credentials: {
                        accessKeyId: env.AWS_ACCESS_KEY_ID,
                        secretAccessKey: env.AWS_SECRET_ACCESS_KEY,
                        sessionToken: env.AWS_SESSION_TOKEN,
                    },
                }),
                clearCredentialsAndIdentityId: () => {
                    /* noop */
                },
            },
        },
    };
};
const extendEnv = (env, dataName) => {
    const bucketName = `${dataName}${dataBucketNameContent}`;
    const keyName = `${dataName}${dataKeyNameContent}`;
    const endpointName = `${dataName}${dataEndpointNameContent}`;
    if (!(bucketName in env &&
        keyName in env &&
        endpointName in env &&
        typeof env[bucketName] === 'string' &&
        typeof env[keyName] === 'string' &&
        typeof env[endpointName] === 'string')) {
        throw new Error(`The data environment variables are malformed. env=${JSON.stringify(env)}`);
    }
    const dataBucket = env[bucketName];
    const dataKey = env[keyName];
    const dataEndpoint = env[endpointName];
    return {
        ...env,
        dataBucket,
        dataKey,
        dataEndpoint,
    };
};
/**
 * Generate the `resourceConfig` and `libraryOptions` need to configure
 * Amplify for the data client in a lambda.
 *
 * Your function needs to be granted resource access on your schema for this to work
 * `a.schema(...).authorization((allow) => [a.resource(myFunction)])`
 * @param env - The environment variables for the data client
 * @returns An object containing the `resourceConfig` and `libraryOptions`
 */
export const getAmplifyDataClientConfig = async (env, s3Client) => {
    if (!s3Client) {
        s3Client = new S3Client();
    }
    const dataName = new NamingConverter().toScreamingSnakeCase(env.AMPLIFY_DATA_DEFAULT_NAME);
    const extendedEnv = extendEnv(env, dataName);
    let modelIntrospectionSchema;
    try {
        const response = await s3Client.send(new GetObjectCommand({
            Bucket: extendedEnv.dataBucket,
            Key: extendedEnv.dataKey,
        }));
        const modelIntrospectionSchemaJson = await response.Body?.transformToString();
        modelIntrospectionSchema = JSON.parse(modelIntrospectionSchemaJson ?? '{}');
    }
    catch (caught) {
        if (caught instanceof NoSuchKey) {
            throw new Error('Error retrieving the schema from S3. Please confirm that your project has a `defineData` included in the `defineBackend` definition.', { cause: caught });
        }
        else if (caught instanceof S3ServiceException) {
            throw new Error(`Error retrieving the schema from S3. You may need to grant this function authorization on the schema. ${caught.name}: ${caught.message}.`, { cause: caught });
        }
        else {
            throw caught;
        }
    }
    const libraryOptions = getLibraryOptions(env);
    const resourceConfig = getResourceConfig(extendedEnv, modelIntrospectionSchema);
    return { resourceConfig, libraryOptions };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0X2FtcGxpZnlfY2xpZW50c19jb25maWd1cmF0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3J1bnRpbWUvZ2V0X2FtcGxpZnlfY2xpZW50c19jb25maWd1cmF0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUM3RCxPQUFPLEVBQ0wsZ0JBQWdCLEVBQ2hCLFNBQVMsRUFDVCxRQUFRLEVBQ1Isa0JBQWtCLEdBQ25CLE1BQU0sb0JBQW9CLENBQUM7QUFFNUIsTUFBTSxrQkFBa0IsR0FBRyxpQ0FBaUMsQ0FBQztBQUM3RCxNQUFNLHFCQUFxQixHQUFHLHlDQUF5QyxDQUFDO0FBQ3hFLE1BQU0sdUJBQXVCLEdBQUcsbUJBQW1CLENBQUM7QUFrQ3BELHdEQUF3RDtBQUV4RCxNQUFNLGlCQUFpQixHQUFHLENBQ3hCLEdBQTZCLEVBQzdCLHdCQUFnQyxFQUNoQixFQUFFO0lBQ2xCLE9BQU87UUFDTCxHQUFHLEVBQUU7WUFDSCxPQUFPLEVBQUU7Z0JBQ1AsUUFBUSxFQUFFLEdBQUcsQ0FBQyxZQUFZO2dCQUMxQixNQUFNLEVBQUUsR0FBRyxDQUFDLFVBQVU7Z0JBQ3RCLGVBQWUsRUFBRSxLQUFjO2dCQUMvQixrQkFBa0IsRUFBRSx3QkFBd0I7YUFDN0M7U0FDRjtLQUNGLENBQUM7QUFDSixDQUFDLENBQUM7QUFrQkYsTUFBTSxpQkFBaUIsR0FBRyxDQUFDLEdBQWtCLEVBQWtCLEVBQUU7SUFDL0QsT0FBTztRQUNMLElBQUksRUFBRTtZQUNKLG1CQUFtQixFQUFFO2dCQUNuQiwyQkFBMkIsRUFBRSxLQUFLLElBQUksRUFBRSxDQUFDLENBQUM7b0JBQ3hDLFdBQVcsRUFBRTt3QkFDWCxXQUFXLEVBQUUsR0FBRyxDQUFDLGlCQUFpQjt3QkFDbEMsZUFBZSxFQUFFLEdBQUcsQ0FBQyxxQkFBcUI7d0JBQzFDLFlBQVksRUFBRSxHQUFHLENBQUMsaUJB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QU0sQ0FBQztRQUNmLENBQUM7SUFDSCxDQUFDO0lBRUQsTUFBTSxjQUFjLEdBQUcsaUJBQWlCLENBQUMsR0FBRyxDQUFDLENBQUM7SUFFOUMsTUFBTSxjQUFjLEdBQUcsaUJBQWlCLENBQ3RDLFdBQVcsRUFDWCx3QkFBd0IsQ0FDekIsQ0FBQztJQUVGLE9BQU8sRUFBRSxjQUFjLEVBQUUsY0FBYyxFQUFFLENBQUM7QUFDNUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTmFtaW5nQ29udmVydGVyIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsYXRmb3JtLWNvcmUnO1xuaW1wb3J0IHtcbiAgR2V0T2JqZWN0Q29tbWFuZCxcbiAgTm9TdWNoS2V5LFxuICBTM0NsaWVudCxcbiAgUzNTZXJ2aWNlRXhjZXB0aW9uLFxufSBmcm9tICdAYXdzLXNkay9jbGllbnQtczMnO1xuXG5jb25zdCBkYXRhS2V5TmFtZUNvbnRlbnQgPSAnX01PREVMX0lOVFJPU1BFQ1RJT05fU0NIRU1BX0tFWSc7XG5jb25zdCBkYXRhQnVja2V0TmFtZUNvbnRlbnQgPSAnX01PREVMX0lOVFJPU1BFQ1RJT05fU0NIRU1BX0JVQ0tFVF9OQU1FJztcbmNvbnN0IGRhdGFFbmRwb2ludE5hbWVDb250ZW50ID0gJ19HUkFQSFFMX0VORFBPSU5UJztcblxuZXhwb3J0IHR5cGUgRGF0YUNsaWVudEVudiA9IHtcbiAgLyogZXNsaW50LWRpc2FibGUgQHR5cGVzY3JpcHQtZXNsaW50L25hbWluZy1jb252ZW50aW9uICovXG4gIEFXU19BQ0NFU1NfS0VZX0lEOiBzdHJpbmc7XG4gIEFXU19TRUNSRVRfQUNDRVNTX0tFWTogc3RyaW5nO1xuICBBV1NfU0VTU0lPTl9UT0tFTjogc3RyaW5nO1xuICBBV1NfUkVHSU9OOiBzdHJpbmc7XG4gIEFNUExJRllfREFUQV9ERUZBVUxUX05BTUU6IHN0cmluZztcbiAgLyogZXNsaW50LWVuYWJsZSBAdHlwZXNjcmlwdC1lc2xpbnQvbmFtaW5nLWNvbnZlbnRpb24gKi9cbn0gJiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjtcblxudHlwZSBEYXRhRW52RXh0ZW5zaW9uID0ge1xuICBkYXRhQnVja2V0OiBzdHJpbmc7XG4gIGRhdGFLZXk6IHN0cmluZztcbiAgZGF0YUVuZHBvaW50OiBzdHJpbmc7XG59O1xuXG50eXBlIEV4dGVuZGVkQW1wbGlmeUNsaWVudEVudiA9IERhdGFDbGllbnRFbnYgJiBEYXRhRW52RXh0ZW5zaW9uO1xuXG4vKiBlc2xpbnQtZGlzYWJsZSBAdHlwZXNjcmlwdC1lc2xpbnQvbmFtaW5nLWNvbnZlbnRpb24gKi9cbmV4cG9ydCB0eXBlIFJlc291cmNlQ29uZmlnID0ge1xuICBBUEk6IHtcbiAgICBHcmFwaFFMOiB7XG4gICAgICBlbmRwb2ludDogc3RyaW5nO1xuICAgICAgcmVnaW9uOiBzdHJpbmc7XG4gICAgICBkZWZhdWx0QXV0aE1vZGU6ICdpYW0nO1xuICAgICAgLy8gVXNpbmcgYGFueWAgdG8gYXZvaWQgcmVwcm9kdWNpbmcgMTAwKyBsaW5lcyBvZiB0eXBpbmcgdG8gbWF0Y2ggdGhlIGV4cGVjdGVkIHNoYXBlIGRlZmluZWQgaW4gYXdzLWFtcGxpZnk6XG4gICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYXdzLWFtcGxpZnkvYW1wbGlmeS1qcy9ibG9iL21haW4vcGFja2FnZXMvY29yZS9zcmMvc2luZ2xldG9uL0FQSS90eXBlcy50cyNMMTQzLUwxNTNcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gICAgICBtb2RlbEludHJvc3BlY3Rpb246IGFueTtcbiAgICB9O1xuICB9O1xufTtcbi8qIGVzbGludC1lbmFibGUgQHR5cGVzY3JpcHQtZXNsaW50L25hbWluZy1jb252ZW50aW9uICovXG5cbmNvbnN0IGdldFJlc291cmNlQ29uZmlnID0gKFxuICBlbnY6IEV4dGVuZGVkQW1wbGlmeUNsaWVudEVudixcbiAgbW9kZWxJbnRyb3NwZWN0aW9uU2NoZW1hOiBvYmplY3QsXG4pOiBSZXNvdXJjZUNvbmZpZyA9PiB7XG4gIHJldHVybiB7XG4gICAgQVBJOiB7XG4gICAgICBHcmFwaFFMOiB7XG4gICAgICAgIGVuZHBvaW50OiBlbnYuZGF0YUVuZHBvaW50LFxuICAgICAgICByZWdpb246IGVudi5BV1NfUkVHSU9OLFxuICAgICAgICBkZWZhdWx0QXV0aE1vZGU6ICdpYW0nIGFzIGNvbnN0LFxuICAgICAgICBtb2RlbEludHJvc3BlY3Rpb246IG1vZGVsSW50cm9zcGVjdGlvblNjaGVtYSxcbiAgICAgIH0sXG4gICAgfSxcbiAgfTtcbn07XG5cbmV4cG9ydCB0eXBlIExpYnJhcnlPcHRpb25zID0ge1xuICAvKiBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25hbWluZy1jb252ZW50aW9uICovXG4gIEF1dGg6IHtcbiAgICBjcmVkZW50aWFsc1Byb3ZpZGVyOiB7XG4gICAgICBnZXRDcmVkZW50aWFsc0FuZElkZW50aXR5SWQ6ICgpID0+IFByb21pc2U8e1xuICAgICAgICBjcmVkZW50aWFsczoge1xuICAgICAgICAgIGFjY2Vzc0tleUlkOiBzdHJpbmc7XG4gICAgICAgICAgc2VjcmV0QWNjZXNzS2V5OiBzdHJpbmc7XG4gICAgICAgICAgc2Vzc2lvblRva2VuOiBzdHJpbmc7XG4gICAgICAgIH07XG4gICAgICB9PjtcbiAgICAgIGNsZWFyQ3JlZGVudGlhbHNBbmRJZGVudGl0eUlkOiAoKSA9PiB2b2lkO1xuICAgIH07XG4gIH07XG59O1xuXG5jb25zdCBnZXRMaWJyYXJ5T3B0aW9ucyA9IChlbnY6IERhdGFDbGllbnRFbnYpOiBMaWJyYXJ5T3B0aW9ucyA9PiB7XG4gIHJldHVybiB7XG4gICAgQXV0aDoge1xuICAgICAgY3JlZGVudGlhbHNQcm92aWRlcjoge1xuICAgICAgICBnZXRDcmVkZW50aWFsc0FuZElkZW50aXR5SWQ6IGFzeW5jICgpID0+ICh7XG4gICAgICAgICAgY3JlZGVudGlhbHM6IHtcbiAgICAgICAgICAgIGFjY2Vzc0tleUlkOiBlbnYuQVdTX0FDQ0VTU19LRVlfSUQsXG4gICAgICAgICAgICBzZWNyZXRBY2Nlc3NLZXk6IGVudi5BV1NfU0VDUkVUX0FDQ0VTU19LRVksXG4gICAgICAgICAgICBzZXNzaW9uVG9rZW46IGVudi5BV1NfU0VTU0lPTl9UT0tFTixcbiAgICAgICAgICB9LFxuICAgICAgICB9KSxcbiAgICAgICAgY2xlYXJDcmVkZW50aWFsc0FuZElkZW50aXR5SWQ6ICgpID0+IHtcbiAgICAgICAgICAvKiBub29wICovXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0sXG4gIH07XG59O1xuXG5leHBvcnQgdHlwZSBEYXRhQ2xpZW50Q29uZmlnID0ge1xuICByZXNvdXJjZUNvbmZpZzogUmVzb3VyY2VDb25maWc7XG4gIGxpYnJhcnlPcHRpb25zOiBMaWJyYXJ5T3B0aW9ucztcbn07XG5cbmNvbnN0IGV4dGVuZEVudiA9IChcbiAgZW52OiBEYXRhQ2xpZW50RW52ICYgUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4gIGRhdGFOYW1lOiBzdHJpbmcsXG4pOiBFeHRlbmRlZEFtcGxpZnlDbGllbnRFbnYgPT4ge1xuICBjb25zdCBidWNrZXROYW1lID0gYCR7ZGF0YU5hbWV9JHtkYXRhQnVja2V0TmFtZUNvbnRlbnR9YDtcbiAgY29uc3Qga2V5TmFtZSA9IGAke2RhdGFOYW1lfSR7ZGF0YUtleU5hbWVDb250ZW50fWA7XG4gIGNvbnN0IGVuZHBvaW50TmFtZSA9IGAke2RhdGFOYW1lfSR7ZGF0YUVuZHBvaW50TmFtZUNvbnRlbnR9YDtcbiAgaWYgKFxuICAgICEoXG4gICAgICBidWNrZXROYW1lIGluIGVudiAmJlxuICAgICAga2V5TmFtZSBpbiBlbnYgJiZcbiAgICAgIGVuZHBvaW50TmFtZSBpbiBlbnYgJiZcbiAgICAgIHR5cGVvZiBlbnZbYnVja2V0TmFtZV0gPT09ICdzdHJpbmcnICYmXG4gICAgICB0eXBlb2YgZW52W2tleU5hbWVdID09PSAnc3RyaW5nJyAmJlxuICAgICAgdHlwZW9mIGVudltlbmRwb2ludE5hbWVdID09PSAnc3RyaW5nJ1xuICAgIClcbiAgKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgYFRoZSBkYXRhIGVudmlyb25tZW50IHZhcmlhYmxlcyBhcmUgbWFsZm9ybWVkLiBlbnY9JHtKU09OLnN0cmluZ2lmeShlbnYpfWAsXG4gICAgKTtcbiAgfVxuXG4gIGNvbnN0IGRhdGFCdWNrZXQgPSBlbnZbYnVja2V0TmFtZV0gYXMgc3RyaW5nO1xuICBjb25zdCBkYXRhS2V5ID0gZW52W2tleU5hbWVdIGFzIHN0cmluZztcbiAgY29uc3QgZGF0YUVuZHBvaW50ID0gZW52W2VuZHBvaW50TmFtZV0gYXMgc3RyaW5nO1xuXG4gIHJldHVybiB7XG4gICAgLi4uZW52LFxuICAgIGRhdGFCdWNrZXQsXG4gICAgZGF0YUtleSxcbiAgICBkYXRhRW5kcG9pbnQsXG4gIH07XG59O1xuXG4vKipcbiAqIEdlbmVyYXRlIHRoZSBgcmVzb3VyY2VDb25maWdgIGFuZCBgbGlicmFyeU9wdGlvbnNgIG5lZWQgdG8gY29uZmlndXJlXG4gKiBBbXBsaWZ5IGZvciB0aGUgZGF0YSBjbGllbnQgaW4gYSBsYW1iZGEuXG4gKlxuICogWW91ciBmdW5jdGlvbiBuZWVkcyB0byBiZSBncmFudGVkIHJlc291cmNlIGFjY2VzcyBvbiB5b3VyIHNjaGVtYSBmb3IgdGhpcyB0byB3b3JrXG4gKiBgYS5zY2hlbWEoLi4uKS5hdXRob3JpemF0aW9uKChhbGxvdykgPT4gW2EucmVzb3VyY2UobXlGdW5jdGlvbildKWBcbiAqIEBwYXJhbSBlbnYgLSBUaGUgZW52aXJvbm1lbnQgdmFyaWFibGVzIGZvciB0aGUgZGF0YSBjbGllbnRcbiAqIEByZXR1cm5zIEFuIG9iamVjdCBjb250YWluaW5nIHRoZSBgcmVzb3VyY2VDb25maWdgIGFuZCBgbGlicmFyeU9wdGlvbnNgXG4gKi9cbmV4cG9ydCBjb25zdCBnZXRBbXBsaWZ5RGF0YUNsaWVudENvbmZpZyA9IGFzeW5jIChcbiAgZW52OiBEYXRhQ2xpZW50RW52LFxuICBzM0NsaWVudD86IFMzQ2xpZW50LFxuKTogUHJvbWlzZTxEYXRhQ2xpZW50Q29uZmlnPiA9PiB7XG4gIGlmICghczNDbGllbnQpIHtcbiAgICBzM0NsaWVudCA9IG5ldyBTM0NsaWVudCgpO1xuICB9XG5cbiAgY29uc3QgZGF0YU5hbWUgPSBuZXcgTmFtaW5nQ29udmVydGVyKCkudG9TY3JlYW1pbmdTbmFrZUNhc2UoXG4gICAgZW52LkFNUExJRllfREFUQV9ERUZBVUxUX05BTUUsXG4gICk7XG4gIGNvbnN0IGV4dGVuZGVkRW52ID0gZXh0ZW5kRW52KGVudiwgZGF0YU5hbWUpO1xuXG4gIGxldCBtb2RlbEludHJvc3BlY3Rpb25TY2hlbWE6IG9iamVjdDtcblxuICB0cnkge1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgczNDbGllbnQuc2VuZChcbiAgICAgIG5ldyBHZXRPYmplY3RDb21tYW5kKHtcbiAgICAgICAgQnVja2V0OiBleHRlbmRlZEVudi5kYXRhQnVja2V0LFxuICAgICAgICBLZXk6IGV4dGVuZGVkRW52LmRhdGFLZXksXG4gICAgICB9KSxcbiAgICApO1xuICAgIGNvbnN0IG1vZGVsSW50cm9zcGVjdGlvblNjaGVtYUpzb24gPVxuICAgICAgYXdhaXQgcmVzcG9uc2UuQm9keT8udHJhbnNmb3JtVG9TdHJpbmcoKTtcbiAgICBtb2RlbEludHJvc3BlY3Rpb25TY2hlbWEgPSBKU09OLnBhcnNlKG1vZGVsSW50cm9zcGVjdGlvblNjaGVtYUpzb24gPz8gJ3t9Jyk7XG4gIH0gY2F0Y2ggKGNhdWdodCkge1xuICAgIGlmIChjYXVnaHQgaW5zdGFuY2VvZiBOb1N1Y2hLZXkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ0Vycm9yIHJldHJpZXZpbmcgdGhlIHNjaGVtYSBmcm9tIFMzLiBQbGVhc2UgY29uZmlybSB0aGF0IHlvdXIgcHJvamVjdCBoYXMgYSBgZGVmaW5lRGF0YWAgaW5jbHVkZWQgaW4gdGhlIGBkZWZpbmVCYWNrZW5kYCBkZWZpbml0aW9uLicsXG4gICAgICAgIHsgY2F1c2U6IGNhdWdodCB9LFxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKGNhdWdodCBpbnN0YW5jZW9mIFMzU2VydmljZUV4Y2VwdGlvbikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRXJyb3IgcmV0cmlldmluZyB0aGUgc2NoZW1hIGZyb20gUzMuIFlvdSBtYXkgbmVlZCB0byBncmFudCB0aGlzIGZ1bmN0aW9uIGF1dGhvcml6YXRpb24gb24gdGhlIHNjaGVtYS4gJHtjYXVnaHQubmFtZX06ICR7Y2F1Z2h0Lm1lc3NhZ2V9LmAsXG4gICAgICAgIHsgY2F1c2U6IGNhdWdodCB9LFxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgY2F1Z2h0O1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGxpYnJhcnlPcHRpb25zID0gZ2V0TGlicmFyeU9wdGlvbnMoZW52KTtcblxuICBjb25zdCByZXNvdXJjZUNvbmZpZyA9IGdldFJlc291cmNlQ29uZmlnKFxuICAgIGV4dGVuZGVkRW52LFxuICAgIG1vZGVsSW50cm9zcGVjdGlvblNjaGVtYSxcbiAgKTtcblxuICByZXR1cm4geyByZXNvdXJjZUNvbmZpZywgbGlicmFyeU9wdGlvbnMgfTtcbn07XG4iXX0=