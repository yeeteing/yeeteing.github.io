"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ConversationTurnResponseSender = void 0;
const graphql_request_executor_1 = require("./graphql_request_executor");
const user_agent_provider_1 = require("./user_agent_provider");
/**
 * This class is responsible for sending a response produced by Bedrock back to AppSync
 * in a form of mutation.
 */
class ConversationTurnResponseSender {
    /**
     * Creates conversation turn response sender.
     */
    constructor(event, userAgentProvider = new user_agent_provider_1.UserAgentProvider(event), graphqlRequestExecutor = new graphql_request_executor_1.GraphqlRequestExecutor(event.graphqlApiEndpoint, event.request.headers.authorization, userAgentProvider), logger = console) {
        this.event = event;
        this.userAgentProvider = userAgentProvider;
        this.graphqlRequestExecutor = graphqlRequestExecutor;
        this.logger = logger;
        this.sendResponse = async (message) => {
            const responseMutationRequest = this.createMutationRequest(message);
            this.logger.debug('Sending response mutation:', responseMutationRequest);
            await this.graphqlRequestExecutor.executeGraphql(responseMutationRequest, {
                userAgent: this.userAgentProvider.getUserAgent({
                    'turn-response-type': 'single',
                }),
            });
        };
        this.sendResponseChunk = async (chunk) => {
            const responseMutationRequest = this.createStreamingMutationRequest(chunk);
            this.logger.debug('Sending response mutation:', responseMutationRequest);
            await this.graphqlRequestExecutor.executeGraphql(responseMutationRequest, {
                userAgent: this.userAgentProvider.getUserAgent({
                    'turn-response-type': 'streaming',
                }),
            });
        };
        this.sendErrors = async (errors) => {
            const responseMutationRequest = this.createMutationErrorsRequest(errors);
            this.logger.debug('Sending errors response mutation:', responseMutationRequest);
            await this.graphqlRequestExecutor.executeGraphql(responseMutationRequest, {
                userAgent: this.userAgentProvider.getUserAgent({
                    'turn-response-type': 'error',
                }),
            });
        };
        this.createMutationErrorsRequest = (errors) => {
            const query = `
        mutation PublishModelResponse($input: ${this.event.responseMutation.inputTypeName}!) {
            ${this.event.responseMutation.name}(input: $input) {
                ${this.event.responseMutation.selectionSet}
            }
        }
    `;
            const variables = {
                input: {
                    conversationId: this.event.conversationId,
                    errors,
                    associatedUserMessageId: this.event.currentMessageId,
                },
            };
            return { query, variables };
        };
        this.createMutationRequest = (content) => {
            const query = `
        mutation PublishModelResponse($input: ${this.event.responseMutation.inputTypeName}!) {
            ${this.event.responseMutation.name}(input: $input) {
                ${this.event.responseMutation.selectionSet}
            }
        }
    `;
            content = this.serializeContent(content);
            const variables = {
                input: {
                    conversationId: this.event.conversationId,
                    content,
                    associatedUserMessageId: this.event.currentMessageId,
                },
            };
            return { query, variables };
        };
        this.createStreamingMutationRequest = (chunk) => {
            const query = `
        mutation PublishModelResponse($input: ${this.event.responseMutation.inputTypeName}!) {
            ${this.event.responseMutation.name}(input: $input) {
                ${this.event.responseMutation.selectionSet}
            }
        }
    `;
            chunk = {
                ...chunk,
                accumulatedTurnContent: this.serializeContent(chunk.accumulatedTurnContent),
            };
            const variables = {
                input: chunk,
            };
            return { query, variables };
        };
        this.serializeContent = (content) => {
            return content.map((block) => {
                if (block.toolUse) {
                    // The `input` field is typed as `AWS JSON` in the GraphQL API because it can represent
                    // arbitrary JSON values.
                    // We need to stringify it before sending it to AppSync to prevent type errors.
                    const input = JSON.stringify(block.toolUse.input);
                    return { toolUse: { ...block.toolUse, input } };
                }
                return block;
            });
        };
    }
}
exports.ConversationTurnResponseSender = ConversationTurnResponseSender;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udmVyc2F0aW9uX3R1cm5fcmVzcG9uc2Vfc2VuZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbnZlcnNhdGlvbi9ydW50aW1lL2NvbnZlcnNhdGlvbl90dXJuX3Jlc3BvbnNlX3NlbmRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFNQSx5RUFBb0U7QUFDcEUsK0RBQTBEO0FBc0IxRDs7O0dBR0c7QUFDSCxNQUFhLDhCQUE4QjtJQUN6Qzs7T0FFRztJQUNILFlBQ21CLEtBQTRCLEVBQzVCLG9CQUFvQixJQUFJLHVDQUFpQixDQUFDLEtBQUssQ0FBQyxFQUNoRCx5QkFBeUIsSUFBSSxpREFBc0IsQ0FDbEUsS0FBSyxDQUFDLGtCQUFrQixFQUN4QixLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxhQUFhLEVBQ25DLGlCQUFpQixDQUNsQixFQUNnQixTQUFTLE9BQU87UUFQaEIsVUFBSyxHQUFMLEtBQUssQ0FBdUI7UUFDNUIsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUErQjtRQUNoRCwyQkFBc0IsR0FBdEIsc0JBQXNCLENBSXRDO1FBQ2dCLFdBQU0sR0FBTixNQUFNLENBQVU7UUFHbkMsaUJBQVksR0FBRyxLQUFLLEVBQUUsT0FBdUIsRUFBRSxFQUFFO1lBQy9DLE1BQU0sdUJBQXVCLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3BFLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLDRCQUE0QixFQUFFLHVCQUF1QixDQUFDLENBQUM7WUFDekUsTUFBTSxJQUFJLENBQUMsc0JBQXNCLENBQUMsY0FBYyxDQUc5Qyx1QkFBdUIsRUFBRTtnQkFDekIsU0FBUyxFQUFFLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxZQUFZLENBQUM7b0JBQzdDLG9CQUFvQixFQUFFLFFBQVE7aUJBQy9CLENBQUM7YUFDSCxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUM7UUFFRixzQkFB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SSxDQUFDLGdCQUFnQixDQUMzQyxLQUFLLENBQUMsc0JBQXNCLENBQzdCO2FBQ0YsQ0FBQztZQUNGLE1BQU0sU0FBUyxHQUFtQztnQkFDaEQsS0FBSyxFQUFFLEtBQUs7YUFDYixDQUFDO1lBQ0YsT0FBTyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsQ0FBQztRQUM5QixDQUFDLENBQUM7UUFFTSxxQkFBZ0IsR0FBRyxDQUFDLE9BQXVCLEVBQUUsRUFBRTtZQUNyRCxPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtnQkFDM0IsSUFBSSxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUM7b0JBQ2xCLHVGQUF1RjtvQkFDdkYseUJBQXlCO29CQUN6QiwrRUFBK0U7b0JBQy9FLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztvQkFDbEQsT0FBTyxFQUFFLE9BQU8sRUFBRSxFQUFFLEdBQUcsS0FBSyxDQUFDLE9BQU8sRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDO2dCQUNsRCxDQUFDO2dCQUNELE9BQU8sS0FBSyxDQUFDO1lBQ2YsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUM7SUFoSEMsQ0FBQztDQWlITDtBQTlIRCx3RUE4SEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb252ZXJzYXRpb25UdXJuRXJyb3IsXG4gIENvbnZlcnNhdGlvblR1cm5FdmVudCxcbiAgU3RyZWFtaW5nUmVzcG9uc2VDaHVuayxcbn0gZnJvbSAnLi90eXBlcy5qcyc7XG5pbXBvcnQgdHlwZSB7IENvbnRlbnRCbG9jayB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1iZWRyb2NrLXJ1bnRpbWUnO1xuaW1wb3J0IHsgR3JhcGhxbFJlcXVlc3RFeGVjdXRvciB9IGZyb20gJy4vZ3JhcGhxbF9yZXF1ZXN0X2V4ZWN1dG9yJztcbmltcG9ydCB7IFVzZXJBZ2VudFByb3ZpZGVyIH0gZnJvbSAnLi91c2VyX2FnZW50X3Byb3ZpZGVyJztcblxuZXhwb3J0IHR5cGUgTXV0YXRpb25SZXNwb25zZUlucHV0ID0ge1xuICBpbnB1dDoge1xuICAgIGNvbnZlcnNhdGlvbklkOiBzdHJpbmc7XG4gICAgY29udGVudDogQ29udGVudEJsb2NrW107XG4gICAgYXNzb2NpYXRlZFVzZXJNZXNzYWdlSWQ6IHN0cmluZztcbiAgfTtcbn07XG5cbmV4cG9ydCB0eXBlIE11dGF0aW9uU3RyZWFtaW5nUmVzcG9uc2VJbnB1dCA9IHtcbiAgaW5wdXQ6IFN0cmVhbWluZ1Jlc3BvbnNlQ2h1bms7XG59O1xuXG5leHBvcnQgdHlwZSBNdXRhdGlvbkVycm9yc1Jlc3BvbnNlSW5wdXQgPSB7XG4gIGlucHV0OiB7XG4gICAgY29udmVyc2F0aW9uSWQ6IHN0cmluZztcbiAgICBlcnJvcnM6IENvbnZlcnNhdGlvblR1cm5FcnJvcltdO1xuICAgIGFzc29jaWF0ZWRVc2VyTWVzc2FnZUlkOiBzdHJpbmc7XG4gIH07XG59O1xuXG4vKipcbiAqIFRoaXMgY2xhc3MgaXMgcmVzcG9uc2libGUgZm9yIHNlbmRpbmcgYSByZXNwb25zZSBwcm9kdWNlZCBieSBCZWRyb2NrIGJhY2sgdG8gQXBwU3luY1xuICogaW4gYSBmb3JtIG9mIG11dGF0aW9uLlxuICovXG5leHBvcnQgY2xhc3MgQ29udmVyc2F0aW9uVHVyblJlc3BvbnNlU2VuZGVyIHtcbiAgLyoqXG4gICAqIENyZWF0ZXMgY29udmVyc2F0aW9uIHR1cm4gcmVzcG9uc2Ugc2VuZGVyLlxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBldmVudDogQ29udmVyc2F0aW9uVHVybkV2ZW50LFxuICAgIHByaXZhdGUgcmVhZG9ubHkgdXNlckFnZW50UHJvdmlkZXIgPSBuZXcgVXNlckFnZW50UHJvdmlkZXIoZXZlbnQpLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZ3JhcGhxbFJlcXVlc3RFeGVjdXRvciA9IG5ldyBHcmFwaHFsUmVxdWVzdEV4ZWN1dG9yKFxuICAgICAgZXZlbnQuZ3JhcGhxbEFwaUVuZHBvaW50LFxuICAgICAgZXZlbnQucmVxdWVzdC5oZWFkZXJzLmF1dGhvcml6YXRpb24sXG4gICAgICB1c2VyQWdlbnRQcm92aWRlcixcbiAgICApLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyID0gY29uc29sZSxcbiAgKSB7fVxuXG4gIHNlbmRSZXNwb25zZSA9IGFzeW5jIChtZXNzYWdlOiBDb250ZW50QmxvY2tbXSkgPT4ge1xuICAgIGNvbnN0IHJlc3BvbnNlTXV0YXRpb25SZXF1ZXN0ID0gdGhpcy5jcmVhdGVNdXRhdGlvblJlcXVlc3QobWVzc2FnZSk7XG4gICAgdGhpcy5sb2dnZXIuZGVidWcoJ1NlbmRpbmcgcmVzcG9uc2UgbXV0YXRpb246JywgcmVzcG9uc2VNdXRhdGlvblJlcXVlc3QpO1xuICAgIGF3YWl0IHRoaXMuZ3JhcGhxbFJlcXVlc3RFeGVjdXRvci5leGVjdXRlR3JhcGhxbDxcbiAgICAgIE11dGF0aW9uUmVzcG9uc2VJbnB1dCxcbiAgICAgIHZvaWRcbiAgICA+KHJlc3BvbnNlTXV0YXRpb25SZXF1ZXN0LCB7XG4gICAgICB1c2VyQWdlbnQ6IHRoaXMudXNlckFnZW50UHJvdmlkZXIuZ2V0VXNlckFnZW50KHtcbiAgICAgICAgJ3R1cm4tcmVzcG9uc2UtdHlwZSc6ICdzaW5nbGUnLFxuICAgICAgfSksXG4gICAgfSk7XG4gIH07XG5cbiAgc2VuZFJlc3BvbnNlQ2h1bmsgPSBhc3luYyAoY2h1bms6IFN0cmVhbWluZ1Jlc3BvbnNlQ2h1bmspID0+IHtcbiAgICBjb25zdCByZXNwb25zZU11dGF0aW9uUmVxdWVzdCA9IHRoaXMuY3JlYXRlU3RyZWFtaW5nTXV0YXRpb25SZXF1ZXN0KGNodW5rKTtcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZygnU2VuZGluZyByZXNwb25zZSBtdXRhdGlvbjonLCByZXNwb25zZU11dGF0aW9uUmVxdWVzdCk7XG4gICAgYXdhaXQgdGhpcy5ncmFwaHFsUmVxdWVzdEV4ZWN1dG9yLmV4ZWN1dGVHcmFwaHFsPFxuICAgICAgTXV0YXRpb25TdHJlYW1pbmdSZXNwb25zZUlucHV0LFxuICAgICAgdm9pZFxuICAgID4ocmVzcG9uc2VNdXRhdGlvblJlcXVlc3QsIHtcbiAgICAgIHVzZXJBZ2VudDogdGhpcy51c2VyQWdlbnRQcm92aWRlci5nZXRVc2VyQWdlbnQoe1xuICAgICAgICAndHVybi1yZXNwb25zZS10eXBlJzogJ3N0cmVhbWluZycsXG4gICAgICB9KSxcbiAgICB9KTtcbiAgfTtcblxuICBzZW5kRXJyb3JzID0gYXN5bmMgKGVycm9yczogQ29udmVyc2F0aW9uVHVybkVycm9yW10pID0+IHtcbiAgICBjb25zdCByZXNwb25zZU11dGF0aW9uUmVxdWVzdCA9IHRoaXMuY3JlYXRlTXV0YXRpb25FcnJvcnNSZXF1ZXN0KGVycm9ycyk7XG4gICAgdGhpcy5sb2dnZXIuZGVidWcoXG4gICAgICAnU2VuZGluZyBlcnJvcnMgcmVzcG9uc2UgbXV0YXRpb246JyxcbiAgICAgIHJlc3BvbnNlTXV0YXRpb25SZXF1ZXN0LFxuICAgICk7XG4gICAgYXdhaXQgdGhpcy5ncmFwaHFsUmVxdWVzdEV4ZWN1dG9yLmV4ZWN1dGVHcmFwaHFsPFxuICAgICAgTXV0YXRpb25FcnJvcnNSZXNwb25zZUlucHV0LFxuICAgICAgdm9pZFxuICAgID4ocmVzcG9uc2VNdXRhdGlvblJlcXVlc3QsIHtcbiAgICAgIHVzZXJBZ2VudDogdGhpcy51c2VyQWdlbnRQcm92aWRlci5nZXRVc2VyQWdlbnQoe1xuICAgICAgICAndHVybi1yZXNwb25zZS10eXBlJzogJ2Vycm9yJyxcbiAgICAgIH0pLFxuICAgIH0pO1xuICB9O1xuXG4gIHByaXZhdGUgY3JlYXRlTXV0YXRpb25FcnJvcnNSZXF1ZXN0ID0gKGVycm9yczogQ29udmVyc2F0aW9uVHVybkVycm9yW10pID0+IHtcbiAgICBjb25zdCBxdWVyeSA9IGBcbiAgICAgICAgbXV0YXRpb24gUHVibGlzaE1vZGVsUmVzcG9uc2UoJGlucHV0OiAke3RoaXMuZXZlbnQucmVzcG9uc2VNdXRhdGlvbi5pbnB1dFR5cGVOYW1lfSEpIHtcbiAgICAgICAgICAgICR7dGhpcy5ldmVudC5yZXNwb25zZU11dGF0aW9uLm5hbWV9KGlucHV0OiAkaW5wdXQpIHtcbiAgICAgICAgICAgICAgICAke3RoaXMuZXZlbnQucmVzcG9uc2VNdXRhdGlvbi5zZWxlY3Rpb25TZXR9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICBgO1xuICAgIGNvbnN0IHZhcmlhYmxlczogTXV0YXRpb25FcnJvcnNSZXNwb25zZUlucHV0ID0ge1xuICAgICAgaW5wdXQ6IHtcbiAgICAgICAgY29udmVyc2F0aW9uSWQ6IHRoaXMuZXZlbnQuY29udmVyc2F0aW9uSWQsXG4gICAgICAgIGVycm9ycyxcbiAgICAgICAgYXNzb2NpYXRlZFVzZXJNZXNzYWdlSWQ6IHRoaXMuZXZlbnQuY3VycmVudE1lc3NhZ2VJZCxcbiAgICAgIH0sXG4gICAgfTtcbiAgICByZXR1cm4geyBxdWVyeSwgdmFyaWFibGVzIH07XG4gIH07XG5cbiAgcHJpdmF0ZSBjcmVhdGVNdXRhdGlvblJlcXVlc3QgPSAoY29udGVudDogQ29udGVudEJsb2NrW10pID0+IHtcbiAgICBjb25zdCBxdWVyeSA9IGBcbiAgICAgICAgbXV0YXRpb24gUHVibGlzaE1vZGVsUmVzcG9uc2UoJGlucHV0OiAke3RoaXMuZXZlbnQucmVzcG9uc2VNdXRhdGlvbi5pbnB1dFR5cGVOYW1lfSEpIHtcbiAgICAgICAgICAgICR7dGhpcy5ldmVudC5yZXNwb25zZU11dGF0aW9uLm5hbWV9KGlucHV0OiAkaW5wdXQpIHtcbiAgICAgICAgICAgICAgICAke3RoaXMuZXZlbnQucmVzcG9uc2VNdXRhdGlvbi5zZWxlY3Rpb25TZXR9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICBgO1xuICAgIGNvbnRlbnQgPSB0aGlzLnNlcmlhbGl6ZUNvbnRlbnQoY29udGVudCk7XG4gICAgY29uc3QgdmFyaWFibGVzOiBNdXRhdGlvblJlc3BvbnNlSW5wdXQgPSB7XG4gICAgICBpbnB1dDoge1xuICAgICAgICBjb252ZXJzYXRpb25JZDogdGhpcy5ldmVudC5jb252ZXJzYXRpb25JZCxcbiAgICAgICAgY29udGVudCxcbiAgICAgICAgYXNzb2NpYXRlZFVzZXJNZXNzYWdlSWQ6IHRoaXMuZXZlbnQuY3VycmVudE1lc3NhZ2VJZCxcbiAgICAgIH0sXG4gICAgfTtcbiAgICByZXR1cm4geyBxdWVyeSwgdmFyaWFibGVzIH07XG4gIH07XG5cbiAgcHJpdmF0ZSBjcmVhdGVTdHJlYW1pbmdNdXRhdGlvblJlcXVlc3QgPSAoY2h1bms6IFN0cmVhbWluZ1Jlc3BvbnNlQ2h1bmspID0+IHtcbiAgICBjb25zdCBxdWVyeSA9IGBcbiAgICAgICAgbXV0YXRpb24gUHVibGlzaE1vZGVsUmVzcG9uc2UoJGlucHV0OiAke3RoaXMuZXZlbnQucmVzcG9uc2VNdXRhdGlvbi5pbnB1dFR5cGVOYW1lfSEpIHtcbiAgICAgICAgICAgICR7dGhpcy5ldmVudC5yZXNwb25zZU11dGF0aW9uLm5hbWV9KGlucHV0OiAkaW5wdXQpIHtcbiAgICAgICAgICAgICAgICAke3RoaXMuZXZlbnQucmVzcG9uc2VNdXRhdGlvbi5zZWxlY3Rpb25TZXR9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICBgO1xuICAgIGNodW5rID0ge1xuICAgICAgLi4uY2h1bmssXG4gICAgICBhY2N1bXVsYXRlZFR1cm5Db250ZW50OiB0aGlzLnNlcmlhbGl6ZUNvbnRlbnQoXG4gICAgICAgIGNodW5rLmFjY3VtdWxhdGVkVHVybkNvbnRlbnQsXG4gICAgICApLFxuICAgIH07XG4gICAgY29uc3QgdmFyaWFibGVzOiBNdXRhdGlvblN0cmVhbWluZ1Jlc3BvbnNlSW5wdXQgPSB7XG4gICAgICBpbnB1dDogY2h1bmssXG4gICAgfTtcbiAgICByZXR1cm4geyBxdWVyeSwgdmFyaWFibGVzIH07XG4gIH07XG5cbiAgcHJpdmF0ZSBzZXJpYWxpemVDb250ZW50ID0gKGNvbnRlbnQ6IENvbnRlbnRCbG9ja1tdKSA9PiB7XG4gICAgcmV0dXJuIGNvbnRlbnQubWFwKChibG9jaykgPT4ge1xuICAgICAgaWYgKGJsb2NrLnRvb2xVc2UpIHtcbiAgICAgICAgLy8gVGhlIGBpbnB1dGAgZmllbGQgaXMgdHlwZWQgYXMgYEFXUyBKU09OYCBpbiB0aGUgR3JhcGhRTCBBUEkgYmVjYXVzZSBpdCBjYW4gcmVwcmVzZW50XG4gICAgICAgIC8vIGFyYml0cmFyeSBKU09OIHZhbHVlcy5cbiAgICAgICAgLy8gV2UgbmVlZCB0byBzdHJpbmdpZnkgaXQgYmVmb3JlIHNlbmRpbmcgaXQgdG8gQXBwU3luYyB0byBwcmV2ZW50IHR5cGUgZXJyb3JzLlxuICAgICAgICBjb25zdCBpbnB1dCA9IEpTT04uc3RyaW5naWZ5KGJsb2NrLnRvb2xVc2UuaW5wdXQpO1xuICAgICAgICByZXR1cm4geyB0b29sVXNlOiB7IC4uLmJsb2NrLnRvb2xVc2UsIGlucHV0IH0gfTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBibG9jaztcbiAgICB9KTtcbiAgfTtcbn1cbiJdfQ==