import { SecretError } from './secret_error.js';
import { ParameterPathConversions } from '@aws-amplify/platform-core';
/**
 * This class implements Amplify Secret using SSM parameter store.
 */
export class SSMSecretClient {
    ssmClient;
    /**
     * Creates a new instance of SSMSecret.
     */
    constructor(ssmClient) {
        this.ssmClient = ssmClient;
    }
    /**
     * Get a secret from SSM parameter store.
     */
    getSecret = async (backendIdentifier, secretIdentifier) => {
        let secret;
        const name = ParameterPathConversions.toParameterFullPath(backendIdentifier, secretIdentifier.name);
        try {
            const resp = await this.ssmClient.getParameter({
                Name: secretIdentifier.version
                    ? `${name}:${secretIdentifier.version}`
                    : name,
                WithDecryption: true,
            });
            if (resp.Parameter?.Value) {
                secret = {
                    name: secretIdentifier.name,
                    version: resp.Parameter.Version,
                    value: resp.Parameter.Value,
                    lastUpdated: resp.Parameter.LastModifiedDate,
                };
            }
        }
        catch (err) {
            throw SecretError.createInstance(err);
        }
        if (!secret) {
            throw new SecretError(`The value of secret '${secretIdentifier.name}' is undefined`);
        }
        return secret;
    };
    /**
     * List secrets from SSM parameter store.
     */
    listSecrets = async (backendIdentifier) => {
        const path = ParameterPathConversions.toParameterPrefix(backendIdentifier);
        const result = [];
        try {
            let nextToken;
            do {
                const resp = await this.ssmClient.getParametersByPath({
                    Path: path,
                    WithDecryption: true,
                    NextToken: nextToken,
                });
                resp.Parameters?.forEach((param) => {
                    if (!param.Name || !param.Value) {
                        return;
                    }
                    const secretName = param.Name.split('/').pop();
                    if (secretName) {
                        result.push({
                            name: secretName,
                            version: param.Version,
                            lastUpdated: param.LastModifiedDate,
                        });
                    }
                });
                nextToken = resp.NextToken;
            } while (nextToken);
            return result;
        }
        catch (err) {
            throw SecretError.createInstance(err);
        }
    };
    /**
     * Set a secret in SSM parameter store.
     */
    setSecret = async (backendIdentifier, secretName, secretValue) => {
        const name = ParameterPathConversions.toParameterFullPath(backendIdentifier, secretName);
        try {
            const resp = await this.ssmClient.putParameter({
                Name: name,
                Type: 'SecureString',
                Value: secretValue,
                Description: `Amplify Secret`,
                Overwrite: true,
            });
            return {
                name: secretName,
                version: resp.Version,
            };
        }
        catch (err) {
            throw SecretError.createInstance(err);
        }
    };
    /**
     * Remove a secret from SSM parameter store.
     */
    removeSecret = async (backendIdentifier, secretName) => {
        const name = ParameterPathConversions.toParameterFullPath(backendIdentifier, secretName);
        try {
            await this.ssmClient.deleteParameter({
                Name: name,
            });
        }
        catch (err) {
            throw SecretError.createInstance(err);
        }
    };
    /**
     * Remove secrets from SSM parameter store.
     */
    removeSecrets = async (backendIdentifier, secretNames) => {
        const names = secretNames.map((secretName) => ParameterPathConversions.toParameterFullPath(backendIdentifier, secretName));
        try {
            const resp = await this.ssmClient.deleteParameters({
                Names: names,
            });
            if (resp.InvalidParameters && resp.InvalidParameters.length > 0) {
                throw new SecretError(`Failed to remove secrets: ${resp.InvalidParameters.join(', ')}`);
            }
        }
        catch (err) {
            if (err instanceof SecretError) {
                throw err;
            }
            throw SecretError.createInstance(err);
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3NtX3NlY3JldC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zc21fc2VjcmV0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQVFoRCxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUV0RTs7R0FFRztBQUNILE1BQU0sT0FBTyxlQUFlO0lBSUc7SUFIN0I7O09BRUc7SUFDSCxZQUE2QixTQUFjO1FBQWQsY0FBUyxHQUFULFNBQVMsQ0FBSztJQUFHLENBQUM7SUFFL0M7O09BRUc7SUFDSSxTQUFTLEdBQUcsS0FBSyxFQUN0QixpQkFBNEMsRUFDNUMsZ0JBQWtDLEVBQ2pCLEVBQUU7UUFDbkIsSUFBSSxNQUEwQixDQUFDO1FBQy9CLE1BQU0sSUFBSSxHQUFXLHdCQUF3QixDQUFDLG1CQUFtQixDQUMvRCxpQkFBaUIsRUFDakIsZ0JBQWdCLENBQUMsSUFBSSxDQUN0QixDQUFDO1FBQ0YsSUFBSSxDQUFDO1lBQ0gsTUFBTSxJQUFJLEdBQUcsTUFBTSxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQztnQkFDN0MsSUFBSSxFQUFFLGdCQUFnQixDQUFDLE9BQU87b0JBQzVCLENBQUMsQ0FBQyxHQUFHLElBQUksSUFBSSxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUU7b0JBQ3ZDLENBQUMsQ0FBQyxJQUFJO2dCQUNSLGNBQWMsRUFBRSxJQUFJO2FBQ3JCLENBQUMsQ0FBQztZQUNILElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRSxLQUFLLEVBQUUsQ0FBQztnQkFDMUIsTUFBTSxHQUFHO29CQUNQLElBQUksRUFBRSxnQkFBZ0IsQ0FBQyxJQUFJO29CQUMzQixPQUFPLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPO29CQUMvQixLQUFLLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLO29CQUMzQixXQUFXLEVBQUUsSUFBSSxDQUFDLFNB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LEdBQVksQ0FBQyxDQUFDO1FBQ2pELENBQUM7SUFDSCxDQUFDLENBQUM7Q0FDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFNTTSB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zc20nO1xuaW1wb3J0IHsgU2VjcmV0RXJyb3IgfSBmcm9tICcuL3NlY3JldF9lcnJvci5qcyc7XG5pbXBvcnQge1xuICBTZWNyZXQsXG4gIFNlY3JldENsaWVudCxcbiAgU2VjcmV0SWRlbnRpZmllcixcbiAgU2VjcmV0TGlzdEl0ZW0sXG59IGZyb20gJy4vc2VjcmV0LmpzJztcbmltcG9ydCB7IEFwcElkLCBCYWNrZW5kSWRlbnRpZmllciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHsgUGFyYW1ldGVyUGF0aENvbnZlcnNpb25zIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsYXRmb3JtLWNvcmUnO1xuXG4vKipcbiAqIFRoaXMgY2xhc3MgaW1wbGVtZW50cyBBbXBsaWZ5IFNlY3JldCB1c2luZyBTU00gcGFyYW1ldGVyIHN0b3JlLlxuICovXG5leHBvcnQgY2xhc3MgU1NNU2VjcmV0Q2xpZW50IGltcGxlbWVudHMgU2VjcmV0Q2xpZW50IHtcbiAgLyoqXG4gICAqIENyZWF0ZXMgYSBuZXcgaW5zdGFuY2Ugb2YgU1NNU2VjcmV0LlxuICAgKi9cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBzc21DbGllbnQ6IFNTTSkge31cblxuICAvKipcbiAgICogR2V0IGEgc2VjcmV0IGZyb20gU1NNIHBhcmFtZXRlciBzdG9yZS5cbiAgICovXG4gIHB1YmxpYyBnZXRTZWNyZXQgPSBhc3luYyAoXG4gICAgYmFja2VuZElkZW50aWZpZXI6IEJhY2tlbmRJZGVudGlmaWVyIHwgQXBwSWQsXG4gICAgc2VjcmV0SWRlbnRpZmllcjogU2VjcmV0SWRlbnRpZmllcixcbiAgKTogUHJvbWlzZTxTZWNyZXQ+ID0+IHtcbiAgICBsZXQgc2VjcmV0OiBTZWNyZXQgfCB1bmRlZmluZWQ7XG4gICAgY29uc3QgbmFtZTogc3RyaW5nID0gUGFyYW1ldGVyUGF0aENvbnZlcnNpb25zLnRvUGFyYW1ldGVyRnVsbFBhdGgoXG4gICAgICBiYWNrZW5kSWRlbnRpZmllcixcbiAgICAgIHNlY3JldElkZW50aWZpZXIubmFtZSxcbiAgICApO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXNwID0gYXdhaXQgdGhpcy5zc21DbGllbnQuZ2V0UGFyYW1ldGVyKHtcbiAgICAgICAgTmFtZTogc2VjcmV0SWRlbnRpZmllci52ZXJzaW9uXG4gICAgICAgICAgPyBgJHtuYW1lfToke3NlY3JldElkZW50aWZpZXIudmVyc2lvbn1gXG4gICAgICAgICAgOiBuYW1lLFxuICAgICAgICBXaXRoRGVjcnlwdGlvbjogdHJ1ZSxcbiAgICAgIH0pO1xuICAgICAgaWYgKHJlc3AuUGFyYW1ldGVyPy5WYWx1ZSkge1xuICAgICAgICBzZWNyZXQgPSB7XG4gICAgICAgICAgbmFtZTogc2VjcmV0SWRlbnRpZmllci5uYW1lLFxuICAgICAgICAgIHZlcnNpb246IHJlc3AuUGFyYW1ldGVyLlZlcnNpb24sXG4gICAgICAgICAgdmFsdWU6IHJlc3AuUGFyYW1ldGVyLlZhbHVlLFxuICAgICAgICAgIGxhc3RVcGRhdGVkOiByZXNwLlBhcmFtZXRlci5MYXN0TW9kaWZpZWREYXRlLFxuICAgICAgICB9O1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhyb3cgU2VjcmV0RXJyb3IuY3JlYXRlSW5zdGFuY2UoZXJyIGFzIEVycm9yKTtcbiAgICB9XG5cbiAgICBpZiAoIXNlY3JldCkge1xuICAgICAgdGhyb3cgbmV3IFNlY3JldEVycm9yKFxuICAgICAgICBgVGhlIHZhbHVlIG9mIHNlY3JldCAnJHtzZWNyZXRJZGVudGlmaWVyLm5hbWV9JyBpcyB1bmRlZmluZWRgLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc2VjcmV0O1xuICB9O1xuXG4gIC8qKlxuICAgKiBMaXN0IHNlY3JldHMgZnJvbSBTU00gcGFyYW1ldGVyIHN0b3JlLlxuICAgKi9cbiAgcHVibGljIGxpc3RTZWNyZXRzID0gYXN5bmMgKFxuICAgIGJhY2tlbmRJZGVudGlmaWVyOiBCYWNrZW5kSWRlbnRpZmllciB8IEFwcElkLFxuICApOiBQcm9taXNlPFNlY3JldExpc3RJdGVtW10+ID0+IHtcbiAgICBjb25zdCBwYXRoID0gUGFyYW1ldGVyUGF0aENvbnZlcnNpb25zLnRvUGFyYW1ldGVyUHJlZml4KGJhY2tlbmRJZGVudGlmaWVyKTtcbiAgICBjb25zdCByZXN1bHQ6IFNlY3JldExpc3RJdGVtW10gPSBbXTtcblxuICAgIHRyeSB7XG4gICAgICBsZXQgbmV4dFRva2VuOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgICBkbyB7XG4gICAgICAgIGNvbnN0IHJlc3AgPSBhd2FpdCB0aGlzLnNzbUNsaWVudC5nZXRQYXJhbWV0ZXJzQnlQYXRoKHtcbiAgICAgICAgICBQYXRoOiBwYXRoLFxuICAgICAgICAgIFdpdGhEZWNyeXB0aW9uOiB0cnVlLFxuICAgICAgICAgIE5leHRUb2tlbjogbmV4dFRva2VuLFxuICAgICAgICB9KTtcblxuICAgICAgICByZXNwLlBhcmFtZXRlcnM/LmZvckVhY2goKHBhcmFtKSA9PiB7XG4gICAgICAgICAgaWYgKCFwYXJhbS5OYW1lIHx8ICFwYXJhbS5WYWx1ZSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIH1cbiAgICAgICAgICBjb25zdCBzZWNyZXROYW1lID0gcGFyYW0uTmFtZS5zcGxpdCgnLycpLnBvcCgpO1xuICAgICAgICAgIGlmIChzZWNyZXROYW1lKSB7XG4gICAgICAgICAgICByZXN1bHQucHVzaCh7XG4gICAgICAgICAgICAgIG5hbWU6IHNlY3JldE5hbWUsXG4gICAgICAgICAgICAgIHZlcnNpb246IHBhcmFtLlZlcnNpb24sXG4gICAgICAgICAgICAgIGxhc3RVcGRhdGVkOiBwYXJhbS5MYXN0TW9kaWZpZWREYXRlLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgbmV4dFRva2VuID0gcmVzcC5OZXh0VG9rZW47XG4gICAgICB9IHdoaWxlIChuZXh0VG9rZW4pO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRocm93IFNlY3JldEVycm9yLmNyZWF0ZUluc3RhbmNlKGVyciBhcyBFcnJvcik7XG4gICAgfVxuICB9O1xuXG4gIC8qKlxuICAgKiBTZXQgYSBzZWNyZXQgaW4gU1NNIHBhcmFtZXRlciBzdG9yZS5cbiAgICovXG4gIHB1YmxpYyBzZXRTZWNyZXQgPSBhc3luYyAoXG4gICAgYmFja2VuZElkZW50aWZpZXI6IEJhY2tlbmRJZGVudGlmaWVyIHwgQXBwSWQsXG4gICAgc2VjcmV0TmFtZTogc3RyaW5nLFxuICAgIHNlY3JldFZhbHVlOiBzdHJpbmcsXG4gICk6IFByb21pc2U8U2VjcmV0SWRlbnRpZmllcj4gPT4ge1xuICAgIGNvbnN0IG5hbWUgPSBQYXJhbWV0ZXJQYXRoQ29udmVyc2lvbnMudG9QYXJhbWV0ZXJGdWxsUGF0aChcbiAgICAgIGJhY2tlbmRJZGVudGlmaWVyLFxuICAgICAgc2VjcmV0TmFtZSxcbiAgICApO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXNwID0gYXdhaXQgdGhpcy5zc21DbGllbnQucHV0UGFyYW1ldGVyKHtcbiAgICAgICAgTmFtZTogbmFtZSxcbiAgICAgICAgVHlwZTogJ1NlY3VyZVN0cmluZycsXG4gICAgICAgIFZhbHVlOiBzZWNyZXRWYWx1ZSxcbiAgICAgICAgRGVzY3JpcHRpb246IGBBbXBsaWZ5IFNlY3JldGAsXG4gICAgICAgIE92ZXJ3cml0ZTogdHJ1ZSxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgbmFtZTogc2VjcmV0TmFtZSxcbiAgICAgICAgdmVyc2lvbjogcmVzcC5WZXJzaW9uLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRocm93IFNlY3JldEVycm9yLmNyZWF0ZUluc3RhbmNlKGVyciBhcyBFcnJvcik7XG4gICAgfVxuICB9O1xuXG4gIC8qKlxuICAgKiBSZW1vdmUgYSBzZWNyZXQgZnJvbSBTU00gcGFyYW1ldGVyIHN0b3JlLlxuICAgKi9cbiAgcHVibGljIHJlbW92ZVNlY3JldCA9IGFzeW5jIChcbiAgICBiYWNrZW5kSWRlbnRpZmllcjogQmFja2VuZElkZW50aWZpZXIgfCBBcHBJZCxcbiAgICBzZWNyZXROYW1lOiBzdHJpbmcsXG4gICkgPT4ge1xuICAgIGNvbnN0IG5hbWUgPSBQYXJhbWV0ZXJQYXRoQ29udmVyc2lvbnMudG9QYXJhbWV0ZXJGdWxsUGF0aChcbiAgICAgIGJhY2tlbmRJZGVudGlmaWVyLFxuICAgICAgc2VjcmV0TmFtZSxcbiAgICApO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnNzbUNsaWVudC5kZWxldGVQYXJhbWV0ZXIoe1xuICAgICAgICBOYW1lOiBuYW1lLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aHJvdyBTZWNyZXRFcnJvci5jcmVhdGVJbnN0YW5jZShlcnIgYXMgRXJyb3IpO1xuICAgIH1cbiAgfTtcblxuICAvKipcbiAgICogUmVtb3ZlIHNlY3JldHMgZnJvbSBTU00gcGFyYW1ldGVyIHN0b3JlLlxuICAgKi9cbiAgcHVibGljIHJlbW92ZVNlY3JldHMgPSBhc3luYyAoXG4gICAgYmFja2VuZElkZW50aWZpZXI6IEJhY2tlbmRJZGVudGlmaWVyIHwgQXBwSWQsXG4gICAgc2VjcmV0TmFtZXM6IHN0cmluZ1tdLFxuICApID0+IHtcbiAgICBjb25zdCBuYW1lcyA9IHNlY3JldE5hbWVzLm1hcCgoc2VjcmV0TmFtZSkgPT5cbiAgICAgIFBhcmFtZXRlclBhdGhDb252ZXJzaW9ucy50b1BhcmFtZXRlckZ1bGxQYXRoKFxuICAgICAgICBiYWNrZW5kSWRlbnRpZmllcixcbiAgICAgICAgc2VjcmV0TmFtZSxcbiAgICAgICksXG4gICAgKTtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzcCA9IGF3YWl0IHRoaXMuc3NtQ2xpZW50LmRlbGV0ZVBhcmFtZXRlcnMoe1xuICAgICAgICBOYW1lczogbmFtZXMsXG4gICAgICB9KTtcbiAgICAgIGlmIChyZXNwLkludmFsaWRQYXJhbWV0ZXJzICYmIHJlc3AuSW52YWxpZFBhcmFtZXRlcnMubGVuZ3RoID4gMCkge1xuICAgICAgICB0aHJvdyBuZXcgU2VjcmV0RXJyb3IoXG4gICAgICAgICAgYEZhaWxlZCB0byByZW1vdmUgc2VjcmV0czogJHtyZXNwLkludmFsaWRQYXJhbWV0ZXJzLmpvaW4oJywgJyl9YCxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBTZWNyZXRFcnJvcikge1xuICAgICAgICB0aHJvdyBlcnI7XG4gICAgICB9XG4gICAgICB0aHJvdyBTZWNyZXRFcnJvci5jcmVhdGVJbnN0YW5jZShlcnIgYXMgRXJyb3IpO1xuICAgIH1cbiAgfTtcbn1cbiJdfQ==