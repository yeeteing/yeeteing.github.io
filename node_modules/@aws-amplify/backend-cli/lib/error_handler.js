import { LogLevel, format, printer } from '@aws-amplify/cli-core';
import { AmplifyError } from '@aws-amplify/platform-core';
import { extractSubCommands } from './extract_sub_commands.js';
let hasAttachUnhandledExceptionListenersBeenCalled = false;
/**
 * Attaches process listeners to handle unhandled exceptions and rejections
 */
export const attachUnhandledExceptionListeners = (usageDataEmitter) => {
    if (hasAttachUnhandledExceptionListenersBeenCalled) {
        return;
    }
    process.on('unhandledRejection', (reason) => {
        process.exitCode = 1;
        if (reason instanceof Error) {
            void handleErrorSafe({ error: reason, usageDataEmitter });
        }
        else if (typeof reason === 'string') {
            void handleErrorSafe({ error: new Error(reason), usageDataEmitter });
        }
        else {
            void handleErrorSafe({
                error: new Error(`Unhandled rejection of type [${typeof reason}]`, {
                    cause: reason,
                }),
                usageDataEmitter,
            });
        }
    });
    process.on('uncaughtException', (error) => {
        process.exitCode = 1;
        void handleErrorSafe({ error, usageDataEmitter });
    });
    hasAttachUnhandledExceptionListenersBeenCalled = true;
};
/**
 * Generates a function that is intended to be used as a callback to yargs.fail()
 * All logic for actually handling errors should be delegated to handleError.
 *
 * For some reason the yargs object that is injected into the fail callback does not include all methods on the Argv type
 * This generator allows us to inject the yargs parser into the callback so that we can call parser.exit() from the failure handler
 * This prevents our top-level error handler from being invoked after the yargs error handler has already been invoked
 */
export const generateCommandFailureHandler = (parser, usageDataEmitter) => {
    /**
     * Format error output when a command fails
     * @param message error message set by the yargs:check validations
     * @param error error thrown by yargs handler
     */
    const handleCommandFailure = async (message, error) => {
        const printHelp = () => {
            printer.printNewLine();
            parser.showHelp();
            printer.printNewLine();
        };
        await handleErrorSafe({
            command: extractSubCommands(parser),
            printMessagePreamble: printHelp,
            error,
            message,
            usageDataEmitter,
        });
        parser.exit(1, error || new Error(message));
    };
    return handleCommandFailure;
};
const handleErrorSafe = async (props) => {
    try {
        await handleError(props);
    }
    catch (e) {
        printer.log(format.error(e), LogLevel.DEBUG);
        // no-op should gracefully exit
        return;
    }
};
/**
 * Error handling for uncaught errors during CLI command execution.
 *
 * This should be the one and only place where we handle unexpected errors.
 * This includes console logging, debug logging, metrics recording, etc.
 * (Note that we don't do all of those things yet, but this is where they should go)
 */
const handleError = async ({ error, printMessagePreamble, message, usageDataEmitter, command, }) => {
    // If yargs threw an error because the customer force-closed a prompt (ie Ctrl+C during a prompt) then the intent to exit the process is clear
    if (isUserForceClosePromptError(error)) {
        return;
    }
    printMessagePreamble?.();
    printer.print(format.error(error || message));
    // additional debug logging for the stack traces
    if (error?.stack) {
        printer.printNewLine();
        printer.log(format.dim(error.stack), LogLevel.DEBUG);
    }
    if (errorHasCauseStackTrace(error)) {
        printer.printNewLine();
        printer.log(format.dim(error.cause.stack), LogLevel.DEBUG);
    }
    await usageDataEmitter?.emitFailure(AmplifyError.isAmplifyError(error)
        ? error
        : AmplifyError.fromError(error && error instanceof Error ? error : new Error(message)), { command: command ?? 'UnknownCommand' });
};
const isUserForceClosePromptError = (err) => {
    return !!err && err?.message.includes('User force closed the prompt');
};
const errorHasCauseStackTrace = (error) => {
    return (typeof error?.cause === 'object' &&
        !!error.cause &&
        'stack' in error.cause &&
        typeof error.cause.stack === 'string');
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXJyb3JfaGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9lcnJvcl9oYW5kbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRWxFLE9BQU8sRUFBRSxZQUFZLEVBQW9CLE1BQU0sNEJBQTRCLENBQUM7QUFDNUUsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFFL0QsSUFBSSw4Q0FBOEMsR0FBRyxLQUFLLENBQUM7QUFVM0Q7O0dBRUc7QUFDSCxNQUFNLENBQUMsTUFBTSxpQ0FBaUMsR0FBRyxDQUMvQyxnQkFBa0MsRUFDNUIsRUFBRTtJQUNSLElBQUksOENBQThDLEVBQUUsQ0FBQztRQUNuRCxPQUFPO0lBQ1QsQ0FBQztJQUNELE9BQU8sQ0FBQyxFQUFFLENBQUMsb0JBQW9CLEVBQUUsQ0FBQyxNQUFNLEVBQUUsRUFBRTtRQUMxQyxPQUFPLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQztRQUNyQixJQUFJLE1BQU0sWUFBWSxLQUFLLEVBQUUsQ0FBQztZQUM1QixLQUFLLGVBQWUsQ0FBQyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDO1FBQzVELENBQUM7YUFBTSxJQUFJLE9BQU8sTUFBTSxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQ3RDLEtBQUssZUFBZSxDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFFLGdCQUFnQixFQUFFLENBQUMsQ0FBQztRQUN2RSxDQUFDO2FBQU0sQ0FBQztZQUNOLEtBQUssZUFBZSxDQUFDO2dCQUNuQixLQUFLLEVBQUUsSUFBSSxLQUFLLENBQUMsZ0NBQWdDLE9BQU8sTUFBTSxHQUFHLEVBQUU7b0JBQ2pFLEtBQUssRUFBRSxNQUFNO2lCQUNkLENBQUM7Z0JBQ0YsZ0JBQWdCO2FB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Y0FBYyxDQUFDLEtBQUssQ0FBQztRQUNoQyxDQUFDLENBQUMsS0FBSztRQUNQLENBQUMsQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUNwQixLQUFLLElBQUksS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FDN0QsRUFDTCxFQUFFLE9BQU8sRUFBRSxPQUFPLElBQUksZ0JBQWdCLEVBQUUsQ0FDekMsQ0FBQztBQUNKLENBQUMsQ0FBQztBQUVGLE1BQU0sMkJBQTJCLEdBQUcsQ0FBQyxHQUFXLEVBQVcsRUFBRTtJQUMzRCxPQUFPLENBQUMsQ0FBQyxHQUFHLElBQUksR0FBRyxFQUFFLE9BQU8sQ0FBQyxRQUFRLENBQUMsOEJBQThCLENBQUMsQ0FBQztBQUN4RSxDQUFDLENBQUM7QUFFRixNQUFNLHVCQUF1QixHQUFHLENBQzlCLEtBQWEsRUFDa0MsRUFBRTtJQUNqRCxPQUFPLENBQ0wsT0FBTyxLQUFLLEVBQUUsS0FBSyxLQUFLLFFBQVE7UUFDaEMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLO1FBQ2IsT0FBTyxJQUFJLEtBQUssQ0FBQyxLQUFLO1FBQ3RCLE9BQU8sS0FBSyxDQUFDLEtBQUssQ0FBQyxLQUFLLEtBQUssUUFBUSxDQUN0QyxDQUFDO0FBQ0osQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTG9nTGV2ZWwsIGZvcm1hdCwgcHJpbnRlciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9jbGktY29yZSc7XG5pbXBvcnQgeyBBcmd2IH0gZnJvbSAneWFyZ3MnO1xuaW1wb3J0IHsgQW1wbGlmeUVycm9yLCBVc2FnZURhdGFFbWl0dGVyIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsYXRmb3JtLWNvcmUnO1xuaW1wb3J0IHsgZXh0cmFjdFN1YkNvbW1hbmRzIH0gZnJvbSAnLi9leHRyYWN0X3N1Yl9jb21tYW5kcy5qcyc7XG5cbmxldCBoYXNBdHRhY2hVbmhhbmRsZWRFeGNlcHRpb25MaXN0ZW5lcnNCZWVuQ2FsbGVkID0gZmFsc2U7XG5cbnR5cGUgSGFuZGxlRXJyb3JQcm9wcyA9IHtcbiAgZXJyb3I/OiBFcnJvcjtcbiAgcHJpbnRNZXNzYWdlUHJlYW1ibGU/OiAoKSA9PiB2b2lkO1xuICBtZXNzYWdlPzogc3RyaW5nO1xuICB1c2FnZURhdGFFbWl0dGVyPzogVXNhZ2VEYXRhRW1pdHRlcjtcbiAgY29tbWFuZD86IHN0cmluZztcbn07XG5cbi8qKlxuICogQXR0YWNoZXMgcHJvY2VzcyBsaXN0ZW5lcnMgdG8gaGFuZGxlIHVuaGFuZGxlZCBleGNlcHRpb25zIGFuZCByZWplY3Rpb25zXG4gKi9cbmV4cG9ydCBjb25zdCBhdHRhY2hVbmhhbmRsZWRFeGNlcHRpb25MaXN0ZW5lcnMgPSAoXG4gIHVzYWdlRGF0YUVtaXR0ZXI6IFVzYWdlRGF0YUVtaXR0ZXIsXG4pOiB2b2lkID0+IHtcbiAgaWYgKGhhc0F0dGFjaFVuaGFuZGxlZEV4Y2VwdGlvbkxpc3RlbmVyc0JlZW5DYWxsZWQpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgcHJvY2Vzcy5vbigndW5oYW5kbGVkUmVqZWN0aW9uJywgKHJlYXNvbikgPT4ge1xuICAgIHByb2Nlc3MuZXhpdENvZGUgPSAxO1xuICAgIGlmIChyZWFzb24gaW5zdGFuY2VvZiBFcnJvcikge1xuICAgICAgdm9pZCBoYW5kbGVFcnJvclNhZmUoeyBlcnJvcjogcmVhc29uLCB1c2FnZURhdGFFbWl0dGVyIH0pO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIHJlYXNvbiA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHZvaWQgaGFuZGxlRXJyb3JTYWZlKHsgZXJyb3I6IG5ldyBFcnJvcihyZWFzb24pLCB1c2FnZURhdGFFbWl0dGVyIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB2b2lkIGhhbmRsZUVycm9yU2FmZSh7XG4gICAgICAgIGVycm9yOiBuZXcgRXJyb3IoYFVuaGFuZGxlZCByZWplY3Rpb24gb2YgdHlwZSBbJHt0eXBlb2YgcmVhc29ufV1gLCB7XG4gICAgICAgICAgY2F1c2U6IHJlYXNvbixcbiAgICAgICAgfSksXG4gICAgICAgIHVzYWdlRGF0YUVtaXR0ZXIsXG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xuXG4gIHByb2Nlc3Mub24oJ3VuY2F1Z2h0RXhjZXB0aW9uJywgKGVycm9yKSA9PiB7XG4gICAgcHJvY2Vzcy5leGl0Q29kZSA9IDE7XG4gICAgdm9pZCBoYW5kbGVFcnJvclNhZmUoeyBlcnJvciwgdXNhZ2VEYXRhRW1pdHRlciB9KTtcbiAgfSk7XG4gIGhhc0F0dGFjaFVuaGFuZGxlZEV4Y2VwdGlvbkxpc3RlbmVyc0JlZW5DYWxsZWQgPSB0cnVlO1xufTtcblxuLyoqXG4gKiBHZW5lcmF0ZXMgYSBmdW5jdGlvbiB0aGF0IGlzIGludGVuZGVkIHRvIGJlIHVzZWQgYXMgYSBjYWxsYmFjayB0byB5YXJncy5mYWlsKClcbiAqIEFsbCBsb2dpYyBmb3IgYWN0dWFsbHkgaGFuZGxpbmcgZXJyb3JzIHNob3VsZCBiZSBkZWxlZ2F0ZWQgdG8gaGFuZGxlRXJyb3IuXG4gKlxuICogRm9yIHNvbWUgcmVhc29uIHRoZSB5YXJncyBvYmplY3QgdGhhdCBpcyBpbmplY3RlZCBpbnRvIHRoZSBmYWlsIGNhbGxiYWNrIGRvZXMgbm90IGluY2x1ZGUgYWxsIG1ldGhvZHMgb24gdGhlIEFyZ3YgdHlwZVxuICogVGhpcyBnZW5lcmF0b3IgYWxsb3dzIHVzIHRvIGluamVjdCB0aGUgeWFyZ3MgcGFyc2VyIGludG8gdGhlIGNhbGxiYWNrIHNvIHRoYXQgd2UgY2FuIGNhbGwgcGFyc2VyLmV4aXQoKSBmcm9tIHRoZSBmYWlsdXJlIGhhbmRsZXJcbiAqIFRoaXMgcHJldmVudHMgb3VyIHRvcC1sZXZlbCBlcnJvciBoYW5kbGVyIGZyb20gYmVpbmcgaW52b2tlZCBhZnRlciB0aGUgeWFyZ3MgZXJyb3IgaGFuZGxlciBoYXMgYWxyZWFkeSBiZWVuIGludm9rZWRcbiAqL1xuZXhwb3J0IGNvbnN0IGdlbmVyYXRlQ29tbWFuZEZhaWx1cmVIYW5kbGVyID0gKFxuICBwYXJzZXI6IEFyZ3YsXG4gIHVzYWdlRGF0YUVtaXR0ZXI/OiBVc2FnZURhdGFFbWl0dGVyLFxuKTogKChtZXNzYWdlOiBzdHJpbmcsIGVycm9yOiBFcnJvcikgPT4gUHJvbWlzZTx2b2lkPikgPT4ge1xuICAvKipcbiAgICogRm9ybWF0IGVycm9yIG91dHB1dCB3aGVuIGEgY29tbWFuZCBmYWlsc1xuICAgKiBAcGFyYW0gbWVzc2FnZSBlcnJvciBtZXNzYWdlIHNldCBieSB0aGUgeWFyZ3M6Y2hlY2sgdmFsaWRhdGlvbnNcbiAgICogQHBhcmFtIGVycm9yIGVycm9yIHRocm93biBieSB5YXJncyBoYW5kbGVyXG4gICAqL1xuICBjb25zdCBoYW5kbGVDb21tYW5kRmFpbHVyZSA9IGFzeW5jIChtZXNzYWdlOiBzdHJpbmcsIGVycm9yPzogRXJyb3IpID0+IHtcbiAgICBjb25zdCBwcmludEhlbHAgPSAoKSA9PiB7XG4gICAgICBwcmludGVyLnByaW50TmV3TGluZSgpO1xuICAgICAgcGFyc2VyLnNob3dIZWxwKCk7XG4gICAgICBwcmludGVyLnByaW50TmV3TGluZSgpO1xuICAgIH07XG4gICAgYXdhaXQgaGFuZGxlRXJyb3JTYWZlKHtcbiAgICAgIGNvbW1hbmQ6IGV4dHJhY3RTdWJDb21tYW5kcyhwYXJzZXIpLFxuICAgICAgcHJpbnRNZXNzYWdlUHJlYW1ibGU6IHByaW50SGVscCxcbiAgICAgIGVycm9yLFxuICAgICAgbWVzc2FnZSxcbiAgICAgIHVzYWdlRGF0YUVtaXR0ZXIsXG4gICAgfSk7XG4gICAgcGFyc2VyLmV4aXQoMSwgZXJyb3IgfHwgbmV3IEVycm9yKG1lc3NhZ2UpKTtcbiAgfTtcbiAgcmV0dXJuIGhhbmRsZUNvbW1hbmRGYWlsdXJlO1xufTtcblxuY29uc3QgaGFuZGxlRXJyb3JTYWZlID0gYXN5bmMgKHByb3BzOiBIYW5kbGVFcnJvclByb3BzKSA9PiB7XG4gIHRyeSB7XG4gICAgYXdhaXQgaGFuZGxlRXJyb3IocHJvcHMpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgcHJpbnRlci5sb2coZm9ybWF0LmVycm9yKGUpLCBMb2dMZXZlbC5ERUJVRyk7XG4gICAgLy8gbm8tb3Agc2hvdWxkIGdyYWNlZnVsbHkgZXhpdFxuICAgIHJldHVybjtcbiAgfVxufTtcblxuLyoqXG4gKiBFcnJvciBoYW5kbGluZyBmb3IgdW5jYXVnaHQgZXJyb3JzIGR1cmluZyBDTEkgY29tbWFuZCBleGVjdXRpb24uXG4gKlxuICogVGhpcyBzaG91bGQgYmUgdGhlIG9uZSBhbmQgb25seSBwbGFjZSB3aGVyZSB3ZSBoYW5kbGUgdW5leHBlY3RlZCBlcnJvcnMuXG4gKiBUaGlzIGluY2x1ZGVzIGNvbnNvbGUgbG9nZ2luZywgZGVidWcgbG9nZ2luZywgbWV0cmljcyByZWNvcmRpbmcsIGV0Yy5cbiAqIChOb3RlIHRoYXQgd2UgZG9uJ3QgZG8gYWxsIG9mIHRob3NlIHRoaW5ncyB5ZXQsIGJ1dCB0aGlzIGlzIHdoZXJlIHRoZXkgc2hvdWxkIGdvKVxuICovXG5jb25zdCBoYW5kbGVFcnJvciA9IGFzeW5jICh7XG4gIGVycm9yLFxuICBwcmludE1lc3NhZ2VQcmVhbWJsZSxcbiAgbWVzc2FnZSxcbiAgdXNhZ2VEYXRhRW1pdHRlcixcbiAgY29tbWFuZCxcbn06IEhhbmRsZUVycm9yUHJvcHMpID0+IHtcbiAgLy8gSWYgeWFyZ3MgdGhyZXcgYW4gZXJyb3IgYmVjYXVzZSB0aGUgY3VzdG9tZXIgZm9yY2UtY2xvc2VkIGEgcHJvbXB0IChpZSBDdHJsK0MgZHVyaW5nIGEgcHJvbXB0KSB0aGVuIHRoZSBpbnRlbnQgdG8gZXhpdCB0aGUgcHJvY2VzcyBpcyBjbGVhclxuICBpZiAoaXNVc2VyRm9yY2VDbG9zZVByb21wdEVycm9yKGVycm9yKSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIHByaW50TWVzc2FnZVByZWFtYmxlPy4oKTtcblxuICBwcmludGVyLnByaW50KGZvcm1hdC5lcnJvcihlcnJvciB8fCBtZXNzYWdlKSk7XG5cbiAgLy8gYWRkaXRpb25hbCBkZWJ1ZyBsb2dnaW5nIGZvciB0aGUgc3RhY2sgdHJhY2VzXG4gIGlmIChlcnJvcj8uc3RhY2spIHtcbiAgICBwcmludGVyLnByaW50TmV3TGluZSgpO1xuICAgIHByaW50ZXIubG9nKGZvcm1hdC5kaW0oZXJyb3Iuc3RhY2spLCBMb2dMZXZlbC5ERUJVRyk7XG4gIH1cbiAgaWYgKGVycm9ySGFzQ2F1c2VTdGFja1RyYWNlKGVycm9yKSkge1xuICAgIHByaW50ZXIucHJpbnROZXdMaW5lKCk7XG4gICAgcHJpbnRlci5sb2coZm9ybWF0LmRpbShlcnJvci5jYXVzZS5zdGFjayksIExvZ0xldmVsLkRFQlVHKTtcbiAgfVxuXG4gIGF3YWl0IHVzYWdlRGF0YUVtaXR0ZXI/LmVtaXRGYWlsdXJlKFxuICAgIEFtcGxpZnlFcnJvci5pc0FtcGxpZnlFcnJvcihlcnJvcilcbiAgICAgID8gZXJyb3JcbiAgICAgIDogQW1wbGlmeUVycm9yLmZyb21FcnJvcihcbiAgICAgICAgICBlcnJvciAmJiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IgOiBuZXcgRXJyb3IobWVzc2FnZSksXG4gICAgICAgICksXG4gICAgeyBjb21tYW5kOiBjb21tYW5kID8/ICdVbmtub3duQ29tbWFuZCcgfSxcbiAgKTtcbn07XG5cbmNvbnN0IGlzVXNlckZvcmNlQ2xvc2VQcm9tcHRFcnJvciA9IChlcnI/OiBFcnJvcik6IGJvb2xlYW4gPT4ge1xuICByZXR1cm4gISFlcnIgJiYgZXJyPy5tZXNzYWdlLmluY2x1ZGVzKCdVc2VyIGZvcmNlIGNsb3NlZCB0aGUgcHJvbXB0Jyk7XG59O1xuXG5jb25zdCBlcnJvckhhc0NhdXNlU3RhY2tUcmFjZSA9IChcbiAgZXJyb3I/OiBFcnJvcixcbik6IGVycm9yIGlzIEVycm9yICYgeyBjYXVzZTogeyBzdGFjazogc3RyaW5nIH0gfSA9PiB7XG4gIHJldHVybiAoXG4gICAgdHlwZW9mIGVycm9yPy5jYXVzZSA9PT0gJ29iamVjdCcgJiZcbiAgICAhIWVycm9yLmNhdXNlICYmXG4gICAgJ3N0YWNrJyBpbiBlcnJvci5jYXVzZSAmJlxuICAgIHR5cGVvZiBlcnJvci5jYXVzZS5zdGFjayA9PT0gJ3N0cmluZydcbiAgKTtcbn07XG4iXX0=