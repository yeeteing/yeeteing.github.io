import { DEFAULT_PROFILE, getHomeDir, loadSharedConfigFiles, } from '@smithy/shared-ini-file-loader';
import { fromIni } from '@aws-sdk/credential-providers';
import { EOL } from 'os';
import _fs from 'fs/promises';
import path from 'path';
import { existsSync } from 'fs';
import { AmplifyUserError } from '@aws-amplify/platform-core';
/**
 * Manages AWS profiles.
 */
export class ProfileController {
    fs;
    /**
     * constructor
     */
    constructor(fs = _fs) {
        this.fs = fs;
    }
    /**
     * Return true if the provided profile exists in the aws config and/or credential file.
     */
    profileExists = async (profile) => {
        const profileData = await loadSharedConfigFiles({
            ignoreCache: true,
        });
        return (profileData.configFile?.[profile] !== undefined ||
            profileData.credentialsFile?.[profile] !== undefined);
    };
    /**
     * Appends a profile to AWS config and credential files.
     */
    createOrAppendAWSFiles = async (options) => {
        await this.createOrAppendAWSConfigFile(options);
        await this.createOrAppendAWSCredentialFile(options);
    };
    createOrAppendAWSConfigFile = async (options) => {
        const filePath = process.env.AWS_CONFIG_FILE ?? path.join(getHomeDir(), '.aws', 'config');
        const dirName = path.dirname(filePath);
        if (!existsSync(dirName)) {
            await this.fs.mkdir(dirName, { recursive: true });
        }
        const fileEndsWithEOL = await this.isFileEndsWithEOL(filePath);
        let configData = fileEndsWithEOL ? '' : EOL;
        configData +=
            options.profile === DEFAULT_PROFILE
                ? `[${options.profile}]${EOL}`
                : `[profile ${options.profile}]${EOL}`;
        configData += `region = ${options.region}${EOL}`;
        try {
            await this.fs.appendFile(filePath, configData, { mode: '600' });
        }
        catch (err) {
            const error = err;
            if (error.message.includes('EACCES')) {
                throw new AmplifyUserError('PermissionsError', {
                    message: `You do not have the permissions to write to this file: ${filePath}`,
                    resolution: `Ensure that you have the right permissions to write to ${filePath}.`,
                }, error);
            }
            else {
                throw error;
            }
        }
        // validate after write. It is to ensure this function is compatible with the current AWS format.
        const profileData = await loadSharedConfigFiles({
            ignoreCache: true,
        });
        const retrievedRegion = profileData.configFile?.[options.profile]?.region;
        if (retrievedRegion !== options.region) {
            throw new Error(`Failed to configure the AWS config file`);
        }
    };
    createOrAppendAWSCredentialFile = async (options) => {
        const filePath = process.env.AWS_SHARED_CREDENTIALS_FILE ??
            path.join(getHomeDir(), '.aws', 'credentials');
        const dirName = path.dirname(filePath);
        if (!existsSync(dirName)) {
            await this.fs.mkdir(dirName, { recursive: true });
        }
        const fileEndsWithEOL = await this.isFileEndsWithEOL(filePath);
        let credentialData = fileEndsWithEOL ? '' : EOL;
        credentialData += `[${options.profile}]${EOL}`;
        credentialData += `aws_access_key_id = ${options.accessKeyId}${EOL}`;
        credentialData += `aws_secret_access_key = ${options.secretAccessKey}${EOL}`;
        await this.fs.appendFile(filePath, credentialData, { mode: '600' });
        // validate after write. It is to ensure this function is compatible with the current AWS format.
        const provider = fromIni({
            profile: options.profile,
            ignoreCache: true,
        });
        const retrievedCredentials = await provider();
        if (retrievedCredentials.accessKeyId !== options.accessKeyId ||
            retrievedCredentials.secretAccessKey !== options.secretAccessKey ||
            retrievedCredentials.sessionToken) {
            throw new Error(`Failed to configure the AWS credentials file`);
        }
    };
    isFileEndsWithEOL = async (filePath) => {
        try {
            const data = await this.fs.readFile(filePath, 'utf-8');
            return data.length > 0 && data.slice(-EOL.length) === EOL;
        }
        catch (err) {
            const error = err;
            if (error.message.includes('ENOENT')) {
                // file doesn't exists
                return true;
            }
            if (error.message.includes('EACCES')) {
                throw new AmplifyUserError('PermissionsError', {
                    message: `You do not have the permissions to read this file: ${filePath}.`,
                    resolution: `Ensure that you have the right permissions to read from ${filePath}.`,
                }, error);
            }
            else {
                throw err;
            }
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvZmlsZV9jb250cm9sbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbW1hbmRzL2NvbmZpZ3VyZS9wcm9maWxlX2NvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLGVBQWUsRUFDZixVQUFVLEVBQ1YscUJBQXFCLEdBQ3RCLE1BQU0sZ0NBQWdDLENBQUM7QUFDeEMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDekIsT0FBTyxHQUFHLE1BQU0sYUFBYSxDQUFDO0FBQzlCLE9BQU8sSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUN4QixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQ2hDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBd0I5RDs7R0FFRztBQUNILE1BQU0sT0FBTyxpQkFBaUI7SUFJQztJQUg3Qjs7T0FFRztJQUNILFlBQTZCLEtBQUssR0FBRztRQUFSLE9BQUUsR0FBRixFQUFFLENBQU07SUFBRyxDQUFDO0lBQ3pDOztPQUVHO0lBQ0gsYUFBYSxHQUFHLEtBQUssRUFBRSxPQUFlLEVBQW9CLEVBQUU7UUFDMUQsTUFBTSxXQUFXLEdBQUcsTUFBTSxxQkFBcUIsQ0FBQztZQUM5QyxXQUFXLEVBQUUsSUFBSTtTQUNsQixDQUFDLENBQUM7UUFFSCxPQUFPLENBQ0wsV0FBVyxDQUFDLFVBQVUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxLQUFLLFNBQVM7WUFDL0MsV0FBVyxDQUFDLGVBQWUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxLQUFLLFNBQVMsQ0FDckQsQ0FBQztJQUNKLENBQUMsQ0FBQztJQUVGOztPQUVHO0lBQ0gsc0JBQXNCLEdBQUcsS0FBSyxFQUFFLE9BQXVCLEVBQUUsRUFBRTtRQUN6RCxNQUFNLElBQUksQ0FBQywyQkFB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QUFFLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQztZQUN2RCxPQUFPLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUssR0FBRyxDQUFDO1FBQzVELENBQUM7UUFBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1lBQ2IsTUFBTSxLQUFLLEdBQUcsR0FBWSxDQUFDO1lBQzNCLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQztnQkFDckMsc0JBQXNCO2dCQUN0QixPQUFPLElBQUksQ0FBQztZQUNkLENBQUM7WUFDRCxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7Z0JBQ3JDLE1BQU0sSUFBSSxnQkFBZ0IsQ0FDeEIsa0JBQWtCLEVBQ2xCO29CQUNFLE9BQU8sRUFBRSxzREFBc0QsUUFBUSxHQUFHO29CQUMxRSxVQUFVLEVBQUUsMkRBQTJELFFBQVEsR0FBRztpQkFDbkYsRUFDRCxLQUFLLENBQ04sQ0FBQztZQUNKLENBQUM7aUJBQU0sQ0FBQztnQkFDTixNQUFNLEdBQUcsQ0FBQztZQUNaLENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQyxDQUFDO0NBQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBERUZBVUxUX1BST0ZJTEUsXG4gIGdldEhvbWVEaXIsXG4gIGxvYWRTaGFyZWRDb25maWdGaWxlcyxcbn0gZnJvbSAnQHNtaXRoeS9zaGFyZWQtaW5pLWZpbGUtbG9hZGVyJztcbmltcG9ydCB7IGZyb21JbmkgfSBmcm9tICdAYXdzLXNkay9jcmVkZW50aWFsLXByb3ZpZGVycyc7XG5pbXBvcnQgeyBFT0wgfSBmcm9tICdvcyc7XG5pbXBvcnQgX2ZzIGZyb20gJ2ZzL3Byb21pc2VzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZXhpc3RzU3luYyB9IGZyb20gJ2ZzJztcbmltcG9ydCB7IEFtcGxpZnlVc2VyRXJyb3IgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5cbi8qKlxuICogT3B0aW9ucyBmb3IgdGhlIHByb2ZpbGUgY29uZmlndXJhdGlvbi5cbiAqL1xudHlwZSBDb25maWdQcm9maWxlT3B0aW9ucyA9IHtcbiAgcHJvZmlsZTogc3RyaW5nO1xuICByZWdpb246IHN0cmluZztcbn07XG5cbi8qKlxuICogT3B0aW9ucyBmb3IgdGhlIHByb2ZpbGUgY3JlZGVudGlhbC5cbiAqL1xudHlwZSBDcmVkZW50aWFsUHJvZmlsZU9wdGlvbnMgPSB7XG4gIHByb2ZpbGU6IHN0cmluZztcbiAgYWNjZXNzS2V5SWQ6IHN0cmluZztcbiAgc2VjcmV0QWNjZXNzS2V5OiBzdHJpbmc7XG59O1xuXG4vKipcbiAqIE9wdGlvbnMgZm9yIHRoZSBwcm9maWxlIGNvbmZpZ3VyYXRpb24gYW5kIGNyZWRlbnRpYWwuXG4gKi9cbmV4cG9ydCB0eXBlIFByb2ZpbGVPcHRpb25zID0gQ29uZmlnUHJvZmlsZU9wdGlvbnMgJiBDcmVkZW50aWFsUHJvZmlsZU9wdGlvbnM7XG5cbi8qKlxuICogTWFuYWdlcyBBV1MgcHJvZmlsZXMuXG4gKi9cbmV4cG9ydCBjbGFzcyBQcm9maWxlQ29udHJvbGxlciB7XG4gIC8qKlxuICAgKiBjb25zdHJ1Y3RvclxuICAgKi9cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBmcyA9IF9mcykge31cbiAgLyoqXG4gICAqIFJldHVybiB0cnVlIGlmIHRoZSBwcm92aWRlZCBwcm9maWxlIGV4aXN0cyBpbiB0aGUgYXdzIGNvbmZpZyBhbmQvb3IgY3JlZGVudGlhbCBmaWxlLlxuICAgKi9cbiAgcHJvZmlsZUV4aXN0cyA9IGFzeW5jIChwcm9maWxlOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+ID0+IHtcbiAgICBjb25zdCBwcm9maWxlRGF0YSA9IGF3YWl0IGxvYWRTaGFyZWRDb25maWdGaWxlcyh7XG4gICAgICBpZ25vcmVDYWNoZTogdHJ1ZSxcbiAgICB9KTtcblxuICAgIHJldHVybiAoXG4gICAgICBwcm9maWxlRGF0YS5jb25maWdGaWxlPy5bcHJvZmlsZV0gIT09IHVuZGVmaW5lZCB8fFxuICAgICAgcHJvZmlsZURhdGEuY3JlZGVudGlhbHNGaWxlPy5bcHJvZmlsZV0gIT09IHVuZGVmaW5lZFxuICAgICk7XG4gIH07XG5cbiAgLyoqXG4gICAqIEFwcGVuZHMgYSBwcm9maWxlIHRvIEFXUyBjb25maWcgYW5kIGNyZWRlbnRpYWwgZmlsZXMuXG4gICAqL1xuICBjcmVhdGVPckFwcGVuZEFXU0ZpbGVzID0gYXN5bmMgKG9wdGlvbnM6IFByb2ZpbGVPcHRpb25zKSA9PiB7XG4gICAgYXdhaXQgdGhpcy5jcmVhdGVPckFwcGVuZEFXU0NvbmZpZ0ZpbGUob3B0aW9ucyk7XG4gICAgYXdhaXQgdGhpcy5jcmVhdGVPckFwcGVuZEFXU0NyZWRlbnRpYWxGaWxlKG9wdGlvbnMpO1xuICB9O1xuXG4gIHByaXZhdGUgY3JlYXRlT3JBcHBlbmRBV1NDb25maWdGaWxlID0gYXN5bmMgKFxuICAgIG9wdGlvbnM6IENvbmZpZ1Byb2ZpbGVPcHRpb25zLFxuICApID0+IHtcbiAgICBjb25zdCBmaWxlUGF0aCA9XG4gICAgICBwcm9jZXNzLmVudi5BV1NfQ09ORklHX0ZJTEUgPz8gcGF0aC5qb2luKGdldEhvbWVEaXIoKSwgJy5hd3MnLCAnY29uZmlnJyk7XG5cbiAgICBjb25zdCBkaXJOYW1lID0gcGF0aC5kaXJuYW1lKGZpbGVQYXRoKTtcbiAgICBpZiAoIWV4aXN0c1N5bmMoZGlyTmFtZSkpIHtcbiAgICAgIGF3YWl0IHRoaXMuZnMubWtkaXIoZGlyTmFtZSwgeyByZWN1cnNpdmU6IHRydWUgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgZmlsZUVuZHNXaXRoRU9MID0gYXdhaXQgdGhpcy5pc0ZpbGVFbmRzV2l0aEVPTChmaWxlUGF0aCk7XG4gICAgbGV0IGNvbmZpZ0RhdGEgPSBmaWxlRW5kc1dpdGhFT0wgPyAnJyA6IEVPTDtcblxuICAgIGNvbmZpZ0RhdGEgKz1cbiAgICAgIG9wdGlvbnMucHJvZmlsZSA9PT0gREVGQVVMVF9QUk9GSUxFXG4gICAgICAgID8gYFske29wdGlvbnMucHJvZmlsZX1dJHtFT0x9YFxuICAgICAgICA6IGBbcHJvZmlsZSAke29wdGlvbnMucHJvZmlsZX1dJHtFT0x9YDtcbiAgICBjb25maWdEYXRhICs9IGByZWdpb24gPSAke29wdGlvbnMucmVnaW9ufSR7RU9MfWA7XG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5mcy5hcHBlbmRGaWxlKGZpbGVQYXRoLCBjb25maWdEYXRhLCB7IG1vZGU6ICc2MDAnIH0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgY29uc3QgZXJyb3IgPSBlcnIgYXMgRXJyb3I7XG4gICAgICBpZiAoZXJyb3IubWVzc2FnZS5pbmNsdWRlcygnRUFDQ0VTJykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICAgJ1Blcm1pc3Npb25zRXJyb3InLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIG1lc3NhZ2U6IGBZb3UgZG8gbm90IGhhdmUgdGhlIHBlcm1pc3Npb25zIHRvIHdyaXRlIHRvIHRoaXMgZmlsZTogJHtmaWxlUGF0aH1gLFxuICAgICAgICAgICAgcmVzb2x1dGlvbjogYEVuc3VyZSB0aGF0IHlvdSBoYXZlIHRoZSByaWdodCBwZXJtaXNzaW9ucyB0byB3cml0ZSB0byAke2ZpbGVQYXRofS5gLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgZXJyb3IsXG4gICAgICAgICk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyB2YWxpZGF0ZSBhZnRlciB3cml0ZS4gSXQgaXMgdG8gZW5zdXJlIHRoaXMgZnVuY3Rpb24gaXMgY29tcGF0aWJsZSB3aXRoIHRoZSBjdXJyZW50IEFXUyBmb3JtYXQuXG4gICAgY29uc3QgcHJvZmlsZURhdGEgPSBhd2FpdCBsb2FkU2hhcmVkQ29uZmlnRmlsZXMoe1xuICAgICAgaWdub3JlQ2FjaGU6IHRydWUsXG4gICAgfSk7XG4gICAgY29uc3QgcmV0cmlldmVkUmVnaW9uID0gcHJvZmlsZURhdGEuY29uZmlnRmlsZT8uW29wdGlvbnMucHJvZmlsZV0/LnJlZ2lvbjtcbiAgICBpZiAocmV0cmlldmVkUmVnaW9uICE9PSBvcHRpb25zLnJlZ2lvbikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gY29uZmlndXJlIHRoZSBBV1MgY29uZmlnIGZpbGVgKTtcbiAgICB9XG4gIH07XG5cbiAgcHJpdmF0ZSBjcmVhdGVPckFwcGVuZEFXU0NyZWRlbnRpYWxGaWxlID0gYXN5bmMgKFxuICAgIG9wdGlvbnM6IENyZWRlbnRpYWxQcm9maWxlT3B0aW9ucyxcbiAgKSA9PiB7XG4gICAgY29uc3QgZmlsZVBhdGggPVxuICAgICAgcHJvY2Vzcy5lbnYuQVdTX1NIQVJFRF9DUkVERU5USUFMU19GSUxFID8/XG4gICAgICBwYXRoLmpvaW4oZ2V0SG9tZURpcigpLCAnLmF3cycsICdjcmVkZW50aWFscycpO1xuXG4gICAgY29uc3QgZGlyTmFtZSA9IHBhdGguZGlybmFtZShmaWxlUGF0aCk7XG4gICAgaWYgKCFleGlzdHNTeW5jKGRpck5hbWUpKSB7XG4gICAgICBhd2FpdCB0aGlzLmZzLm1rZGlyKGRpck5hbWUsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IGZpbGVFbmRzV2l0aEVPTCA9IGF3YWl0IHRoaXMuaXNGaWxlRW5kc1dpdGhFT0woZmlsZVBhdGgpO1xuICAgIGxldCBjcmVkZW50aWFsRGF0YSA9IGZpbGVFbmRzV2l0aEVPTCA/ICcnIDogRU9MO1xuXG4gICAgY3JlZGVudGlhbERhdGEgKz0gYFske29wdGlvbnMucHJvZmlsZX1dJHtFT0x9YDtcbiAgICBjcmVkZW50aWFsRGF0YSArPSBgYXdzX2FjY2Vzc19rZXlfaWQgPSAke29wdGlvbnMuYWNjZXNzS2V5SWR9JHtFT0x9YDtcbiAgICBjcmVkZW50aWFsRGF0YSArPSBgYXdzX3NlY3JldF9hY2Nlc3Nfa2V5ID0gJHtvcHRpb25zLnNlY3JldEFjY2Vzc0tleX0ke0VPTH1gO1xuXG4gICAgYXdhaXQgdGhpcy5mcy5hcHBlbmRGaWxlKGZpbGVQYXRoLCBjcmVkZW50aWFsRGF0YSwgeyBtb2RlOiAnNjAwJyB9KTtcblxuICAgIC8vIHZhbGlkYXRlIGFmdGVyIHdyaXRlLiBJdCBpcyB0byBlbnN1cmUgdGhpcyBmdW5jdGlvbiBpcyBjb21wYXRpYmxlIHdpdGggdGhlIGN1cnJlbnQgQVdTIGZvcm1hdC5cbiAgICBjb25zdCBwcm92aWRlciA9IGZyb21Jbmkoe1xuICAgICAgcHJvZmlsZTogb3B0aW9ucy5wcm9maWxlLFxuICAgICAgaWdub3JlQ2FjaGU6IHRydWUsXG4gICAgfSk7XG4gICAgY29uc3QgcmV0cmlldmVkQ3JlZGVudGlhbHMgPSBhd2FpdCBwcm92aWRlcigpO1xuICAgIGlmIChcbiAgICAgIHJldHJpZXZlZENyZWRlbnRpYWxzLmFjY2Vzc0tleUlkICE9PSBvcHRpb25zLmFjY2Vzc0tleUlkIHx8XG4gICAgICByZXRyaWV2ZWRDcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXkgIT09IG9wdGlvbnMuc2VjcmV0QWNjZXNzS2V5IHx8XG4gICAgICByZXRyaWV2ZWRDcmVkZW50aWFscy5zZXNzaW9uVG9rZW5cbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGNvbmZpZ3VyZSB0aGUgQVdTIGNyZWRlbnRpYWxzIGZpbGVgKTtcbiAgICB9XG4gIH07XG5cbiAgcHJpdmF0ZSBpc0ZpbGVFbmRzV2l0aEVPTCA9IGFzeW5jIChmaWxlUGF0aDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzLmZzLnJlYWRGaWxlKGZpbGVQYXRoLCAndXRmLTgnKTtcbiAgICAgIHJldHVybiBkYXRhLmxlbmd0aCA+IDAgJiYgZGF0YS5zbGljZSgtRU9MLmxlbmd0aCkgPT09IEVPTDtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGNvbnN0IGVycm9yID0gZXJyIGFzIEVycm9yO1xuICAgICAgaWYgKGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoJ0VOT0VOVCcpKSB7XG4gICAgICAgIC8vIGZpbGUgZG9lc24ndCBleGlzdHNcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgICBpZiAoZXJyb3IubWVzc2FnZS5pbmNsdWRlcygnRUFDQ0VTJykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICAgJ1Blcm1pc3Npb25zRXJyb3InLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIG1lc3NhZ2U6IGBZb3UgZG8gbm90IGhhdmUgdGhlIHBlcm1pc3Npb25zIHRvIHJlYWQgdGhpcyBmaWxlOiAke2ZpbGVQYXRofS5gLFxuICAgICAgICAgICAgcmVzb2x1dGlvbjogYEVuc3VyZSB0aGF0IHlvdSBoYXZlIHRoZSByaWdodCBwZXJtaXNzaW9ucyB0byByZWFkIGZyb20gJHtmaWxlUGF0aH0uYCxcbiAgICAgICAgICB9LFxuICAgICAgICAgIGVycm9yLFxuICAgICAgICApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgfVxuICAgIH1cbiAgfTtcbn1cbiJdfQ==