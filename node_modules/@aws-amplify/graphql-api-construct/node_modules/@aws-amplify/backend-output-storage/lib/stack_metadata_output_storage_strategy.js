"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.StackMetadataBackendOutputStorageStrategy = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
/**
 * Implementation of BackendOutputStorageStrategy that stores config data in stack metadata and outputs
 */
class StackMetadataBackendOutputStorageStrategy {
    stack;
    lazyListValueMap = new Map();
    /**
     * Initialize the instance with a stack.
     *
     * If the stack is an AmplifyStack, set a parameter in SSM so the stack can be identified later by the project environment
     */
    constructor(stack) {
        this.stack = stack;
    }
    /**
     * Store construct output as stack output and add metadata to the metadata object.
     */
    addBackendOutputEntry = (keyName, backendOutputEntry) => {
        // add all the data values as stack outputs
        Object.entries(backendOutputEntry.payload).forEach(([key, value]) => {
            new aws_cdk_lib_1.CfnOutput(this.stack, key, { value });
        });
        const metadata = this.stack.templateOptions.metadata || {};
        const existingMetadataEntry = metadata[keyName];
        this.addOrUpdateMetadata(existingMetadataEntry, keyName, backendOutputEntry);
    };
    /**
     * Lazily construct and append to output list as stack output and add metadata to the metadata object.
     */
    appendToBackendOutputList = (keyName, backendOutputEntry) => {
        const version = backendOutputEntry.version;
        let listsMap = this.lazyListValueMap.get(keyName);
        const metadata = this.stack.templateOptions.metadata || {};
        const existingMetadataEntry = metadata[keyName];
        if (existingMetadataEntry) {
            if (existingMetadataEntry.version !== version) {
                throw new Error(`Metadata entry for ${keyName} at version ${existingMetadataEntry.version} already exists. Cannot add another entry for the same key at version ${version}.`);
            }
        }
        this.addOrUpdateMetadata(existingMetadataEntry, keyName, backendOutputEntry);
        Object.entries(backendOutputEntry.payload ?? []).forEach(([listName, value]) => {
            if (!value) {
                return;
            }
            if (!listsMap) {
                listsMap = new Map();
                this.lazyListValueMap.set(keyName, listsMap);
            }
            let outputList = listsMap.get(listName);
            if (outputList) {
                outputList.push(value);
            }
            else {
                outputList = [value];
                listsMap.set(listName, outputList);
                new aws_cdk_lib_1.CfnOutput(this.stack, listName, {
                    value: aws_cdk_lib_1.Lazy.string({ produce: () => JSON.stringify(outputList) }),
                });
            }
        });
    };
    /**
     * Add or update metadata entry.
     * @param existingMetadataEntry - The existing metadata entry.
     * @param keyName - The key name.
     * @param backendOutputEntry - The backend output entry.
     */
    addOrUpdateMetadata(existingMetadataEntry, keyName, backendOutputEntry) {
        if (existingMetadataEntry) {
            this.stack.addMetadata(keyName, {
                version: backendOutputEntry.version,
                stackOutputs: [
                    ...new Set([
                        ...Object.keys(backendOutputEntry.payload),
                        ...existingMetadataEntry.stackOutputs,
                    ]),
                ],
            });
        }
        else {
            this.stack.addMetadata(keyName, {
                version: backendOutputEntry.version,
                stackOutputs: Object.keys(backendOutputEntry.payload),
            });
        }
    }
}
exports.StackMetadataBackendOutputStorageStrategy = StackMetadataBackendOutputStorageStrategy;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhY2tfbWV0YWRhdGFfb3V0cHV0X3N0b3JhZ2Vfc3RyYXRlZ3kuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvc3RhY2tfbWV0YWRhdGFfb3V0cHV0X3N0b3JhZ2Vfc3RyYXRlZ3kudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBS0EsNkNBQXFEO0FBTXJEOztHQUVHO0FBQ0gsTUFBYSx5Q0FBeUM7SUFXdkI7SUFSckIsZ0JBQWdCLEdBQ3RCLElBQUksR0FBRyxFQUFFLENBQUM7SUFFWjs7OztPQUlHO0lBQ0gsWUFBNkIsS0FBWTtRQUFaLFVBQUssR0FBTCxLQUFLLENBQU87SUFBRyxDQUFDO0lBRTdDOztPQUVHO0lBQ0gscUJBQXFCLEdBQUcsQ0FDdEIsT0FBZSxFQUNmLGtCQUFzQyxFQUNoQyxFQUFFO1FBQ1IsMkNBQTJDO1FBQzNDLE1BQU0sQ0FBQyxPQUFPLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLEVBQUUsRUFBRTtZQUNsRSxJQUFJLHVCQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQzVDLENBQUMsQ0FBQyxDQUFDO1FBRUgsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsUUFBUSxJQUFJLEVBQUUsQ0FBQztRQUMzRCxNQUFNLHFCQUFxQixHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUVoRCxJQUFJLENBQUMsbUJBQW1CLENBQ3RCLHFCQUFxQixFQUNyQixPQUFPLEVBQ1Asa0JBQWtCLENBQ25CLENBQUM7SUFDSixDQUFDLENBQUM7SUFFRjs7T0FFRztJQUNILHlCQUF5QixHQUFHLENBQzFCLE9BQWUsRUFDZixrQkFBbUQsRUFDN0MsRUFBRTtRQUNSLE1BQU0sT0FBTyxHQUFHLGtCQUFrQixDQUFDLE9BQU8sQ0FBQztRQUMzQyxJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRWxELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsZUFBZSxDQUFDLFFBQVEsSUFBSSxFQUFFLENBQUM7UUFDM0QsTUFBTSxxQkFBcUIsR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFaEQsSUFBSSxxQkFBcUIsRUFBRTtZQUN6QixJQUFJLHFCQUFxQixDQUFDLE9BQU8sS0FBSyxPQUFPLEVBQUU7Z0JBQzdDLE1BQU0sSUFBSSxLQUFLLENBQ2Isc0JBQXNCLE9BQU8sZUFBZSxxQkFBcUIsQ0FBQyxPQUFPLHlFQUF5RSxPQUFPLEdBQUcsQ0FDN0osQ0FBQzthQUNIO1NBQ0Y7UUFFRCxJQUFJLENBQUMsbUJBQW1CLENBQ3RCLHFCQUFxQixFQUNyQixPQUFPLEVBQ1Asa0JBQXdDLENBQ3pDLENBQUM7UUFFRixNQUFNLENBQUMsT0FBTyxDQUFDLGtCQUFrQixDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQ3RELENBQUMsQ0FBQyxRQUFRLEVBQUUsS0FBSyxDQUFDLEVBQUUsRUFBRTtZQUNwQixJQUFJLENBQUMsS0FBSyxFQUFFO2dCQUNWLE9BQU87YUFDUjtZQUNELElBQUksQ0FBQyxRQUFRLEVBQUU7Z0JBQ2IsUUFBUSxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7Z0JBQ3JCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDO2FBQzlDO1lBQ0QsSUFBSSxVQUFVLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUV4QyxJQUFJLFVBQVUsRUFBRTtnQkFDZCxVQUFVLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQ3hCO2lCQUFNO2dCQUNMLFVBQVUsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNyQixRQUFRLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxVQUFVLENBQUMsQ0FBQztnQkFFbkMsSUFBSSx1QkFBUyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsUUFBUSxFQUFFO29CQUNsQyxLQUFLLEVBQUUsa0JBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDO2lCQUNsRSxDQUFDLENBQUM7YUFDSjtRQUNILENBQUMsQ0FDRixDQUFDO0lBQ0osQ0FBQyxDQUFDO0lBRUY7Ozs7O09BS0c7SUFDSyxtQkFBbUIsQ0FDekIscUJBRWEsRUFDYixPQUFlLEVBQ2Ysa0JBQXNDO1FBRXRDLElBQUkscUJBQXFCLEVBQUU7WUFDekIsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFO2dCQUM5QixPQUFPLEVBQUUsa0JBQWtCLENBQUMsT0FBTztnQkFDbkMsWUFBWSxFQUFFO29CQUNaLEdBQUcsSUFBSSxHQUFHLENBQUM7d0JBQ1QsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE9BQU8sQ0FBQzt3QkFDMUMsR0FBRyxxQkFBcUIsQ0FBQyxZQUFZO3FCQUN0QyxDQUFDO2lCQUNIO2FBQ0YsQ0FBQyxDQUFDO1NBQ0o7YUFBTTtZQUNMLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRTtnQkFDOUIsT0FBTyxFQUFFLGtCQUFrQixDQUFDLE9BQU87Z0JBQ25DLFlBQVksRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE9BQU8sQ0FBQzthQUN0RCxDQUFDLENBQUM7U0FDSjtJQUNILENBQUM7Q0FDRjtBQXJIRCw4RkFxSEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBCYWNrZW5kT3V0cHV0RW50cnksXG4gIEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3ksXG4gIERlZXBQYXJ0aWFsLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7IENmbk91dHB1dCwgTGF6eSwgU3RhY2sgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5cbi8vIEFsaWFzZWQgc3RyaW5ncyBmb3IgcmVhZGFiaWxpdHlcbnR5cGUgTWV0YWRhdGFLZXkgPSBzdHJpbmc7XG50eXBlIE91dHB1dEtleSA9IHN0cmluZztcblxuLyoqXG4gKiBJbXBsZW1lbnRhdGlvbiBvZiBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5IHRoYXQgc3RvcmVzIGNvbmZpZyBkYXRhIGluIHN0YWNrIG1ldGFkYXRhIGFuZCBvdXRwdXRzXG4gKi9cbmV4cG9ydCBjbGFzcyBTdGFja01ldGFkYXRhQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneVxuICBpbXBsZW1lbnRzIEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3k8QmFja2VuZE91dHB1dEVudHJ5Plxue1xuICBwcml2YXRlIGxhenlMaXN0VmFsdWVNYXA6IE1hcDxNZXRhZGF0YUtleSwgTWFwPE91dHB1dEtleSwgc3RyaW5nW10+PiA9XG4gICAgbmV3IE1hcCgpO1xuXG4gIC8qKlxuICAgKiBJbml0aWFsaXplIHRoZSBpbnN0YW5jZSB3aXRoIGEgc3RhY2suXG4gICAqXG4gICAqIElmIHRoZSBzdGFjayBpcyBhbiBBbXBsaWZ5U3RhY2ssIHNldCBhIHBhcmFtZXRlciBpbiBTU00gc28gdGhlIHN0YWNrIGNhbiBiZSBpZGVudGlmaWVkIGxhdGVyIGJ5IHRoZSBwcm9qZWN0IGVudmlyb25tZW50XG4gICAqL1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHN0YWNrOiBTdGFjaykge31cblxuICAvKipcbiAgICogU3RvcmUgY29uc3RydWN0IG91dHB1dCBhcyBzdGFjayBvdXRwdXQgYW5kIGFkZCBtZXRhZGF0YSB0byB0aGUgbWV0YWRhdGEgb2JqZWN0LlxuICAgKi9cbiAgYWRkQmFja2VuZE91dHB1dEVudHJ5ID0gKFxuICAgIGtleU5hbWU6IHN0cmluZyxcbiAgICBiYWNrZW5kT3V0cHV0RW50cnk6IEJhY2tlbmRPdXRwdXRFbnRyeSxcbiAgKTogdm9pZCA9PiB7XG4gICAgLy8gYWRkIGFsbCB0aGUgZGF0YSB2YWx1ZXMgYXMgc3RhY2sgb3V0cHV0c1xuICAgIE9iamVjdC5lbnRyaWVzKGJhY2tlbmRPdXRwdXRFbnRyeS5wYXlsb2FkKS5mb3JFYWNoKChba2V5LCB2YWx1ZV0pID0+IHtcbiAgICAgIG5ldyBDZm5PdXRwdXQodGhpcy5zdGFjaywga2V5LCB7IHZhbHVlIH0pO1xuICAgIH0pO1xuXG4gICAgY29uc3QgbWV0YWRhdGEgPSB0aGlzLnN0YWNrLnRlbXBsYXRlT3B0aW9ucy5tZXRhZGF0YSB8fCB7fTtcbiAgICBjb25zdCBleGlzdGluZ01ldGFkYXRhRW50cnkgPSBtZXRhZGF0YVtrZXlOYW1lXTtcblxuICAgIHRoaXMuYWRkT3JVcGRhdGVNZXRhZGF0YShcbiAgICAgIGV4aXN0aW5nTWV0YWRhdGFFbnRyeSxcbiAgICAgIGtleU5hbWUsXG4gICAgICBiYWNrZW5kT3V0cHV0RW50cnksXG4gICAgKTtcbiAgfTtcblxuICAvKipcbiAgICogTGF6aWx5IGNvbnN0cnVjdCBhbmQgYXBwZW5kIHRvIG91dHB1dCBsaXN0IGFzIHN0YWNrIG91dHB1dCBhbmQgYWRkIG1ldGFkYXRhIHRvIHRoZSBtZXRhZGF0YSBvYmplY3QuXG4gICAqL1xuICBhcHBlbmRUb0JhY2tlbmRPdXRwdXRMaXN0ID0gKFxuICAgIGtleU5hbWU6IHN0cmluZyxcbiAgICBiYWNrZW5kT3V0cHV0RW50cnk6IERlZXBQYXJ0aWFsPEJhY2tlbmRPdXRwdXRFbnRyeT4sXG4gICk6IHZvaWQgPT4ge1xuICAgIGNvbnN0IHZlcnNpb24gPSBiYWNrZW5kT3V0cHV0RW50cnkudmVyc2lvbjtcbiAgICBsZXQgbGlzdHNNYXAgPSB0aGlzLmxhenlMaXN0VmFsdWVNYXAuZ2V0KGtleU5hbWUpO1xuXG4gICAgY29uc3QgbWV0YWRhdGEgPSB0aGlzLnN0YWNrLnRlbXBsYXRlT3B0aW9ucy5tZXRhZGF0YSB8fCB7fTtcbiAgICBjb25zdCBleGlzdGluZ01ldGFkYXRhRW50cnkgPSBtZXRhZGF0YVtrZXlOYW1lXTtcblxuICAgIGlmIChleGlzdGluZ01ldGFkYXRhRW50cnkpIHtcbiAgICAgIGlmIChleGlzdGluZ01ldGFkYXRhRW50cnkudmVyc2lvbiAhPT0gdmVyc2lvbikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYE1ldGFkYXRhIGVudHJ5IGZvciAke2tleU5hbWV9IGF0IHZlcnNpb24gJHtleGlzdGluZ01ldGFkYXRhRW50cnkudmVyc2lvbn0gYWxyZWFkeSBleGlzdHMuIENhbm5vdCBhZGQgYW5vdGhlciBlbnRyeSBmb3IgdGhlIHNhbWUga2V5IGF0IHZlcnNpb24gJHt2ZXJzaW9ufS5gLFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMuYWRkT3JVcGRhdGVNZXRhZGF0YShcbiAgICAgIGV4aXN0aW5nTWV0YWRhdGFFbnRyeSxcbiAgICAgIGtleU5hbWUsXG4gICAgICBiYWNrZW5kT3V0cHV0RW50cnkgYXMgQmFja2VuZE91dHB1dEVudHJ5LFxuICAgICk7XG5cbiAgICBPYmplY3QuZW50cmllcyhiYWNrZW5kT3V0cHV0RW50cnkucGF5bG9hZCA/PyBbXSkuZm9yRWFjaChcbiAgICAgIChbbGlzdE5hbWUsIHZhbHVlXSkgPT4ge1xuICAgICAgICBpZiAoIXZhbHVlKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmICghbGlzdHNNYXApIHtcbiAgICAgICAgICBsaXN0c01hcCA9IG5ldyBNYXAoKTtcbiAgICAgICAgICB0aGlzLmxhenlMaXN0VmFsdWVNYXAuc2V0KGtleU5hbWUsIGxpc3RzTWFwKTtcbiAgICAgICAgfVxuICAgICAgICBsZXQgb3V0cHV0TGlzdCA9IGxpc3RzTWFwLmdldChsaXN0TmFtZSk7XG5cbiAgICAgICAgaWYgKG91dHB1dExpc3QpIHtcbiAgICAgICAgICBvdXRwdXRMaXN0LnB1c2godmFsdWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG91dHB1dExpc3QgPSBbdmFsdWVdO1xuICAgICAgICAgIGxpc3RzTWFwLnNldChsaXN0TmFtZSwgb3V0cHV0TGlzdCk7XG5cbiAgICAgICAgICBuZXcgQ2ZuT3V0cHV0KHRoaXMuc3RhY2ssIGxpc3ROYW1lLCB7XG4gICAgICAgICAgICB2YWx1ZTogTGF6eS5zdHJpbmcoeyBwcm9kdWNlOiAoKSA9PiBKU09OLnN0cmluZ2lmeShvdXRwdXRMaXN0KSB9KSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICApO1xuICB9O1xuXG4gIC8qKlxuICAgKiBBZGQgb3IgdXBkYXRlIG1ldGFkYXRhIGVudHJ5LlxuICAgKiBAcGFyYW0gZXhpc3RpbmdNZXRhZGF0YUVudHJ5IC0gVGhlIGV4aXN0aW5nIG1ldGFkYXRhIGVudHJ5LlxuICAgKiBAcGFyYW0ga2V5TmFtZSAtIFRoZSBrZXkgbmFtZS5cbiAgICogQHBhcmFtIGJhY2tlbmRPdXRwdXRFbnRyeSAtIFRoZSBiYWNrZW5kIG91dHB1dCBlbnRyeS5cbiAgICovXG4gIHByaXZhdGUgYWRkT3JVcGRhdGVNZXRhZGF0YShcbiAgICBleGlzdGluZ01ldGFkYXRhRW50cnk6XG4gICAgICB8IHsgdmVyc2lvbjogc3RyaW5nOyBzdGFja091dHB1dHM6IHN0cmluZ1tdIH1cbiAgICAgIHwgdW5kZWZpbmVkLFxuICAgIGtleU5hbWU6IHN0cmluZyxcbiAgICBiYWNrZW5kT3V0cHV0RW50cnk6IEJhY2tlbmRPdXRwdXRFbnRyeSxcbiAgKSB7XG4gICAgaWYgKGV4aXN0aW5nTWV0YWRhdGFFbnRyeSkge1xuICAgICAgdGhpcy5zdGFjay5hZGRNZXRhZGF0YShrZXlOYW1lLCB7XG4gICAgICAgIHZlcnNpb246IGJhY2tlbmRPdXRwdXRFbnRyeS52ZXJzaW9uLFxuICAgICAgICBzdGFja091dHB1dHM6IFtcbiAgICAgICAgICAuLi5uZXcgU2V0KFtcbiAgICAgICAgICAgIC4uLk9iamVjdC5rZXlzKGJhY2tlbmRPdXRwdXRFbnRyeS5wYXlsb2FkKSxcbiAgICAgICAgICAgIC4uLmV4aXN0aW5nTWV0YWRhdGFFbnRyeS5zdGFja091dHB1dHMsXG4gICAgICAgICAgXSksXG4gICAgICAgIF0sXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zdGFjay5hZGRNZXRhZGF0YShrZXlOYW1lLCB7XG4gICAgICAgIHZlcnNpb246IGJhY2tlbmRPdXRwdXRFbnRyeS52ZXJzaW9uLFxuICAgICAgICBzdGFja091dHB1dHM6IE9iamVjdC5rZXlzKGJhY2tlbmRPdXRwdXRFbnRyeS5wYXlsb2FkKSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxufVxuIl19