import { format } from '../../format/format.js';
import { EOL } from 'os';
/**
 * Collects events from CDK Toolkit about cfn deployment and structures them
 * nicely for printing.
 *
 * It will continuously re-update the cfn deployment progress and show only the resources
 * that are currently being updated, in addition to a progress bar which
 * shows how far along the deployment is.
 *
 * Resources that have failed will always be shown, resources that failed deployment because
 * they have been canceled are not included.
 */
export class CfnDeploymentProgressLogger {
    // Keeps a cache/mapping of LogicalResourceId <-> Friendly resource name along with hierarchy
    // Friendly name is formatted as a path e.g. NestedStackName/LambdaFunction/ServiceRole
    resourceNameCache;
    /**
     * A list of resource IDs which are currently being processed
     */
    resourcesInProgress = {};
    /**
     * Previous completion state observed by logical ID
     *
     * We use this to detect that if we see a DELETE_COMPLETE after a
     * CREATE_COMPLETE, it's actually a rollback and we should DECREASE
     * resourcesDone instead of increase it
     */
    resourcesPrevCompleteState = {};
    /**
     * Count of resources that have reported a _COMPLETE status
     */
    resourcesDone = 0;
    /**
     * Total number of resources (inclusive of all nested stacks and their resources)
     */
    resourcesTotal;
    rollingBack = false;
    failures = new Array();
    // Display formatting related properties
    block;
    rootStackDisplay = 'root stack';
    timeStampWidth = 12;
    resourceTypeColumnWidth = 25;
    statusWidth = 20;
    resourceNameIndentation = 0;
    getBlockWidth;
    /**
     * Instantiate the CFN deployment progress builder
     */
    constructor(props) {
        // +1 because the stack also emits a "COMPLETE" event at the end, and that wasn't
        // counted yet. This makes it line up with the amount of events we expect.
        this.resourcesTotal = props.resourcesTotal
            ? props.resourcesTotal + 1
            : undefined;
        this.getBlockWidth = props.getBlockWidth;
        this.block = props.rewritableBlock;
        this.resourceNameCache = {};
    }
    /**
     * Add a new CDK event corresponding to CFN deployment progress
     */
    addActivity(cfnEvent) {
        const metadata = cfnEvent.metadata;
        const event = cfnEvent.event;
        const status = event.ResourceStatus;
        // CDK Metadata resources are not relevant
        if (!status ||
            !event.LogicalResourceId ||
            event.LogicalResourceId === 'CDKMetadata') {
            return;
        }
        // Hydrate friendly name resource cache
        if (event.ResourceType === 'AWS::CloudFormation::Stack') {
            const nestedStackName = this.getFriendlyNameFromNestedStackName(event.LogicalResourceId);
            if (nestedStackName) {
                this.resourceNameCache[event.LogicalResourceId] = nestedStackName;
            }
        }
        if (metadata && metadata.constructPath) {
            if (!(event.LogicalResourceId in this.resourceNameCache)) {
                this.resourceNameCache[event.LogicalResourceId] =
                    this.normalizeCDKConstructPath(metadata.constructPath);
            }
        }
        // Hydrate friendly name resource cache
        if (status === 'ROLLBACK_IN_PROGRESS' ||
            status === 'UPDATE_ROLLBACK_IN_PROGRESS') {
            // Only triggered on the stack once we've started doing a rollback
            this.rollingBack = true;
        }
        if (status.endsWith('_IN_PROGRESS')) {
            this.resourcesInProgress[event.LogicalResourceId] = event;
        }
        if (this.isFailureStatus(event)) {
            const isCanceled = 
            // eslint-disable-next-line spellcheck/spell-checker
            (event.ResourceStatusReason ?? '').indexOf('cancelled') > -1;
            // Canceled is not an interesting failure reason
            if (!isCanceled) {
                this.failures.push(event);
            }
        }
        if (status.endsWith('_COMPLETE') || status.endsWith('_FAILED')) {
            delete this.resourcesInProgress[event.LogicalResourceId];
        }
        if (status.endsWith('_COMPLETE_CLEANUP_IN_PROGRESS')) {
            this.resourcesDone++;
        }
        if (status.endsWith('_COMPLETE')) {
            const prevState = this.resourcesPrevCompleteState[event.LogicalResourceId];
            if (!prevState) {
                this.resourcesDone++;
            }
            else {
                // If we completed this before and we're completing it AGAIN, means we're rolling back.
                // Protect against silly underflow.
                this.resourcesDone--;
                if (this.resourcesDone < 0) {
                    this.resourcesDone = 0;
                }
            }
            this.resourcesPrevCompleteState[event.LogicalResourceId] = status;
        }
    }
    /**
     * Formats the current progress accumulated and pass it to a rewritable block for display
     */
    async print() {
        // Used for creating resource hierarchies
        this.resourceNameIndentation = 0;
        const lines = [];
        // Add a progress bar at the top if available
        const progress = this.progressBar();
        if (progress) {
            lines.push('  ' + progress, '');
        }
        // Normally we'd only print "resources in progress", but it's also useful
        // to keep an eye on the failures and know about the specific errors as quickly
        // as possible (while the stack is still rolling back), so add those in.
        const toPrint = [
            ...this.failures,
            ...Object.values(this.resourcesInProgress),
        ];
        toPrint.sort((a, b) => {
            if (a.LogicalResourceId &&
                a.LogicalResourceId in this.resourceNameCache &&
                b.LogicalResourceId &&
                b.LogicalResourceId in this.resourceNameCache) {
                // Always display the root stack first
                if (this.resourceNameCache[b.LogicalResourceId].startsWith(this.rootStackDisplay) &&
                    !this.resourceNameCache[a.LogicalResourceId].startsWith(this.rootStackDisplay)) {
                    return 1;
                }
                if (this.resourceNameCache[a.LogicalResourceId].startsWith(this.rootStackDisplay) &&
                    !this.resourceNameCache[b.LogicalResourceId].startsWith(this.rootStackDisplay)) {
                    return -1;
                }
                // Rest order them lexicographical so that we "group" all child resources together
                return this.resourceNameCache[a.LogicalResourceId].localeCompare(this.resourceNameCache[b.LogicalResourceId]);
            }
            // If we don't have friendly names, just order them based on the time
            return a.Timestamp.getTime() - b.Timestamp.getTime();
        });
        lines.push(...toPrint
            .filter(
        // If we don't have LogicalResourceId we don't have anything
        (res) => res.LogicalResourceId)
            .map((res) => {
            const color = this.colorFromStatusActivity(res.ResourceStatus);
            return this.getFormattedLine(res, color);
        }));
        await this.block.displayLines(lines);
    }
    /**
     * Extract nested stack names
     */
    normalizeCDKConstructPath = (constructPath) => {
        // Don't run regex on long strings, they are most likely not valid and could cause DOS attach. See CodeQL's js/polynomial-redos
        if (constructPath.length > 1000)
            return constructPath;
        const nestedStackRegex = /(?<nestedStack>[a-zA-Z0-9_]+)\.NestedStack\/\1\.NestedStackResource$/;
        return constructPath
            .replace(nestedStackRegex, '$<nestedStack>')
            .replace('/amplifyAuth/', '/')
            .replace('/amplifyData/', '/');
    };
    /**
     * Extract the failure reason from stack events
     */
    failureReason = (event) => {
        return event.ResourceStatusReason ?? '';
    };
    /**
     * If we have total number of resources, format the progress bar and return
     */
    progressBar = () => {
        const FULL_BLOCK = '█';
        const PARTIAL_BLOCK = ['', '▏', '▎', '▍', '▌', '▋', '▊', '▉'];
        const MAX_PROGRESSBAR_WIDTH = 500;
        const MIN_PROGRESSBAR_WIDTH = 10;
        const PROGRESSBAR_EXTRA_SPACE = 2 /* leading spaces */ +
            2 /* brackets */ +
            4 /* progress number decoration */ +
            6; /* 2 progress numbers up to 999 */
        const width = Math.max(Math.min(this.getBlockWidth() - PROGRESSBAR_EXTRA_SPACE - 1, MAX_PROGRESSBAR_WIDTH), MIN_PROGRESSBAR_WIDTH);
        if (!this.resourcesTotal) {
            return '';
        }
        const fraction = Math.min(this.resourcesDone / this.resourcesTotal, 1);
        const innerWidth = Math.max(1, width - 2);
        const chars = innerWidth * fraction;
        const remainder = chars - Math.floor(chars);
        const fullChars = FULL_BLOCK.repeat(Math.floor(chars));
        const partialChar = PARTIAL_BLOCK[Math.floor(remainder * PARTIAL_BLOCK.length)];
        const filler = '·'.repeat(innerWidth - Math.floor(chars) - (partialChar ? 1 : 0));
        const color = this.rollingBack ? 'Yellow' : 'Green';
        return ('[' +
            format.color(fullChars + partialChar, color) +
            filler +
            `] (${this.resourcesDone}/${this.resourcesTotal})`);
    };
    /**
     * Format the failure reason to be on the next line
     */
    failureReasonOnNextLine = (event) => {
        return this.isFailureStatus(event)
            ? `${EOL}${' '.repeat(this.timeStampWidth + this.statusWidth + 6)}${format.color(this.failureReason(event) ?? '', 'Red')}`
            : '';
    };
    isFailureStatus = (event) => {
        if ((event.ResourceStatusReason?.includes('The following resource(s) failed') ||
            event.ResourceStatusReason === 'Initiated by parent stack') &&
            event.ResourceType === 'AWS::CloudFormation::Stack') {
            // Useless nested stack failure messages
            return false;
        }
        return ((event.ResourceStatus && event.ResourceStatus.endsWith('_FAILED')) ||
            event.ResourceStatus === 'ROLLBACK_IN_PROGRESS' ||
            event.ResourceStatus === 'UPDATE_ROLLBACK_IN_PROGRESS');
    };
    getFormattedLine = (event, color) => {
        const timeStamp = this.padLeft(this.timeStampWidth, new Date(event.Timestamp).toLocaleTimeString());
        const status = color
            ? format.color(this.padRight(this.statusWidth, (event.ResourceStatus || '').slice(0, this.statusWidth)), color)
            : this.padRight(this.statusWidth, (event.ResourceStatus || '').slice(0, this.statusWidth));
        const resourceType = this.padRight(this.resourceTypeColumnWidth, this.shorten(this.resourceTypeColumnWidth, event.ResourceType?.split('::').slice(1).join(':') || ''));
        const formattedResourceName = this.getFormattedResourceDisplayName(event.LogicalResourceId);
        const resourceNameToDisplay = color
            ? format.color(format.bold(this.shorten(100, formattedResourceName)), color)
            : format.bold(this.shorten(100, formattedResourceName));
        return `${format.dim(timeStamp)} | ${status} | ${resourceType} | ${resourceNameToDisplay}${this.failureReasonOnNextLine(event)}`;
    };
    getFormattedResourceDisplayName = (logicalResourceId) => {
        const constructPath = this.resourceNameCache[logicalResourceId] ?? logicalResourceId;
        let resourceNameDisplay = '';
        const paths = constructPath.split('/');
        const resourceName = paths.pop();
        if (resourceName === undefined || paths.length === 0) {
            // If there is no hierarchy we just display as-is with no padding and resets padding for next resource
            resourceNameDisplay = constructPath;
            this.resourceNameIndentation = 0;
        }
        else {
            // Figure out the padding based on the hierarchy of this resource but
            // make sure it's never more than 1 than the previous padding.
            this.resourceNameIndentation = Math.min(paths.length - 1, this.resourceNameIndentation);
            resourceNameDisplay =
                '  '.repeat(this.resourceNameIndentation++) + '∟ ' + resourceName;
        }
        return resourceNameDisplay;
    };
    /**
     * For a typical nested stack, CFN generate update events as follows
     *
     * When querying for Root Stack
     * RootStack events (*)
     * ∟ NestedStack events
     *
     * When querying for Nested Stack
     * NestedStack events (*)
     * ∟ Resource events
     *
     * For the * marked resources, cdk doesn't include metadata, so we don't have
     * a way to show friendly names. This method tries to identify these stacks
     * and make them show up in Root stack hierarchy
     */
    getFriendlyNameFromNestedStackName = (stackName) => {
        const parts = stackName.split('-');
        if (parts && parts.length === 7 && parts[3] === 'sandbox') {
            return this.rootStackDisplay + '/' + parts[5].slice(0, -8) + ' stack';
        }
        else if (parts && parts.length === 5) {
            if (parts[3] === 'sandbox') {
                return this.rootStackDisplay;
            }
        }
        return undefined;
    };
    colorFromStatusActivity = (status) => {
        if (!status) {
            return;
        }
        if (status.endsWith('_FAILED')) {
            return 'Red';
        }
        if (status.startsWith('CREATE_') ||
            status.startsWith('UPDATE_') ||
            status.startsWith('IMPORT_')) {
            return 'Green';
        }
        // For stacks, it may also be 'UPDDATE_ROLLBACK_IN_PROGRESS'
        if (status.indexOf('ROLLBACK_') !== -1) {
            return 'Yellow';
        }
        if (status.startsWith('DELETE_')) {
            return 'Yellow';
        }
        return;
    };
    shorten = (maxWidth, p) => {
        if (p.length <= maxWidth) {
            return p;
        }
        const half = Math.floor((maxWidth - 3) / 2);
        return p.slice(0, half) + '...' + p.slice(-half);
    };
    padRight = (n, x) => x + ' '.repeat(Math.max(0, n - x.length));
    padLeft = (n, x) => ' '.repeat(Math.max(0, n - x.length)) + x;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2ZuX2RlcGxveW1lbnRfcHJvZ3Jlc3NfbG9nZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2xvZ2dlcnMvY2ZuLWRlcGxveW1lbnQtcHJvZ3Jlc3MvY2ZuX2RlcGxveW1lbnRfcHJvZ3Jlc3NfbG9nZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUdBLE9BQU8sRUFBYSxNQUFNLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUMzRCxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBRXpCOzs7Ozs7Ozs7O0dBVUc7QUFDSCxNQUFNLE9BQU8sMkJBQTJCO0lBQ3RDLDZGQUE2RjtJQUM3Rix1RkFBdUY7SUFDL0UsaUJBQWlCLENBRXZCO0lBRUY7O09BRUc7SUFDSyxtQkFBbUIsR0FBK0IsRUFBRSxDQUFDO0lBRTdEOzs7Ozs7T0FNRztJQUNLLDBCQUEwQixHQUEyQixFQUFFLENBQUM7SUFFaEU7O09BRUc7SUFDSyxhQUFhLEdBQVcsQ0FBQyxDQUFDO0lBRWxDOztPQUVHO0lBQ2MsY0FBYyxDQUFVO0lBRWpDLFdBQVcsR0FBRyxLQUFLLENBQUM7SUFFWCxRQUFRLEdBQUcsSUFBSSxLQUFLLEVBQWMsQ0FBQztJQUVwRCx3Q0FBd0M7SUFDaEMsS0FBSyxDQUFDO0lBQ04sZ0JBQWdCLEdBQUcsWUFBWSxDQUFDO0lBQ2hDLGNBQWMsR0FBRyxFQUFFLENBQUM7SUFDcEIsdUJBQXVCLEdBQUcsRUFBRSxDQUFDO0lBQzdCLFdBQVcsR0FBRyxFQUFFLENBQUM7SUFDakIsdUJBQXVCLEdBQUcsQ0FBQyxDQUFDO0lBQ25CLGFBQWEsQ0FBZTtJQUU3Qzs7T0FFRztJQUNILFlBQVksS0FBbUI7UUFDN0IsaUZBQWlGO1FBQ2pGLDBFQUEwRTtRQUMxRSxJQUFJLENBQUMsY0FBYyxHQUFHLEtBQUssQ0FBQyxjQUFjO1lBQ3hDLENBQUMsQ0FBQyxLQUFLLENBQUMsY0FBYyxHQUFHLENBQUM7WUFDMUIsQ0FBQyxDQUFDLFNB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RyxDQUFDLENBQVMsRUFBRSxDQUFTLEVBQVUsRUFBRSxDQUNqRCxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7Q0FDN0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTdGFja0V2ZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWNsb3VkZm9ybWF0aW9uJztcblxuaW1wb3J0IHsgUmV3cml0YWJsZUJsb2NrIH0gZnJvbSAnLi9yZXdyaXRhYmxlX2Jsb2NrLmpzJztcbmltcG9ydCB7IENvbG9yTmFtZSwgZm9ybWF0IH0gZnJvbSAnLi4vLi4vZm9ybWF0L2Zvcm1hdC5qcyc7XG5pbXBvcnQgeyBFT0wgfSBmcm9tICdvcyc7XG5cbi8qKlxuICogQ29sbGVjdHMgZXZlbnRzIGZyb20gQ0RLIFRvb2xraXQgYWJvdXQgY2ZuIGRlcGxveW1lbnQgYW5kIHN0cnVjdHVyZXMgdGhlbVxuICogbmljZWx5IGZvciBwcmludGluZy5cbiAqXG4gKiBJdCB3aWxsIGNvbnRpbnVvdXNseSByZS11cGRhdGUgdGhlIGNmbiBkZXBsb3ltZW50IHByb2dyZXNzIGFuZCBzaG93IG9ubHkgdGhlIHJlc291cmNlc1xuICogdGhhdCBhcmUgY3VycmVudGx5IGJlaW5nIHVwZGF0ZWQsIGluIGFkZGl0aW9uIHRvIGEgcHJvZ3Jlc3MgYmFyIHdoaWNoXG4gKiBzaG93cyBob3cgZmFyIGFsb25nIHRoZSBkZXBsb3ltZW50IGlzLlxuICpcbiAqIFJlc291cmNlcyB0aGF0IGhhdmUgZmFpbGVkIHdpbGwgYWx3YXlzIGJlIHNob3duLCByZXNvdXJjZXMgdGhhdCBmYWlsZWQgZGVwbG95bWVudCBiZWNhdXNlXG4gKiB0aGV5IGhhdmUgYmVlbiBjYW5jZWxlZCBhcmUgbm90IGluY2x1ZGVkLlxuICovXG5leHBvcnQgY2xhc3MgQ2ZuRGVwbG95bWVudFByb2dyZXNzTG9nZ2VyIHtcbiAgLy8gS2VlcHMgYSBjYWNoZS9tYXBwaW5nIG9mIExvZ2ljYWxSZXNvdXJjZUlkIDwtPiBGcmllbmRseSByZXNvdXJjZSBuYW1lIGFsb25nIHdpdGggaGllcmFyY2h5XG4gIC8vIEZyaWVuZGx5IG5hbWUgaXMgZm9ybWF0dGVkIGFzIGEgcGF0aCBlLmcuIE5lc3RlZFN0YWNrTmFtZS9MYW1iZGFGdW5jdGlvbi9TZXJ2aWNlUm9sZVxuICBwcml2YXRlIHJlc291cmNlTmFtZUNhY2hlOiB7XG4gICAgW2xvZ2ljYWxJZDogc3RyaW5nXTogc3RyaW5nO1xuICB9O1xuXG4gIC8qKlxuICAgKiBBIGxpc3Qgb2YgcmVzb3VyY2UgSURzIHdoaWNoIGFyZSBjdXJyZW50bHkgYmVpbmcgcHJvY2Vzc2VkXG4gICAqL1xuICBwcml2YXRlIHJlc291cmNlc0luUHJvZ3Jlc3M6IFJlY29yZDxzdHJpbmcsIFN0YWNrRXZlbnQ+ID0ge307XG5cbiAgLyoqXG4gICAqIFByZXZpb3VzIGNvbXBsZXRpb24gc3RhdGUgb2JzZXJ2ZWQgYnkgbG9naWNhbCBJRFxuICAgKlxuICAgKiBXZSB1c2UgdGhpcyB0byBkZXRlY3QgdGhhdCBpZiB3ZSBzZWUgYSBERUxFVEVfQ09NUExFVEUgYWZ0ZXIgYVxuICAgKiBDUkVBVEVfQ09NUExFVEUsIGl0J3MgYWN0dWFsbHkgYSByb2xsYmFjayBhbmQgd2Ugc2hvdWxkIERFQ1JFQVNFXG4gICAqIHJlc291cmNlc0RvbmUgaW5zdGVhZCBvZiBpbmNyZWFzZSBpdFxuICAgKi9cbiAgcHJpdmF0ZSByZXNvdXJjZXNQcmV2Q29tcGxldGVTdGF0ZTogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9O1xuXG4gIC8qKlxuICAgKiBDb3VudCBvZiByZXNvdXJjZXMgdGhhdCBoYXZlIHJlcG9ydGVkIGEgX0NPTVBMRVRFIHN0YXR1c1xuICAgKi9cbiAgcHJpdmF0ZSByZXNvdXJjZXNEb25lOiBudW1iZXIgPSAwO1xuXG4gIC8qKlxuICAgKiBUb3RhbCBudW1iZXIgb2YgcmVzb3VyY2VzIChpbmNsdXNpdmUgb2YgYWxsIG5lc3RlZCBzdGFja3MgYW5kIHRoZWlyIHJlc291cmNlcylcbiAgICovXG4gIHByaXZhdGUgcmVhZG9ubHkgcmVzb3VyY2VzVG90YWw/OiBudW1iZXI7XG5cbiAgcHJpdmF0ZSByb2xsaW5nQmFjayA9IGZhbHNlO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgZmFpbHVyZXMgPSBuZXcgQXJyYXk8U3RhY2tFdmVudD4oKTtcblxuICAvLyBEaXNwbGF5IGZvcm1hdHRpbmcgcmVsYXRlZCBwcm9wZXJ0aWVzXG4gIHByaXZhdGUgYmxvY2s7XG4gIHByaXZhdGUgcm9vdFN0YWNrRGlzcGxheSA9ICdyb290IHN0YWNrJztcbiAgcHJpdmF0ZSB0aW1lU3RhbXBXaWR0aCA9IDEyO1xuICBwcml2YXRlIHJlc291cmNlVHlwZUNvbHVtbldpZHRoID0gMjU7XG4gIHByaXZhdGUgc3RhdHVzV2lkdGggPSAyMDtcbiAgcHJpdmF0ZSByZXNvdXJjZU5hbWVJbmRlbnRhdGlvbiA9IDA7XG4gIHByaXZhdGUgcmVhZG9ubHkgZ2V0QmxvY2tXaWR0aDogKCkgPT4gbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBJbnN0YW50aWF0ZSB0aGUgQ0ZOIGRlcGxveW1lbnQgcHJvZ3Jlc3MgYnVpbGRlclxuICAgKi9cbiAgY29uc3RydWN0b3IocHJvcHM6IFByaW50ZXJQcm9wcykge1xuICAgIC8vICsxIGJlY2F1c2UgdGhlIHN0YWNrIGFsc28gZW1pdHMgYSBcIkNPTVBMRVRFXCIgZXZlbnQgYXQgdGhlIGVuZCwgYW5kIHRoYXQgd2Fzbid0XG4gICAgLy8gY291bnRlZCB5ZXQuIFRoaXMgbWFrZXMgaXQgbGluZSB1cCB3aXRoIHRoZSBhbW91bnQgb2YgZXZlbnRzIHdlIGV4cGVjdC5cbiAgICB0aGlzLnJlc291cmNlc1RvdGFsID0gcHJvcHMucmVzb3VyY2VzVG90YWxcbiAgICAgID8gcHJvcHMucmVzb3VyY2VzVG90YWwgKyAxXG4gICAgICA6IHVuZGVmaW5lZDtcblxuICAgIHRoaXMuZ2V0QmxvY2tXaWR0aCA9IHByb3BzLmdldEJsb2NrV2lkdGg7XG4gICAgdGhpcy5ibG9jayA9IHByb3BzLnJld3JpdGFibGVCbG9jaztcbiAgICB0aGlzLnJlc291cmNlTmFtZUNhY2hlID0ge307XG4gIH1cblxuICAvKipcbiAgICogQWRkIGEgbmV3IENESyBldmVudCBjb3JyZXNwb25kaW5nIHRvIENGTiBkZXBsb3ltZW50IHByb2dyZXNzXG4gICAqL1xuICBwdWJsaWMgYWRkQWN0aXZpdHkoY2ZuRXZlbnQ6IENmbkRlcGxveW1lbnRTdGFja0V2ZW50KSB7XG4gICAgY29uc3QgbWV0YWRhdGEgPSBjZm5FdmVudC5tZXRhZGF0YTtcbiAgICBjb25zdCBldmVudCA9IGNmbkV2ZW50LmV2ZW50O1xuICAgIGNvbnN0IHN0YXR1cyA9IGV2ZW50LlJlc291cmNlU3RhdHVzO1xuXG4gICAgLy8gQ0RLIE1ldGFkYXRhIHJlc291cmNlcyBhcmUgbm90IHJlbGV2YW50XG4gICAgaWYgKFxuICAgICAgIXN0YXR1cyB8fFxuICAgICAgIWV2ZW50LkxvZ2ljYWxSZXNvdXJjZUlkIHx8XG4gICAgICBldmVudC5Mb2dpY2FsUmVzb3VyY2VJZCA9PT0gJ0NES01ldGFkYXRhJ1xuICAgICkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIEh5ZHJhdGUgZnJpZW5kbHkgbmFtZSByZXNvdXJjZSBjYWNoZVxuICAgIGlmIChldmVudC5SZXNvdXJjZVR5cGUgPT09ICdBV1M6OkNsb3VkRm9ybWF0aW9uOjpTdGFjaycpIHtcbiAgICAgIGNvbnN0IG5lc3RlZFN0YWNrTmFtZSA9IHRoaXMuZ2V0RnJpZW5kbHlOYW1lRnJvbU5lc3RlZFN0YWNrTmFtZShcbiAgICAgICAgZXZlbnQuTG9naWNhbFJlc291cmNlSWQsXG4gICAgICApO1xuICAgICAgaWYgKG5lc3RlZFN0YWNrTmFtZSkge1xuICAgICAgICB0aGlzLnJlc291cmNlTmFtZUNhY2hlW2V2ZW50LkxvZ2ljYWxSZXNvdXJjZUlkXSA9IG5lc3RlZFN0YWNrTmFtZTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKG1ldGFkYXRhICYmIG1ldGFkYXRhLmNvbnN0cnVjdFBhdGgpIHtcbiAgICAgIGlmICghKGV2ZW50LkxvZ2ljYWxSZXNvdXJjZUlkIGluIHRoaXMucmVzb3VyY2VOYW1lQ2FjaGUpKSB7XG4gICAgICAgIHRoaXMucmVzb3VyY2VOYW1lQ2FjaGVbZXZlbnQuTG9naWNhbFJlc291cmNlSWRdID1cbiAgICAgICAgICB0aGlzLm5vcm1hbGl6ZUNES0NvbnN0cnVjdFBhdGgobWV0YWRhdGEuY29uc3RydWN0UGF0aCk7XG4gICAgICB9XG4gICAgfVxuICAgIC8vIEh5ZHJhdGUgZnJpZW5kbHkgbmFtZSByZXNvdXJjZSBjYWNoZVxuXG4gICAgaWYgKFxuICAgICAgc3RhdHVzID09PSAnUk9MTEJBQ0tfSU5fUFJPR1JFU1MnIHx8XG4gICAgICBzdGF0dXMgPT09ICdVUERBVEVfUk9MTEJBQ0tfSU5fUFJPR1JFU1MnXG4gICAgKSB7XG4gICAgICAvLyBPbmx5IHRyaWdnZXJlZCBvbiB0aGUgc3RhY2sgb25jZSB3ZSd2ZSBzdGFydGVkIGRvaW5nIGEgcm9sbGJhY2tcbiAgICAgIHRoaXMucm9sbGluZ0JhY2sgPSB0cnVlO1xuICAgIH1cblxuICAgIGlmIChzdGF0dXMuZW5kc1dpdGgoJ19JTl9QUk9HUkVTUycpKSB7XG4gICAgICB0aGlzLnJlc291cmNlc0luUHJvZ3Jlc3NbZXZlbnQuTG9naWNhbFJlc291cmNlSWRdID0gZXZlbnQ7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuaXNGYWlsdXJlU3RhdHVzKGV2ZW50KSkge1xuICAgICAgY29uc3QgaXNDYW5jZWxlZCA9XG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBzcGVsbGNoZWNrL3NwZWxsLWNoZWNrZXJcbiAgICAgICAgKGV2ZW50LlJlc291cmNlU3RhdHVzUmVhc29uID8/ICcnKS5pbmRleE9mKCdjYW5jZWxsZWQnKSA+IC0xO1xuXG4gICAgICAvLyBDYW5jZWxlZCBpcyBub3QgYW4gaW50ZXJlc3RpbmcgZmFpbHVyZSByZWFzb25cbiAgICAgIGlmICghaXNDYW5jZWxlZCkge1xuICAgICAgICB0aGlzLmZhaWx1cmVzLnB1c2goZXZlbnQpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChzdGF0dXMuZW5kc1dpdGgoJ19DT01QTEVURScpIHx8IHN0YXR1cy5lbmRzV2l0aCgnX0ZBSUxFRCcpKSB7XG4gICAgICBkZWxldGUgdGhpcy5yZXNvdXJjZXNJblByb2dyZXNzW2V2ZW50LkxvZ2ljYWxSZXNvdXJjZUlkXTtcbiAgICB9XG5cbiAgICBpZiAoc3RhdHVzLmVuZHNXaXRoKCdfQ09NUExFVEVfQ0xFQU5VUF9JTl9QUk9HUkVTUycpKSB7XG4gICAgICB0aGlzLnJlc291cmNlc0RvbmUrKztcbiAgICB9XG5cbiAgICBpZiAoc3RhdHVzLmVuZHNXaXRoKCdfQ09NUExFVEUnKSkge1xuICAgICAgY29uc3QgcHJldlN0YXRlID1cbiAgICAgICAgdGhpcy5yZXNvdXJjZXNQcmV2Q29tcGxldGVTdGF0ZVtldmVudC5Mb2dpY2FsUmVzb3VyY2VJZF07XG4gICAgICBpZiAoIXByZXZTdGF0ZSkge1xuICAgICAgICB0aGlzLnJlc291cmNlc0RvbmUrKztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIElmIHdlIGNvbXBsZXRlZCB0aGlzIGJlZm9yZSBhbmQgd2UncmUgY29tcGxldGluZyBpdCBBR0FJTiwgbWVhbnMgd2UncmUgcm9sbGluZyBiYWNrLlxuICAgICAgICAvLyBQcm90ZWN0IGFnYWluc3Qgc2lsbHkgdW5kZXJmbG93LlxuICAgICAgICB0aGlzLnJlc291cmNlc0RvbmUtLTtcbiAgICAgICAgaWYgKHRoaXMucmVzb3VyY2VzRG9uZSA8IDApIHtcbiAgICAgICAgICB0aGlzLnJlc291cmNlc0RvbmUgPSAwO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0aGlzLnJlc291cmNlc1ByZXZDb21wbGV0ZVN0YXRlW2V2ZW50LkxvZ2ljYWxSZXNvdXJjZUlkXSA9IHN0YXR1cztcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRm9ybWF0cyB0aGUgY3VycmVudCBwcm9ncmVzcyBhY2N1bXVsYXRlZCBhbmQgcGFzcyBpdCB0byBhIHJld3JpdGFibGUgYmxvY2sgZm9yIGRpc3BsYXlcbiAgICovXG4gIHB1YmxpYyBhc3luYyBwcmludCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvLyBVc2VkIGZvciBjcmVhdGluZyByZXNvdXJjZSBoaWVyYXJjaGllc1xuICAgIHRoaXMucmVzb3VyY2VOYW1lSW5kZW50YXRpb24gPSAwO1xuXG4gICAgY29uc3QgbGluZXMgPSBbXTtcblxuICAgIC8vIEFkZCBhIHByb2dyZXNzIGJhciBhdCB0aGUgdG9wIGlmIGF2YWlsYWJsZVxuICAgIGNvbnN0IHByb2dyZXNzID0gdGhpcy5wcm9ncmVzc0JhcigpO1xuICAgIGlmIChwcm9ncmVzcykge1xuICAgICAgbGluZXMucHVzaCgnICAnICsgcHJvZ3Jlc3MsICcnKTtcbiAgICB9XG5cbiAgICAvLyBOb3JtYWxseSB3ZSdkIG9ubHkgcHJpbnQgXCJyZXNvdXJjZXMgaW4gcHJvZ3Jlc3NcIiwgYnV0IGl0J3MgYWxzbyB1c2VmdWxcbiAgICAvLyB0byBrZWVwIGFuIGV5ZSBvbiB0aGUgZmFpbHVyZXMgYW5kIGtub3cgYWJvdXQgdGhlIHNwZWNpZmljIGVycm9ycyBhcyBxdWlja2x5XG4gICAgLy8gYXMgcG9zc2libGUgKHdoaWxlIHRoZSBzdGFjayBpcyBzdGlsbCByb2xsaW5nIGJhY2spLCBzbyBhZGQgdGhvc2UgaW4uXG4gICAgY29uc3QgdG9QcmludDogU3RhY2tFdmVudFtdID0gW1xuICAgICAgLi4udGhpcy5mYWlsdXJlcyxcbiAgICAgIC4uLk9iamVjdC52YWx1ZXModGhpcy5yZXNvdXJjZXNJblByb2dyZXNzKSxcbiAgICBdO1xuICAgIHRvUHJpbnQuc29ydCgoYSwgYikgPT4ge1xuICAgICAgaWYgKFxuICAgICAgICBhLkxvZ2ljYWxSZXNvdXJjZUlkICYmXG4gICAgICAgIGEuTG9naWNhbFJlc291cmNlSWQgaW4gdGhpcy5yZXNvdXJjZU5hbWVDYWNoZSAmJlxuICAgICAgICBiLkxvZ2ljYWxSZXNvdXJjZUlkICYmXG4gICAgICAgIGIuTG9naWNhbFJlc291cmNlSWQgaW4gdGhpcy5yZXNvdXJjZU5hbWVDYWNoZVxuICAgICAgKSB7XG4gICAgICAgIC8vIEFsd2F5cyBkaXNwbGF5IHRoZSByb290IHN0YWNrIGZpcnN0XG4gICAgICAgIGlmIChcbiAgICAgICAgICB0aGlzLnJlc291cmNlTmFtZUNhY2hlW2IuTG9naWNhbFJlc291cmNlSWRdLnN0YXJ0c1dpdGgoXG4gICAgICAgICAgICB0aGlzLnJvb3RTdGFja0Rpc3BsYXksXG4gICAgICAgICAgKSAmJlxuICAgICAgICAgICF0aGlzLnJlc291cmNlTmFtZUNhY2hlW2EuTG9naWNhbFJlc291cmNlSWRdLnN0YXJ0c1dpdGgoXG4gICAgICAgICAgICB0aGlzLnJvb3RTdGFja0Rpc3BsYXksXG4gICAgICAgICAgKVxuICAgICAgICApIHtcbiAgICAgICAgICByZXR1cm4gMTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoXG4gICAgICAgICAgdGhpcy5yZXNvdXJjZU5hbWVDYWNoZVthLkxvZ2ljYWxSZXNvdXJjZUlkXS5zdGFydHNXaXRoKFxuICAgICAgICAgICAgdGhpcy5yb290U3RhY2tEaXNwbGF5LFxuICAgICAgICAgICkgJiZcbiAgICAgICAgICAhdGhpcy5yZXNvdXJjZU5hbWVDYWNoZVtiLkxvZ2ljYWxSZXNvdXJjZUlkXS5zdGFydHNXaXRoKFxuICAgICAgICAgICAgdGhpcy5yb290U3RhY2tEaXNwbGF5LFxuICAgICAgICAgIClcbiAgICAgICAgKSB7XG4gICAgICAgICAgcmV0dXJuIC0xO1xuICAgICAgICB9XG4gICAgICAgIC8vIFJlc3Qgb3JkZXIgdGhlbSBsZXhpY29ncmFwaGljYWwgc28gdGhhdCB3ZSBcImdyb3VwXCIgYWxsIGNoaWxkIHJlc291cmNlcyB0b2dldGhlclxuICAgICAgICByZXR1cm4gdGhpcy5yZXNvdXJjZU5hbWVDYWNoZVthLkxvZ2ljYWxSZXNvdXJjZUlkXS5sb2NhbGVDb21wYXJlKFxuICAgICAgICAgIHRoaXMucmVzb3VyY2VOYW1lQ2FjaGVbYi5Mb2dpY2FsUmVzb3VyY2VJZF0sXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICAvLyBJZiB3ZSBkb24ndCBoYXZlIGZyaWVuZGx5IG5hbWVzLCBqdXN0IG9yZGVyIHRoZW0gYmFzZWQgb24gdGhlIHRpbWVcbiAgICAgIHJldHVybiBhLlRpbWVzdGFtcCEuZ2V0VGltZSgpIC0gYi5UaW1lc3RhbXAhLmdldFRpbWUoKTtcbiAgICB9KTtcblxuICAgIGxpbmVzLnB1c2goXG4gICAgICAuLi50b1ByaW50XG4gICAgICAgIC5maWx0ZXIoXG4gICAgICAgICAgLy8gSWYgd2UgZG9uJ3QgaGF2ZSBMb2dpY2FsUmVzb3VyY2VJZCB3ZSBkb24ndCBoYXZlIGFueXRoaW5nXG4gICAgICAgICAgKHJlcykgPT4gcmVzLkxvZ2ljYWxSZXNvdXJjZUlkLFxuICAgICAgICApXG4gICAgICAgIC5tYXAoKHJlcykgPT4ge1xuICAgICAgICAgIGNvbnN0IGNvbG9yID0gdGhpcy5jb2xvckZyb21TdGF0dXNBY3Rpdml0eShyZXMuUmVzb3VyY2VTdGF0dXMpO1xuXG4gICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Rm9ybWF0dGVkTGluZShyZXMsIGNvbG9yKTtcbiAgICAgICAgfSksXG4gICAgKTtcblxuICAgIGF3YWl0IHRoaXMuYmxvY2suZGlzcGxheUxpbmVzKGxpbmVzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFeHRyYWN0IG5lc3RlZCBzdGFjayBuYW1lc1xuICAgKi9cbiAgcHJpdmF0ZSBub3JtYWxpemVDREtDb25zdHJ1Y3RQYXRoID0gKGNvbnN0cnVjdFBhdGg6IHN0cmluZyk6IHN0cmluZyA9PiB7XG4gICAgLy8gRG9uJ3QgcnVuIHJlZ2V4IG9uIGxvbmcgc3RyaW5ncywgdGhleSBhcmUgbW9zdCBsaWtlbHkgbm90IHZhbGlkIGFuZCBjb3VsZCBjYXVzZSBET1MgYXR0YWNoLiBTZWUgQ29kZVFMJ3MganMvcG9seW5vbWlhbC1yZWRvc1xuICAgIGlmIChjb25zdHJ1Y3RQYXRoLmxlbmd0aCA+IDEwMDApIHJldHVybiBjb25zdHJ1Y3RQYXRoO1xuICAgIGNvbnN0IG5lc3RlZFN0YWNrUmVnZXggPVxuICAgICAgLyg/PG5lc3RlZFN0YWNrPlthLXpBLVowLTlfXSspXFwuTmVzdGVkU3RhY2tcXC9cXDFcXC5OZXN0ZWRTdGFja1Jlc291cmNlJC87XG5cbiAgICByZXR1cm4gY29uc3RydWN0UGF0aFxuICAgICAgLnJlcGxhY2UobmVzdGVkU3RhY2tSZWdleCwgJyQ8bmVzdGVkU3RhY2s+JylcbiAgICAgIC5yZXBsYWNlKCcvYW1wbGlmeUF1dGgvJywgJy8nKVxuICAgICAgLnJlcGxhY2UoJy9hbXBsaWZ5RGF0YS8nLCAnLycpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBFeHRyYWN0IHRoZSBmYWlsdXJlIHJlYXNvbiBmcm9tIHN0YWNrIGV2ZW50c1xuICAgKi9cbiAgcHJpdmF0ZSBmYWlsdXJlUmVhc29uID0gKGV2ZW50OiBTdGFja0V2ZW50KSA9PiB7XG4gICAgcmV0dXJuIGV2ZW50LlJlc291cmNlU3RhdHVzUmVhc29uID8/ICcnO1xuICB9O1xuXG4gIC8qKlxuICAgKiBJZiB3ZSBoYXZlIHRvdGFsIG51bWJlciBvZiByZXNvdXJjZXMsIGZvcm1hdCB0aGUgcHJvZ3Jlc3MgYmFyIGFuZCByZXR1cm5cbiAgICovXG4gIHByaXZhdGUgcHJvZ3Jlc3NCYXIgPSAoKSA9PiB7XG4gICAgY29uc3QgRlVMTF9CTE9DSyA9ICfilognO1xuICAgIGNvbnN0IFBBUlRJQUxfQkxPQ0sgPSBbJycsICfilo8nLCAn4paOJywgJ+KWjScsICfilownLCAn4paLJywgJ+KWiicsICfiloknXTtcbiAgICBjb25zdCBNQVhfUFJPR1JFU1NCQVJfV0lEVEggPSA1MDA7XG4gICAgY29uc3QgTUlOX1BST0dSRVNTQkFSX1dJRFRIID0gMTA7XG4gICAgY29uc3QgUFJPR1JFU1NCQVJfRVhUUkFfU1BBQ0UgPVxuICAgICAgMiAvKiBsZWFkaW5nIHNwYWNlcyAqLyArXG4gICAgICAyIC8qIGJyYWNrZXRzICovICtcbiAgICAgIDQgLyogcHJvZ3Jlc3MgbnVtYmVyIGRlY29yYXRpb24gKi8gK1xuICAgICAgNjsgLyogMiBwcm9ncmVzcyBudW1iZXJzIHVwIHRvIDk5OSAqL1xuXG4gICAgY29uc3Qgd2lkdGggPSBNYXRoLm1heChcbiAgICAgIE1hdGgubWluKFxuICAgICAgICB0aGlzLmdldEJsb2NrV2lkdGgoKSAtIFBST0dSRVNTQkFSX0VYVFJBX1NQQUNFIC0gMSxcbiAgICAgICAgTUFYX1BST0dSRVNTQkFSX1dJRFRILFxuICAgICAgKSxcbiAgICAgIE1JTl9QUk9HUkVTU0JBUl9XSURUSCxcbiAgICApO1xuXG4gICAgaWYgKCF0aGlzLnJlc291cmNlc1RvdGFsKSB7XG4gICAgICByZXR1cm4gJyc7XG4gICAgfVxuICAgIGNvbnN0IGZyYWN0aW9uID0gTWF0aC5taW4odGhpcy5yZXNvdXJjZXNEb25lIC8gdGhpcy5yZXNvdXJjZXNUb3RhbCwgMSk7XG4gICAgY29uc3QgaW5uZXJXaWR0aCA9IE1hdGgubWF4KDEsIHdpZHRoIC0gMik7XG4gICAgY29uc3QgY2hhcnMgPSBpbm5lcldpZHRoICogZnJhY3Rpb247XG4gICAgY29uc3QgcmVtYWluZGVyID0gY2hhcnMgLSBNYXRoLmZsb29yKGNoYXJzKTtcblxuICAgIGNvbnN0IGZ1bGxDaGFycyA9IEZVTExfQkxPQ0sucmVwZWF0KE1hdGguZmxvb3IoY2hhcnMpKTtcbiAgICBjb25zdCBwYXJ0aWFsQ2hhciA9XG4gICAgICBQQVJUSUFMX0JMT0NLW01hdGguZmxvb3IocmVtYWluZGVyICogUEFSVElBTF9CTE9DSy5sZW5ndGgpXTtcbiAgICBjb25zdCBmaWxsZXIgPSAnwrcnLnJlcGVhdChcbiAgICAgIGlubmVyV2lkdGggLSBNYXRoLmZsb29yKGNoYXJzKSAtIChwYXJ0aWFsQ2hhciA/IDEgOiAwKSxcbiAgICApO1xuXG4gICAgY29uc3QgY29sb3I6IENvbG9yTmFtZSA9IHRoaXMucm9sbGluZ0JhY2sgPyAnWWVsbG93JyA6ICdHcmVlbic7XG5cbiAgICByZXR1cm4gKFxuICAgICAgJ1snICtcbiAgICAgIGZvcm1hdC5jb2xvcihmdWxsQ2hhcnMgKyBwYXJ0aWFsQ2hhciwgY29sb3IpICtcbiAgICAgIGZpbGxlciArXG4gICAgICBgXSAoJHt0aGlzLnJlc291cmNlc0RvbmV9LyR7dGhpcy5yZXNvdXJjZXNUb3RhbH0pYFxuICAgICk7XG4gIH07XG5cbiAgLyoqXG4gICAqIEZvcm1hdCB0aGUgZmFpbHVyZSByZWFzb24gdG8gYmUgb24gdGhlIG5leHQgbGluZVxuICAgKi9cbiAgcHJpdmF0ZSBmYWlsdXJlUmVhc29uT25OZXh0TGluZSA9IChldmVudDogU3RhY2tFdmVudCkgPT4ge1xuICAgIHJldHVybiB0aGlzLmlzRmFpbHVyZVN0YXR1cyhldmVudClcbiAgICAgID8gYCR7RU9MfSR7JyAnLnJlcGVhdChcbiAgICAgICAgICB0aGlzLnRpbWVTdGFtcFdpZHRoICsgdGhpcy5zdGF0dXNXaWR0aCArIDYsXG4gICAgICAgICl9JHtmb3JtYXQuY29sb3IodGhpcy5mYWlsdXJlUmVhc29uKGV2ZW50KSA/PyAnJywgJ1JlZCcpfWBcbiAgICAgIDogJyc7XG4gIH07XG5cbiAgcHJpdmF0ZSBpc0ZhaWx1cmVTdGF0dXMgPSAoZXZlbnQ6IFN0YWNrRXZlbnQpID0+IHtcbiAgICBpZiAoXG4gICAgICAoZXZlbnQuUmVzb3VyY2VTdGF0dXNSZWFzb24/LmluY2x1ZGVzKFxuICAgICAgICAnVGhlIGZvbGxvd2luZyByZXNvdXJjZShzKSBmYWlsZWQnLFxuICAgICAgKSB8fFxuICAgICAgICBldmVudC5SZXNvdXJjZVN0YXR1c1JlYXNvbiA9PT0gJ0luaXRpYXRlZCBieSBwYXJlbnQgc3RhY2snKSAmJlxuICAgICAgZXZlbnQuUmVzb3VyY2VUeXBlID09PSAnQVdTOjpDbG91ZEZvcm1hdGlvbjo6U3RhY2snXG4gICAgKSB7XG4gICAgICAvLyBVc2VsZXNzIG5lc3RlZCBzdGFjayBmYWlsdXJlIG1lc3NhZ2VzXG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHJldHVybiAoXG4gICAgICAoZXZlbnQuUmVzb3VyY2VTdGF0dXMgJiYgZXZlbnQuUmVzb3VyY2VTdGF0dXMuZW5kc1dpdGgoJ19GQUlMRUQnKSkgfHxcbiAgICAgIGV2ZW50LlJlc291cmNlU3RhdHVzID09PSAnUk9MTEJBQ0tfSU5fUFJPR1JFU1MnIHx8XG4gICAgICBldmVudC5SZXNvdXJjZVN0YXR1cyA9PT0gJ1VQREFURV9ST0xMQkFDS19JTl9QUk9HUkVTUydcbiAgICApO1xuICB9O1xuXG4gIHByaXZhdGUgZ2V0Rm9ybWF0dGVkTGluZSA9IChldmVudDogU3RhY2tFdmVudCwgY29sb3I/OiBDb2xvck5hbWUpID0+IHtcbiAgICBjb25zdCB0aW1lU3RhbXAgPSB0aGlzLnBhZExlZnQoXG4gICAgICB0aGlzLnRpbWVTdGFtcFdpZHRoLFxuICAgICAgbmV3IERhdGUoZXZlbnQuVGltZXN0YW1wISkudG9Mb2NhbGVUaW1lU3RyaW5nKCksXG4gICAgKTtcbiAgICBjb25zdCBzdGF0dXMgPSBjb2xvclxuICAgICAgPyBmb3JtYXQuY29sb3IoXG4gICAgICAgICAgdGhpcy5wYWRSaWdodChcbiAgICAgICAgICAgIHRoaXMuc3RhdHVzV2lkdGgsXG4gICAgICAgICAgICAoZXZlbnQuUmVzb3VyY2VTdGF0dXMgfHwgJycpLnNsaWNlKDAsIHRoaXMuc3RhdHVzV2lkdGgpLFxuICAgICAgICAgICksXG4gICAgICAgICAgY29sb3IsXG4gICAgICAgIClcbiAgICAgIDogdGhpcy5wYWRSaWdodChcbiAgICAgICAgICB0aGlzLnN0YXR1c1dpZHRoLFxuICAgICAgICAgIChldmVudC5SZXNvdXJjZVN0YXR1cyB8fCAnJykuc2xpY2UoMCwgdGhpcy5zdGF0dXNXaWR0aCksXG4gICAgICAgICk7XG5cbiAgICBjb25zdCByZXNvdXJjZVR5cGUgPSB0aGlzLnBhZFJpZ2h0KFxuICAgICAgdGhpcy5yZXNvdXJjZVR5cGVDb2x1bW5XaWR0aCxcbiAgICAgIHRoaXMuc2hvcnRlbihcbiAgICAgICAgdGhpcy5yZXNvdXJjZVR5cGVDb2x1bW5XaWR0aCxcbiAgICAgICAgZXZlbnQuUmVzb3VyY2VUeXBlPy5zcGxpdCgnOjonKS5zbGljZSgxKS5qb2luKCc6JykgfHwgJycsXG4gICAgICApLFxuICAgICk7XG5cbiAgICBjb25zdCBmb3JtYXR0ZWRSZXNvdXJjZU5hbWUgPSB0aGlzLmdldEZvcm1hdHRlZFJlc291cmNlRGlzcGxheU5hbWUoXG4gICAgICBldmVudC5Mb2dpY2FsUmVzb3VyY2VJZCEsXG4gICAgKTtcbiAgICBjb25zdCByZXNvdXJjZU5hbWVUb0Rpc3BsYXkgPSBjb2xvclxuICAgICAgPyBmb3JtYXQuY29sb3IoXG4gICAgICAgICAgZm9ybWF0LmJvbGQodGhpcy5zaG9ydGVuKDEwMCwgZm9ybWF0dGVkUmVzb3VyY2VOYW1lKSksXG4gICAgICAgICAgY29sb3IsXG4gICAgICAgIClcbiAgICAgIDogZm9ybWF0LmJvbGQodGhpcy5zaG9ydGVuKDEwMCwgZm9ybWF0dGVkUmVzb3VyY2VOYW1lKSk7XG4gICAgcmV0dXJuIGAke2Zvcm1hdC5kaW0odGltZVN0YW1wKX0gfCAke3N0YXR1c30gfCAke3Jlc291cmNlVHlwZX0gfCAke3Jlc291cmNlTmFtZVRvRGlzcGxheX0ke3RoaXMuZmFpbHVyZVJlYXNvbk9uTmV4dExpbmUoXG4gICAgICBldmVudCxcbiAgICApfWA7XG4gIH07XG5cbiAgcHJpdmF0ZSBnZXRGb3JtYXR0ZWRSZXNvdXJjZURpc3BsYXlOYW1lID0gKGxvZ2ljYWxSZXNvdXJjZUlkOiBzdHJpbmcpID0+IHtcbiAgICBjb25zdCBjb25zdHJ1Y3RQYXRoID1cbiAgICAgIHRoaXMucmVzb3VyY2VOYW1lQ2FjaGVbbG9naWNhbFJlc291cmNlSWRdID8/IGxvZ2ljYWxSZXNvdXJjZUlkO1xuXG4gICAgbGV0IHJlc291cmNlTmFtZURpc3BsYXkgPSAnJztcbiAgICBjb25zdCBwYXRocyA9IGNvbnN0cnVjdFBhdGguc3BsaXQoJy8nKTtcbiAgICBjb25zdCByZXNvdXJjZU5hbWUgPSBwYXRocy5wb3AoKTtcbiAgICBpZiAocmVzb3VyY2VOYW1lID09PSB1bmRlZmluZWQgfHwgcGF0aHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAvLyBJZiB0aGVyZSBpcyBubyBoaWVyYXJjaHkgd2UganVzdCBkaXNwbGF5IGFzLWlzIHdpdGggbm8gcGFkZGluZyBhbmQgcmVzZXRzIHBhZGRpbmcgZm9yIG5leHQgcmVzb3VyY2VcbiAgICAgIHJlc291cmNlTmFtZURpc3BsYXkgPSBjb25zdHJ1Y3RQYXRoO1xuICAgICAgdGhpcy5yZXNvdXJjZU5hbWVJbmRlbnRhdGlvbiA9IDA7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIEZpZ3VyZSBvdXQgdGhlIHBhZGRpbmcgYmFzZWQgb24gdGhlIGhpZXJhcmNoeSBvZiB0aGlzIHJlc291cmNlIGJ1dFxuICAgICAgLy8gbWFrZSBzdXJlIGl0J3MgbmV2ZXIgbW9yZSB0aGFuIDEgdGhhbiB0aGUgcHJldmlvdXMgcGFkZGluZy5cbiAgICAgIHRoaXMucmVzb3VyY2VOYW1lSW5kZW50YXRpb24gPSBNYXRoLm1pbihcbiAgICAgICAgcGF0aHMubGVuZ3RoIC0gMSxcbiAgICAgICAgdGhpcy5yZXNvdXJjZU5hbWVJbmRlbnRhdGlvbixcbiAgICAgICk7XG4gICAgICByZXNvdXJjZU5hbWVEaXNwbGF5ID1cbiAgICAgICAgJyAgJy5yZXBlYXQodGhpcy5yZXNvdXJjZU5hbWVJbmRlbnRhdGlvbisrKSArICfiiJ8gJyArIHJlc291cmNlTmFtZTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc291cmNlTmFtZURpc3BsYXk7XG4gIH07XG5cbiAgLyoqXG4gICAqIEZvciBhIHR5cGljYWwgbmVzdGVkIHN0YWNrLCBDRk4gZ2VuZXJhdGUgdXBkYXRlIGV2ZW50cyBhcyBmb2xsb3dzXG4gICAqXG4gICAqIFdoZW4gcXVlcnlpbmcgZm9yIFJvb3QgU3RhY2tcbiAgICogUm9vdFN0YWNrIGV2ZW50cyAoKilcbiAgICog4oifIE5lc3RlZFN0YWNrIGV2ZW50c1xuICAgKlxuICAgKiBXaGVuIHF1ZXJ5aW5nIGZvciBOZXN0ZWQgU3RhY2tcbiAgICogTmVzdGVkU3RhY2sgZXZlbnRzICgqKVxuICAgKiDiiJ8gUmVzb3VyY2UgZXZlbnRzXG4gICAqXG4gICAqIEZvciB0aGUgKiBtYXJrZWQgcmVzb3VyY2VzLCBjZGsgZG9lc24ndCBpbmNsdWRlIG1ldGFkYXRhLCBzbyB3ZSBkb24ndCBoYXZlXG4gICAqIGEgd2F5IHRvIHNob3cgZnJpZW5kbHkgbmFtZXMuIFRoaXMgbWV0aG9kIHRyaWVzIHRvIGlkZW50aWZ5IHRoZXNlIHN0YWNrc1xuICAgKiBhbmQgbWFrZSB0aGVtIHNob3cgdXAgaW4gUm9vdCBzdGFjayBoaWVyYXJjaHlcbiAgICovXG4gIHByaXZhdGUgZ2V0RnJpZW5kbHlOYW1lRnJvbU5lc3RlZFN0YWNrTmFtZSA9IChcbiAgICBzdGFja05hbWU6IHN0cmluZyxcbiAgKTogc3RyaW5nIHwgdW5kZWZpbmVkID0+IHtcbiAgICBjb25zdCBwYXJ0cyA9IHN0YWNrTmFtZS5zcGxpdCgnLScpO1xuICAgIGlmIChwYXJ0cyAmJiBwYXJ0cy5sZW5ndGggPT09IDcgJiYgcGFydHNbM10gPT09ICdzYW5kYm94Jykge1xuICAgICAgcmV0dXJuIHRoaXMucm9vdFN0YWNrRGlzcGxheSArICcvJyArIHBhcnRzWzVdLnNsaWNlKDAsIC04KSArICcgc3RhY2snO1xuICAgIH0gZWxzZSBpZiAocGFydHMgJiYgcGFydHMubGVuZ3RoID09PSA1KSB7XG4gICAgICBpZiAocGFydHNbM10gPT09ICdzYW5kYm94Jykge1xuICAgICAgICByZXR1cm4gdGhpcy5yb290U3RhY2tEaXNwbGF5O1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9O1xuXG4gIHByaXZhdGUgY29sb3JGcm9tU3RhdHVzQWN0aXZpdHkgPSAoXG4gICAgc3RhdHVzPzogc3RyaW5nLFxuICApOiBDb2xvck5hbWUgfCB1bmRlZmluZWQgPT4ge1xuICAgIGlmICghc3RhdHVzKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHN0YXR1cy5lbmRzV2l0aCgnX0ZBSUxFRCcpKSB7XG4gICAgICByZXR1cm4gJ1JlZCc7XG4gICAgfVxuXG4gICAgaWYgKFxuICAgICAgc3RhdHVzLnN0YXJ0c1dpdGgoJ0NSRUFURV8nKSB8fFxuICAgICAgc3RhdHVzLnN0YXJ0c1dpdGgoJ1VQREFURV8nKSB8fFxuICAgICAgc3RhdHVzLnN0YXJ0c1dpdGgoJ0lNUE9SVF8nKVxuICAgICkge1xuICAgICAgcmV0dXJuICdHcmVlbic7XG4gICAgfVxuICAgIC8vIEZvciBzdGFja3MsIGl0IG1heSBhbHNvIGJlICdVUEREQVRFX1JPTExCQUNLX0lOX1BST0dSRVNTJ1xuICAgIGlmIChzdGF0dXMuaW5kZXhPZignUk9MTEJBQ0tfJykgIT09IC0xKSB7XG4gICAgICByZXR1cm4gJ1llbGxvdyc7XG4gICAgfVxuICAgIGlmIChzdGF0dXMuc3RhcnRzV2l0aCgnREVMRVRFXycpKSB7XG4gICAgICByZXR1cm4gJ1llbGxvdyc7XG4gICAgfVxuXG4gICAgcmV0dXJuO1xuICB9O1xuXG4gIHByaXZhdGUgc2hvcnRlbiA9IChtYXhXaWR0aDogbnVtYmVyLCBwOiBzdHJpbmcpID0+IHtcbiAgICBpZiAocC5sZW5ndGggPD0gbWF4V2lkdGgpIHtcbiAgICAgIHJldHVybiBwO1xuICAgIH1cbiAgICBjb25zdCBoYWxmID0gTWF0aC5mbG9vcigobWF4V2lkdGggLSAzKSAvIDIpO1xuICAgIHJldHVybiBwLnNsaWNlKDAsIGhhbGYpICsgJy4uLicgKyBwLnNsaWNlKC1oYWxmKTtcbiAgfTtcblxuICBwcml2YXRlIHBhZFJpZ2h0ID0gKG46IG51bWJlciwgeDogc3RyaW5nKTogc3RyaW5nID0+XG4gICAgeCArICcgJy5yZXBlYXQoTWF0aC5tYXgoMCwgbiAtIHgubGVuZ3RoKSk7XG5cbiAgcHJpdmF0ZSBwYWRMZWZ0ID0gKG46IG51bWJlciwgeDogc3RyaW5nKTogc3RyaW5nID0+XG4gICAgJyAnLnJlcGVhdChNYXRoLm1heCgwLCBuIC0geC5sZW5ndGgpKSArIHg7XG59XG5cbmV4cG9ydCB0eXBlIENmbkRlcGxveW1lbnRTdGFja0V2ZW50ID0ge1xuICBkZXBsb3ltZW50Pzogc3RyaW5nO1xuICBldmVudDogU3RhY2tFdmVudDtcbiAgbWV0YWRhdGE/OiB7XG4gICAgZW50cnk6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH07XG4gICAgY29uc3RydWN0UGF0aDogc3RyaW5nO1xuICB9O1xuICBwcm9ncmVzcz86IHtcbiAgICB0b3RhbDogbnVtYmVyO1xuICAgIGNvbXBsZXRlZDogbnVtYmVyO1xuICAgIGZvcm1hdHRlZDogc3RyaW5nO1xuICB9O1xufTtcblxudHlwZSBQcmludGVyUHJvcHMgPSB7XG4gIC8qKlxuICAgKiBUb3RhbCByZXNvdXJjZXMgdG8gZGVwbG95XG4gICAqL1xuICByZWFkb25seSByZXNvdXJjZXNUb3RhbD86IG51bWJlcjtcblxuICAvKipcbiAgICogUmV3cml0YWJsZSBibG9jayBpbiB3aGljaCB0byByZW5kZXIgdGhlIENGTiBwcm9ncmVzcy5cbiAgICovXG4gIHJlYWRvbmx5IHJld3JpdGFibGVCbG9jazogUmV3cml0YWJsZUJsb2NrO1xuXG4gIC8qKlxuICAgKiB3aWR0aCBvZiB0aGUgYmxvY2sgaW4gd2hpY2ggdG8gcmVuZGVyIHRoZSBDRk4gcHJvZ3Jlc3MuIEl0J3MgYSBmdW5jdGlvbiBzaW5jZSB3aW5kb3dzIGhlaWdodCBhbmQgd2lkdGggYXJlIGR5bmFtaWNcbiAgICovXG4gIHJlYWRvbmx5IGdldEJsb2NrV2lkdGg6ICgpID0+IG51bWJlcjtcbn07XG4iXX0=