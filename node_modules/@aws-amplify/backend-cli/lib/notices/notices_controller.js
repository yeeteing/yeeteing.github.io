import { NoticesManifestFetcher } from './notices_manifest_fetcher.js';
import { AmplifyUserError, PackageJsonReader, } from '@aws-amplify/platform-core';
import { LocalNamespaceResolver, } from '../backend-identifier/local_namespace_resolver.js';
import { NoticePredicatesEvaluator } from './notice_predicates_evaluator.js';
import { noticesAcknowledgementFileInstance, noticesMetadataFileInstance, } from './notices_files.js';
/**
 * A notices controller.
 */
export class NoticesController {
    packageManagerController;
    noticesAcknowledgementFile;
    noticesMetadataFile;
    namespaceResolver;
    noticesManifestFetcher;
    noticePredicatesEvaluator;
    /**
     * Creates notices controller.
     */
    constructor(packageManagerController, noticesAcknowledgementFile = noticesAcknowledgementFileInstance, noticesMetadataFile = noticesMetadataFileInstance, namespaceResolver = new LocalNamespaceResolver(new PackageJsonReader()), noticesManifestFetcher = new NoticesManifestFetcher(), noticePredicatesEvaluator = new NoticePredicatesEvaluator(packageManagerController)) {
        this.packageManagerController = packageManagerController;
        this.noticesAcknowledgementFile = noticesAcknowledgementFile;
        this.noticesMetadataFile = noticesMetadataFile;
        this.namespaceResolver = namespaceResolver;
        this.noticesManifestFetcher = noticesManifestFetcher;
        this.noticePredicatesEvaluator = noticePredicatesEvaluator;
    }
    getApplicableNotices = async (params) => {
        const noticesManifest = await this.noticesManifestFetcher.fetchNoticesManifest();
        let notices = noticesManifest.notices;
        if (!params.includeAcknowledged) {
            notices = await this.filterAcknowledgedNotices(notices);
        }
        notices = this.applyValidityPeriod(notices);
        notices = await this.applyFrequency(notices, params);
        notices = await this.applyPredicates(notices, params);
        return notices;
    };
    acknowledge = async (noticeId) => {
        const projectName = await this.namespaceResolver.resolve();
        const noticesManifest = await this.noticesManifestFetcher.fetchNoticesManifest();
        const notice = noticesManifest.notices.find((item) => item.id === noticeId);
        if (!notice) {
            throw new AmplifyUserError('NoticeNotFoundError', {
                message: `Notice with id=${noticeId} does not exist.`,
                resolution: `Ensure that notice being acknowledged exists. Run '${this.packageManagerController.getCommand(['ampx', 'notices', 'list'])}' to find available notices`,
            });
        }
        const acknowledgementFileContent = await this.noticesAcknowledgementFile.read();
        const existingAcknowledgement = acknowledgementFileContent.projectAcknowledgements.find((item) => item.projectName === projectName && item.noticeId === noticeId);
        if (existingAcknowledgement) {
            existingAcknowledgement.acknowledgedAt = Date.now();
        }
        else {
            acknowledgementFileContent.projectAcknowledgements.push({
                projectName,
                noticeId,
                acknowledgedAt: Date.now(),
            });
        }
        await this.noticesAcknowledgementFile.write(acknowledgementFileContent);
    };
    recordPrintingTimes = async (notices) => {
        const projectName = await this.namespaceResolver.resolve();
        const trackerFileContent = await this.noticesMetadataFile.read();
        for (const notice of notices) {
            const trackerItem = trackerFileContent.printTimes.find((item) => {
                return item.noticeId === notice.id && item.projectName === projectName;
            });
            if (trackerItem) {
                trackerItem.shownAt = Date.now();
            }
            else {
                trackerFileContent.printTimes.push({
                    projectName,
                    noticeId: notice.id,
                    shownAt: Date.now(),
                });
            }
        }
        await this.noticesMetadataFile.write(trackerFileContent);
    };
    filterAcknowledgedNotices = async (notices) => {
        const filteredNotices = [];
        const acknowledgementFileContent = await this.noticesAcknowledgementFile.read();
        const projectName = await this.namespaceResolver.resolve();
        for (const notice of notices) {
            const isAcknowledged = acknowledgementFileContent.projectAcknowledgements.find((ack) => {
                return ack.projectName === projectName && ack.noticeId === notice.id;
            }) !== undefined;
            if (!isAcknowledged) {
                filteredNotices.push(notice);
            }
        }
        return filteredNotices;
    };
    applyPredicates = async (notices, opts) => {
        const filteredNotices = [];
        for (const notice of notices) {
            if (await this.noticePredicatesEvaluator.evaluate(notice, opts)) {
                filteredNotices.push(notice);
            }
        }
        return filteredNotices;
    };
    applyFrequency = async (notices, opts) => {
        if (opts.event === 'listNoticesCommand') {
            // always show for listing command.
            return notices;
        }
        const projectName = await this.namespaceResolver.resolve();
        const metadata = await this.noticesMetadataFile.read();
        const shouldIncludeNotice = (notice) => {
            const desiredFrequency = notice.frequency ?? 'command';
            if (opts.event === 'postDeployment') {
                return desiredFrequency === 'deployment';
            }
            else if (desiredFrequency === 'command' ||
                desiredFrequency === 'deployment') {
                return opts.event === 'postCommand';
            }
            else if (desiredFrequency === 'once') {
                return (metadata.printTimes.find((item) => {
                    return (item.noticeId === notice.id && item.projectName === projectName);
                }) === undefined);
            }
            else if (desiredFrequency === 'daily') {
                const trackerItem = metadata.printTimes.find((item) => {
                    return (item.noticeId === notice.id && item.projectName === projectName);
                });
                if (!trackerItem) {
                    return true;
                }
                const shownAt = new Date(trackerItem.shownAt);
                const now = new Date();
                return (shownAt.getFullYear() !== now.getFullYear() ||
                    shownAt.getMonth() !== now.getMonth() ||
                    shownAt.getDate() !== now.getDate());
            }
            return false;
        };
        const filteredNotices = [];
        for (const notice of notices) {
            if (shouldIncludeNotice(notice)) {
                filteredNotices.push(notice);
            }
        }
        return filteredNotices;
    };
    applyValidityPeriod = (notices) => {
        const shouldIncludeNotice = (notice) => {
            const now = Date.now();
            return ((notice.validFrom ? now >= notice.validFrom : true) &&
                (notice.validTo ? now <= notice.validTo : true));
        };
        const filteredNotices = [];
        for (const notice of notices) {
            if (shouldIncludeNotice(notice)) {
                filteredNotices.push(notice);
            }
        }
        return filteredNotices;
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm90aWNlc19jb250cm9sbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL25vdGljZXMvbm90aWNlc19jb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQ3ZFLE9BQU8sRUFDTCxnQkFBZ0IsRUFDaEIsaUJBQWlCLEdBQ2xCLE1BQU0sNEJBQTRCLENBQUM7QUFDcEMsT0FBTyxFQUNMLHNCQUFzQixHQUV2QixNQUFNLG1EQUFtRCxDQUFDO0FBQzNELE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBRzdFLE9BQU8sRUFDTCxrQ0FBa0MsRUFDbEMsMkJBQTJCLEdBQzVCLE1BQU0sb0JBQW9CLENBQUM7QUFFNUI7O0dBRUc7QUFDSCxNQUFNLE9BQU8saUJBQWlCO0lBS1Q7SUFDQTtJQUNBO0lBQ0E7SUFHQTtJQUNBO0lBWG5COztPQUVHO0lBQ0gsWUFDbUIsd0JBQWtELEVBQ2xELDZCQUE2QixrQ0FBa0MsRUFDL0Qsc0JBQXNCLDJCQUEyQixFQUNqRCxvQkFBdUMsSUFBSSxzQkFBc0IsQ0FDaEYsSUFBSSxpQkFBaUIsRUFBRSxDQUN4QixFQUNnQix5QkFBeUIsSUFBSSxzQkFBc0IsRUFBRSxFQUNyRCw0QkFBNEIsSUFBSSx5QkFBeUIsQ0FDeEUsd0JBQXdCLENBQ3pCO1FBVGdCLDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBMEI7UUFDbEQsK0JBQTBCLEdBQTFCLDBCQUEwQixDQUFxQztRQUMvRCx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQThCO1FBQ2pELHNCQUFpQixHQUFqQixpQkFBaUIsQ0FFakM7UUFDZ0IsMkJBQXNCLEdBQXRCLHNCQUFzQixDQUErQjtRQUNyRCw4QkFBeUIsR0FBekIseUJBQXlCLENBRXpDO0lBQ0EsQ0FBQztJQUNKLG9CQUFvQixHQUFHLEtBQUssRUFDMUIsTUFFeUIsRUFDRCxFQUFFO1FB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LGVBQWUsR0FBa0IsRUFBRSxDQUFDO1FBQzFDLEtBQUssTUFBTSxNQUFNLElBQUksT0FBTyxFQUFFLENBQUM7WUFDN0IsSUFBSSxtQkFBbUIsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDO2dCQUNoQyxlQUFlLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQy9CLENBQUM7UUFDSCxDQUFDO1FBQ0QsT0FBTyxlQUFlLENBQUM7SUFDekIsQ0FBQyxDQUFDO0lBRU0sbUJBQW1CLEdBQUcsQ0FBQyxPQUFzQixFQUFpQixFQUFFO1FBQ3RFLE1BQU0sbUJBQW1CLEdBQUcsQ0FBQyxNQUFjLEVBQVcsRUFBRTtZQUN0RCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDdkIsT0FBTyxDQUNMLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDbkQsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQ2hELENBQUM7UUFDSixDQUFDLENBQUM7UUFDRixNQUFNLGVBQWUsR0FBa0IsRUFBRSxDQUFDO1FBQzFDLEtBQUssTUFBTSxNQUFNLElBQUksT0FBTyxFQUFFLENBQUM7WUFDN0IsSUFBSSxtQkFBbUIsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDO2dCQUNoQyxlQUFlLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQy9CLENBQUM7UUFDSCxDQUFDO1FBQ0QsT0FBTyxlQUFlLENBQUM7SUFDekIsQ0FBQyxDQUFDO0NBQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBOb3RpY2UgfSBmcm9tICdAYXdzLWFtcGxpZnkvY2xpLWNvcmUnO1xuaW1wb3J0IHsgTm90aWNlc01hbmlmZXN0RmV0Y2hlciB9IGZyb20gJy4vbm90aWNlc19tYW5pZmVzdF9mZXRjaGVyLmpzJztcbmltcG9ydCB7XG4gIEFtcGxpZnlVc2VyRXJyb3IsXG4gIFBhY2thZ2VKc29uUmVhZGVyLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5pbXBvcnQge1xuICBMb2NhbE5hbWVzcGFjZVJlc29sdmVyLFxuICBOYW1lc3BhY2VSZXNvbHZlcixcbn0gZnJvbSAnLi4vYmFja2VuZC1pZGVudGlmaWVyL2xvY2FsX25hbWVzcGFjZV9yZXNvbHZlci5qcyc7XG5pbXBvcnQgeyBOb3RpY2VQcmVkaWNhdGVzRXZhbHVhdG9yIH0gZnJvbSAnLi9ub3RpY2VfcHJlZGljYXRlc19ldmFsdWF0b3IuanMnO1xuaW1wb3J0IHsgUGFja2FnZU1hbmFnZXJDb250cm9sbGVyIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQgeyBOb3RpY2VzUmVuZGVyZXJQYXJhbXMgfSBmcm9tICcuL25vdGljZXNfcmVuZGVyZXIuanMnO1xuaW1wb3J0IHtcbiAgbm90aWNlc0Fja25vd2xlZGdlbWVudEZpbGVJbnN0YW5jZSxcbiAgbm90aWNlc01ldGFkYXRhRmlsZUluc3RhbmNlLFxufSBmcm9tICcuL25vdGljZXNfZmlsZXMuanMnO1xuXG4vKipcbiAqIEEgbm90aWNlcyBjb250cm9sbGVyLlxuICovXG5leHBvcnQgY2xhc3MgTm90aWNlc0NvbnRyb2xsZXIge1xuICAvKipcbiAgICogQ3JlYXRlcyBub3RpY2VzIGNvbnRyb2xsZXIuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHBhY2thZ2VNYW5hZ2VyQ29udHJvbGxlcjogUGFja2FnZU1hbmFnZXJDb250cm9sbGVyLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgbm90aWNlc0Fja25vd2xlZGdlbWVudEZpbGUgPSBub3RpY2VzQWNrbm93bGVkZ2VtZW50RmlsZUluc3RhbmNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgbm90aWNlc01ldGFkYXRhRmlsZSA9IG5vdGljZXNNZXRhZGF0YUZpbGVJbnN0YW5jZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IG5hbWVzcGFjZVJlc29sdmVyOiBOYW1lc3BhY2VSZXNvbHZlciA9IG5ldyBMb2NhbE5hbWVzcGFjZVJlc29sdmVyKFxuICAgICAgbmV3IFBhY2thZ2VKc29uUmVhZGVyKCksXG4gICAgKSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IG5vdGljZXNNYW5pZmVzdEZldGNoZXIgPSBuZXcgTm90aWNlc01hbmlmZXN0RmV0Y2hlcigpLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgbm90aWNlUHJlZGljYXRlc0V2YWx1YXRvciA9IG5ldyBOb3RpY2VQcmVkaWNhdGVzRXZhbHVhdG9yKFxuICAgICAgcGFja2FnZU1hbmFnZXJDb250cm9sbGVyLFxuICAgICksXG4gICkge31cbiAgZ2V0QXBwbGljYWJsZU5vdGljZXMgPSBhc3luYyAoXG4gICAgcGFyYW1zOiB7XG4gICAgICBpbmNsdWRlQWNrbm93bGVkZ2VkPzogYm9vbGVhbjtcbiAgICB9ICYgTm90aWNlc1JlbmRlcmVyUGFyYW1zLFxuICApOiBQcm9taXNlPEFycmF5PE5vdGljZT4+ID0+IHtcbiAgICBjb25zdCBub3RpY2VzTWFuaWZlc3QgPVxuICAgICAgYXdhaXQgdGhpcy5ub3RpY2VzTWFuaWZlc3RGZXRjaGVyLmZldGNoTm90aWNlc01hbmlmZXN0KCk7XG4gICAgbGV0IG5vdGljZXMgPSBub3RpY2VzTWFuaWZlc3Qubm90aWNlcztcbiAgICBpZiAoIXBhcmFtcy5pbmNsdWRlQWNrbm93bGVkZ2VkKSB7XG4gICAgICBub3RpY2VzID0gYXdhaXQgdGhpcy5maWx0ZXJBY2tub3dsZWRnZWROb3RpY2VzKG5vdGljZXMpO1xuICAgIH1cbiAgICBub3RpY2VzID0gdGhpcy5hcHBseVZhbGlkaXR5UGVyaW9kKG5vdGljZXMpO1xuICAgIG5vdGljZXMgPSBhd2FpdCB0aGlzLmFwcGx5RnJlcXVlbmN5KG5vdGljZXMsIHBhcmFtcyk7XG4gICAgbm90aWNlcyA9IGF3YWl0IHRoaXMuYXBwbHlQcmVkaWNhdGVzKG5vdGljZXMsIHBhcmFtcyk7XG4gICAgcmV0dXJuIG5vdGljZXM7XG4gIH07XG5cbiAgYWNrbm93bGVkZ2UgPSBhc3luYyAobm90aWNlSWQ6IHN0cmluZykgPT4ge1xuICAgIGNvbnN0IHByb2plY3ROYW1lID0gYXdhaXQgdGhpcy5uYW1lc3BhY2VSZXNvbHZlci5yZXNvbHZlKCk7XG4gICAgY29uc3Qgbm90aWNlc01hbmlmZXN0ID1cbiAgICAgIGF3YWl0IHRoaXMubm90aWNlc01hbmlmZXN0RmV0Y2hlci5mZXRjaE5vdGljZXNNYW5pZmVzdCgpO1xuICAgIGNvbnN0IG5vdGljZSA9IG5vdGljZXNNYW5pZmVzdC5ub3RpY2VzLmZpbmQoKGl0ZW0pID0+IGl0ZW0uaWQgPT09IG5vdGljZUlkKTtcbiAgICBpZiAoIW5vdGljZSkge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoJ05vdGljZU5vdEZvdW5kRXJyb3InLCB7XG4gICAgICAgIG1lc3NhZ2U6IGBOb3RpY2Ugd2l0aCBpZD0ke25vdGljZUlkfSBkb2VzIG5vdCBleGlzdC5gLFxuICAgICAgICByZXNvbHV0aW9uOiBgRW5zdXJlIHRoYXQgbm90aWNlIGJlaW5nIGFja25vd2xlZGdlZCBleGlzdHMuIFJ1biAnJHt0aGlzLnBhY2thZ2VNYW5hZ2VyQ29udHJvbGxlci5nZXRDb21tYW5kKFxuICAgICAgICAgIFsnYW1weCcsICdub3RpY2VzJywgJ2xpc3QnXSxcbiAgICAgICAgKX0nIHRvIGZpbmQgYXZhaWxhYmxlIG5vdGljZXNgLFxuICAgICAgfSk7XG4gICAgfVxuICAgIGNvbnN0IGFja25vd2xlZGdlbWVudEZpbGVDb250ZW50ID1cbiAgICAgIGF3YWl0IHRoaXMubm90aWNlc0Fja25vd2xlZGdlbWVudEZpbGUucmVhZCgpO1xuICAgIGNvbnN0IGV4aXN0aW5nQWNrbm93bGVkZ2VtZW50ID1cbiAgICAgIGFja25vd2xlZGdlbWVudEZpbGVDb250ZW50LnByb2plY3RBY2tub3dsZWRnZW1lbnRzLmZpbmQoXG4gICAgICAgIChpdGVtKSA9PlxuICAgICAgICAgIGl0ZW0ucHJvamVjdE5hbWUgPT09IHByb2plY3ROYW1lICYmIGl0ZW0ubm90aWNlSWQgPT09IG5vdGljZUlkLFxuICAgICAgKTtcbiAgICBpZiAoZXhpc3RpbmdBY2tub3dsZWRnZW1lbnQpIHtcbiAgICAgIGV4aXN0aW5nQWNrbm93bGVkZ2VtZW50LmFja25vd2xlZGdlZEF0ID0gRGF0ZS5ub3coKTtcbiAgICB9IGVsc2Uge1xuICAgICAgYWNrbm93bGVkZ2VtZW50RmlsZUNvbnRlbnQucHJvamVjdEFja25vd2xlZGdlbWVudHMucHVzaCh7XG4gICAgICAgIHByb2plY3ROYW1lLFxuICAgICAgICBub3RpY2VJZCxcbiAgICAgICAgYWNrbm93bGVkZ2VkQXQ6IERhdGUubm93KCksXG4gICAgICB9KTtcbiAgICB9XG4gICAgYXdhaXQgdGhpcy5ub3RpY2VzQWNrbm93bGVkZ2VtZW50RmlsZS53cml0ZShhY2tub3dsZWRnZW1lbnRGaWxlQ29udGVudCk7XG4gIH07XG5cbiAgcmVjb3JkUHJpbnRpbmdUaW1lcyA9IGFzeW5jIChub3RpY2VzOiBBcnJheTxOb3RpY2U+KSA9PiB7XG4gICAgY29uc3QgcHJvamVjdE5hbWUgPSBhd2FpdCB0aGlzLm5hbWVzcGFjZVJlc29sdmVyLnJlc29sdmUoKTtcbiAgICBjb25zdCB0cmFja2VyRmlsZUNvbnRlbnQgPSBhd2FpdCB0aGlzLm5vdGljZXNNZXRhZGF0YUZpbGUucmVhZCgpO1xuICAgIGZvciAoY29uc3Qgbm90aWNlIG9mIG5vdGljZXMpIHtcbiAgICAgIGNvbnN0IHRyYWNrZXJJdGVtID0gdHJhY2tlckZpbGVDb250ZW50LnByaW50VGltZXMuZmluZCgoaXRlbSkgPT4ge1xuICAgICAgICByZXR1cm4gaXRlbS5ub3RpY2VJZCA9PT0gbm90aWNlLmlkICYmIGl0ZW0ucHJvamVjdE5hbWUgPT09IHByb2plY3ROYW1lO1xuICAgICAgfSk7XG4gICAgICBpZiAodHJhY2tlckl0ZW0pIHtcbiAgICAgICAgdHJhY2tlckl0ZW0uc2hvd25BdCA9IERhdGUubm93KCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0cmFja2VyRmlsZUNvbnRlbnQucHJpbnRUaW1lcy5wdXNoKHtcbiAgICAgICAgICBwcm9qZWN0TmFtZSxcbiAgICAgICAgICBub3RpY2VJZDogbm90aWNlLmlkLFxuICAgICAgICAgIHNob3duQXQ6IERhdGUubm93KCksXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgICBhd2FpdCB0aGlzLm5vdGljZXNNZXRhZGF0YUZpbGUud3JpdGUodHJhY2tlckZpbGVDb250ZW50KTtcbiAgfTtcblxuICBwcml2YXRlIGZpbHRlckFja25vd2xlZGdlZE5vdGljZXMgPSBhc3luYyAoXG4gICAgbm90aWNlczogQXJyYXk8Tm90aWNlPixcbiAgKTogUHJvbWlzZTxBcnJheTxOb3RpY2U+PiA9PiB7XG4gICAgY29uc3QgZmlsdGVyZWROb3RpY2VzOiBBcnJheTxOb3RpY2U+ID0gW107XG4gICAgY29uc3QgYWNrbm93bGVkZ2VtZW50RmlsZUNvbnRlbnQgPVxuICAgICAgYXdhaXQgdGhpcy5ub3RpY2VzQWNrbm93bGVkZ2VtZW50RmlsZS5yZWFkKCk7XG4gICAgY29uc3QgcHJvamVjdE5hbWUgPSBhd2FpdCB0aGlzLm5hbWVzcGFjZVJlc29sdmVyLnJlc29sdmUoKTtcbiAgICBmb3IgKGNvbnN0IG5vdGljZSBvZiBub3RpY2VzKSB7XG4gICAgICBjb25zdCBpc0Fja25vd2xlZGdlZDogYm9vbGVhbiA9XG4gICAgICAgIGFja25vd2xlZGdlbWVudEZpbGVDb250ZW50LnByb2plY3RBY2tub3dsZWRnZW1lbnRzLmZpbmQoKGFjaykgPT4ge1xuICAgICAgICAgIHJldHVybiBhY2sucHJvamVjdE5hbWUgPT09IHByb2plY3ROYW1lICYmIGFjay5ub3RpY2VJZCA9PT0gbm90aWNlLmlkO1xuICAgICAgICB9KSAhPT0gdW5kZWZpbmVkO1xuICAgICAgaWYgKCFpc0Fja25vd2xlZGdlZCkge1xuICAgICAgICBmaWx0ZXJlZE5vdGljZXMucHVzaChub3RpY2UpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmlsdGVyZWROb3RpY2VzO1xuICB9O1xuXG4gIHByaXZhdGUgYXBwbHlQcmVkaWNhdGVzID0gYXN5bmMgKFxuICAgIG5vdGljZXM6IEFycmF5PE5vdGljZT4sXG4gICAgb3B0czogTm90aWNlc1JlbmRlcmVyUGFyYW1zLFxuICApOiBQcm9taXNlPEFycmF5PE5vdGljZT4+ID0+IHtcbiAgICBjb25zdCBmaWx0ZXJlZE5vdGljZXM6IEFycmF5PE5vdGljZT4gPSBbXTtcbiAgICBmb3IgKGNvbnN0IG5vdGljZSBvZiBub3RpY2VzKSB7XG4gICAgICBpZiAoYXdhaXQgdGhpcy5ub3RpY2VQcmVkaWNhdGVzRXZhbHVhdG9yLmV2YWx1YXRlKG5vdGljZSwgb3B0cykpIHtcbiAgICAgICAgZmlsdGVyZWROb3RpY2VzLnB1c2gobm90aWNlKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGZpbHRlcmVkTm90aWNlcztcbiAgfTtcblxuICBwcml2YXRlIGFwcGx5RnJlcXVlbmN5ID0gYXN5bmMgKFxuICAgIG5vdGljZXM6IEFycmF5PE5vdGljZT4sXG4gICAgb3B0czogTm90aWNlc1JlbmRlcmVyUGFyYW1zLFxuICApOiBQcm9taXNlPEFycmF5PE5vdGljZT4+ID0+IHtcbiAgICBpZiAob3B0cy5ldmVudCA9PT0gJ2xpc3ROb3RpY2VzQ29tbWFuZCcpIHtcbiAgICAgIC8vIGFsd2F5cyBzaG93IGZvciBsaXN0aW5nIGNvbW1hbmQuXG4gICAgICByZXR1cm4gbm90aWNlcztcbiAgICB9XG4gICAgY29uc3QgcHJvamVjdE5hbWUgPSBhd2FpdCB0aGlzLm5hbWVzcGFjZVJlc29sdmVyLnJlc29sdmUoKTtcbiAgICBjb25zdCBtZXRhZGF0YSA9IGF3YWl0IHRoaXMubm90aWNlc01ldGFkYXRhRmlsZS5yZWFkKCk7XG5cbiAgICBjb25zdCBzaG91bGRJbmNsdWRlTm90aWNlID0gKG5vdGljZTogTm90aWNlKTogYm9vbGVhbiA9PiB7XG4gICAgICBjb25zdCBkZXNpcmVkRnJlcXVlbmN5ID0gbm90aWNlLmZyZXF1ZW5jeSA/PyAnY29tbWFuZCc7XG4gICAgICBpZiAob3B0cy5ldmVudCA9PT0gJ3Bvc3REZXBsb3ltZW50Jykge1xuICAgICAgICByZXR1cm4gZGVzaXJlZEZyZXF1ZW5jeSA9PT0gJ2RlcGxveW1lbnQnO1xuICAgICAgfSBlbHNlIGlmIChcbiAgICAgICAgZGVzaXJlZEZyZXF1ZW5jeSA9PT0gJ2NvbW1hbmQnIHx8XG4gICAgICAgIGRlc2lyZWRGcmVxdWVuY3kgPT09ICdkZXBsb3ltZW50J1xuICAgICAgKSB7XG4gICAgICAgIHJldHVybiBvcHRzLmV2ZW50ID09PSAncG9zdENvbW1hbmQnO1xuICAgICAgfSBlbHNlIGlmIChkZXNpcmVkRnJlcXVlbmN5ID09PSAnb25jZScpIHtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICBtZXRhZGF0YS5wcmludFRpbWVzLmZpbmQoKGl0ZW0pID0+IHtcbiAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgIGl0ZW0ubm90aWNlSWQgPT09IG5vdGljZS5pZCAmJiBpdGVtLnByb2plY3ROYW1lID09PSBwcm9qZWN0TmFtZVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9KSA9PT0gdW5kZWZpbmVkXG4gICAgICAgICk7XG4gICAgICB9IGVsc2UgaWYgKGRlc2lyZWRGcmVxdWVuY3kgPT09ICdkYWlseScpIHtcbiAgICAgICAgY29uc3QgdHJhY2tlckl0ZW0gPSBtZXRhZGF0YS5wcmludFRpbWVzLmZpbmQoKGl0ZW0pID0+IHtcbiAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgaXRlbS5ub3RpY2VJZCA9PT0gbm90aWNlLmlkICYmIGl0ZW0ucHJvamVjdE5hbWUgPT09IHByb2plY3ROYW1lXG4gICAgICAgICAgKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGlmICghdHJhY2tlckl0ZW0pIHtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBzaG93bkF0ID0gbmV3IERhdGUodHJhY2tlckl0ZW0uc2hvd25BdCk7XG4gICAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgc2hvd25BdC5nZXRGdWxsWWVhcigpICE9PSBub3cuZ2V0RnVsbFllYXIoKSB8fFxuICAgICAgICAgIHNob3duQXQuZ2V0TW9udGgoKSAhPT0gbm93LmdldE1vbnRoKCkgfHxcbiAgICAgICAgICBzaG93bkF0LmdldERhdGUoKSAhPT0gbm93LmdldERhdGUoKVxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH07XG4gICAgY29uc3QgZmlsdGVyZWROb3RpY2VzOiBBcnJheTxOb3RpY2U+ID0gW107XG4gICAgZm9yIChjb25zdCBub3RpY2Ugb2Ygbm90aWNlcykge1xuICAgICAgaWYgKHNob3VsZEluY2x1ZGVOb3RpY2Uobm90aWNlKSkge1xuICAgICAgICBmaWx0ZXJlZE5vdGljZXMucHVzaChub3RpY2UpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmlsdGVyZWROb3RpY2VzO1xuICB9O1xuXG4gIHByaXZhdGUgYXBwbHlWYWxpZGl0eVBlcmlvZCA9IChub3RpY2VzOiBBcnJheTxOb3RpY2U+KTogQXJyYXk8Tm90aWNlPiA9PiB7XG4gICAgY29uc3Qgc2hvdWxkSW5jbHVkZU5vdGljZSA9IChub3RpY2U6IE5vdGljZSk6IGJvb2xlYW4gPT4ge1xuICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICAgIHJldHVybiAoXG4gICAgICAgIChub3RpY2UudmFsaWRGcm9tID8gbm93ID49IG5vdGljZS52YWxpZEZyb20gOiB0cnVlKSAmJlxuICAgICAgICAobm90aWNlLnZhbGlkVG8gPyBub3cgPD0gbm90aWNlLnZhbGlkVG8gOiB0cnVlKVxuICAgICAgKTtcbiAgICB9O1xuICAgIGNvbnN0IGZpbHRlcmVkTm90aWNlczogQXJyYXk8Tm90aWNlPiA9IFtdO1xuICAgIGZvciAoY29uc3Qgbm90aWNlIG9mIG5vdGljZXMpIHtcbiAgICAgIGlmIChzaG91bGRJbmNsdWRlTm90aWNlKG5vdGljZSkpIHtcbiAgICAgICAgZmlsdGVyZWROb3RpY2VzLnB1c2gobm90aWNlKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGZpbHRlcmVkTm90aWNlcztcbiAgfTtcbn1cbiJdfQ==