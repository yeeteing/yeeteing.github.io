import _isCI from 'is-ci';
import { ClientConfigFormat, ClientConfigVersionOption, DEFAULT_CLIENT_CONFIG_VERSION, } from '@aws-amplify/client-config';
import { AmplifyUserError } from '@aws-amplify/platform-core';
import { format } from '@aws-amplify/cli-core';
/**
 * An entry point for deploy command.
 */
export class PipelineDeployCommand {
    clientConfigGenerator;
    backendDeployer;
    isCiEnvironment;
    /**
     * @inheritDoc
     */
    command;
    /**
     * @inheritDoc
     */
    describe;
    /**
     * Creates top level entry point for deploy command.
     */
    constructor(clientConfigGenerator, backendDeployer, isCiEnvironment = _isCI) {
        this.clientConfigGenerator = clientConfigGenerator;
        this.backendDeployer = backendDeployer;
        this.isCiEnvironment = isCiEnvironment;
        this.command = 'pipeline-deploy';
        this.describe =
            'Command to deploy backends in a custom CI/CD pipeline. This command is not intended to be used locally.';
    }
    /**
     * @inheritDoc
     */
    handler = async (args) => {
        if (!this.isCiEnvironment) {
            throw new AmplifyUserError('RunningPipelineDeployNotInCiError', {
                message: 'It looks like this command is being run outside of a CI/CD workflow.',
                resolution: `To deploy locally use ${format.normalizeAmpxCommand('sandbox')} instead.`,
            });
        }
        const backendId = {
            namespace: args.appId,
            name: args.branch,
            type: 'branch',
        };
        await this.backendDeployer.deploy(backendId, {
            validateAppSources: true,
        });
        await this.clientConfigGenerator.generateClientConfigToFile(backendId, args.outputsVersion, args.outputsOutDir, args.outputsFormat);
    };
    builder = (yargs) => {
        return yargs
            .version(false)
            .option('branch', {
            describe: 'Name of the git branch being deployed',
            demandOption: true,
            type: 'string',
            array: false,
        })
            .option('app-id', {
            describe: 'The app id of the target Amplify app',
            demandOption: true,
            type: 'string',
            array: false,
        })
            .option('outputs-out-dir', {
            describe: 'A path to directory where amplify_outputs is written. If not provided defaults to current process working directory.',
            type: 'string',
            array: false,
        })
            .option('outputs-version', {
            describe: 'Version of the configuration. Version 0 represents classic amplify-cli config file amplify-configuration and 1 represents newer config file amplify_outputs',
            type: 'string',
            array: false,
            choices: Object.values(ClientConfigVersionOption),
            default: DEFAULT_CLIENT_CONFIG_VERSION,
        })
            .option('outputs-format', {
            describe: 'amplify_outputs file format',
            type: 'string',
            array: false,
            choices: Object.values(ClientConfigFormat),
        })
            .check(async (argv) => {
            if (argv['branch'].length === 0 || argv['app-id'].length === 0) {
                throw new AmplifyUserError('InvalidCommandInputError', {
                    message: 'Invalid --branch or --app-id',
                    resolution: '--branch and --app-id must be at least 1 character',
                });
            }
            return true;
        });
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGlwZWxpbmVfZGVwbG95X2NvbW1hbmQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY29tbWFuZHMvcGlwZWxpbmUtZGVwbG95L3BpcGVsaW5lX2RlcGxveV9jb21tYW5kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxNQUFNLE9BQU8sQ0FBQztBQU0xQixPQUFPLEVBQ0wsa0JBQWtCLEVBRWxCLHlCQUF5QixFQUN6Qiw2QkFBNkIsR0FDOUIsTUFBTSw0QkFBNEIsQ0FBQztBQUNwQyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFhL0M7O0dBRUc7QUFDSCxNQUFNLE9BQU8scUJBQXFCO0lBaUJiO0lBQ0E7SUFDQTtJQWhCbkI7O09BRUc7SUFDTSxPQUFPLENBQVM7SUFFekI7O09BRUc7SUFDTSxRQUFRLENBQVM7SUFFMUI7O09BRUc7SUFDSCxZQUNtQixxQkFBbUQsRUFDbkQsZUFBZ0MsRUFDaEMsa0JBQWdDLEtBQUs7UUFGckMsMEJBQXFCLEdBQXJCLHFCQUFxQixDQUE4QjtRQUNuRCxvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFDaEMsb0JBQWUsR0FBZixlQUFlLENBQXNCO1FBRXRELElBQUksQ0FBQyxPQUFPLEdBQUcsaUJBQWlCLENBQUM7UUFDakMsSUFBSSxDQUFDLFFBQVE7WUFDWCx5R0FBeUcsQ0FBQztJQUM5RyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxPQUFPLEdBQUcsS0FBSyxFQUNiLElBQXNELEVBQ3ZDLEVBQUU7UUFDakIsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztZQUMxQixNQUFNLElBQUksZ0JBQWdCLENBQUMsbUNBQW1DLEVBQUU7Z0JBQzlELE9BQU8sRUFDTCxzRUFBc0U7Z0JBQ3hFLFVBQVUsRUFBRSx5QkFBeUIsTUFBTSxDQUFDLG9CQUFvQixDQUM5RCxTQUFTLENBQ1YsV0FBVzthQUNiLENBQUMsQ0FBQztRQUNMLENBQUM7UUFFRCxNQUFNLFNBQVMsR0FBc0I7WUFDbkMsU0FBUyxFQUFFLElBQUksQ0FBQyxLQUFLO1lBQ3JCLElBQUksRUFBRSxJQUFJLENBQUMsTUFBTTtZQUNqQixJQUFJLEVBQUUsUUFBUTtTQUNmLENBQUM7UUFDRixNQUFNLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRTtZQUMzQyxrQkFBa0IsRUFBRSxJQUFJO1NBQ3pCLENBQUMsQ0FBQztRQUNILE1BQU0sSUFBSSxDQUFDLHFCQUFxQixDQUFDLDBCQUEwQixDQUN6RCxTQUFTLEVBQ1QsSUFBSSxDQUFDLGNBQXFDLEVBQzFDLElBQUksQ0FBQyxhQUFhLEVBQ2xCLElBQUksQ0FBQyxhQUFhLENBQ25CLENBQUM7SUFDSixDQUFDLENBQUM7SUFFRixPQUFPLEdBQUcsQ0FBQyxLQUFXLEVBQXNDLEVBQUU7UUFDNUQsT0FBTyxLQUFLO2FBQ1QsT0FBTyxDQUFDLEtBQUssQ0FBQzthQUNkLE1BQU0sQ0FBQyxRQUFRLEVBQUU7WUFDaEIsUUFBUSxFQUFFLHVDQUF1QztZQUNqRCxZQUFZLEVBQUUsSUFBSTtZQUNsQixJQUFJLEVBQUUsUUFBUTtZQUNkLEtBQUssRUFBRSxLQUFLO1NBQ2IsQ0FBQzthQUNELE1BQU0sQ0FBQyxRQUFRLEVBQUU7WUFDaEIsUUFBUSxFQUFFLHNDQUFzQztZQUNoRCxZQUFZLEVBQUUsSUFBSTtZQUNsQixJQUFJLEVBQUUsUUFBUTtZQUNkLEtBQUssRUFBRSxLQUFLO1NBQ2IsQ0FBQzthQUNELE1BQU0sQ0FBQyxpQkFBaUIsRUFBRTtZQUN6QixRQUFRLEVBQ04sc0hBQXNIO1lBQ3hILElBQUksRUFBRSxRQUFRO1lBQ2QsS0FBSyxFQUFFLEtBQUs7U0FDYixDQUFDO2FBQ0QsTUFBTSxDQUFDLGlCQUFpQixFQUFFO1lBQ3pCLFFBQVEsRUFDTiw2SkFBNko7WUFDL0osSUFBSSxFQUFFLFFBQVE7WUFDZCxLQUFLLEVBQUUsS0FBSztZQUNaLE9BQU8sRUFBRSxNQUFNLENBQUMsTUFBTSxDQUFDLHlCQUF5QixDQUFDO1lBQ2pELE9BQU8sRUFBRSw2QkFBNkI7U0FDdkMsQ0FBQzthQUNELE1BQU0sQ0FBQyxnQkFBZ0IsRUFBRTtZQUN4QixRQUFRLEVBQUUsNkJBQTZCO1lBQ3ZDLElBQUksRUFBRSxRQUFRO1lBQ2QsS0FBSyxFQUFFLEtBQUs7WUFDWixPQUFPLEVBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQztTQUMzQyxDQUFDO2FBQ0QsS0FBSyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsRUFBRTtZQUNwQixJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7Z0JBQy9ELE1BQU0sSUFBSSxnQkFBZ0IsQ0FBQywwQkFBMEIsRUFBRTtvQkFDckQsT0FBTyxFQUFFLDhCQUE4QjtvQkFDdkMsVUFBVSxFQUFFLG9EQUFvRDtpQkFDakUsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztZQUNELE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDLENBQUM7Q0FDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfaXNDSSBmcm9tICdpcy1jaSc7XG5pbXBvcnQgeyBBcmd1bWVudHNDYW1lbENhc2UsIEFyZ3YsIENvbW1hbmRNb2R1bGUgfSBmcm9tICd5YXJncyc7XG5pbXBvcnQgeyBCYWNrZW5kRGVwbG95ZXIgfSBmcm9tICdAYXdzLWFtcGxpZnkvYmFja2VuZC1kZXBsb3llcic7XG5pbXBvcnQgeyBDbGllbnRDb25maWdHZW5lcmF0b3JBZGFwdGVyIH0gZnJvbSAnLi4vLi4vY2xpZW50LWNvbmZpZy9jbGllbnRfY29uZmlnX2dlbmVyYXRvcl9hZGFwdGVyLmpzJztcbmltcG9ydCB7IEFyZ3VtZW50c0tlYmFiQ2FzZSB9IGZyb20gJy4uLy4uL2tlYmFiX2Nhc2UuanMnO1xuaW1wb3J0IHsgQmFja2VuZElkZW50aWZpZXIgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7XG4gIENsaWVudENvbmZpZ0Zvcm1hdCxcbiAgQ2xpZW50Q29uZmlnVmVyc2lvbixcbiAgQ2xpZW50Q29uZmlnVmVyc2lvbk9wdGlvbixcbiAgREVGQVVMVF9DTElFTlRfQ09ORklHX1ZFUlNJT04sXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9jbGllbnQtY29uZmlnJztcbmltcG9ydCB7IEFtcGxpZnlVc2VyRXJyb3IgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5pbXBvcnQgeyBmb3JtYXQgfSBmcm9tICdAYXdzLWFtcGxpZnkvY2xpLWNvcmUnO1xuXG5leHBvcnQgdHlwZSBQaXBlbGluZURlcGxveUNvbW1hbmRPcHRpb25zID1cbiAgQXJndW1lbnRzS2ViYWJDYXNlPFBpcGVsaW5lRGVwbG95Q29tbWFuZE9wdGlvbnNDYW1lbENhc2U+O1xuXG50eXBlIFBpcGVsaW5lRGVwbG95Q29tbWFuZE9wdGlvbnNDYW1lbENhc2UgPSB7XG4gIGJyYW5jaDogc3RyaW5nO1xuICBhcHBJZDogc3RyaW5nO1xuICBvdXRwdXRzRm9ybWF0OiBDbGllbnRDb25maWdGb3JtYXQgfCB1bmRlZmluZWQ7XG4gIG91dHB1dHNWZXJzaW9uOiBzdHJpbmc7XG4gIG91dHB1dHNPdXREaXI/OiBzdHJpbmc7XG59O1xuXG4vKipcbiAqIEFuIGVudHJ5IHBvaW50IGZvciBkZXBsb3kgY29tbWFuZC5cbiAqL1xuZXhwb3J0IGNsYXNzIFBpcGVsaW5lRGVwbG95Q29tbWFuZFxuICBpbXBsZW1lbnRzIENvbW1hbmRNb2R1bGU8b2JqZWN0LCBQaXBlbGluZURlcGxveUNvbW1hbmRPcHRpb25zPlxue1xuICAvKipcbiAgICogQGluaGVyaXREb2NcbiAgICovXG4gIHJlYWRvbmx5IGNvbW1hbmQ6IHN0cmluZztcblxuICAvKipcbiAgICogQGluaGVyaXREb2NcbiAgICovXG4gIHJlYWRvbmx5IGRlc2NyaWJlOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgdG9wIGxldmVsIGVudHJ5IHBvaW50IGZvciBkZXBsb3kgY29tbWFuZC5cbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgY2xpZW50Q29uZmlnR2VuZXJhdG9yOiBDbGllbnRDb25maWdHZW5lcmF0b3JBZGFwdGVyLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYmFja2VuZERlcGxveWVyOiBCYWNrZW5kRGVwbG95ZXIsXG4gICAgcHJpdmF0ZSByZWFkb25seSBpc0NpRW52aXJvbm1lbnQ6IHR5cGVvZiBfaXNDSSA9IF9pc0NJLFxuICApIHtcbiAgICB0aGlzLmNvbW1hbmQgPSAncGlwZWxpbmUtZGVwbG95JztcbiAgICB0aGlzLmRlc2NyaWJlID1cbiAgICAgICdDb21tYW5kIHRvIGRlcGxveSBiYWNrZW5kcyBpbiBhIGN1c3RvbSBDSS9DRCBwaXBlbGluZS4gVGhpcyBjb21tYW5kIGlzIG5vdCBpbnRlbmRlZCB0byBiZSB1c2VkIGxvY2FsbHkuJztcbiAgfVxuXG4gIC8qKlxuICAgKiBAaW5oZXJpdERvY1xuICAgKi9cbiAgaGFuZGxlciA9IGFzeW5jIChcbiAgICBhcmdzOiBBcmd1bWVudHNDYW1lbENhc2U8UGlwZWxpbmVEZXBsb3lDb21tYW5kT3B0aW9ucz4sXG4gICk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIGlmICghdGhpcy5pc0NpRW52aXJvbm1lbnQpIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKCdSdW5uaW5nUGlwZWxpbmVEZXBsb3lOb3RJbkNpRXJyb3InLCB7XG4gICAgICAgIG1lc3NhZ2U6XG4gICAgICAgICAgJ0l0IGxvb2tzIGxpa2UgdGhpcyBjb21tYW5kIGlzIGJlaW5nIHJ1biBvdXRzaWRlIG9mIGEgQ0kvQ0Qgd29ya2Zsb3cuJyxcbiAgICAgICAgcmVzb2x1dGlvbjogYFRvIGRlcGxveSBsb2NhbGx5IHVzZSAke2Zvcm1hdC5ub3JtYWxpemVBbXB4Q29tbWFuZChcbiAgICAgICAgICAnc2FuZGJveCcsXG4gICAgICAgICl9IGluc3RlYWQuYCxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IGJhY2tlbmRJZDogQmFja2VuZElkZW50aWZpZXIgPSB7XG4gICAgICBuYW1lc3BhY2U6IGFyZ3MuYXBwSWQsXG4gICAgICBuYW1lOiBhcmdzLmJyYW5jaCxcbiAgICAgIHR5cGU6ICdicmFuY2gnLFxuICAgIH07XG4gICAgYXdhaXQgdGhpcy5iYWNrZW5kRGVwbG95ZXIuZGVwbG95KGJhY2tlbmRJZCwge1xuICAgICAgdmFsaWRhdGVBcHBTb3VyY2VzOiB0cnVlLFxuICAgIH0pO1xuICAgIGF3YWl0IHRoaXMuY2xpZW50Q29uZmlnR2VuZXJhdG9yLmdlbmVyYXRlQ2xpZW50Q29uZmlnVG9GaWxlKFxuICAgICAgYmFja2VuZElkLFxuICAgICAgYXJncy5vdXRwdXRzVmVyc2lvbiBhcyBDbGllbnRDb25maWdWZXJzaW9uLFxuICAgICAgYXJncy5vdXRwdXRzT3V0RGlyLFxuICAgICAgYXJncy5vdXRwdXRzRm9ybWF0LFxuICAgICk7XG4gIH07XG5cbiAgYnVpbGRlciA9ICh5YXJnczogQXJndik6IEFyZ3Y8UGlwZWxpbmVEZXBsb3lDb21tYW5kT3B0aW9ucz4gPT4ge1xuICAgIHJldHVybiB5YXJnc1xuICAgICAgLnZlcnNpb24oZmFsc2UpXG4gICAgICAub3B0aW9uKCdicmFuY2gnLCB7XG4gICAgICAgIGRlc2NyaWJlOiAnTmFtZSBvZiB0aGUgZ2l0IGJyYW5jaCBiZWluZyBkZXBsb3llZCcsXG4gICAgICAgIGRlbWFuZE9wdGlvbjogdHJ1ZSxcbiAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgIGFycmF5OiBmYWxzZSxcbiAgICAgIH0pXG4gICAgICAub3B0aW9uKCdhcHAtaWQnLCB7XG4gICAgICAgIGRlc2NyaWJlOiAnVGhlIGFwcCBpZCBvZiB0aGUgdGFyZ2V0IEFtcGxpZnkgYXBwJyxcbiAgICAgICAgZGVtYW5kT3B0aW9uOiB0cnVlLFxuICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgYXJyYXk6IGZhbHNlLFxuICAgICAgfSlcbiAgICAgIC5vcHRpb24oJ291dHB1dHMtb3V0LWRpcicsIHtcbiAgICAgICAgZGVzY3JpYmU6XG4gICAgICAgICAgJ0EgcGF0aCB0byBkaXJlY3Rvcnkgd2hlcmUgYW1wbGlmeV9vdXRwdXRzIGlzIHdyaXR0ZW4uIElmIG5vdCBwcm92aWRlZCBkZWZhdWx0cyB0byBjdXJyZW50IHByb2Nlc3Mgd29ya2luZyBkaXJlY3RvcnkuJyxcbiAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgIGFycmF5OiBmYWxzZSxcbiAgICAgIH0pXG4gICAgICAub3B0aW9uKCdvdXRwdXRzLXZlcnNpb24nLCB7XG4gICAgICAgIGRlc2NyaWJlOlxuICAgICAgICAgICdWZXJzaW9uIG9mIHRoZSBjb25maWd1cmF0aW9uLiBWZXJzaW9uIDAgcmVwcmVzZW50cyBjbGFzc2ljIGFtcGxpZnktY2xpIGNvbmZpZyBmaWxlIGFtcGxpZnktY29uZmlndXJhdGlvbiBhbmQgMSByZXByZXNlbnRzIG5ld2VyIGNvbmZpZyBmaWxlIGFtcGxpZnlfb3V0cHV0cycsXG4gICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICBhcnJheTogZmFsc2UsXG4gICAgICAgIGNob2ljZXM6IE9iamVjdC52YWx1ZXMoQ2xpZW50Q29uZmlnVmVyc2lvbk9wdGlvbiksXG4gICAgICAgIGRlZmF1bHQ6IERFRkFVTFRfQ0xJRU5UX0NPTkZJR19WRVJTSU9OLFxuICAgICAgfSlcbiAgICAgIC5vcHRpb24oJ291dHB1dHMtZm9ybWF0Jywge1xuICAgICAgICBkZXNjcmliZTogJ2FtcGxpZnlfb3V0cHV0cyBmaWxlIGZvcm1hdCcsXG4gICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICBhcnJheTogZmFsc2UsXG4gICAgICAgIGNob2ljZXM6IE9iamVjdC52YWx1ZXMoQ2xpZW50Q29uZmlnRm9ybWF0KSxcbiAgICAgIH0pXG4gICAgICAuY2hlY2soYXN5bmMgKGFyZ3YpID0+IHtcbiAgICAgICAgaWYgKGFyZ3ZbJ2JyYW5jaCddLmxlbmd0aCA9PT0gMCB8fCBhcmd2WydhcHAtaWQnXS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcignSW52YWxpZENvbW1hbmRJbnB1dEVycm9yJywge1xuICAgICAgICAgICAgbWVzc2FnZTogJ0ludmFsaWQgLS1icmFuY2ggb3IgLS1hcHAtaWQnLFxuICAgICAgICAgICAgcmVzb2x1dGlvbjogJy0tYnJhbmNoIGFuZCAtLWFwcC1pZCBtdXN0IGJlIGF0IGxlYXN0IDEgY2hhcmFjdGVyJyxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH0pO1xuICB9O1xufVxuIl19