import { Duration } from 'aws-cdk-lib';
import { AmplifyUserError } from '@aws-amplify/platform-core';
const DEFAULT_API_KEY_EXPIRATION_DAYS = 7;
const DEFAULT_LAMBDA_AUTH_TIME_TO_LIVE_SECONDS = 60;
/**
 * Function instance provider which uses the
 */
export const buildConstructFactoryProvidedAuthConfig = (authResourceProvider) => {
    if (!authResourceProvider)
        return;
    return {
        userPool: authResourceProvider.resources.userPool,
        identityPoolId: authResourceProvider.resources.identityPoolId,
        authenticatedUserRole: authResourceProvider.resources.authenticatedUserIamRole,
        unauthenticatedUserRole: authResourceProvider.resources.unauthenticatedUserIamRole,
    };
};
/**
 * Convert to CDK ApiKeyAuthorizationConfig.
 */
const convertApiKeyAuthConfigToCDK = ({ description, expiresInDays = DEFAULT_API_KEY_EXPIRATION_DAYS, } = {}) => ({
    description,
    expires: Duration.days(expiresInDays),
});
/**
 * Convert to CDK LambdaAuthorizationConfig.
 */
const convertLambdaAuthorizationConfigToCDK = (getInstanceProps, { function: authFn, timeToLiveInSeconds = DEFAULT_LAMBDA_AUTH_TIME_TO_LIVE_SECONDS, }) => ({
    function: authFn.getInstance(getInstanceProps).resources.lambda,
    ttl: Duration.seconds(timeToLiveInSeconds),
});
/**
 * Convert to CDK OIDCAuthorizationConfig.
 */
const convertOIDCAuthConfigToCDK = ({ oidcProviderName, oidcIssuerUrl, clientId, tokenExpiryFromAuthInSeconds, tokenExpireFromIssueInSeconds, }) => ({
    oidcProviderName,
    oidcIssuerUrl,
    clientId,
    tokenExpiryFromAuth: Duration.seconds(tokenExpiryFromAuthInSeconds),
    tokenExpiryFromIssue: Duration.seconds(tokenExpireFromIssueInSeconds),
});
/**
 * Compute default auth mode based on availability of auth resources.
 *
 * Will default to userPool if userPool is provided and auth resources are not provided.
 *
 * If no auth resources are provided and there's only one mode we'll use that as we implicitly always add iam auth.
 */
const computeDefaultAuthorizationMode = (providedAuthConfig, authModes) => {
    if (isUsingDefaultApiKeyAuth(providedAuthConfig, authModes)) {
        return 'apiKey';
    }
    else if (providedAuthConfig && !authModes) {
        return 'userPool';
    }
    else if (!providedAuthConfig &&
        authModes &&
        Object.keys(authModes).length === 1) {
        if (authModes.oidcAuthorizationMode) {
            return 'oidc';
        }
        else if (authModes.lambdaAuthorizationMode) {
            return 'lambda';
        }
        else if (authModes.apiKeyAuthorizationMode) {
            return 'apiKey';
        }
    }
    throw new AmplifyUserError('DefineDataConfigurationError', {
        message: 'A defaultAuthorizationMode is required if multiple authorization modes are configured',
        resolution: "When calling 'defineData' specify 'authorizationModes.defaultAuthorizationMode'",
    });
};
/**
 * Compute user pool auth config from auth resource provider.
 * @returns a user pool auth config, if relevant
 */
const computeUserPoolAuthFromResource = (providedAuthConfig) => {
    if (providedAuthConfig) {
        return { userPool: providedAuthConfig.userPool };
    }
    return;
};
/**
 * Compute identity pool auth config from auth resource provider.
 * @returns an iam auth config, if relevant
 */
const computeIdentityPoolAuthFromResource = (providedAuthConfig) => {
    if (providedAuthConfig) {
        return {
            authenticatedUserRole: providedAuthConfig.authenticatedUserRole,
            unauthenticatedUserRole: providedAuthConfig.unauthenticatedUserRole,
            identityPoolId: providedAuthConfig.identityPoolId,
        };
    }
    return;
};
/**
 * Compute api key auth config from auth resource provider.
 * @returns an api key auth config, if relevant
 */
const computeApiKeyAuthFromResource = (providedAuthConfig, authModes) => {
    if (isUsingDefaultApiKeyAuth(providedAuthConfig, authModes)) {
        return {
            expires: Duration.days(DEFAULT_API_KEY_EXPIRATION_DAYS),
        };
    }
    return;
};
const authorizationModeMapping = {
    iam: 'AWS_IAM',
    identityPool: 'AWS_IAM',
    userPool: 'AMAZON_COGNITO_USER_POOLS',
    oidc: 'OPENID_CONNECT',
    apiKey: 'API_KEY',
    lambda: 'AWS_LAMBDA',
};
const convertAuthorizationModeToCDK = (mode) => {
    if (!mode)
        return;
    return authorizationModeMapping[mode];
};
/**
 * Convert to CDK AuthorizationModes.
 */
export const convertAuthorizationModesToCDK = (getInstanceProps, authResources, authModes) => {
    const defaultAuthorizationMode = authModes?.defaultAuthorizationMode ??
        computeDefaultAuthorizationMode(authResources, authModes);
    const cdkAuthorizationMode = convertAuthorizationModeToCDK(defaultAuthorizationMode);
    const apiKeyConfig = authModes?.apiKeyAuthorizationMode ||
        // If default auth mode is apiKey, don't require apiKeyAuthorizationMode to be defined
        defaultAuthorizationMode === 'apiKey'
        ? convertApiKeyAuthConfigToCDK(authModes?.apiKeyAuthorizationMode)
        : computeApiKeyAuthFromResource(authResources, authModes);
    const userPoolConfig = computeUserPoolAuthFromResource(authResources);
    const identityPoolConfig = computeIdentityPoolAuthFromResource(authResources);
    const lambdaConfig = authModes?.lambdaAuthorizationMode
        ? convertLambdaAuthorizationConfigToCDK(getInstanceProps, authModes.lambdaAuthorizationMode)
        : undefined;
    const oidcConfig = authModes?.oidcAuthorizationMode
        ? convertOIDCAuthConfigToCDK(authModes.oidcAuthorizationMode)
        : undefined;
    return {
        ...(cdkAuthorizationMode
            ? { defaultAuthorizationMode: cdkAuthorizationMode }
            : undefined),
        ...(apiKeyConfig ? { apiKeyConfig } : undefined),
        ...(userPoolConfig ? { userPoolConfig } : undefined),
        ...(identityPoolConfig ? { identityPoolConfig } : undefined),
        ...(lambdaConfig ? { lambdaConfig } : undefined),
        ...(oidcConfig ? { oidcConfig } : undefined),
        iamConfig: {
            enableIamAuthorizationMode: true,
        },
    };
};
/**
 * Return whether or not the api will use default API_KEY auth due to absence of auth resources and input auth-modes.
 * @param authResources the generated auth resources in the system
 * @param authModes the provided auth modes
 * @returns a boolean indicating whether or not default api key auth will be used.
 */
export const isUsingDefaultApiKeyAuth = (authResources, authModes) => {
    return authModes === undefined && authResources === undefined;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udmVydF9hdXRob3JpemF0aW9uX21vZGVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NvbnZlcnRfYXV0aG9yaXphdGlvbl9tb2Rlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBeUJ2QyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUU5RCxNQUFNLCtCQUErQixHQUFHLENBQUMsQ0FBQztBQUMxQyxNQUFNLHdDQUF3QyxHQUFHLEVBQUUsQ0FBQztBQVNwRDs7R0FFRztBQUNILE1BQU0sQ0FBQyxNQUFNLHVDQUF1QyxHQUFHLENBQ3JELG9CQUVhLEVBQ21CLEVBQUU7SUFDbEMsSUFBSSxDQUFDLG9CQUFvQjtRQUFFLE9BQU87SUFDbEMsT0FBTztRQUNMLFFBQVEsRUFBRSxvQkFBb0IsQ0FBQyxTQUFTLENBQUMsUUFBUTtRQUNqRCxjQUFjLEVBQUUsb0JBQW9CLENBQUMsU0FBUyxDQUFDLGNBQWM7UUFDN0QscUJBQXFCLEVBQ25CLG9CQUFvQixDQUFDLFNBQVMsQ0FBQyx3QkFBd0I7UUFDekQsdUJBQXVCLEVBQ3JCLG9CQUFvQixDQUFDLFNBQVMsQ0FBQywwQkFBMEI7S0FDNUQsQ0FBQztBQUNKLENBQUMsQ0FBQztBQUVGOztHQUVHO0FBQ0gsTUFBTSw0QkFBNEIsR0FBRyxDQUFDLEVBQ3BDLFdBQVcsRUFDWCxhQUFhLEdBQUcsK0JBQStCLE1BQ2YsRUFBRSxFQUFnQyxFQUFFLENBQUMsQ0FBQztJQUN0RSxXQUFXO0lBQ1gsT0FBTyxFQUFFLFFBQVEsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDO0NBQ3RDLENBQUMsQ0FBQztBQUVIOztHQUVHO0FBQ0gsTUFBTSxxQ0FBcUMsR0FBRyxDQUM1QyxnQkFBa0QsRUFDbEQsRUFDRSxRQUFRLEVBQUUsTUFBTSxFQUNoQixtQkFBbUIsR0FBRyx3Q0FBd0MsR0FDakMsRUFDRCxFQUFF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Q0FBQywwQkFBMEIsQ0FBQyxTQUFTLENBQUMscUJBQXFCLENBQUM7UUFDN0QsQ0FBQyxDQUFDLFNBQVMsQ0FBQztJQUVkLE9BQU87UUFDTCxHQUFHLENBQUMsb0JBQW9CO1lBQ3RCLENBQUMsQ0FBQyxFQUFFLHdCQUF3QixFQUFFLG9CQUFvQixFQUFFO1lBQ3BELENBQUMsQ0FBQyxTQUFTLENBQUM7UUFDZCxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxFQUFFLFlBQVksRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7UUFDaEQsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsRUFBRSxjQUFjLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO1FBQ3BELEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsRUFBRSxrQkFBa0IsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7UUFDNUQsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsRUFBRSxZQUFZLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO1FBQ2hELEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQUUsVUFBVSxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztRQUM1QyxTQUFTLEVBQUU7WUFDVCwwQkFBMEIsRUFBRSxJQUFJO1NBQ2pDO0tBQ0YsQ0FBQztBQUNKLENBQUMsQ0FBQztBQUVGOzs7OztHQUtHO0FBQ0gsTUFBTSxDQUFDLE1BQU0sd0JBQXdCLEdBQUcsQ0FDdEMsYUFBNkMsRUFDN0MsU0FBeUMsRUFDaEMsRUFBRTtJQUNYLE9BQU8sU0FBUyxLQUFLLFNBQVMsSUFBSSxhQUFhLEtBQUssU0FBUyxDQUFDO0FBQ2hFLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IER1cmF0aW9uIH0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgSVVzZXJQb29sIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWNvZ25pdG8nO1xuaW1wb3J0IHsgSVJvbGUgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtaWFtJztcbmltcG9ydCB7XG4gIEFwaUtleUF1dGhvcml6YXRpb25Db25maWcgYXMgQ0RLQXBpS2V5QXV0aG9yaXphdGlvbkNvbmZpZyxcbiAgQXV0aG9yaXphdGlvbk1vZGVzIGFzIENES0F1dGhvcml6YXRpb25Nb2RlcyxcbiAgSWRlbnRpdHlQb29sQXV0aG9yaXphdGlvbkNvbmZpZyBhcyBDREtJZGVudGl0eVBvb2xBdXRob3JpemF0aW9uQ29uZmlnLFxuICBMYW1iZGFBdXRob3JpemF0aW9uQ29uZmlnIGFzIENES0xhbWJkYUF1dGhvcml6YXRpb25Db25maWcsXG4gIE9JRENBdXRob3JpemF0aW9uQ29uZmlnIGFzIENES09JRENBdXRob3JpemF0aW9uQ29uZmlnLFxuICBVc2VyUG9vbEF1dGhvcml6YXRpb25Db25maWcgYXMgQ0RLVXNlclBvb2xBdXRob3JpemF0aW9uQ29uZmlnLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvZGF0YS1jb25zdHJ1Y3QnO1xuaW1wb3J0IHtcbiAgQW1wbGlmeURhdGFFcnJvcixcbiAgQXBpS2V5QXV0aG9yaXphdGlvbk1vZGVQcm9wcyxcbiAgQXV0aG9yaXphdGlvbk1vZGVzLFxuICBEZWZhdWx0QXV0aG9yaXphdGlvbk1vZGUsXG4gIExhbWJkYUF1dGhvcml6YXRpb25Nb2RlUHJvcHMsXG4gIE9JRENBdXRob3JpemF0aW9uTW9kZVByb3BzLFxufSBmcm9tICcuL3R5cGVzLmpzJztcbmltcG9ydCB7XG4gIEF1dGhSZXNvdXJjZXMsXG4gIENvbnN0cnVjdEZhY3RvcnlHZXRJbnN0YW5jZVByb3BzLFxuICBSZWZlcmVuY2VBdXRoUmVzb3VyY2VzLFxuICBSZXNvdXJjZVByb3ZpZGVyLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7IEFtcGxpZnlVc2VyRXJyb3IgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5cbmNvbnN0IERFRkFVTFRfQVBJX0tFWV9FWFBJUkFUSU9OX0RBWVMgPSA3O1xuY29uc3QgREVGQVVMVF9MQU1CREFfQVVUSF9USU1FX1RPX0xJVkVfU0VDT05EUyA9IDYwO1xuXG5leHBvcnQgdHlwZSBQcm92aWRlZEF1dGhDb25maWcgPSB7XG4gIHVzZXJQb29sOiBJVXNlclBvb2w7XG4gIGF1dGhlbnRpY2F0ZWRVc2VyUm9sZTogSVJvbGU7XG4gIHVuYXV0aGVudGljYXRlZFVzZXJSb2xlOiBJUm9sZTtcbiAgaWRlbnRpdHlQb29sSWQ6IHN0cmluZztcbn07XG5cbi8qKlxuICogRnVuY3Rpb24gaW5zdGFuY2UgcHJvdmlkZXIgd2hpY2ggdXNlcyB0aGVcbiAqL1xuZXhwb3J0IGNvbnN0IGJ1aWxkQ29uc3RydWN0RmFjdG9yeVByb3ZpZGVkQXV0aENvbmZpZyA9IChcbiAgYXV0aFJlc291cmNlUHJvdmlkZXI6XG4gICAgfCBSZXNvdXJjZVByb3ZpZGVyPEF1dGhSZXNvdXJjZXMgfCBSZWZlcmVuY2VBdXRoUmVzb3VyY2VzPlxuICAgIHwgdW5kZWZpbmVkLFxuKTogUHJvdmlkZWRBdXRoQ29uZmlnIHwgdW5kZWZpbmVkID0+IHtcbiAgaWYgKCFhdXRoUmVzb3VyY2VQcm92aWRlcikgcmV0dXJuO1xuICByZXR1cm4ge1xuICAgIHVzZXJQb29sOiBhdXRoUmVzb3VyY2VQcm92aWRlci5yZXNvdXJjZXMudXNlclBvb2wsXG4gICAgaWRlbnRpdHlQb29sSWQ6IGF1dGhSZXNvdXJjZVByb3ZpZGVyLnJlc291cmNlcy5pZGVudGl0eVBvb2xJZCxcbiAgICBhdXRoZW50aWNhdGVkVXNlclJvbGU6XG4gICAgICBhdXRoUmVzb3VyY2VQcm92aWRlci5yZXNvdXJjZXMuYXV0aGVudGljYXRlZFVzZXJJYW1Sb2xlLFxuICAgIHVuYXV0aGVudGljYXRlZFVzZXJSb2xlOlxuICAgICAgYXV0aFJlc291cmNlUHJvdmlkZXIucmVzb3VyY2VzLnVuYXV0aGVudGljYXRlZFVzZXJJYW1Sb2xlLFxuICB9O1xufTtcblxuLyoqXG4gKiBDb252ZXJ0IHRvIENESyBBcGlLZXlBdXRob3JpemF0aW9uQ29uZmlnLlxuICovXG5jb25zdCBjb252ZXJ0QXBpS2V5QXV0aENvbmZpZ1RvQ0RLID0gKHtcbiAgZGVzY3JpcHRpb24sXG4gIGV4cGlyZXNJbkRheXMgPSBERUZBVUxUX0FQSV9LRVlfRVhQSVJBVElPTl9EQVlTLFxufTogQXBpS2V5QXV0aG9yaXphdGlvbk1vZGVQcm9wcyA9IHt9KTogQ0RLQXBpS2V5QXV0aG9yaXphdGlvbkNvbmZpZyA9PiAoe1xuICBkZXNjcmlwdGlvbixcbiAgZXhwaXJlczogRHVyYXRpb24uZGF5cyhleHBpcmVzSW5EYXlzKSxcbn0pO1xuXG4vKipcbiAqIENvbnZlcnQgdG8gQ0RLIExhbWJkYUF1dGhvcml6YXRpb25Db25maWcuXG4gKi9cbmNvbnN0IGNvbnZlcnRMYW1iZGFBdXRob3JpemF0aW9uQ29uZmlnVG9DREsgPSAoXG4gIGdldEluc3RhbmNlUHJvcHM6IENvbnN0cnVjdEZhY3RvcnlHZXRJbnN0YW5jZVByb3BzLFxuICB7XG4gICAgZnVuY3Rpb246IGF1dGhGbixcbiAgICB0aW1lVG9MaXZlSW5TZWNvbmRzID0gREVGQVVMVF9MQU1CREFfQVVUSF9USU1FX1RPX0xJVkVfU0VDT05EUyxcbiAgfTogTGFtYmRhQXV0aG9yaXphdGlvbk1vZGVQcm9wcyxcbik6IENES0xhbWJkYUF1dGhvcml6YXRpb25Db25maWcgPT4gKHtcbiAgZnVuY3Rpb246IGF1dGhGbi5nZXRJbnN0YW5jZShnZXRJbnN0YW5jZVByb3BzKS5yZXNvdXJjZXMubGFtYmRhLFxuICB0dGw6IER1cmF0aW9uLnNlY29uZHModGltZVRvTGl2ZUluU2Vjb25kcyksXG59KTtcblxuLyoqXG4gKiBDb252ZXJ0IHRvIENESyBPSURDQXV0aG9yaXphdGlvbkNvbmZpZy5cbiAqL1xuY29uc3QgY29udmVydE9JRENBdXRoQ29uZmlnVG9DREsgPSAoe1xuICBvaWRjUHJvdmlkZXJOYW1lLFxuICBvaWRjSXNzdWVyVXJsLFxuICBjbGllbnRJZCxcbiAgdG9rZW5FeHBpcnlGcm9tQXV0aEluU2Vjb25kcyxcbiAgdG9rZW5FeHBpcmVGcm9tSXNzdWVJblNlY29uZHMsXG59OiBPSURDQXV0aG9yaXphdGlvbk1vZGVQcm9wcyk6IENES09JRENBdXRob3JpemF0aW9uQ29uZmlnID0+ICh7XG4gIG9pZGNQcm92aWRlck5hbWUsXG4gIG9pZGNJc3N1ZXJVcmwsXG4gIGNsaWVudElkLFxuICB0b2tlbkV4cGlyeUZyb21BdXRoOiBEdXJhdGlvbi5zZWNvbmRzKHRva2VuRXhwaXJ5RnJvbUF1dGhJblNlY29uZHMpLFxuICB0b2tlbkV4cGlyeUZyb21Jc3N1ZTogRHVyYXRpb24uc2Vjb25kcyh0b2tlbkV4cGlyZUZyb21Jc3N1ZUluU2Vjb25kcyksXG59KTtcblxuLyoqXG4gKiBDb21wdXRlIGRlZmF1bHQgYXV0aCBtb2RlIGJhc2VkIG9uIGF2YWlsYWJpbGl0eSBvZiBhdXRoIHJlc291cmNlcy5cbiAqXG4gKiBXaWxsIGRlZmF1bHQgdG8gdXNlclBvb2wgaWYgdXNlclBvb2wgaXMgcHJvdmlkZWQgYW5kIGF1dGggcmVzb3VyY2VzIGFyZSBub3QgcHJvdmlkZWQuXG4gKlxuICogSWYgbm8gYXV0aCByZXNvdXJjZXMgYXJlIHByb3ZpZGVkIGFuZCB0aGVyZSdzIG9ubHkgb25lIG1vZGUgd2UnbGwgdXNlIHRoYXQgYXMgd2UgaW1wbGljaXRseSBhbHdheXMgYWRkIGlhbSBhdXRoLlxuICovXG5jb25zdCBjb21wdXRlRGVmYXVsdEF1dGhvcml6YXRpb25Nb2RlID0gKFxuICBwcm92aWRlZEF1dGhDb25maWc6IFByb3ZpZGVkQXV0aENvbmZpZyB8IHVuZGVmaW5lZCxcbiAgYXV0aE1vZGVzOiBBdXRob3JpemF0aW9uTW9kZXMgfCB1bmRlZmluZWQsXG4pOiBEZWZhdWx0QXV0aG9yaXphdGlvbk1vZGUgfCB1bmRlZmluZWQgPT4ge1xuICBpZiAoaXNVc2luZ0RlZmF1bHRBcGlLZXlBdXRoKHByb3ZpZGVkQXV0aENvbmZpZywgYXV0aE1vZGVzKSkge1xuICAgIHJldHVybiAnYXBpS2V5JztcbiAgfSBlbHNlIGlmIChwcm92aWRlZEF1dGhDb25maWcgJiYgIWF1dGhNb2Rlcykge1xuICAgIHJldHVybiAndXNlclBvb2wnO1xuICB9IGVsc2UgaWYgKFxuICAgICFwcm92aWRlZEF1dGhDb25maWcgJiZcbiAgICBhdXRoTW9kZXMgJiZcbiAgICBPYmplY3Qua2V5cyhhdXRoTW9kZXMpLmxlbmd0aCA9PT0gMVxuICApIHtcbiAgICBpZiAoYXV0aE1vZGVzLm9pZGNBdXRob3JpemF0aW9uTW9kZSkge1xuICAgICAgcmV0dXJuICdvaWRjJztcbiAgICB9IGVsc2UgaWYgKGF1dGhNb2Rlcy5sYW1iZGFBdXRob3JpemF0aW9uTW9kZSkge1xuICAgICAgcmV0dXJuICdsYW1iZGEnO1xuICAgIH0gZWxzZSBpZiAoYXV0aE1vZGVzLmFwaUtleUF1dGhvcml6YXRpb25Nb2RlKSB7XG4gICAgICByZXR1cm4gJ2FwaUtleSc7XG4gICAgfVxuICB9XG4gIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yPEFtcGxpZnlEYXRhRXJyb3I+KCdEZWZpbmVEYXRhQ29uZmlndXJhdGlvbkVycm9yJywge1xuICAgIG1lc3NhZ2U6XG4gICAgICAnQSBkZWZhdWx0QXV0aG9yaXphdGlvbk1vZGUgaXMgcmVxdWlyZWQgaWYgbXVsdGlwbGUgYXV0aG9yaXphdGlvbiBtb2RlcyBhcmUgY29uZmlndXJlZCcsXG4gICAgcmVzb2x1dGlvbjpcbiAgICAgIFwiV2hlbiBjYWxsaW5nICdkZWZpbmVEYXRhJyBzcGVjaWZ5ICdhdXRob3JpemF0aW9uTW9kZXMuZGVmYXVsdEF1dGhvcml6YXRpb25Nb2RlJ1wiLFxuICB9KTtcbn07XG5cbi8qKlxuICogQ29tcHV0ZSB1c2VyIHBvb2wgYXV0aCBjb25maWcgZnJvbSBhdXRoIHJlc291cmNlIHByb3ZpZGVyLlxuICogQHJldHVybnMgYSB1c2VyIHBvb2wgYXV0aCBjb25maWcsIGlmIHJlbGV2YW50XG4gKi9cbmNvbnN0IGNvbXB1dGVVc2VyUG9vbEF1dGhGcm9tUmVzb3VyY2UgPSAoXG4gIHByb3ZpZGVkQXV0aENvbmZpZzogUHJvdmlkZWRBdXRoQ29uZmlnIHwgdW5kZWZpbmVkLFxuKTogQ0RLVXNlclBvb2xBdXRob3JpemF0aW9uQ29uZmlnIHwgdW5kZWZpbmVkID0+IHtcbiAgaWYgKHByb3ZpZGVkQXV0aENvbmZpZykge1xuICAgIHJldHVybiB7IHVzZXJQb29sOiBwcm92aWRlZEF1dGhDb25maWcudXNlclBvb2wgfTtcbiAgfVxuICByZXR1cm47XG59O1xuXG4vKipcbiAqIENvbXB1dGUgaWRlbnRpdHkgcG9vbCBhdXRoIGNvbmZpZyBmcm9tIGF1dGggcmVzb3VyY2UgcHJvdmlkZXIuXG4gKiBAcmV0dXJucyBhbiBpYW0gYXV0aCBjb25maWcsIGlmIHJlbGV2YW50XG4gKi9cbmNvbnN0IGNvbXB1dGVJZGVudGl0eVBvb2xBdXRoRnJvbVJlc291cmNlID0gKFxuICBwcm92aWRlZEF1dGhDb25maWc6IFByb3ZpZGVkQXV0aENvbmZpZyB8IHVuZGVmaW5lZCxcbik6IENES0lkZW50aXR5UG9vbEF1dGhvcml6YXRpb25Db25maWcgfCB1bmRlZmluZWQgPT4ge1xuICBpZiAocHJvdmlkZWRBdXRoQ29uZmlnKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGF1dGhlbnRpY2F0ZWRVc2VyUm9sZTogcHJvdmlkZWRBdXRoQ29uZmlnLmF1dGhlbnRpY2F0ZWRVc2VyUm9sZSxcbiAgICAgIHVuYXV0aGVudGljYXRlZFVzZXJSb2xlOiBwcm92aWRlZEF1dGhDb25maWcudW5hdXRoZW50aWNhdGVkVXNlclJvbGUsXG4gICAgICBpZGVudGl0eVBvb2xJZDogcHJvdmlkZWRBdXRoQ29uZmlnLmlkZW50aXR5UG9vbElkLFxuICAgIH07XG4gIH1cbiAgcmV0dXJuO1xufTtcblxuLyoqXG4gKiBDb21wdXRlIGFwaSBrZXkgYXV0aCBjb25maWcgZnJvbSBhdXRoIHJlc291cmNlIHByb3ZpZGVyLlxuICogQHJldHVybnMgYW4gYXBpIGtleSBhdXRoIGNvbmZpZywgaWYgcmVsZXZhbnRcbiAqL1xuY29uc3QgY29tcHV0ZUFwaUtleUF1dGhGcm9tUmVzb3VyY2UgPSAoXG4gIHByb3ZpZGVkQXV0aENvbmZpZzogUHJvdmlkZWRBdXRoQ29uZmlnIHwgdW5kZWZpbmVkLFxuICBhdXRoTW9kZXM6IEF1dGhvcml6YXRpb25Nb2RlcyB8IHVuZGVmaW5lZCxcbik6IENES0FwaUtleUF1dGhvcml6YXRpb25Db25maWcgfCB1bmRlZmluZWQgPT4ge1xuICBpZiAoaXNVc2luZ0RlZmF1bHRBcGlLZXlBdXRoKHByb3ZpZGVkQXV0aENvbmZpZywgYXV0aE1vZGVzKSkge1xuICAgIHJldHVybiB7XG4gICAgICBleHBpcmVzOiBEdXJhdGlvbi5kYXlzKERFRkFVTFRfQVBJX0tFWV9FWFBJUkFUSU9OX0RBWVMpLFxuICAgIH07XG4gIH1cbiAgcmV0dXJuO1xufTtcblxuY29uc3QgYXV0aG9yaXphdGlvbk1vZGVNYXBwaW5nID0ge1xuICBpYW06ICdBV1NfSUFNJyxcbiAgaWRlbnRpdHlQb29sOiAnQVdTX0lBTScsXG4gIHVzZXJQb29sOiAnQU1BWk9OX0NPR05JVE9fVVNFUl9QT09MUycsXG4gIG9pZGM6ICdPUEVOSURfQ09OTkVDVCcsXG4gIGFwaUtleTogJ0FQSV9LRVknLFxuICBsYW1iZGE6ICdBV1NfTEFNQkRBJyxcbn0gYXMgY29uc3Q7XG5cbmNvbnN0IGNvbnZlcnRBdXRob3JpemF0aW9uTW9kZVRvQ0RLID0gKG1vZGU/OiBEZWZhdWx0QXV0aG9yaXphdGlvbk1vZGUpID0+IHtcbiAgaWYgKCFtb2RlKSByZXR1cm47XG5cbiAgcmV0dXJuIGF1dGhvcml6YXRpb25Nb2RlTWFwcGluZ1ttb2RlXTtcbn07XG5cbi8qKlxuICogQ29udmVydCB0byBDREsgQXV0aG9yaXphdGlvbk1vZGVzLlxuICovXG5leHBvcnQgY29uc3QgY29udmVydEF1dGhvcml6YXRpb25Nb2Rlc1RvQ0RLID0gKFxuICBnZXRJbnN0YW5jZVByb3BzOiBDb25zdHJ1Y3RGYWN0b3J5R2V0SW5zdGFuY2VQcm9wcyxcbiAgYXV0aFJlc291cmNlczogUHJvdmlkZWRBdXRoQ29uZmlnIHwgdW5kZWZpbmVkLFxuICBhdXRoTW9kZXM6IEF1dGhvcml6YXRpb25Nb2RlcyB8IHVuZGVmaW5lZCxcbik6IENES0F1dGhvcml6YXRpb25Nb2RlcyA9PiB7XG4gIGNvbnN0IGRlZmF1bHRBdXRob3JpemF0aW9uTW9kZSA9XG4gICAgYXV0aE1vZGVzPy5kZWZhdWx0QXV0aG9yaXphdGlvbk1vZGUgPz9cbiAgICBjb21wdXRlRGVmYXVsdEF1dGhvcml6YXRpb25Nb2RlKGF1dGhSZXNvdXJjZXMsIGF1dGhNb2Rlcyk7XG4gIGNvbnN0IGNka0F1dGhvcml6YXRpb25Nb2RlID0gY29udmVydEF1dGhvcml6YXRpb25Nb2RlVG9DREsoXG4gICAgZGVmYXVsdEF1dGhvcml6YXRpb25Nb2RlLFxuICApO1xuICBjb25zdCBhcGlLZXlDb25maWcgPVxuICAgIGF1dGhNb2Rlcz8uYXBpS2V5QXV0aG9yaXphdGlvbk1vZGUgfHxcbiAgICAvLyBJZiBkZWZhdWx0IGF1dGggbW9kZSBpcyBhcGlLZXksIGRvbid0IHJlcXVpcmUgYXBpS2V5QXV0aG9yaXphdGlvbk1vZGUgdG8gYmUgZGVmaW5lZFxuICAgIGRlZmF1bHRBdXRob3JpemF0aW9uTW9kZSA9PT0gJ2FwaUtleSdcbiAgICAgID8gY29udmVydEFwaUtleUF1dGhDb25maWdUb0NESyhhdXRoTW9kZXM/LmFwaUtleUF1dGhvcml6YXRpb25Nb2RlKVxuICAgICAgOiBjb21wdXRlQXBpS2V5QXV0aEZyb21SZXNvdXJjZShhdXRoUmVzb3VyY2VzLCBhdXRoTW9kZXMpO1xuICBjb25zdCB1c2VyUG9vbENvbmZpZyA9IGNvbXB1dGVVc2VyUG9vbEF1dGhGcm9tUmVzb3VyY2UoYXV0aFJlc291cmNlcyk7XG4gIGNvbnN0IGlkZW50aXR5UG9vbENvbmZpZyA9IGNvbXB1dGVJZGVudGl0eVBvb2xBdXRoRnJvbVJlc291cmNlKGF1dGhSZXNvdXJjZXMpO1xuICBjb25zdCBsYW1iZGFDb25maWcgPSBhdXRoTW9kZXM/LmxhbWJkYUF1dGhvcml6YXRpb25Nb2RlXG4gICAgPyBjb252ZXJ0TGFtYmRhQXV0aG9yaXphdGlvbkNvbmZpZ1RvQ0RLKFxuICAgICAgICBnZXRJbnN0YW5jZVByb3BzLFxuICAgICAgICBhdXRoTW9kZXMubGFtYmRhQXV0aG9yaXphdGlvbk1vZGUsXG4gICAgICApXG4gICAgOiB1bmRlZmluZWQ7XG4gIGNvbnN0IG9pZGNDb25maWcgPSBhdXRoTW9kZXM/Lm9pZGNBdXRob3JpemF0aW9uTW9kZVxuICAgID8gY29udmVydE9JRENBdXRoQ29uZmlnVG9DREsoYXV0aE1vZGVzLm9pZGNBdXRob3JpemF0aW9uTW9kZSlcbiAgICA6IHVuZGVmaW5lZDtcblxuICByZXR1cm4ge1xuICAgIC4uLihjZGtBdXRob3JpemF0aW9uTW9kZVxuICAgICAgPyB7IGRlZmF1bHRBdXRob3JpemF0aW9uTW9kZTogY2RrQXV0aG9yaXphdGlvbk1vZGUgfVxuICAgICAgOiB1bmRlZmluZWQpLFxuICAgIC4uLihhcGlLZXlDb25maWcgPyB7IGFwaUtleUNvbmZpZyB9IDogdW5kZWZpbmVkKSxcbiAgICAuLi4odXNlclBvb2xDb25maWcgPyB7IHVzZXJQb29sQ29uZmlnIH0gOiB1bmRlZmluZWQpLFxuICAgIC4uLihpZGVudGl0eVBvb2xDb25maWcgPyB7IGlkZW50aXR5UG9vbENvbmZpZyB9IDogdW5kZWZpbmVkKSxcbiAgICAuLi4obGFtYmRhQ29uZmlnID8geyBsYW1iZGFDb25maWcgfSA6IHVuZGVmaW5lZCksXG4gICAgLi4uKG9pZGNDb25maWcgPyB7IG9pZGNDb25maWcgfSA6IHVuZGVmaW5lZCksXG4gICAgaWFtQ29uZmlnOiB7XG4gICAgICBlbmFibGVJYW1BdXRob3JpemF0aW9uTW9kZTogdHJ1ZSxcbiAgICB9LFxuICB9O1xufTtcblxuLyoqXG4gKiBSZXR1cm4gd2hldGhlciBvciBub3QgdGhlIGFwaSB3aWxsIHVzZSBkZWZhdWx0IEFQSV9LRVkgYXV0aCBkdWUgdG8gYWJzZW5jZSBvZiBhdXRoIHJlc291cmNlcyBhbmQgaW5wdXQgYXV0aC1tb2Rlcy5cbiAqIEBwYXJhbSBhdXRoUmVzb3VyY2VzIHRoZSBnZW5lcmF0ZWQgYXV0aCByZXNvdXJjZXMgaW4gdGhlIHN5c3RlbVxuICogQHBhcmFtIGF1dGhNb2RlcyB0aGUgcHJvdmlkZWQgYXV0aCBtb2Rlc1xuICogQHJldHVybnMgYSBib29sZWFuIGluZGljYXRpbmcgd2hldGhlciBvciBub3QgZGVmYXVsdCBhcGkga2V5IGF1dGggd2lsbCBiZSB1c2VkLlxuICovXG5leHBvcnQgY29uc3QgaXNVc2luZ0RlZmF1bHRBcGlLZXlBdXRoID0gKFxuICBhdXRoUmVzb3VyY2VzOiBQcm92aWRlZEF1dGhDb25maWcgfCB1bmRlZmluZWQsXG4gIGF1dGhNb2RlczogQXV0aG9yaXphdGlvbk1vZGVzIHwgdW5kZWZpbmVkLFxuKTogYm9vbGVhbiA9PiB7XG4gIHJldHVybiBhdXRoTW9kZXMgPT09IHVuZGVmaW5lZCAmJiBhdXRoUmVzb3VyY2VzID09PSB1bmRlZmluZWQ7XG59O1xuIl19