import { SecretError } from './secret_error.js';
import { AmplifyFault, AmplifyUserError } from '@aws-amplify/platform-core';
import { SSMServiceException } from '@aws-sdk/client-ssm';
/**
 * Handles errors and translate them to AmplifyUserError or AmplifyFaults
 * To be used exclusively by the amplify cli
 */
export class SSMSecretClientWithAmplifyErrorHandling {
    secretClient;
    /**
     * wraps the secretClient with Amplify CLI specific error handling
     */
    constructor(secretClient) {
        this.secretClient = secretClient;
    }
    getSecret = async (backendIdentifier, secretIdentifier) => {
        try {
            return await this.secretClient.getSecret(backendIdentifier, secretIdentifier);
        }
        catch (e) {
            throw this.translateToAmplifyError(e, 'Get', secretIdentifier);
        }
    };
    listSecrets = async (backendIdentifier) => {
        try {
            return await this.secretClient.listSecrets(backendIdentifier);
        }
        catch (e) {
            throw this.translateToAmplifyError(e, 'List');
        }
    };
    setSecret = async (backendIdentifier, secretName, secretValue) => {
        try {
            return await this.secretClient.setSecret(backendIdentifier, secretName, secretValue);
        }
        catch (e) {
            throw this.translateToAmplifyError(e, 'Set');
        }
    };
    removeSecret = async (backendIdentifier, secretName) => {
        try {
            return await this.secretClient.removeSecret(backendIdentifier, secretName);
        }
        catch (e) {
            throw this.translateToAmplifyError(e, 'Remove', { name: secretName });
        }
    };
    /**
     * Remove secrets from SSM parameter store.
     */
    removeSecrets = async (backendIdentifier, secretNames) => {
        try {
            return await this.secretClient.removeSecrets(backendIdentifier, secretNames);
        }
        catch (e) {
            throw this.translateToAmplifyError(e, 'Remove');
        }
    };
    translateToAmplifyError = (error, apiName, secretIdentifier) => {
        if (error instanceof SecretError && error.cause) {
            if ([
                'UnrecognizedClientException',
                'AccessDeniedException',
                'NotAuthorized',
                'ExpiredTokenException',
                'ExpiredToken',
                'CredentialsProviderError',
                'IncompleteSignatureException',
                'InvalidSignatureException',
            ].includes(error.cause.name)) {
                return new AmplifyUserError('SSMCredentialsError', {
                    message: `Failed to ${apiName.toLowerCase()} secrets. ${error.cause.name}: ${error.cause?.message}`,
                    resolution: 'Make sure your AWS credentials are set up correctly, refreshed and have necessary permissions to call SSM service',
                });
            }
            if (error.cause.message.includes('connect ENOMEM')) {
                return new AmplifyUserError('InsufficientMemorySpaceError', {
                    message: `Failed to ${apiName.toLowerCase()} secrets. ${error.cause.name}: ${error.cause?.message}`,
                    resolution: 'There appears to be insufficient memory on your system to finish. Close other applications or restart your system and try again.',
                });
            }
            if (error.cause.name === 'ParameterNotFound' &&
                (apiName === 'Get' || apiName === 'Remove') &&
                secretIdentifier) {
                return new AmplifyUserError('SSMParameterNotFoundError', {
                    message: `Failed to ${apiName.toLowerCase()} ${secretIdentifier.name} secret. ${error.cause.name}: ${error.cause?.message}`,
                    resolution: `Make sure that ${secretIdentifier.name} has been set. See https://docs.amplify.aws/react/deploy-and-host/fullstack-branching/secrets-and-vars/.`,
                });
            }
            let downstreamException = error;
            if (!(error.cause instanceof SSMServiceException) &&
                error.cause instanceof Error) {
                downstreamException = error.cause;
            }
            throw new AmplifyFault(`${apiName}SecretsFailedFault`, {
                message: `Failed to ${apiName.toLowerCase()} secrets. ${error.cause.name}: ${error.cause?.message}`,
            }, downstreamException);
        }
        return error;
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3NtX3NlY3JldF93aXRoX2FtcGxpZnlfZXJyb3JfaGFuZGxpbmcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvc3NtX3NlY3JldF93aXRoX2FtcGxpZnlfZXJyb3JfaGFuZGxpbmcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBT0EsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxZQUFZLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUM1RSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUUxRDs7O0dBR0c7QUFDSCxNQUFNLE9BQU8sdUNBQXVDO0lBSXJCO0lBSDdCOztPQUVHO0lBQ0gsWUFBNkIsWUFBMEI7UUFBMUIsaUJBQVksR0FBWixZQUFZLENBQWM7SUFBRyxDQUFDO0lBRTNELFNBQVMsR0FBRyxLQUFLLEVBQ2YsaUJBQTRDLEVBQzVDLGdCQUFrQyxFQUNqQixFQUFFO1FBQ25CLElBQUksQ0FBQztZQUNILE9BQU8sTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FDdEMsaUJBQWlCLEVBQ2pCLGdCQUFnQixDQUNqQixDQUFDO1FBQ0osQ0FBQztRQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7WUFDWCxNQUFNLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDLEVBQUUsS0FBSyxFQUFFLGdCQUFnQixDQUFDLENBQUM7UUFDakUsQ0FBQztJQUNILENBQUMsQ0FBQztJQUVGLFdBQVcsR0FBRyxLQUFLLEVBQ2pCLGlCQUE0QyxFQUNqQixFQUFFO1FBQzdCLElBQUksQ0FBQztZQUNILE9BQU8sTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBQ2hFLENBQUM7UUFBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1lBQ1gsTUFBTSxJQUFJLENBQUMsdUJBQXVCLENBQUMsQ0FBQyxFQUFFLE1BQU0s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QUFDLDJCQUEyQixFQUFFO29CQUN2RCxPQUFPLEVBQUUsYUFBYSxPQUFPLENBQUMsV0FBVyxFQUFFLElBQ3pDLGdCQUFnQixDQUFDLElBQ25CLFlBQVksS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLEtBQUssS0FBSyxDQUFDLEtBQUssRUFBRSxPQUFPLEVBQUU7b0JBQ3ZELFVBQVUsRUFBRSxrQkFBa0IsZ0JBQWdCLENBQUMsSUFBSSwwR0FBMEc7aUJBQzlKLENBQUMsQ0FBQztZQUNMLENBQUM7WUFDRCxJQUFJLG1CQUFtQixHQUFVLEtBQUssQ0FBQztZQUN2QyxJQUNFLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxZQUFZLG1CQUFtQixDQUFDO2dCQUM3QyxLQUFLLENBQUMsS0FBSyxZQUFZLEtBQUssRUFDNUIsQ0FBQztnQkFDRCxtQkFBbUIsR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDO1lBQ3BDLENBQUM7WUFDRCxNQUFNLElBQUksWUFBWSxDQUNwQixHQUFHLE9BQU8sb0JBQW9CLEVBQzlCO2dCQUNFLE9BQU8sRUFBRSxhQUFhLE9BQU8sQ0FBQyxXQUFXLEVBQUUsYUFDekMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUNkLEtBQUssS0FBSyxDQUFDLEtBQUssRUFBRSxPQUFPLEVBQUU7YUFDNUIsRUFDRCxtQkFBbUIsQ0FDcEIsQ0FBQztRQUNKLENBQUM7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUMsQ0FBQztDQUNIIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwSWQsIEJhY2tlbmRJZGVudGlmaWVyIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQge1xuICBTZWNyZXQsXG4gIFNlY3JldENsaWVudCxcbiAgU2VjcmV0SWRlbnRpZmllcixcbiAgU2VjcmV0TGlzdEl0ZW0sXG59IGZyb20gJy4vc2VjcmV0LmpzJztcbmltcG9ydCB7IFNlY3JldEVycm9yIH0gZnJvbSAnLi9zZWNyZXRfZXJyb3IuanMnO1xuaW1wb3J0IHsgQW1wbGlmeUZhdWx0LCBBbXBsaWZ5VXNlckVycm9yIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsYXRmb3JtLWNvcmUnO1xuaW1wb3J0IHsgU1NNU2VydmljZUV4Y2VwdGlvbiB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zc20nO1xuXG4vKipcbiAqIEhhbmRsZXMgZXJyb3JzIGFuZCB0cmFuc2xhdGUgdGhlbSB0byBBbXBsaWZ5VXNlckVycm9yIG9yIEFtcGxpZnlGYXVsdHNcbiAqIFRvIGJlIHVzZWQgZXhjbHVzaXZlbHkgYnkgdGhlIGFtcGxpZnkgY2xpXG4gKi9cbmV4cG9ydCBjbGFzcyBTU01TZWNyZXRDbGllbnRXaXRoQW1wbGlmeUVycm9ySGFuZGxpbmcgaW1wbGVtZW50cyBTZWNyZXRDbGllbnQge1xuICAvKipcbiAgICogd3JhcHMgdGhlIHNlY3JldENsaWVudCB3aXRoIEFtcGxpZnkgQ0xJIHNwZWNpZmljIGVycm9yIGhhbmRsaW5nXG4gICAqL1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHNlY3JldENsaWVudDogU2VjcmV0Q2xpZW50KSB7fVxuXG4gIGdldFNlY3JldCA9IGFzeW5jIChcbiAgICBiYWNrZW5kSWRlbnRpZmllcjogQmFja2VuZElkZW50aWZpZXIgfCBBcHBJZCxcbiAgICBzZWNyZXRJZGVudGlmaWVyOiBTZWNyZXRJZGVudGlmaWVyLFxuICApOiBQcm9taXNlPFNlY3JldD4gPT4ge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5zZWNyZXRDbGllbnQuZ2V0U2VjcmV0KFxuICAgICAgICBiYWNrZW5kSWRlbnRpZmllcixcbiAgICAgICAgc2VjcmV0SWRlbnRpZmllcixcbiAgICAgICk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cgdGhpcy50cmFuc2xhdGVUb0FtcGxpZnlFcnJvcihlLCAnR2V0Jywgc2VjcmV0SWRlbnRpZmllcik7XG4gICAgfVxuICB9O1xuXG4gIGxpc3RTZWNyZXRzID0gYXN5bmMgKFxuICAgIGJhY2tlbmRJZGVudGlmaWVyOiBCYWNrZW5kSWRlbnRpZmllciB8IEFwcElkLFxuICApOiBQcm9taXNlPFNlY3JldExpc3RJdGVtW10+ID0+IHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuc2VjcmV0Q2xpZW50Lmxpc3RTZWNyZXRzKGJhY2tlbmRJZGVudGlmaWVyKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyB0aGlzLnRyYW5zbGF0ZVRvQW1wbGlmeUVycm9yKGUsICdMaXN0Jyk7XG4gICAgfVxuICB9O1xuXG4gIHNldFNlY3JldCA9IGFzeW5jIChcbiAgICBiYWNrZW5kSWRlbnRpZmllcjogQmFja2VuZElkZW50aWZpZXIgfCBBcHBJZCxcbiAgICBzZWNyZXROYW1lOiBzdHJpbmcsXG4gICAgc2VjcmV0VmFsdWU6IHN0cmluZyxcbiAgKTogUHJvbWlzZTxTZWNyZXRJZGVudGlmaWVyPiA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnNlY3JldENsaWVudC5zZXRTZWNyZXQoXG4gICAgICAgIGJhY2tlbmRJZGVudGlmaWVyLFxuICAgICAgICBzZWNyZXROYW1lLFxuICAgICAgICBzZWNyZXRWYWx1ZSxcbiAgICAgICk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cgdGhpcy50cmFuc2xhdGVUb0FtcGxpZnlFcnJvcihlLCAnU2V0Jyk7XG4gICAgfVxuICB9O1xuXG4gIHJlbW92ZVNlY3JldCA9IGFzeW5jIChcbiAgICBiYWNrZW5kSWRlbnRpZmllcjogQmFja2VuZElkZW50aWZpZXIgfCBBcHBJZCxcbiAgICBzZWNyZXROYW1lOiBzdHJpbmcsXG4gICk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5zZWNyZXRDbGllbnQucmVtb3ZlU2VjcmV0KFxuICAgICAgICBiYWNrZW5kSWRlbnRpZmllcixcbiAgICAgICAgc2VjcmV0TmFtZSxcbiAgICAgICk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cgdGhpcy50cmFuc2xhdGVUb0FtcGxpZnlFcnJvcihlLCAnUmVtb3ZlJywgeyBuYW1lOiBzZWNyZXROYW1lIH0pO1xuICAgIH1cbiAgfTtcblxuICAvKipcbiAgICogUmVtb3ZlIHNlY3JldHMgZnJvbSBTU00gcGFyYW1ldGVyIHN0b3JlLlxuICAgKi9cbiAgcHVibGljIHJlbW92ZVNlY3JldHMgPSBhc3luYyAoXG4gICAgYmFja2VuZElkZW50aWZpZXI6IEJhY2tlbmRJZGVudGlmaWVyIHwgQXBwSWQsXG4gICAgc2VjcmV0TmFtZXM6IHN0cmluZ1tdLFxuICApID0+IHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuc2VjcmV0Q2xpZW50LnJlbW92ZVNlY3JldHMoXG4gICAgICAgIGJhY2tlbmRJZGVudGlmaWVyLFxuICAgICAgICBzZWNyZXROYW1lcyxcbiAgICAgICk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cgdGhpcy50cmFuc2xhdGVUb0FtcGxpZnlFcnJvcihlLCAnUmVtb3ZlJyk7XG4gICAgfVxuICB9O1xuXG4gIHByaXZhdGUgdHJhbnNsYXRlVG9BbXBsaWZ5RXJyb3IgPSAoXG4gICAgZXJyb3I6IHVua25vd24sXG4gICAgYXBpTmFtZTogc3RyaW5nLFxuICAgIHNlY3JldElkZW50aWZpZXI/OiBTZWNyZXRJZGVudGlmaWVyLFxuICApID0+IHtcbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBTZWNyZXRFcnJvciAmJiBlcnJvci5jYXVzZSkge1xuICAgICAgaWYgKFxuICAgICAgICBbXG4gICAgICAgICAgJ1VucmVjb2duaXplZENsaWVudEV4Y2VwdGlvbicsXG4gICAgICAgICAgJ0FjY2Vzc0RlbmllZEV4Y2VwdGlvbicsXG4gICAgICAgICAgJ05vdEF1dGhvcml6ZWQnLFxuICAgICAgICAgICdFeHBpcmVkVG9rZW5FeGNlcHRpb24nLFxuICAgICAgICAgICdFeHBpcmVkVG9rZW4nLFxuICAgICAgICAgICdDcmVkZW50aWFsc1Byb3ZpZGVyRXJyb3InLFxuICAgICAgICAgICdJbmNvbXBsZXRlU2lnbmF0dXJlRXhjZXB0aW9uJyxcbiAgICAgICAgICAnSW52YWxpZFNpZ25hdHVyZUV4Y2VwdGlvbicsXG4gICAgICAgIF0uaW5jbHVkZXMoZXJyb3IuY2F1c2UubmFtZSlcbiAgICAgICkge1xuICAgICAgICByZXR1cm4gbmV3IEFtcGxpZnlVc2VyRXJyb3IoJ1NTTUNyZWRlbnRpYWxzRXJyb3InLCB7XG4gICAgICAgICAgbWVzc2FnZTogYEZhaWxlZCB0byAke2FwaU5hbWUudG9Mb3dlckNhc2UoKX0gc2VjcmV0cy4gJHtcbiAgICAgICAgICAgIGVycm9yLmNhdXNlLm5hbWVcbiAgICAgICAgICB9OiAke2Vycm9yLmNhdXNlPy5tZXNzYWdlfWAsXG4gICAgICAgICAgcmVzb2x1dGlvbjpcbiAgICAgICAgICAgICdNYWtlIHN1cmUgeW91ciBBV1MgY3JlZGVudGlhbHMgYXJlIHNldCB1cCBjb3JyZWN0bHksIHJlZnJlc2hlZCBhbmQgaGF2ZSBuZWNlc3NhcnkgcGVybWlzc2lvbnMgdG8gY2FsbCBTU00gc2VydmljZScsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgaWYgKGVycm9yLmNhdXNlLm1lc3NhZ2UuaW5jbHVkZXMoJ2Nvbm5lY3QgRU5PTUVNJykpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBBbXBsaWZ5VXNlckVycm9yKCdJbnN1ZmZpY2llbnRNZW1vcnlTcGFjZUVycm9yJywge1xuICAgICAgICAgIG1lc3NhZ2U6IGBGYWlsZWQgdG8gJHthcGlOYW1lLnRvTG93ZXJDYXNlKCl9IHNlY3JldHMuICR7XG4gICAgICAgICAgICBlcnJvci5jYXVzZS5uYW1lXG4gICAgICAgICAgfTogJHtlcnJvci5jYXVzZT8ubWVzc2FnZX1gLFxuICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAnVGhlcmUgYXBwZWFycyB0byBiZSBpbnN1ZmZpY2llbnQgbWVtb3J5IG9uIHlvdXIgc3lzdGVtIHRvIGZpbmlzaC4gQ2xvc2Ugb3RoZXIgYXBwbGljYXRpb25zIG9yIHJlc3RhcnQgeW91ciBzeXN0ZW0gYW5kIHRyeSBhZ2Fpbi4nLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIGlmIChcbiAgICAgICAgZXJyb3IuY2F1c2UubmFtZSA9PT0gJ1BhcmFtZXRlck5vdEZvdW5kJyAmJlxuICAgICAgICAoYXBpTmFtZSA9PT0gJ0dldCcgfHwgYXBpTmFtZSA9PT0gJ1JlbW92ZScpICYmXG4gICAgICAgIHNlY3JldElkZW50aWZpZXJcbiAgICAgICkge1xuICAgICAgICByZXR1cm4gbmV3IEFtcGxpZnlVc2VyRXJyb3IoJ1NTTVBhcmFtZXRlck5vdEZvdW5kRXJyb3InLCB7XG4gICAgICAgICAgbWVzc2FnZTogYEZhaWxlZCB0byAke2FwaU5hbWUudG9Mb3dlckNhc2UoKX0gJHtcbiAgICAgICAgICAgIHNlY3JldElkZW50aWZpZXIubmFtZVxuICAgICAgICAgIH0gc2VjcmV0LiAke2Vycm9yLmNhdXNlLm5hbWV9OiAke2Vycm9yLmNhdXNlPy5tZXNzYWdlfWAsXG4gICAgICAgICAgcmVzb2x1dGlvbjogYE1ha2Ugc3VyZSB0aGF0ICR7c2VjcmV0SWRlbnRpZmllci5uYW1lfSBoYXMgYmVlbiBzZXQuIFNlZSBodHRwczovL2RvY3MuYW1wbGlmeS5hd3MvcmVhY3QvZGVwbG95LWFuZC1ob3N0L2Z1bGxzdGFjay1icmFuY2hpbmcvc2VjcmV0cy1hbmQtdmFycy8uYCxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBsZXQgZG93bnN0cmVhbUV4Y2VwdGlvbjogRXJyb3IgPSBlcnJvcjtcbiAgICAgIGlmIChcbiAgICAgICAgIShlcnJvci5jYXVzZSBpbnN0YW5jZW9mIFNTTVNlcnZpY2VFeGNlcHRpb24pICYmXG4gICAgICAgIGVycm9yLmNhdXNlIGluc3RhbmNlb2YgRXJyb3JcbiAgICAgICkge1xuICAgICAgICBkb3duc3RyZWFtRXhjZXB0aW9uID0gZXJyb3IuY2F1c2U7XG4gICAgICB9XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeUZhdWx0KFxuICAgICAgICBgJHthcGlOYW1lfVNlY3JldHNGYWlsZWRGYXVsdGAsXG4gICAgICAgIHtcbiAgICAgICAgICBtZXNzYWdlOiBgRmFpbGVkIHRvICR7YXBpTmFtZS50b0xvd2VyQ2FzZSgpfSBzZWNyZXRzLiAke1xuICAgICAgICAgICAgZXJyb3IuY2F1c2UubmFtZVxuICAgICAgICAgIH06ICR7ZXJyb3IuY2F1c2U/Lm1lc3NhZ2V9YCxcbiAgICAgICAgfSxcbiAgICAgICAgZG93bnN0cmVhbUV4Y2VwdGlvbixcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBlcnJvcjtcbiAgfTtcbn1cbiJdfQ==