/**
 * This code loads environment values from SSM and places them in their corresponding environment variables.
 * If there are no SSM environment values for this function, this is a noop.
 *
 * We include the cjs shim here because it is required for the ssm shim to work both in the lambda and in tests
 */
// cjs shim
import { createRequire } from 'node:module';
import path from 'node:path';
import url from 'node:url';
global.require = createRequire(import.meta.url);
global.__filename = url.fileURLToPath(import.meta.url);
global.__dirname = path.dirname(__filename);
// aws-sdk v2 does not play nice with normal ESM imports so we have to use require here
// eslint-disable-next-line @typescript-eslint/no-require-imports
const aws = require('aws-sdk');
/**
 * Reads SSM environment context from a known Amplify environment variable,
 * fetches values from SSM and places those values in the corresponding environment variables
 */
export const internalAmplifyFunctionResolveSsmParams = async (client = new aws.SSM()) => {
    const envPathObject = JSON.parse(process.env.AMPLIFY_SSM_ENV_CONFIG ?? '{}');
    const paths = Object.values(envPathObject).map((paths) => paths.path);
    if (paths.length === 0) {
        return;
    }
    const chunkArray = (array, chunkSize) => {
        const chunks = [];
        for (let i = 0; i < array.length; i += chunkSize) {
            chunks.push(array.slice(i, i + chunkSize));
        }
        return chunks;
    };
    const resolveSecrets = async (paths) => {
        const response = (await Promise.all(chunkArray(paths, 10).map(async (chunkedPaths) => await client
            .getParameters({
            Names: chunkedPaths,
            WithDecryption: true,
        })
            .promise()))).reduce((accumulator, response) => {
            accumulator.Parameters?.push(...(response.Parameters ?? []));
            accumulator.InvalidParameters?.push(...(response.InvalidParameters ?? []));
            return accumulator;
        }, {
            Parameters: [],
            InvalidParameters: [],
        });
        if (response.Parameters && response.Parameters.length > 0) {
            for (const parameter of response.Parameters) {
                if (parameter.Name) {
                    const envKey = Object.keys(envPathObject).find((key) => envPathObject[key].sharedPath === parameter.Name ||
                        envPathObject[key].path === parameter.Name);
                    if (envKey) {
                        process.env[envKey] = parameter.Value;
                    }
                }
            }
        }
        return response;
    };
    const response = await resolveSecrets(paths);
    const sharedPaths = (response?.InvalidParameters || [])
        .map((invalidParam) => Object.values(envPathObject).find((paths) => paths.path === invalidParam)?.sharedPath)
        .filter((sharedParam) => !!sharedParam); // this assertion is safe because we are filtering out undefined
    if (sharedPaths.length > 0) {
        await resolveSecrets(sharedPaths);
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzb2x2ZV9zc21fcGFyYW1zX3Nka192Mi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW1iZGEtc2hpbXMvcmVzb2x2ZV9zc21fcGFyYW1zX3Nka192Mi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7R0FLRztBQUNILFdBQVc7QUFDWCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQzVDLE9BQU8sSUFBSSxNQUFNLFdBQVcsQ0FBQztBQUM3QixPQUFPLEdBQUcsTUFBTSxVQUFVLENBQUM7QUFDM0IsTUFBTSxDQUFDLE9BQU8sR0FBRyxhQUFhLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUNoRCxNQUFNLENBQUMsVUFBVSxHQUFHLEdBQUcsQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUN2RCxNQUFNLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFNNUMsdUZBQXVGO0FBQ3ZGLGlFQUFpRTtBQUNqRSxNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7QUFFL0I7OztHQUdHO0FBQ0gsTUFBTSxDQUFDLE1BQU0sdUNBQXVDLEdBQUcsS0FBSyxFQUMxRCxTQUFTLElBQUksR0FBRyxDQUFDLEdBQUcsRUFBUyxFQUM3QixFQUFFO0lBQ0YsTUFBTSxhQUFhLEdBQWUsSUFBSSxDQUFDLEtBQUssQ0FDMUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxzQkFBc0IsSUFBSSxJQUFJLENBQzNDLENBQUM7SUFDRixNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRXRFLElBQUksS0FBSyxDQUFDLE1BQU0sS0FBSyxD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Q0FBYSxDQUFDLENBQUMsZ0VBQWdFO0lBRXZILElBQUksV0FBVyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztRQUMzQixNQUFNLGNBQWMsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNwQyxDQUFDO0FBQ0gsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBUaGlzIGNvZGUgbG9hZHMgZW52aXJvbm1lbnQgdmFsdWVzIGZyb20gU1NNIGFuZCBwbGFjZXMgdGhlbSBpbiB0aGVpciBjb3JyZXNwb25kaW5nIGVudmlyb25tZW50IHZhcmlhYmxlcy5cbiAqIElmIHRoZXJlIGFyZSBubyBTU00gZW52aXJvbm1lbnQgdmFsdWVzIGZvciB0aGlzIGZ1bmN0aW9uLCB0aGlzIGlzIGEgbm9vcC5cbiAqXG4gKiBXZSBpbmNsdWRlIHRoZSBjanMgc2hpbSBoZXJlIGJlY2F1c2UgaXQgaXMgcmVxdWlyZWQgZm9yIHRoZSBzc20gc2hpbSB0byB3b3JrIGJvdGggaW4gdGhlIGxhbWJkYSBhbmQgaW4gdGVzdHNcbiAqL1xuLy8gY2pzIHNoaW1cbmltcG9ydCB7IGNyZWF0ZVJlcXVpcmUgfSBmcm9tICdub2RlOm1vZHVsZSc7XG5pbXBvcnQgcGF0aCBmcm9tICdub2RlOnBhdGgnO1xuaW1wb3J0IHVybCBmcm9tICdub2RlOnVybCc7XG5nbG9iYWwucmVxdWlyZSA9IGNyZWF0ZVJlcXVpcmUoaW1wb3J0Lm1ldGEudXJsKTtcbmdsb2JhbC5fX2ZpbGVuYW1lID0gdXJsLmZpbGVVUkxUb1BhdGgoaW1wb3J0Lm1ldGEudXJsKTtcbmdsb2JhbC5fX2Rpcm5hbWUgPSBwYXRoLmRpcm5hbWUoX19maWxlbmFtZSk7XG5cbi8vIHR5cGUgaW1wb3J0cyB0aGF0IHdpbGwgYmUgZXJhc2VkIGZyb20gdGhlIGJ1bmRsZSBvdXRwdXRcbmltcG9ydCB0eXBlIHsgU1NNIH0gZnJvbSAnYXdzLXNkayc7XG5pbXBvcnQgdHlwZSB7IFNzbUVudlZhcnMgfSBmcm9tICcuLi9mdW5jdGlvbl9lbnZfdHJhbnNsYXRvci5qcyc7XG5cbi8vIGF3cy1zZGsgdjIgZG9lcyBub3QgcGxheSBuaWNlIHdpdGggbm9ybWFsIEVTTSBpbXBvcnRzIHNvIHdlIGhhdmUgdG8gdXNlIHJlcXVpcmUgaGVyZVxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1yZXF1aXJlLWltcG9ydHNcbmNvbnN0IGF3cyA9IHJlcXVpcmUoJ2F3cy1zZGsnKTtcblxuLyoqXG4gKiBSZWFkcyBTU00gZW52aXJvbm1lbnQgY29udGV4dCBmcm9tIGEga25vd24gQW1wbGlmeSBlbnZpcm9ubWVudCB2YXJpYWJsZSxcbiAqIGZldGNoZXMgdmFsdWVzIGZyb20gU1NNIGFuZCBwbGFjZXMgdGhvc2UgdmFsdWVzIGluIHRoZSBjb3JyZXNwb25kaW5nIGVudmlyb25tZW50IHZhcmlhYmxlc1xuICovXG5leHBvcnQgY29uc3QgaW50ZXJuYWxBbXBsaWZ5RnVuY3Rpb25SZXNvbHZlU3NtUGFyYW1zID0gYXN5bmMgKFxuICBjbGllbnQgPSBuZXcgYXdzLlNTTSgpIGFzIFNTTSxcbikgPT4ge1xuICBjb25zdCBlbnZQYXRoT2JqZWN0OiBTc21FbnZWYXJzID0gSlNPTi5wYXJzZShcbiAgICBwcm9jZXNzLmVudi5BTVBMSUZZX1NTTV9FTlZfQ09ORklHID8/ICd7fScsXG4gICk7XG4gIGNvbnN0IHBhdGhzID0gT2JqZWN0LnZhbHVlcyhlbnZQYXRoT2JqZWN0KS5tYXAoKHBhdGhzKSA9PiBwYXRocy5wYXRoKTtcblxuICBpZiAocGF0aHMubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgY2h1bmtBcnJheSA9IDxUPihhcnJheTogVFtdLCBjaHVua1NpemU6IG51bWJlcik6IFRbXVtdID0+IHtcbiAgICBjb25zdCBjaHVua3M6IFRbXVtdID0gW107XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkgKz0gY2h1bmtTaXplKSB7XG4gICAgICBjaHVua3MucHVzaChhcnJheS5zbGljZShpLCBpICsgY2h1bmtTaXplKSk7XG4gICAgfVxuICAgIHJldHVybiBjaHVua3M7XG4gIH07XG5cbiAgY29uc3QgcmVzb2x2ZVNlY3JldHMgPSBhc3luYyAocGF0aHM6IHN0cmluZ1tdKSA9PiB7XG4gICAgY29uc3QgcmVzcG9uc2UgPSAoXG4gICAgICBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgY2h1bmtBcnJheShwYXRocywgMTApLm1hcChcbiAgICAgICAgICBhc3luYyAoY2h1bmtlZFBhdGhzKSA9PlxuICAgICAgICAgICAgYXdhaXQgY2xpZW50XG4gICAgICAgICAgICAgIC5nZXRQYXJhbWV0ZXJzKHtcbiAgICAgICAgICAgICAgICBOYW1lczogY2h1bmtlZFBhdGhzLFxuICAgICAgICAgICAgICAgIFdpdGhEZWNyeXB0aW9uOiB0cnVlLFxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAucHJvbWlzZSgpLFxuICAgICAgICApLFxuICAgICAgKVxuICAgICkucmVkdWNlKFxuICAgICAgKGFjY3VtdWxhdG9yLCByZXNwb25zZSkgPT4ge1xuICAgICAgICBhY2N1bXVsYXRvci5QYXJhbWV0ZXJzPy5wdXNoKC4uLihyZXNwb25zZS5QYXJhbWV0ZXJzID8/IFtdKSk7XG4gICAgICAgIGFjY3VtdWxhdG9yLkludmFsaWRQYXJhbWV0ZXJzPy5wdXNoKFxuICAgICAgICAgIC4uLihyZXNwb25zZS5JbnZhbGlkUGFyYW1ldGVycyA/PyBbXSksXG4gICAgICAgICk7XG4gICAgICAgIHJldHVybiBhY2N1bXVsYXRvcjtcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIFBhcmFtZXRlcnM6IFtdLFxuICAgICAgICBJbnZhbGlkUGFyYW1ldGVyczogW10sXG4gICAgICB9IGFzIFNTTS5HZXRQYXJhbWV0ZXJzUmVzdWx0LFxuICAgICk7XG5cbiAgICBpZiAocmVzcG9uc2UuUGFyYW1ldGVycyAmJiByZXNwb25zZS5QYXJhbWV0ZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgIGZvciAoY29uc3QgcGFyYW1ldGVyIG9mIHJlc3BvbnNlLlBhcmFtZXRlcnMpIHtcbiAgICAgICAgaWYgKHBhcmFtZXRlci5OYW1lKSB7XG4gICAgICAgICAgY29uc3QgZW52S2V5ID0gT2JqZWN0LmtleXMoZW52UGF0aE9iamVjdCkuZmluZChcbiAgICAgICAgICAgIChrZXkpID0+XG4gICAgICAgICAgICAgIGVudlBhdGhPYmplY3Rba2V5XS5zaGFyZWRQYXRoID09PSBwYXJhbWV0ZXIuTmFtZSB8fFxuICAgICAgICAgICAgICBlbnZQYXRoT2JqZWN0W2tleV0ucGF0aCA9PT0gcGFyYW1ldGVyLk5hbWUsXG4gICAgICAgICAgKTtcbiAgICAgICAgICBpZiAoZW52S2V5KSB7XG4gICAgICAgICAgICBwcm9jZXNzLmVudltlbnZLZXldID0gcGFyYW1ldGVyLlZhbHVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiByZXNwb25zZTtcbiAgfTtcblxuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlc29sdmVTZWNyZXRzKHBhdGhzKTtcblxuICBjb25zdCBzaGFyZWRQYXRocyA9IChyZXNwb25zZT8uSW52YWxpZFBhcmFtZXRlcnMgfHwgW10pXG4gICAgLm1hcChcbiAgICAgIChpbnZhbGlkUGFyYW0pID0+XG4gICAgICAgIE9iamVjdC52YWx1ZXMoZW52UGF0aE9iamVjdCkuZmluZChcbiAgICAgICAgICAocGF0aHMpID0+IHBhdGhzLnBhdGggPT09IGludmFsaWRQYXJhbSxcbiAgICAgICAgKT8uc2hhcmVkUGF0aCxcbiAgICApXG4gICAgLmZpbHRlcigoc2hhcmVkUGFyYW0pID0+ICEhc2hhcmVkUGFyYW0pIGFzIHN0cmluZ1tdOyAvLyB0aGlzIGFzc2VydGlvbiBpcyBzYWZlIGJlY2F1c2Ugd2UgYXJlIGZpbHRlcmluZyBvdXQgdW5kZWZpbmVkXG5cbiAgaWYgKHNoYXJlZFBhdGhzLmxlbmd0aCA+IDApIHtcbiAgICBhd2FpdCByZXNvbHZlU2VjcmV0cyhzaGFyZWRQYXRocyk7XG4gIH1cbn07XG4iXX0=