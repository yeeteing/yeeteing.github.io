import { CloudFormationServiceException, DescribeStacksCommand, GetTemplateSummaryCommand, } from '@aws-sdk/client-cloudformation';
import { backendOutputStackMetadataSchema, } from '@aws-amplify/backend-output-schemas';
import { BackendOutputClientError, BackendOutputClientErrorType, } from './index.js';
/**
 * Gets Amplify backend outputs from stack metadata and outputs
 */
export class StackMetadataBackendOutputRetrievalStrategy {
    cfnClient;
    stackNameResolver;
    /**
     * Instantiate with a CloudFormationClient and a StackNameResolver
     */
    constructor(cfnClient, stackNameResolver) {
        this.cfnClient = cfnClient;
        this.stackNameResolver = stackNameResolver;
    }
    /**
     * Resolves the stackName, then queries CFN for the stack metadata and outputs
     *
     * It combines the metadata and outputs to reconstruct the data object that was provided by the Amplify constructs when writing the output.
     * Except now the data contains the resolved values of the deployed resources rather than CFN references
     */
    fetchBackendOutput = async () => {
        const stackName = await this.stackNameResolver.resolveMainStackName();
        let metadataObject;
        try {
            // GetTemplateSummary includes the template metadata as a string
            const templateSummary = await this.cfnClient.send(new GetTemplateSummaryCommand({ StackName: stackName }));
            if (typeof templateSummary.Metadata !== 'string') {
                throw new BackendOutputClientError(BackendOutputClientErrorType.METADATA_RETRIEVAL_ERROR, 'Stack template metadata is not a string');
            }
            metadataObject = JSON.parse(templateSummary.Metadata);
        }
        catch (error) {
            if (error instanceof CloudFormationServiceException &&
                error.message.startsWith('Stack with id') &&
                error.message.endsWith('does not exist')) {
                throw new BackendOutputClientError(BackendOutputClientErrorType.NO_STACK_FOUND, `Stack with id ${stackName} does not exist`);
            }
            if (error instanceof CloudFormationServiceException &&
                ['ExpiredToken', 'InvalidClientTokenId'].includes(error.name)) {
                throw new BackendOutputClientError(BackendOutputClientErrorType.CREDENTIALS_ERROR, error.message);
            }
            if (error instanceof CloudFormationServiceException &&
                error.name === 'AccessDenied') {
                throw new BackendOutputClientError(BackendOutputClientErrorType.ACCESS_DENIED, error.message);
            }
            throw error;
        }
        const filteredMetadataObject = this.filterBackendOutputEntryStackMetadata(metadataObject);
        // parse and validate the metadata object
        const backendOutputMetadata = backendOutputStackMetadataSchema.parse(filteredMetadataObject);
        // DescribeStacks includes the template output
        const stackDescription = await this.cfnClient.send(new DescribeStacksCommand({ StackName: stackName }));
        const outputs = stackDescription?.Stacks?.[0]?.Outputs;
        if (stackDescription.Stacks?.[0].StackStatus?.endsWith('_IN_PROGRESS')) {
            const deploymentType = stackDescription.Stacks?.[0].Tags?.find((tag) => tag.Key === 'amplify:deployment-type')?.Value ?? 'sandbox';
            throw new BackendOutputClientError(BackendOutputClientErrorType.DEPLOYMENT_IN_PROGRESS, `This ${deploymentType} deployment is in progress. Re-run this command once the deployment completes.`);
        }
        if (outputs === undefined) {
            throw new BackendOutputClientError(BackendOutputClientErrorType.NO_OUTPUTS_FOUND, 'Stack outputs are undefined');
        }
        // outputs is a list of output entries. here we turn that into a Record<name, value> object
        const stackOutputRecord = outputs
            .filter((output) => !!output.OutputValue && !!output.OutputKey)
            .reduce((accumulator, outputEntry) => ({
            ...accumulator,
            // it's safe to disable this rule because we've already filtered out potentially undefined outputs
            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
            [outputEntry.OutputKey]: outputEntry.OutputValue,
        }), {});
        // now we iterate over the metadata entries and reconstruct the data object based on the stackOutputs that each construct package set
        const result = {};
        Object.entries(backendOutputMetadata).forEach(([outputKeyName, entry]) => {
            const outputData = entry.stackOutputs.reduce((accumulator, outputName) => {
                if (stackOutputRecord[outputName] === undefined ||
                    stackOutputRecord[outputName] === '') {
                    return accumulator;
                }
                return {
                    ...accumulator,
                    [outputName]: stackOutputRecord[outputName],
                };
            }, {});
            result[outputKeyName] = {
                version: entry.version,
                payload: outputData,
            };
        });
        return result;
    };
    /**
     * Filter out stack metadata entries that do not pertain to backend outputs
     */
    filterBackendOutputEntryStackMetadata(metadata) {
        return Object.fromEntries(Object.entries(metadata).filter(([, value]) => this.isBackendOutputEntryStackMetadata(value)));
    }
    /**
     * Type predicate to determine if stack metadata entry is like a backend output entry.
     * Zod parsing validation will handle stricter type checking
     */
    isBackendOutputEntryStackMetadata(obj) {
        return (!!obj &&
            typeof obj === 'object' &&
            'version' in obj &&
            'stackOutputs' in obj);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhY2tfbWV0YWRhdGFfb3V0cHV0X3JldHJpZXZhbF9zdHJhdGVneS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zdGFja19tZXRhZGF0YV9vdXRwdXRfcmV0cmlldmFsX3N0cmF0ZWd5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFFTCw4QkFBOEIsRUFDOUIscUJBQXFCLEVBQ3JCLHlCQUF5QixHQUMxQixNQUFNLGdDQUFnQyxDQUFDO0FBTXhDLE9BQU8sRUFFTCxnQ0FBZ0MsR0FDakMsTUFBTSxxQ0FBcUMsQ0FBQztBQUM3QyxPQUFPLEVBQ0wsd0JBQXdCLEVBQ3hCLDRCQUE0QixHQUM3QixNQUFNLFlBQVksQ0FBQztBQUVwQjs7R0FFRztBQUNILE1BQU0sT0FBTywyQ0FBMkM7SUFPbkM7SUFDQTtJQUxuQjs7T0FFRztJQUNILFlBQ21CLFNBQStCLEVBQy9CLGlCQUF3QztRQUR4QyxjQUFTLEdBQVQsU0FBUyxDQUFzQjtRQUMvQixzQkFBaUIsR0FBakIsaUJBQWlCLENBQXVCO0lBQ3hELENBQUM7SUFFSjs7Ozs7T0FLRztJQUNILGtCQUFrQixHQUFHLEtBQUssSUFBNEIsRUFBRTtRQUN0RCxNQUFNLFNBQVMsR0FBRyxNQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1FBRXRFLElBQUksY0FBYyxDQUFDO1FBRW5CLElBQUksQ0FBQztZQUNILGdFQUFnRTtZQUNoRSxNQUFNLGVBQWUsR0FBRyxNQUFNLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUMvQyxJQUFJLHlCQUF5QixDQUFDLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQ3hELENBQUM7WUFFRixJQUFJLE9BQU8sZUFBZSxDQUFDLFFBQVEsS0FBSyxRQUFRLEVBQUUsQ0FBQztnQkFDakQsTUFBTSxJQUFJLHdCQUF3QixDQUNoQyw0QkFBNEIsQ0FBQyx3QkFBd0IsRUFDckQseUNBQXlDLENBQzFDLENBQUM7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R0FBWTtRQUVaLE9BQU8sQ0FDTCxDQUFDLENBQUMsR0FBRztZQUNMLE9BQU8sR0FBRyxLQUFLLFFBQVE7WUFDdkIsU0FBUyxJQUFJLEdBQUc7WUFDaEIsY0FBYyxJQUFJLEdBQUcsQ0FDdEIsQ0FBQztJQUNKLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENsb3VkRm9ybWF0aW9uQ2xpZW50LFxuICBDbG91ZEZvcm1hdGlvblNlcnZpY2VFeGNlcHRpb24sXG4gIERlc2NyaWJlU3RhY2tzQ29tbWFuZCxcbiAgR2V0VGVtcGxhdGVTdW1tYXJ5Q29tbWFuZCxcbn0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWNsb3VkZm9ybWF0aW9uJztcbmltcG9ydCB7XG4gIEJhY2tlbmRPdXRwdXQsXG4gIEJhY2tlbmRPdXRwdXRSZXRyaWV2YWxTdHJhdGVneSxcbiAgTWFpblN0YWNrTmFtZVJlc29sdmVyLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7XG4gIEJhY2tlbmRPdXRwdXRFbnRyeVN0YWNrTWV0YWRhdGEsXG4gIGJhY2tlbmRPdXRwdXRTdGFja01ldGFkYXRhU2NoZW1hLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvYmFja2VuZC1vdXRwdXQtc2NoZW1hcyc7XG5pbXBvcnQge1xuICBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3IsXG4gIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvclR5cGUsXG59IGZyb20gJy4vaW5kZXguanMnO1xuXG4vKipcbiAqIEdldHMgQW1wbGlmeSBiYWNrZW5kIG91dHB1dHMgZnJvbSBzdGFjayBtZXRhZGF0YSBhbmQgb3V0cHV0c1xuICovXG5leHBvcnQgY2xhc3MgU3RhY2tNZXRhZGF0YUJhY2tlbmRPdXRwdXRSZXRyaWV2YWxTdHJhdGVneVxuICBpbXBsZW1lbnRzIEJhY2tlbmRPdXRwdXRSZXRyaWV2YWxTdHJhdGVneVxue1xuICAvKipcbiAgICogSW5zdGFudGlhdGUgd2l0aCBhIENsb3VkRm9ybWF0aW9uQ2xpZW50IGFuZCBhIFN0YWNrTmFtZVJlc29sdmVyXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNmbkNsaWVudDogQ2xvdWRGb3JtYXRpb25DbGllbnQsXG4gICAgcHJpdmF0ZSByZWFkb25seSBzdGFja05hbWVSZXNvbHZlcjogTWFpblN0YWNrTmFtZVJlc29sdmVyLFxuICApIHt9XG5cbiAgLyoqXG4gICAqIFJlc29sdmVzIHRoZSBzdGFja05hbWUsIHRoZW4gcXVlcmllcyBDRk4gZm9yIHRoZSBzdGFjayBtZXRhZGF0YSBhbmQgb3V0cHV0c1xuICAgKlxuICAgKiBJdCBjb21iaW5lcyB0aGUgbWV0YWRhdGEgYW5kIG91dHB1dHMgdG8gcmVjb25zdHJ1Y3QgdGhlIGRhdGEgb2JqZWN0IHRoYXQgd2FzIHByb3ZpZGVkIGJ5IHRoZSBBbXBsaWZ5IGNvbnN0cnVjdHMgd2hlbiB3cml0aW5nIHRoZSBvdXRwdXQuXG4gICAqIEV4Y2VwdCBub3cgdGhlIGRhdGEgY29udGFpbnMgdGhlIHJlc29sdmVkIHZhbHVlcyBvZiB0aGUgZGVwbG95ZWQgcmVzb3VyY2VzIHJhdGhlciB0aGFuIENGTiByZWZlcmVuY2VzXG4gICAqL1xuICBmZXRjaEJhY2tlbmRPdXRwdXQgPSBhc3luYyAoKTogUHJvbWlzZTxCYWNrZW5kT3V0cHV0PiA9PiB7XG4gICAgY29uc3Qgc3RhY2tOYW1lID0gYXdhaXQgdGhpcy5zdGFja05hbWVSZXNvbHZlci5yZXNvbHZlTWFpblN0YWNrTmFtZSgpO1xuXG4gICAgbGV0IG1ldGFkYXRhT2JqZWN0O1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIEdldFRlbXBsYXRlU3VtbWFyeSBpbmNsdWRlcyB0aGUgdGVtcGxhdGUgbWV0YWRhdGEgYXMgYSBzdHJpbmdcbiAgICAgIGNvbnN0IHRlbXBsYXRlU3VtbWFyeSA9IGF3YWl0IHRoaXMuY2ZuQ2xpZW50LnNlbmQoXG4gICAgICAgIG5ldyBHZXRUZW1wbGF0ZVN1bW1hcnlDb21tYW5kKHsgU3RhY2tOYW1lOiBzdGFja05hbWUgfSksXG4gICAgICApO1xuXG4gICAgICBpZiAodHlwZW9mIHRlbXBsYXRlU3VtbWFyeS5NZXRhZGF0YSAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgdGhyb3cgbmV3IEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvcihcbiAgICAgICAgICBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3JUeXBlLk1FVEFEQVRBX1JFVFJJRVZBTF9FUlJPUixcbiAgICAgICAgICAnU3RhY2sgdGVtcGxhdGUgbWV0YWRhdGEgaXMgbm90IGEgc3RyaW5nJyxcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgbWV0YWRhdGFPYmplY3QgPSBKU09OLnBhcnNlKHRlbXBsYXRlU3VtbWFyeS5NZXRhZGF0YSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGlmIChcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBDbG91ZEZvcm1hdGlvblNlcnZpY2VFeGNlcHRpb24gJiZcbiAgICAgICAgZXJyb3IubWVzc2FnZS5zdGFydHNXaXRoKCdTdGFjayB3aXRoIGlkJykgJiZcbiAgICAgICAgZXJyb3IubWVzc2FnZS5lbmRzV2l0aCgnZG9lcyBub3QgZXhpc3QnKVxuICAgICAgKSB7XG4gICAgICAgIHRocm93IG5ldyBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3IoXG4gICAgICAgICAgQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZS5OT19TVEFDS19GT1VORCxcbiAgICAgICAgICBgU3RhY2sgd2l0aCBpZCAke3N0YWNrTmFtZX0gZG9lcyBub3QgZXhpc3RgLFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIENsb3VkRm9ybWF0aW9uU2VydmljZUV4Y2VwdGlvbiAmJlxuICAgICAgICBbJ0V4cGlyZWRUb2tlbicsICdJbnZhbGlkQ2xpZW50VG9rZW5JZCddLmluY2x1ZGVzKGVycm9yLm5hbWUpXG4gICAgICApIHtcbiAgICAgICAgdGhyb3cgbmV3IEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvcihcbiAgICAgICAgICBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3JUeXBlLkNSRURFTlRJQUxTX0VSUk9SLFxuICAgICAgICAgIGVycm9yLm1lc3NhZ2UsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgQ2xvdWRGb3JtYXRpb25TZXJ2aWNlRXhjZXB0aW9uICYmXG4gICAgICAgIGVycm9yLm5hbWUgPT09ICdBY2Nlc3NEZW5pZWQnXG4gICAgICApIHtcbiAgICAgICAgdGhyb3cgbmV3IEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvcihcbiAgICAgICAgICBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3JUeXBlLkFDQ0VTU19ERU5JRUQsXG4gICAgICAgICAgZXJyb3IubWVzc2FnZSxcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuXG4gICAgY29uc3QgZmlsdGVyZWRNZXRhZGF0YU9iamVjdCA9XG4gICAgICB0aGlzLmZpbHRlckJhY2tlbmRPdXRwdXRFbnRyeVN0YWNrTWV0YWRhdGEobWV0YWRhdGFPYmplY3QpO1xuXG4gICAgLy8gcGFyc2UgYW5kIHZhbGlkYXRlIHRoZSBtZXRhZGF0YSBvYmplY3RcbiAgICBjb25zdCBiYWNrZW5kT3V0cHV0TWV0YWRhdGEgPSBiYWNrZW5kT3V0cHV0U3RhY2tNZXRhZGF0YVNjaGVtYS5wYXJzZShcbiAgICAgIGZpbHRlcmVkTWV0YWRhdGFPYmplY3QsXG4gICAgKTtcblxuICAgIC8vIERlc2NyaWJlU3RhY2tzIGluY2x1ZGVzIHRoZSB0ZW1wbGF0ZSBvdXRwdXRcbiAgICBjb25zdCBzdGFja0Rlc2NyaXB0aW9uID0gYXdhaXQgdGhpcy5jZm5DbGllbnQuc2VuZChcbiAgICAgIG5ldyBEZXNjcmliZVN0YWNrc0NvbW1hbmQoeyBTdGFja05hbWU6IHN0YWNrTmFtZSB9KSxcbiAgICApO1xuXG4gICAgY29uc3Qgb3V0cHV0cyA9IHN0YWNrRGVzY3JpcHRpb24/LlN0YWNrcz8uWzBdPy5PdXRwdXRzO1xuICAgIGlmIChzdGFja0Rlc2NyaXB0aW9uLlN0YWNrcz8uWzBdLlN0YWNrU3RhdHVzPy5lbmRzV2l0aCgnX0lOX1BST0dSRVNTJykpIHtcbiAgICAgIGNvbnN0IGRlcGxveW1lbnRUeXBlID1cbiAgICAgICAgc3RhY2tEZXNjcmlwdGlvbi5TdGFja3M/LlswXS5UYWdzPy5maW5kKFxuICAgICAgICAgICh0YWcpID0+IHRhZy5LZXkgPT09ICdhbXBsaWZ5OmRlcGxveW1lbnQtdHlwZScsXG4gICAgICAgICk/LlZhbHVlID8/ICdzYW5kYm94JztcbiAgICAgIHRocm93IG5ldyBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3IoXG4gICAgICAgIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvclR5cGUuREVQTE9ZTUVOVF9JTl9QUk9HUkVTUyxcbiAgICAgICAgYFRoaXMgJHtkZXBsb3ltZW50VHlwZX0gZGVwbG95bWVudCBpcyBpbiBwcm9ncmVzcy4gUmUtcnVuIHRoaXMgY29tbWFuZCBvbmNlIHRoZSBkZXBsb3ltZW50IGNvbXBsZXRlcy5gLFxuICAgICAgKTtcbiAgICB9XG4gICAgaWYgKG91dHB1dHMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgbmV3IEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvcihcbiAgICAgICAgQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZS5OT19PVVRQVVRTX0ZPVU5ELFxuICAgICAgICAnU3RhY2sgb3V0cHV0cyBhcmUgdW5kZWZpbmVkJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gb3V0cHV0cyBpcyBhIGxpc3Qgb2Ygb3V0cHV0IGVudHJpZXMuIGhlcmUgd2UgdHVybiB0aGF0IGludG8gYSBSZWNvcmQ8bmFtZSwgdmFsdWU+IG9iamVjdFxuICAgIGNvbnN0IHN0YWNrT3V0cHV0UmVjb3JkID0gb3V0cHV0c1xuICAgICAgLmZpbHRlcigob3V0cHV0KSA9PiAhIW91dHB1dC5PdXRwdXRWYWx1ZSAmJiAhIW91dHB1dC5PdXRwdXRLZXkpXG4gICAgICAucmVkdWNlKFxuICAgICAgICAoYWNjdW11bGF0b3IsIG91dHB1dEVudHJ5KSA9PiAoe1xuICAgICAgICAgIC4uLmFjY3VtdWxhdG9yLFxuICAgICAgICAgIC8vIGl0J3Mgc2FmZSB0byBkaXNhYmxlIHRoaXMgcnVsZSBiZWNhdXNlIHdlJ3ZlIGFscmVhZHkgZmlsdGVyZWQgb3V0IHBvdGVudGlhbGx5IHVuZGVmaW5lZCBvdXRwdXRzXG4gICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICAgICAgICBbb3V0cHV0RW50cnkuT3V0cHV0S2V5IV06IG91dHB1dEVudHJ5Lk91dHB1dFZhbHVlISxcbiAgICAgICAgfSksXG4gICAgICAgIHt9IGFzIFJlY29yZDxzdHJpbmcsIHN0cmluZz4sXG4gICAgICApO1xuXG4gICAgLy8gbm93IHdlIGl0ZXJhdGUgb3ZlciB0aGUgbWV0YWRhdGEgZW50cmllcyBhbmQgcmVjb25zdHJ1Y3QgdGhlIGRhdGEgb2JqZWN0IGJhc2VkIG9uIHRoZSBzdGFja091dHB1dHMgdGhhdCBlYWNoIGNvbnN0cnVjdCBwYWNrYWdlIHNldFxuICAgIGNvbnN0IHJlc3VsdDogQmFja2VuZE91dHB1dCA9IHt9O1xuICAgIE9iamVjdC5lbnRyaWVzKGJhY2tlbmRPdXRwdXRNZXRhZGF0YSkuZm9yRWFjaCgoW291dHB1dEtleU5hbWUsIGVudHJ5XSkgPT4ge1xuICAgICAgY29uc3Qgb3V0cHV0RGF0YSA9IGVudHJ5LnN0YWNrT3V0cHV0cy5yZWR1Y2UoXG4gICAgICAgIChhY2N1bXVsYXRvciwgb3V0cHV0TmFtZSkgPT4ge1xuICAgICAgICAgIGlmIChcbiAgICAgICAgICAgIHN0YWNrT3V0cHV0UmVjb3JkW291dHB1dE5hbWVdID09PSB1bmRlZmluZWQgfHxcbiAgICAgICAgICAgIHN0YWNrT3V0cHV0UmVjb3JkW291dHB1dE5hbWVdID09PSAnJ1xuICAgICAgICAgICkge1xuICAgICAgICAgICAgcmV0dXJuIGFjY3VtdWxhdG9yO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgLi4uYWNjdW11bGF0b3IsXG4gICAgICAgICAgICBbb3V0cHV0TmFtZV06IHN0YWNrT3V0cHV0UmVjb3JkW291dHB1dE5hbWVdLFxuICAgICAgICAgIH07XG4gICAgICAgIH0sXG4gICAgICAgIHt9IGFzIFJlY29yZDxzdHJpbmcsIHN0cmluZz4sXG4gICAgICApO1xuICAgICAgcmVzdWx0W291dHB1dEtleU5hbWVdID0ge1xuICAgICAgICB2ZXJzaW9uOiBlbnRyeS52ZXJzaW9uLFxuICAgICAgICBwYXlsb2FkOiBvdXRwdXREYXRhLFxuICAgICAgfTtcbiAgICB9KTtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9O1xuXG4gIC8qKlxuICAgKiBGaWx0ZXIgb3V0IHN0YWNrIG1ldGFkYXRhIGVudHJpZXMgdGhhdCBkbyBub3QgcGVydGFpbiB0byBiYWNrZW5kIG91dHB1dHNcbiAgICovXG4gIHByaXZhdGUgZmlsdGVyQmFja2VuZE91dHB1dEVudHJ5U3RhY2tNZXRhZGF0YTxcbiAgICBUIGV4dGVuZHMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4gID4obWV0YWRhdGE6IFQpIHtcbiAgICByZXR1cm4gT2JqZWN0LmZyb21FbnRyaWVzKFxuICAgICAgT2JqZWN0LmVudHJpZXMobWV0YWRhdGEpLmZpbHRlcigoWywgdmFsdWVdKSA9PlxuICAgICAgICB0aGlzLmlzQmFja2VuZE91dHB1dEVudHJ5U3RhY2tNZXRhZGF0YSh2YWx1ZSksXG4gICAgICApLFxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogVHlwZSBwcmVkaWNhdGUgdG8gZGV0ZXJtaW5lIGlmIHN0YWNrIG1ldGFkYXRhIGVudHJ5IGlzIGxpa2UgYSBiYWNrZW5kIG91dHB1dCBlbnRyeS5cbiAgICogWm9kIHBhcnNpbmcgdmFsaWRhdGlvbiB3aWxsIGhhbmRsZSBzdHJpY3RlciB0eXBlIGNoZWNraW5nXG4gICAqL1xuICBwcml2YXRlIGlzQmFja2VuZE91dHB1dEVudHJ5U3RhY2tNZXRhZGF0YShcbiAgICBvYmo6IHVua25vd24sXG4gICk6IG9iaiBpcyBCYWNrZW5kT3V0cHV0RW50cnlTdGFja01ldGFkYXRhIHtcbiAgICByZXR1cm4gKFxuICAgICAgISFvYmogJiZcbiAgICAgIHR5cGVvZiBvYmogPT09ICdvYmplY3QnICYmXG4gICAgICAndmVyc2lvbicgaW4gb2JqICYmXG4gICAgICAnc3RhY2tPdXRwdXRzJyBpbiBvYmpcbiAgICApO1xuICB9XG59XG4iXX0=