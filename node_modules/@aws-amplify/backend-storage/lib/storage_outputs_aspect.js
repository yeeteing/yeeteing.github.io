import { storageOutputKey, } from '@aws-amplify/backend-output-schemas';
import { AmplifyUserError } from '@aws-amplify/platform-core';
import { Stack } from 'aws-cdk-lib';
import { AmplifyStorage } from './construct.js';
/**
 * Aspect to store the storage outputs in the backend
 */
export class StorageOutputsAspect {
    isStorageProcessed = false;
    outputStorageStrategy;
    /**
     * Constructs a new instance of the StorageValidator class.
     */
    constructor(outputStorageStrategy) {
        this.outputStorageStrategy = outputStorageStrategy;
    }
    /**
     * Visit the given node.
     * If the node is an AmplifyStorage construct, we will traverse its siblings in the same stack
     * @param node The node to visit.
     */
    visit(node) {
        if (!(node instanceof AmplifyStorage) || this.isStorageProcessed) {
            return;
        }
        /**
         * only traverse the siblings once to store the outputs,
         * storing the same outputs multiple times result in error
         */
        this.isStorageProcessed = true;
        const storageInstances = Stack.of(node).node.children.filter((el) => el instanceof AmplifyStorage);
        const storageCount = storageInstances.length;
        let defaultStorageFound = false;
        Stack.of(node).node.children.forEach((child) => {
            if (!(child instanceof AmplifyStorage)) {
                return;
            }
            if (child.isDefault && !defaultStorageFound) {
                defaultStorageFound = true;
            }
            else if (child.isDefault && defaultStorageFound) {
                throw new AmplifyUserError('MultipleDefaultStorageError', {
                    message: `More than one default storage set in the Amplify project.`,
                    resolution: 'Remove `isDefault: true` from all `defineStorage` calls except for one in your Amplify project.',
                });
            }
        });
        /*
         * If there is no default bucket set and there is only one bucket,
         * we need to set the bucket as default.
         */
        if (!defaultStorageFound && storageCount === 1) {
            this.storeOutput(this.outputStorageStrategy, true, node);
        }
        else if (!defaultStorageFound && storageCount > 1) {
            throw new AmplifyUserError('NoDefaultStorageError', {
                message: 'No default storage set in the Amplify project.',
                resolution: 'Add `isDefault: true` to one of the `defineStorage` calls in your Amplify project.',
            });
        }
        else {
            Stack.of(node).node.children.forEach((child) => {
                if (!(child instanceof AmplifyStorage)) {
                    return;
                }
                this.storeOutput(this.outputStorageStrategy, child.isDefault, child);
            });
        }
    }
    storeOutput = (outputStorageStrategy, isDefault = false, node) => {
        if (isDefault) {
            outputStorageStrategy.addBackendOutputEntry(storageOutputKey, {
                version: '1',
                payload: {
                    storageRegion: Stack.of(node).region,
                    bucketName: node.resources.bucket.bucketName,
                },
            });
        }
        const bucketsPayload = {
            name: node.name,
            bucketName: node.resources.bucket.bucketName,
            storageRegion: Stack.of(node).region,
        };
        if (node.accessDefinition) {
            bucketsPayload.paths = node.accessDefinition;
        }
        // both default and non-default buckets should have the name, bucket name, and storage region stored in `buckets` field
        outputStorageStrategy.appendToBackendOutputList(storageOutputKey, {
            version: '1',
            payload: {
                buckets: JSON.stringify(bucketsPayload),
            },
        });
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmFnZV9vdXRwdXRzX2FzcGVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zdG9yYWdlX291dHB1dHNfYXNwZWN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFFTCxnQkFBZ0IsR0FDakIsTUFBTSxxQ0FBcUMsQ0FBQztBQUM3QyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUU5RCxPQUFPLEVBQVcsS0FBSyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRTdDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUdoRDs7R0FFRztBQUNILE1BQU0sT0FBTyxvQkFBb0I7SUFDL0Isa0JBQWtCLEdBQUcsS0FBSyxDQUFDO0lBQzNCLHFCQUFxQixDQUFDO0lBQ3RCOztPQUVHO0lBQ0gsWUFDRSxxQkFBa0U7UUFFbEUsSUFBSSxDQUFDLHFCQUFxQixHQUFHLHFCQUFxQixDQUFDO0lBQ3JELENBQUM7SUFFRDs7OztPQUlHO0lBQ0ksS0FBSyxDQUFDLElBQWdCO1FBQzNCLElBQUksQ0FBQyxDQUFDLElBQUksWUFBWSxjQUFjLENBQUMsSUFBSSxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztZQUNqRSxPQUFPO1FBQ1QsQ0FBQztRQUNEOzs7V0FHRztRQUNILElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLENBQUM7UUFFL0IsTUFBTSxnQkFBZ0IsR0FBRyxLQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUMxRCxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxZQUFZLGNBQWMsQ0FDckMsQ0FBQztRQUNGLE1BQU0sWUFBWSxHQUFHLGdCQUFnQixDQUFDLE1BQU0sQ0FBQztRQUU3QyxJQUFJLG1CQUFtQixHQUFHLEtBQUssQ0FBQztRQUVoQyxLQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFD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cmFnZU91dHB1dCxcbiAgc3RvcmFnZU91dHB1dEtleSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQtb3V0cHV0LXNjaGVtYXMnO1xuaW1wb3J0IHsgQW1wbGlmeVVzZXJFcnJvciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcbmltcG9ydCB7IEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3kgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7IElBc3BlY3QsIFN0YWNrIH0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgSUNvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgQW1wbGlmeVN0b3JhZ2UgfSBmcm9tICcuL2NvbnN0cnVjdC5qcyc7XG5pbXBvcnQgeyBTdG9yYWdlQWNjZXNzRGVmaW5pdGlvbk91dHB1dCB9IGZyb20gJy4vcHJpdmF0ZV90eXBlcy5qcyc7XG5cbi8qKlxuICogQXNwZWN0IHRvIHN0b3JlIHRoZSBzdG9yYWdlIG91dHB1dHMgaW4gdGhlIGJhY2tlbmRcbiAqL1xuZXhwb3J0IGNsYXNzIFN0b3JhZ2VPdXRwdXRzQXNwZWN0IGltcGxlbWVudHMgSUFzcGVjdCB7XG4gIGlzU3RvcmFnZVByb2Nlc3NlZCA9IGZhbHNlO1xuICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3k7XG4gIC8qKlxuICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGluc3RhbmNlIG9mIHRoZSBTdG9yYWdlVmFsaWRhdG9yIGNsYXNzLlxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5OiBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5PFN0b3JhZ2VPdXRwdXQ+LFxuICApIHtcbiAgICB0aGlzLm91dHB1dFN0b3JhZ2VTdHJhdGVneSA9IG91dHB1dFN0b3JhZ2VTdHJhdGVneTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWaXNpdCB0aGUgZ2l2ZW4gbm9kZS5cbiAgICogSWYgdGhlIG5vZGUgaXMgYW4gQW1wbGlmeVN0b3JhZ2UgY29uc3RydWN0LCB3ZSB3aWxsIHRyYXZlcnNlIGl0cyBzaWJsaW5ncyBpbiB0aGUgc2FtZSBzdGFja1xuICAgKiBAcGFyYW0gbm9kZSBUaGUgbm9kZSB0byB2aXNpdC5cbiAgICovXG4gIHB1YmxpYyB2aXNpdChub2RlOiBJQ29uc3RydWN0KTogdm9pZCB7XG4gICAgaWYgKCEobm9kZSBpbnN0YW5jZW9mIEFtcGxpZnlTdG9yYWdlKSB8fCB0aGlzLmlzU3RvcmFnZVByb2Nlc3NlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICAvKipcbiAgICAgKiBvbmx5IHRyYXZlcnNlIHRoZSBzaWJsaW5ncyBvbmNlIHRvIHN0b3JlIHRoZSBvdXRwdXRzLFxuICAgICAqIHN0b3JpbmcgdGhlIHNhbWUgb3V0cHV0cyBtdWx0aXBsZSB0aW1lcyByZXN1bHQgaW4gZXJyb3JcbiAgICAgKi9cbiAgICB0aGlzLmlzU3RvcmFnZVByb2Nlc3NlZCA9IHRydWU7XG5cbiAgICBjb25zdCBzdG9yYWdlSW5zdGFuY2VzID0gU3RhY2sub2Yobm9kZSkubm9kZS5jaGlsZHJlbi5maWx0ZXIoXG4gICAgICAoZWwpID0+IGVsIGluc3RhbmNlb2YgQW1wbGlmeVN0b3JhZ2UsXG4gICAgKTtcbiAgICBjb25zdCBzdG9yYWdlQ291bnQgPSBzdG9yYWdlSW5zdGFuY2VzLmxlbmd0aDtcblxuICAgIGxldCBkZWZhdWx0U3RvcmFnZUZvdW5kID0gZmFsc2U7XG5cbiAgICBTdGFjay5vZihub2RlKS5ub2RlLmNoaWxkcmVuLmZvckVhY2goKGNoaWxkKSA9PiB7XG4gICAgICBpZiAoIShjaGlsZCBpbnN0YW5jZW9mIEFtcGxpZnlTdG9yYWdlKSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBpZiAoY2hpbGQuaXNEZWZhdWx0ICYmICFkZWZhdWx0U3RvcmFnZUZvdW5kKSB7XG4gICAgICAgIGRlZmF1bHRTdG9yYWdlRm91bmQgPSB0cnVlO1xuICAgICAgfSBlbHNlIGlmIChjaGlsZC5pc0RlZmF1bHQgJiYgZGVmYXVsdFN0b3JhZ2VGb3VuZCkge1xuICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcignTXVsdGlwbGVEZWZhdWx0U3RvcmFnZUVycm9yJywge1xuICAgICAgICAgIG1lc3NhZ2U6IGBNb3JlIHRoYW4gb25lIGRlZmF1bHQgc3RvcmFnZSBzZXQgaW4gdGhlIEFtcGxpZnkgcHJvamVjdC5gLFxuICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAnUmVtb3ZlIGBpc0RlZmF1bHQ6IHRydWVgIGZyb20gYWxsIGBkZWZpbmVTdG9yYWdlYCBjYWxscyBleGNlcHQgZm9yIG9uZSBpbiB5b3VyIEFtcGxpZnkgcHJvamVjdC4nLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICAvKlxuICAgICAqIElmIHRoZXJlIGlzIG5vIGRlZmF1bHQgYnVja2V0IHNldCBhbmQgdGhlcmUgaXMgb25seSBvbmUgYnVja2V0LFxuICAgICAqIHdlIG5lZWQgdG8gc2V0IHRoZSBidWNrZXQgYXMgZGVmYXVsdC5cbiAgICAgKi9cbiAgICBpZiAoIWRlZmF1bHRTdG9yYWdlRm91bmQgJiYgc3RvcmFnZUNvdW50ID09PSAxKSB7XG4gICAgICB0aGlzLnN0b3JlT3V0cHV0KHRoaXMub3V0cHV0U3RvcmFnZVN0cmF0ZWd5LCB0cnVlLCBub2RlKTtcbiAgICB9IGVsc2UgaWYgKCFkZWZhdWx0U3RvcmFnZUZvdW5kICYmIHN0b3JhZ2VDb3VudCA+IDEpIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKCdOb0RlZmF1bHRTdG9yYWdlRXJyb3InLCB7XG4gICAgICAgIG1lc3NhZ2U6ICdObyBkZWZhdWx0IHN0b3JhZ2Ugc2V0IGluIHRoZSBBbXBsaWZ5IHByb2plY3QuJyxcbiAgICAgICAgcmVzb2x1dGlvbjpcbiAgICAgICAgICAnQWRkIGBpc0RlZmF1bHQ6IHRydWVgIHRvIG9uZSBvZiB0aGUgYGRlZmluZVN0b3JhZ2VgIGNhbGxzIGluIHlvdXIgQW1wbGlmeSBwcm9qZWN0LicsXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgU3RhY2sub2Yobm9kZSkubm9kZS5jaGlsZHJlbi5mb3JFYWNoKChjaGlsZCkgPT4ge1xuICAgICAgICBpZiAoIShjaGlsZCBpbnN0YW5jZW9mIEFtcGxpZnlTdG9yYWdlKSkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnN0b3JlT3V0cHV0KHRoaXMub3V0cHV0U3RvcmFnZVN0cmF0ZWd5LCBjaGlsZC5pc0RlZmF1bHQsIGNoaWxkKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc3RvcmVPdXRwdXQgPSAoXG4gICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5OiBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5PFN0b3JhZ2VPdXRwdXQ+LFxuICAgIGlzRGVmYXVsdDogYm9vbGVhbiA9IGZhbHNlLFxuICAgIG5vZGU6IEFtcGxpZnlTdG9yYWdlLFxuICApOiB2b2lkID0+IHtcbiAgICBpZiAoaXNEZWZhdWx0KSB7XG4gICAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3kuYWRkQmFja2VuZE91dHB1dEVudHJ5KHN0b3JhZ2VPdXRwdXRLZXksIHtcbiAgICAgICAgdmVyc2lvbjogJzEnLFxuICAgICAgICBwYXlsb2FkOiB7XG4gICAgICAgICAgc3RvcmFnZVJlZ2lvbjogU3RhY2sub2Yobm9kZSkucmVnaW9uLFxuICAgICAgICAgIGJ1Y2tldE5hbWU6IG5vZGUucmVzb3VyY2VzLmJ1Y2tldC5idWNrZXROYW1lLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfVxuICAgIGNvbnN0IGJ1Y2tldHNQYXlsb2FkOiBSZWNvcmQ8XG4gICAgICBzdHJpbmcsXG4gICAgICBzdHJpbmcgfCBTdG9yYWdlQWNjZXNzRGVmaW5pdGlvbk91dHB1dFxuICAgID4gPSB7XG4gICAgICBuYW1lOiBub2RlLm5hbWUsXG4gICAgICBidWNrZXROYW1lOiBub2RlLnJlc291cmNlcy5idWNrZXQuYnVja2V0TmFtZSxcbiAgICAgIHN0b3JhZ2VSZWdpb246IFN0YWNrLm9mKG5vZGUpLnJlZ2lvbixcbiAgICB9O1xuICAgIGlmIChub2RlLmFjY2Vzc0RlZmluaXRpb24pIHtcbiAgICAgIGJ1Y2tldHNQYXlsb2FkLnBhdGhzID0gbm9kZS5hY2Nlc3NEZWZpbml0aW9uO1xuICAgIH1cbiAgICAvLyBib3RoIGRlZmF1bHQgYW5kIG5vbi1kZWZhdWx0IGJ1Y2tldHMgc2hvdWxkIGhhdmUgdGhlIG5hbWUsIGJ1Y2tldCBuYW1lLCBhbmQgc3RvcmFnZSByZWdpb24gc3RvcmVkIGluIGBidWNrZXRzYCBmaWVsZFxuICAgIG91dHB1dFN0b3JhZ2VTdHJhdGVneS5hcHBlbmRUb0JhY2tlbmRPdXRwdXRMaXN0KHN0b3JhZ2VPdXRwdXRLZXksIHtcbiAgICAgIHZlcnNpb246ICcxJyxcbiAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgYnVja2V0czogSlNPTi5zdHJpbmdpZnkoYnVja2V0c1BheWxvYWQpLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfTtcbn1cbiJdfQ==