import semver from 'semver';
import { hideBin } from 'yargs/helpers';
/**
 * Evaluates notice predicates.
 */
export class NoticePredicatesEvaluator {
    packageManagerController;
    _process;
    dependencies;
    /**
     * Creates notice predicates evaluator.
     */
    constructor(packageManagerController, _process = process) {
        this.packageManagerController = packageManagerController;
        this._process = _process;
    }
    evaluate = async (notice, opts) => {
        for (const predicate of notice.predicates) {
            switch (predicate.type) {
                case 'nodeVersion':
                    if (!this.evaluateNodeVersion(predicate.versionRange)) {
                        return false;
                    }
                    break;
                case 'osFamily':
                    if (!this.evaluateOsFamily(predicate.osFamily)) {
                        return false;
                    }
                    break;
                case 'backendComponent':
                    // TODO out of scope for now due to complexity.
                    // Detecting backend components could be accomplished by:
                    // 1. Inspecting outputs file. (Not ideal, file is available only after successful deployment).
                    // 2. Inspecting cdk.out assembly (Does not require deployment, but relies on assembly format).
                    // 3. Have synthesis leave additional file into .amplify that we can read. (We control everything).
                    // 4. Have in memory ability to record information about verticals (Similar to 3 but requires integration with Toolkit to go first to spike it).
                    break;
                case 'command':
                    if (!this.evaluateCommand(predicate.command)) {
                        return false;
                    }
                    break;
                case 'errorMessage':
                    if (!this.evaluateErrorMessage(predicate.errorMessage, opts?.error)) {
                        return false;
                    }
                    break;
                case 'packageVersion':
                    if (!(await this.evaluatePackageVersion(predicate.packageName, predicate.versionRange))) {
                        return false;
                    }
                    break;
            }
        }
        return true;
    };
    evaluateCommand = (expectedCommand) => {
        const command = hideBin(this._process.argv)[0];
        return command === expectedCommand;
    };
    evaluateOsFamily = (expectedOsFamily) => {
        switch (expectedOsFamily) {
            case 'windows':
                return this._process.platform === 'win32';
            case 'macos':
                return this._process.platform === 'darwin';
            case 'linux':
                return this._process.platform === 'linux';
        }
    };
    evaluateErrorMessage = (expectedErrorMessage, actualError) => {
        if (!actualError) {
            return false;
        }
        return actualError.message.includes(expectedErrorMessage);
    };
    evaluateNodeVersion = (versionRange) => {
        return semver.satisfies(this._process.version, versionRange);
    };
    evaluatePackageVersion = async (packageName, versionRange) => {
        const dependencies = await this.tryGetDependencies();
        if (dependencies) {
            const matchingPackage = dependencies.find((dependency) => dependency.name === packageName &&
                semver.satisfies(dependency.version, versionRange));
            return matchingPackage !== undefined;
        }
        return false;
    };
    tryGetDependencies = async () => {
        if (!this.dependencies) {
            this.dependencies =
                await this.packageManagerController.tryGetDependencies();
        }
        return this.dependencies;
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm90aWNlX3ByZWRpY2F0ZXNfZXZhbHVhdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL25vdGljZXMvbm90aWNlX3ByZWRpY2F0ZXNfZXZhbHVhdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sTUFBTSxNQUFNLFFBQVEsQ0FBQztBQUs1QixPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBR3hDOztHQUVHO0FBQ0gsTUFBTSxPQUFPLHlCQUF5QjtJQU9qQjtJQUNBO0lBUFgsWUFBWSxDQUFnQztJQUVwRDs7T0FFRztJQUNILFlBQ21CLHdCQUFrRCxFQUNsRCxXQUFXLE9BQU87UUFEbEIsNkJBQXdCLEdBQXhCLHdCQUF3QixDQUEwQjtRQUNsRCxhQUFRLEdBQVIsUUFBUSxDQUFVO0lBQ2xDLENBQUM7SUFFSixRQUFRLEdBQUcsS0FBSyxFQUNkLE1BQWMsRUFDZCxJQUEyQixFQUNULEVBQUU7UUFDcEIsS0FBSyxNQUFNLFNBQVMsSUFBSSxNQUFNLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDMUMsUUFBUSxTQUFTLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ3ZCLEtBQUssYUFBYTtvQkFDaEIsSUFBSSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQzt3QkFDdEQsT0FBTyxLQUFLLENBQUM7b0JBQ2YsQ0FBQztvQkFDRCxNQUFNO2dCQUNSLEtBQUssVUFBVTtvQkFDYixJQUFJLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDO3dCQUMvQyxPQUFPLEtBQUssQ0FBQztvQkFDZixDQUFDO29CQUNELE1BQU07Z0JBQ1IsS0FBSyxrQkFBa0I7b0JBQ3JCLCtDQUErQztvQkFDL0MseURBQXlEO29CQUN6RCwrRkFBK0Y7b0JBQy9GLCtGQUErRjtvQkFDL0YsbUdBQW1HO29CQUNuRyxnSkFBZ0o7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O1FBQzdELENBQUM7UUFDRCxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUM7SUFDM0IsQ0FBQyxDQUFDO0NBQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBOb3RpY2UgfSBmcm9tICdAYXdzLWFtcGxpZnkvY2xpLWNvcmUnO1xuaW1wb3J0IHNlbXZlciBmcm9tICdzZW12ZXInO1xuaW1wb3J0IHtcbiAgRGVwZW5kZW5jeSxcbiAgUGFja2FnZU1hbmFnZXJDb250cm9sbGVyLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7IGhpZGVCaW4gfSBmcm9tICd5YXJncy9oZWxwZXJzJztcbmltcG9ydCB7IE5vdGljZXNSZW5kZXJlclBhcmFtcyB9IGZyb20gJy4vbm90aWNlc19yZW5kZXJlci5qcyc7XG5cbi8qKlxuICogRXZhbHVhdGVzIG5vdGljZSBwcmVkaWNhdGVzLlxuICovXG5leHBvcnQgY2xhc3MgTm90aWNlUHJlZGljYXRlc0V2YWx1YXRvciB7XG4gIHByaXZhdGUgZGVwZW5kZW5jaWVzOiBBcnJheTxEZXBlbmRlbmN5PiB8IHVuZGVmaW5lZDtcblxuICAvKipcbiAgICogQ3JlYXRlcyBub3RpY2UgcHJlZGljYXRlcyBldmFsdWF0b3IuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHBhY2thZ2VNYW5hZ2VyQ29udHJvbGxlcjogUGFja2FnZU1hbmFnZXJDb250cm9sbGVyLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgX3Byb2Nlc3MgPSBwcm9jZXNzLFxuICApIHt9XG5cbiAgZXZhbHVhdGUgPSBhc3luYyAoXG4gICAgbm90aWNlOiBOb3RpY2UsXG4gICAgb3B0czogTm90aWNlc1JlbmRlcmVyUGFyYW1zLFxuICApOiBQcm9taXNlPGJvb2xlYW4+ID0+IHtcbiAgICBmb3IgKGNvbnN0IHByZWRpY2F0ZSBvZiBub3RpY2UucHJlZGljYXRlcykge1xuICAgICAgc3dpdGNoIChwcmVkaWNhdGUudHlwZSkge1xuICAgICAgICBjYXNlICdub2RlVmVyc2lvbic6XG4gICAgICAgICAgaWYgKCF0aGlzLmV2YWx1YXRlTm9kZVZlcnNpb24ocHJlZGljYXRlLnZlcnNpb25SYW5nZSkpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ29zRmFtaWx5JzpcbiAgICAgICAgICBpZiAoIXRoaXMuZXZhbHVhdGVPc0ZhbWlseShwcmVkaWNhdGUub3NGYW1pbHkpKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdiYWNrZW5kQ29tcG9uZW50JzpcbiAgICAgICAgICAvLyBUT0RPIG91dCBvZiBzY29wZSBmb3Igbm93IGR1ZSB0byBjb21wbGV4aXR5LlxuICAgICAgICAgIC8vIERldGVjdGluZyBiYWNrZW5kIGNvbXBvbmVudHMgY291bGQgYmUgYWNjb21wbGlzaGVkIGJ5OlxuICAgICAgICAgIC8vIDEuIEluc3BlY3Rpbmcgb3V0cHV0cyBmaWxlLiAoTm90IGlkZWFsLCBmaWxlIGlzIGF2YWlsYWJsZSBvbmx5IGFmdGVyIHN1Y2Nlc3NmdWwgZGVwbG95bWVudCkuXG4gICAgICAgICAgLy8gMi4gSW5zcGVjdGluZyBjZGsub3V0IGFzc2VtYmx5IChEb2VzIG5vdCByZXF1aXJlIGRlcGxveW1lbnQsIGJ1dCByZWxpZXMgb24gYXNzZW1ibHkgZm9ybWF0KS5cbiAgICAgICAgICAvLyAzLiBIYXZlIHN5bnRoZXNpcyBsZWF2ZSBhZGRpdGlvbmFsIGZpbGUgaW50byAuYW1wbGlmeSB0aGF0IHdlIGNhbiByZWFkLiAoV2UgY29udHJvbCBldmVyeXRoaW5nKS5cbiAgICAgICAgICAvLyA0LiBIYXZlIGluIG1lbW9yeSBhYmlsaXR5IHRvIHJlY29yZCBpbmZvcm1hdGlvbiBhYm91dCB2ZXJ0aWNhbHMgKFNpbWlsYXIgdG8gMyBidXQgcmVxdWlyZXMgaW50ZWdyYXRpb24gd2l0aCBUb29sa2l0IHRvIGdvIGZpcnN0IHRvIHNwaWtlIGl0KS5cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnY29tbWFuZCc6XG4gICAgICAgICAgaWYgKCF0aGlzLmV2YWx1YXRlQ29tbWFuZChwcmVkaWNhdGUuY29tbWFuZCkpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ2Vycm9yTWVzc2FnZSc6XG4gICAgICAgICAgaWYgKCF0aGlzLmV2YWx1YXRlRXJyb3JNZXNzYWdlKHByZWRpY2F0ZS5lcnJvck1lc3NhZ2UsIG9wdHM/LmVycm9yKSkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAncGFja2FnZVZlcnNpb24nOlxuICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICEoYXdhaXQgdGhpcy5ldmFsdWF0ZVBhY2thZ2VWZXJzaW9uKFxuICAgICAgICAgICAgICBwcmVkaWNhdGUucGFja2FnZU5hbWUsXG4gICAgICAgICAgICAgIHByZWRpY2F0ZS52ZXJzaW9uUmFuZ2UsXG4gICAgICAgICAgICApKVxuICAgICAgICAgICkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfTtcblxuICBwcml2YXRlIGV2YWx1YXRlQ29tbWFuZCA9IChleHBlY3RlZENvbW1hbmQ6IHN0cmluZyk6IGJvb2xlYW4gPT4ge1xuICAgIGNvbnN0IGNvbW1hbmQgPSBoaWRlQmluKHRoaXMuX3Byb2Nlc3MuYXJndilbMF07XG4gICAgcmV0dXJuIGNvbW1hbmQgPT09IGV4cGVjdGVkQ29tbWFuZDtcbiAgfTtcblxuICBwcml2YXRlIGV2YWx1YXRlT3NGYW1pbHkgPSAoXG4gICAgZXhwZWN0ZWRPc0ZhbWlseTogJ3dpbmRvd3MnIHwgJ21hY29zJyB8ICdsaW51eCcsXG4gICk6IGJvb2xlYW4gPT4ge1xuICAgIHN3aXRjaCAoZXhwZWN0ZWRPc0ZhbWlseSkge1xuICAgICAgY2FzZSAnd2luZG93cyc6XG4gICAgICAgIHJldHVybiB0aGlzLl9wcm9jZXNzLnBsYXRmb3JtID09PSAnd2luMzInO1xuICAgICAgY2FzZSAnbWFjb3MnOlxuICAgICAgICByZXR1cm4gdGhpcy5fcHJvY2Vzcy5wbGF0Zm9ybSA9PT0gJ2Rhcndpbic7XG4gICAgICBjYXNlICdsaW51eCc6XG4gICAgICAgIHJldHVybiB0aGlzLl9wcm9jZXNzLnBsYXRmb3JtID09PSAnbGludXgnO1xuICAgIH1cbiAgfTtcblxuICBwcml2YXRlIGV2YWx1YXRlRXJyb3JNZXNzYWdlID0gKFxuICAgIGV4cGVjdGVkRXJyb3JNZXNzYWdlOiBzdHJpbmcsXG4gICAgYWN0dWFsRXJyb3I6IEVycm9yIHwgdW5kZWZpbmVkLFxuICApOiBib29sZWFuID0+IHtcbiAgICBpZiAoIWFjdHVhbEVycm9yKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHJldHVybiBhY3R1YWxFcnJvci5tZXNzYWdlLmluY2x1ZGVzKGV4cGVjdGVkRXJyb3JNZXNzYWdlKTtcbiAgfTtcblxuICBwcml2YXRlIGV2YWx1YXRlTm9kZVZlcnNpb24gPSAodmVyc2lvblJhbmdlOiBzdHJpbmcpOiBib29sZWFuID0+IHtcbiAgICByZXR1cm4gc2VtdmVyLnNhdGlzZmllcyh0aGlzLl9wcm9jZXNzLnZlcnNpb24sIHZlcnNpb25SYW5nZSk7XG4gIH07XG5cbiAgcHJpdmF0ZSBldmFsdWF0ZVBhY2thZ2VWZXJzaW9uID0gYXN5bmMgKFxuICAgIHBhY2thZ2VOYW1lOiBzdHJpbmcsXG4gICAgdmVyc2lvblJhbmdlOiBzdHJpbmcsXG4gICk6IFByb21pc2U8Ym9vbGVhbj4gPT4ge1xuICAgIGNvbnN0IGRlcGVuZGVuY2llcyA9IGF3YWl0IHRoaXMudHJ5R2V0RGVwZW5kZW5jaWVzKCk7XG4gICAgaWYgKGRlcGVuZGVuY2llcykge1xuICAgICAgY29uc3QgbWF0Y2hpbmdQYWNrYWdlID0gZGVwZW5kZW5jaWVzLmZpbmQoXG4gICAgICAgIChkZXBlbmRlbmN5KSA9PlxuICAgICAgICAgIGRlcGVuZGVuY3kubmFtZSA9PT0gcGFja2FnZU5hbWUgJiZcbiAgICAgICAgICBzZW12ZXIuc2F0aXNmaWVzKGRlcGVuZGVuY3kudmVyc2lvbiwgdmVyc2lvblJhbmdlKSxcbiAgICAgICk7XG4gICAgICByZXR1cm4gbWF0Y2hpbmdQYWNrYWdlICE9PSB1bmRlZmluZWQ7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfTtcblxuICBwcml2YXRlIHRyeUdldERlcGVuZGVuY2llcyA9IGFzeW5jICgpID0+IHtcbiAgICBpZiAoIXRoaXMuZGVwZW5kZW5jaWVzKSB7XG4gICAgICB0aGlzLmRlcGVuZGVuY2llcyA9XG4gICAgICAgIGF3YWl0IHRoaXMucGFja2FnZU1hbmFnZXJDb250cm9sbGVyLnRyeUdldERlcGVuZGVuY2llcygpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5kZXBlbmRlbmNpZXM7XG4gIH07XG59XG4iXX0=