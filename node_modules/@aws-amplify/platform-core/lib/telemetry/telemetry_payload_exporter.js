"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.DefaultTelemetryPayloadExporter = void 0;
const core_1 = require("@opentelemetry/core");
const https_1 = __importDefault(require("https"));
const is_ci_1 = __importDefault(require("is-ci"));
const os_1 = __importDefault(require("os"));
const uuid_1 = require("uuid");
const get_telemetry_url_1 = require("./get_telemetry_url");
const telemetry_payload_1 = require("./telemetry_payload");
const constants_1 = require("./constants");
const get_local_project_id_1 = require("./get_local_project_id");
const account_id_fetcher_1 = require("./account_id_fetcher");
const region_fetcher_1 = require("./region_fetcher");
const translate_error_to_telemetry_error_details_1 = require("./translate_error_to_telemetry_error_details");
const errors_1 = require("../errors");
/**
 * Maps data from span to payload and sends the payload
 */
class DefaultTelemetryPayloadExporter {
    dependencies;
    payloadVersion;
    sessionId;
    url;
    accountIdFetcher;
    regionFetcher;
    isShutdown = false;
    spanQueue = [];
    dependenciesToReport;
    /**
     * Constructor for DefaultTelemetryPayloadExporter
     */
    constructor(dependencies, payloadVersion = constants_1.latestPayloadVersion, sessionId = (0, uuid_1.v4)(), url = (0, get_telemetry_url_1.getUrl)(), accountIdFetcher = new account_id_fetcher_1.AccountIdFetcher(), regionFetcher = new region_fetcher_1.RegionFetcher()) {
        this.dependencies = dependencies;
        this.payloadVersion = payloadVersion;
        this.sessionId = sessionId;
        this.url = url;
        this.accountIdFetcher = accountIdFetcher;
        this.regionFetcher = regionFetcher;
        const targetDependencies = [
            '@aws-amplify/ai-constructs',
            '@aws-amplify/auth-construct',
            '@aws-amplify/backend',
            '@aws-amplify/backend-ai',
            '@aws-amplify/backend-auth',
            '@aws-amplify/backend-cli',
            '@aws-amplify/backend-data',
            '@aws-amplify/backend-deployer',
            '@aws-amplify/backend-function',
            '@aws-amplify/backend-output-schemas',
            '@aws-amplify/backend-output-storage',
            '@aws-amplify/backend-secret',
            '@aws-amplify/backend-storage',
            '@aws-amplify/cli-core',
            '@aws-amplify/client-config',
            '@aws-amplify/deployed-backend-client',
            '@aws-amplify/form-generator',
            '@aws-amplify/model-generator',
            '@aws-amplify/platform-core',
            '@aws-amplify/plugin-types',
            '@aws-amplify/sandbox',
            '@aws-amplify/schema-generator',
            '@aws-amplify/seed',
            'aws-amplify',
            'aws-cdk',
            'aws-cdk-lib',
        ];
        this.dependenciesToReport = this.dependencies?.filter((dependency) => targetDependencies.includes(dependency.name));
    }
    export = async (spans, resultCallback) => {
        if (this.isShutdown) {
            resultCallback({ code: core_1.ExportResultCode.FAILED });
            return;
        }
        try {
            this.spanQueue.push(...spans);
            await this.sendSpans();
            resultCallback({ code: core_1.ExportResultCode.SUCCESS });
        }
        catch {
            resultCallback({ code: core_1.ExportResultCode.FAILED });
        }
    };
    shutdown = async () => {
        await this.sendSpans();
    };
    forceFlush = async () => {
        await this.sendSpans();
    };
    sendSpans = async () => {
        for (const span of this.spanQueue) {
            try {
                const payload = await this.getTelemetryPayload(span);
                if (payload) {
                    await this.send(payload);
                }
                // eslint-disable-next-line @aws-amplify/amplify-backend-rules/no-empty-catch
            }
            catch {
                // Don't propogate errors related to not being able to send telemetry
            }
            this.spanQueue.shift();
        }
    };
    getTelemetryPayload = async (span) => {
        try {
            let payload;
            const basePayload = {
                identifiers: {
                    payloadVersion: this.payloadVersion,
                    sessionUuid: this.sessionId,
                    eventId: (0, uuid_1.v4)(),
                    timestamp: new Date().toISOString(),
                    localProjectId: await (0, get_local_project_id_1.getLocalProjectId)(),
                    accountId: await this.accountIdFetcher.fetch(),
                    awsRegion: await this.regionFetcher.fetch(),
                },
                environment: {
                    os: {
                        platform: os_1.default.platform(),
                        release: os_1.default.release(),
                    },
                    shell: os_1.default.userInfo().shell ?? '',
                    npmUserAgent: process.env.npm_config_user_agent ?? '',
                    ci: is_ci_1.default,
                    memory: {
                        total: os_1.default.totalmem(),
                        free: os_1.default.freemem(),
                    },
                },
                project: {
                    dependencies: this.dependenciesToReport,
                },
            };
            if (Object.keys(span.attributes).length >= constants_1.telemetrySpanAttributeCountLimit) {
                payload = {
                    ...basePayload, // to undo Partial typing on basePayload to ensure payload completeness
                    event: {
                        state: 'FAILED',
                        command: {
                            path: [],
                            parameters: [],
                        },
                    },
                    latency: { total: 0 },
                    error: (0, translate_error_to_telemetry_error_details_1.translateErrorToTelemetryErrorDetails)(new errors_1.AmplifyFault('TelemetrySpanAttributeCountLimitFault', {
                        message: `Telemetry span attribute count has hit the limit of ${constants_1.telemetrySpanAttributeCountLimit}`,
                    })),
                };
            }
            else {
                const unflattened = this.unflattenSpanAttributes(span.attributes);
                payload = {
                    ...basePayload, // to undo Partial typing on basePayload to ensure payload completeness
                    event: unflattened.event,
                    latency: unflattened.latency,
                    error: unflattened.error,
                };
            }
            const parsedPayload = telemetry_payload_1.telemetryPayloadSchema.parse(payload);
            return parsedPayload;
        }
        catch {
            // Don't propogate errors related to not being able to get telemetry payload
            return;
        }
    };
    // Unflattens dot notation span attributes into telemetry payload
    unflattenSpanAttributes = (attributes) => {
        // Using any here is safe because we parse the result with telemetry schema
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        const result = {};
        for (const [flatKey, value] of Object.entries(attributes)) {
            const keys = flatKey.split('.');
            let current = result;
            // Navigate through the nested structure
            for (let i = 0; i < keys.length - 1; i++) {
                const key = keys[i];
                // Create nested object if it doesn't exist
                if (!(key in current)) {
                    current[key] = {};
                }
                current = current[key];
            }
            // Set the value at the final key
            const lastKey = keys[keys.length - 1];
            current[lastKey] = value;
        }
        return result;
    };
    send = (data) => {
        return new Promise((resolve) => {
            const payload = JSON.stringify(data);
            const req = https_1.default.request({
                hostname: this.url.hostname,
                port: this.url.port,
                path: this.url.path,
                method: 'POST',
                headers: {
                    'content-type': 'application/json',
                    'content-length': payload.length,
                },
            });
            req.on('error', () => {
                /* noop */
            });
            req.setTimeout(2000, () => {
                // 2 seconds
                resolve();
            });
            req.write(payload);
            req.end(() => {
                resolve();
            });
        });
    };
}
exports.DefaultTelemetryPayloadExporter = DefaultTelemetryPayloadExporter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVsZW1ldHJ5X3BheWxvYWRfZXhwb3J0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdGVsZW1ldHJ5L3RlbGVtZXRyeV9wYXlsb2FkX2V4cG9ydGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLDhDQUFxRTtBQUVyRSxrREFBMEI7QUFDMUIsa0RBQXlCO0FBQ3pCLDRDQUFvQjtBQUNwQiwrQkFBb0M7QUFDcEMsMkRBQTZDO0FBQzdDLDJEQUErRTtBQUMvRSwyQ0FHcUI7QUFDckIsaUVBQTJEO0FBQzNELDZEQUF3RDtBQUN4RCxxREFBaUQ7QUFFakQsNkdBQXFHO0FBQ3JHLHNDQUF5QztBQUV6Qzs7R0FFRztBQUNILE1BQWEsK0JBQStCO0lBU3ZCO0lBQ0E7SUFDQTtJQUNBO0lBQ0E7SUFDQTtJQWJYLFVBQVUsR0FBRyxLQUFLLENBQUM7SUFDbkIsU0FBUyxHQUFtQixFQUFFLENBQUM7SUFDL0Isb0JBQW9CLENBQXFCO0lBRWpEOztPQUVHO0lBQ0gsWUFDbUIsWUFBZ0MsRUFDaEMsaUJBQWlCLGdDQUFvQixFQUNyQyxZQUFZLElBQUEsU0FBTSxHQUFFLEVBQ3BCLE1BQU0sSUFBQSwwQkFBTSxHQUFFLEVBQ2QsbUJBQW1CLElBQUkscUNBQWdCLEVBQUUsRUFDekMsZ0JBQWdCLElBQUksOEJBQWEsRUFBRTtRQUxuQyxpQkFBWSxHQUFaLFlBQVksQ0FBb0I7UUFDaEMsbUJBQWMsR0FBZCxjQUFjLENBQXVCO1FBQ3JDLGNBQVMsR0FBVCxTQUFTLENBQVc7UUFDcEIsUUFBRyxHQUFILEdBQUcsQ0FBVztRQUNkLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBeUI7UUFDekMsa0JBQWEsR0FBYixhQUFhLENBQXNCO1FBRXBELE1BQU0sa0JBQWtCLEdBQUc7WUFDekIsNEJBQTRCO1lBQzVCLDZCQUE2QjtZQUM3QixzQkFBc0I7WUFDdEIseUJBQXlCO1lBQ3pCLDJCQUEyQjtZQUMzQiwwQkFBMEI7WUFDMUIsMkJBQTJC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QUNaLENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUM7Q0FDSDtBQXpORCwwRUF5TkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFeHBvcnRSZXN1bHQsIEV4cG9ydFJlc3VsdENvZGUgfSBmcm9tICdAb3BlbnRlbGVtZXRyeS9jb3JlJztcbmltcG9ydCB7IFJlYWRhYmxlU3BhbiB9IGZyb20gJ0BvcGVudGVsZW1ldHJ5L3Nkay10cmFjZS1iYXNlJztcbmltcG9ydCBodHRwcyBmcm9tICdodHRwcyc7XG5pbXBvcnQgaXNDSSBmcm9tICdpcy1jaSc7XG5pbXBvcnQgb3MgZnJvbSAnb3MnO1xuaW1wb3J0IHsgdjQgYXMgdXVpZFY0IH0gZnJvbSAndXVpZCc7XG5pbXBvcnQgeyBnZXRVcmwgfSBmcm9tICcuL2dldF90ZWxlbWV0cnlfdXJsJztcbmltcG9ydCB7IFRlbGVtZXRyeVBheWxvYWQsIHRlbGVtZXRyeVBheWxvYWRTY2hlbWEgfSBmcm9tICcuL3RlbGVtZXRyeV9wYXlsb2FkJztcbmltcG9ydCB7XG4gIGxhdGVzdFBheWxvYWRWZXJzaW9uLFxuICB0ZWxlbWV0cnlTcGFuQXR0cmlidXRlQ291bnRMaW1pdCxcbn0gZnJvbSAnLi9jb25zdGFudHMnO1xuaW1wb3J0IHsgZ2V0TG9jYWxQcm9qZWN0SWQgfSBmcm9tICcuL2dldF9sb2NhbF9wcm9qZWN0X2lkJztcbmltcG9ydCB7IEFjY291bnRJZEZldGNoZXIgfSBmcm9tICcuL2FjY291bnRfaWRfZmV0Y2hlcic7XG5pbXBvcnQgeyBSZWdpb25GZXRjaGVyIH0gZnJvbSAnLi9yZWdpb25fZmV0Y2hlcic7XG5pbXBvcnQgeyBEZXBlbmRlbmN5IH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQgeyB0cmFuc2xhdGVFcnJvclRvVGVsZW1ldHJ5RXJyb3JEZXRhaWxzIH0gZnJvbSAnLi90cmFuc2xhdGVfZXJyb3JfdG9fdGVsZW1ldHJ5X2Vycm9yX2RldGFpbHMnO1xuaW1wb3J0IHsgQW1wbGlmeUZhdWx0IH0gZnJvbSAnLi4vZXJyb3JzJztcblxuLyoqXG4gKiBNYXBzIGRhdGEgZnJvbSBzcGFuIHRvIHBheWxvYWQgYW5kIHNlbmRzIHRoZSBwYXlsb2FkXG4gKi9cbmV4cG9ydCBjbGFzcyBEZWZhdWx0VGVsZW1ldHJ5UGF5bG9hZEV4cG9ydGVyIHtcbiAgcHJpdmF0ZSBpc1NodXRkb3duID0gZmFsc2U7XG4gIHByaXZhdGUgc3BhblF1ZXVlOiBSZWFkYWJsZVNwYW5bXSA9IFtdO1xuICBwcml2YXRlIGRlcGVuZGVuY2llc1RvUmVwb3J0PzogQXJyYXk8RGVwZW5kZW5jeT47XG5cbiAgLyoqXG4gICAqIENvbnN0cnVjdG9yIGZvciBEZWZhdWx0VGVsZW1ldHJ5UGF5bG9hZEV4cG9ydGVyXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IGRlcGVuZGVuY2llcz86IEFycmF5PERlcGVuZGVuY3k+LFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcGF5bG9hZFZlcnNpb24gPSBsYXRlc3RQYXlsb2FkVmVyc2lvbixcbiAgICBwcml2YXRlIHJlYWRvbmx5IHNlc3Npb25JZCA9IHV1aWRWNCgpLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgdXJsID0gZ2V0VXJsKCksXG4gICAgcHJpdmF0ZSByZWFkb25seSBhY2NvdW50SWRGZXRjaGVyID0gbmV3IEFjY291bnRJZEZldGNoZXIoKSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHJlZ2lvbkZldGNoZXIgPSBuZXcgUmVnaW9uRmV0Y2hlcigpLFxuICApIHtcbiAgICBjb25zdCB0YXJnZXREZXBlbmRlbmNpZXMgPSBbXG4gICAgICAnQGF3cy1hbXBsaWZ5L2FpLWNvbnN0cnVjdHMnLFxuICAgICAgJ0Bhd3MtYW1wbGlmeS9hdXRoLWNvbnN0cnVjdCcsXG4gICAgICAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQnLFxuICAgICAgJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLWFpJyxcbiAgICAgICdAYXdzLWFtcGxpZnkvYmFja2VuZC1hdXRoJyxcbiAgICAgICdAYXdzLWFtcGxpZnkvYmFja2VuZC1jbGknLFxuICAgICAgJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLWRhdGEnLFxuICAgICAgJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLWRlcGxveWVyJyxcbiAgICAgICdAYXdzLWFtcGxpZnkvYmFja2VuZC1mdW5jdGlvbicsXG4gICAgICAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQtb3V0cHV0LXNjaGVtYXMnLFxuICAgICAgJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLW91dHB1dC1zdG9yYWdlJyxcbiAgICAgICdAYXdzLWFtcGxpZnkvYmFja2VuZC1zZWNyZXQnLFxuICAgICAgJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLXN0b3JhZ2UnLFxuICAgICAgJ0Bhd3MtYW1wbGlmeS9jbGktY29yZScsXG4gICAgICAnQGF3cy1hbXBsaWZ5L2NsaWVudC1jb25maWcnLFxuICAgICAgJ0Bhd3MtYW1wbGlmeS9kZXBsb3llZC1iYWNrZW5kLWNsaWVudCcsXG4gICAgICAnQGF3cy1hbXBsaWZ5L2Zvcm0tZ2VuZXJhdG9yJyxcbiAgICAgICdAYXdzLWFtcGxpZnkvbW9kZWwtZ2VuZXJhdG9yJyxcbiAgICAgICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZScsXG4gICAgICAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcycsXG4gICAgICAnQGF3cy1hbXBsaWZ5L3NhbmRib3gnLFxuICAgICAgJ0Bhd3MtYW1wbGlmeS9zY2hlbWEtZ2VuZXJhdG9yJyxcbiAgICAgICdAYXdzLWFtcGxpZnkvc2VlZCcsXG4gICAgICAnYXdzLWFtcGxpZnknLFxuICAgICAgJ2F3cy1jZGsnLFxuICAgICAgJ2F3cy1jZGstbGliJyxcbiAgICBdO1xuXG4gICAgdGhpcy5kZXBlbmRlbmNpZXNUb1JlcG9ydCA9IHRoaXMuZGVwZW5kZW5jaWVzPy5maWx0ZXIoKGRlcGVuZGVuY3kpID0+XG4gICAgICB0YXJnZXREZXBlbmRlbmNpZXMuaW5jbHVkZXMoZGVwZW5kZW5jeS5uYW1lKSxcbiAgICApO1xuICB9XG5cbiAgZXhwb3J0ID0gYXN5bmMgKFxuICAgIHNwYW5zOiBSZWFkYWJsZVNwYW5bXSxcbiAgICByZXN1bHRDYWxsYmFjazogKHJlc3VsdDogRXhwb3J0UmVzdWx0KSA9PiB2b2lkLFxuICApOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICBpZiAodGhpcy5pc1NodXRkb3duKSB7XG4gICAgICByZXN1bHRDYWxsYmFjayh7IGNvZGU6IEV4cG9ydFJlc3VsdENvZGUuRkFJTEVEIH0pO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICB0aGlzLnNwYW5RdWV1ZS5wdXNoKC4uLnNwYW5zKTtcbiAgICAgIGF3YWl0IHRoaXMuc2VuZFNwYW5zKCk7XG4gICAgICByZXN1bHRDYWxsYmFjayh7IGNvZGU6IEV4cG9ydFJlc3VsdENvZGUuU1VDQ0VTUyB9KTtcbiAgICB9IGNhdGNoIHtcbiAgICAgIHJlc3VsdENhbGxiYWNrKHsgY29kZTogRXhwb3J0UmVzdWx0Q29kZS5GQUlMRUQgfSk7XG4gICAgfVxuICB9O1xuXG4gIHNodXRkb3duID0gYXN5bmMgKCk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIGF3YWl0IHRoaXMuc2VuZFNwYW5zKCk7XG4gIH07XG5cbiAgZm9yY2VGbHVzaCA9IGFzeW5jICgpOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICBhd2FpdCB0aGlzLnNlbmRTcGFucygpO1xuICB9O1xuXG4gIHByaXZhdGUgc2VuZFNwYW5zID0gYXN5bmMgKCkgPT4ge1xuICAgIGZvciAoY29uc3Qgc3BhbiBvZiB0aGlzLnNwYW5RdWV1ZSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgcGF5bG9hZCA9IGF3YWl0IHRoaXMuZ2V0VGVsZW1ldHJ5UGF5bG9hZChzcGFuKTtcbiAgICAgICAgaWYgKHBheWxvYWQpIHtcbiAgICAgICAgICBhd2FpdCB0aGlzLnNlbmQocGF5bG9hZCk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEBhd3MtYW1wbGlmeS9hbXBsaWZ5LWJhY2tlbmQtcnVsZXMvbm8tZW1wdHktY2F0Y2hcbiAgICAgIH0gY2F0Y2gge1xuICAgICAgICAvLyBEb24ndCBwcm9wb2dhdGUgZXJyb3JzIHJlbGF0ZWQgdG8gbm90IGJlaW5nIGFibGUgdG8gc2VuZCB0ZWxlbWV0cnlcbiAgICAgIH1cbiAgICAgIHRoaXMuc3BhblF1ZXVlLnNoaWZ0KCk7XG4gICAgfVxuICB9O1xuXG4gIHByaXZhdGUgZ2V0VGVsZW1ldHJ5UGF5bG9hZCA9IGFzeW5jIChcbiAgICBzcGFuOiBSZWFkYWJsZVNwYW4sXG4gICk6IFByb21pc2U8VGVsZW1ldHJ5UGF5bG9hZCB8IHVuZGVmaW5lZD4gPT4ge1xuICAgIHRyeSB7XG4gICAgICBsZXQgcGF5bG9hZDogVGVsZW1ldHJ5UGF5bG9hZDtcbiAgICAgIGNvbnN0IGJhc2VQYXlsb2FkOiBQYXJ0aWFsPFRlbGVtZXRyeVBheWxvYWQ+ID0ge1xuICAgICAgICBpZGVudGlmaWVyczoge1xuICAgICAgICAgIHBheWxvYWRWZXJzaW9uOiB0aGlzLnBheWxvYWRWZXJzaW9uLFxuICAgICAgICAgIHNlc3Npb25VdWlkOiB0aGlzLnNlc3Npb25JZCxcbiAgICAgICAgICBldmVudElkOiB1dWlkVjQoKSxcbiAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgICBsb2NhbFByb2plY3RJZDogYXdhaXQgZ2V0TG9jYWxQcm9qZWN0SWQoKSxcbiAgICAgICAgICBhY2NvdW50SWQ6IGF3YWl0IHRoaXMuYWNjb3VudElkRmV0Y2hlci5mZXRjaCgpLFxuICAgICAgICAgIGF3c1JlZ2lvbjogYXdhaXQgdGhpcy5yZWdpb25GZXRjaGVyLmZldGNoKCksXG4gICAgICAgIH0sXG4gICAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgICAgb3M6IHtcbiAgICAgICAgICAgIHBsYXRmb3JtOiBvcy5wbGF0Zm9ybSgpLFxuICAgICAgICAgICAgcmVsZWFzZTogb3MucmVsZWFzZSgpLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgc2hlbGw6IG9zLnVzZXJJbmZvKCkuc2hlbGwgPz8gJycsXG4gICAgICAgICAgbnBtVXNlckFnZW50OiBwcm9jZXNzLmVudi5ucG1fY29uZmlnX3VzZXJfYWdlbnQgPz8gJycsXG4gICAgICAgICAgY2k6IGlzQ0ksXG4gICAgICAgICAgbWVtb3J5OiB7XG4gICAgICAgICAgICB0b3RhbDogb3MudG90YWxtZW0oKSxcbiAgICAgICAgICAgIGZyZWU6IG9zLmZyZWVtZW0oKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBwcm9qZWN0OiB7XG4gICAgICAgICAgZGVwZW5kZW5jaWVzOiB0aGlzLmRlcGVuZGVuY2llc1RvUmVwb3J0LFxuICAgICAgICB9LFxuICAgICAgfTtcblxuICAgICAgaWYgKFxuICAgICAgICBPYmplY3Qua2V5cyhzcGFuLmF0dHJpYnV0ZXMpLmxlbmd0aCA+PSB0ZWxlbWV0cnlTcGFuQXR0cmlidXRlQ291bnRMaW1pdFxuICAgICAgKSB7XG4gICAgICAgIHBheWxvYWQgPSB7XG4gICAgICAgICAgLi4uKGJhc2VQYXlsb2FkIGFzIFRlbGVtZXRyeVBheWxvYWQpLCAvLyB0byB1bmRvIFBhcnRpYWwgdHlwaW5nIG9uIGJhc2VQYXlsb2FkIHRvIGVuc3VyZSBwYXlsb2FkIGNvbXBsZXRlbmVzc1xuICAgICAgICAgIGV2ZW50OiB7XG4gICAgICAgICAgICBzdGF0ZTogJ0ZBSUxFRCcsXG4gICAgICAgICAgICBjb21tYW5kOiB7XG4gICAgICAgICAgICAgIHBhdGg6IFtdLFxuICAgICAgICAgICAgICBwYXJhbWV0ZXJzOiBbXSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICBsYXRlbmN5OiB7IHRvdGFsOiAwIH0sXG4gICAgICAgICAgZXJyb3I6IHRyYW5zbGF0ZUVycm9yVG9UZWxlbWV0cnlFcnJvckRldGFpbHMoXG4gICAgICAgICAgICBuZXcgQW1wbGlmeUZhdWx0KCdUZWxlbWV0cnlTcGFuQXR0cmlidXRlQ291bnRMaW1pdEZhdWx0Jywge1xuICAgICAgICAgICAgICBtZXNzYWdlOiBgVGVsZW1ldHJ5IHNwYW4gYXR0cmlidXRlIGNvdW50IGhhcyBoaXQgdGhlIGxpbWl0IG9mICR7dGVsZW1ldHJ5U3BhbkF0dHJpYnV0ZUNvdW50TGltaXR9YCxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICksXG4gICAgICAgIH07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCB1bmZsYXR0ZW5lZCA9IHRoaXMudW5mbGF0dGVuU3BhbkF0dHJpYnV0ZXMoc3Bhbi5hdHRyaWJ1dGVzKTtcblxuICAgICAgICBwYXlsb2FkID0ge1xuICAgICAgICAgIC4uLihiYXNlUGF5bG9hZCBhcyBUZWxlbWV0cnlQYXlsb2FkKSwgLy8gdG8gdW5kbyBQYXJ0aWFsIHR5cGluZyBvbiBiYXNlUGF5bG9hZCB0byBlbnN1cmUgcGF5bG9hZCBjb21wbGV0ZW5lc3NcbiAgICAgICAgICBldmVudDogdW5mbGF0dGVuZWQuZXZlbnQsXG4gICAgICAgICAgbGF0ZW5jeTogdW5mbGF0dGVuZWQubGF0ZW5jeSxcbiAgICAgICAgICBlcnJvcjogdW5mbGF0dGVuZWQuZXJyb3IsXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHBhcnNlZFBheWxvYWQ6IFRlbGVtZXRyeVBheWxvYWQgPVxuICAgICAgICB0ZWxlbWV0cnlQYXlsb2FkU2NoZW1hLnBhcnNlKHBheWxvYWQpO1xuICAgICAgcmV0dXJuIHBhcnNlZFBheWxvYWQ7XG4gICAgfSBjYXRjaCB7XG4gICAgICAvLyBEb24ndCBwcm9wb2dhdGUgZXJyb3JzIHJlbGF0ZWQgdG8gbm90IGJlaW5nIGFibGUgdG8gZ2V0IHRlbGVtZXRyeSBwYXlsb2FkXG4gICAgICByZXR1cm47XG4gICAgfVxuICB9O1xuXG4gIC8vIFVuZmxhdHRlbnMgZG90IG5vdGF0aW9uIHNwYW4gYXR0cmlidXRlcyBpbnRvIHRlbGVtZXRyeSBwYXlsb2FkXG4gIHByaXZhdGUgdW5mbGF0dGVuU3BhbkF0dHJpYnV0ZXMgPSAoYXR0cmlidXRlczogUmVjb3JkPHN0cmluZywgdW5rbm93bj4pID0+IHtcbiAgICAvLyBVc2luZyBhbnkgaGVyZSBpcyBzYWZlIGJlY2F1c2Ugd2UgcGFyc2UgdGhlIHJlc3VsdCB3aXRoIHRlbGVtZXRyeSBzY2hlbWFcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICAgIGNvbnN0IHJlc3VsdDogYW55ID0ge307XG5cbiAgICBmb3IgKGNvbnN0IFtmbGF0S2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMoYXR0cmlidXRlcykpIHtcbiAgICAgIGNvbnN0IGtleXMgPSBmbGF0S2V5LnNwbGl0KCcuJyk7XG4gICAgICBsZXQgY3VycmVudCA9IHJlc3VsdDtcblxuICAgICAgLy8gTmF2aWdhdGUgdGhyb3VnaCB0aGUgbmVzdGVkIHN0cnVjdHVyZVxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aCAtIDE7IGkrKykge1xuICAgICAgICBjb25zdCBrZXkgPSBrZXlzW2ldO1xuICAgICAgICAvLyBDcmVhdGUgbmVzdGVkIG9iamVjdCBpZiBpdCBkb2Vzbid0IGV4aXN0XG4gICAgICAgIGlmICghKGtleSBpbiBjdXJyZW50KSkge1xuICAgICAgICAgIGN1cnJlbnRba2V5XSA9IHt9O1xuICAgICAgICB9XG4gICAgICAgIGN1cnJlbnQgPSBjdXJyZW50W2tleV07XG4gICAgICB9XG5cbiAgICAgIC8vIFNldCB0aGUgdmFsdWUgYXQgdGhlIGZpbmFsIGtleVxuICAgICAgY29uc3QgbGFzdEtleSA9IGtleXNba2V5cy5sZW5ndGggLSAxXTtcbiAgICAgIGN1cnJlbnRbbGFzdEtleV0gPSB2YWx1ZTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfTtcblxuICBwcml2YXRlIHNlbmQgPSAoZGF0YTogVGVsZW1ldHJ5UGF5bG9hZCkgPT4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZSkgPT4ge1xuICAgICAgY29uc3QgcGF5bG9hZDogc3RyaW5nID0gSlNPTi5zdHJpbmdpZnkoZGF0YSk7XG4gICAgICBjb25zdCByZXEgPSBodHRwcy5yZXF1ZXN0KHtcbiAgICAgICAgaG9zdG5hbWU6IHRoaXMudXJsLmhvc3RuYW1lLFxuICAgICAgICBwb3J0OiB0aGlzLnVybC5wb3J0LFxuICAgICAgICBwYXRoOiB0aGlzLnVybC5wYXRoLFxuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdjb250ZW50LXR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgJ2NvbnRlbnQtbGVuZ3RoJzogcGF5bG9hZC5sZW5ndGgsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICAgIHJlcS5vbignZXJyb3InLCAoKSA9PiB7XG4gICAgICAgIC8qIG5vb3AgKi9cbiAgICAgIH0pO1xuICAgICAgcmVxLnNldFRpbWVvdXQoMjAwMCwgKCkgPT4ge1xuICAgICAgICAvLyAyIHNlY29uZHNcbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfSk7XG5cbiAgICAgIHJlcS53cml0ZShwYXlsb2FkKTtcbiAgICAgIHJlcS5lbmQoKCkgPT4ge1xuICAgICAgICByZXNvbHZlKCk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfTtcbn1cbiJdfQ==