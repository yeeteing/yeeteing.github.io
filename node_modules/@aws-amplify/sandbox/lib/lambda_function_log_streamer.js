import { LogLevel } from '@aws-amplify/cli-core';
import { BackendOutputClientError, BackendOutputClientErrorType, } from '@aws-amplify/deployed-backend-client';
import { TagName } from '@aws-amplify/platform-core';
import { GetFunctionCommand } from '@aws-sdk/client-lambda';
/**
 * Logs streamer for customer defined lambda functions in a sandbox.
 */
export class LambdaFunctionLogStreamer {
    lambda;
    logsMonitor;
    backendOutputClient;
    printer;
    enabled = false;
    /**
     * Creates an instance of LambdaFunctionLogStreamer
     */
    constructor(lambda, logsMonitor, backendOutputClient, printer) {
        this.lambda = lambda;
        this.logsMonitor = logsMonitor;
        this.backendOutputClient = backendOutputClient;
        this.printer = printer;
    }
    /**
     * Starts streaming logs in the given sandbox.
     * @param sandboxBackendId The sandbox backend identifier.
     * @param streamingOptions Options to configure the log streaming.
     */
    startStreamingLogs = async (sandboxBackendId, streamingOptions) => {
        if (streamingOptions?.enabled) {
            this.enabled = true;
        }
        else {
            return;
        }
        let backendOutput = {};
        try {
            backendOutput =
                await this.backendOutputClient.getOutput(sandboxBackendId);
        }
        catch (error) {
            // If stack does not exist or hasn't deployed successfully, we do not want to go further to start streaming logs
            if (BackendOutputClientError.isBackendOutputClientError(error) &&
                [
                    BackendOutputClientErrorType.NO_STACK_FOUND,
                    BackendOutputClientErrorType.NO_OUTPUTS_FOUND,
                ].some((code) => error.code === code)) {
                this.enabled = false;
                return;
            }
        }
        const definedFunctionsPayload = backendOutput['AWS::Amplify::Function']?.payload.definedFunctions;
        const definedConversationHandlersPayload = backendOutput['AWS::Amplify::AI::Conversation']?.payload
            .definedConversationHandlers;
        const deployedFunctionNames = definedFunctionsPayload
            ? JSON.parse(definedFunctionsPayload)
            : [];
        deployedFunctionNames.push(...(definedConversationHandlersPayload
            ? JSON.parse(definedConversationHandlersPayload)
            : []));
        for (const functionName of deployedFunctionNames) {
            const getFunctionResponse = await this.lambda.send(new GetFunctionCommand({
                FunctionName: functionName,
            }));
            const logGroupName = getFunctionResponse.Configuration?.LoggingConfig?.LogGroup;
            if (!logGroupName) {
                this.printer.log(`[Sandbox] Could not find logGroup for lambda function ${functionName}. Logs will not be streamed for this function.`, LogLevel.DEBUG);
                continue;
            }
            const friendlyFunctionName = getFunctionResponse.Tags?.[TagName.FRIENDLY_NAME];
            if (!friendlyFunctionName) {
                this.printer.log(`[Sandbox] Could not find user defined name for lambda function ${functionName}. Logs will not be streamed for this function.`, LogLevel.DEBUG);
                continue;
            }
            let shouldStreamLogs = false;
            if (streamingOptions.logsFilters) {
                for (const filter of streamingOptions.logsFilters) {
                    const pattern = new RegExp(filter);
                    if (pattern.test(friendlyFunctionName)) {
                        shouldStreamLogs = true;
                        this.printer.log(`[Sandbox] Logs for function ${friendlyFunctionName} will be streamed as it matched filter '${filter}'`, LogLevel.DEBUG);
                        break;
                    }
                }
            }
            else {
                // No logs filter, means we stream all logs
                this.printer.log(`[Sandbox] Logs for function ${friendlyFunctionName} will be streamed.`, LogLevel.DEBUG);
                shouldStreamLogs = true;
            }
            if (shouldStreamLogs) {
                this.logsMonitor?.addLogGroups(friendlyFunctionName, logGroupName);
            }
            else {
                this.printer.log(`[Sandbox] Skipping logs streaming for function ${friendlyFunctionName} since it did not match any filters. To stream logs for this function, ensure at least one of your logs-filters match this function name.`, LogLevel.DEBUG);
            }
        }
        // finally start listening
        this.logsMonitor?.activate(streamingOptions.logsOutFile);
    };
    stopStreamingLogs = () => {
        if (!this.enabled) {
            return;
        }
        this.printer.log(`[Sandbox] Streaming function logs will be paused during the deployment and will be resumed after the deployment is completed.`, LogLevel.DEBUG);
        this.logsMonitor?.pause();
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGFtYmRhX2Z1bmN0aW9uX2xvZ19zdHJlYW1lci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9sYW1iZGFfZnVuY3Rpb25fbG9nX3N0cmVhbWVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQVcsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRCxPQUFPLEVBRUwsd0JBQXdCLEVBQ3hCLDRCQUE0QixHQUM3QixNQUFNLHNDQUFzQyxDQUFDO0FBQzlDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUdyRCxPQUFPLEVBQUUsa0JBQWtCLEVBQWdCLE1BQU0sd0JBQXdCLENBQUM7QUFJMUU7O0dBRUc7QUFDSCxNQUFNLE9BQU8seUJBQXlCO0lBTWpCO0lBQ0E7SUFDQTtJQUNBO0lBUlgsT0FBTyxHQUFZLEtBQUssQ0FBQztJQUNqQzs7T0FFRztJQUNILFlBQ21CLE1BQW9CLEVBQ3BCLFdBQXNDLEVBQ3RDLG1CQUF3QyxFQUN4QyxPQUFnQjtRQUhoQixXQUFNLEdBQU4sTUFBTSxDQUFjO1FBQ3BCLGdCQUFXLEdBQVgsV0FBVyxDQUEyQjtRQUN0Qyx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO1FBQ3hDLFlBQU8sR0FBUCxPQUFPLENBQVM7SUFDaEMsQ0FBQztJQUVKOzs7O09BSUc7SUFDSCxrQkFBa0IsR0FBRyxLQUFLLEVBQ3hCLGdCQUFtQyxFQUNuQyxnQkFBa0QsRUFDbEQsRUFBRTtRQUNGLElBQUksZ0JBQWdCLEVBQUUsT0FBTyxFQUFFLENBQUM7WUFDOUIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7UUFDdEIsQ0FBQzthQUFNLENBQUM7WUFDTixPQUFPO1FBQ1QsQ0FBQztRQUVELElBQUksYUFBYSxHQUFrQixFQUFFLENBQUM7UUFDdEMsSUFBSSxDQUFDO1lBQ0gsYUFBYTtnQkFDWCxNQUFNLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLENB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QUFHLElBQUksQ0FBQztZQUMxQixDQUFDO1lBRUQsSUFBSSxnQkFBZ0IsRUFBRSxDQUFDO2dCQUNyQixJQUFJLENBQUMsV0FBVyxFQUFFLFlBQVksQ0FBQyxvQkFBb0IsRUFBRSxZQUFZLENBQUMsQ0FBQztZQUNyRSxDQUFDO2lCQUFNLENBQUM7Z0JBQ04sSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQ2Qsa0RBQWtELG9CQUFvQiwySUFBMkksRUFDak4sUUFBUSxDQUFDLEtBQUssQ0FDZixDQUFDO1lBQ0osQ0FBQztRQUNILENBQUM7UUFFRCwwQkFBMEI7UUFDMUIsSUFBSSxDQUFDLFdBQVcsRUFBRSxRQUFRLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDM0QsQ0FBQyxDQUFDO0lBRUYsaUJBQWlCLEdBQUcsR0FBRyxFQUFFO1FBQ3ZCLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDbEIsT0FBTztRQUNULENBQUM7UUFDRCxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FDZCwrSEFBK0gsRUFDL0gsUUFBUSxDQUFDLEtBQUssQ0FDZixDQUFDO1FBQ0YsSUFBSSxDQUFDLFdBQVcsRUFBRSxLQUFLLEVBQUUsQ0FBQztJQUM1QixDQUFDLENBQUM7Q0FDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExvZ0xldmVsLCBQcmludGVyIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L2NsaS1jb3JlJztcbmltcG9ydCB7XG4gIEJhY2tlbmRPdXRwdXRDbGllbnQsXG4gIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvcixcbiAgQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2RlcGxveWVkLWJhY2tlbmQtY2xpZW50JztcbmltcG9ydCB7IFRhZ05hbWUgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5pbXBvcnQgeyBCYWNrZW5kSWRlbnRpZmllciwgQmFja2VuZE91dHB1dCB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuXG5pbXBvcnQgeyBHZXRGdW5jdGlvbkNvbW1hbmQsIExhbWJkYUNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1sYW1iZGEnO1xuaW1wb3J0IHsgQ2xvdWRXYXRjaExvZ0V2ZW50TW9uaXRvciB9IGZyb20gJy4vY2xvdWR3YXRjaF9sb2dzX21vbml0b3IuanMnO1xuaW1wb3J0IHsgU2FuZGJveEZ1bmN0aW9uU3RyZWFtaW5nT3B0aW9ucyB9IGZyb20gJy4vc2FuZGJveC5qcyc7XG5cbi8qKlxuICogTG9ncyBzdHJlYW1lciBmb3IgY3VzdG9tZXIgZGVmaW5lZCBsYW1iZGEgZnVuY3Rpb25zIGluIGEgc2FuZGJveC5cbiAqL1xuZXhwb3J0IGNsYXNzIExhbWJkYUZ1bmN0aW9uTG9nU3RyZWFtZXIge1xuICBwcml2YXRlIGVuYWJsZWQ6IGJvb2xlYW4gPSBmYWxzZTtcbiAgLyoqXG4gICAqIENyZWF0ZXMgYW4gaW5zdGFuY2Ugb2YgTGFtYmRhRnVuY3Rpb25Mb2dTdHJlYW1lclxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBsYW1iZGE6IExhbWJkYUNsaWVudCxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGxvZ3NNb25pdG9yOiBDbG91ZFdhdGNoTG9nRXZlbnRNb25pdG9yLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYmFja2VuZE91dHB1dENsaWVudDogQmFja2VuZE91dHB1dENsaWVudCxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByaW50ZXI6IFByaW50ZXIsXG4gICkge31cblxuICAvKipcbiAgICogU3RhcnRzIHN0cmVhbWluZyBsb2dzIGluIHRoZSBnaXZlbiBzYW5kYm94LlxuICAgKiBAcGFyYW0gc2FuZGJveEJhY2tlbmRJZCBUaGUgc2FuZGJveCBiYWNrZW5kIGlkZW50aWZpZXIuXG4gICAqIEBwYXJhbSBzdHJlYW1pbmdPcHRpb25zIE9wdGlvbnMgdG8gY29uZmlndXJlIHRoZSBsb2cgc3RyZWFtaW5nLlxuICAgKi9cbiAgc3RhcnRTdHJlYW1pbmdMb2dzID0gYXN5bmMgKFxuICAgIHNhbmRib3hCYWNrZW5kSWQ6IEJhY2tlbmRJZGVudGlmaWVyLFxuICAgIHN0cmVhbWluZ09wdGlvbnM/OiBTYW5kYm94RnVuY3Rpb25TdHJlYW1pbmdPcHRpb25zLFxuICApID0+IHtcbiAgICBpZiAoc3RyZWFtaW5nT3B0aW9ucz8uZW5hYmxlZCkge1xuICAgICAgdGhpcy5lbmFibGVkID0gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxldCBiYWNrZW5kT3V0cHV0OiBCYWNrZW5kT3V0cHV0ID0ge307XG4gICAgdHJ5IHtcbiAgICAgIGJhY2tlbmRPdXRwdXQgPVxuICAgICAgICBhd2FpdCB0aGlzLmJhY2tlbmRPdXRwdXRDbGllbnQuZ2V0T3V0cHV0KHNhbmRib3hCYWNrZW5kSWQpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAvLyBJZiBzdGFjayBkb2VzIG5vdCBleGlzdCBvciBoYXNuJ3QgZGVwbG95ZWQgc3VjY2Vzc2Z1bGx5LCB3ZSBkbyBub3Qgd2FudCB0byBnbyBmdXJ0aGVyIHRvIHN0YXJ0IHN0cmVhbWluZyBsb2dzXG4gICAgICBpZiAoXG4gICAgICAgIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvci5pc0JhY2tlbmRPdXRwdXRDbGllbnRFcnJvcihlcnJvcikgJiZcbiAgICAgICAgW1xuICAgICAgICAgIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvclR5cGUuTk9fU1RBQ0tfRk9VTkQsXG4gICAgICAgICAgQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZS5OT19PVVRQVVRTX0ZPVU5ELFxuICAgICAgICBdLnNvbWUoKGNvZGUpID0+IChlcnJvciBhcyBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3IpLmNvZGUgPT09IGNvZGUpXG4gICAgICApIHtcbiAgICAgICAgdGhpcy5lbmFibGVkID0gZmFsc2U7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBkZWZpbmVkRnVuY3Rpb25zUGF5bG9hZCA9XG4gICAgICBiYWNrZW5kT3V0cHV0WydBV1M6OkFtcGxpZnk6OkZ1bmN0aW9uJ10/LnBheWxvYWQuZGVmaW5lZEZ1bmN0aW9ucztcbiAgICBjb25zdCBkZWZpbmVkQ29udmVyc2F0aW9uSGFuZGxlcnNQYXlsb2FkID1cbiAgICAgIGJhY2tlbmRPdXRwdXRbJ0FXUzo6QW1wbGlmeTo6QUk6OkNvbnZlcnNhdGlvbiddPy5wYXlsb2FkXG4gICAgICAgIC5kZWZpbmVkQ29udmVyc2F0aW9uSGFuZGxlcnM7XG4gICAgY29uc3QgZGVwbG95ZWRGdW5jdGlvbk5hbWVzID0gZGVmaW5lZEZ1bmN0aW9uc1BheWxvYWRcbiAgICAgID8gKEpTT04ucGFyc2UoZGVmaW5lZEZ1bmN0aW9uc1BheWxvYWQpIGFzIHN0cmluZ1tdKVxuICAgICAgOiBbXTtcbiAgICBkZXBsb3llZEZ1bmN0aW9uTmFtZXMucHVzaChcbiAgICAgIC4uLihkZWZpbmVkQ29udmVyc2F0aW9uSGFuZGxlcnNQYXlsb2FkXG4gICAgICAgID8gKEpTT04ucGFyc2UoZGVmaW5lZENvbnZlcnNhdGlvbkhhbmRsZXJzUGF5bG9hZCkgYXMgc3RyaW5nW10pXG4gICAgICAgIDogW10pLFxuICAgICk7XG5cbiAgICBmb3IgKGNvbnN0IGZ1bmN0aW9uTmFtZSBvZiBkZXBsb3llZEZ1bmN0aW9uTmFtZXMpIHtcbiAgICAgIGNvbnN0IGdldEZ1bmN0aW9uUmVzcG9uc2UgPSBhd2FpdCB0aGlzLmxhbWJkYS5zZW5kKFxuICAgICAgICBuZXcgR2V0RnVuY3Rpb25Db21tYW5kKHtcbiAgICAgICAgICBGdW5jdGlvbk5hbWU6IGZ1bmN0aW9uTmFtZSxcbiAgICAgICAgfSksXG4gICAgICApO1xuICAgICAgY29uc3QgbG9nR3JvdXBOYW1lID1cbiAgICAgICAgZ2V0RnVuY3Rpb25SZXNwb25zZS5Db25maWd1cmF0aW9uPy5Mb2dnaW5nQ29uZmlnPy5Mb2dHcm91cDtcbiAgICAgIGlmICghbG9nR3JvdXBOYW1lKSB7XG4gICAgICAgIHRoaXMucHJpbnRlci5sb2coXG4gICAgICAgICAgYFtTYW5kYm94XSBDb3VsZCBub3QgZmluZCBsb2dHcm91cCBmb3IgbGFtYmRhIGZ1bmN0aW9uICR7ZnVuY3Rpb25OYW1lfS4gTG9ncyB3aWxsIG5vdCBiZSBzdHJlYW1lZCBmb3IgdGhpcyBmdW5jdGlvbi5gLFxuICAgICAgICAgIExvZ0xldmVsLkRFQlVHLFxuICAgICAgICApO1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGZyaWVuZGx5RnVuY3Rpb25OYW1lID1cbiAgICAgICAgZ2V0RnVuY3Rpb25SZXNwb25zZS5UYWdzPy5bVGFnTmFtZS5GUklFTkRMWV9OQU1FXTtcbiAgICAgIGlmICghZnJpZW5kbHlGdW5jdGlvbk5hbWUpIHtcbiAgICAgICAgdGhpcy5wcmludGVyLmxvZyhcbiAgICAgICAgICBgW1NhbmRib3hdIENvdWxkIG5vdCBmaW5kIHVzZXIgZGVmaW5lZCBuYW1lIGZvciBsYW1iZGEgZnVuY3Rpb24gJHtmdW5jdGlvbk5hbWV9LiBMb2dzIHdpbGwgbm90IGJlIHN0cmVhbWVkIGZvciB0aGlzIGZ1bmN0aW9uLmAsXG4gICAgICAgICAgTG9nTGV2ZWwuREVCVUcsXG4gICAgICAgICk7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBsZXQgc2hvdWxkU3RyZWFtTG9ncyA9IGZhbHNlO1xuICAgICAgaWYgKHN0cmVhbWluZ09wdGlvbnMubG9nc0ZpbHRlcnMpIHtcbiAgICAgICAgZm9yIChjb25zdCBmaWx0ZXIgb2Ygc3RyZWFtaW5nT3B0aW9ucy5sb2dzRmlsdGVycykge1xuICAgICAgICAgIGNvbnN0IHBhdHRlcm4gPSBuZXcgUmVnRXhwKGZpbHRlcik7XG4gICAgICAgICAgaWYgKHBhdHRlcm4udGVzdChmcmllbmRseUZ1bmN0aW9uTmFtZSkpIHtcbiAgICAgICAgICAgIHNob3VsZFN0cmVhbUxvZ3MgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5wcmludGVyLmxvZyhcbiAgICAgICAgICAgICAgYFtTYW5kYm94XSBMb2dzIGZvciBmdW5jdGlvbiAke2ZyaWVuZGx5RnVuY3Rpb25OYW1lfSB3aWxsIGJlIHN0cmVhbWVkIGFzIGl0IG1hdGNoZWQgZmlsdGVyICcke2ZpbHRlcn0nYCxcbiAgICAgICAgICAgICAgTG9nTGV2ZWwuREVCVUcsXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBObyBsb2dzIGZpbHRlciwgbWVhbnMgd2Ugc3RyZWFtIGFsbCBsb2dzXG4gICAgICAgIHRoaXMucHJpbnRlci5sb2coXG4gICAgICAgICAgYFtTYW5kYm94XSBMb2dzIGZvciBmdW5jdGlvbiAke2ZyaWVuZGx5RnVuY3Rpb25OYW1lfSB3aWxsIGJlIHN0cmVhbWVkLmAsXG4gICAgICAgICAgTG9nTGV2ZWwuREVCVUcsXG4gICAgICAgICk7XG4gICAgICAgIHNob3VsZFN0cmVhbUxvZ3MgPSB0cnVlO1xuICAgICAgfVxuXG4gICAgICBpZiAoc2hvdWxkU3RyZWFtTG9ncykge1xuICAgICAgICB0aGlzLmxvZ3NNb25pdG9yPy5hZGRMb2dHcm91cHMoZnJpZW5kbHlGdW5jdGlvbk5hbWUsIGxvZ0dyb3VwTmFtZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnByaW50ZXIubG9nKFxuICAgICAgICAgIGBbU2FuZGJveF0gU2tpcHBpbmcgbG9ncyBzdHJlYW1pbmcgZm9yIGZ1bmN0aW9uICR7ZnJpZW5kbHlGdW5jdGlvbk5hbWV9IHNpbmNlIGl0IGRpZCBub3QgbWF0Y2ggYW55IGZpbHRlcnMuIFRvIHN0cmVhbSBsb2dzIGZvciB0aGlzIGZ1bmN0aW9uLCBlbnN1cmUgYXQgbGVhc3Qgb25lIG9mIHlvdXIgbG9ncy1maWx0ZXJzIG1hdGNoIHRoaXMgZnVuY3Rpb24gbmFtZS5gLFxuICAgICAgICAgIExvZ0xldmVsLkRFQlVHLFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIGZpbmFsbHkgc3RhcnQgbGlzdGVuaW5nXG4gICAgdGhpcy5sb2dzTW9uaXRvcj8uYWN0aXZhdGUoc3RyZWFtaW5nT3B0aW9ucy5sb2dzT3V0RmlsZSk7XG4gIH07XG5cbiAgc3RvcFN0cmVhbWluZ0xvZ3MgPSAoKSA9PiB7XG4gICAgaWYgKCF0aGlzLmVuYWJsZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5wcmludGVyLmxvZyhcbiAgICAgIGBbU2FuZGJveF0gU3RyZWFtaW5nIGZ1bmN0aW9uIGxvZ3Mgd2lsbCBiZSBwYXVzZWQgZHVyaW5nIHRoZSBkZXBsb3ltZW50IGFuZCB3aWxsIGJlIHJlc3VtZWQgYWZ0ZXIgdGhlIGRlcGxveW1lbnQgaXMgY29tcGxldGVkLmAsXG4gICAgICBMb2dMZXZlbC5ERUJVRyxcbiAgICApO1xuICAgIHRoaXMubG9nc01vbml0b3I/LnBhdXNlKCk7XG4gIH07XG59XG4iXX0=