import { Arn, Lazy, Stack, Tags } from 'aws-cdk-lib';
import { AmplifyUserError, TagName } from '@aws-amplify/platform-core';
import { AmplifyFunctionBase } from './function_construct_base.js';
import { FunctionResourceAccessAcceptor } from './resource_access_acceptor.js';
import { amplifySsmEnvConfigKey } from './constants.js';
import { Effect, PolicyStatement } from 'aws-cdk-lib/aws-iam';
/**
 * Adapts provided CDK function as Amplify function.
 */
export class ProvidedFunctionFactory {
    functionProvider;
    props;
    generator;
    /**
     * Creates provided function factory.
     */
    constructor(functionProvider, props) {
        this.functionProvider = functionProvider;
        this.props = props;
    }
    /**
     * Creates a function instance.
     */
    getInstance(props) {
        if (!this.generator) {
            this.generator = new ProvidedFunctionGenerator(this.functionProvider, props.outputStorageStrategy, this.props);
        }
        return props.constructContainer.getOrCompute(this.generator);
    }
}
class ProvidedFunctionGenerator {
    functionProvider;
    outputStorageStrategy;
    resourceGroupName;
    constructor(functionProvider, outputStorageStrategy, props) {
        this.functionProvider = functionProvider;
        this.outputStorageStrategy = outputStorageStrategy;
        this.resourceGroupName = props?.resourceGroupName ?? 'function';
    }
    generateContainerEntry = ({ scope, backendSecretResolver, }) => {
        let providedFunction;
        try {
            providedFunction = this.functionProvider(scope);
        }
        catch (e) {
            if (e instanceof Error &&
                (e.message.includes('docker exited with status 1') ||
                    e.message.includes('docker ENOENT'))) {
                throw new AmplifyUserError('CustomFunctionProviderDockerError', {
                    message: 'Failed to instantiate custom function provider',
                    resolution: 'See https://docs.amplify.aws/react/build-a-backend/functions/custom-functions for more details about current limitations and troubleshooting steps.',
                }, e);
            }
            else {
                throw new AmplifyUserError('CustomFunctionProviderError', {
                    message: 'Failed to instantiate custom function provider',
                    resolution: 'Check the definition of your custom function provided in `defineFunction` and refer to the logs for more information. See https://docs.amplify.aws/react/build-a-backend/functions/custom-functions for more details.',
                }, e instanceof Error ? e : undefined);
            }
        }
        return new ProvidedAmplifyFunction(scope, `${providedFunction.node.id}-provided`, this.outputStorageStrategy, providedFunction, backendSecretResolver);
    };
}
class ProvidedAmplifyFunction extends AmplifyFunctionBase {
    backendSecretResolver;
    resources;
    cfnFunction;
    envVars = {};
    ssmEnvVars = {};
    ssmPaths = [];
    constructor(scope, id, outputStorageStrategy, providedFunction, backendSecretResolver) {
        super(scope, id, outputStorageStrategy);
        this.backendSecretResolver = backendSecretResolver;
        this.cfnFunction = providedFunction.node.findChild('Resource');
        Tags.of(this.cfnFunction).add(TagName.FRIENDLY_NAME, providedFunction.node.id);
        const currentEnvVars = this.cfnFunction.environment;
        this.cfnFunction.addPropertyOverride('Environment.Variables', Lazy.any({
            produce: () => {
                if (currentEnvVars &&
                    'variables' in currentEnvVars &&
                    isStringRecord(currentEnvVars.variables)) {
                    return {
                        ...currentEnvVars.variables,
                        ...this.envVars,
                        [amplifySsmEnvConfigKey]: JSON.stringify(this.ssmEnvVars),
                    };
                }
                return {
                    ...this.envVars,
                    [amplifySsmEnvConfigKey]: JSON.stringify(this.ssmEnvVars),
                };
            },
        }));
        providedFunction.node.addValidation({
            validate: () => {
                // only add the ssm access policy if there are ssm paths
                if (this.ssmPaths.length > 0) {
                    const ssmAccessPolicy = new PolicyStatement({
                        effect: Effect.ALLOW,
                        actions: ['ssm:GetParameters'],
                        resources: this.ssmPaths
                            .map((path) => (path.startsWith('/') ? path.slice(1) : path)) // the Arn formatter will add a leading slash between the resource and resourceName
                            .map((path) => Arn.format({
                            service: 'ssm',
                            resource: 'parameter',
                            resourceName: path,
                        }, Stack.of(providedFunction))),
                    });
                    providedFunction.grantPrincipal.addToPrincipalPolicy(ssmAccessPolicy);
                }
                return [];
            },
        });
        this.resources = {
            lambda: providedFunction,
            cfnResources: {
                cfnFunction: this.cfnFunction,
            },
        };
        this.storeOutput();
    }
    addEnvironment = (key, value) => {
        if (key === amplifySsmEnvConfigKey) {
            throw new AmplifyUserError('CustomFunctionProviderReservedEnvironmentVariableError', {
                message: `${amplifySsmEnvConfigKey} is a reserved environment variable name`,
                resolution: 'Please use a non-reserved environment variable name.',
            });
        }
        if (typeof value === 'string') {
            this.envVars[key] = value;
        }
        else {
            this.envVars[key] = '<value will be resolved during runtime>';
            const { branchSecretPath, sharedSecretPath } = this.backendSecretResolver.resolvePath(value);
            this.ssmEnvVars[key] = {
                path: branchSecretPath,
                sharedPath: sharedSecretPath,
            };
            this.ssmPaths.push(branchSecretPath, sharedSecretPath);
        }
    };
    getResourceAccessAcceptor = () => new FunctionResourceAccessAcceptor(this);
}
const isStringRecord = (value) => {
    return (typeof value === 'object' &&
        value !== null &&
        Object.keys(value).every((key) => typeof value[key] === 'string'));
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvdmlkZWRfZnVuY3Rpb25fZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9wcm92aWRlZF9mdW5jdGlvbl9mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWdCQSxPQUFPLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxPQUFPLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUN2RSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUNuRSxPQUFPLEVBQUUsOEJBQThCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUUvRSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN4RCxPQUFPLEVBQUUsTUFBTSxFQUFFLGVBQWUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBWTlEOztHQUVHO0FBQ0gsTUFBTSxPQUFPLHVCQUF1QjtJQVNmO0lBQ0E7SUFQWCxTQUFTLENBQW1DO0lBRXBEOztPQUVHO0lBQ0gsWUFDbUIsZ0JBQWlELEVBQ2pELEtBQTZCO1FBRDdCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBaUM7UUFDakQsVUFBSyxHQUFMLEtBQUssQ0FBd0I7SUFDN0MsQ0FBQztJQUVKOztPQUVHO0lBQ0gsV0FBVyxDQUFDLEtBQXVDO1FBQ2pELElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7WUFDcEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLHlCQUF5QixDQUM1QyxJQUFJLENBQUMsZ0JBQWdCLEVBQ3JCLEtBQUssQ0FBQyxxQkFBcUIsRUFDM0IsSUFBSSxDQUFDLEtBQUssQ0FDWCxDQUFDO1FBQ0osQ0FBQztRQUNELE9BQU8sS0FBSyxDQUFDLGtCQUFrQixDQUFDLFlBQVksQ0FDMUMsSUFBSSxDQUFDLFNBQVMsQ0FDSSxDQUFDO0lBQ3ZCLENB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QztJQUNILENBQUMsQ0FBQztJQUVGLHlCQUF5QixHQUFHLEdBQTJCLEVBQUUsQ0FDdkQsSUFBSSw4QkFBOEIsQ0FBQyxJQUFJLENBQUMsQ0FBQztDQUM1QztBQUVELE1BQU0sY0FBYyxHQUFHLENBQUMsS0FBYyxFQUFtQyxFQUFFO0lBQ3pFLE9BQU8sQ0FDTCxPQUFPLEtBQUssS0FBSyxRQUFRO1FBQ3pCLEtBQUssS0FBSyxJQUFJO1FBQ2QsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQ3RCLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxPQUFRLEtBQWlDLENBQUMsR0FBRyxDQUFDLEtBQUssUUFBUSxDQUNyRSxDQUNGLENBQUM7QUFDSixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBbXBsaWZ5RnVuY3Rpb24sXG4gIEFtcGxpZnlSZXNvdXJjZUdyb3VwTmFtZSxcbiAgQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneSxcbiAgQmFja2VuZFNlY3JldCxcbiAgQmFja2VuZFNlY3JldFJlc29sdmVyLFxuICBDb25zdHJ1Y3RDb250YWluZXJFbnRyeUdlbmVyYXRvcixcbiAgQ29uc3RydWN0RmFjdG9yeSxcbiAgQ29uc3RydWN0RmFjdG9yeUdldEluc3RhbmNlUHJvcHMsXG4gIEZ1bmN0aW9uUmVzb3VyY2VzLFxuICBHZW5lcmF0ZUNvbnRhaW5lckVudHJ5UHJvcHMsXG4gIFJlc291cmNlQWNjZXNzQWNjZXB0b3IsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgeyBDZm5GdW5jdGlvbiwgSUZ1bmN0aW9uIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBGdW5jdGlvbk91dHB1dCB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLW91dHB1dC1zY2hlbWFzJztcbmltcG9ydCB7IEFybiwgTGF6eSwgU3RhY2ssIFRhZ3MgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgeyBBbXBsaWZ5VXNlckVycm9yLCBUYWdOYW1lIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsYXRmb3JtLWNvcmUnO1xuaW1wb3J0IHsgQW1wbGlmeUZ1bmN0aW9uQmFzZSB9IGZyb20gJy4vZnVuY3Rpb25fY29uc3RydWN0X2Jhc2UuanMnO1xuaW1wb3J0IHsgRnVuY3Rpb25SZXNvdXJjZUFjY2Vzc0FjY2VwdG9yIH0gZnJvbSAnLi9yZXNvdXJjZV9hY2Nlc3NfYWNjZXB0b3IuanMnO1xuaW1wb3J0IHsgU3NtRW52VmFycyB9IGZyb20gJy4vZnVuY3Rpb25fZW52X3RyYW5zbGF0b3IuanMnO1xuaW1wb3J0IHsgYW1wbGlmeVNzbUVudkNvbmZpZ0tleSB9IGZyb20gJy4vY29uc3RhbnRzLmpzJztcbmltcG9ydCB7IEVmZmVjdCwgUG9saWN5U3RhdGVtZW50IH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWlhbSc7XG5cbmV4cG9ydCB0eXBlIFByb3ZpZGVkRnVuY3Rpb25Qcm9wcyA9IHtcbiAgLyoqXG4gICAqIEdyb3VwIHRoZSBmdW5jdGlvbiB3aXRoIGV4aXN0aW5nIEFtcGxpZnkgcmVzb3VyY2VzIG9yIHNlcGFyYXRlIHRoZSBmdW5jdGlvbiBpbnRvIGl0cyBvd24gZ3JvdXAuXG4gICAqIEBkZWZhdWx0ICdmdW5jdGlvbicgLy8gZ3JvdXBpbmcgd2l0aCBvdGhlciBBbXBsaWZ5IGZ1bmN0aW9uc1xuICAgKiBAZXhhbXBsZVxuICAgKiByZXNvdXJjZUdyb3VwTmFtZTogJ2F1dGgnIC8vIHRvIGdyb3VwIGFuIGF1dGggdHJpZ2dlciB3aXRoIGFuIGF1dGggcmVzb3VyY2VcbiAgICovXG4gIHJlc291cmNlR3JvdXBOYW1lPzogQW1wbGlmeVJlc291cmNlR3JvdXBOYW1lO1xufTtcblxuLyoqXG4gKiBBZGFwdHMgcHJvdmlkZWQgQ0RLIGZ1bmN0aW9uIGFzIEFtcGxpZnkgZnVuY3Rpb24uXG4gKi9cbmV4cG9ydCBjbGFzcyBQcm92aWRlZEZ1bmN0aW9uRmFjdG9yeVxuICBpbXBsZW1lbnRzIENvbnN0cnVjdEZhY3Rvcnk8QW1wbGlmeUZ1bmN0aW9uPlxue1xuICBwcml2YXRlIGdlbmVyYXRvcjogQ29uc3RydWN0Q29udGFpbmVyRW50cnlHZW5lcmF0b3I7XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgcHJvdmlkZWQgZnVuY3Rpb24gZmFjdG9yeS5cbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZnVuY3Rpb25Qcm92aWRlcjogKHNjb3BlOiBDb25zdHJ1Y3QpID0+IElGdW5jdGlvbixcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByb3BzPzogUHJvdmlkZWRGdW5jdGlvblByb3BzLFxuICApIHt9XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgYSBmdW5jdGlvbiBpbnN0YW5jZS5cbiAgICovXG4gIGdldEluc3RhbmNlKHByb3BzOiBDb25zdHJ1Y3RGYWN0b3J5R2V0SW5zdGFuY2VQcm9wcyk6IEFtcGxpZnlGdW5jdGlvbiB7XG4gICAgaWYgKCF0aGlzLmdlbmVyYXRvcikge1xuICAgICAgdGhpcy5nZW5lcmF0b3IgPSBuZXcgUHJvdmlkZWRGdW5jdGlvbkdlbmVyYXRvcihcbiAgICAgICAgdGhpcy5mdW5jdGlvblByb3ZpZGVyLFxuICAgICAgICBwcm9wcy5vdXRwdXRTdG9yYWdlU3RyYXRlZ3ksXG4gICAgICAgIHRoaXMucHJvcHMsXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gcHJvcHMuY29uc3RydWN0Q29udGFpbmVyLmdldE9yQ29tcHV0ZShcbiAgICAgIHRoaXMuZ2VuZXJhdG9yLFxuICAgICkgYXMgQW1wbGlmeUZ1bmN0aW9uO1xuICB9XG59XG5cbmNsYXNzIFByb3ZpZGVkRnVuY3Rpb25HZW5lcmF0b3IgaW1wbGVtZW50cyBDb25zdHJ1Y3RDb250YWluZXJFbnRyeUdlbmVyYXRvciB7XG4gIHJlYWRvbmx5IHJlc291cmNlR3JvdXBOYW1lOiBBbXBsaWZ5UmVzb3VyY2VHcm91cE5hbWU7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBmdW5jdGlvblByb3ZpZGVyOiAoc2NvcGU6IENvbnN0cnVjdCkgPT4gSUZ1bmN0aW9uLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5OiBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5PEZ1bmN0aW9uT3V0cHV0PixcbiAgICBwcm9wcz86IFByb3ZpZGVkRnVuY3Rpb25Qcm9wcyxcbiAgKSB7XG4gICAgdGhpcy5yZXNvdXJjZUdyb3VwTmFtZSA9IHByb3BzPy5yZXNvdXJjZUdyb3VwTmFtZSA/PyAnZnVuY3Rpb24nO1xuICB9XG5cbiAgZ2VuZXJhdGVDb250YWluZXJFbnRyeSA9ICh7XG4gICAgc2NvcGUsXG4gICAgYmFja2VuZFNlY3JldFJlc29sdmVyLFxuICB9OiBHZW5lcmF0ZUNvbnRhaW5lckVudHJ5UHJvcHMpID0+IHtcbiAgICBsZXQgcHJvdmlkZWRGdW5jdGlvbjogSUZ1bmN0aW9uO1xuICAgIHRyeSB7XG4gICAgICBwcm92aWRlZEZ1bmN0aW9uID0gdGhpcy5mdW5jdGlvblByb3ZpZGVyKHNjb3BlKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBpZiAoXG4gICAgICAgIGUgaW5zdGFuY2VvZiBFcnJvciAmJlxuICAgICAgICAoZS5tZXNzYWdlLmluY2x1ZGVzKCdkb2NrZXIgZXhpdGVkIHdpdGggc3RhdHVzIDEnKSB8fFxuICAgICAgICAgIGUubWVzc2FnZS5pbmNsdWRlcygnZG9ja2VyIEVOT0VOVCcpKVxuICAgICAgKSB7XG4gICAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAgICdDdXN0b21GdW5jdGlvblByb3ZpZGVyRG9ja2VyRXJyb3InLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gaW5zdGFudGlhdGUgY3VzdG9tIGZ1bmN0aW9uIHByb3ZpZGVyJyxcbiAgICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAgICdTZWUgaHR0cHM6Ly9kb2NzLmFtcGxpZnkuYXdzL3JlYWN0L2J1aWxkLWEtYmFja2VuZC9mdW5jdGlvbnMvY3VzdG9tLWZ1bmN0aW9ucyBmb3IgbW9yZSBkZXRhaWxzIGFib3V0IGN1cnJlbnQgbGltaXRhdGlvbnMgYW5kIHRyb3VibGVzaG9vdGluZyBzdGVwcy4nLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgZSxcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAgICdDdXN0b21GdW5jdGlvblByb3ZpZGVyRXJyb3InLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gaW5zdGFudGlhdGUgY3VzdG9tIGZ1bmN0aW9uIHByb3ZpZGVyJyxcbiAgICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAgICdDaGVjayB0aGUgZGVmaW5pdGlvbiBvZiB5b3VyIGN1c3RvbSBmdW5jdGlvbiBwcm92aWRlZCBpbiBgZGVmaW5lRnVuY3Rpb25gIGFuZCByZWZlciB0byB0aGUgbG9ncyBmb3IgbW9yZSBpbmZvcm1hdGlvbi4gU2VlIGh0dHBzOi8vZG9jcy5hbXBsaWZ5LmF3cy9yZWFjdC9idWlsZC1hLWJhY2tlbmQvZnVuY3Rpb25zL2N1c3RvbS1mdW5jdGlvbnMgZm9yIG1vcmUgZGV0YWlscy4nLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgZSBpbnN0YW5jZW9mIEVycm9yID8gZSA6IHVuZGVmaW5lZCxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG5ldyBQcm92aWRlZEFtcGxpZnlGdW5jdGlvbihcbiAgICAgIHNjb3BlLFxuICAgICAgYCR7cHJvdmlkZWRGdW5jdGlvbi5ub2RlLmlkfS1wcm92aWRlZGAsXG4gICAgICB0aGlzLm91dHB1dFN0b3JhZ2VTdHJhdGVneSxcbiAgICAgIHByb3ZpZGVkRnVuY3Rpb24sXG4gICAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gICAgKTtcbiAgfTtcbn1cblxuY2xhc3MgUHJvdmlkZWRBbXBsaWZ5RnVuY3Rpb24gZXh0ZW5kcyBBbXBsaWZ5RnVuY3Rpb25CYXNlIHtcbiAgcmVhZG9ubHkgcmVzb3VyY2VzOiBGdW5jdGlvblJlc291cmNlcztcbiAgcHJpdmF0ZSByZWFkb25seSBjZm5GdW5jdGlvbjogQ2ZuRnVuY3Rpb247XG4gIHByaXZhdGUgcmVhZG9ubHkgZW52VmFyczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9O1xuICBwcml2YXRlIHJlYWRvbmx5IHNzbUVudlZhcnM6IFNzbUVudlZhcnMgPSB7fTtcbiAgcHJpdmF0ZSByZWFkb25seSBzc21QYXRoczogc3RyaW5nW10gPSBbXTtcbiAgY29uc3RydWN0b3IoXG4gICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICBpZDogc3RyaW5nLFxuICAgIG91dHB1dFN0b3JhZ2VTdHJhdGVneTogQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneTxGdW5jdGlvbk91dHB1dD4sXG4gICAgcHJvdmlkZWRGdW5jdGlvbjogSUZ1bmN0aW9uLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYmFja2VuZFNlY3JldFJlc29sdmVyOiBCYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gICkge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5KTtcblxuICAgIHRoaXMuY2ZuRnVuY3Rpb24gPSBwcm92aWRlZEZ1bmN0aW9uLm5vZGUuZmluZENoaWxkKFxuICAgICAgJ1Jlc291cmNlJyxcbiAgICApIGFzIENmbkZ1bmN0aW9uO1xuXG4gICAgVGFncy5vZih0aGlzLmNmbkZ1bmN0aW9uKS5hZGQoXG4gICAgICBUYWdOYW1lLkZSSUVORExZX05BTUUsXG4gICAgICBwcm92aWRlZEZ1bmN0aW9uLm5vZGUuaWQsXG4gICAgKTtcblxuICAgIGNvbnN0IGN1cnJlbnRFbnZWYXJzID0gdGhpcy5jZm5GdW5jdGlvbi5lbnZpcm9ubWVudDtcblxuICAgIHRoaXMuY2ZuRnVuY3Rpb24uYWRkUHJvcGVydHlPdmVycmlkZShcbiAgICAgICdFbnZpcm9ubWVudC5WYXJpYWJsZXMnLFxuICAgICAgTGF6eS5hbnkoe1xuICAgICAgICBwcm9kdWNlOiAoKSA9PiB7XG4gICAgICAgICAgaWYgKFxuICAgICAgICAgICAgY3VycmVudEVudlZhcnMgJiZcbiAgICAgICAgICAgICd2YXJpYWJsZXMnIGluIGN1cnJlbnRFbnZWYXJzICYmXG4gICAgICAgICAgICBpc1N0cmluZ1JlY29yZChjdXJyZW50RW52VmFycy52YXJpYWJsZXMpXG4gICAgICAgICAgKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAuLi5jdXJyZW50RW52VmFycy52YXJpYWJsZXMsXG4gICAgICAgICAgICAgIC4uLnRoaXMuZW52VmFycyxcbiAgICAgICAgICAgICAgW2FtcGxpZnlTc21FbnZDb25maWdLZXldOiBKU09OLnN0cmluZ2lmeSh0aGlzLnNzbUVudlZhcnMpLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIC4uLnRoaXMuZW52VmFycyxcbiAgICAgICAgICAgIFthbXBsaWZ5U3NtRW52Q29uZmlnS2V5XTogSlNPTi5zdHJpbmdpZnkodGhpcy5zc21FbnZWYXJzKSxcbiAgICAgICAgICB9O1xuICAgICAgICB9LFxuICAgICAgfSksXG4gICAgKTtcblxuICAgIHByb3ZpZGVkRnVuY3Rpb24ubm9kZS5hZGRWYWxpZGF0aW9uKHtcbiAgICAgIHZhbGlkYXRlOiAoKSA9PiB7XG4gICAgICAgIC8vIG9ubHkgYWRkIHRoZSBzc20gYWNjZXNzIHBvbGljeSBpZiB0aGVyZSBhcmUgc3NtIHBhdGhzXG4gICAgICAgIGlmICh0aGlzLnNzbVBhdGhzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBjb25zdCBzc21BY2Nlc3NQb2xpY3kgPSBuZXcgUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgIGVmZmVjdDogRWZmZWN0LkFMTE9XLFxuICAgICAgICAgICAgYWN0aW9uczogWydzc206R2V0UGFyYW1ldGVycyddLFxuICAgICAgICAgICAgcmVzb3VyY2VzOiB0aGlzLnNzbVBhdGhzXG4gICAgICAgICAgICAgIC5tYXAoKHBhdGgpID0+IChwYXRoLnN0YXJ0c1dpdGgoJy8nKSA/IHBhdGguc2xpY2UoMSkgOiBwYXRoKSkgLy8gdGhlIEFybiBmb3JtYXR0ZXIgd2lsbCBhZGQgYSBsZWFkaW5nIHNsYXNoIGJldHdlZW4gdGhlIHJlc291cmNlIGFuZCByZXNvdXJjZU5hbWVcbiAgICAgICAgICAgICAgLm1hcCgocGF0aCkgPT5cbiAgICAgICAgICAgICAgICBBcm4uZm9ybWF0KFxuICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBzZXJ2aWNlOiAnc3NtJyxcbiAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2U6ICdwYXJhbWV0ZXInLFxuICAgICAgICAgICAgICAgICAgICByZXNvdXJjZU5hbWU6IHBhdGgsXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgU3RhY2sub2YocHJvdmlkZWRGdW5jdGlvbiksXG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgKSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBwcm92aWRlZEZ1bmN0aW9uLmdyYW50UHJpbmNpcGFsLmFkZFRvUHJpbmNpcGFsUG9saWN5KHNzbUFjY2Vzc1BvbGljeSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHRoaXMucmVzb3VyY2VzID0ge1xuICAgICAgbGFtYmRhOiBwcm92aWRlZEZ1bmN0aW9uLFxuICAgICAgY2ZuUmVzb3VyY2VzOiB7XG4gICAgICAgIGNmbkZ1bmN0aW9uOiB0aGlzLmNmbkZ1bmN0aW9uLFxuICAgICAgfSxcbiAgICB9O1xuXG4gICAgdGhpcy5zdG9yZU91dHB1dCgpO1xuICB9XG5cbiAgYWRkRW52aXJvbm1lbnQgPSAoa2V5OiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcgfCBCYWNrZW5kU2VjcmV0KSA9PiB7XG4gICAgaWYgKGtleSA9PT0gYW1wbGlmeVNzbUVudkNvbmZpZ0tleSkge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICdDdXN0b21GdW5jdGlvblByb3ZpZGVyUmVzZXJ2ZWRFbnZpcm9ubWVudFZhcmlhYmxlRXJyb3InLFxuICAgICAgICB7XG4gICAgICAgICAgbWVzc2FnZTogYCR7YW1wbGlmeVNzbUVudkNvbmZpZ0tleX0gaXMgYSByZXNlcnZlZCBlbnZpcm9ubWVudCB2YXJpYWJsZSBuYW1lYCxcbiAgICAgICAgICByZXNvbHV0aW9uOiAnUGxlYXNlIHVzZSBhIG5vbi1yZXNlcnZlZCBlbnZpcm9ubWVudCB2YXJpYWJsZSBuYW1lLicsXG4gICAgICAgIH0sXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykge1xuICAgICAgdGhpcy5lbnZWYXJzW2tleV0gPSB2YWx1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5lbnZWYXJzW2tleV0gPSAnPHZhbHVlIHdpbGwgYmUgcmVzb2x2ZWQgZHVyaW5nIHJ1bnRpbWU+JztcbiAgICAgIGNvbnN0IHsgYnJhbmNoU2VjcmV0UGF0aCwgc2hhcmVkU2VjcmV0UGF0aCB9ID1cbiAgICAgICAgdGhpcy5iYWNrZW5kU2VjcmV0UmVzb2x2ZXIucmVzb2x2ZVBhdGgodmFsdWUpO1xuICAgICAgdGhpcy5zc21FbnZWYXJzW2tleV0gPSB7XG4gICAgICAgIHBhdGg6IGJyYW5jaFNlY3JldFBhdGgsXG4gICAgICAgIHNoYXJlZFBhdGg6IHNoYXJlZFNlY3JldFBhdGgsXG4gICAgICB9O1xuICAgICAgdGhpcy5zc21QYXRocy5wdXNoKGJyYW5jaFNlY3JldFBhdGgsIHNoYXJlZFNlY3JldFBhdGgpO1xuICAgIH1cbiAgfTtcblxuICBnZXRSZXNvdXJjZUFjY2Vzc0FjY2VwdG9yID0gKCk6IFJlc291cmNlQWNjZXNzQWNjZXB0b3IgPT5cbiAgICBuZXcgRnVuY3Rpb25SZXNvdXJjZUFjY2Vzc0FjY2VwdG9yKHRoaXMpO1xufVxuXG5jb25zdCBpc1N0cmluZ1JlY29yZCA9ICh2YWx1ZTogdW5rbm93bik6IHZhbHVlIGlzIFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPT4ge1xuICByZXR1cm4gKFxuICAgIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiZcbiAgICB2YWx1ZSAhPT0gbnVsbCAmJlxuICAgIE9iamVjdC5rZXlzKHZhbHVlKS5ldmVyeShcbiAgICAgIChrZXkpID0+IHR5cGVvZiAodmFsdWUgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4pW2tleV0gPT09ICdzdHJpbmcnLFxuICAgIClcbiAgKTtcbn07XG4iXX0=