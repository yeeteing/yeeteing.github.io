"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ReadableCloudAssembly = void 0;
const node_fs_1 = require("node:fs");
/**
 * The canonical implementation of `IReadableCloudAssembly`
 *
 * Holds a read lock that is unlocked on disposal, as well as optionally deletes the
 * cloud assembly directory.
 */
class ReadableCloudAssembly {
    cloudAssembly;
    lock;
    options;
    constructor(cloudAssembly, lock, options) {
        this.cloudAssembly = cloudAssembly;
        this.lock = lock;
        this.options = options;
    }
    async _unlock() {
        return this.lock.release();
    }
    async dispose() {
        await this.lock.release();
        if (this.options?.deleteOnDispose) {
            await node_fs_1.promises.rm(this.cloudAssembly.directory, { recursive: true, force: true });
        }
    }
    [Symbol.asyncDispose]() {
        return this.dispose();
    }
}
exports.ReadableCloudAssembly = ReadableCloudAssembly;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVhZGFibGUtYXNzZW1ibHkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJyZWFkYWJsZS1hc3NlbWJseS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxxQ0FBeUM7QUFjekM7Ozs7O0dBS0c7QUFDSCxNQUFhLHFCQUFxQjtJQUVkO0lBQ0M7SUFDQTtJQUhuQixZQUNrQixhQUFrQyxFQUNqQyxJQUFlLEVBQ2YsT0FBc0M7UUFGdkMsa0JBQWEsR0FBYixhQUFhLENBQXFCO1FBQ2pDLFNBQUksR0FBSixJQUFJLENBQVc7UUFDZixZQUFPLEdBQVAsT0FBTyxDQUErQjtJQUV6RCxDQUFDO0lBRU0sS0FBSyxDQUFDLE9BQU87UUFDbEIsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQzdCLENBQUM7SUFFTSxLQUFLLENBQUMsT0FBTztRQUNsQixNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDMUIsSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFFLGVBQWUsRUFBRSxDQUFDO1lBQ2xDLE1BQU0sa0JBQUUsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQzlFLENBQUM7SUFDSCxDQUFDO0lBRU0sQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDO1FBQzFCLE9BQU8sSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ3hCLENBQUM7Q0FDRjtBQXRCRCxzREFzQkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBwcm9taXNlcyBhcyBmcyB9IGZyb20gJ25vZGU6ZnMnO1xuaW1wb3J0IHR5cGUgKiBhcyBjeGFwaSBmcm9tICdAYXdzLWNkay9jeC1hcGknO1xuaW1wb3J0IHR5cGUgeyBJUmVhZExvY2sgfSBmcm9tICcuLi8uLi9yd2xvY2snO1xuaW1wb3J0IHR5cGUgeyBJUmVhZGFibGVDbG91ZEFzc2VtYmx5IH0gZnJvbSAnLi4vdHlwZXMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIFJlYWRhYmxlQ2xvdWRBc3NlbWJseU9wdGlvbnMge1xuICAvKipcbiAgICogRGVsZXRlIHRoZSBDbG91ZCBBc3NlbWJseSBkaXJlY3Rvcnkgd2hlbiB0aGUgb2JqZWN0IGlzIGRpc3Bvc2VkXG4gICAqXG4gICAqIEBkZWZhdWx0IGZhbHNlXG4gICAqL1xuICByZWFkb25seSBkZWxldGVPbkRpc3Bvc2U/OiBib29sZWFuO1xufVxuXG4vKipcbiAqIFRoZSBjYW5vbmljYWwgaW1wbGVtZW50YXRpb24gb2YgYElSZWFkYWJsZUNsb3VkQXNzZW1ibHlgXG4gKlxuICogSG9sZHMgYSByZWFkIGxvY2sgdGhhdCBpcyB1bmxvY2tlZCBvbiBkaXNwb3NhbCwgYXMgd2VsbCBhcyBvcHRpb25hbGx5IGRlbGV0ZXMgdGhlXG4gKiBjbG91ZCBhc3NlbWJseSBkaXJlY3RvcnkuXG4gKi9cbmV4cG9ydCBjbGFzcyBSZWFkYWJsZUNsb3VkQXNzZW1ibHkgaW1wbGVtZW50cyBJUmVhZGFibGVDbG91ZEFzc2VtYmx5IHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIHJlYWRvbmx5IGNsb3VkQXNzZW1ibHk6IGN4YXBpLkNsb3VkQXNzZW1ibHksXG4gICAgcHJpdmF0ZSByZWFkb25seSBsb2NrOiBJUmVhZExvY2ssXG4gICAgcHJpdmF0ZSByZWFkb25seSBvcHRpb25zPzogUmVhZGFibGVDbG91ZEFzc2VtYmx5T3B0aW9ucyxcbiAgKSB7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgX3VubG9jaygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gdGhpcy5sb2NrLnJlbGVhc2UoKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBkaXNwb3NlKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGF3YWl0IHRoaXMubG9jay5yZWxlYXNlKCk7XG4gICAgaWYgKHRoaXMub3B0aW9ucz8uZGVsZXRlT25EaXNwb3NlKSB7XG4gICAgICBhd2FpdCBmcy5ybSh0aGlzLmNsb3VkQXNzZW1ibHkuZGlyZWN0b3J5LCB7IHJlY3Vyc2l2ZTogdHJ1ZSwgZm9yY2U6IHRydWUgfSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIFtTeW1ib2wuYXN5bmNEaXNwb3NlXSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gdGhpcy5kaXNwb3NlKCk7XG4gIH1cbn1cbiJdfQ==