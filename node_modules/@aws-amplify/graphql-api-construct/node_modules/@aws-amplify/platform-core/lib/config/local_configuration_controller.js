"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.LocalConfigurationController = void 0;
const os_1 = __importDefault(require("os"));
const path_1 = __importDefault(require("path"));
const promises_1 = __importDefault(require("fs/promises"));
/**
 * Used to interact with config file based on OS.
 */
class LocalConfigurationController {
    projectName;
    configFileName;
    dirPath;
    configFilePath;
    _store;
    /**
     * Initializes paths to project config dir & config file.
     */
    constructor(projectName = 'amplify', configFileName = 'config.json') {
        this.projectName = projectName;
        this.configFileName = configFileName;
        this.dirPath = this.getConfigDirPath(this.projectName);
        this.configFilePath = path_1.default.join(this.dirPath, this.configFileName);
    }
    /**
     * Gets values from cached config by path.
     */
    async get(path) {
        return path.split('.').reduce((acc, current) => {
            return acc?.[current];
        }, await this.store());
    }
    /**
     * Set value by path & update config file to disk.
     */
    async set(path, value) {
        let current = await this.store();
        path.split('.').forEach((key, index, keys) => {
            if (index === keys.length - 1) {
                current[key] = value;
            }
            else {
                if (current[key] == null) {
                    current[key] = {};
                }
                current = current[key];
            }
        });
        await this.write();
    }
    /**
     * Writes config file to disk if found.
     */
    async write() {
        // creates project directory if it doesn't exist.
        await this.mkConfigDir();
        const output = JSON.stringify(this._store ? this._store : {});
        await promises_1.default.writeFile(this.configFilePath, output, 'utf8');
    }
    /**
     * Reset cached config and delete the config file.
     */
    async clear() {
        this._store = {};
        await promises_1.default.rm(this.configFilePath);
    }
    /**
     * Getter for cached config, retrieves config from disk if not cached already.
     * If the store is not cached & config file does not exist, it will create a blank one.
     */
    async store() {
        if (this._store) {
            return this._store;
        }
        // check if file exists & readable.
        let fd;
        try {
            fd = await promises_1.default.open(this.configFilePath, promises_1.default.constants.F_OK, promises_1.default.constants.O_RDWR);
            const fileContent = await promises_1.default.readFile(fd, 'utf-8');
            this._store = JSON.parse(fileContent);
        }
        catch {
            this._store = {};
            await this.write();
        }
        finally {
            await fd?.close();
        }
        return this._store;
    }
    /**
     * Creates project directory to store config if it doesn't exist yet.
     */
    mkConfigDir() {
        return promises_1.default.mkdir(this.dirPath, { recursive: true });
    }
    /**
     * Returns the path to config directory depending on OS
     */
    getConfigDirPath(name) {
        const homedir = os_1.default.homedir();
        const macos = () => path_1.default.join(homedir, 'Library', 'Preferences', name);
        const windows = () => {
            return path_1.default.join(process.env.APPDATA || path_1.default.join(homedir, 'AppData', 'Roaming'), name, 'Config');
        };
        const linux = () => {
            return path_1.default.join(process.env.XDG_STATE_HOME || path_1.default.join(homedir, '.local', 'state'), name);
        };
        switch (process.platform) {
            case 'darwin':
                return macos();
            case 'win32':
                return windows();
            default:
                return linux();
        }
    }
}
exports.LocalConfigurationController = LocalConfigurationController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9jYWxfY29uZmlndXJhdGlvbl9jb250cm9sbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NvbmZpZy9sb2NhbF9jb25maWd1cmF0aW9uX2NvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsNENBQW9CO0FBQ3BCLGdEQUF3QjtBQUN4QiwyREFBNkI7QUFHN0I7O0dBRUc7QUFDSCxNQUFhLDRCQUE0QjtJQVNwQjtJQUNBO0lBVG5CLE9BQU8sQ0FBUztJQUNoQixjQUFjLENBQVM7SUFDdkIsTUFBTSxDQUEwQjtJQUVoQzs7T0FFRztJQUNILFlBQ21CLGNBQWMsU0FBUyxFQUN2QixpQkFBaUIsYUFBYTtRQUQ5QixnQkFBVyxHQUFYLFdBQVcsQ0FBWTtRQUN2QixtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFFL0MsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3ZELElBQUksQ0FBQyxjQUFjLEdBQUcsY0FBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUNyRSxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsR0FBRyxDQUFJLElBQVk7UUFDdkIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FDM0IsQ0FBQyxHQUE0QixFQUFFLE9BQWUsRUFBRSxFQUFFO1lBQ2hELE9BQU8sR0FBRyxFQUFFLENBQUMsT0FBTyxDQUE0QixDQUFDO1FBQ25ELENBQUMsRUFDRCxNQUFNLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FDZCxDQUFDO0lBQ1QsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFZLEVBQUUsS0FBZ0M7UUFDdEQsSUFBSSxPQUFPLEdBQTRCLE1BQU0sSUFBSSxDQUFDLEtBQUss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T0FBTyxJQUFJLGNBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxTQUFTLENBQUMsRUFDL0QsSUFBSSxFQUNKLFFBQVEsQ0FDVCxDQUFDO1FBQ0osQ0FBQyxDQUFDO1FBQ0YsTUFBTSxLQUFLLEdBQUcsR0FBRyxFQUFFO1lBQ2pCLE9BQU8sY0FBSSxDQUFDLElBQUksQ0FDZCxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsSUFBSSxjQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxRQUFRLEVBQUUsT0FBTyxDQUFDLEVBQ25FLElBQUksQ0FDTCxDQUFDO1FBQ0osQ0FBQyxDQUFDO1FBRUYsUUFBUSxPQUFPLENBQUMsUUFBUSxFQUFFO1lBQ3hCLEtBQUssUUFBUTtnQkFDWCxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2pCLEtBQUssT0FBTztnQkFDVixPQUFPLE9BQU8sRUFBRSxDQUFDO1lBQ25CO2dCQUNFLE9BQU8sS0FBSyxFQUFFLENBQUM7U0FDbEI7SUFDSCxDQUFDO0NBQ0Y7QUFwSUQsb0VBb0lDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IG9zIGZyb20gJ29zJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzL3Byb21pc2VzJztcbmltcG9ydCB7IENvbmZpZ3VyYXRpb25Db250cm9sbGVyIH0gZnJvbSAnLi9sb2NhbF9jb25maWd1cmF0aW9uX2NvbnRyb2xsZXJfZmFjdG9yeSc7XG5cbi8qKlxuICogVXNlZCB0byBpbnRlcmFjdCB3aXRoIGNvbmZpZyBmaWxlIGJhc2VkIG9uIE9TLlxuICovXG5leHBvcnQgY2xhc3MgTG9jYWxDb25maWd1cmF0aW9uQ29udHJvbGxlciBpbXBsZW1lbnRzIENvbmZpZ3VyYXRpb25Db250cm9sbGVyIHtcbiAgZGlyUGF0aDogc3RyaW5nO1xuICBjb25maWdGaWxlUGF0aDogc3RyaW5nO1xuICBfc3RvcmU6IFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuXG4gIC8qKlxuICAgKiBJbml0aWFsaXplcyBwYXRocyB0byBwcm9qZWN0IGNvbmZpZyBkaXIgJiBjb25maWcgZmlsZS5cbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJvamVjdE5hbWUgPSAnYW1wbGlmeScsXG4gICAgcHJpdmF0ZSByZWFkb25seSBjb25maWdGaWxlTmFtZSA9ICdjb25maWcuanNvbicsXG4gICkge1xuICAgIHRoaXMuZGlyUGF0aCA9IHRoaXMuZ2V0Q29uZmlnRGlyUGF0aCh0aGlzLnByb2plY3ROYW1lKTtcbiAgICB0aGlzLmNvbmZpZ0ZpbGVQYXRoID0gcGF0aC5qb2luKHRoaXMuZGlyUGF0aCwgdGhpcy5jb25maWdGaWxlTmFtZSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0cyB2YWx1ZXMgZnJvbSBjYWNoZWQgY29uZmlnIGJ5IHBhdGguXG4gICAqL1xuICBhc3luYyBnZXQ8VD4ocGF0aDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHBhdGguc3BsaXQoJy4nKS5yZWR1Y2UoXG4gICAgICAoYWNjOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiwgY3VycmVudDogc3RyaW5nKSA9PiB7XG4gICAgICAgIHJldHVybiBhY2M/LltjdXJyZW50XSBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjtcbiAgICAgIH0sXG4gICAgICBhd2FpdCB0aGlzLnN0b3JlKCksXG4gICAgKSBhcyBUO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCB2YWx1ZSBieSBwYXRoICYgdXBkYXRlIGNvbmZpZyBmaWxlIHRvIGRpc2suXG4gICAqL1xuICBhc3luYyBzZXQocGF0aDogc3RyaW5nLCB2YWx1ZTogc3RyaW5nIHwgYm9vbGVhbiB8IG51bWJlcikge1xuICAgIGxldCBjdXJyZW50OiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiA9IGF3YWl0IHRoaXMuc3RvcmUoKTtcblxuICAgIHBhdGguc3BsaXQoJy4nKS5mb3JFYWNoKChrZXksIGluZGV4LCBrZXlzKSA9PiB7XG4gICAgICBpZiAoaW5kZXggPT09IGtleXMubGVuZ3RoIC0gMSkge1xuICAgICAgICBjdXJyZW50W2tleV0gPSB2YWx1ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChjdXJyZW50W2tleV0gPT0gbnVsbCkge1xuICAgICAgICAgIGN1cnJlbnRba2V5XSA9IHt9O1xuICAgICAgICB9XG4gICAgICAgIGN1cnJlbnQgPSBjdXJyZW50W2tleV0gYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj47XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBhd2FpdCB0aGlzLndyaXRlKCk7XG4gIH1cblxuICAvKipcbiAgICogV3JpdGVzIGNvbmZpZyBmaWxlIHRvIGRpc2sgaWYgZm91bmQuXG4gICAqL1xuICBhc3luYyB3cml0ZSgpIHtcbiAgICAvLyBjcmVhdGVzIHByb2plY3QgZGlyZWN0b3J5IGlmIGl0IGRvZXNuJ3QgZXhpc3QuXG4gICAgYXdhaXQgdGhpcy5ta0NvbmZpZ0RpcigpO1xuXG4gICAgY29uc3Qgb3V0cHV0ID0gSlNPTi5zdHJpbmdpZnkodGhpcy5fc3RvcmUgPyB0aGlzLl9zdG9yZSA6IHt9KTtcbiAgICBhd2FpdCBmcy53cml0ZUZpbGUodGhpcy5jb25maWdGaWxlUGF0aCwgb3V0cHV0LCAndXRmOCcpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlc2V0IGNhY2hlZCBjb25maWcgYW5kIGRlbGV0ZSB0aGUgY29uZmlnIGZpbGUuXG4gICAqL1xuICBhc3luYyBjbGVhcigpIHtcbiAgICB0aGlzLl9zdG9yZSA9IHt9O1xuICAgIGF3YWl0IGZzLnJtKHRoaXMuY29uZmlnRmlsZVBhdGgpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHRlciBmb3IgY2FjaGVkIGNvbmZpZywgcmV0cmlldmVzIGNvbmZpZyBmcm9tIGRpc2sgaWYgbm90IGNhY2hlZCBhbHJlYWR5LlxuICAgKiBJZiB0aGUgc3RvcmUgaXMgbm90IGNhY2hlZCAmIGNvbmZpZyBmaWxlIGRvZXMgbm90IGV4aXN0LCBpdCB3aWxsIGNyZWF0ZSBhIGJsYW5rIG9uZS5cbiAgICovXG4gIHByaXZhdGUgYXN5bmMgc3RvcmUoKTogUHJvbWlzZTxSZWNvcmQ8c3RyaW5nLCB1bmtub3duPj4ge1xuICAgIGlmICh0aGlzLl9zdG9yZSkge1xuICAgICAgcmV0dXJuIHRoaXMuX3N0b3JlO1xuICAgIH1cbiAgICAvLyBjaGVjayBpZiBmaWxlIGV4aXN0cyAmIHJlYWRhYmxlLlxuICAgIGxldCBmZDtcblxuICAgIHRyeSB7XG4gICAgICBmZCA9IGF3YWl0IGZzLm9wZW4oXG4gICAgICAgIHRoaXMuY29uZmlnRmlsZVBhdGgsXG4gICAgICAgIGZzLmNvbnN0YW50cy5GX09LLFxuICAgICAgICBmcy5jb25zdGFudHMuT19SRFdSLFxuICAgICAgKTtcbiAgICAgIGNvbnN0IGZpbGVDb250ZW50ID0gYXdhaXQgZnMucmVhZEZpbGUoZmQsICd1dGYtOCcpO1xuICAgICAgdGhpcy5fc3RvcmUgPSBKU09OLnBhcnNlKGZpbGVDb250ZW50KTtcbiAgICB9IGNhdGNoIHtcbiAgICAgIHRoaXMuX3N0b3JlID0ge307XG4gICAgICBhd2FpdCB0aGlzLndyaXRlKCk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGF3YWl0IGZkPy5jbG9zZSgpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fc3RvcmU7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlcyBwcm9qZWN0IGRpcmVjdG9yeSB0byBzdG9yZSBjb25maWcgaWYgaXQgZG9lc24ndCBleGlzdCB5ZXQuXG4gICAqL1xuICBwcml2YXRlIG1rQ29uZmlnRGlyKCkge1xuICAgIHJldHVybiBmcy5ta2Rpcih0aGlzLmRpclBhdGgsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIHBhdGggdG8gY29uZmlnIGRpcmVjdG9yeSBkZXBlbmRpbmcgb24gT1NcbiAgICovXG4gIHByaXZhdGUgZ2V0Q29uZmlnRGlyUGF0aChuYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGNvbnN0IGhvbWVkaXIgPSBvcy5ob21lZGlyKCk7XG5cbiAgICBjb25zdCBtYWNvcyA9ICgpID0+IHBhdGguam9pbihob21lZGlyLCAnTGlicmFyeScsICdQcmVmZXJlbmNlcycsIG5hbWUpO1xuICAgIGNvbnN0IHdpbmRvd3MgPSAoKSA9PiB7XG4gICAgICByZXR1cm4gcGF0aC5qb2luKFxuICAgICAgICBwcm9jZXNzLmVudi5BUFBEQVRBIHx8IHBhdGguam9pbihob21lZGlyLCAnQXBwRGF0YScsICdSb2FtaW5nJyksXG4gICAgICAgIG5hbWUsXG4gICAgICAgICdDb25maWcnLFxuICAgICAgKTtcbiAgICB9O1xuICAgIGNvbnN0IGxpbnV4ID0gKCkgPT4ge1xuICAgICAgcmV0dXJuIHBhdGguam9pbihcbiAgICAgICAgcHJvY2Vzcy5lbnYuWERHX1NUQVRFX0hPTUUgfHwgcGF0aC5qb2luKGhvbWVkaXIsICcubG9jYWwnLCAnc3RhdGUnKSxcbiAgICAgICAgbmFtZSxcbiAgICAgICk7XG4gICAgfTtcblxuICAgIHN3aXRjaCAocHJvY2Vzcy5wbGF0Zm9ybSkge1xuICAgICAgY2FzZSAnZGFyd2luJzpcbiAgICAgICAgcmV0dXJuIG1hY29zKCk7XG4gICAgICBjYXNlICd3aW4zMic6XG4gICAgICAgIHJldHVybiB3aW5kb3dzKCk7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gbGludXgoKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==