import { Construct } from 'constructs';
import { CustomResource, Duration, Stack, aws_cognito, aws_iam, } from 'aws-cdk-lib';
import { AttributionMetadataStorage, StackMetadataBackendOutputStorageStrategy, } from '@aws-amplify/backend-output-storage';
import * as path from 'path';
import { NodejsFunction } from 'aws-cdk-lib/aws-lambda-nodejs';
import { Runtime } from 'aws-cdk-lib/aws-lambda';
import { Provider } from 'aws-cdk-lib/custom-resources';
import { Role } from 'aws-cdk-lib/aws-iam';
import { fileURLToPath } from 'node:url';
/**
 * Expected key that auth output is stored under - must match backend-output-schemas's authOutputKey
 */
export const authOutputKey = 'AWS::Amplify::Auth';
const REFERENCE_AUTH_CUSTOM_RESOURCE_PROVIDER_ID = 'AmplifyRefAuthCustomResourceProvider';
const REFERENCE_AUTH_CUSTOM_RESOURCE_ID = 'AmplifyRefAuthCustomResource';
const RESOURCE_TYPE = 'Custom::AmplifyRefAuth';
const filename = fileURLToPath(import.meta.url);
const dirname = path.dirname(filename);
const resourcesRoot = path.normalize(path.join(dirname, 'lambda'));
const refAuthLambdaFilePath = path.join(resourcesRoot, 'reference_auth_initializer.js');
const authStackType = 'auth-Cognito';
/**
 * These properties are fetched by the custom resource and must be accounted for
 * in the final AuthOutput payload.
 */
export const OUTPUT_PROPERTIES_PROVIDED_BY_AUTH_CUSTOM_RESOURCE = [
    'allowUnauthenticatedIdentities',
    'signupAttributes',
    'usernameAttributes',
    'verificationMechanisms',
    'passwordPolicyMinLength',
    'passwordPolicyRequirements',
    'mfaConfiguration',
    'mfaTypes',
    'socialProviders',
    'oauthCognitoDomain',
    'oauthScope',
    'oauthRedirectSignIn',
    'oauthRedirectSignOut',
    'oauthResponseType',
    'oauthClientId',
];
/**
 * Reference Auth construct for using external auth resources
 */
export class AmplifyReferenceAuth extends Construct {
    resources;
    configurationCustomResource;
    /**
     * Create a new AmplifyConstruct
     */
    constructor(scope, id, props) {
        super(scope, id);
        this.resources = {
            userPool: aws_cognito.UserPool.fromUserPoolId(this, 'UserPool', props.userPoolId),
            userPoolClient: aws_cognito.UserPoolClient.fromUserPoolClientId(this, 'UserPoolClient', props.userPoolClientId),
            authenticatedUserIamRole: aws_iam.Role.fromRoleArn(this, 'authenticatedUserRole', props.authRoleArn),
            unauthenticatedUserIamRole: aws_iam.Role.fromRoleArn(this, 'unauthenticatedUserRole', props.unauthRoleArn),
            identityPoolId: props.identityPoolId,
            groups: {},
        };
        // mapping of existing group roles
        if (props.groups) {
            Object.entries(props.groups).forEach(([groupName, roleArn]) => {
                this.resources.groups[groupName] = {
                    role: Role.fromRoleArn(this, `${groupName}GroupRole`, roleArn),
                };
            });
        }
        // custom resource lambda
        const refAuthLambda = new NodejsFunction(scope, `${REFERENCE_AUTH_CUSTOM_RESOURCE_PROVIDER_ID}Lambda`, {
            runtime: Runtime.NODEJS_20_X,
            timeout: Duration.seconds(10),
            entry: refAuthLambdaFilePath,
            handler: 'handler',
        });
        // UserPool & UserPoolClient specific permissions
        refAuthLambda.grantPrincipal.addToPrincipalPolicy(new aws_iam.PolicyStatement({
            effect: aws_iam.Effect.ALLOW,
            actions: [
                'cognito-idp:DescribeUserPool',
                'cognito-idp:GetUserPoolMfaConfig',
                'cognito-idp:ListIdentityProviders',
                'cognito-idp:ListGroups',
                'cognito-idp:DescribeUserPoolClient',
            ],
            resources: [this.resources.userPool.userPoolArn],
        }));
        // IdentityPool specific permissions
        const stack = Stack.of(this);
        refAuthLambda.grantPrincipal.addToPrincipalPolicy(new aws_iam.PolicyStatement({
            effect: aws_iam.Effect.ALLOW,
            actions: [
                'cognito-identity:DescribeIdentityPool',
                'cognito-identity:GetIdentityPoolRoles',
            ],
            resources: [
                `arn:aws:cognito-identity:${stack.region}:${stack.account}:identitypool/${this.resources.identityPoolId}`,
            ],
        }));
        const provider = new Provider(scope, REFERENCE_AUTH_CUSTOM_RESOURCE_PROVIDER_ID, {
            onEventHandler: refAuthLambda,
        });
        const initializerProps = {
            userPoolId: props.userPoolId,
            identityPoolId: props.identityPoolId,
            userPoolClientId: props.userPoolClientId,
            authRoleArn: props.authRoleArn,
            unauthRoleArn: props.unauthRoleArn,
            groups: props.groups ?? {},
            region: Stack.of(this).region,
        };
        // custom resource
        this.configurationCustomResource = new CustomResource(scope, REFERENCE_AUTH_CUSTOM_RESOURCE_ID, {
            serviceToken: provider.serviceToken,
            properties: {
                ...initializerProps,
            },
            resourceType: RESOURCE_TYPE,
        });
        this.storeOutput(props.outputStorageStrategy);
        new AttributionMetadataStorage().storeAttributionMetadata(Stack.of(this), authStackType, fileURLToPath(new URL('../package.json', import.meta.url)));
    }
    /**
     * Stores auth output using the provided strategy
     */
    storeOutput = (outputStorageStrategy = new StackMetadataBackendOutputStorageStrategy(Stack.of(this))) => {
        // these properties cannot be overwritten
        const output = {
            userPoolId: this.resources.userPool.userPoolId,
            webClientId: this.resources.userPoolClient.userPoolClientId,
            identityPoolId: this.resources.identityPoolId,
            authRegion: Stack.of(this).region,
        };
        // assign cdk tokens which will be resolved during deployment
        for (const property of OUTPUT_PROPERTIES_PROVIDED_BY_AUTH_CUSTOM_RESOURCE) {
            output[property] =
                this.configurationCustomResource.getAttString(property);
        }
        outputStorageStrategy.addBackendOutputEntry(authOutputKey, {
            version: '1',
            payload: output,
        });
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVmZXJlbmNlX2NvbnN0cnVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9yZWZlcmVuY2VfY29uc3RydWN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDdkMsT0FBTyxFQUNMLGNBQWMsRUFDZCxRQUFRLEVBQ1IsS0FBSyxFQUNMLFdBQVcsRUFDWCxPQUFPLEdBQ1IsTUFBTSxhQUFhLENBQUM7QUFNckIsT0FBTyxFQUNMLDBCQUEwQixFQUMxQix5Q0FBeUMsR0FDMUMsTUFBTSxxQ0FBcUMsQ0FBQztBQUU3QyxPQUFPLEtBQUssSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUM3QixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDL0QsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ2pELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUN4RCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFM0MsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUd6Qzs7R0FFRztBQUNILE1BQU0sQ0FBQyxNQUFNLGFBQWEsR0FBRyxvQkFBb0IsQ0FBQztBQUVsRCxNQUFNLDBDQUEwQyxHQUM5QyxzQ0FBc0MsQ0FBQztBQUN6QyxNQUFNLGlDQUFpQyxHQUFHLDhCQUE4QixDQUFDO0FBQ3pFLE1BQU0sYUFBYSxHQUFHLHdCQUF3QixDQUFDO0FBRS9DLE1BQU0sUUFBUSxHQUFHLGFBQWEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ2hELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDdkMsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9B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cG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHtcbiAgQ3VzdG9tUmVzb3VyY2UsXG4gIER1cmF0aW9uLFxuICBTdGFjayxcbiAgYXdzX2NvZ25pdG8sXG4gIGF3c19pYW0sXG59IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7XG4gIEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3ksXG4gIFJlZmVyZW5jZUF1dGhSZXNvdXJjZXMsXG4gIFJlc291cmNlUHJvdmlkZXIsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHtcbiAgQXR0cmlidXRpb25NZXRhZGF0YVN0b3JhZ2UsXG4gIFN0YWNrTWV0YWRhdGFCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5LFxufSBmcm9tICdAYXdzLWFtcGxpZnkvYmFja2VuZC1vdXRwdXQtc3RvcmFnZSc7XG5pbXBvcnQgeyBBdXRoT3V0cHV0IH0gZnJvbSAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQtb3V0cHV0LXNjaGVtYXMnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IE5vZGVqc0Z1bmN0aW9uIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYS1ub2RlanMnO1xuaW1wb3J0IHsgUnVudGltZSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgUHJvdmlkZXIgfSBmcm9tICdhd3MtY2RrLWxpYi9jdXN0b20tcmVzb3VyY2VzJztcbmltcG9ydCB7IFJvbGUgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtaWFtJztcbmltcG9ydCB7IFJlZmVyZW5jZUF1dGhJbml0aWFsaXplclByb3BzIH0gZnJvbSAnLi9sYW1iZGEvcmVmZXJlbmNlX2F1dGhfaW5pdGlhbGl6ZXIuanMnO1xuaW1wb3J0IHsgZmlsZVVSTFRvUGF0aCB9IGZyb20gJ25vZGU6dXJsJztcbmltcG9ydCB7IFJlZmVyZW5jZUF1dGhQcm9wcyB9IGZyb20gJy4vcmVmZXJlbmNlX2ZhY3RvcnkuanMnO1xuXG4vKipcbiAqIEV4cGVjdGVkIGtleSB0aGF0IGF1dGggb3V0cHV0IGlzIHN0b3JlZCB1bmRlciAtIG11c3QgbWF0Y2ggYmFja2VuZC1vdXRwdXQtc2NoZW1hcydzIGF1dGhPdXRwdXRLZXlcbiAqL1xuZXhwb3J0IGNvbnN0IGF1dGhPdXRwdXRLZXkgPSAnQVdTOjpBbXBsaWZ5OjpBdXRoJztcblxuY29uc3QgUkVGRVJFTkNFX0FVVEhfQ1VTVE9NX1JFU09VUkNFX1BST1ZJREVSX0lEID1cbiAgJ0FtcGxpZnlSZWZBdXRoQ3VzdG9tUmVzb3VyY2VQcm92aWRlcic7XG5jb25zdCBSRUZFUkVOQ0VfQVVUSF9DVVNUT01fUkVTT1VSQ0VfSUQgPSAnQW1wbGlmeVJlZkF1dGhDdXN0b21SZXNvdXJjZSc7XG5jb25zdCBSRVNPVVJDRV9UWVBFID0gJ0N1c3RvbTo6QW1wbGlmeVJlZkF1dGgnO1xuXG5jb25zdCBmaWxlbmFtZSA9IGZpbGVVUkxUb1BhdGgoaW1wb3J0Lm1ldGEudXJsKTtcbmNvbnN0IGRpcm5hbWUgPSBwYXRoLmRpcm5hbWUoZmlsZW5hbWUpO1xuY29uc3QgcmVzb3VyY2VzUm9vdCA9IHBhdGgubm9ybWFsaXplKHBhdGguam9pbihkaXJuYW1lLCAnbGFtYmRhJykpO1xuY29uc3QgcmVmQXV0aExhbWJkYUZpbGVQYXRoID0gcGF0aC5qb2luKFxuICByZXNvdXJjZXNSb290LFxuICAncmVmZXJlbmNlX2F1dGhfaW5pdGlhbGl6ZXIuanMnLFxuKTtcblxuY29uc3QgYXV0aFN0YWNrVHlwZSA9ICdhdXRoLUNvZ25pdG8nO1xuXG4vKipcbiAqIFRoZXNlIHByb3BlcnRpZXMgYXJlIGZldGNoZWQgYnkgdGhlIGN1c3RvbSByZXNvdXJjZSBhbmQgbXVzdCBiZSBhY2NvdW50ZWQgZm9yXG4gKiBpbiB0aGUgZmluYWwgQXV0aE91dHB1dCBwYXlsb2FkLlxuICovXG5leHBvcnQgY29uc3QgT1VUUFVUX1BST1BFUlRJRVNfUFJPVklERURfQllfQVVUSF9DVVNUT01fUkVTT1VSQ0U6IChrZXlvZiBBdXRoT3V0cHV0WydwYXlsb2FkJ10pW10gPVxuICBbXG4gICAgJ2FsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllcycsXG4gICAgJ3NpZ251cEF0dHJpYnV0ZXMnLFxuICAgICd1c2VybmFtZUF0dHJpYnV0ZXMnLFxuICAgICd2ZXJpZmljYXRpb25NZWNoYW5pc21zJyxcbiAgICAncGFzc3dvcmRQb2xpY3lNaW5MZW5ndGgnLFxuICAgICdwYXNzd29yZFBvbGljeVJlcXVpcmVtZW50cycsXG4gICAgJ21mYUNvbmZpZ3VyYXRpb24nLFxuICAgICdtZmFUeXBlcycsXG4gICAgJ3NvY2lhbFByb3ZpZGVycycsXG4gICAgJ29hdXRoQ29nbml0b0RvbWFpbicsXG4gICAgJ29hdXRoU2NvcGUnLFxuICAgICdvYXV0aFJlZGlyZWN0U2lnbkluJyxcbiAgICAnb2F1dGhSZWRpcmVjdFNpZ25PdXQnLFxuICAgICdvYXV0aFJlc3BvbnNlVHlwZScsXG4gICAgJ29hdXRoQ2xpZW50SWQnLFxuICBdO1xuLyoqXG4gKiBSZWZlcmVuY2UgQXV0aCBjb25zdHJ1Y3QgZm9yIHVzaW5nIGV4dGVybmFsIGF1dGggcmVzb3VyY2VzXG4gKi9cbmV4cG9ydCBjbGFzcyBBbXBsaWZ5UmVmZXJlbmNlQXV0aFxuICBleHRlbmRzIENvbnN0cnVjdFxuICBpbXBsZW1lbnRzIFJlc291cmNlUHJvdmlkZXI8UmVmZXJlbmNlQXV0aFJlc291cmNlcz5cbntcbiAgcmVzb3VyY2VzOiBSZWZlcmVuY2VBdXRoUmVzb3VyY2VzO1xuXG4gIHByaXZhdGUgY29uZmlndXJhdGlvbkN1c3RvbVJlc291cmNlOiBDdXN0b21SZXNvdXJjZTtcblxuICAvKipcbiAgICogQ3JlYXRlIGEgbmV3IEFtcGxpZnlDb25zdHJ1Y3RcbiAgICovXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBSZWZlcmVuY2VBdXRoUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgdGhpcy5yZXNvdXJjZXMgPSB7XG4gICAgICB1c2VyUG9vbDogYXdzX2NvZ25pdG8uVXNlclBvb2wuZnJvbVVzZXJQb29sSWQoXG4gICAgICAgIHRoaXMsXG4gICAgICAgICdVc2VyUG9vbCcsXG4gICAgICAgIHByb3BzLnVzZXJQb29sSWQsXG4gICAgICApLFxuICAgICAgdXNlclBvb2xDbGllbnQ6IGF3c19jb2duaXRvLlVzZXJQb29sQ2xpZW50LmZyb21Vc2VyUG9vbENsaWVudElkKFxuICAgICAgICB0aGlzLFxuICAgICAgICAnVXNlclBvb2xDbGllbnQnLFxuICAgICAgICBwcm9wcy51c2VyUG9vbENsaWVudElkLFxuICAgICAgKSxcbiAgICAgIGF1dGhlbnRpY2F0ZWRVc2VySWFtUm9sZTogYXdzX2lhbS5Sb2xlLmZyb21Sb2xlQXJuKFxuICAgICAgICB0aGlzLFxuICAgICAgICAnYXV0aGVudGljYXRlZFVzZXJSb2xlJyxcbiAgICAgICAgcHJvcHMuYXV0aFJvbGVBcm4sXG4gICAgICApLFxuICAgICAgdW5hdXRoZW50aWNhdGVkVXNlcklhbVJvbGU6IGF3c19pYW0uUm9sZS5mcm9tUm9sZUFybihcbiAgICAgICAgdGhpcyxcbiAgICAgICAgJ3VuYXV0aGVudGljYXRlZFVzZXJSb2xlJyxcbiAgICAgICAgcHJvcHMudW5hdXRoUm9sZUFybixcbiAgICAgICksXG4gICAgICBpZGVudGl0eVBvb2xJZDogcHJvcHMuaWRlbnRpdHlQb29sSWQsXG4gICAgICBncm91cHM6IHt9LFxuICAgIH07XG5cbiAgICAvLyBtYXBwaW5nIG9mIGV4aXN0aW5nIGdyb3VwIHJvbGVzXG4gICAgaWYgKHByb3BzLmdyb3Vwcykge1xuICAgICAgT2JqZWN0LmVudHJpZXMocHJvcHMuZ3JvdXBzKS5mb3JFYWNoKChbZ3JvdXBOYW1lLCByb2xlQXJuXSkgPT4ge1xuICAgICAgICB0aGlzLnJlc291cmNlcy5ncm91cHNbZ3JvdXBOYW1lXSA9IHtcbiAgICAgICAgICByb2xlOiBSb2xlLmZyb21Sb2xlQXJuKHRoaXMsIGAke2dyb3VwTmFtZX1Hcm91cFJvbGVgLCByb2xlQXJuKSxcbiAgICAgICAgfTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIGN1c3RvbSByZXNvdXJjZSBsYW1iZGFcbiAgICBjb25zdCByZWZBdXRoTGFtYmRhID0gbmV3IE5vZGVqc0Z1bmN0aW9uKFxuICAgICAgc2NvcGUsXG4gICAgICBgJHtSRUZFUkVOQ0VfQVVUSF9DVVNUT01fUkVTT1VSQ0VfUFJPVklERVJfSUR9TGFtYmRhYCxcbiAgICAgIHtcbiAgICAgICAgcnVudGltZTogUnVudGltZS5OT0RFSlNfMjBfWCxcbiAgICAgICAgdGltZW91dDogRHVyYXRpb24uc2Vjb25kcygxMCksXG4gICAgICAgIGVudHJ5OiByZWZBdXRoTGFtYmRhRmlsZVBhdGgsXG4gICAgICAgIGhhbmRsZXI6ICdoYW5kbGVyJyxcbiAgICAgIH0sXG4gICAgKTtcbiAgICAvLyBVc2VyUG9vbCAmIFVzZXJQb29sQ2xpZW50IHNwZWNpZmljIHBlcm1pc3Npb25zXG4gICAgcmVmQXV0aExhbWJkYS5ncmFudFByaW5jaXBhbC5hZGRUb1ByaW5jaXBhbFBvbGljeShcbiAgICAgIG5ldyBhd3NfaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgIGVmZmVjdDogYXdzX2lhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICAnY29nbml0by1pZHA6RGVzY3JpYmVVc2VyUG9vbCcsXG4gICAgICAgICAgJ2NvZ25pdG8taWRwOkdldFVzZXJQb29sTWZhQ29uZmlnJyxcbiAgICAgICAgICAnY29nbml0by1pZHA6TGlzdElkZW50aXR5UHJvdmlkZXJzJyxcbiAgICAgICAgICAnY29nbml0by1pZHA6TGlzdEdyb3VwcycsXG4gICAgICAgICAgJ2NvZ25pdG8taWRwOkRlc2NyaWJlVXNlclBvb2xDbGllbnQnLFxuICAgICAgICBdLFxuICAgICAgICByZXNvdXJjZXM6IFt0aGlzLnJlc291cmNlcy51c2VyUG9vbC51c2VyUG9vbEFybl0sXG4gICAgICB9KSxcbiAgICApO1xuICAgIC8vIElkZW50aXR5UG9vbCBzcGVjaWZpYyBwZXJtaXNzaW9uc1xuICAgIGNvbnN0IHN0YWNrID0gU3RhY2sub2YodGhpcyk7XG4gICAgcmVmQXV0aExhbWJkYS5ncmFudFByaW5jaXBhbC5hZGRUb1ByaW5jaXBhbFBvbGljeShcbiAgICAgIG5ldyBhd3NfaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgIGVmZmVjdDogYXdzX2lhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICAnY29nbml0by1pZGVudGl0eTpEZXNjcmliZUlkZW50aXR5UG9vbCcsXG4gICAgICAgICAgJ2NvZ25pdG8taWRlbnRpdHk6R2V0SWRlbnRpdHlQb29sUm9sZXMnLFxuICAgICAgICBdLFxuICAgICAgICByZXNvdXJjZXM6IFtcbiAgICAgICAgICBgYXJuOmF3czpjb2duaXRvLWlkZW50aXR5OiR7c3RhY2sucmVnaW9ufToke3N0YWNrLmFjY291bnR9OmlkZW50aXR5cG9vbC8ke3RoaXMucmVzb3VyY2VzLmlkZW50aXR5UG9vbElkfWAsXG4gICAgICAgIF0sXG4gICAgICB9KSxcbiAgICApO1xuICAgIGNvbnN0IHByb3ZpZGVyID0gbmV3IFByb3ZpZGVyKFxuICAgICAgc2NvcGUsXG4gICAgICBSRUZFUkVOQ0VfQVVUSF9DVVNUT01fUkVTT1VSQ0VfUFJPVklERVJfSUQsXG4gICAgICB7XG4gICAgICAgIG9uRXZlbnRIYW5kbGVyOiByZWZBdXRoTGFtYmRhLFxuICAgICAgfSxcbiAgICApO1xuICAgIGNvbnN0IGluaXRpYWxpemVyUHJvcHM6IFJlZmVyZW5jZUF1dGhJbml0aWFsaXplclByb3BzID0ge1xuICAgICAgdXNlclBvb2xJZDogcHJvcHMudXNlclBvb2xJZCxcbiAgICAgIGlkZW50aXR5UG9vbElkOiBwcm9wcy5pZGVudGl0eVBvb2xJZCxcbiAgICAgIHVzZXJQb29sQ2xpZW50SWQ6IHByb3BzLnVzZXJQb29sQ2xpZW50SWQsXG4gICAgICBhdXRoUm9sZUFybjogcHJvcHMuYXV0aFJvbGVBcm4sXG4gICAgICB1bmF1dGhSb2xlQXJuOiBwcm9wcy51bmF1dGhSb2xlQXJuLFxuICAgICAgZ3JvdXBzOiBwcm9wcy5ncm91cHMgPz8ge30sXG4gICAgICByZWdpb246IFN0YWNrLm9mKHRoaXMpLnJlZ2lvbixcbiAgICB9O1xuICAgIC8vIGN1c3RvbSByZXNvdXJjZVxuICAgIHRoaXMuY29uZmlndXJhdGlvbkN1c3RvbVJlc291cmNlID0gbmV3IEN1c3RvbVJlc291cmNlKFxuICAgICAgc2NvcGUsXG4gICAgICBSRUZFUkVOQ0VfQVVUSF9DVVNUT01fUkVTT1VSQ0VfSUQsXG4gICAgICB7XG4gICAgICAgIHNlcnZpY2VUb2tlbjogcHJvdmlkZXIuc2VydmljZVRva2VuLFxuICAgICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgICAgLi4uaW5pdGlhbGl6ZXJQcm9wcyxcbiAgICAgICAgfSxcbiAgICAgICAgcmVzb3VyY2VUeXBlOiBSRVNPVVJDRV9UWVBFLFxuICAgICAgfSxcbiAgICApO1xuXG4gICAgdGhpcy5zdG9yZU91dHB1dChwcm9wcy5vdXRwdXRTdG9yYWdlU3RyYXRlZ3kpO1xuICAgIG5ldyBBdHRyaWJ1dGlvbk1ldGFkYXRhU3RvcmFnZSgpLnN0b3JlQXR0cmlidXRpb25NZXRhZGF0YShcbiAgICAgIFN0YWNrLm9mKHRoaXMpLFxuICAgICAgYXV0aFN0YWNrVHlwZSxcbiAgICAgIGZpbGVVUkxUb1BhdGgobmV3IFVSTCgnLi4vcGFja2FnZS5qc29uJywgaW1wb3J0Lm1ldGEudXJsKSksXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdG9yZXMgYXV0aCBvdXRwdXQgdXNpbmcgdGhlIHByb3ZpZGVkIHN0cmF0ZWd5XG4gICAqL1xuICBwcml2YXRlIHN0b3JlT3V0cHV0ID0gKFxuICAgIG91dHB1dFN0b3JhZ2VTdHJhdGVneTogQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneTxBdXRoT3V0cHV0PiA9IG5ldyBTdGFja01ldGFkYXRhQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneShcbiAgICAgIFN0YWNrLm9mKHRoaXMpLFxuICAgICksXG4gICk6IHZvaWQgPT4ge1xuICAgIC8vIHRoZXNlIHByb3BlcnRpZXMgY2Fubm90IGJlIG92ZXJ3cml0dGVuXG4gICAgY29uc3Qgb3V0cHV0OiBBdXRoT3V0cHV0WydwYXlsb2FkJ10gPSB7XG4gICAgICB1c2VyUG9vbElkOiB0aGlzLnJlc291cmNlcy51c2VyUG9vbC51c2VyUG9vbElkLFxuICAgICAgd2ViQ2xpZW50SWQ6IHRoaXMucmVzb3VyY2VzLnVzZXJQb29sQ2xpZW50LnVzZXJQb29sQ2xpZW50SWQsXG4gICAgICBpZGVudGl0eVBvb2xJZDogdGhpcy5yZXNvdXJjZXMuaWRlbnRpdHlQb29sSWQsXG4gICAgICBhdXRoUmVnaW9uOiBTdGFjay5vZih0aGlzKS5yZWdpb24sXG4gICAgfTtcblxuICAgIC8vIGFzc2lnbiBjZGsgdG9rZW5zIHdoaWNoIHdpbGwgYmUgcmVzb2x2ZWQgZHVyaW5nIGRlcGxveW1lbnRcbiAgICBmb3IgKGNvbnN0IHByb3BlcnR5IG9mIE9VVFBVVF9QUk9QRVJUSUVTX1BST1ZJREVEX0JZX0FVVEhfQ1VTVE9NX1JFU09VUkNFKSB7XG4gICAgICBvdXRwdXRbcHJvcGVydHldID1cbiAgICAgICAgdGhpcy5jb25maWd1cmF0aW9uQ3VzdG9tUmVzb3VyY2UuZ2V0QXR0U3RyaW5nKHByb3BlcnR5KTtcbiAgICB9XG5cbiAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3kuYWRkQmFja2VuZE91dHB1dEVudHJ5KGF1dGhPdXRwdXRLZXksIHtcbiAgICAgIHZlcnNpb246ICcxJyxcbiAgICAgIHBheWxvYWQ6IG91dHB1dCxcbiAgICB9KTtcbiAgfTtcbn1cbiJdfQ==