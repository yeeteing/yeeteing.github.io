"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.StackMetadataBackendOutputStorageStrategy = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
/**
 * Implementation of BackendOutputStorageStrategy that stores config data in stack metadata and outputs
 */
class StackMetadataBackendOutputStorageStrategy {
    stack;
    lazyListValueMap = new Map();
    /**
     * Initialize the instance with a stack.
     *
     * If the stack is an AmplifyStack, set a parameter in SSM so the stack can be identified later by the project environment
     */
    constructor(stack) {
        this.stack = stack;
    }
    /**
     * Store construct output as stack output and add metadata to the metadata object.
     */
    addBackendOutputEntry = (keyName, backendOutputEntry) => {
        // add all the data values as stack outputs
        Object.entries(backendOutputEntry.payload).forEach(([key, value]) => {
            new aws_cdk_lib_1.CfnOutput(this.stack, key, { value });
        });
        const metadata = this.stack.templateOptions.metadata || {};
        const existingMetadataEntry = metadata[keyName];
        this.addOrUpdateMetadata(existingMetadataEntry, keyName, backendOutputEntry);
    };
    /**
     * Lazily construct and append to output list as stack output and add metadata to the metadata object.
     */
    appendToBackendOutputList = (keyName, backendOutputEntry) => {
        const version = backendOutputEntry.version;
        let listsMap = this.lazyListValueMap.get(keyName);
        const metadata = this.stack.templateOptions.metadata || {};
        const existingMetadataEntry = metadata[keyName];
        if (existingMetadataEntry) {
            if (existingMetadataEntry.version !== version) {
                throw new Error(`Metadata entry for ${keyName} at version ${existingMetadataEntry.version} already exists. Cannot add another entry for the same key at version ${version}.`);
            }
        }
        this.addOrUpdateMetadata(existingMetadataEntry, keyName, backendOutputEntry);
        Object.entries(backendOutputEntry.payload ?? []).forEach(([listName, value]) => {
            if (!value) {
                return;
            }
            if (!listsMap) {
                listsMap = new Map();
                this.lazyListValueMap.set(keyName, listsMap);
            }
            let outputList = listsMap.get(listName);
            if (outputList) {
                outputList.push(value);
            }
            else {
                outputList = [value];
                listsMap.set(listName, outputList);
                new aws_cdk_lib_1.CfnOutput(this.stack, listName, {
                    value: aws_cdk_lib_1.Lazy.string({ produce: () => JSON.stringify(outputList) }),
                });
            }
        });
    };
    /**
     * Add or update metadata entry.
     * @param existingMetadataEntry - The existing metadata entry.
     * @param keyName - The key name.
     * @param backendOutputEntry - The backend output entry.
     */
    addOrUpdateMetadata(existingMetadataEntry, keyName, backendOutputEntry) {
        if (existingMetadataEntry) {
            this.stack.addMetadata(keyName, {
                version: backendOutputEntry.version,
                stackOutputs: [
                    ...new Set([
                        ...Object.keys(backendOutputEntry.payload),
                        ...existingMetadataEntry.stackOutputs,
                    ]),
                ],
            });
        }
        else {
            this.stack.addMetadata(keyName, {
                version: backendOutputEntry.version,
                stackOutputs: Object.keys(backendOutputEntry.payload),
            });
        }
    }
}
exports.StackMetadataBackendOutputStorageStrategy = StackMetadataBackendOutputStorageStrategy;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhY2tfbWV0YWRhdGFfb3V0cHV0X3N0b3JhZ2Vfc3RyYXRlZ3kuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvc3RhY2tfbWV0YWRhdGFfb3V0cHV0X3N0b3JhZ2Vfc3RyYXRlZ3kudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBS0EsNkNBQXFEO0FBTXJEOztHQUVHO0FBQ0gsTUFBYSx5Q0FBeUM7SUFXdkI7SUFSckIsZ0JBQWdCLEdBQ3RCLElBQUksR0FBRyxFQUFFLENBQUM7SUFFWjs7OztPQUlHO0lBQ0gsWUFBNkIsS0FBWTtRQUFaLFVBQUssR0FBTCxLQUFLLENBQU87SUFBRyxDQUFDO0lBRTdDOztPQUVHO0lBQ0gscUJBQXFCLEdBQUcsQ0FDdEIsT0FBZSxFQUNmLGtCQUFzQyxFQUNoQyxFQUFFO1FBQ1IsMkNBQTJDO1FBQzNDLE1BQU0sQ0FBQyxPQUFPLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLEVBQUUsRUFBRTtZQUNsRSxJQUFJLHVCQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQzVDLENBQUMsQ0FBQyxDQUFDO1FBRUgsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsUUFBUSxJQUFJLEVBQUUsQ0FBQztRQUMzRCxNQUFNLHFCQUFxQixHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUVoRCxJQUFJLENBQUMsbUJBQW1CLENBQ3RCLHFCQUFxQixFQUNyQixPQUFPLEVBQ1Asa0JBQWtCLENBQ25CLENBQUM7SUFDSixDQUFDLENBQUM7SUFFRjs7T0FFRztJQUNILHlCQUF5QixHQUFHLENBQzFCLE9BQWUsRUFDZixrQkFBbUQsRUFDN0MsRUFBRTtRQUNSLE1BQU0sT0FBTyxHQUFHLGtCQUFrQixDQUFDLE9BQU8sQ0FB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a2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneSxcbiAgRGVlcFBhcnRpYWwsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHsgQ2ZuT3V0cHV0LCBMYXp5LCBTdGFjayB9IGZyb20gJ2F3cy1jZGstbGliJztcblxuLy8gQWxpYXNlZCBzdHJpbmdzIGZvciByZWFkYWJpbGl0eVxudHlwZSBNZXRhZGF0YUtleSA9IHN0cmluZztcbnR5cGUgT3V0cHV0S2V5ID0gc3RyaW5nO1xuXG4vKipcbiAqIEltcGxlbWVudGF0aW9uIG9mIEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3kgdGhhdCBzdG9yZXMgY29uZmlnIGRhdGEgaW4gc3RhY2sgbWV0YWRhdGEgYW5kIG91dHB1dHNcbiAqL1xuZXhwb3J0IGNsYXNzIFN0YWNrTWV0YWRhdGFCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5XG4gIGltcGxlbWVudHMgQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneTxCYWNrZW5kT3V0cHV0RW50cnk+XG57XG4gIHByaXZhdGUgbGF6eUxpc3RWYWx1ZU1hcDogTWFwPE1ldGFkYXRhS2V5LCBNYXA8T3V0cHV0S2V5LCBzdHJpbmdbXT4+ID1cbiAgICBuZXcgTWFwKCk7XG5cbiAgLyoqXG4gICAqIEluaXRpYWxpemUgdGhlIGluc3RhbmNlIHdpdGggYSBzdGFjay5cbiAgICpcbiAgICogSWYgdGhlIHN0YWNrIGlzIGFuIEFtcGxpZnlTdGFjaywgc2V0IGEgcGFyYW1ldGVyIGluIFNTTSBzbyB0aGUgc3RhY2sgY2FuIGJlIGlkZW50aWZpZWQgbGF0ZXIgYnkgdGhlIHByb2plY3QgZW52aXJvbm1lbnRcbiAgICovXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgc3RhY2s6IFN0YWNrKSB7fVxuXG4gIC8qKlxuICAgKiBTdG9yZSBjb25zdHJ1Y3Qgb3V0cHV0IGFzIHN0YWNrIG91dHB1dCBhbmQgYWRkIG1ldGFkYXRhIHRvIHRoZSBtZXRhZGF0YSBvYmplY3QuXG4gICAqL1xuICBhZGRCYWNrZW5kT3V0cHV0RW50cnkgPSAoXG4gICAga2V5TmFtZTogc3RyaW5nLFxuICAgIGJhY2tlbmRPdXRwdXRFbnRyeTogQmFja2VuZE91dHB1dEVudHJ5LFxuICApOiB2b2lkID0+IHtcbiAgICAvLyBhZGQgYWxsIHRoZSBkYXRhIHZhbHVlcyBhcyBzdGFjayBvdXRwdXRzXG4gICAgT2JqZWN0LmVudHJpZXMoYmFja2VuZE91dHB1dEVudHJ5LnBheWxvYWQpLmZvckVhY2goKFtrZXksIHZhbHVlXSkgPT4ge1xuICAgICAgbmV3IENmbk91dHB1dCh0aGlzLnN0YWNrLCBrZXksIHsgdmFsdWUgfSk7XG4gICAgfSk7XG5cbiAgICBjb25zdCBtZXRhZGF0YSA9IHRoaXMuc3RhY2sudGVtcGxhdGVPcHRpb25zLm1ldGFkYXRhIHx8IHt9O1xuICAgIGNvbnN0IGV4aXN0aW5nTWV0YWRhdGFFbnRyeSA9IG1ldGFkYXRhW2tleU5hbWVdO1xuXG4gICAgdGhpcy5hZGRPclVwZGF0ZU1ldGFkYXRhKFxuICAgICAgZXhpc3RpbmdNZXRhZGF0YUVudHJ5LFxuICAgICAga2V5TmFtZSxcbiAgICAgIGJhY2tlbmRPdXRwdXRFbnRyeSxcbiAgICApO1xuICB9O1xuXG4gIC8qKlxuICAgKiBMYXppbHkgY29uc3RydWN0IGFuZCBhcHBlbmQgdG8gb3V0cHV0IGxpc3QgYXMgc3RhY2sgb3V0cHV0IGFuZCBhZGQgbWV0YWRhdGEgdG8gdGhlIG1ldGFkYXRhIG9iamVjdC5cbiAgICovXG4gIGFwcGVuZFRvQmFja2VuZE91dHB1dExpc3QgPSAoXG4gICAga2V5TmFtZTogc3RyaW5nLFxuICAgIGJhY2tlbmRPdXRwdXRFbnRyeTogRGVlcFBhcnRpYWw8QmFja2VuZE91dHB1dEVudHJ5PixcbiAgKTogdm9pZCA9PiB7XG4gICAgY29uc3QgdmVyc2lvbiA9IGJhY2tlbmRPdXRwdXRFbnRyeS52ZXJzaW9uO1xuICAgIGxldCBsaXN0c01hcCA9IHRoaXMubGF6eUxpc3RWYWx1ZU1hcC5nZXQoa2V5TmFtZSk7XG5cbiAgICBjb25zdCBtZXRhZGF0YSA9IHRoaXMuc3RhY2sudGVtcGxhdGVPcHRpb25zLm1ldGFkYXRhIHx8IHt9O1xuICAgIGNvbnN0IGV4aXN0aW5nTWV0YWRhdGFFbnRyeSA9IG1ldGFkYXRhW2tleU5hbWVdO1xuXG4gICAgaWYgKGV4aXN0aW5nTWV0YWRhdGFFbnRyeSkge1xuICAgICAgaWYgKGV4aXN0aW5nTWV0YWRhdGFFbnRyeS52ZXJzaW9uICE9PSB2ZXJzaW9uKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgTWV0YWRhdGEgZW50cnkgZm9yICR7a2V5TmFtZX0gYXQgdmVyc2lvbiAke2V4aXN0aW5nTWV0YWRhdGFFbnRyeS52ZXJzaW9ufSBhbHJlYWR5IGV4aXN0cy4gQ2Fubm90IGFkZCBhbm90aGVyIGVudHJ5IGZvciB0aGUgc2FtZSBrZXkgYXQgdmVyc2lvbiAke3ZlcnNpb259LmAsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy5hZGRPclVwZGF0ZU1ldGFkYXRhKFxuICAgICAgZXhpc3RpbmdNZXRhZGF0YUVudHJ5LFxuICAgICAga2V5TmFtZSxcbiAgICAgIGJhY2tlbmRPdXRwdXRFbnRyeSBhcyBCYWNrZW5kT3V0cHV0RW50cnksXG4gICAgKTtcblxuICAgIE9iamVjdC5lbnRyaWVzKGJhY2tlbmRPdXRwdXRFbnRyeS5wYXlsb2FkID8/IFtdKS5mb3JFYWNoKFxuICAgICAgKFtsaXN0TmFtZSwgdmFsdWVdKSA9PiB7XG4gICAgICAgIGlmICghdmFsdWUpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFsaXN0c01hcCkge1xuICAgICAgICAgIGxpc3RzTWFwID0gbmV3IE1hcCgpO1xuICAgICAgICAgIHRoaXMubGF6eUxpc3RWYWx1ZU1hcC5zZXQoa2V5TmFtZSwgbGlzdHNNYXApO1xuICAgICAgICB9XG4gICAgICAgIGxldCBvdXRwdXRMaXN0ID0gbGlzdHNNYXAuZ2V0KGxpc3ROYW1lKTtcblxuICAgICAgICBpZiAob3V0cHV0TGlzdCkge1xuICAgICAgICAgIG91dHB1dExpc3QucHVzaCh2YWx1ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgb3V0cHV0TGlzdCA9IFt2YWx1ZV07XG4gICAgICAgICAgbGlzdHNNYXAuc2V0KGxpc3ROYW1lLCBvdXRwdXRMaXN0KTtcblxuICAgICAgICAgIG5ldyBDZm5PdXRwdXQodGhpcy5zdGFjaywgbGlzdE5hbWUsIHtcbiAgICAgICAgICAgIHZhbHVlOiBMYXp5LnN0cmluZyh7IHByb2R1Y2U6ICgpID0+IEpTT04uc3RyaW5naWZ5KG91dHB1dExpc3QpIH0pLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgICk7XG4gIH07XG5cbiAgLyoqXG4gICAqIEFkZCBvciB1cGRhdGUgbWV0YWRhdGEgZW50cnkuXG4gICAqIEBwYXJhbSBleGlzdGluZ01ldGFkYXRhRW50cnkgLSBUaGUgZXhpc3RpbmcgbWV0YWRhdGEgZW50cnkuXG4gICAqIEBwYXJhbSBrZXlOYW1lIC0gVGhlIGtleSBuYW1lLlxuICAgKiBAcGFyYW0gYmFja2VuZE91dHB1dEVudHJ5IC0gVGhlIGJhY2tlbmQgb3V0cHV0IGVudHJ5LlxuICAgKi9cbiAgcHJpdmF0ZSBhZGRPclVwZGF0ZU1ldGFkYXRhKFxuICAgIGV4aXN0aW5nTWV0YWRhdGFFbnRyeTpcbiAgICAgIHwgeyB2ZXJzaW9uOiBzdHJpbmc7IHN0YWNrT3V0cHV0czogc3RyaW5nW10gfVxuICAgICAgfCB1bmRlZmluZWQsXG4gICAga2V5TmFtZTogc3RyaW5nLFxuICAgIGJhY2tlbmRPdXRwdXRFbnRyeTogQmFja2VuZE91dHB1dEVudHJ5LFxuICApIHtcbiAgICBpZiAoZXhpc3RpbmdNZXRhZGF0YUVudHJ5KSB7XG4gICAgICB0aGlzLnN0YWNrLmFkZE1ldGFkYXRhKGtleU5hbWUsIHtcbiAgICAgICAgdmVyc2lvbjogYmFja2VuZE91dHB1dEVudHJ5LnZlcnNpb24sXG4gICAgICAgIHN0YWNrT3V0cHV0czogW1xuICAgICAgICAgIC4uLm5ldyBTZXQoW1xuICAgICAgICAgICAgLi4uT2JqZWN0LmtleXMoYmFja2VuZE91dHB1dEVudHJ5LnBheWxvYWQpLFxuICAgICAgICAgICAgLi4uZXhpc3RpbmdNZXRhZGF0YUVudHJ5LnN0YWNrT3V0cHV0cyxcbiAgICAgICAgICBdKSxcbiAgICAgICAgXSxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnN0YWNrLmFkZE1ldGFkYXRhKGtleU5hbWUsIHtcbiAgICAgICAgdmVyc2lvbjogYmFja2VuZE91dHB1dEVudHJ5LnZlcnNpb24sXG4gICAgICAgIHN0YWNrT3V0cHV0czogT2JqZWN0LmtleXMoYmFja2VuZE91dHB1dEVudHJ5LnBheWxvYWQpLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG59XG4iXX0=