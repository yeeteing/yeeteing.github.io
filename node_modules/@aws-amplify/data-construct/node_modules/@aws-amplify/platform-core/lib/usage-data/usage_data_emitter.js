"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.DefaultUsageDataEmitter = void 0;
const uuid_1 = require("uuid");
const account_id_fetcher_js_1 = require("./account_id_fetcher.js");
const os_1 = __importDefault(require("os"));
const https_1 = __importDefault(require("https"));
const get_installation_id_js_1 = require("./get_installation_id.js");
const constants_js_1 = require("./constants.js");
const get_usage_data_url_js_1 = require("./get_usage_data_url.js");
const is_ci_1 = __importDefault(require("is-ci"));
const serializable_error_js_1 = require("./serializable_error.js");
/**
 * Entry point for sending usage data metrics
 */
class DefaultUsageDataEmitter {
    libraryVersion;
    dependencies;
    sessionUuid;
    url;
    accountIdFetcher;
    dependenciesToReport;
    /**
     * Constructor for UsageDataEmitter
     */
    constructor(libraryVersion, dependencies, sessionUuid = (0, uuid_1.v4)(), url = (0, get_usage_data_url_js_1.getUrl)(), accountIdFetcher = new account_id_fetcher_js_1.AccountIdFetcher()) {
        this.libraryVersion = libraryVersion;
        this.dependencies = dependencies;
        this.sessionUuid = sessionUuid;
        this.url = url;
        this.accountIdFetcher = accountIdFetcher;
        const targetDependencies = ['aws-cdk', 'aws-cdk-lib'];
        this.dependenciesToReport = this.dependencies?.filter((dependency) => targetDependencies.includes(dependency.name));
    }
    emitSuccess = async (metrics, dimensions) => {
        try {
            const data = await this.getUsageData({
                state: 'SUCCEEDED',
                metrics,
                dimensions,
            });
            await this.send(data);
            // eslint-disable-next-line amplify-backend-rules/no-empty-catch
        }
        catch {
            // Don't propagate errors related to not being able to send telemetry
        }
    };
    emitFailure = async (error, dimensions) => {
        try {
            const data = await this.getUsageData({
                state: 'FAILED',
                error,
                dimensions,
            });
            await this.send(data);
            // eslint-disable-next-line amplify-backend-rules/no-empty-catch
        }
        catch {
            // Don't propagate errors related to not being able to send telemetry
        }
    };
    getUsageData = async (options) => {
        return {
            accountId: await this.accountIdFetcher.fetch(),
            sessionUuid: this.sessionUuid,
            installationUuid: (0, get_installation_id_js_1.getInstallationUuid)(),
            amplifyCliVersion: this.libraryVersion,
            timestamp: new Date().toISOString(),
            error: options.error ? new serializable_error_js_1.SerializableError(options.error) : undefined,
            downstreamException: options.error &&
                options.error.cause &&
                options.error.cause instanceof Error
                ? new serializable_error_js_1.SerializableError(options.error.cause)
                : undefined,
            payloadVersion: constants_js_1.latestPayloadVersion,
            osPlatform: os_1.default.platform(),
            osRelease: os_1.default.release(),
            nodeVersion: process.versions.node,
            state: options.state,
            codePathDurations: this.translateMetricsToUsageData(options.metrics),
            input: this.translateDimensionsToUsageData(options.dimensions),
            isCi: is_ci_1.default,
            projectSetting: {
                editor: process.env.npm_config_user_agent,
                details: JSON.stringify(this.dependenciesToReport),
            },
        };
    };
    send = (data) => {
        return new Promise((resolve) => {
            const payload = JSON.stringify(data);
            const req = https_1.default.request({
                hostname: this.url.hostname,
                port: this.url.port,
                path: this.url.path,
                method: 'POST',
                headers: {
                    'content-type': 'application/json',
                    'content-length': payload.length,
                },
            });
            req.on('error', () => {
                /* noop */
            });
            req.setTimeout(2000, () => {
                // 2 seconds
                resolve();
            });
            req.write(payload);
            req.end(() => {
                resolve();
            });
        });
    };
    translateMetricsToUsageData = (metrics) => {
        if (!metrics)
            return {};
        let totalDuration, platformStartup;
        for (const [name, data] of Object.entries(metrics)) {
            if (name === 'totalTime') {
                totalDuration = Math.round(data);
            }
            else if (name === 'synthesisTime') {
                platformStartup = Math.round(data);
            }
        }
        return { totalDuration, platformStartup };
    };
    translateDimensionsToUsageData = (dimensions) => {
        let command = '';
        if (dimensions) {
            for (const [name, data] of Object.entries(dimensions)) {
                if (name === 'command') {
                    command = data;
                }
            }
        }
        return { command, plugin: 'Gen2' };
    };
}
exports.DefaultUsageDataEmitter = DefaultUsageDataEmitter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNhZ2VfZGF0YV9lbWl0dGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3VzYWdlLWRhdGEvdXNhZ2VfZGF0YV9lbWl0dGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLCtCQUFrQztBQUNsQyxtRUFBMkQ7QUFFM0QsNENBQW9CO0FBQ3BCLGtEQUEwQjtBQUMxQixxRUFBK0Q7QUFDL0QsaURBQXNEO0FBQ3RELG1FQUFpRDtBQUNqRCxrREFBeUI7QUFDekIsbUVBQTREO0FBSzVEOztHQUVHO0FBQ0gsTUFBYSx1QkFBdUI7SUFNZjtJQUNBO0lBQ0E7SUFDQTtJQUNBO0lBVFgsb0JBQW9CLENBQXFCO0lBQ2pEOztPQUVHO0lBQ0gsWUFDbUIsY0FBc0IsRUFDdEIsWUFBZ0MsRUFDaEMsY0FBYyxJQUFBLFNBQUksR0FBRSxFQUNwQixNQUFNLElBQUEsOEJBQU0sR0FBRSxFQUNkLG1CQUFtQixJQUFJLHdDQUFnQixFQUFFO1FBSnpDLG1CQUFjLEdBQWQsY0FBYyxDQUFRO1FBQ3RCLGlCQUFZLEdBQVosWUFBWSxDQUFvQjtRQUNoQyxnQkFBVyxHQUFYLFdBQVcsQ0FBUztRQUNwQixRQUFHLEdBQUgsR0FBRyxDQUFXO1FBQ2QscUJBQWdCLEdBQWhCLGdCQUFnQixDQUF5QjtRQUUxRCxNQUFNLGtCQUFrQixHQUFHLENBQUMsU0FBUyxFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBRXRELElBQUksQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLENBQUMsWUFBWSxFQUFFLE1BQU0sQ0FBQyxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQ25FLGtCQUFrQixDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQzdDLENBQUM7SUFDSixDQUFDO0lBRUQsV0FBVyxHQUFHLEtBQUssRUFDakIsT0FBZ0MsRUFDaEMsVUFBbUMsRUFDbkMsRUFBRTtRQUNGLElBQUk7WUFDRixNQUFNLElBQUksR0FBRyxNQUFNLElBQUksQ0FBQyxZQUFZ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QixJQUFJLFVBQVUsRUFBRTtZQUNkLEtBQUssTUFBTSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxFQUFFO2dCQUNyRCxJQUFJLElBQUksS0FBSyxTQUFTLEVBQUU7b0JBQ3RCLE9BQU8sR0FBRyxJQUFJLENBQUM7aUJBQ2hCO2FBQ0Y7U0FDRjtRQUNELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxDQUFDO0lBQ3JDLENBQUMsQ0FBQztDQUNIO0FBN0lELDBEQTZJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHY0IGFzIHV1aWQgfSBmcm9tICd1dWlkJztcbmltcG9ydCB7IEFjY291bnRJZEZldGNoZXIgfSBmcm9tICcuL2FjY291bnRfaWRfZmV0Y2hlci5qcyc7XG5pbXBvcnQgeyBVc2FnZURhdGEgfSBmcm9tICcuL3VzYWdlX2RhdGEuanMnO1xuaW1wb3J0IG9zIGZyb20gJ29zJztcbmltcG9ydCBodHRwcyBmcm9tICdodHRwcyc7XG5pbXBvcnQgeyBnZXRJbnN0YWxsYXRpb25VdWlkIH0gZnJvbSAnLi9nZXRfaW5zdGFsbGF0aW9uX2lkLmpzJztcbmltcG9ydCB7IGxhdGVzdFBheWxvYWRWZXJzaW9uIH0gZnJvbSAnLi9jb25zdGFudHMuanMnO1xuaW1wb3J0IHsgZ2V0VXJsIH0gZnJvbSAnLi9nZXRfdXNhZ2VfZGF0YV91cmwuanMnO1xuaW1wb3J0IGlzQ0kgZnJvbSAnaXMtY2knO1xuaW1wb3J0IHsgU2VyaWFsaXphYmxlRXJyb3IgfSBmcm9tICcuL3NlcmlhbGl6YWJsZV9lcnJvci5qcyc7XG5pbXBvcnQgeyBVc2FnZURhdGFFbWl0dGVyIH0gZnJvbSAnLi91c2FnZV9kYXRhX2VtaXR0ZXJfZmFjdG9yeS5qcyc7XG5pbXBvcnQgeyBBbXBsaWZ5RXJyb3IgfSBmcm9tICcuLi9pbmRleC5qcyc7XG5pbXBvcnQgeyBEZXBlbmRlbmN5IH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5cbi8qKlxuICogRW50cnkgcG9pbnQgZm9yIHNlbmRpbmcgdXNhZ2UgZGF0YSBtZXRyaWNzXG4gKi9cbmV4cG9ydCBjbGFzcyBEZWZhdWx0VXNhZ2VEYXRhRW1pdHRlciBpbXBsZW1lbnRzIFVzYWdlRGF0YUVtaXR0ZXIge1xuICBwcml2YXRlIGRlcGVuZGVuY2llc1RvUmVwb3J0PzogQXJyYXk8RGVwZW5kZW5jeT47XG4gIC8qKlxuICAgKiBDb25zdHJ1Y3RvciBmb3IgVXNhZ2VEYXRhRW1pdHRlclxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBsaWJyYXJ5VmVyc2lvbjogc3RyaW5nLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZGVwZW5kZW5jaWVzPzogQXJyYXk8RGVwZW5kZW5jeT4sXG4gICAgcHJpdmF0ZSByZWFkb25seSBzZXNzaW9uVXVpZCA9IHV1aWQoKSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHVybCA9IGdldFVybCgpLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYWNjb3VudElkRmV0Y2hlciA9IG5ldyBBY2NvdW50SWRGZXRjaGVyKCksXG4gICkge1xuICAgIGNvbnN0IHRhcmdldERlcGVuZGVuY2llcyA9IFsnYXdzLWNkaycsICdhd3MtY2RrLWxpYiddO1xuXG4gICAgdGhpcy5kZXBlbmRlbmNpZXNUb1JlcG9ydCA9IHRoaXMuZGVwZW5kZW5jaWVzPy5maWx0ZXIoKGRlcGVuZGVuY3kpID0+XG4gICAgICB0YXJnZXREZXBlbmRlbmNpZXMuaW5jbHVkZXMoZGVwZW5kZW5jeS5uYW1lKSxcbiAgICApO1xuICB9XG5cbiAgZW1pdFN1Y2Nlc3MgPSBhc3luYyAoXG4gICAgbWV0cmljcz86IFJlY29yZDxzdHJpbmcsIG51bWJlcj4sXG4gICAgZGltZW5zaW9ucz86IFJlY29yZDxzdHJpbmcsIHN0cmluZz4sXG4gICkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBkYXRhID0gYXdhaXQgdGhpcy5nZXRVc2FnZURhdGEoe1xuICAgICAgICBzdGF0ZTogJ1NVQ0NFRURFRCcsXG4gICAgICAgIG1ldHJpY3MsXG4gICAgICAgIGRpbWVuc2lvbnMsXG4gICAgICB9KTtcbiAgICAgIGF3YWl0IHRoaXMuc2VuZChkYXRhKTtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBhbXBsaWZ5LWJhY2tlbmQtcnVsZXMvbm8tZW1wdHktY2F0Y2hcbiAgICB9IGNhdGNoIHtcbiAgICAgIC8vIERvbid0IHByb3BhZ2F0ZSBlcnJvcnMgcmVsYXRlZCB0byBub3QgYmVpbmcgYWJsZSB0byBzZW5kIHRlbGVtZXRyeVxuICAgIH1cbiAgfTtcblxuICBlbWl0RmFpbHVyZSA9IGFzeW5jIChcbiAgICBlcnJvcjogQW1wbGlmeUVycm9yLFxuICAgIGRpbWVuc2lvbnM/OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+LFxuICApID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMuZ2V0VXNhZ2VEYXRhKHtcbiAgICAgICAgc3RhdGU6ICdGQUlMRUQnLFxuICAgICAgICBlcnJvcixcbiAgICAgICAgZGltZW5zaW9ucyxcbiAgICAgIH0pO1xuICAgICAgYXdhaXQgdGhpcy5zZW5kKGRhdGEpO1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGFtcGxpZnktYmFja2VuZC1ydWxlcy9uby1lbXB0eS1jYXRjaFxuICAgIH0gY2F0Y2gge1xuICAgICAgLy8gRG9uJ3QgcHJvcGFnYXRlIGVycm9ycyByZWxhdGVkIHRvIG5vdCBiZWluZyBhYmxlIHRvIHNlbmQgdGVsZW1ldHJ5XG4gICAgfVxuICB9O1xuXG4gIHByaXZhdGUgZ2V0VXNhZ2VEYXRhID0gYXN5bmMgKG9wdGlvbnM6IHtcbiAgICBzdGF0ZTogJ1NVQ0NFRURFRCcgfCAnRkFJTEVEJztcbiAgICBtZXRyaWNzPzogUmVjb3JkPHN0cmluZywgbnVtYmVyPjtcbiAgICBkaW1lbnNpb25zPzogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcbiAgICBlcnJvcj86IEFtcGxpZnlFcnJvcjtcbiAgfSk6IFByb21pc2U8VXNhZ2VEYXRhPiA9PiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGFjY291bnRJZDogYXdhaXQgdGhpcy5hY2NvdW50SWRGZXRjaGVyLmZldGNoKCksXG4gICAgICBzZXNzaW9uVXVpZDogdGhpcy5zZXNzaW9uVXVpZCxcbiAgICAgIGluc3RhbGxhdGlvblV1aWQ6IGdldEluc3RhbGxhdGlvblV1aWQoKSxcbiAgICAgIGFtcGxpZnlDbGlWZXJzaW9uOiB0aGlzLmxpYnJhcnlWZXJzaW9uLFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICBlcnJvcjogb3B0aW9ucy5lcnJvciA/IG5ldyBTZXJpYWxpemFibGVFcnJvcihvcHRpb25zLmVycm9yKSA6IHVuZGVmaW5lZCxcbiAgICAgIGRvd25zdHJlYW1FeGNlcHRpb246XG4gICAgICAgIG9wdGlvbnMuZXJyb3IgJiZcbiAgICAgICAgb3B0aW9ucy5lcnJvci5jYXVzZSAmJlxuICAgICAgICBvcHRpb25zLmVycm9yLmNhdXNlIGluc3RhbmNlb2YgRXJyb3JcbiAgICAgICAgICA/IG5ldyBTZXJpYWxpemFibGVFcnJvcihvcHRpb25zLmVycm9yLmNhdXNlKVxuICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgcGF5bG9hZFZlcnNpb246IGxhdGVzdFBheWxvYWRWZXJzaW9uLFxuICAgICAgb3NQbGF0Zm9ybTogb3MucGxhdGZvcm0oKSxcbiAgICAgIG9zUmVsZWFzZTogb3MucmVsZWFzZSgpLFxuICAgICAgbm9kZVZlcnNpb246IHByb2Nlc3MudmVyc2lvbnMubm9kZSxcbiAgICAgIHN0YXRlOiBvcHRpb25zLnN0YXRlLFxuICAgICAgY29kZVBhdGhEdXJhdGlvbnM6IHRoaXMudHJhbnNsYXRlTWV0cmljc1RvVXNhZ2VEYXRhKG9wdGlvbnMubWV0cmljcyksXG4gICAgICBpbnB1dDogdGhpcy50cmFuc2xhdGVEaW1lbnNpb25zVG9Vc2FnZURhdGEob3B0aW9ucy5kaW1lbnNpb25zKSxcbiAgICAgIGlzQ2k6IGlzQ0ksXG4gICAgICBwcm9qZWN0U2V0dGluZzoge1xuICAgICAgICBlZGl0b3I6IHByb2Nlc3MuZW52Lm5wbV9jb25maWdfdXNlcl9hZ2VudCxcbiAgICAgICAgZGV0YWlsczogSlNPTi5zdHJpbmdpZnkodGhpcy5kZXBlbmRlbmNpZXNUb1JlcG9ydCksXG4gICAgICB9LFxuICAgIH07XG4gIH07XG5cbiAgcHJpdmF0ZSBzZW5kID0gKGRhdGE6IFVzYWdlRGF0YSkgPT4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZSkgPT4ge1xuICAgICAgY29uc3QgcGF5bG9hZDogc3RyaW5nID0gSlNPTi5zdHJpbmdpZnkoZGF0YSk7XG4gICAgICBjb25zdCByZXEgPSBodHRwcy5yZXF1ZXN0KHtcbiAgICAgICAgaG9zdG5hbWU6IHRoaXMudXJsLmhvc3RuYW1lLFxuICAgICAgICBwb3J0OiB0aGlzLnVybC5wb3J0LFxuICAgICAgICBwYXRoOiB0aGlzLnVybC5wYXRoLFxuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdjb250ZW50LXR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgJ2NvbnRlbnQtbGVuZ3RoJzogcGF5bG9hZC5sZW5ndGgsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICAgIHJlcS5vbignZXJyb3InLCAoKSA9PiB7XG4gICAgICAgIC8qIG5vb3AgKi9cbiAgICAgIH0pO1xuICAgICAgcmVxLnNldFRpbWVvdXQoMjAwMCwgKCkgPT4ge1xuICAgICAgICAvLyAyIHNlY29uZHNcbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfSk7XG5cbiAgICAgIHJlcS53cml0ZShwYXlsb2FkKTtcbiAgICAgIHJlcS5lbmQoKCkgPT4ge1xuICAgICAgICByZXNvbHZlKCk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfTtcblxuICBwcml2YXRlIHRyYW5zbGF0ZU1ldHJpY3NUb1VzYWdlRGF0YSA9IChtZXRyaWNzPzogUmVjb3JkPHN0cmluZywgbnVtYmVyPikgPT4ge1xuICAgIGlmICghbWV0cmljcykgcmV0dXJuIHt9O1xuICAgIGxldCB0b3RhbER1cmF0aW9uLCBwbGF0Zm9ybVN0YXJ0dXA7XG4gICAgZm9yIChjb25zdCBbbmFtZSwgZGF0YV0gb2YgT2JqZWN0LmVudHJpZXMobWV0cmljcykpIHtcbiAgICAgIGlmIChuYW1lID09PSAndG90YWxUaW1lJykge1xuICAgICAgICB0b3RhbER1cmF0aW9uID0gTWF0aC5yb3VuZChkYXRhKTtcbiAgICAgIH0gZWxzZSBpZiAobmFtZSA9PT0gJ3N5bnRoZXNpc1RpbWUnKSB7XG4gICAgICAgIHBsYXRmb3JtU3RhcnR1cCA9IE1hdGgucm91bmQoZGF0YSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB7IHRvdGFsRHVyYXRpb24sIHBsYXRmb3JtU3RhcnR1cCB9O1xuICB9O1xuXG4gIHByaXZhdGUgdHJhbnNsYXRlRGltZW5zaW9uc1RvVXNhZ2VEYXRhID0gKFxuICAgIGRpbWVuc2lvbnM/OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+LFxuICApID0+IHtcbiAgICBsZXQgY29tbWFuZCA9ICcnO1xuICAgIGlmIChkaW1lbnNpb25zKSB7XG4gICAgICBmb3IgKGNvbnN0IFtuYW1lLCBkYXRhXSBvZiBPYmplY3QuZW50cmllcyhkaW1lbnNpb25zKSkge1xuICAgICAgICBpZiAobmFtZSA9PT0gJ2NvbW1hbmQnKSB7XG4gICAgICAgICAgY29tbWFuZCA9IGRhdGE7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHsgY29tbWFuZCwgcGx1Z2luOiAnR2VuMicgfTtcbiAgfTtcbn1cbiJdfQ==