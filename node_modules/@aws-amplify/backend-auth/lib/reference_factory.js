import { authAccessBuilder as _authAccessBuilder } from './access_builder.js';
import path from 'path';
import { AmplifyUserError, TagName } from '@aws-amplify/platform-core';
import { AuthAccessPolicyArbiterFactory } from './auth_access_policy_arbiter.js';
import { Stack, Tags } from 'aws-cdk-lib';
import { UserPoolAccessPolicyFactory } from './userpool_access_policy_factory.js';
import { AmplifyAuthFactory } from './factory.js';
import { AmplifyReferenceAuth } from './reference_construct.js';
/**
 * Singleton factory for AmplifyReferenceAuth that can be used in Amplify project files.
 *
 * Exported for testing purpose only & should NOT be exported out of the package.
 */
export class AmplifyReferenceAuthFactory {
    props;
    importStack;
    provides = 'AuthResources';
    generator;
    /**
     * Set the properties that will be used to initialize AmplifyReferenceAuth
     */
    constructor(props, 
    // eslint-disable-next-line @aws-amplify/amplify-backend-rules/prefer-amplify-errors
    importStack = new Error().stack) {
        this.props = props;
        this.importStack = importStack;
        if (AmplifyAuthFactory.factoryCount > 0) {
            throw new AmplifyUserError('MultipleSingletonResourcesError', {
                message: 'Multiple `defineAuth` or `referenceAuth` calls are not allowed within an Amplify backend',
                resolution: 'Remove all but one `defineAuth` or `referenceAuth` call',
            });
        }
        AmplifyAuthFactory.factoryCount++;
    }
    /**
     * Get a singleton instance of AmplifyReferenceAuth
     */
    getInstance = (getInstanceProps) => {
        const { constructContainer, importPathVerifier } = getInstanceProps;
        importPathVerifier?.verify(this.importStack, path.join('amplify', 'auth', 'resource'), 'Amplify Auth must be defined in amplify/auth/resource.ts');
        if (!this.generator) {
            this.generator = new AmplifyReferenceAuthGenerator(this.props, getInstanceProps);
        }
        return constructContainer.getOrCompute(this.generator);
    };
}
class AmplifyReferenceAuthGenerator {
    props;
    getInstanceProps;
    authAccessBuilder;
    authAccessPolicyArbiterFactory;
    resourceGroupName = 'auth';
    name;
    constructor(props, getInstanceProps, authAccessBuilder = _authAccessBuilder, authAccessPolicyArbiterFactory = new AuthAccessPolicyArbiterFactory()) {
        this.props = props;
        this.getInstanceProps = getInstanceProps;
        this.authAccessBuilder = authAccessBuilder;
        this.authAccessPolicyArbiterFactory = authAccessPolicyArbiterFactory;
        this.name = 'amplifyAuth';
    }
    generateContainerEntry = ({ scope, ssmEnvironmentEntriesGenerator, }) => {
        const authProps = {
            ...this.props,
            outputStorageStrategy: this.getInstanceProps.outputStorageStrategy,
        };
        let authConstruct;
        try {
            authConstruct = new AmplifyReferenceAuth(scope, this.name, authProps);
        }
        catch (error) {
            throw new AmplifyUserError('AmplifyReferenceAuthConstructInitializationError', {
                message: 'Failed to instantiate reference auth construct',
                resolution: 'See the underlying error message for more details.',
            }, error);
        }
        Tags.of(authConstruct).add(TagName.FRIENDLY_NAME, this.name);
        const authConstructMixin = {
            ...authConstruct,
            /**
             * Returns a resourceAccessAcceptor for the given role
             * @param roleIdentifier Either the auth or unauth role name or the name of a UserPool group
             */
            getResourceAccessAcceptor: (roleIdentifier) => ({
                identifier: `${roleIdentifier}ResourceAccessAcceptor`,
                acceptResourceAccess: (policy) => {
                    const role = roleNameIsAuthRoleName(roleIdentifier)
                        ? authConstruct.resources[roleIdentifier]
                        : authConstruct.resources.groups?.[roleIdentifier]?.role;
                    if (!role) {
                        throw new AmplifyUserError('InvalidResourceAccessConfigError', {
                            message: `No auth IAM role found for "${roleIdentifier}".`,
                            resolution: `If you are trying to configure UserPool group access, ensure that the group name is specified correctly.`,
                        });
                    }
                    policy.attachToRole(role);
                },
            }),
            stack: Stack.of(authConstruct),
        };
        if (!this.props.access) {
            return authConstructMixin;
        }
        // props.access is the access callback defined by the customer
        // here we inject the authAccessBuilder into the callback and run it
        // this produces the access definition that will be used to create the auth access policies
        const accessDefinition = this.props.access(this.authAccessBuilder);
        const ssmEnvironmentEntries = ssmEnvironmentEntriesGenerator.generateSsmEnvironmentEntries({
            [`${this.name}_USERPOOL_ID`]: authConstructMixin.resources.userPool.userPoolId,
        });
        const authPolicyArbiter = this.authAccessPolicyArbiterFactory.getInstance(accessDefinition, this.getInstanceProps, ssmEnvironmentEntries, new UserPoolAccessPolicyFactory(authConstruct.resources.userPool));
        authPolicyArbiter.arbitratePolicies();
        return authConstructMixin;
    };
}
const roleNameIsAuthRoleName = (roleName) => {
    return (roleName === 'authenticatedUserIamRole' ||
        roleName === 'unauthenticatedUserIamRole');
};
/**
 * Provide references to existing auth resources.
 */
export const referenceAuth = (props) => {
    return new AmplifyReferenceAuthFactory(props, 
    // eslint-disable-next-line @aws-amplify/amplify-backend-rules/prefer-amplify-errors
    new Error().stack);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVmZXJlbmNlX2ZhY3RvcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcmVmZXJlbmNlX2ZhY3RvcnkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBZUEsT0FBTyxFQUFFLGlCQUFpQixJQUFJLGtCQUFrQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDOUUsT0FBTyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQ3hCLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxPQUFPLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUN2RSxPQUFPLEVBQUUsOEJBQThCLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUNqRixPQUFPLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUUxQyxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUNsRixPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDbEQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFzRGhFOzs7O0dBSUc7QUFDSCxNQUFNLE9BQU8sMkJBQTJCO0lBV25CO0lBRUE7SUFWVixRQUFRLEdBQUcsZUFBZSxDQUFDO0lBRTVCLFNBQVMsQ0FBbUM7SUFFcEQ7O09BRUc7SUFDSCxZQUNtQixLQUFnQztJQUNqRCxvRkFBb0Y7SUFDbkUsY0FBYyxJQUFJLEtBQUssRUFBRSxDQUFDLEtBQUs7UUFGL0IsVUFBSyxHQUFMLEtBQUssQ0FBMkI7UUFFaEMsZ0JBQVcsR0FBWCxXQUFXLENBQW9CO1FBRWhELElBQUksa0JBQWtCLENBQUMsWUFBWSxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ3hDLE1BQU0sSUFBSSxnQkFBZ0IsQ0FBQyxpQ0FBaUMsRUFBRTtnQkFDNUQsT0FBTyxFQUNMLDBGQUEwRjtnQkFDNUYsVUFBVSxFQUFFLHlEQUF5RDthQUN0RSxDQUFDLENBQUM7UUFDTCxDQUFDO1FBQ0Qsa0JBQWtCLENBQUMsWUFB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YSxHQUFHLENBQzNCLEtBQWdDLEVBQ1EsRUFBRTtJQUMxQyxPQUFPLElBQUksMkJBQTJCLENBQ3BDLEtBQUs7SUFDTCxvRkFBb0Y7SUFDcEYsSUFBSSxLQUFLLEVBQUUsQ0FBQyxLQUFLLENBQ2xCLENBQUM7QUFDSixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBbXBsaWZ5UmVzb3VyY2VHcm91cE5hbWUsXG4gIEF1dGhSb2xlTmFtZSxcbiAgQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneSxcbiAgQ29uc3RydWN0Q29udGFpbmVyRW50cnlHZW5lcmF0b3IsXG4gIENvbnN0cnVjdEZhY3RvcnksXG4gIENvbnN0cnVjdEZhY3RvcnlHZXRJbnN0YW5jZVByb3BzLFxuICBHZW5lcmF0ZUNvbnRhaW5lckVudHJ5UHJvcHMsXG4gIFJlZmVyZW5jZUF1dGhSZXNvdXJjZXMsXG4gIFJlc291cmNlQWNjZXNzQWNjZXB0b3IsXG4gIFJlc291cmNlQWNjZXNzQWNjZXB0b3JGYWN0b3J5LFxuICBSZXNvdXJjZVByb3ZpZGVyLFxuICBTdGFja1Byb3ZpZGVyLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7IEF1dGhBY2Nlc3NHZW5lcmF0b3IsIEV4cGFuZCB9IGZyb20gJy4vdHlwZXMuanMnO1xuaW1wb3J0IHsgYXV0aEFjY2Vzc0J1aWxkZXIgYXMgX2F1dGhBY2Nlc3NCdWlsZGVyIH0gZnJvbSAnLi9hY2Nlc3NfYnVpbGRlci5qcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IEFtcGxpZnlVc2VyRXJyb3IsIFRhZ05hbWUgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5pbXBvcnQgeyBBdXRoQWNjZXNzUG9saWN5QXJiaXRlckZhY3RvcnkgfSBmcm9tICcuL2F1dGhfYWNjZXNzX3BvbGljeV9hcmJpdGVyLmpzJztcbmltcG9ydCB7IFN0YWNrLCBUYWdzIH0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgUG9saWN5IH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWlhbSc7XG5pbXBvcnQgeyBVc2VyUG9vbEFjY2Vzc1BvbGljeUZhY3RvcnkgfSBmcm9tICcuL3VzZXJwb29sX2FjY2Vzc19wb2xpY3lfZmFjdG9yeS5qcyc7XG5pbXBvcnQgeyBBbXBsaWZ5QXV0aEZhY3RvcnkgfSBmcm9tICcuL2ZhY3RvcnkuanMnO1xuaW1wb3J0IHsgQW1wbGlmeVJlZmVyZW5jZUF1dGggfSBmcm9tICcuL3JlZmVyZW5jZV9jb25zdHJ1Y3QuanMnO1xuaW1wb3J0IHsgQXV0aE91dHB1dCB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLW91dHB1dC1zY2hlbWFzJztcblxuZXhwb3J0IHR5cGUgUmVmZXJlbmNlQXV0aFByb3BzID0ge1xuICAvKipcbiAgICogQGludGVybmFsXG4gICAqL1xuICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3k/OiBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5PEF1dGhPdXRwdXQ+O1xuICAvKipcbiAgICogRXhpc3RpbmcgVXNlclBvb2wgSWRcbiAgICovXG4gIHVzZXJQb29sSWQ6IHN0cmluZztcbiAgLyoqXG4gICAqIEV4aXN0aW5nIElkZW50aXR5UG9vbCBJZFxuICAgKi9cbiAgaWRlbnRpdHlQb29sSWQ6IHN0cmluZztcbiAgLyoqXG4gICAqIEV4aXN0aW5nIFVzZXJQb29sQ2xpZW50IElkXG4gICAqL1xuICB1c2VyUG9vbENsaWVudElkOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBFeGlzdGluZyBBdXRoUm9sZSBBUk5cbiAgICovXG4gIGF1dGhSb2xlQXJuOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBFeGlzdGluZyBVbmF1dGhSb2xlIEFSTlxuICAgKi9cbiAgdW5hdXRoUm9sZUFybjogc3RyaW5nO1xuICAvKipcbiAgICogQSBtYXBwaW5nIG9mIGV4aXN0aW5nIGdyb3VwIG5hbWVzIGFuZCB0aGVpciBhc3NvY2lhdGVkIHJvbGUgQVJOc1xuICAgKiB3aGljaCBjYW4gYmUgdXNlZCBmb3IgZ3JvdXAgcGVybWlzc2lvbnMuXG4gICAqL1xuICBncm91cHM/OiB7XG4gICAgW2dyb3VwTmFtZTogc3RyaW5nXTogc3RyaW5nO1xuICB9O1xufTtcblxuZXhwb3J0IHR5cGUgQmFja2VuZFJlZmVyZW5jZUF1dGggPSBSZXNvdXJjZVByb3ZpZGVyPFJlZmVyZW5jZUF1dGhSZXNvdXJjZXM+ICZcbiAgUmVzb3VyY2VBY2Nlc3NBY2NlcHRvckZhY3Rvcnk8QXV0aFJvbGVOYW1lIHwgc3RyaW5nPiAmXG4gIFN0YWNrUHJvdmlkZXI7XG5cbmV4cG9ydCB0eXBlIEFtcGxpZnlSZWZlcmVuY2VBdXRoUHJvcHMgPSBFeHBhbmQ8XG4gIE9taXQ8UmVmZXJlbmNlQXV0aFByb3BzLCAnb3V0cHV0U3RvcmFnZVN0cmF0ZWd5Jz4gJiB7XG4gICAgLyoqXG4gICAgICogQ29uZmlndXJlIGFjY2VzcyB0byBhdXRoIGZvciBvdGhlciBBbXBsaWZ5IHJlc291cmNlc1xuICAgICAqIEBzZWUgaHR0cHM6Ly9kb2NzLmFtcGxpZnkuYXdzL3JlYWN0L2J1aWxkLWEtYmFja2VuZC9hdXRoL2dyYW50LWFjY2Vzcy10by1hdXRoLXJlc291cmNlcy9cbiAgICAgKiBAZXhhbXBsZVxuICAgICAqIGFjY2VzczogKGFsbG93KSA9PiBbYWxsb3cucmVzb3VyY2UocG9zdENvbmZpcm1hdGlvbikudG8oW1wiYWRkVXNlclRvR3JvdXBcIl0pXVxuICAgICAqIEBleGFtcGxlXG4gICAgICogYWNjZXNzOiAoYWxsb3cpID0+IFthbGxvdy5yZXNvdXJjZShncm91cE1hbmFnZXIpLnRvKFtcIm1hbmFnZUdyb3Vwc1wiXSldXG4gICAgICovXG4gICAgYWNjZXNzPzogQXV0aEFjY2Vzc0dlbmVyYXRvcjtcbiAgfVxuPjtcbi8qKlxuICogU2luZ2xldG9uIGZhY3RvcnkgZm9yIEFtcGxpZnlSZWZlcmVuY2VBdXRoIHRoYXQgY2FuIGJlIHVzZWQgaW4gQW1wbGlmeSBwcm9qZWN0IGZpbGVzLlxuICpcbiAqIEV4cG9ydGVkIGZvciB0ZXN0aW5nIHB1cnBvc2Ugb25seSAmIHNob3VsZCBOT1QgYmUgZXhwb3J0ZWQgb3V0IG9mIHRoZSBwYWNrYWdlLlxuICovXG5leHBvcnQgY2xhc3MgQW1wbGlmeVJlZmVyZW5jZUF1dGhGYWN0b3J5XG4gIGltcGxlbWVudHMgQ29uc3RydWN0RmFjdG9yeTxCYWNrZW5kUmVmZXJlbmNlQXV0aD5cbntcbiAgcmVhZG9ubHkgcHJvdmlkZXMgPSAnQXV0aFJlc291cmNlcyc7XG5cbiAgcHJpdmF0ZSBnZW5lcmF0b3I6IENvbnN0cnVjdENvbnRhaW5lckVudHJ5R2VuZXJhdG9yO1xuXG4gIC8qKlxuICAgKiBTZXQgdGhlIHByb3BlcnRpZXMgdGhhdCB3aWxsIGJlIHVzZWQgdG8gaW5pdGlhbGl6ZSBBbXBsaWZ5UmVmZXJlbmNlQXV0aFxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcm9wczogQW1wbGlmeVJlZmVyZW5jZUF1dGhQcm9wcyxcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQGF3cy1hbXBsaWZ5L2FtcGxpZnktYmFja2VuZC1ydWxlcy9wcmVmZXItYW1wbGlmeS1lcnJvcnNcbiAgICBwcml2YXRlIHJlYWRvbmx5IGltcG9ydFN0YWNrID0gbmV3IEVycm9yKCkuc3RhY2ssXG4gICkge1xuICAgIGlmIChBbXBsaWZ5QXV0aEZhY3RvcnkuZmFjdG9yeUNvdW50ID4gMCkge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoJ011bHRpcGxlU2luZ2xldG9uUmVzb3VyY2VzRXJyb3InLCB7XG4gICAgICAgIG1lc3NhZ2U6XG4gICAgICAgICAgJ011bHRpcGxlIGBkZWZpbmVBdXRoYCBvciBgcmVmZXJlbmNlQXV0aGAgY2FsbHMgYXJlIG5vdCBhbGxvd2VkIHdpdGhpbiBhbiBBbXBsaWZ5IGJhY2tlbmQnLFxuICAgICAgICByZXNvbHV0aW9uOiAnUmVtb3ZlIGFsbCBidXQgb25lIGBkZWZpbmVBdXRoYCBvciBgcmVmZXJlbmNlQXV0aGAgY2FsbCcsXG4gICAgICB9KTtcbiAgICB9XG4gICAgQW1wbGlmeUF1dGhGYWN0b3J5LmZhY3RvcnlDb3VudCsrO1xuICB9XG4gIC8qKlxuICAgKiBHZXQgYSBzaW5nbGV0b24gaW5zdGFuY2Ugb2YgQW1wbGlmeVJlZmVyZW5jZUF1dGhcbiAgICovXG4gIGdldEluc3RhbmNlID0gKFxuICAgIGdldEluc3RhbmNlUHJvcHM6IENvbnN0cnVjdEZhY3RvcnlHZXRJbnN0YW5jZVByb3BzLFxuICApOiBCYWNrZW5kUmVmZXJlbmNlQXV0aCA9PiB7XG4gICAgY29uc3QgeyBjb25zdHJ1Y3RDb250YWluZXIsIGltcG9ydFBhdGhWZXJpZmllciB9ID0gZ2V0SW5zdGFuY2VQcm9wcztcbiAgICBpbXBvcnRQYXRoVmVyaWZpZXI/LnZlcmlmeShcbiAgICAgIHRoaXMuaW1wb3J0U3RhY2ssXG4gICAgICBwYXRoLmpvaW4oJ2FtcGxpZnknLCAnYXV0aCcsICdyZXNvdXJjZScpLFxuICAgICAgJ0FtcGxpZnkgQXV0aCBtdXN0IGJlIGRlZmluZWQgaW4gYW1wbGlmeS9hdXRoL3Jlc291cmNlLnRzJyxcbiAgICApO1xuICAgIGlmICghdGhpcy5nZW5lcmF0b3IpIHtcbiAgICAgIHRoaXMuZ2VuZXJhdG9yID0gbmV3IEFtcGxpZnlSZWZlcmVuY2VBdXRoR2VuZXJhdG9yKFxuICAgICAgICB0aGlzLnByb3BzLFxuICAgICAgICBnZXRJbnN0YW5jZVByb3BzLFxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbnN0cnVjdENvbnRhaW5lci5nZXRPckNvbXB1dGUoXG4gICAgICB0aGlzLmdlbmVyYXRvcixcbiAgICApIGFzIEJhY2tlbmRSZWZlcmVuY2VBdXRoO1xuICB9O1xufVxuY2xhc3MgQW1wbGlmeVJlZmVyZW5jZUF1dGhHZW5lcmF0b3JcbiAgaW1wbGVtZW50cyBDb25zdHJ1Y3RDb250YWluZXJFbnRyeUdlbmVyYXRvclxue1xuICByZWFkb25seSByZXNvdXJjZUdyb3VwTmFtZTogQW1wbGlmeVJlc291cmNlR3JvdXBOYW1lID0gJ2F1dGgnO1xuICBwcml2YXRlIHJlYWRvbmx5IG5hbWU6IHN0cmluZztcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByb3BzOiBBbXBsaWZ5UmVmZXJlbmNlQXV0aFByb3BzLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZ2V0SW5zdGFuY2VQcm9wczogQ29uc3RydWN0RmFjdG9yeUdldEluc3RhbmNlUHJvcHMsXG4gICAgcHJpdmF0ZSByZWFkb25seSBhdXRoQWNjZXNzQnVpbGRlciA9IF9hdXRoQWNjZXNzQnVpbGRlcixcbiAgICBwcml2YXRlIHJlYWRvbmx5IGF1dGhBY2Nlc3NQb2xpY3lBcmJpdGVyRmFjdG9yeSA9IG5ldyBBdXRoQWNjZXNzUG9saWN5QXJiaXRlckZhY3RvcnkoKSxcbiAgKSB7XG4gICAgdGhpcy5uYW1lID0gJ2FtcGxpZnlBdXRoJztcbiAgfVxuXG4gIGdlbmVyYXRlQ29udGFpbmVyRW50cnkgPSAoe1xuICAgIHNjb3BlLFxuICAgIHNzbUVudmlyb25tZW50RW50cmllc0dlbmVyYXRvcixcbiAgfTogR2VuZXJhdGVDb250YWluZXJFbnRyeVByb3BzKSA9PiB7XG4gICAgY29uc3QgYXV0aFByb3BzOiBSZWZlcmVuY2VBdXRoUHJvcHMgPSB7XG4gICAgICAuLi50aGlzLnByb3BzLFxuICAgICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5OiB0aGlzLmdldEluc3RhbmNlUHJvcHMub3V0cHV0U3RvcmFnZVN0cmF0ZWd5LFxuICAgIH07XG5cbiAgICBsZXQgYXV0aENvbnN0cnVjdDogQW1wbGlmeVJlZmVyZW5jZUF1dGg7XG4gICAgdHJ5IHtcbiAgICAgIGF1dGhDb25zdHJ1Y3QgPSBuZXcgQW1wbGlmeVJlZmVyZW5jZUF1dGgoc2NvcGUsIHRoaXMubmFtZSwgYXV0aFByb3BzKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICdBbXBsaWZ5UmVmZXJlbmNlQXV0aENvbnN0cnVjdEluaXRpYWxpemF0aW9uRXJyb3InLFxuICAgICAgICB7XG4gICAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBpbnN0YW50aWF0ZSByZWZlcmVuY2UgYXV0aCBjb25zdHJ1Y3QnLFxuICAgICAgICAgIHJlc29sdXRpb246ICdTZWUgdGhlIHVuZGVybHlpbmcgZXJyb3IgbWVzc2FnZSBmb3IgbW9yZSBkZXRhaWxzLicsXG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yIGFzIEVycm9yLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBUYWdzLm9mKGF1dGhDb25zdHJ1Y3QpLmFkZChUYWdOYW1lLkZSSUVORExZX05BTUUsIHRoaXMubmFtZSk7XG5cbiAgICBjb25zdCBhdXRoQ29uc3RydWN0TWl4aW46IEJhY2tlbmRSZWZlcmVuY2VBdXRoID0ge1xuICAgICAgLi4uYXV0aENvbnN0cnVjdCxcbiAgICAgIC8qKlxuICAgICAgICogUmV0dXJucyBhIHJlc291cmNlQWNjZXNzQWNjZXB0b3IgZm9yIHRoZSBnaXZlbiByb2xlXG4gICAgICAgKiBAcGFyYW0gcm9sZUlkZW50aWZpZXIgRWl0aGVyIHRoZSBhdXRoIG9yIHVuYXV0aCByb2xlIG5hbWUgb3IgdGhlIG5hbWUgb2YgYSBVc2VyUG9vbCBncm91cFxuICAgICAgICovXG4gICAgICBnZXRSZXNvdXJjZUFjY2Vzc0FjY2VwdG9yOiAoXG4gICAgICAgIHJvbGVJZGVudGlmaWVyOiBBdXRoUm9sZU5hbWUgfCBzdHJpbmcsXG4gICAgICApOiBSZXNvdXJjZUFjY2Vzc0FjY2VwdG9yID0+ICh7XG4gICAgICAgIGlkZW50aWZpZXI6IGAke3JvbGVJZGVudGlmaWVyfVJlc291cmNlQWNjZXNzQWNjZXB0b3JgLFxuICAgICAgICBhY2NlcHRSZXNvdXJjZUFjY2VzczogKHBvbGljeTogUG9saWN5KSA9PiB7XG4gICAgICAgICAgY29uc3Qgcm9sZSA9IHJvbGVOYW1lSXNBdXRoUm9sZU5hbWUocm9sZUlkZW50aWZpZXIpXG4gICAgICAgICAgICA/IGF1dGhDb25zdHJ1Y3QucmVzb3VyY2VzW3JvbGVJZGVudGlmaWVyXVxuICAgICAgICAgICAgOiBhdXRoQ29uc3RydWN0LnJlc291cmNlcy5ncm91cHM/Lltyb2xlSWRlbnRpZmllcl0/LnJvbGU7XG4gICAgICAgICAgaWYgKCFyb2xlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcignSW52YWxpZFJlc291cmNlQWNjZXNzQ29uZmlnRXJyb3InLCB7XG4gICAgICAgICAgICAgIG1lc3NhZ2U6IGBObyBhdXRoIElBTSByb2xlIGZvdW5kIGZvciBcIiR7cm9sZUlkZW50aWZpZXJ9XCIuYCxcbiAgICAgICAgICAgICAgcmVzb2x1dGlvbjogYElmIHlvdSBhcmUgdHJ5aW5nIHRvIGNvbmZpZ3VyZSBVc2VyUG9vbCBncm91cCBhY2Nlc3MsIGVuc3VyZSB0aGF0IHRoZSBncm91cCBuYW1lIGlzIHNwZWNpZmllZCBjb3JyZWN0bHkuYCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICBwb2xpY3kuYXR0YWNoVG9Sb2xlKHJvbGUpO1xuICAgICAgICB9LFxuICAgICAgfSksXG4gICAgICBzdGFjazogU3RhY2sub2YoYXV0aENvbnN0cnVjdCksXG4gICAgfTtcbiAgICBpZiAoIXRoaXMucHJvcHMuYWNjZXNzKSB7XG4gICAgICByZXR1cm4gYXV0aENvbnN0cnVjdE1peGluO1xuICAgIH1cbiAgICAvLyBwcm9wcy5hY2Nlc3MgaXMgdGhlIGFjY2VzcyBjYWxsYmFjayBkZWZpbmVkIGJ5IHRoZSBjdXN0b21lclxuICAgIC8vIGhlcmUgd2UgaW5qZWN0IHRoZSBhdXRoQWNjZXNzQnVpbGRlciBpbnRvIHRoZSBjYWxsYmFjayBhbmQgcnVuIGl0XG4gICAgLy8gdGhpcyBwcm9kdWNlcyB0aGUgYWNjZXNzIGRlZmluaXRpb24gdGhhdCB3aWxsIGJlIHVzZWQgdG8gY3JlYXRlIHRoZSBhdXRoIGFjY2VzcyBwb2xpY2llc1xuICAgIGNvbnN0IGFjY2Vzc0RlZmluaXRpb24gPSB0aGlzLnByb3BzLmFjY2Vzcyh0aGlzLmF1dGhBY2Nlc3NCdWlsZGVyKTtcblxuICAgIGNvbnN0IHNzbUVudmlyb25tZW50RW50cmllcyA9XG4gICAgICBzc21FbnZpcm9ubWVudEVudHJpZXNHZW5lcmF0b3IuZ2VuZXJhdGVTc21FbnZpcm9ubWVudEVudHJpZXMoe1xuICAgICAgICBbYCR7dGhpcy5uYW1lfV9VU0VSUE9PTF9JRGBdOlxuICAgICAgICAgIGF1dGhDb25zdHJ1Y3RNaXhpbi5yZXNvdXJjZXMudXNlclBvb2wudXNlclBvb2xJZCxcbiAgICAgIH0pO1xuXG4gICAgY29uc3QgYXV0aFBvbGljeUFyYml0ZXIgPSB0aGlzLmF1dGhBY2Nlc3NQb2xpY3lBcmJpdGVyRmFjdG9yeS5nZXRJbnN0YW5jZShcbiAgICAgIGFjY2Vzc0RlZmluaXRpb24sXG4gICAgICB0aGlzLmdldEluc3RhbmNlUHJvcHMsXG4gICAgICBzc21FbnZpcm9ubWVudEVudHJpZXMsXG4gICAgICBuZXcgVXNlclBvb2xBY2Nlc3NQb2xpY3lGYWN0b3J5KGF1dGhDb25zdHJ1Y3QucmVzb3VyY2VzLnVzZXJQb29sKSxcbiAgICApO1xuXG4gICAgYXV0aFBvbGljeUFyYml0ZXIuYXJiaXRyYXRlUG9saWNpZXMoKTtcblxuICAgIHJldHVybiBhdXRoQ29uc3RydWN0TWl4aW47XG4gIH07XG59XG5cbmNvbnN0IHJvbGVOYW1lSXNBdXRoUm9sZU5hbWUgPSAocm9sZU5hbWU6IHN0cmluZyk6IHJvbGVOYW1lIGlzIEF1dGhSb2xlTmFtZSA9PiB7XG4gIHJldHVybiAoXG4gICAgcm9sZU5hbWUgPT09ICdhdXRoZW50aWNhdGVkVXNlcklhbVJvbGUnIHx8XG4gICAgcm9sZU5hbWUgPT09ICd1bmF1dGhlbnRpY2F0ZWRVc2VySWFtUm9sZSdcbiAgKTtcbn07XG5cbi8qKlxuICogUHJvdmlkZSByZWZlcmVuY2VzIHRvIGV4aXN0aW5nIGF1dGggcmVzb3VyY2VzLlxuICovXG5leHBvcnQgY29uc3QgcmVmZXJlbmNlQXV0aCA9IChcbiAgcHJvcHM6IEFtcGxpZnlSZWZlcmVuY2VBdXRoUHJvcHMsXG4pOiBDb25zdHJ1Y3RGYWN0b3J5PEJhY2tlbmRSZWZlcmVuY2VBdXRoPiA9PiB7XG4gIHJldHVybiBuZXcgQW1wbGlmeVJlZmVyZW5jZUF1dGhGYWN0b3J5KFxuICAgIHByb3BzLFxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAYXdzLWFtcGxpZnkvYW1wbGlmeS1iYWNrZW5kLXJ1bGVzL3ByZWZlci1hbXBsaWZ5LWVycm9yc1xuICAgIG5ldyBFcnJvcigpLnN0YWNrLFxuICApO1xufTtcbiJdfQ==