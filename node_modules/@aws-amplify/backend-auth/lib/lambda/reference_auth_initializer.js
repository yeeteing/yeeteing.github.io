import { CognitoIdentityProviderClient, DescribeUserPoolClientCommand, DescribeUserPoolCommand, GetUserPoolMfaConfigCommand, ListGroupsCommand, ListIdentityProvidersCommand, } from '@aws-sdk/client-cognito-identity-provider';
import { CognitoIdentityClient, DescribeIdentityPoolCommand, GetIdentityPoolRolesCommand, } from '@aws-sdk/client-cognito-identity';
import { randomUUID } from 'node:crypto';
/**
 * Initializer that fetches and process auth resources.
 */
export class ReferenceAuthInitializer {
    cognitoIdentityClient;
    cognitoIdentityProviderClient;
    uuidGenerator;
    /**
     * Create a new initializer
     * @param cognitoIdentityClient identity client
     * @param cognitoIdentityProviderClient identity provider client
     */
    constructor(cognitoIdentityClient, cognitoIdentityProviderClient, uuidGenerator) {
        this.cognitoIdentityClient = cognitoIdentityClient;
        this.cognitoIdentityProviderClient = cognitoIdentityProviderClient;
        this.uuidGenerator = uuidGenerator;
    }
    /**
     * Handles custom resource events
     * @param event event to process
     * @returns custom resource response
     */
    handleEvent = async (event) => {
        console.info(`Received '${event.RequestType}' event`);
        // physical id is only generated on create, otherwise it must stay the same
        const physicalId = event.RequestType === 'Create'
            ? this.uuidGenerator()
            : event.PhysicalResourceId;
        // on delete, just respond with success since we don't need to do anything
        if (event.RequestType === 'Delete') {
            return {
                RequestId: event.RequestId,
                LogicalResourceId: event.LogicalResourceId,
                PhysicalResourceId: physicalId,
                StackId: event.StackId,
                NoEcho: true,
                Status: 'SUCCESS',
            };
        }
        // for create or update events, we will fetch and validate resource properties
        const props = event.ResourceProperties;
        const { userPool, userPoolPasswordPolicy, userPoolMFA, userPoolGroups, userPoolProviders, userPoolClient, identityPool, roles, } = await this.getResourceDetails(props.userPoolId, props.identityPoolId, props.userPoolClientId);
        this.validateResources(userPool, userPoolProviders, userPoolGroups, userPoolClient, identityPool, roles, props);
        const userPoolOutputs = await this.getUserPoolOutputs(userPool, userPoolPasswordPolicy, userPoolProviders, userPoolMFA, props.region);
        const identityPoolOutputs = await this.getIdentityPoolOutputs(identityPool);
        const userPoolClientOutputs = await this.getUserPoolClientOutputs(userPoolClient);
        const data = {
            userPoolId: props.userPoolId,
            webClientId: props.userPoolClientId,
            identityPoolId: props.identityPoolId,
            ...userPoolOutputs,
            ...identityPoolOutputs,
            ...userPoolClientOutputs,
        };
        return {
            RequestId: event.RequestId,
            LogicalResourceId: event.LogicalResourceId,
            PhysicalResourceId: physicalId,
            StackId: event.StackId,
            NoEcho: true,
            Data: data,
            Status: 'SUCCESS',
        };
    };
    getUserPool = async (userPoolId) => {
        const userPoolCommand = new DescribeUserPoolCommand({
            UserPoolId: userPoolId,
        });
        const userPoolResponse = await this.cognitoIdentityProviderClient.send(userPoolCommand);
        if (!userPoolResponse.UserPool) {
            throw new Error('Failed to retrieve the specified UserPool.');
        }
        const userPool = userPoolResponse.UserPool;
        const policy = userPool.Policies?.PasswordPolicy;
        if (!policy) {
            throw new Error('Failed to retrieve password policy.');
        }
        return {
            userPool: userPoolResponse.UserPool,
            userPoolPasswordPolicy: policy,
        };
    };
    getUserPoolMFASettings = async (userPoolId) => {
        // mfa types
        const mfaCommand = new GetUserPoolMfaConfigCommand({
            UserPoolId: userPoolId,
        });
        const mfaResponse = await this.cognitoIdentityProviderClient.send(mfaCommand);
        return mfaResponse;
    };
    getUserPoolGroups = async (userPoolId) => {
        let nextToken;
        const groups = [];
        do {
            const listGroupsResponse = await this.cognitoIdentityProviderClient.send(new ListGroupsCommand({
                UserPoolId: userPoolId,
                NextToken: nextToken,
            }));
            if (!listGroupsResponse.Groups) {
                throw new Error('An error occurred while retrieving the groups for the user pool.');
            }
            groups.push(...listGroupsResponse.Groups);
            nextToken = listGroupsResponse.NextToken;
        } while (nextToken);
        return groups;
    };
    getUserPoolProviders = async (userPoolId) => {
        const providers = [];
        let nextToken;
        do {
            const providersResponse = await this.cognitoIdentityProviderClient.send(new ListIdentityProvidersCommand({
                UserPoolId: userPoolId,
                NextToken: nextToken,
            }));
            if (providersResponse.Providers === undefined) {
                throw new Error('An error occurred while retrieving identity providers for the user pool.');
            }
            providers.push(...providersResponse.Providers);
            nextToken = providersResponse.NextToken;
        } while (nextToken);
        return providers;
    };
    getIdentityPool = async (identityPoolId) => {
        const idpResponse = await this.cognitoIdentityClient.send(new DescribeIdentityPoolCommand({
            IdentityPoolId: identityPoolId,
        }));
        if (!idpResponse.IdentityPoolId) {
            throw new Error('An error occurred while retrieving the identity pool details.');
        }
        return idpResponse;
    };
    getIdentityPoolRoles = async (identityPoolId) => {
        const rolesCommand = new GetIdentityPoolRolesCommand({
            IdentityPoolId: identityPoolId,
        });
        const rolesResponse = await this.cognitoIdentityClient.send(rolesCommand);
        if (!rolesResponse.Roles) {
            throw new Error('An error occurred while retrieving the roles for the identity pool.');
        }
        return rolesResponse.Roles;
    };
    getUserPoolClient = async (userPoolId, userPoolClientId) => {
        const userPoolClientCommand = new DescribeUserPoolClientCommand({
            UserPoolId: userPoolId,
            ClientId: userPoolClientId,
        });
        const userPoolClientResponse = await this.cognitoIdentityProviderClient.send(userPoolClientCommand);
        if (!userPoolClientResponse.UserPoolClient) {
            throw new Error('An error occurred while retrieving the user pool client details.');
        }
        return userPoolClientResponse.UserPoolClient;
    };
    /**
     * Retrieves all of the resource data that is necessary for validation and output generation.
     * @param userPoolId userPoolId
     * @param identityPoolId identityPoolId
     * @param userPoolClientId userPoolClientId
     * @returns all necessary resource data
     */
    getResourceDetails = async (userPoolId, identityPoolId, userPoolClientId) => {
        const { userPool, userPoolPasswordPolicy } = await this.getUserPool(userPoolId);
        const userPoolMFA = await this.getUserPoolMFASettings(userPoolId);
        const userPoolProviders = await this.getUserPoolProviders(userPoolId);
        const userPoolGroups = await this.getUserPoolGroups(userPoolId);
        const userPoolClient = await this.getUserPoolClient(userPoolId, userPoolClientId);
        const identityPool = await this.getIdentityPool(identityPoolId);
        const roles = await this.getIdentityPoolRoles(identityPoolId);
        return {
            userPool,
            userPoolPasswordPolicy,
            userPoolMFA,
            userPoolProviders,
            userPoolGroups,
            userPoolClient,
            identityPool,
            roles,
        };
    };
    /**
     * Validate the resource associations.
     * 1. make sure the user pool & user pool client pair are a cognito provider for the identity pool
     * 2. make sure the provided auth/unauth role ARNs match the roles for the identity pool
     * 3. make sure the user pool client is a web client
     * @param userPool userPool
     * @param userPoolProviders the user pool providers
     * @param userPoolGroups the existing groups for the userPool
     * @param userPoolClient userPoolClient
     * @param identityPool identityPool
     * @param identityPoolRoles identityPool roles
     * @param props props that include the roles which we compare with the actual roles for the identity pool
     */
    validateResources = (userPool, userPoolProviders, userPoolGroups, userPoolClient, identityPool, identityPoolRoles, props) => {
        // verify the user pool is a cognito provider for this identity pool
        if (!identityPool.CognitoIdentityProviders ||
            identityPool.CognitoIdentityProviders.length === 0) {
            throw new Error('The specified identity pool does not have any cognito identity providers.');
        }
        // check for alias attributes, since we don't support this yet
        if (userPool.AliasAttributes && userPool.AliasAttributes.length > 0) {
            throw new Error('The specified user pool is configured with alias attributes which are not currently supported.');
        }
        // check OAuth settings
        if (userPoolProviders.length > 0) {
            // validate user pool
            const domainSpecified = userPool.Domain || userPool.CustomDomain;
            if (!domainSpecified) {
                throw new Error('You must configure a domain for your UserPool if external login providers are enabled.');
            }
            // validate user pool client
            const hasLogoutUrls = userPoolClient.LogoutURLs && userPoolClient.LogoutURLs.length > 0;
            const hasCallbackUrls = userPoolClient.CallbackURLs && userPoolClient.CallbackURLs.length > 0;
            if (!hasLogoutUrls) {
                throw new Error('Your UserPool client must have "Allowed sign-out URLs" configured if external login providers are enabled.');
            }
            if (!hasCallbackUrls) {
                throw new Error('Your UserPool client must have "Allowed callback URLs" configured if external login providers are enabled.');
            }
        }
        // make sure props groups Roles actually exist for the user pool
        const groupEntries = Object.entries(props.groups);
        for (const [groupName, groupRoleARN] of groupEntries) {
            const match = userPoolGroups.find((g) => g.RoleArn === groupRoleARN);
            if (match === undefined) {
                throw new Error(`The group '${groupName}' with role '${groupRoleARN}' does not match any group for the specified user pool.`);
            }
        }
        // verify that the user pool + user pool client pair are configured with the identity pool
        const matchingProvider = identityPool.CognitoIdentityProviders.find((p) => {
            const matchingUserPool = p.ProviderName ===
                `cognito-idp.${props.region}.amazonaws.com/${userPool.Id}`;
            const matchingUserPoolClient = p.ClientId === userPoolClient.ClientId;
            return matchingUserPool && matchingUserPoolClient;
        });
        if (!matchingProvider) {
            throw new Error('The user pool and user pool client pair do not match any cognito identity providers for the specified identity pool.');
        }
        // verify the auth / unauth roles from the props match the identity pool roles that we retrieved
        const authRoleArn = identityPoolRoles['authenticated'];
        const unauthRoleArn = identityPoolRoles['unauthenticated'];
        if (authRoleArn !== props.authRoleArn) {
            throw new Error('The provided authRoleArn does not match the authenticated role for the specified identity pool.');
        }
        if (unauthRoleArn !== props.unauthRoleArn) {
            throw new Error('The provided unauthRoleArn does not match the unauthenticated role for the specified identity pool.');
        }
        // make sure the client is a web client here (web clients shouldn't have client secrets)
        if (userPoolClient?.ClientSecret) {
            throw new Error('The specified user pool client is not configured as a web client.');
        }
    };
    /**
     * Transform the userPool data into outputs.
     * @param userPool user pool
     * @param userPoolPasswordPolicy user pool password policy
     * @param userPoolProviders user pool providers
     * @param userPoolMFA user pool MFA settings
     * @returns formatted outputs
     */
    getUserPoolOutputs = (userPool, userPoolPasswordPolicy, userPoolProviders, userPoolMFA, region) => {
        // password policy requirements
        const requirements = [];
        userPoolPasswordPolicy.RequireNumbers &&
            requirements.push('REQUIRES_NUMBERS');
        userPoolPasswordPolicy.RequireLowercase &&
            requirements.push('REQUIRES_LOWERCASE');
        userPoolPasswordPolicy.RequireUppercase &&
            requirements.push('REQUIRES_UPPERCASE');
        userPoolPasswordPolicy.RequireSymbols &&
            requirements.push('REQUIRES_SYMBOLS');
        // mfa types
        const mfaTypes = [];
        if (userPoolMFA.SmsMfaConfiguration &&
            userPoolMFA.SmsMfaConfiguration.SmsConfiguration) {
            mfaTypes.push('SMS_MFA');
        }
        if (userPoolMFA.SoftwareTokenMfaConfiguration?.Enabled) {
            mfaTypes.push('TOTP');
        }
        // social providers
        const socialProviders = [];
        if (userPoolProviders) {
            for (const provider of userPoolProviders) {
                const providerType = provider.ProviderType;
                const providerName = provider.ProviderName;
                if (providerType === 'Google') {
                    socialProviders.push('GOOGLE');
                }
                if (providerType === 'Facebook') {
                    socialProviders.push('FACEBOOK');
                }
                if (providerType === 'SignInWithApple') {
                    socialProviders.push('SIGN_IN_WITH_APPLE');
                }
                if (providerType === 'LoginWithAmazon') {
                    socialProviders.push('LOGIN_WITH_AMAZON');
                }
                if (providerType === 'OIDC' && providerName) {
                    socialProviders.push(providerName);
                }
                if (providerType === 'SAML' && providerName) {
                    socialProviders.push(providerName);
                }
            }
        }
        // domain
        const oauthDomain = userPool.CustomDomain ?? userPool.Domain ?? '';
        const fullDomainPath = `${oauthDomain}.auth.${region}.amazoncognito.com`;
        const data = {
            signupAttributes: JSON.stringify(userPool.SchemaAttributes?.filter((attribute) => attribute.Required && attribute.Name).map((attribute) => attribute.Name?.toLowerCase()) || []),
            usernameAttributes: JSON.stringify(userPool.UsernameAttributes?.map((attribute) => attribute.toLowerCase()) || []),
            verificationMechanisms: JSON.stringify(userPool.AutoVerifiedAttributes ?? []),
            passwordPolicyMinLength: userPoolPasswordPolicy.MinimumLength === undefined
                ? ''
                : userPoolPasswordPolicy.MinimumLength.toString(),
            passwordPolicyRequirements: JSON.stringify(requirements),
            mfaConfiguration: userPool.MfaConfiguration ?? 'OFF',
            mfaTypes: JSON.stringify(mfaTypes),
            socialProviders: JSON.stringify(socialProviders),
            oauthCognitoDomain: fullDomainPath,
        };
        return data;
    };
    /**
     * Transforms identityPool info into outputs.
     * @param identityPool identity pool data
     * @returns formatted outputs
     */
    getIdentityPoolOutputs = (identityPool) => {
        const data = {
            allowUnauthenticatedIdentities: identityPool.AllowUnauthenticatedIdentities === true ? 'true' : 'false',
        };
        return data;
    };
    /**
     * Transforms userPoolClient info into outputs.
     * @param userPoolClient userPoolClient data
     * @returns formatted outputs
     */
    getUserPoolClientOutputs = (userPoolClient) => {
        const data = {
            oauthScope: JSON.stringify(userPoolClient.AllowedOAuthScopes ?? []),
            oauthRedirectSignIn: userPoolClient.CallbackURLs
                ? userPoolClient.CallbackURLs.join(',')
                : '',
            oauthRedirectSignOut: userPoolClient.LogoutURLs
                ? userPoolClient.LogoutURLs.join(',')
                : '',
            oauthResponseType: userPoolClient.AllowedOAuthFlows
                ? userPoolClient.AllowedOAuthFlows.join(',')
                : '',
            oauthClientId: userPoolClient.ClientId,
        };
        return data;
    };
}
/**
 * Entry point for the lambda-backend custom resource to retrieve auth outputs.
 */
export const handler = async (event) => {
    const initializer = new ReferenceAuthInitializer(new CognitoIdentityClient(), new CognitoIdentityProviderClient(), randomUUID);
    return initializer.handleEvent(event);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVmZXJlbmNlX2F1dGhfaW5pdGlhbGl6ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbGFtYmRhL3JlZmVyZW5jZV9hdXRoX2luaXRpYWxpemVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUtBLE9BQU8sRUFDTCw2QkFBNkIsRUFDN0IsNkJBQTZCLEVBQzdCLHVCQUF1QixFQUN2QiwyQkFBMkIsRUFHM0IsaUJBQWlCLEVBQ2pCLDRCQUE0QixHQUs3QixNQUFNLDJDQUEyQyxDQUFDO0FBQ25ELE9BQU8sRUFDTCxxQkFBcUIsRUFDckIsMkJBQTJCLEVBRTNCLDJCQUEyQixHQUM1QixNQUFNLGtDQUFrQyxDQUFDO0FBQzFDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFZekM7O0dBRUc7QUFDSCxNQUFNLE9BQU8sd0JBQXdCO0lBT3pCO0lBQ0E7SUFDQTtJQVJWOzs7O09BSUc7SUFDSCxZQUNVLHFCQUE0QyxFQUM1Qyw2QkFBNEQsRUFDNUQsYUFBMkI7UUFGM0IsMEJBQXFCLEdBQXJCLHFCQUFxQixDQUF1QjtRQUM1QyxrQ0FBNkIsR0FBN0IsNkJBQTZCLENBQStCO1FBQzVELGtCQUFhLEdBQWIsYUFBYSxDQUFjO0lBQ2xDLENBQUM7SUFFSjs7OztPQUlHO0lBQ0ksV0FBVyxHQUFHLEtBQUssRUFBRSxLQUF3QyxFQUFFLEVBQUU7UUFDdEUsT0FBTyxDQUFDLElBQUksQ0FBQyxhQUFhLEtBQUssQ0FBQyxXQUFXLFNBQVMsQ0FBQyxDQUFDO1FBQ3RELDJFQUEyRTtRQUMzRSxNQUFNLFVBQVUsR0FDZCxLQUFLLENBQUMsV0FBVyxLQUFLLFFBQVE7WUFDNUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDdEIsQ0FBQyxDQUFDLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQztRQUUvQiwwRUFBMEU7UUFDMUUsSUFBSSxLQUFLLENBQUMsV0FBVyxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQ25DLE9BQU87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QyxpQkFBaUI7Z0JBQ2pELENBQUMsQ0FBQyxjQUFjLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQztnQkFDNUMsQ0FBQyxDQUFDLEVBQUU7WUFDTixhQUFhLEVBQUUsY0FBYyxDQUFDLFFBQVE7U0FDdkMsQ0FBQztRQUNGLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQyxDQUFDO0NBQ0g7QUFFRDs7R0FFRztBQUNILE1BQU0sQ0FBQyxNQUFNLE9BQU8sR0FBRyxLQUFLLEVBQzFCLEtBQXdDLEVBQ08sRUFBRTtJQUNqRCxNQUFNLFdBQVcsR0FBRyxJQUFJLHdCQUF3QixDQUM5QyxJQUFJLHFCQUFxQixFQUFFLEVBQzNCLElBQUksNkJBQTZCLEVBQUUsRUFDbkMsVUFBVSxDQUNYLENBQUM7SUFDRixPQUFPLFdBQVcsQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDeEMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZUV2ZW50LFxuICBDbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlUmVzcG9uc2UsXG4gIENsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VTdWNjZXNzUmVzcG9uc2UsXG59IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHtcbiAgQ29nbml0b0lkZW50aXR5UHJvdmlkZXJDbGllbnQsXG4gIERlc2NyaWJlVXNlclBvb2xDbGllbnRDb21tYW5kLFxuICBEZXNjcmliZVVzZXJQb29sQ29tbWFuZCxcbiAgR2V0VXNlclBvb2xNZmFDb25maWdDb21tYW5kLFxuICBHZXRVc2VyUG9vbE1mYUNvbmZpZ0NvbW1hbmRPdXRwdXQsXG4gIEdyb3VwVHlwZSxcbiAgTGlzdEdyb3Vwc0NvbW1hbmQsXG4gIExpc3RJZGVudGl0eVByb3ZpZGVyc0NvbW1hbmQsXG4gIFBhc3N3b3JkUG9saWN5VHlwZSxcbiAgUHJvdmlkZXJEZXNjcmlwdGlvbixcbiAgVXNlclBvb2xDbGllbnRUeXBlLFxuICBVc2VyUG9vbFR5cGUsXG59IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1jb2duaXRvLWlkZW50aXR5LXByb3ZpZGVyJztcbmltcG9ydCB7XG4gIENvZ25pdG9JZGVudGl0eUNsaWVudCxcbiAgRGVzY3JpYmVJZGVudGl0eVBvb2xDb21tYW5kLFxuICBEZXNjcmliZUlkZW50aXR5UG9vbENvbW1hbmRPdXRwdXQsXG4gIEdldElkZW50aXR5UG9vbFJvbGVzQ29tbWFuZCxcbn0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWNvZ25pdG8taWRlbnRpdHknO1xuaW1wb3J0IHsgcmFuZG9tVVVJRCB9IGZyb20gJ25vZGU6Y3J5cHRvJztcbmltcG9ydCB7IEF1dGhPdXRwdXQgfSBmcm9tICdAYXdzLWFtcGxpZnkvYmFja2VuZC1vdXRwdXQtc2NoZW1hcyc7XG5leHBvcnQgdHlwZSBSZWZlcmVuY2VBdXRoSW5pdGlhbGl6ZXJQcm9wcyA9IHtcbiAgdXNlclBvb2xJZDogc3RyaW5nO1xuICBpZGVudGl0eVBvb2xJZDogc3RyaW5nO1xuICBhdXRoUm9sZUFybjogc3RyaW5nO1xuICB1bmF1dGhSb2xlQXJuOiBzdHJpbmc7XG4gIHVzZXJQb29sQ2xpZW50SWQ6IHN0cmluZztcbiAgZ3JvdXBzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+O1xuICByZWdpb246IHN0cmluZztcbn07XG5cbi8qKlxuICogSW5pdGlhbGl6ZXIgdGhhdCBmZXRjaGVzIGFuZCBwcm9jZXNzIGF1dGggcmVzb3VyY2VzLlxuICovXG5leHBvcnQgY2xhc3MgUmVmZXJlbmNlQXV0aEluaXRpYWxpemVyIHtcbiAgLyoqXG4gICAqIENyZWF0ZSBhIG5ldyBpbml0aWFsaXplclxuICAgKiBAcGFyYW0gY29nbml0b0lkZW50aXR5Q2xpZW50IGlkZW50aXR5IGNsaWVudFxuICAgKiBAcGFyYW0gY29nbml0b0lkZW50aXR5UHJvdmlkZXJDbGllbnQgaWRlbnRpdHkgcHJvdmlkZXIgY2xpZW50XG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGNvZ25pdG9JZGVudGl0eUNsaWVudDogQ29nbml0b0lkZW50aXR5Q2xpZW50LFxuICAgIHByaXZhdGUgY29nbml0b0lkZW50aXR5UHJvdmlkZXJDbGllbnQ6IENvZ25pdG9JZGVudGl0eVByb3ZpZGVyQ2xpZW50LFxuICAgIHByaXZhdGUgdXVpZEdlbmVyYXRvcjogKCkgPT4gc3RyaW5nLFxuICApIHt9XG5cbiAgLyoqXG4gICAqIEhhbmRsZXMgY3VzdG9tIHJlc291cmNlIGV2ZW50c1xuICAgKiBAcGFyYW0gZXZlbnQgZXZlbnQgdG8gcHJvY2Vzc1xuICAgKiBAcmV0dXJucyBjdXN0b20gcmVzb3VyY2UgcmVzcG9uc2VcbiAgICovXG4gIHB1YmxpYyBoYW5kbGVFdmVudCA9IGFzeW5jIChldmVudDogQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZUV2ZW50KSA9PiB7XG4gICAgY29uc29sZS5pbmZvKGBSZWNlaXZlZCAnJHtldmVudC5SZXF1ZXN0VHlwZX0nIGV2ZW50YCk7XG4gICAgLy8gcGh5c2ljYWwgaWQgaXMgb25seSBnZW5lcmF0ZWQgb24gY3JlYXRlLCBvdGhlcndpc2UgaXQgbXVzdCBzdGF5IHRoZSBzYW1lXG4gICAgY29uc3QgcGh5c2ljYWxJZCA9XG4gICAgICBldmVudC5SZXF1ZXN0VHlwZSA9PT0gJ0NyZWF0ZSdcbiAgICAgICAgPyB0aGlzLnV1aWRHZW5lcmF0b3IoKVxuICAgICAgICA6IGV2ZW50LlBoeXNpY2FsUmVzb3VyY2VJZDtcblxuICAgIC8vIG9uIGRlbGV0ZSwganVzdCByZXNwb25kIHdpdGggc3VjY2VzcyBzaW5jZSB3ZSBkb24ndCBuZWVkIHRvIGRvIGFueXRoaW5nXG4gICAgaWYgKGV2ZW50LlJlcXVlc3RUeXBlID09PSAnRGVsZXRlJykge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgUmVxdWVzdElkOiBldmVudC5SZXF1ZXN0SWQsXG4gICAgICAgIExvZ2ljYWxSZXNvdXJjZUlkOiBldmVudC5Mb2dpY2FsUmVzb3VyY2VJZCxcbiAgICAgICAgUGh5c2ljYWxSZXNvdXJjZUlkOiBwaHlzaWNhbElkLFxuICAgICAgICBTdGFja0lkOiBldmVudC5TdGFja0lkLFxuICAgICAgICBOb0VjaG86IHRydWUsXG4gICAgICAgIFN0YXR1czogJ1NVQ0NFU1MnLFxuICAgICAgfSBhcyBDbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlU3VjY2Vzc1Jlc3BvbnNlO1xuICAgIH1cbiAgICAvLyBmb3IgY3JlYXRlIG9yIHVwZGF0ZSBldmVudHMsIHdlIHdpbGwgZmV0Y2ggYW5kIHZhbGlkYXRlIHJlc291cmNlIHByb3BlcnRpZXNcbiAgICBjb25zdCBwcm9wcyA9XG4gICAgICBldmVudC5SZXNvdXJjZVByb3BlcnRpZXMgYXMgdW5rbm93biBhcyBSZWZlcmVuY2VBdXRoSW5pdGlhbGl6ZXJQcm9wcztcbiAgICBjb25zdCB7XG4gICAgICB1c2VyUG9vbCxcbiAgICAgIHVzZXJQb29sUGFzc3dvcmRQb2xpY3ksXG4gICAgICB1c2VyUG9vbE1GQSxcbiAgICAgIHVzZXJQb29sR3JvdXBzLFxuICAgICAgdXNlclBvb2xQcm92aWRlcnMsXG4gICAgICB1c2VyUG9vbENsaWVudCxcbiAgICAgIGlkZW50aXR5UG9vbCxcbiAgICAgIHJvbGVzLFxuICAgIH0gPSBhd2FpdCB0aGlzLmdldFJlc291cmNlRGV0YWlscyhcbiAgICAgIHByb3BzLnVzZXJQb29sSWQsXG4gICAgICBwcm9wcy5pZGVudGl0eVBvb2xJZCxcbiAgICAgIHByb3BzLnVzZXJQb29sQ2xpZW50SWQsXG4gICAgKTtcblxuICAgIHRoaXMudmFsaWRhdGVSZXNvdXJjZXMoXG4gICAgICB1c2VyUG9vbCxcbiAgICAgIHVzZXJQb29sUHJvdmlkZXJzLFxuICAgICAgdXNlclBvb2xHcm91cHMsXG4gICAgICB1c2VyUG9vbENsaWVudCxcbiAgICAgIGlkZW50aXR5UG9vbCxcbiAgICAgIHJvbGVzLFxuICAgICAgcHJvcHMsXG4gICAgKTtcblxuICAgIGNvbnN0IHVzZXJQb29sT3V0cHV0cyA9IGF3YWl0IHRoaXMuZ2V0VXNlclBvb2xPdXRwdXRzKFxuICAgICAgdXNlclBvb2wsXG4gICAgICB1c2VyUG9vbFBhc3N3b3JkUG9saWN5LFxuICAgICAgdXNlclBvb2xQcm92aWRlcnMsXG4gICAgICB1c2VyUG9vbE1GQSxcbiAgICAgIHByb3BzLnJlZ2lvbixcbiAgICApO1xuICAgIGNvbnN0IGlkZW50aXR5UG9vbE91dHB1dHMgPSBhd2FpdCB0aGlzLmdldElkZW50aXR5UG9vbE91dHB1dHMoaWRlbnRpdHlQb29sKTtcbiAgICBjb25zdCB1c2VyUG9vbENsaWVudE91dHB1dHMgPVxuICAgICAgYXdhaXQgdGhpcy5nZXRVc2VyUG9vbENsaWVudE91dHB1dHModXNlclBvb2xDbGllbnQpO1xuICAgIGNvbnN0IGRhdGE6IE9taXQ8QXV0aE91dHB1dFsncGF5bG9hZCddLCAnYXV0aFJlZ2lvbic+ID0ge1xuICAgICAgdXNlclBvb2xJZDogcHJvcHMudXNlclBvb2xJZCxcbiAgICAgIHdlYkNsaWVudElkOiBwcm9wcy51c2VyUG9vbENsaWVudElkLFxuICAgICAgaWRlbnRpdHlQb29sSWQ6IHByb3BzLmlkZW50aXR5UG9vbElkLFxuICAgICAgLi4udXNlclBvb2xPdXRwdXRzLFxuICAgICAgLi4uaWRlbnRpdHlQb29sT3V0cHV0cyxcbiAgICAgIC4uLnVzZXJQb29sQ2xpZW50T3V0cHV0cyxcbiAgICB9O1xuICAgIHJldHVybiB7XG4gICAgICBSZXF1ZXN0SWQ6IGV2ZW50LlJlcXVlc3RJZCxcbiAgICAgIExvZ2ljYWxSZXNvdXJjZUlkOiBldmVudC5Mb2dpY2FsUmVzb3VyY2VJZCxcbiAgICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogcGh5c2ljYWxJZCxcbiAgICAgIFN0YWNrSWQ6IGV2ZW50LlN0YWNrSWQsXG4gICAgICBOb0VjaG86IHRydWUsXG4gICAgICBEYXRhOiBkYXRhLFxuICAgICAgU3RhdHVzOiAnU1VDQ0VTUycsXG4gICAgfSBhcyBDbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlU3VjY2Vzc1Jlc3BvbnNlO1xuICB9O1xuXG4gIHByaXZhdGUgZ2V0VXNlclBvb2wgPSBhc3luYyAodXNlclBvb2xJZDogc3RyaW5nKSA9PiB7XG4gICAgY29uc3QgdXNlclBvb2xDb21tYW5kID0gbmV3IERlc2NyaWJlVXNlclBvb2xDb21tYW5kKHtcbiAgICAgIFVzZXJQb29sSWQ6IHVzZXJQb29sSWQsXG4gICAgfSk7XG4gICAgY29uc3QgdXNlclBvb2xSZXNwb25zZSA9XG4gICAgICBhd2FpdCB0aGlzLmNvZ25pdG9JZGVudGl0eVByb3ZpZGVyQ2xpZW50LnNlbmQodXNlclBvb2xDb21tYW5kKTtcbiAgICBpZiAoIXVzZXJQb29sUmVzcG9uc2UuVXNlclBvb2wpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHJldHJpZXZlIHRoZSBzcGVjaWZpZWQgVXNlclBvb2wuJyk7XG4gICAgfVxuICAgIGNvbnN0IHVzZXJQb29sID0gdXNlclBvb2xSZXNwb25zZS5Vc2VyUG9vbDtcbiAgICBjb25zdCBwb2xpY3kgPSB1c2VyUG9vbC5Qb2xpY2llcz8uUGFzc3dvcmRQb2xpY3k7XG4gICAgaWYgKCFwb2xpY3kpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHJldHJpZXZlIHBhc3N3b3JkIHBvbGljeS4nKTtcbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgIHVzZXJQb29sOiB1c2VyUG9vbFJlc3BvbnNlLlVzZXJQb29sLFxuICAgICAgdXNlclBvb2xQYXNzd29yZFBvbGljeTogcG9saWN5LFxuICAgIH07XG4gIH07XG5cbiAgcHJpdmF0ZSBnZXRVc2VyUG9vbE1GQVNldHRpbmdzID0gYXN5bmMgKHVzZXJQb29sSWQ6IHN0cmluZykgPT4ge1xuICAgIC8vIG1mYSB0eXBlc1xuICAgIGNvbnN0IG1mYUNvbW1hbmQgPSBuZXcgR2V0VXNlclBvb2xNZmFDb25maWdDb21tYW5kKHtcbiAgICAgIFVzZXJQb29sSWQ6IHVzZXJQb29sSWQsXG4gICAgfSk7XG4gICAgY29uc3QgbWZhUmVzcG9uc2UgPVxuICAgICAgYXdhaXQgdGhpcy5jb2duaXRvSWRlbnRpdHlQcm92aWRlckNsaWVudC5zZW5kKG1mYUNvbW1hbmQpO1xuICAgIHJldHVybiBtZmFSZXNwb25zZTtcbiAgfTtcblxuICBwcml2YXRlIGdldFVzZXJQb29sR3JvdXBzID0gYXN5bmMgKHVzZXJQb29sSWQ6IHN0cmluZykgPT4ge1xuICAgIGxldCBuZXh0VG9rZW46IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBjb25zdCBncm91cHM6IEdyb3VwVHlwZVtdID0gW107XG4gICAgZG8ge1xuICAgICAgY29uc3QgbGlzdEdyb3Vwc1Jlc3BvbnNlID0gYXdhaXQgdGhpcy5jb2duaXRvSWRlbnRpdHlQcm92aWRlckNsaWVudC5zZW5kKFxuICAgICAgICBuZXcgTGlzdEdyb3Vwc0NvbW1hbmQoe1xuICAgICAgICAgIFVzZXJQb29sSWQ6IHVzZXJQb29sSWQsXG4gICAgICAgICAgTmV4dFRva2VuOiBuZXh0VG9rZW4sXG4gICAgICAgIH0pLFxuICAgICAgKTtcbiAgICAgIGlmICghbGlzdEdyb3Vwc1Jlc3BvbnNlLkdyb3Vwcykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgJ0FuIGVycm9yIG9jY3VycmVkIHdoaWxlIHJldHJpZXZpbmcgdGhlIGdyb3VwcyBmb3IgdGhlIHVzZXIgcG9vbC4nLFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgZ3JvdXBzLnB1c2goLi4ubGlzdEdyb3Vwc1Jlc3BvbnNlLkdyb3Vwcyk7XG4gICAgICBuZXh0VG9rZW4gPSBsaXN0R3JvdXBzUmVzcG9uc2UuTmV4dFRva2VuO1xuICAgIH0gd2hpbGUgKG5leHRUb2tlbik7XG4gICAgcmV0dXJuIGdyb3VwcztcbiAgfTtcblxuICBwcml2YXRlIGdldFVzZXJQb29sUHJvdmlkZXJzID0gYXN5bmMgKHVzZXJQb29sSWQ6IHN0cmluZykgPT4ge1xuICAgIGNvbnN0IHByb3ZpZGVyczogUHJvdmlkZXJEZXNjcmlwdGlvbltdID0gW107XG4gICAgbGV0IG5leHRUb2tlbjogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgIGRvIHtcbiAgICAgIGNvbnN0IHByb3ZpZGVyc1Jlc3BvbnNlID0gYXdhaXQgdGhpcy5jb2duaXRvSWRlbnRpdHlQcm92aWRlckNsaWVudC5zZW5kKFxuICAgICAgICBuZXcgTGlzdElkZW50aXR5UHJvdmlkZXJzQ29tbWFuZCh7XG4gICAgICAgICAgVXNlclBvb2xJZDogdXNlclBvb2xJZCxcbiAgICAgICAgICBOZXh0VG9rZW46IG5leHRUb2tlbixcbiAgICAgICAgfSksXG4gICAgICApO1xuICAgICAgaWYgKHByb3ZpZGVyc1Jlc3BvbnNlLlByb3ZpZGVycyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAnQW4gZXJyb3Igb2NjdXJyZWQgd2hpbGUgcmV0cmlldmluZyBpZGVudGl0eSBwcm92aWRlcnMgZm9yIHRoZSB1c2VyIHBvb2wuJyxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHByb3ZpZGVycy5wdXNoKC4uLnByb3ZpZGVyc1Jlc3BvbnNlLlByb3ZpZGVycyk7XG4gICAgICBuZXh0VG9rZW4gPSBwcm92aWRlcnNSZXNwb25zZS5OZXh0VG9rZW47XG4gICAgfSB3aGlsZSAobmV4dFRva2VuKTtcbiAgICByZXR1cm4gcHJvdmlkZXJzO1xuICB9O1xuXG4gIHByaXZhdGUgZ2V0SWRlbnRpdHlQb29sID0gYXN5bmMgKGlkZW50aXR5UG9vbElkOiBzdHJpbmcpID0+IHtcbiAgICBjb25zdCBpZHBSZXNwb25zZSA9IGF3YWl0IHRoaXMuY29nbml0b0lkZW50aXR5Q2xpZW50LnNlbmQoXG4gICAgICBuZXcgRGVzY3JpYmVJZGVudGl0eVBvb2xDb21tYW5kKHtcbiAgICAgICAgSWRlbnRpdHlQb29sSWQ6IGlkZW50aXR5UG9vbElkLFxuICAgICAgfSksXG4gICAgKTtcbiAgICBpZiAoIWlkcFJlc3BvbnNlLklkZW50aXR5UG9vbElkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdBbiBlcnJvciBvY2N1cnJlZCB3aGlsZSByZXRyaWV2aW5nIHRoZSBpZGVudGl0eSBwb29sIGRldGFpbHMuJyxcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBpZHBSZXNwb25zZTtcbiAgfTtcblxuICBwcml2YXRlIGdldElkZW50aXR5UG9vbFJvbGVzID0gYXN5bmMgKGlkZW50aXR5UG9vbElkOiBzdHJpbmcpID0+IHtcbiAgICBjb25zdCByb2xlc0NvbW1hbmQgPSBuZXcgR2V0SWRlbnRpdHlQb29sUm9sZXNDb21tYW5kKHtcbiAgICAgIElkZW50aXR5UG9vbElkOiBpZGVudGl0eVBvb2xJZCxcbiAgICB9KTtcbiAgICBjb25zdCByb2xlc1Jlc3BvbnNlID0gYXdhaXQgdGhpcy5jb2duaXRvSWRlbnRpdHlDbGllbnQuc2VuZChyb2xlc0NvbW1hbmQpO1xuICAgIGlmICghcm9sZXNSZXNwb25zZS5Sb2xlcykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAnQW4gZXJyb3Igb2NjdXJyZWQgd2hpbGUgcmV0cmlldmluZyB0aGUgcm9sZXMgZm9yIHRoZSBpZGVudGl0eSBwb29sLicsXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gcm9sZXNSZXNwb25zZS5Sb2xlcztcbiAgfTtcblxuICBwcml2YXRlIGdldFVzZXJQb29sQ2xpZW50ID0gYXN5bmMgKFxuICAgIHVzZXJQb29sSWQ6IHN0cmluZyxcbiAgICB1c2VyUG9vbENsaWVudElkOiBzdHJpbmcsXG4gICkgPT4ge1xuICAgIGNvbnN0IHVzZXJQb29sQ2xpZW50Q29tbWFuZCA9IG5ldyBEZXNjcmliZVVzZXJQb29sQ2xpZW50Q29tbWFuZCh7XG4gICAgICBVc2VyUG9vbElkOiB1c2VyUG9vbElkLFxuICAgICAgQ2xpZW50SWQ6IHVzZXJQb29sQ2xpZW50SWQsXG4gICAgfSk7XG4gICAgY29uc3QgdXNlclBvb2xDbGllbnRSZXNwb25zZSA9XG4gICAgICBhd2FpdCB0aGlzLmNvZ25pdG9JZGVudGl0eVByb3ZpZGVyQ2xpZW50LnNlbmQodXNlclBvb2xDbGllbnRDb21tYW5kKTtcbiAgICBpZiAoIXVzZXJQb29sQ2xpZW50UmVzcG9uc2UuVXNlclBvb2xDbGllbnQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ0FuIGVycm9yIG9jY3VycmVkIHdoaWxlIHJldHJpZXZpbmcgdGhlIHVzZXIgcG9vbCBjbGllbnQgZGV0YWlscy4nLFxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIHVzZXJQb29sQ2xpZW50UmVzcG9uc2UuVXNlclBvb2xDbGllbnQ7XG4gIH07XG5cbiAgLyoqXG4gICAqIFJldHJpZXZlcyBhbGwgb2YgdGhlIHJlc291cmNlIGRhdGEgdGhhdCBpcyBuZWNlc3NhcnkgZm9yIHZhbGlkYXRpb24gYW5kIG91dHB1dCBnZW5lcmF0aW9uLlxuICAgKiBAcGFyYW0gdXNlclBvb2xJZCB1c2VyUG9vbElkXG4gICAqIEBwYXJhbSBpZGVudGl0eVBvb2xJZCBpZGVudGl0eVBvb2xJZFxuICAgKiBAcGFyYW0gdXNlclBvb2xDbGllbnRJZCB1c2VyUG9vbENsaWVudElkXG4gICAqIEByZXR1cm5zIGFsbCBuZWNlc3NhcnkgcmVzb3VyY2UgZGF0YVxuICAgKi9cbiAgcHJpdmF0ZSBnZXRSZXNvdXJjZURldGFpbHMgPSBhc3luYyAoXG4gICAgdXNlclBvb2xJZDogc3RyaW5nLFxuICAgIGlkZW50aXR5UG9vbElkOiBzdHJpbmcsXG4gICAgdXNlclBvb2xDbGllbnRJZDogc3RyaW5nLFxuICApID0+IHtcbiAgICBjb25zdCB7IHVzZXJQb29sLCB1c2VyUG9vbFBhc3N3b3JkUG9saWN5IH0gPVxuICAgICAgYXdhaXQgdGhpcy5nZXRVc2VyUG9vbCh1c2VyUG9vbElkKTtcbiAgICBjb25zdCB1c2VyUG9vbE1GQSA9IGF3YWl0IHRoaXMuZ2V0VXNlclBvb2xNRkFTZXR0aW5ncyh1c2VyUG9vbElkKTtcbiAgICBjb25zdCB1c2VyUG9vbFByb3ZpZGVycyA9IGF3YWl0IHRoaXMuZ2V0VXNlclBvb2xQcm92aWRlcnModXNlclBvb2xJZCk7XG4gICAgY29uc3QgdXNlclBvb2xHcm91cHMgPSBhd2FpdCB0aGlzLmdldFVzZXJQb29sR3JvdXBzKHVzZXJQb29sSWQpO1xuICAgIGNvbnN0IHVzZXJQb29sQ2xpZW50ID0gYXdhaXQgdGhpcy5nZXRVc2VyUG9vbENsaWVudChcbiAgICAgIHVzZXJQb29sSWQsXG4gICAgICB1c2VyUG9vbENsaWVudElkLFxuICAgICk7XG4gICAgY29uc3QgaWRlbnRpdHlQb29sID0gYXdhaXQgdGhpcy5nZXRJZGVudGl0eVBvb2woaWRlbnRpdHlQb29sSWQpO1xuICAgIGNvbnN0IHJvbGVzID0gYXdhaXQgdGhpcy5nZXRJZGVudGl0eVBvb2xSb2xlcyhpZGVudGl0eVBvb2xJZCk7XG4gICAgcmV0dXJuIHtcbiAgICAgIHVzZXJQb29sLFxuICAgICAgdXNlclBvb2xQYXNzd29yZFBvbGljeSxcbiAgICAgIHVzZXJQb29sTUZBLFxuICAgICAgdXNlclBvb2xQcm92aWRlcnMsXG4gICAgICB1c2VyUG9vbEdyb3VwcyxcbiAgICAgIHVzZXJQb29sQ2xpZW50LFxuICAgICAgaWRlbnRpdHlQb29sLFxuICAgICAgcm9sZXMsXG4gICAgfTtcbiAgfTtcblxuICAvKipcbiAgICogVmFsaWRhdGUgdGhlIHJlc291cmNlIGFzc29jaWF0aW9ucy5cbiAgICogMS4gbWFrZSBzdXJlIHRoZSB1c2VyIHBvb2wgJiB1c2VyIHBvb2wgY2xpZW50IHBhaXIgYXJlIGEgY29nbml0byBwcm92aWRlciBmb3IgdGhlIGlkZW50aXR5IHBvb2xcbiAgICogMi4gbWFrZSBzdXJlIHRoZSBwcm92aWRlZCBhdXRoL3VuYXV0aCByb2xlIEFSTnMgbWF0Y2ggdGhlIHJvbGVzIGZvciB0aGUgaWRlbnRpdHkgcG9vbFxuICAgKiAzLiBtYWtlIHN1cmUgdGhlIHVzZXIgcG9vbCBjbGllbnQgaXMgYSB3ZWIgY2xpZW50XG4gICAqIEBwYXJhbSB1c2VyUG9vbCB1c2VyUG9vbFxuICAgKiBAcGFyYW0gdXNlclBvb2xQcm92aWRlcnMgdGhlIHVzZXIgcG9vbCBwcm92aWRlcnNcbiAgICogQHBhcmFtIHVzZXJQb29sR3JvdXBzIHRoZSBleGlzdGluZyBncm91cHMgZm9yIHRoZSB1c2VyUG9vbFxuICAgKiBAcGFyYW0gdXNlclBvb2xDbGllbnQgdXNlclBvb2xDbGllbnRcbiAgICogQHBhcmFtIGlkZW50aXR5UG9vbCBpZGVudGl0eVBvb2xcbiAgICogQHBhcmFtIGlkZW50aXR5UG9vbFJvbGVzIGlkZW50aXR5UG9vbCByb2xlc1xuICAgKiBAcGFyYW0gcHJvcHMgcHJvcHMgdGhhdCBpbmNsdWRlIHRoZSByb2xlcyB3aGljaCB3ZSBjb21wYXJlIHdpdGggdGhlIGFjdHVhbCByb2xlcyBmb3IgdGhlIGlkZW50aXR5IHBvb2xcbiAgICovXG4gIHByaXZhdGUgdmFsaWRhdGVSZXNvdXJjZXMgPSAoXG4gICAgdXNlclBvb2w6IFVzZXJQb29sVHlwZSxcbiAgICB1c2VyUG9vbFByb3ZpZGVyczogUHJvdmlkZXJEZXNjcmlwdGlvbltdLFxuICAgIHVzZXJQb29sR3JvdXBzOiBHcm91cFR5cGVbXSxcbiAgICB1c2VyUG9vbENsaWVudDogVXNlclBvb2xDbGllbnRUeXBlLFxuICAgIGlkZW50aXR5UG9vbDogRGVzY3JpYmVJZGVudGl0eVBvb2xDb21tYW5kT3V0cHV0LFxuICAgIGlkZW50aXR5UG9vbFJvbGVzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+LFxuICAgIHByb3BzOiBSZWZlcmVuY2VBdXRoSW5pdGlhbGl6ZXJQcm9wcyxcbiAgKSA9PiB7XG4gICAgLy8gdmVyaWZ5IHRoZSB1c2VyIHBvb2wgaXMgYSBjb2duaXRvIHByb3ZpZGVyIGZvciB0aGlzIGlkZW50aXR5IHBvb2xcbiAgICBpZiAoXG4gICAgICAhaWRlbnRpdHlQb29sLkNvZ25pdG9JZGVudGl0eVByb3ZpZGVycyB8fFxuICAgICAgaWRlbnRpdHlQb29sLkNvZ25pdG9JZGVudGl0eVByb3ZpZGVycy5sZW5ndGggPT09IDBcbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ1RoZSBzcGVjaWZpZWQgaWRlbnRpdHkgcG9vbCBkb2VzIG5vdCBoYXZlIGFueSBjb2duaXRvIGlkZW50aXR5IHByb3ZpZGVycy4nLFxuICAgICAgKTtcbiAgICB9XG4gICAgLy8gY2hlY2sgZm9yIGFsaWFzIGF0dHJpYnV0ZXMsIHNpbmNlIHdlIGRvbid0IHN1cHBvcnQgdGhpcyB5ZXRcbiAgICBpZiAodXNlclBvb2wuQWxpYXNBdHRyaWJ1dGVzICYmIHVzZXJQb29sLkFsaWFzQXR0cmlidXRlcy5sZW5ndGggPiAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdUaGUgc3BlY2lmaWVkIHVzZXIgcG9vbCBpcyBjb25maWd1cmVkIHdpdGggYWxpYXMgYXR0cmlidXRlcyB3aGljaCBhcmUgbm90IGN1cnJlbnRseSBzdXBwb3J0ZWQuJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gY2hlY2sgT0F1dGggc2V0dGluZ3NcbiAgICBpZiAodXNlclBvb2xQcm92aWRlcnMubGVuZ3RoID4gMCkge1xuICAgICAgLy8gdmFsaWRhdGUgdXNlciBwb29sXG4gICAgICBjb25zdCBkb21haW5TcGVjaWZpZWQgPSB1c2VyUG9vbC5Eb21haW4gfHwgdXNlclBvb2wuQ3VzdG9tRG9tYWluO1xuICAgICAgaWYgKCFkb21haW5TcGVjaWZpZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICdZb3UgbXVzdCBjb25maWd1cmUgYSBkb21haW4gZm9yIHlvdXIgVXNlclBvb2wgaWYgZXh0ZXJuYWwgbG9naW4gcHJvdmlkZXJzIGFyZSBlbmFibGVkLicsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIC8vIHZhbGlkYXRlIHVzZXIgcG9vbCBjbGllbnRcbiAgICAgIGNvbnN0IGhhc0xvZ291dFVybHMgPVxuICAgICAgICB1c2VyUG9vbENsaWVudC5Mb2dvdXRVUkxzICYmIHVzZXJQb29sQ2xpZW50LkxvZ291dFVSTHMubGVuZ3RoID4gMDtcbiAgICAgIGNvbnN0IGhhc0NhbGxiYWNrVXJscyA9XG4gICAgICAgIHVzZXJQb29sQ2xpZW50LkNhbGxiYWNrVVJMcyAmJiB1c2VyUG9vbENsaWVudC5DYWxsYmFja1VSTHMubGVuZ3RoID4gMDtcbiAgICAgIGlmICghaGFzTG9nb3V0VXJscykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgJ1lvdXIgVXNlclBvb2wgY2xpZW50IG11c3QgaGF2ZSBcIkFsbG93ZWQgc2lnbi1vdXQgVVJMc1wiIGNvbmZpZ3VyZWQgaWYgZXh0ZXJuYWwgbG9naW4gcHJvdmlkZXJzIGFyZSBlbmFibGVkLicsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoIWhhc0NhbGxiYWNrVXJscykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgJ1lvdXIgVXNlclBvb2wgY2xpZW50IG11c3QgaGF2ZSBcIkFsbG93ZWQgY2FsbGJhY2sgVVJMc1wiIGNvbmZpZ3VyZWQgaWYgZXh0ZXJuYWwgbG9naW4gcHJvdmlkZXJzIGFyZSBlbmFibGVkLicsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gbWFrZSBzdXJlIHByb3BzIGdyb3VwcyBSb2xlcyBhY3R1YWxseSBleGlzdCBmb3IgdGhlIHVzZXIgcG9vbFxuICAgIGNvbnN0IGdyb3VwRW50cmllcyA9IE9iamVjdC5lbnRyaWVzKHByb3BzLmdyb3Vwcyk7XG4gICAgZm9yIChjb25zdCBbZ3JvdXBOYW1lLCBncm91cFJvbGVBUk5dIG9mIGdyb3VwRW50cmllcykge1xuICAgICAgY29uc3QgbWF0Y2ggPSB1c2VyUG9vbEdyb3Vwcy5maW5kKChnKSA9PiBnLlJvbGVBcm4gPT09IGdyb3VwUm9sZUFSTik7XG4gICAgICBpZiAobWF0Y2ggPT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYFRoZSBncm91cCAnJHtncm91cE5hbWV9JyB3aXRoIHJvbGUgJyR7Z3JvdXBSb2xlQVJOfScgZG9lcyBub3QgbWF0Y2ggYW55IGdyb3VwIGZvciB0aGUgc3BlY2lmaWVkIHVzZXIgcG9vbC5gLFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgICAvLyB2ZXJpZnkgdGhhdCB0aGUgdXNlciBwb29sICsgdXNlciBwb29sIGNsaWVudCBwYWlyIGFyZSBjb25maWd1cmVkIHdpdGggdGhlIGlkZW50aXR5IHBvb2xcbiAgICBjb25zdCBtYXRjaGluZ1Byb3ZpZGVyID0gaWRlbnRpdHlQb29sLkNvZ25pdG9JZGVudGl0eVByb3ZpZGVycy5maW5kKChwKSA9PiB7XG4gICAgICBjb25zdCBtYXRjaGluZ1VzZXJQb29sOiBib29sZWFuID1cbiAgICAgICAgcC5Qcm92aWRlck5hbWUgPT09XG4gICAgICAgIGBjb2duaXRvLWlkcC4ke3Byb3BzLnJlZ2lvbn0uYW1hem9uYXdzLmNvbS8ke3VzZXJQb29sLklkfWA7XG4gICAgICBjb25zdCBtYXRjaGluZ1VzZXJQb29sQ2xpZW50OiBib29sZWFuID1cbiAgICAgICAgcC5DbGllbnRJZCA9PT0gdXNlclBvb2xDbGllbnQuQ2xpZW50SWQ7XG4gICAgICByZXR1cm4gbWF0Y2hpbmdVc2VyUG9vbCAmJiBtYXRjaGluZ1VzZXJQb29sQ2xpZW50O1xuICAgIH0pO1xuICAgIGlmICghbWF0Y2hpbmdQcm92aWRlcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAnVGhlIHVzZXIgcG9vbCBhbmQgdXNlciBwb29sIGNsaWVudCBwYWlyIGRvIG5vdCBtYXRjaCBhbnkgY29nbml0byBpZGVudGl0eSBwcm92aWRlcnMgZm9yIHRoZSBzcGVjaWZpZWQgaWRlbnRpdHkgcG9vbC4nLFxuICAgICAgKTtcbiAgICB9XG4gICAgLy8gdmVyaWZ5IHRoZSBhdXRoIC8gdW5hdXRoIHJvbGVzIGZyb20gdGhlIHByb3BzIG1hdGNoIHRoZSBpZGVudGl0eSBwb29sIHJvbGVzIHRoYXQgd2UgcmV0cmlldmVkXG4gICAgY29uc3QgYXV0aFJvbGVBcm4gPSBpZGVudGl0eVBvb2xSb2xlc1snYXV0aGVudGljYXRlZCddO1xuICAgIGNvbnN0IHVuYXV0aFJvbGVBcm4gPSBpZGVudGl0eVBvb2xSb2xlc1sndW5hdXRoZW50aWNhdGVkJ107XG4gICAgaWYgKGF1dGhSb2xlQXJuICE9PSBwcm9wcy5hdXRoUm9sZUFybikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAnVGhlIHByb3ZpZGVkIGF1dGhSb2xlQXJuIGRvZXMgbm90IG1hdGNoIHRoZSBhdXRoZW50aWNhdGVkIHJvbGUgZm9yIHRoZSBzcGVjaWZpZWQgaWRlbnRpdHkgcG9vbC4nLFxuICAgICAgKTtcbiAgICB9XG4gICAgaWYgKHVuYXV0aFJvbGVBcm4gIT09IHByb3BzLnVuYXV0aFJvbGVBcm4pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ1RoZSBwcm92aWRlZCB1bmF1dGhSb2xlQXJuIGRvZXMgbm90IG1hdGNoIHRoZSB1bmF1dGhlbnRpY2F0ZWQgcm9sZSBmb3IgdGhlIHNwZWNpZmllZCBpZGVudGl0eSBwb29sLicsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIG1ha2Ugc3VyZSB0aGUgY2xpZW50IGlzIGEgd2ViIGNsaWVudCBoZXJlICh3ZWIgY2xpZW50cyBzaG91bGRuJ3QgaGF2ZSBjbGllbnQgc2VjcmV0cylcbiAgICBpZiAodXNlclBvb2xDbGllbnQ/LkNsaWVudFNlY3JldCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAnVGhlIHNwZWNpZmllZCB1c2VyIHBvb2wgY2xpZW50IGlzIG5vdCBjb25maWd1cmVkIGFzIGEgd2ViIGNsaWVudC4nLFxuICAgICAgKTtcbiAgICB9XG4gIH07XG5cbiAgLyoqXG4gICAqIFRyYW5zZm9ybSB0aGUgdXNlclBvb2wgZGF0YSBpbnRvIG91dHB1dHMuXG4gICAqIEBwYXJhbSB1c2VyUG9vbCB1c2VyIHBvb2xcbiAgICogQHBhcmFtIHVzZXJQb29sUGFzc3dvcmRQb2xpY3kgdXNlciBwb29sIHBhc3N3b3JkIHBvbGljeVxuICAgKiBAcGFyYW0gdXNlclBvb2xQcm92aWRlcnMgdXNlciBwb29sIHByb3ZpZGVyc1xuICAgKiBAcGFyYW0gdXNlclBvb2xNRkEgdXNlciBwb29sIE1GQSBzZXR0aW5nc1xuICAgKiBAcmV0dXJucyBmb3JtYXR0ZWQgb3V0cHV0c1xuICAgKi9cbiAgcHJpdmF0ZSBnZXRVc2VyUG9vbE91dHB1dHMgPSAoXG4gICAgdXNlclBvb2w6IFVzZXJQb29sVHlwZSxcbiAgICB1c2VyUG9vbFBhc3N3b3JkUG9saWN5OiBQYXNzd29yZFBvbGljeVR5cGUsXG4gICAgdXNlclBvb2xQcm92aWRlcnM6IFByb3ZpZGVyRGVzY3JpcHRpb25bXSxcbiAgICB1c2VyUG9vbE1GQTogR2V0VXNlclBvb2xNZmFDb25maWdDb21tYW5kT3V0cHV0LFxuICAgIHJlZ2lvbjogc3RyaW5nLFxuICApID0+IHtcbiAgICAvLyBwYXNzd29yZCBwb2xpY3kgcmVxdWlyZW1lbnRzXG4gICAgY29uc3QgcmVxdWlyZW1lbnRzOiBzdHJpbmdbXSA9IFtdO1xuICAgIHVzZXJQb29sUGFzc3dvcmRQb2xpY3kuUmVxdWlyZU51bWJlcnMgJiZcbiAgICAgIHJlcXVpcmVtZW50cy5wdXNoKCdSRVFVSVJFU19OVU1CRVJTJyk7XG4gICAgdXNlclBvb2xQYXNzd29yZFBvbGljeS5SZXF1aXJlTG93ZXJjYXNlICYmXG4gICAgICByZXF1aXJlbWVudHMucHVzaCgnUkVRVUlSRVNfTE9XRVJDQVNFJyk7XG4gICAgdXNlclBvb2xQYXNzd29yZFBvbGljeS5SZXF1aXJlVXBwZXJjYXNlICYmXG4gICAgICByZXF1aXJlbWVudHMucHVzaCgnUkVRVUlSRVNfVVBQRVJDQVNFJyk7XG4gICAgdXNlclBvb2xQYXNzd29yZFBvbGljeS5SZXF1aXJlU3ltYm9scyAmJlxuICAgICAgcmVxdWlyZW1lbnRzLnB1c2goJ1JFUVVJUkVTX1NZTUJPTFMnKTtcbiAgICAvLyBtZmEgdHlwZXNcbiAgICBjb25zdCBtZmFUeXBlczogc3RyaW5nW10gPSBbXTtcbiAgICBpZiAoXG4gICAgICB1c2VyUG9vbE1GQS5TbXNNZmFDb25maWd1cmF0aW9uICYmXG4gICAgICB1c2VyUG9vbE1GQS5TbXNNZmFDb25maWd1cmF0aW9uLlNtc0NvbmZpZ3VyYXRpb25cbiAgICApIHtcbiAgICAgIG1mYVR5cGVzLnB1c2goJ1NNU19NRkEnKTtcbiAgICB9XG4gICAgaWYgKHVzZXJQb29sTUZBLlNvZnR3YXJlVG9rZW5NZmFDb25maWd1cmF0aW9uPy5FbmFibGVkKSB7XG4gICAgICBtZmFUeXBlcy5wdXNoKCdUT1RQJyk7XG4gICAgfVxuICAgIC8vIHNvY2lhbCBwcm92aWRlcnNcbiAgICBjb25zdCBzb2NpYWxQcm92aWRlcnM6IHN0cmluZ1tdID0gW107XG4gICAgaWYgKHVzZXJQb29sUHJvdmlkZXJzKSB7XG4gICAgICBmb3IgKGNvbnN0IHByb3ZpZGVyIG9mIHVzZXJQb29sUHJvdmlkZXJzKSB7XG4gICAgICAgIGNvbnN0IHByb3ZpZGVyVHlwZSA9IHByb3ZpZGVyLlByb3ZpZGVyVHlwZTtcbiAgICAgICAgY29uc3QgcHJvdmlkZXJOYW1lID0gcHJvdmlkZXIuUHJvdmlkZXJOYW1lO1xuICAgICAgICBpZiAocHJvdmlkZXJUeXBlID09PSAnR29vZ2xlJykge1xuICAgICAgICAgIHNvY2lhbFByb3ZpZGVycy5wdXNoKCdHT09HTEUnKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocHJvdmlkZXJUeXBlID09PSAnRmFjZWJvb2snKSB7XG4gICAgICAgICAgc29jaWFsUHJvdmlkZXJzLnB1c2goJ0ZBQ0VCT09LJyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHByb3ZpZGVyVHlwZSA9PT0gJ1NpZ25JbldpdGhBcHBsZScpIHtcbiAgICAgICAgICBzb2NpYWxQcm92aWRlcnMucHVzaCgnU0lHTl9JTl9XSVRIX0FQUExFJyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHByb3ZpZGVyVHlwZSA9PT0gJ0xvZ2luV2l0aEFtYXpvbicpIHtcbiAgICAgICAgICBzb2NpYWxQcm92aWRlcnMucHVzaCgnTE9HSU5fV0lUSF9BTUFaT04nKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocHJvdmlkZXJUeXBlID09PSAnT0lEQycgJiYgcHJvdmlkZXJOYW1lKSB7XG4gICAgICAgICAgc29jaWFsUHJvdmlkZXJzLnB1c2gocHJvdmlkZXJOYW1lKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocHJvdmlkZXJUeXBlID09PSAnU0FNTCcgJiYgcHJvdmlkZXJOYW1lKSB7XG4gICAgICAgICAgc29jaWFsUHJvdmlkZXJzLnB1c2gocHJvdmlkZXJOYW1lKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIGRvbWFpblxuICAgIGNvbnN0IG9hdXRoRG9tYWluID0gdXNlclBvb2wuQ3VzdG9tRG9tYWluID8/IHVzZXJQb29sLkRvbWFpbiA/PyAnJztcbiAgICBjb25zdCBmdWxsRG9tYWluUGF0aCA9IGAke29hdXRoRG9tYWlufS5hdXRoLiR7cmVnaW9ufS5hbWF6b25jb2duaXRvLmNvbWA7XG4gICAgY29uc3QgZGF0YSA9IHtcbiAgICAgIHNpZ251cEF0dHJpYnV0ZXM6IEpTT04uc3RyaW5naWZ5KFxuICAgICAgICB1c2VyUG9vbC5TY2hlbWFBdHRyaWJ1dGVzPy5maWx0ZXIoXG4gICAgICAgICAgKGF0dHJpYnV0ZSkgPT4gYXR0cmlidXRlLlJlcXVpcmVkICYmIGF0dHJpYnV0ZS5OYW1lLFxuICAgICAgICApLm1hcCgoYXR0cmlidXRlKSA9PiBhdHRyaWJ1dGUuTmFtZT8udG9Mb3dlckNhc2UoKSkgfHwgW10sXG4gICAgICApLFxuICAgICAgdXNlcm5hbWVBdHRyaWJ1dGVzOiBKU09OLnN0cmluZ2lmeShcbiAgICAgICAgdXNlclBvb2wuVXNlcm5hbWVBdHRyaWJ1dGVzPy5tYXAoKGF0dHJpYnV0ZSkgPT5cbiAgICAgICAgICBhdHRyaWJ1dGUudG9Mb3dlckNhc2UoKSxcbiAgICAgICAgKSB8fCBbXSxcbiAgICAgICksXG4gICAgICB2ZXJpZmljYXRpb25NZWNoYW5pc21zOiBKU09OLnN0cmluZ2lmeShcbiAgICAgICAgdXNlclBvb2wuQXV0b1ZlcmlmaWVkQXR0cmlidXRlcyA/PyBbXSxcbiAgICAgICksXG4gICAgICBwYXNzd29yZFBvbGljeU1pbkxlbmd0aDpcbiAgICAgICAgdXNlclBvb2xQYXNzd29yZFBvbGljeS5NaW5pbXVtTGVuZ3RoID09PSB1bmRlZmluZWRcbiAgICAgICAgICA/ICcnXG4gICAgICAgICAgOiB1c2VyUG9vbFBhc3N3b3JkUG9saWN5Lk1pbmltdW1MZW5ndGgudG9TdHJpbmcoKSxcbiAgICAgIHBhc3N3b3JkUG9saWN5UmVxdWlyZW1lbnRzOiBKU09OLnN0cmluZ2lmeShyZXF1aXJlbWVudHMpLFxuICAgICAgbWZhQ29uZmlndXJhdGlvbjogdXNlclBvb2wuTWZhQ29uZmlndXJhdGlvbiA/PyAnT0ZGJyxcbiAgICAgIG1mYVR5cGVzOiBKU09OLnN0cmluZ2lmeShtZmFUeXBlcyksXG4gICAgICBzb2NpYWxQcm92aWRlcnM6IEpTT04uc3RyaW5naWZ5KHNvY2lhbFByb3ZpZGVycyksXG4gICAgICBvYXV0aENvZ25pdG9Eb21haW46IGZ1bGxEb21haW5QYXRoLFxuICAgIH07XG4gICAgcmV0dXJuIGRhdGE7XG4gIH07XG5cbiAgLyoqXG4gICAqIFRyYW5zZm9ybXMgaWRlbnRpdHlQb29sIGluZm8gaW50byBvdXRwdXRzLlxuICAgKiBAcGFyYW0gaWRlbnRpdHlQb29sIGlkZW50aXR5IHBvb2wgZGF0YVxuICAgKiBAcmV0dXJucyBmb3JtYXR0ZWQgb3V0cHV0c1xuICAgKi9cbiAgcHJpdmF0ZSBnZXRJZGVudGl0eVBvb2xPdXRwdXRzID0gKFxuICAgIGlkZW50aXR5UG9vbDogRGVzY3JpYmVJZGVudGl0eVBvb2xDb21tYW5kT3V0cHV0LFxuICApID0+IHtcbiAgICBjb25zdCBkYXRhID0ge1xuICAgICAgYWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzOlxuICAgICAgICBpZGVudGl0eVBvb2wuQWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzID09PSB0cnVlID8gJ3RydWUnIDogJ2ZhbHNlJyxcbiAgICB9O1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xuXG4gIC8qKlxuICAgKiBUcmFuc2Zvcm1zIHVzZXJQb29sQ2xpZW50IGluZm8gaW50byBvdXRwdXRzLlxuICAgKiBAcGFyYW0gdXNlclBvb2xDbGllbnQgdXNlclBvb2xDbGllbnQgZGF0YVxuICAgKiBAcmV0dXJucyBmb3JtYXR0ZWQgb3V0cHV0c1xuICAgKi9cbiAgcHJpdmF0ZSBnZXRVc2VyUG9vbENsaWVudE91dHB1dHMgPSAodXNlclBvb2xDbGllbnQ6IFVzZXJQb29sQ2xpZW50VHlwZSkgPT4ge1xuICAgIGNvbnN0IGRhdGEgPSB7XG4gICAgICBvYXV0aFNjb3BlOiBKU09OLnN0cmluZ2lmeSh1c2VyUG9vbENsaWVudC5BbGxvd2VkT0F1dGhTY29wZXMgPz8gW10pLFxuICAgICAgb2F1dGhSZWRpcmVjdFNpZ25JbjogdXNlclBvb2xDbGllbnQuQ2FsbGJhY2tVUkxzXG4gICAgICAgID8gdXNlclBvb2xDbGllbnQuQ2FsbGJhY2tVUkxzLmpvaW4oJywnKVxuICAgICAgICA6ICcnLFxuICAgICAgb2F1dGhSZWRpcmVjdFNpZ25PdXQ6IHVzZXJQb29sQ2xpZW50LkxvZ291dFVSTHNcbiAgICAgICAgPyB1c2VyUG9vbENsaWVudC5Mb2dvdXRVUkxzLmpvaW4oJywnKVxuICAgICAgICA6ICcnLFxuICAgICAgb2F1dGhSZXNwb25zZVR5cGU6IHVzZXJQb29sQ2xpZW50LkFsbG93ZWRPQXV0aEZsb3dzXG4gICAgICAgID8gdXNlclBvb2xDbGllbnQuQWxsb3dlZE9BdXRoRmxvd3Muam9pbignLCcpXG4gICAgICAgIDogJycsXG4gICAgICBvYXV0aENsaWVudElkOiB1c2VyUG9vbENsaWVudC5DbGllbnRJZCxcbiAgICB9O1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xufVxuXG4vKipcbiAqIEVudHJ5IHBvaW50IGZvciB0aGUgbGFtYmRhLWJhY2tlbmQgY3VzdG9tIHJlc291cmNlIHRvIHJldHJpZXZlIGF1dGggb3V0cHV0cy5cbiAqL1xuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBDbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlRXZlbnQsXG4pOiBQcm9taXNlPENsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VSZXNwb25zZT4gPT4ge1xuICBjb25zdCBpbml0aWFsaXplciA9IG5ldyBSZWZlcmVuY2VBdXRoSW5pdGlhbGl6ZXIoXG4gICAgbmV3IENvZ25pdG9JZGVudGl0eUNsaWVudCgpLFxuICAgIG5ldyBDb2duaXRvSWRlbnRpdHlQcm92aWRlckNsaWVudCgpLFxuICAgIHJhbmRvbVVVSUQsXG4gICk7XG4gIHJldHVybiBpbml0aWFsaXplci5oYW5kbGVFdmVudChldmVudCk7XG59O1xuIl19