import { existsSync as _existsSync } from 'fs';
import _fsp from 'fs/promises';
import { execa as _execa } from 'execa';
import * as _path from 'path';
import { LogLevel } from '../printer/printer.js';
import { printer } from '../printer.js';
import { executeWithDebugLogger as _executeWithDebugLogger } from './execute_with_debugger_logger.js';
import { getPackageManagerRunnerName } from './get_package_manager_name.js';
/**
 * PackageManagerController is an abstraction around package manager commands that are needed to initialize a project and install dependencies
 */
export class PackageManagerControllerBase {
    cwd;
    executable;
    initDefault;
    installCommand;
    lockFileReader;
    fsp;
    path;
    execa;
    executeWithDebugLogger;
    existsSync;
    binaryRunner;
    /**
     * constructor - sets the project root
     */
    constructor(cwd, executable, initDefault, installCommand, lockFileReader, fsp = _fsp, path = _path, execa = _execa, executeWithDebugLogger = _executeWithDebugLogger, existsSync = _existsSync) {
        this.cwd = cwd;
        this.executable = executable;
        this.initDefault = initDefault;
        this.installCommand = installCommand;
        this.lockFileReader = lockFileReader;
        this.fsp = fsp;
        this.path = path;
        this.execa = execa;
        this.executeWithDebugLogger = executeWithDebugLogger;
        this.existsSync = existsSync;
        this.binaryRunner = getPackageManagerRunnerName();
    }
    /**
     * installDependencies - installs dependencies in the project root
     */
    async installDependencies(packageNames, type) {
        const args = [`${this.installCommand}`].concat(...packageNames);
        if (type === 'dev') {
            args.push('-D');
        }
        await this.executeWithDebugLogger(this.cwd, this.executable, args, this.execa);
    }
    /**
     * initializeProject - initializes a project in the project root by checking the package.json file
     */
    initializeProject = async () => {
        if (this.packageJsonExists(this.cwd)) {
            // if package.json already exists, no need to do anything
            return;
        }
        printer.log(`No package.json file found in the current directory. Running \`${this.executable} init\`...`, LogLevel.DEBUG);
        try {
            await this.executeWithDebugLogger(this.cwd, this.executable, this.initDefault, this.execa);
        }
        catch (err) {
            throw new Error(`\`${this.executable} init\` did not exit successfully. Initialize a valid JavaScript package before continuing.`, { cause: err });
        }
        if (!this.packageJsonExists(this.cwd)) {
            // this should only happen if the customer exits out of npm init before finishing
            throw new Error(`package.json does not exist after running \`${this.executable} init\`. Initialize a valid JavaScript package before continuing.'`);
        }
    };
    /**
     * initializeTsConfig - initializes a tsconfig.json file in the project root
     *
     * When changing this method, double check if a corresponding change is needed in the integration test setup in `setup_dir_as_esm_module.ts`.
     */
    async initializeTsConfig(targetDir) {
        const tsConfigTemplate = {
            compilerOptions: {
                target: 'es2022',
                module: 'es2022',
                moduleResolution: 'bundler',
                resolveJsonModule: true,
                esModuleInterop: true,
                forceConsistentCasingInFileNames: true,
                strict: true,
                skipLibCheck: true,
                // The path here is coupled with backend-function's generated typedef file path
                paths: { '$amplify/*': ['../.amplify/generated/*'] },
            },
        };
        const tsConfigPath = this.path.resolve(targetDir, 'tsconfig.json');
        await this.fsp.writeFile(tsConfigPath, JSON.stringify(tsConfigTemplate, null, 2), 'utf-8');
    }
    /**
     * runWithPackageManager - Factory function that runs a command with the specified package manager's binary runner
     */
    runWithPackageManager(args = [], dir, options) {
        return this.executeWithDebugLogger(dir, this.binaryRunner, args, this.execa, options);
    }
    getCommand = (args) => `${this.binaryRunner} ${args.join(' ')}`;
    /**
     * allowsSignalPropagation - Determines if the package manager allows the process
     * signals such as SIGINT to be propagated to the underlying node process.
     * @deprecated
     */
    allowsSignalPropagation = () => true;
    /**
     * tryGetDependencies - Tries to retrieve dependency versions from the lock file in the project root
     */
    tryGetDependencies = async () => {
        const lockFileContents = await this.lockFileReader.getLockFileContentsFromCwd();
        return lockFileContents?.dependencies;
    };
    /**
     * Check if a package.json file exists in projectRoot
     */
    packageJsonExists = (projectRoot) => {
        return this.existsSync(this.path.resolve(projectRoot, 'package.json'));
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFja2FnZV9tYW5hZ2VyX2NvbnRyb2xsZXJfYmFzZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wYWNrYWdlLW1hbmFnZXItY29udHJvbGxlci9wYWNrYWdlX21hbmFnZXJfY29udHJvbGxlcl9iYXNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLElBQUksV0FBVyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQy9DLE9BQU8sSUFBSSxNQUFNLGFBQWEsQ0FBQztBQUMvQixPQUFPLEVBQUUsS0FBSyxJQUFJLE1BQU0sRUFBRSxNQUFNLE9BQU8sQ0FBQztBQUN4QyxPQUFPLEtBQUssS0FBSyxNQUFNLE1BQU0sQ0FBQztBQU85QixPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDakQsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN4QyxPQUFPLEVBQUUsc0JBQXNCLElBQUksdUJBQXVCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUN0RyxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUc1RTs7R0FFRztBQUNILE1BQU0sT0FBZ0IsNEJBQTRCO0lBUTNCO0lBQ0E7SUFDQTtJQUNBO0lBQ0E7SUFDQTtJQUNBO0lBQ0E7SUFDQTtJQUNBO0lBZEYsWUFBWSxDQUFTO0lBQ3hDOztPQUVHO0lBQ0gsWUFDcUIsR0FBVyxFQUNYLFVBQWtCLEVBQ2xCLFdBQXFCLEVBQ3JCLGNBQXNCLEVBQ3RCLGNBQThCLEVBQzlCLE1BQU0sSUFBSSxFQUNWLE9BQU8sS0FBSyxFQUNaLFFBQVEsTUFBTSxFQUNkLHlCQUF5Qix1QkFBdUIsRUFDaEQsYUFBYSxXQUFXO1FBVHhCLFFBQUcsR0FBSCxHQUFHLENBQVE7UUFDWCxlQUFVLEdBQVYsVUFBVSxDQUFRO1FBQ2xCLGdCQUFXLEdBQVgsV0FBVyxDQUFVO1FBQ3JCLG1CQUFjLEdBQWQsY0FBYyxDQUFRO1FB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RUc7SUFDSCxxQkFBcUIsQ0FDbkIsT0FBaUIsRUFBRSxFQUNuQixHQUFXLEVBQ1gsT0FBc0I7UUFFdEIsT0FBTyxJQUFJLENBQUMsc0JBQXNCLENBQ2hDLEdBQUcsRUFDSCxJQUFJLENBQUMsWUFBWSxFQUNqQixJQUFJLEVBQ0osSUFBSSxDQUFDLEtBQUssRUFDVixPQUFPLENBQ1IsQ0FBQztJQUNKLENBQUM7SUFFRCxVQUFVLEdBQUcsQ0FBQyxJQUFjLEVBQUUsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7SUFFMUU7Ozs7T0FJRztJQUNILHVCQUF1QixHQUFHLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQztJQUVyQzs7T0FFRztJQUNILGtCQUFrQixHQUFHLEtBQUssSUFBNEMsRUFBRTtRQUN0RSxNQUFNLGdCQUFnQixHQUNwQixNQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsMEJBQTBCLEVBQUUsQ0FBQztRQUV6RCxPQUFPLGdCQUFnQixFQUFFLFlBQVksQ0FBQztJQUN4QyxDQUFDLENBQUM7SUFFRjs7T0FFRztJQUNLLGlCQUFpQixHQUFHLENBQUMsV0FBbUIsRUFBVyxFQUFFO1FBQzNELE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsY0FBYyxDQUFDLENBQUMsQ0FBQztJQUN6RSxDQUFDLENBQUM7Q0FDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGV4aXN0c1N5bmMgYXMgX2V4aXN0c1N5bmMgfSBmcm9tICdmcyc7XG5pbXBvcnQgX2ZzcCBmcm9tICdmcy9wcm9taXNlcyc7XG5pbXBvcnQgeyBleGVjYSBhcyBfZXhlY2EgfSBmcm9tICdleGVjYSc7XG5pbXBvcnQgKiBhcyBfcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7XG4gIERlcGVuZGVuY3ksXG4gIEV4ZWNhQ2hpbGRQcm9jZXNzLFxuICBFeGVjYU9wdGlvbnMsXG4gIHR5cGUgUGFja2FnZU1hbmFnZXJDb250cm9sbGVyLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7IExvZ0xldmVsIH0gZnJvbSAnLi4vcHJpbnRlci9wcmludGVyLmpzJztcbmltcG9ydCB7IHByaW50ZXIgfSBmcm9tICcuLi9wcmludGVyLmpzJztcbmltcG9ydCB7IGV4ZWN1dGVXaXRoRGVidWdMb2dnZXIgYXMgX2V4ZWN1dGVXaXRoRGVidWdMb2dnZXIgfSBmcm9tICcuL2V4ZWN1dGVfd2l0aF9kZWJ1Z2dlcl9sb2dnZXIuanMnO1xuaW1wb3J0IHsgZ2V0UGFja2FnZU1hbmFnZXJSdW5uZXJOYW1lIH0gZnJvbSAnLi9nZXRfcGFja2FnZV9tYW5hZ2VyX25hbWUuanMnO1xuaW1wb3J0IHsgTG9ja0ZpbGVSZWFkZXIgfSBmcm9tICcuL2xvY2stZmlsZS1yZWFkZXIvdHlwZXMuanMnO1xuXG4vKipcbiAqIFBhY2thZ2VNYW5hZ2VyQ29udHJvbGxlciBpcyBhbiBhYnN0cmFjdGlvbiBhcm91bmQgcGFja2FnZSBtYW5hZ2VyIGNvbW1hbmRzIHRoYXQgYXJlIG5lZWRlZCB0byBpbml0aWFsaXplIGEgcHJvamVjdCBhbmQgaW5zdGFsbCBkZXBlbmRlbmNpZXNcbiAqL1xuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFBhY2thZ2VNYW5hZ2VyQ29udHJvbGxlckJhc2VcbiAgaW1wbGVtZW50cyBQYWNrYWdlTWFuYWdlckNvbnRyb2xsZXJcbntcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IGJpbmFyeVJ1bm5lcjogc3RyaW5nO1xuICAvKipcbiAgICogY29uc3RydWN0b3IgLSBzZXRzIHRoZSBwcm9qZWN0IHJvb3RcbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByb3RlY3RlZCByZWFkb25seSBjd2Q6IHN0cmluZyxcbiAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgZXhlY3V0YWJsZTogc3RyaW5nLFxuICAgIHByb3RlY3RlZCByZWFkb25seSBpbml0RGVmYXVsdDogc3RyaW5nW10sXG4gICAgcHJvdGVjdGVkIHJlYWRvbmx5IGluc3RhbGxDb21tYW5kOiBzdHJpbmcsXG4gICAgcHJvdGVjdGVkIHJlYWRvbmx5IGxvY2tGaWxlUmVhZGVyOiBMb2NrRmlsZVJlYWRlcixcbiAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgZnNwID0gX2ZzcCxcbiAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgcGF0aCA9IF9wYXRoLFxuICAgIHByb3RlY3RlZCByZWFkb25seSBleGVjYSA9IF9leGVjYSxcbiAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgZXhlY3V0ZVdpdGhEZWJ1Z0xvZ2dlciA9IF9leGVjdXRlV2l0aERlYnVnTG9nZ2VyLFxuICAgIHByb3RlY3RlZCByZWFkb25seSBleGlzdHNTeW5jID0gX2V4aXN0c1N5bmMsXG4gICkge1xuICAgIHRoaXMuYmluYXJ5UnVubmVyID0gZ2V0UGFja2FnZU1hbmFnZXJSdW5uZXJOYW1lKCk7XG4gIH1cblxuICAvKipcbiAgICogaW5zdGFsbERlcGVuZGVuY2llcyAtIGluc3RhbGxzIGRlcGVuZGVuY2llcyBpbiB0aGUgcHJvamVjdCByb290XG4gICAqL1xuICBhc3luYyBpbnN0YWxsRGVwZW5kZW5jaWVzKFxuICAgIHBhY2thZ2VOYW1lczogc3RyaW5nW10sXG4gICAgdHlwZTogJ2RldicgfCAncHJvZCcsXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGFyZ3MgPSBbYCR7dGhpcy5pbnN0YWxsQ29tbWFuZH1gXS5jb25jYXQoLi4ucGFja2FnZU5hbWVzKTtcbiAgICBpZiAodHlwZSA9PT0gJ2RldicpIHtcbiAgICAgIGFyZ3MucHVzaCgnLUQnKTtcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLmV4ZWN1dGVXaXRoRGVidWdMb2dnZXIoXG4gICAgICB0aGlzLmN3ZCxcbiAgICAgIHRoaXMuZXhlY3V0YWJsZSxcbiAgICAgIGFyZ3MsXG4gICAgICB0aGlzLmV4ZWNhLFxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogaW5pdGlhbGl6ZVByb2plY3QgLSBpbml0aWFsaXplcyBhIHByb2plY3QgaW4gdGhlIHByb2plY3Qgcm9vdCBieSBjaGVja2luZyB0aGUgcGFja2FnZS5qc29uIGZpbGVcbiAgICovXG4gIGluaXRpYWxpemVQcm9qZWN0ID0gYXN5bmMgKCkgPT4ge1xuICAgIGlmICh0aGlzLnBhY2thZ2VKc29uRXhpc3RzKHRoaXMuY3dkKSkge1xuICAgICAgLy8gaWYgcGFja2FnZS5qc29uIGFscmVhZHkgZXhpc3RzLCBubyBuZWVkIHRvIGRvIGFueXRoaW5nXG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgcHJpbnRlci5sb2coXG4gICAgICBgTm8gcGFja2FnZS5qc29uIGZpbGUgZm91bmQgaW4gdGhlIGN1cnJlbnQgZGlyZWN0b3J5LiBSdW5uaW5nIFxcYCR7dGhpcy5leGVjdXRhYmxlfSBpbml0XFxgLi4uYCxcbiAgICAgIExvZ0xldmVsLkRFQlVHLFxuICAgICk7XG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5leGVjdXRlV2l0aERlYnVnTG9nZ2VyKFxuICAgICAgICB0aGlzLmN3ZCxcbiAgICAgICAgdGhpcy5leGVjdXRhYmxlLFxuICAgICAgICB0aGlzLmluaXREZWZhdWx0LFxuICAgICAgICB0aGlzLmV4ZWNhLFxuICAgICAgKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYFxcYCR7dGhpcy5leGVjdXRhYmxlfSBpbml0XFxgIGRpZCBub3QgZXhpdCBzdWNjZXNzZnVsbHkuIEluaXRpYWxpemUgYSB2YWxpZCBKYXZhU2NyaXB0IHBhY2thZ2UgYmVmb3JlIGNvbnRpbnVpbmcuYCxcbiAgICAgICAgeyBjYXVzZTogZXJyIH0sXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5wYWNrYWdlSnNvbkV4aXN0cyh0aGlzLmN3ZCkpIHtcbiAgICAgIC8vIHRoaXMgc2hvdWxkIG9ubHkgaGFwcGVuIGlmIHRoZSBjdXN0b21lciBleGl0cyBvdXQgb2YgbnBtIGluaXQgYmVmb3JlIGZpbmlzaGluZ1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgcGFja2FnZS5qc29uIGRvZXMgbm90IGV4aXN0IGFmdGVyIHJ1bm5pbmcgXFxgJHt0aGlzLmV4ZWN1dGFibGV9IGluaXRcXGAuIEluaXRpYWxpemUgYSB2YWxpZCBKYXZhU2NyaXB0IHBhY2thZ2UgYmVmb3JlIGNvbnRpbnVpbmcuJ2AsXG4gICAgICApO1xuICAgIH1cbiAgfTtcblxuICAvKipcbiAgICogaW5pdGlhbGl6ZVRzQ29uZmlnIC0gaW5pdGlhbGl6ZXMgYSB0c2NvbmZpZy5qc29uIGZpbGUgaW4gdGhlIHByb2plY3Qgcm9vdFxuICAgKlxuICAgKiBXaGVuIGNoYW5naW5nIHRoaXMgbWV0aG9kLCBkb3VibGUgY2hlY2sgaWYgYSBjb3JyZXNwb25kaW5nIGNoYW5nZSBpcyBuZWVkZWQgaW4gdGhlIGludGVncmF0aW9uIHRlc3Qgc2V0dXAgaW4gYHNldHVwX2Rpcl9hc19lc21fbW9kdWxlLnRzYC5cbiAgICovXG4gIGFzeW5jIGluaXRpYWxpemVUc0NvbmZpZyh0YXJnZXREaXI6IHN0cmluZykge1xuICAgIGNvbnN0IHRzQ29uZmlnVGVtcGxhdGUgPSB7XG4gICAgICBjb21waWxlck9wdGlvbnM6IHtcbiAgICAgICAgdGFyZ2V0OiAnZXMyMDIyJyxcbiAgICAgICAgbW9kdWxlOiAnZXMyMDIyJyxcbiAgICAgICAgbW9kdWxlUmVzb2x1dGlvbjogJ2J1bmRsZXInLFxuICAgICAgICByZXNvbHZlSnNvbk1vZHVsZTogdHJ1ZSxcbiAgICAgICAgZXNNb2R1bGVJbnRlcm9wOiB0cnVlLFxuICAgICAgICBmb3JjZUNvbnNpc3RlbnRDYXNpbmdJbkZpbGVOYW1lczogdHJ1ZSxcbiAgICAgICAgc3RyaWN0OiB0cnVlLFxuICAgICAgICBza2lwTGliQ2hlY2s6IHRydWUsXG4gICAgICAgIC8vIFRoZSBwYXRoIGhlcmUgaXMgY291cGxlZCB3aXRoIGJhY2tlbmQtZnVuY3Rpb24ncyBnZW5lcmF0ZWQgdHlwZWRlZiBmaWxlIHBhdGhcbiAgICAgICAgcGF0aHM6IHsgJyRhbXBsaWZ5LyonOiBbJy4uLy5hbXBsaWZ5L2dlbmVyYXRlZC8qJ10gfSxcbiAgICAgIH0sXG4gICAgfTtcbiAgICBjb25zdCB0c0NvbmZpZ1BhdGggPSB0aGlzLnBhdGgucmVzb2x2ZSh0YXJnZXREaXIsICd0c2NvbmZpZy5qc29uJyk7XG4gICAgYXdhaXQgdGhpcy5mc3Aud3JpdGVGaWxlKFxuICAgICAgdHNDb25maWdQYXRoLFxuICAgICAgSlNPTi5zdHJpbmdpZnkodHNDb25maWdUZW1wbGF0ZSwgbnVsbCwgMiksXG4gICAgICAndXRmLTgnLFxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogcnVuV2l0aFBhY2thZ2VNYW5hZ2VyIC0gRmFjdG9yeSBmdW5jdGlvbiB0aGF0IHJ1bnMgYSBjb21tYW5kIHdpdGggdGhlIHNwZWNpZmllZCBwYWNrYWdlIG1hbmFnZXIncyBiaW5hcnkgcnVubmVyXG4gICAqL1xuICBydW5XaXRoUGFja2FnZU1hbmFnZXIoXG4gICAgYXJnczogc3RyaW5nW10gPSBbXSxcbiAgICBkaXI6IHN0cmluZyxcbiAgICBvcHRpb25zPzogRXhlY2FPcHRpb25zLFxuICApOiBFeGVjYUNoaWxkUHJvY2VzcyB7XG4gICAgcmV0dXJuIHRoaXMuZXhlY3V0ZVdpdGhEZWJ1Z0xvZ2dlcihcbiAgICAgIGRpcixcbiAgICAgIHRoaXMuYmluYXJ5UnVubmVyLFxuICAgICAgYXJncyxcbiAgICAgIHRoaXMuZXhlY2EsXG4gICAgICBvcHRpb25zLFxuICAgICk7XG4gIH1cblxuICBnZXRDb21tYW5kID0gKGFyZ3M6IHN0cmluZ1tdKSA9PiBgJHt0aGlzLmJpbmFyeVJ1bm5lcn0gJHthcmdzLmpvaW4oJyAnKX1gO1xuXG4gIC8qKlxuICAgKiBhbGxvd3NTaWduYWxQcm9wYWdhdGlvbiAtIERldGVybWluZXMgaWYgdGhlIHBhY2thZ2UgbWFuYWdlciBhbGxvd3MgdGhlIHByb2Nlc3NcbiAgICogc2lnbmFscyBzdWNoIGFzIFNJR0lOVCB0byBiZSBwcm9wYWdhdGVkIHRvIHRoZSB1bmRlcmx5aW5nIG5vZGUgcHJvY2Vzcy5cbiAgICogQGRlcHJlY2F0ZWRcbiAgICovXG4gIGFsbG93c1NpZ25hbFByb3BhZ2F0aW9uID0gKCkgPT4gdHJ1ZTtcblxuICAvKipcbiAgICogdHJ5R2V0RGVwZW5kZW5jaWVzIC0gVHJpZXMgdG8gcmV0cmlldmUgZGVwZW5kZW5jeSB2ZXJzaW9ucyBmcm9tIHRoZSBsb2NrIGZpbGUgaW4gdGhlIHByb2plY3Qgcm9vdFxuICAgKi9cbiAgdHJ5R2V0RGVwZW5kZW5jaWVzID0gYXN5bmMgKCk6IFByb21pc2U8QXJyYXk8RGVwZW5kZW5jeT4gfCB1bmRlZmluZWQ+ID0+IHtcbiAgICBjb25zdCBsb2NrRmlsZUNvbnRlbnRzID1cbiAgICAgIGF3YWl0IHRoaXMubG9ja0ZpbGVSZWFkZXIuZ2V0TG9ja0ZpbGVDb250ZW50c0Zyb21Dd2QoKTtcblxuICAgIHJldHVybiBsb2NrRmlsZUNvbnRlbnRzPy5kZXBlbmRlbmNpZXM7XG4gIH07XG5cbiAgLyoqXG4gICAqIENoZWNrIGlmIGEgcGFja2FnZS5qc29uIGZpbGUgZXhpc3RzIGluIHByb2plY3RSb290XG4gICAqL1xuICBwcml2YXRlIHBhY2thZ2VKc29uRXhpc3RzID0gKHByb2plY3RSb290OiBzdHJpbmcpOiBib29sZWFuID0+IHtcbiAgICByZXR1cm4gdGhpcy5leGlzdHNTeW5jKHRoaXMucGF0aC5yZXNvbHZlKHByb2plY3RSb290LCAncGFja2FnZS5qc29uJykpO1xuICB9O1xufVxuIl19