import { AmplifyFormRenderer, ModuleKind, ReactIndexStudioTemplateRenderer, ReactUtilsStudioTemplateRenderer, ScriptKind, ScriptTarget, getDeclarationFilename, } from '@aws-amplify/codegen-ui-react';
/**
 * Generates GraphQL-compatible forms in React by directly leveraging @aws-amplify/codegen-ui-react
 */
export class LocalGraphqlFormGenerator {
    schemaFetcher;
    renderOptions;
    resultBuilder;
    static defaultConfig = {
        module: ModuleKind.ES2020,
        target: ScriptTarget.ES2020,
        script: ScriptKind.JSX,
        renderTypeDeclarations: true,
    };
    /**
     * Instantiates a LocalGraphqlFormGenerator for a provided schema
     */
    constructor(schemaFetcher, renderOptions, resultBuilder) {
        this.schemaFetcher = schemaFetcher;
        this.renderOptions = renderOptions;
        this.resultBuilder = resultBuilder;
    }
    /**
     * Gets the react render config
     */
    get config() {
        return {
            module: ModuleKind.ES2020,
            target: ScriptTarget.ES2020,
            script: ScriptKind.JSX,
            includeUseClientDirective: true,
            renderTypeDeclarations: true,
            apiConfiguration: {
                dataApi: 'GraphQL',
                fragmentsFilePath: this.renderGraphqlPath('fragments'),
                mutationsFilePath: this.renderGraphqlPath('mutations'),
                queriesFilePath: this.renderGraphqlPath('queries'),
                subscriptionsFilePath: this.renderGraphqlPath('subscriptions'),
                typesFilePath: this.renderGraphqlPath('types'),
            },
            dependencies: {
                // Tell the renderer to generate amplify js v6 compatible code
                'aws-amplify': '^6.0.0',
            },
        };
    }
    generateIndexFile = (schemas) => {
        const { componentText, fileName } = this.createIndexFile(schemas);
        return {
            schemaName: 'AmplifyStudioIndexFile',
            componentText,
            fileName,
            declaration: undefined,
            error: undefined,
        };
    };
    generateForms = async (options) => {
        const dataSchema = await this.schemaFetcher();
        const filteredModels = this.getFilteredModels(dataSchema, options?.models);
        const filteredSchema = this.transformModelListToMap(filteredModels);
        const utilFile = this.generateUtilFile();
        const baseForms = this.generateBaseForms(filteredSchema);
        const indexFile = this.generateIndexFile(baseForms.map(({ name }) => ({
            name,
        })));
        dataSchema.models = Object.entries(dataSchema.models).reduce((prev, [key, value]) => {
            prev[key] = value;
            return prev;
        }, {});
        const forms = baseForms.reduce((prev, formSchema) => {
            const results = this.codegenForm(dataSchema, formSchema);
            results.forEach((result) => {
                prev[result.fileName] = result.componentText;
            });
            return prev;
        }, {});
        forms[utilFile.fileName] = utilFile.componentText;
        forms[indexFile.fileName] = indexFile.componentText;
        return this.resultBuilder(forms);
    };
    /**
     * reduces the dataSchema to a map of models
     */
    getModelMapForDataSchema = (dataSchema) => {
        return Object.entries(dataSchema.models).reduce((prev, [name, model]) => {
            if (!model.isJoinTable) {
                prev[name] = new Set(['create', 'update']);
            }
            return prev;
        }, {});
    };
    getSchema = (name, type) => ({
        name: `${name}${type === 'create' ? 'CreateForm' : 'UpdateForm'}`,
        formActionType: type,
        dataType: { dataSourceType: 'DataStore', dataTypeName: name },
        fields: {},
        sectionalElements: {},
        style: {},
        cta: {},
    });
    generateBaseForms = (modelMap) => {
        const schemas = [];
        Object.entries(modelMap).forEach(([name, set]) => {
            set.forEach((type) => schemas.push(this.getSchema(name, type)));
        });
        return schemas;
    };
    renderGraphqlPath = (submodule) => {
        const graphqlPath = `${this.renderOptions.graphqlDir}/${submodule}`;
        // if the path does not start with a leading ./ or ../, assume that the graphql folder is in the same directory relative to the ui, and prepend a `./`
        if (graphqlPath.startsWith('.')) {
            return graphqlPath;
        }
        return `./${graphqlPath}`;
    };
    createUiBuilderForm = (schema, dataSchema, formFeatureFlags) => {
        const renderer = new AmplifyFormRenderer(schema, dataSchema, this.config, formFeatureFlags);
        const { componentText, declaration } = renderer.renderComponentInternal();
        const files = [
            {
                componentText,
                fileName: renderer.fileName,
            },
        ];
        if (declaration) {
            files.push({
                componentText: declaration,
                fileName: getDeclarationFilename(renderer.fileName),
            });
        }
        return files;
    };
    filterModelsByName = (filteredModelNames, schemaModel) => {
        const lowerCaseModelKeys = new Set(Object.keys(schemaModel).map((k) => k.toLowerCase()));
        const modelEntries = Object.entries(schemaModel);
        return filteredModelNames.reduce((prev, model) => {
            if (lowerCaseModelKeys?.has(model.toLowerCase())) {
                const entry = modelEntries.find(([key]) => key.toLowerCase() === model.toLowerCase());
                if (!entry) {
                    // eslint-disable-next-line @aws-amplify/amplify-backend-rules/prefer-amplify-errors
                    throw new Error(`Could not find specified model ${model}`);
                }
                prev.push(entry);
                return prev;
            }
            // eslint-disable-next-line @aws-amplify/amplify-backend-rules/prefer-amplify-errors
            throw new Error(`Could not find specified model ${model}`);
        }, []);
    };
    codegenForm = (dataSchema, formSchema) => {
        return this.createUiBuilderForm(formSchema, dataSchema, {});
    };
    getFilteredModels = (dataSchema, filteredModelNames) => {
        const modelMap = this.getModelMapForDataSchema(dataSchema);
        const filteredModels = [];
        if (!filteredModelNames || !filteredModelNames?.length) {
            filteredModels.push(...Object.entries(modelMap));
        }
        else {
            filteredModels.push(...this.filterModelsByName(filteredModelNames, modelMap));
        }
        return filteredModels;
    };
    transformModelListToMap = (models) => {
        return models.reduce((prev, [key, value]) => ({ ...prev, [key]: value }), {});
    };
    createUtilFile = (utils) => {
        const renderer = new ReactUtilsStudioTemplateRenderer(utils, this.config);
        const { componentText } = renderer.renderComponentInternal();
        return {
            componentText,
            fileName: renderer.fileName,
        };
    };
    /**
     * Return utils file text
     */
    generateUtilFile = () => {
        const utils = [
            'validation',
            'formatter',
            'fetchByPath',
            'processFile',
        ];
        const { componentText, fileName } = this.createUtilFile(utils);
        return {
            schemaName: 'AmplifyStudioUtilFile',
            componentText,
            fileName,
            declaration: undefined,
            error: undefined,
        };
    };
    createIndexFile = (schemas) => {
        const renderer = new ReactIndexStudioTemplateRenderer(schemas, LocalGraphqlFormGenerator.defaultConfig);
        const { componentText } = renderer.renderComponentInternal();
        return {
            componentText,
            fileName: renderer.fileName,
        };
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9jYWxfY29kZWdlbl9ncmFwaHFsX2Zvcm1fZ2VuZXJhdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2xvY2FsX2NvZGVnZW5fZ3JhcGhxbF9mb3JtX2dlbmVyYXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFNQSxPQUFPLEVBQ0wsbUJBQW1CLEVBQ25CLFVBQVUsRUFDVixnQ0FBZ0MsRUFFaEMsZ0NBQWdDLEVBQ2hDLFVBQVUsRUFDVixZQUFZLEVBRVosc0JBQXNCLEdBQ3ZCLE1BQU0sK0JBQStCLENBQUM7QUFzQnZDOztHQUVHO0FBQ0gsTUFBTSxPQUFPLHlCQUF5QjtJQVkxQjtJQUNBO0lBQ0E7SUFiRixNQUFNLENBQUMsYUFBYSxHQUFHO1FBQzdCLE1BQU0sRUFBRSxVQUFVLENBQUMsTUFBTTtRQUN6QixNQUFNLEVBQUUsWUFBWSxDQUFDLE1BQU07UUFDM0IsTUFBTSxFQUFFLFVBQVUsQ0FBQyxHQUFHO1FBQ3RCLHNCQUFzQixFQUFFLElBQUk7S0FDN0IsQ0FBQztJQUVGOztPQUVHO0lBQ0gsWUFDVSxhQUE0QixFQUM1QixhQUE0QixFQUM1QixhQUE0QjtRQUY1QixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUM1QixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUM1QixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtJQUNuQyxDQUFDO0lBRUo7O09BRUc7SUFDSCxJQUFZLE1BQU07UUFDaEIsT0FBTztZQUNMLE1BQU0sRUFBRSxVQUFVLENBQUMsTUFBTTtZQUN6QixNQUFNLEVBQUUsWUFBWSxDQUFDLE1BQU07WUFDM0IsTUFBTSxFQUFFLFVBQVUsQ0FBQyxHQUFHO1lBQ3RCLHlCQUF5QixFQUFFLElBQUk7WUFDL0Isc0JBQXNCLEVBQUUsSUFBSTtZQUM1QixnQkFBZ0IsRUFBRTtnQkFDaEIsT0FBTyxFQUFFLFNBQVM7Z0JBQ2xCLGlCQUFpQixFQUFFLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXLENBQUM7Z0JBQ3RELGlCQUFp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V0FBVztZQUNYLGFBQWE7WUFDYixhQUFhO1NBQ2QsQ0FBQztRQUNGLE1BQU0sRUFBRSxhQUFhLEVBQUUsUUFBUSxFQUFFLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMvRCxPQUFPO1lBQ0wsVUFBVSxFQUFFLHVCQUF1QjtZQUNuQyxhQUFhO1lBQ2IsUUFBUTtZQUNSLFdBQVcsRUFBRSxTQUFTO1lBQ3RCLEtBQUssRUFBRSxTQUFTO1NBQ2pCLENBQUM7SUFDSixDQUFDLENBQUM7SUFFTSxlQUFlLEdBQUcsQ0FBQyxPQUF1QixFQUFFLEVBQUU7UUFDcEQsTUFBTSxRQUFRLEdBQUcsSUFBSSxnQ0FBZ0MsQ0FDbkQsT0FBTyxFQUNQLHlCQUF5QixDQUFDLGFBQWEsQ0FDeEMsQ0FBQztRQUNGLE1BQU0sRUFBRSxhQUFhLEVBQUUsR0FBRyxRQUFRLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztRQUM3RCxPQUFPO1lBQ0wsYUFBYTtZQUNiLFFBQVEsRUFBRSxRQUFRLENBQUMsUUFBUTtTQUM1QixDQUFDO0lBQ0osQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgRm9ybUZlYXR1cmVGbGFncyxcbiAgR2VuZXJpY0RhdGFTY2hlbWEsXG4gIFN0dWRpb0Zvcm0sXG4gIFN0dWRpb1NjaGVtYSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2NvZGVnZW4tdWknO1xuaW1wb3J0IHtcbiAgQW1wbGlmeUZvcm1SZW5kZXJlcixcbiAgTW9kdWxlS2luZCxcbiAgUmVhY3RJbmRleFN0dWRpb1RlbXBsYXRlUmVuZGVyZXIsXG4gIFJlYWN0UmVuZGVyQ29uZmlnLFxuICBSZWFjdFV0aWxzU3R1ZGlvVGVtcGxhdGVSZW5kZXJlcixcbiAgU2NyaXB0S2luZCxcbiAgU2NyaXB0VGFyZ2V0LFxuICBVdGlsVGVtcGxhdGVUeXBlLFxuICBnZXREZWNsYXJhdGlvbkZpbGVuYW1lLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvY29kZWdlbi11aS1yZWFjdCc7XG5pbXBvcnQge1xuICBGb3JtR2VuZXJhdGlvbk9wdGlvbnMsXG4gIEdyYXBocWxGb3JtR2VuZXJhdG9yLFxuICBHcmFwaHFsR2VuZXJhdGlvblJlc3VsdCxcbn0gZnJvbSAnLi9ncmFwaHFsX2Zvcm1fZ2VuZXJhdG9yLmpzJztcblxudHlwZSBGb3JtRGVmID0gU2V0PCdjcmVhdGUnIHwgJ3VwZGF0ZSc+O1xudHlwZSBNb2RlbFJlY29yZCA9IFJlY29yZDxzdHJpbmcsIEZvcm1EZWY+O1xuXG4vKipcbiAqIFJlbmRlciBDb25maWd1cmF0aW9uIE9wdGlvbnMgZm9yIHJlYWN0IGZvcm1zXG4gKi9cbmV4cG9ydCB0eXBlIFJlbmRlck9wdGlvbnMgPSB7XG4gIGdyYXBocWxEaXI6IHN0cmluZztcbn07XG5cbmV4cG9ydCB0eXBlIFJlc3VsdEJ1aWxkZXIgPSAoXG4gIGZpbGVNYXA6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4sXG4pID0+IEdyYXBocWxHZW5lcmF0aW9uUmVzdWx0O1xuXG5leHBvcnQgdHlwZSBTY2hlbWFGZXRjaGVyID0gKCkgPT4gUHJvbWlzZTxHZW5lcmljRGF0YVNjaGVtYT47XG4vKipcbiAqIEdlbmVyYXRlcyBHcmFwaFFMLWNvbXBhdGlibGUgZm9ybXMgaW4gUmVhY3QgYnkgZGlyZWN0bHkgbGV2ZXJhZ2luZyBAYXdzLWFtcGxpZnkvY29kZWdlbi11aS1yZWFjdFxuICovXG5leHBvcnQgY2xhc3MgTG9jYWxHcmFwaHFsRm9ybUdlbmVyYXRvciBpbXBsZW1lbnRzIEdyYXBocWxGb3JtR2VuZXJhdG9yIHtcbiAgcHJpdmF0ZSBzdGF0aWMgZGVmYXVsdENvbmZpZyA9IHtcbiAgICBtb2R1bGU6IE1vZHVsZUtpbmQuRVMyMDIwLFxuICAgIHRhcmdldDogU2NyaXB0VGFyZ2V0LkVTMjAyMCxcbiAgICBzY3JpcHQ6IFNjcmlwdEtpbmQuSlNYLFxuICAgIHJlbmRlclR5cGVEZWNsYXJhdGlvbnM6IHRydWUsXG4gIH07XG5cbiAgLyoqXG4gICAqIEluc3RhbnRpYXRlcyBhIExvY2FsR3JhcGhxbEZvcm1HZW5lcmF0b3IgZm9yIGEgcHJvdmlkZWQgc2NoZW1hXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHNjaGVtYUZldGNoZXI6IFNjaGVtYUZldGNoZXIsXG4gICAgcHJpdmF0ZSByZW5kZXJPcHRpb25zOiBSZW5kZXJPcHRpb25zLFxuICAgIHByaXZhdGUgcmVzdWx0QnVpbGRlcjogUmVzdWx0QnVpbGRlcixcbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBHZXRzIHRoZSByZWFjdCByZW5kZXIgY29uZmlnXG4gICAqL1xuICBwcml2YXRlIGdldCBjb25maWcoKTogUmVhY3RSZW5kZXJDb25maWcge1xuICAgIHJldHVybiB7XG4gICAgICBtb2R1bGU6IE1vZHVsZUtpbmQuRVMyMDIwLFxuICAgICAgdGFyZ2V0OiBTY3JpcHRUYXJnZXQuRVMyMDIwLFxuICAgICAgc2NyaXB0OiBTY3JpcHRLaW5kLkpTWCxcbiAgICAgIGluY2x1ZGVVc2VDbGllbnREaXJlY3RpdmU6IHRydWUsXG4gICAgICByZW5kZXJUeXBlRGVjbGFyYXRpb25zOiB0cnVlLFxuICAgICAgYXBpQ29uZmlndXJhdGlvbjoge1xuICAgICAgICBkYXRhQXBpOiAnR3JhcGhRTCcsXG4gICAgICAgIGZyYWdtZW50c0ZpbGVQYXRoOiB0aGlzLnJlbmRlckdyYXBocWxQYXRoKCdmcmFnbWVudHMnKSxcbiAgICAgICAgbXV0YXRpb25zRmlsZVBhdGg6IHRoaXMucmVuZGVyR3JhcGhxbFBhdGgoJ211dGF0aW9ucycpLFxuICAgICAgICBxdWVyaWVzRmlsZVBhdGg6IHRoaXMucmVuZGVyR3JhcGhxbFBhdGgoJ3F1ZXJpZXMnKSxcbiAgICAgICAgc3Vic2NyaXB0aW9uc0ZpbGVQYXRoOiB0aGlzLnJlbmRlckdyYXBocWxQYXRoKCdzdWJzY3JpcHRpb25zJyksXG4gICAgICAgIHR5cGVzRmlsZVBhdGg6IHRoaXMucmVuZGVyR3JhcGhxbFBhdGgoJ3R5cGVzJyksXG4gICAgICB9LFxuICAgICAgZGVwZW5kZW5jaWVzOiB7XG4gICAgICAgIC8vIFRlbGwgdGhlIHJlbmRlcmVyIHRvIGdlbmVyYXRlIGFtcGxpZnkganMgdjYgY29tcGF0aWJsZSBjb2RlXG4gICAgICAgICdhd3MtYW1wbGlmeSc6ICdeNi4wLjAnLFxuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgZ2VuZXJhdGVJbmRleEZpbGUgPSAoc2NoZW1hczogeyBuYW1lOiBzdHJpbmcgfVtdKSA9PiB7XG4gICAgY29uc3QgeyBjb21wb25lbnRUZXh0LCBmaWxlTmFtZSB9ID0gdGhpcy5jcmVhdGVJbmRleEZpbGUoXG4gICAgICBzY2hlbWFzIGFzIFN0dWRpb1NjaGVtYVtdLFxuICAgICk7XG4gICAgcmV0dXJuIHtcbiAgICAgIHNjaGVtYU5hbWU6ICdBbXBsaWZ5U3R1ZGlvSW5kZXhGaWxlJyxcbiAgICAgIGNvbXBvbmVudFRleHQsXG4gICAgICBmaWxlTmFtZSxcbiAgICAgIGRlY2xhcmF0aW9uOiB1bmRlZmluZWQsXG4gICAgICBlcnJvcjogdW5kZWZpbmVkLFxuICAgIH07XG4gIH07XG5cbiAgZ2VuZXJhdGVGb3JtcyA9IGFzeW5jIChcbiAgICBvcHRpb25zPzogRm9ybUdlbmVyYXRpb25PcHRpb25zLFxuICApOiBQcm9taXNlPEdyYXBocWxHZW5lcmF0aW9uUmVzdWx0PiA9PiB7XG4gICAgY29uc3QgZGF0YVNjaGVtYSA9IGF3YWl0IHRoaXMuc2NoZW1hRmV0Y2hlcigpO1xuICAgIGNvbnN0IGZpbHRlcmVkTW9kZWxzID0gdGhpcy5nZXRGaWx0ZXJlZE1vZGVscyhkYXRhU2NoZW1hLCBvcHRpb25zPy5tb2RlbHMpO1xuICAgIGNvbnN0IGZpbHRlcmVkU2NoZW1hID0gdGhpcy50cmFuc2Zvcm1Nb2RlbExpc3RUb01hcChmaWx0ZXJlZE1vZGVscyk7XG4gICAgY29uc3QgdXRpbEZpbGUgPSB0aGlzLmdlbmVyYXRlVXRpbEZpbGUoKTtcbiAgICBjb25zdCBiYXNlRm9ybXMgPSB0aGlzLmdlbmVyYXRlQmFzZUZvcm1zKGZpbHRlcmVkU2NoZW1hKTtcbiAgICBjb25zdCBpbmRleEZpbGUgPSB0aGlzLmdlbmVyYXRlSW5kZXhGaWxlKFxuICAgICAgYmFzZUZvcm1zLm1hcCgoeyBuYW1lIH0pID0+ICh7XG4gICAgICAgIG5hbWUsXG4gICAgICB9KSksXG4gICAgKTtcblxuICAgIGRhdGFTY2hlbWEubW9kZWxzID0gT2JqZWN0LmVudHJpZXMoZGF0YVNjaGVtYS5tb2RlbHMpLnJlZHVjZTxcbiAgICAgICh0eXBlb2YgZGF0YVNjaGVtYSlbJ21vZGVscyddXG4gICAgPigocHJldiwgW2tleSwgdmFsdWVdKSA9PiB7XG4gICAgICBwcmV2W2tleV0gPSB2YWx1ZTtcblxuICAgICAgcmV0dXJuIHByZXY7XG4gICAgfSwge30pO1xuXG4gICAgY29uc3QgZm9ybXMgPSBiYXNlRm9ybXMucmVkdWNlPFJlY29yZDxzdHJpbmcsIHN0cmluZz4+KFxuICAgICAgKHByZXYsIGZvcm1TY2hlbWEpID0+IHtcbiAgICAgICAgY29uc3QgcmVzdWx0cyA9IHRoaXMuY29kZWdlbkZvcm0oZGF0YVNjaGVtYSwgZm9ybVNjaGVtYSk7XG4gICAgICAgIHJlc3VsdHMuZm9yRWFjaCgocmVzdWx0KSA9PiB7XG4gICAgICAgICAgcHJldltyZXN1bHQuZmlsZU5hbWVdID0gcmVzdWx0LmNvbXBvbmVudFRleHQ7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gcHJldjtcbiAgICAgIH0sXG4gICAgICB7fSxcbiAgICApO1xuICAgIGZvcm1zW3V0aWxGaWxlLmZpbGVOYW1lXSA9IHV0aWxGaWxlLmNvbXBvbmVudFRleHQ7XG4gICAgZm9ybXNbaW5kZXhGaWxlLmZpbGVOYW1lXSA9IGluZGV4RmlsZS5jb21wb25lbnRUZXh0O1xuICAgIHJldHVybiB0aGlzLnJlc3VsdEJ1aWxkZXIoZm9ybXMpO1xuICB9O1xuXG4gIC8qKlxuICAgKiByZWR1Y2VzIHRoZSBkYXRhU2NoZW1hIHRvIGEgbWFwIG9mIG1vZGVsc1xuICAgKi9cbiAgcHJpdmF0ZSBnZXRNb2RlbE1hcEZvckRhdGFTY2hlbWEgPSAoZGF0YVNjaGVtYTogR2VuZXJpY0RhdGFTY2hlbWEpID0+IHtcbiAgICByZXR1cm4gT2JqZWN0LmVudHJpZXMoZGF0YVNjaGVtYS5tb2RlbHMpLnJlZHVjZTxNb2RlbFJlY29yZD4oXG4gICAgICAocHJldiwgW25hbWUsIG1vZGVsXSkgPT4ge1xuICAgICAgICBpZiAoIW1vZGVsLmlzSm9pblRhYmxlKSB7XG4gICAgICAgICAgcHJldltuYW1lXSA9IG5ldyBTZXQoWydjcmVhdGUnLCAndXBkYXRlJ10pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBwcmV2O1xuICAgICAgfSxcbiAgICAgIHt9LFxuICAgICk7XG4gIH07XG5cbiAgcHJpdmF0ZSBnZXRTY2hlbWEgPSAoXG4gICAgbmFtZTogc3RyaW5nLFxuICAgIHR5cGU6ICdjcmVhdGUnIHwgJ3VwZGF0ZScsXG4gICk6IFN0dWRpb0Zvcm0gPT4gKHtcbiAgICBuYW1lOiBgJHtuYW1lfSR7dHlwZSA9PT0gJ2NyZWF0ZScgPyAnQ3JlYXRlRm9ybScgOiAnVXBkYXRlRm9ybSd9YCxcbiAgICBmb3JtQWN0aW9uVHlwZTogdHlwZSxcbiAgICBkYXRhVHlwZTogeyBkYXRhU291cmNlVHlwZTogJ0RhdGFTdG9yZScsIGRhdGFUeXBlTmFtZTogbmFtZSB9LFxuICAgIGZpZWxkczoge30sXG4gICAgc2VjdGlvbmFsRWxlbWVudHM6IHt9LFxuICAgIHN0eWxlOiB7fSxcbiAgICBjdGE6IHt9LFxuICB9KTtcblxuICBwcml2YXRlIGdlbmVyYXRlQmFzZUZvcm1zID0gKG1vZGVsTWFwOiB7XG4gICAgW21vZGVsOiBzdHJpbmddOiBTZXQ8J2NyZWF0ZScgfCAndXBkYXRlJz47XG4gIH0pOiBTdHVkaW9Gb3JtW10gPT4ge1xuICAgIGNvbnN0IHNjaGVtYXM6IFN0dWRpb0Zvcm1bXSA9IFtdO1xuICAgIE9iamVjdC5lbnRyaWVzKG1vZGVsTWFwKS5mb3JFYWNoKChbbmFtZSwgc2V0XSkgPT4ge1xuICAgICAgc2V0LmZvckVhY2goKHR5cGUpID0+IHNjaGVtYXMucHVzaCh0aGlzLmdldFNjaGVtYShuYW1lLCB0eXBlKSkpO1xuICAgIH0pO1xuICAgIHJldHVybiBzY2hlbWFzO1xuICB9O1xuXG4gIHByaXZhdGUgcmVuZGVyR3JhcGhxbFBhdGggPSAoXG4gICAgc3VibW9kdWxlOlxuICAgICAgfCAnZnJhZ21lbnRzJ1xuICAgICAgfCAnbXV0YXRpb25zJ1xuICAgICAgfCAncXVlcmllcydcbiAgICAgIHwgJ3R5cGVzJ1xuICAgICAgfCAnc3Vic2NyaXB0aW9ucycsXG4gICkgPT4ge1xuICAgIGNvbnN0IGdyYXBocWxQYXRoID0gYCR7dGhpcy5yZW5kZXJPcHRpb25zLmdyYXBocWxEaXJ9LyR7c3VibW9kdWxlfWA7XG4gICAgLy8gaWYgdGhlIHBhdGggZG9lcyBub3Qgc3RhcnQgd2l0aCBhIGxlYWRpbmcgLi8gb3IgLi4vLCBhc3N1bWUgdGhhdCB0aGUgZ3JhcGhxbCBmb2xkZXIgaXMgaW4gdGhlIHNhbWUgZGlyZWN0b3J5IHJlbGF0aXZlIHRvIHRoZSB1aSwgYW5kIHByZXBlbmQgYSBgLi9gXG4gICAgaWYgKGdyYXBocWxQYXRoLnN0YXJ0c1dpdGgoJy4nKSkge1xuICAgICAgcmV0dXJuIGdyYXBocWxQYXRoO1xuICAgIH1cbiAgICByZXR1cm4gYC4vJHtncmFwaHFsUGF0aH1gO1xuICB9O1xuXG4gIHByaXZhdGUgY3JlYXRlVWlCdWlsZGVyRm9ybSA9IChcbiAgICBzY2hlbWE6IFN0dWRpb0Zvcm0sXG4gICAgZGF0YVNjaGVtYT86IEdlbmVyaWNEYXRhU2NoZW1hLFxuICAgIGZvcm1GZWF0dXJlRmxhZ3M/OiBGb3JtRmVhdHVyZUZsYWdzLFxuICApID0+IHtcbiAgICBjb25zdCByZW5kZXJlciA9IG5ldyBBbXBsaWZ5Rm9ybVJlbmRlcmVyKFxuICAgICAgc2NoZW1hLFxuICAgICAgZGF0YVNjaGVtYSxcbiAgICAgIHRoaXMuY29uZmlnLFxuICAgICAgZm9ybUZlYXR1cmVGbGFncyxcbiAgICApO1xuICAgIGNvbnN0IHsgY29tcG9uZW50VGV4dCwgZGVjbGFyYXRpb24gfSA9IHJlbmRlcmVyLnJlbmRlckNvbXBvbmVudEludGVybmFsKCk7XG4gICAgY29uc3QgZmlsZXMgPSBbXG4gICAgICB7XG4gICAgICAgIGNvbXBvbmVudFRleHQsXG4gICAgICAgIGZpbGVOYW1lOiByZW5kZXJlci5maWxlTmFtZSxcbiAgICAgIH0sXG4gICAgXTtcbiAgICBpZiAoZGVjbGFyYXRpb24pIHtcbiAgICAgIGZpbGVzLnB1c2goe1xuICAgICAgICBjb21wb25lbnRUZXh0OiBkZWNsYXJhdGlvbixcbiAgICAgICAgZmlsZU5hbWU6IGdldERlY2xhcmF0aW9uRmlsZW5hbWUocmVuZGVyZXIuZmlsZU5hbWUpLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZpbGVzO1xuICB9O1xuICBwcml2YXRlIGZpbHRlck1vZGVsc0J5TmFtZSA9IChcbiAgICBmaWx0ZXJlZE1vZGVsTmFtZXM6IHN0cmluZ1tdLFxuICAgIHNjaGVtYU1vZGVsOiBNb2RlbFJlY29yZCxcbiAgKSA9PiB7XG4gICAgY29uc3QgbG93ZXJDYXNlTW9kZWxLZXlzID0gbmV3IFNldChcbiAgICAgIE9iamVjdC5rZXlzKHNjaGVtYU1vZGVsKS5tYXAoKGspID0+IGsudG9Mb3dlckNhc2UoKSksXG4gICAgKTtcbiAgICBjb25zdCBtb2RlbEVudHJpZXMgPSBPYmplY3QuZW50cmllcyhzY2hlbWFNb2RlbCk7XG4gICAgcmV0dXJuIGZpbHRlcmVkTW9kZWxOYW1lcy5yZWR1Y2U8QXJyYXk8W3N0cmluZywgRm9ybURlZl0+PihcbiAgICAgIChwcmV2LCBtb2RlbCkgPT4ge1xuICAgICAgICBpZiAobG93ZXJDYXNlTW9kZWxLZXlzPy5oYXMobW9kZWwudG9Mb3dlckNhc2UoKSkpIHtcbiAgICAgICAgICBjb25zdCBlbnRyeSA9IG1vZGVsRW50cmllcy5maW5kKFxuICAgICAgICAgICAgKFtrZXldKSA9PiBrZXkudG9Mb3dlckNhc2UoKSA9PT0gbW9kZWwudG9Mb3dlckNhc2UoKSxcbiAgICAgICAgICApO1xuICAgICAgICAgIGlmICghZW50cnkpIHtcbiAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAYXdzLWFtcGxpZnkvYW1wbGlmeS1iYWNrZW5kLXJ1bGVzL3ByZWZlci1hbXBsaWZ5LWVycm9yc1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgZmluZCBzcGVjaWZpZWQgbW9kZWwgJHttb2RlbH1gKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcHJldi5wdXNoKGVudHJ5KTtcbiAgICAgICAgICByZXR1cm4gcHJldjtcbiAgICAgICAgfVxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQGF3cy1hbXBsaWZ5L2FtcGxpZnktYmFja2VuZC1ydWxlcy9wcmVmZXItYW1wbGlmeS1lcnJvcnNcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgZmluZCBzcGVjaWZpZWQgbW9kZWwgJHttb2RlbH1gKTtcbiAgICAgIH0sXG4gICAgICBbXSxcbiAgICApO1xuICB9O1xuICBwcml2YXRlIGNvZGVnZW5Gb3JtID0gKFxuICAgIGRhdGFTY2hlbWE6IEdlbmVyaWNEYXRhU2NoZW1hLFxuICAgIGZvcm1TY2hlbWE6IFN0dWRpb0Zvcm0sXG4gICkgPT4ge1xuICAgIHJldHVybiB0aGlzLmNyZWF0ZVVpQnVpbGRlckZvcm0oZm9ybVNjaGVtYSwgZGF0YVNjaGVtYSwge30pO1xuICB9O1xuXG4gIHByaXZhdGUgZ2V0RmlsdGVyZWRNb2RlbHMgPSAoXG4gICAgZGF0YVNjaGVtYTogR2VuZXJpY0RhdGFTY2hlbWEsXG4gICAgZmlsdGVyZWRNb2RlbE5hbWVzPzogc3RyaW5nW10sXG4gICkgPT4ge1xuICAgIGNvbnN0IG1vZGVsTWFwID0gdGhpcy5nZXRNb2RlbE1hcEZvckRhdGFTY2hlbWEoZGF0YVNjaGVtYSk7XG4gICAgY29uc3QgZmlsdGVyZWRNb2RlbHM6IEFycmF5PFtzdHJpbmcsIEZvcm1EZWZdPiA9IFtdO1xuICAgIGlmICghZmlsdGVyZWRNb2RlbE5hbWVzIHx8ICFmaWx0ZXJlZE1vZGVsTmFtZXM/Lmxlbmd0aCkge1xuICAgICAgZmlsdGVyZWRNb2RlbHMucHVzaCguLi5PYmplY3QuZW50cmllcyhtb2RlbE1hcCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBmaWx0ZXJlZE1vZGVscy5wdXNoKFxuICAgICAgICAuLi50aGlzLmZpbHRlck1vZGVsc0J5TmFtZShmaWx0ZXJlZE1vZGVsTmFtZXMsIG1vZGVsTWFwKSxcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBmaWx0ZXJlZE1vZGVscztcbiAgfTtcbiAgcHJpdmF0ZSB0cmFuc2Zvcm1Nb2RlbExpc3RUb01hcCA9IChtb2RlbHM6IEFycmF5PFtzdHJpbmcsIEZvcm1EZWZdPikgPT4ge1xuICAgIHJldHVybiBtb2RlbHMucmVkdWNlKFxuICAgICAgKHByZXYsIFtrZXksIHZhbHVlXSkgPT4gKHsgLi4ucHJldiwgW2tleV06IHZhbHVlIH0pLFxuICAgICAge30sXG4gICAgKTtcbiAgfTtcblxuICBwcml2YXRlIGNyZWF0ZVV0aWxGaWxlID0gKHV0aWxzOiBVdGlsVGVtcGxhdGVUeXBlW10pID0+IHtcbiAgICBjb25zdCByZW5kZXJlciA9IG5ldyBSZWFjdFV0aWxzU3R1ZGlvVGVtcGxhdGVSZW5kZXJlcih1dGlscywgdGhpcy5jb25maWcpO1xuICAgIGNvbnN0IHsgY29tcG9uZW50VGV4dCB9ID0gcmVuZGVyZXIucmVuZGVyQ29tcG9uZW50SW50ZXJuYWwoKTtcbiAgICByZXR1cm4ge1xuICAgICAgY29tcG9uZW50VGV4dCxcbiAgICAgIGZpbGVOYW1lOiByZW5kZXJlci5maWxlTmFtZSxcbiAgICB9O1xuICB9O1xuXG4gIC8qKlxuICAgKiBSZXR1cm4gdXRpbHMgZmlsZSB0ZXh0XG4gICAqL1xuICBwcml2YXRlIGdlbmVyYXRlVXRpbEZpbGUgPSAoKSA9PiB7XG4gICAgY29uc3QgdXRpbHM6IFV0aWxUZW1wbGF0ZVR5cGVbXSA9IFtcbiAgICAgICd2YWxpZGF0aW9uJyxcbiAgICAgICdmb3JtYXR0ZXInLFxuICAgICAgJ2ZldGNoQnlQYXRoJyxcbiAgICAgICdwcm9jZXNzRmlsZScsXG4gICAgXTtcbiAgICBjb25zdCB7IGNvbXBvbmVudFRleHQsIGZpbGVOYW1lIH0gPSB0aGlzLmNyZWF0ZVV0aWxGaWxlKHV0aWxzKTtcbiAgICByZXR1cm4ge1xuICAgICAgc2NoZW1hTmFtZTogJ0FtcGxpZnlTdHVkaW9VdGlsRmlsZScsXG4gICAgICBjb21wb25lbnRUZXh0LFxuICAgICAgZmlsZU5hbWUsXG4gICAgICBkZWNsYXJhdGlvbjogdW5kZWZpbmVkLFxuICAgICAgZXJyb3I6IHVuZGVmaW5lZCxcbiAgICB9O1xuICB9O1xuXG4gIHByaXZhdGUgY3JlYXRlSW5kZXhGaWxlID0gKHNjaGVtYXM6IFN0dWRpb1NjaGVtYVtdKSA9PiB7XG4gICAgY29uc3QgcmVuZGVyZXIgPSBuZXcgUmVhY3RJbmRleFN0dWRpb1RlbXBsYXRlUmVuZGVyZXIoXG4gICAgICBzY2hlbWFzLFxuICAgICAgTG9jYWxHcmFwaHFsRm9ybUdlbmVyYXRvci5kZWZhdWx0Q29uZmlnLFxuICAgICk7XG4gICAgY29uc3QgeyBjb21wb25lbnRUZXh0IH0gPSByZW5kZXJlci5yZW5kZXJDb21wb25lbnRJbnRlcm5hbCgpO1xuICAgIHJldHVybiB7XG4gICAgICBjb21wb25lbnRUZXh0LFxuICAgICAgZmlsZU5hbWU6IHJlbmRlcmVyLmZpbGVOYW1lLFxuICAgIH07XG4gIH07XG59XG4iXX0=