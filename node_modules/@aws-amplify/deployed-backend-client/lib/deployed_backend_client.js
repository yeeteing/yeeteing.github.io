import { BackendIdentifierConversions } from '@aws-amplify/platform-core';
import { DeleteStackCommand, DescribeStacksCommand, ListStackResourcesCommand, ListStacksCommand, StackStatus, } from '@aws-sdk/client-cloudformation';
import { GetObjectCommand } from '@aws-sdk/client-s3';
import { authOutputKey, functionOutputKey, graphqlOutputKey, platformOutputKey, storageOutputKey, } from '@aws-amplify/backend-output-schemas';
/**
 * Deployment Client
 */
export class DefaultDeployedBackendClient {
    cfnClient;
    s3Client;
    backendOutputClient;
    deployedResourcesEnumerator;
    stackStatusMapper;
    arnParser;
    /**
     * Constructor for deployment client
     */
    constructor(cfnClient, s3Client, backendOutputClient, deployedResourcesEnumerator, stackStatusMapper, arnParser) {
        this.cfnClient = cfnClient;
        this.s3Client = s3Client;
        this.backendOutputClient = backendOutputClient;
        this.deployedResourcesEnumerator = deployedResourcesEnumerator;
        this.stackStatusMapper = stackStatusMapper;
        this.arnParser = arnParser;
    }
    /**
     * Deletes a sandbox with the specified id
     */
    deleteSandbox = async (sandboxBackendIdentifier) => {
        const stackName = BackendIdentifierConversions.toStackName({
            ...sandboxBackendIdentifier,
            type: 'sandbox',
        });
        await this.cfnClient.send(new DeleteStackCommand({ StackName: stackName }));
    };
    /**
     * Fetches all backend metadata for a specified backend
     */
    getBackendMetadata = async (backendId) => {
        const stackName = BackendIdentifierConversions.toStackName(backendId);
        return this.buildBackendMetadata(stackName);
    };
    listBackends = (listBackendsRequest) => {
        const backends = this.listBackendsInternal(listBackendsRequest);
        return {
            getBackendSummaryByPage: () => backends,
        };
    };
    /**
     * Returns a list of stacks for specific deployment type and status
     * @yields
     */
    async *listBackendsInternal(listBackendsRequest) {
        const stackMetadata = [];
        let nextToken;
        const deploymentType = listBackendsRequest?.deploymentType;
        const statusFilter = listBackendsRequest?.backendStatusFilters
            ? listBackendsRequest?.backendStatusFilters
            : [];
        do {
            const listStacksResponse = await this.listStacks(nextToken, statusFilter);
            const stackMetadataPromises = listStacksResponse.stackSummaries
                .filter((stackSummary) => {
                return (this.getBackendStackType(stackSummary.StackName) === deploymentType);
            })
                .map(async (stackSummary) => {
                const deploymentType = await this.tryGetDeploymentType(stackSummary);
                return {
                    name: stackSummary.StackName,
                    backendId: BackendIdentifierConversions.fromStackName(stackSummary.StackName),
                    lastUpdated: stackSummary.LastUpdatedTime ?? stackSummary.CreationTime,
                    status: this.stackStatusMapper.translateStackStatus(stackSummary.StackStatus),
                    deploymentType,
                };
            });
            const stackMetadataResolvedPromises = await Promise.all(stackMetadataPromises);
            const filteredMetadata = stackMetadataResolvedPromises.filter((stackMetadata) => stackMetadata.deploymentType === deploymentType);
            stackMetadata.push(...filteredMetadata);
            nextToken = listStacksResponse.nextToken;
            if (stackMetadata.length !== 0) {
                yield stackMetadata;
            }
        } while (stackMetadata.length === 0 && nextToken);
    }
    getBackendStackType = (stackName) => {
        const backendIdentifier = BackendIdentifierConversions.fromStackName(stackName);
        return backendIdentifier?.type;
    };
    tryGetDeploymentType = async (stackSummary) => {
        const stackDescription = await this.cfnClient.send(new DescribeStacksCommand({ StackName: stackSummary.StackName }));
        return stackDescription.Stacks?.[0].Tags?.find((tag) => tag.Key === 'amplify:deployment-type')?.Value;
    };
    listStacks = async (nextToken, stackStatusFilter) => {
        const stacks = await this.cfnClient.send(new ListStacksCommand({
            NextToken: nextToken,
            StackStatusFilter: stackStatusFilter.length > 0
                ? stackStatusFilter
                : Object.values(StackStatus).filter((status) => status !== StackStatus.DELETE_COMPLETE),
        }));
        nextToken = stacks.NextToken;
        return { stackSummaries: stacks.StackSummaries ?? [], nextToken };
    };
    buildBackendMetadata = async (stackName) => {
        const stackBackendIdentifier = {
            stackName,
        };
        const backendOutput = await this.backendOutputClient.getOutput(stackBackendIdentifier);
        const stackDescription = await this.cfnClient.send(new DescribeStacksCommand({ StackName: stackName }));
        const stack = stackDescription?.Stacks?.[0];
        const status = this.stackStatusMapper.translateStackStatus(stack?.StackStatus);
        const lastUpdated = stack?.LastUpdatedTime ?? stack?.CreationTime;
        const stackResources = await this.cfnClient.send(new ListStackResourcesCommand({
            StackName: stackName,
        }));
        const childStackPromises = stackResources.StackResourceSummaries?.filter((stackResourceSummary) => {
            return (stackResourceSummary.ResourceType === 'AWS::CloudFormation::Stack');
        }).map(async (stackResourceSummary) => {
            // arn:aws:{service}:{region}:{account}:stack/{stackName}/{additionalFields}
            const arnParts = stackResourceSummary.PhysicalResourceId?.split('/');
            const childStackName = arnParts?.[1];
            if (!childStackName) {
                return;
            }
            const stackDescription = await this.cfnClient.send(new DescribeStacksCommand({ StackName: childStackName }));
            const stack = stackDescription?.Stacks?.[0];
            return stack;
        }) ?? [];
        const childStacks = await Promise.all(childStackPromises);
        const authStack = childStacks.find((nestedStack) => nestedStack?.StackName?.includes('auth'));
        const storageStack = childStacks.find((nestedStack) => nestedStack?.StackName?.includes('storage'));
        const apiStack = childStacks.find((nestedStack) => nestedStack?.StackName?.includes('data'));
        const functionStack = childStacks.find((nestedStack) => nestedStack?.StackName?.includes('function'));
        // stack?.StackId is the ARN of the stack
        const { accountId, region } = this.arnParser.tryParseArn(stack?.StackId);
        const resources = await this.deployedResourcesEnumerator.listDeployedResources(this.cfnClient, stackName, accountId, region);
        const backendMetadataObject = {
            deploymentType: backendOutput[platformOutputKey].payload
                .deploymentType,
            lastUpdated,
            status,
            name: stackName,
            resources,
        };
        if (authStack) {
            backendMetadataObject.authConfiguration = {
                status: this.stackStatusMapper.translateStackStatus(authStack.StackStatus),
                lastUpdated: authStack.LastUpdatedTime ?? authStack.CreationTime,
                userPoolId: backendOutput[authOutputKey]?.payload.userPoolId,
            };
        }
        if (storageStack) {
            backendMetadataObject.storageConfiguration = {
                status: this.stackStatusMapper.translateStackStatus(storageStack.StackStatus),
                lastUpdated: storageStack.LastUpdatedTime ?? storageStack.CreationTime,
                s3BucketName: backendOutput[storageOutputKey]?.payload
                    .bucketName,
            };
        }
        if (apiStack) {
            const additionalAuthTypesString = backendOutput[graphqlOutputKey]?.payload
                .awsAppsyncAdditionalAuthenticationTypes;
            const additionalAuthTypes = additionalAuthTypesString
                ? additionalAuthTypesString.split(',')
                : [];
            backendMetadataObject.apiConfiguration = {
                status: this.stackStatusMapper.translateStackStatus(apiStack.StackStatus),
                lastUpdated: apiStack.LastUpdatedTime ?? apiStack.CreationTime,
                graphqlEndpoint: backendOutput[graphqlOutputKey]?.payload
                    .awsAppsyncApiEndpoint,
                defaultAuthType: backendOutput[graphqlOutputKey]?.payload
                    .awsAppsyncAuthenticationType,
                additionalAuthTypes,
                conflictResolutionMode: backendOutput[graphqlOutputKey]?.payload
                    .awsAppsyncConflictResolutionMode,
                apiId: backendOutput[graphqlOutputKey]?.payload
                    .awsAppsyncApiId,
                modelSchemaS3Uri: backendOutput[graphqlOutputKey]?.payload
                    .amplifyApiModelSchemaS3Uri,
            };
        }
        if (functionStack) {
            const functionResources = resources.filter((resource) => resource.resourceType === 'AWS::Lambda::Function');
            const functionConfigurations = [];
            const definedFunctionsString = backendOutput[functionOutputKey]?.payload.definedFunctions;
            const customerFunctionNames = definedFunctionsString
                ? JSON.parse(definedFunctionsString)
                : [];
            customerFunctionNames.forEach((functionName) => {
                const resource = functionResources.find((func) => func.physicalResourceId === functionName);
                if (resource) {
                    functionConfigurations.push({
                        status: this.stackStatusMapper.translateStackStatus(resource.resourceStatus),
                        lastUpdated: resource.lastUpdated ??
                            functionStack.LastUpdatedTime ??
                            functionStack.CreationTime,
                        functionName,
                    });
                }
            });
            backendMetadataObject.functionConfigurations = functionConfigurations;
        }
        return backendMetadataObject;
    };
    fetchSchema = async (schemaS3Uri) => {
        if (!schemaS3Uri) {
            throw new Error('schemaS3Uri output is not available');
        }
        // s3://{bucketName}/{fileName}
        const uriParts = schemaS3Uri.split('/');
        const bucketName = uriParts[2];
        const objectPath = uriParts.slice(3, uriParts.length).join('/');
        if (!bucketName || !objectPath) {
            throw new Error('schemaS3Uri is not valid');
        }
        const s3Response = await this.s3Client.send(new GetObjectCommand({ Bucket: bucketName, Key: objectPath }));
        if (!s3Response.Body) {
            throw new Error(`s3Response from ${schemaS3Uri} does not contain a Body`);
        }
        return await s3Response.Body?.transformToString();
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVwbG95ZWRfYmFja2VuZF9jbGllbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZGVwbG95ZWRfYmFja2VuZF9jbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBZ0JBLE9BQU8sRUFBRSw0QkFBNEIsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRTFFLE9BQU8sRUFFTCxrQkFBa0IsRUFDbEIscUJBQXFCLEVBQ3JCLHlCQUF5QixFQUN6QixpQkFBaUIsRUFJakIsV0FBVyxHQUVaLE1BQU0sZ0NBQWdDLENBQUM7QUFFeEMsT0FBTyxFQUFFLGdCQUFnQixFQUFZLE1BQU0sb0JBQW9CLENBQUM7QUFDaEUsT0FBTyxFQUNMLGFBQWEsRUFDYixpQkFBaUIsRUFDakIsZ0JBQWdCLEVBQ2hCLGlCQUFpQixFQUNqQixnQkFBZ0IsR0FDakIsTUFBTSxxQ0FBcUMsQ0FBQztBQUs3Qzs7R0FFRztBQUNILE1BQU0sT0FBTyw0QkFBNEI7SUFLcEI7SUFDQTtJQUNBO0lBQ0E7SUFDQTtJQUNBO0lBVG5COztPQUVHO0lBQ0gsWUFDbUIsU0FBK0IsRUFDL0IsUUFBa0IsRUFDbEIsbUJBQXdDLEVBQ3hDLDJCQUF3RCxFQUN4RCxpQkFBb0MsRUFDcEMsU0FBb0I7UUFMcEIsY0FBUyxHQUFULFNBQVMsQ0FBc0I7UUFDL0IsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO1FBQ3hDLGdDQUEyQixHQUEzQiwyQkFBMkIsQ0FBNkI7UUFDeEQsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQjtRQUNwQyxjQUFTLEdBQVQsU0FBUyxDQUFXO0lBQ3BDLENBQUM7SUFFSjs7T0FFRztJQUNILGFBQWEsR0FBRyxLQUFLLEVBQ25CLHdCQUF5RCxFQUMxQyxFQUFFO1FBQ2pCLE1BQU0sU0FBUyxHQUFHLDRCQUE0QixDQUFDLFdBQVcsQ0FBQztZQUN6RCxHQUFHLHdCQUF3QjtZQUMzQixJQUFJLEVBQUUsU0FBUztTQUNo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QUMsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFaEUsSUFBSSxDQUFDLFVBQVUsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQy9CLE1BQU0sSUFBSSxLQUFLLENBQUMsMEJBQTBCLENBQUMsQ0FBQztRQUM5QyxDQUFDO1FBRUQsTUFBTSxVQUFVLEdBQUcsTUFBTSxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FDekMsSUFBSSxnQkFBZ0IsQ0FBQyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLFVBQVUsRUFBRSxDQUFDLENBQzlELENBQUM7UUFFRixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ3JCLE1BQU0sSUFBSSxLQUFLLENBQUMsbUJBQW1CLFdBQVcsMEJBQTBCLENBQUMsQ0FBQztRQUM1RSxDQUFDO1FBRUQsT0FBTyxNQUFNLFVBQVUsQ0FBQyxJQUFJLEVBQUUsaUJBQWlCLEVBQUUsQ0FBQztJQUNwRCxDQUFDLENBQUM7Q0FDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEJhY2tlbmRJZGVudGlmaWVyLFxuICBCYWNrZW5kT3V0cHV0LFxuICBEZXBsb3ltZW50VHlwZSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQge1xuICBBcGlBdXRoVHlwZSxcbiAgQmFja2VuZE1ldGFkYXRhLFxuICBCYWNrZW5kU3RhdHVzLFxuICBCYWNrZW5kU3VtbWFyeU1ldGFkYXRhLFxuICBDb25mbGljdFJlc29sdXRpb25Nb2RlLFxuICBEZXBsb3llZEJhY2tlbmRDbGllbnQsXG4gIEZ1bmN0aW9uQ29uZmlndXJhdGlvbixcbiAgTGlzdEJhY2tlbmRzUmVxdWVzdCxcbiAgTGlzdEJhY2tlbmRzUmVzcG9uc2UsXG59IGZyb20gJy4vZGVwbG95ZWRfYmFja2VuZF9jbGllbnRfZmFjdG9yeS5qcyc7XG5pbXBvcnQgeyBCYWNrZW5kSWRlbnRpZmllckNvbnZlcnNpb25zIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsYXRmb3JtLWNvcmUnO1xuaW1wb3J0IHsgQmFja2VuZE91dHB1dENsaWVudCB9IGZyb20gJy4vYmFja2VuZF9vdXRwdXRfY2xpZW50X2ZhY3RvcnkuanMnO1xuaW1wb3J0IHtcbiAgQ2xvdWRGb3JtYXRpb25DbGllbnQsXG4gIERlbGV0ZVN0YWNrQ29tbWFuZCxcbiAgRGVzY3JpYmVTdGFja3NDb21tYW5kLFxuICBMaXN0U3RhY2tSZXNvdXJjZXNDb21tYW5kLFxuICBMaXN0U3RhY2tzQ29tbWFuZCxcbiAgTGlzdFN0YWNrc0NvbW1hbmRPdXRwdXQsXG4gIFN0YWNrLFxuICBTdGFja1Jlc291cmNlU3VtbWFyeSxcbiAgU3RhY2tTdGF0dXMsXG4gIFN0YWNrU3VtbWFyeSxcbn0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWNsb3VkZm9ybWF0aW9uJztcblxuaW1wb3J0IHsgR2V0T2JqZWN0Q29tbWFuZCwgUzNDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtczMnO1xuaW1wb3J0IHtcbiAgYXV0aE91dHB1dEtleSxcbiAgZnVuY3Rpb25PdXRwdXRLZXksXG4gIGdyYXBocWxPdXRwdXRLZXksXG4gIHBsYXRmb3JtT3V0cHV0S2V5LFxuICBzdG9yYWdlT3V0cHV0S2V5LFxufSBmcm9tICdAYXdzLWFtcGxpZnkvYmFja2VuZC1vdXRwdXQtc2NoZW1hcyc7XG5pbXBvcnQgeyBEZXBsb3llZFJlc291cmNlc0VudW1lcmF0b3IgfSBmcm9tICcuL2RlcGxveWVkLWJhY2tlbmQtY2xpZW50L2RlcGxveWVkX3Jlc291cmNlc19lbnVtZXJhdG9yLmpzJztcbmltcG9ydCB7IFN0YWNrU3RhdHVzTWFwcGVyIH0gZnJvbSAnLi9kZXBsb3llZC1iYWNrZW5kLWNsaWVudC9zdGFja19zdGF0dXNfbWFwcGVyLmpzJztcbmltcG9ydCB7IEFyblBhcnNlciB9IGZyb20gJy4vZGVwbG95ZWQtYmFja2VuZC1jbGllbnQvYXJuX3BhcnNlci5qcyc7XG5cbi8qKlxuICogRGVwbG95bWVudCBDbGllbnRcbiAqL1xuZXhwb3J0IGNsYXNzIERlZmF1bHREZXBsb3llZEJhY2tlbmRDbGllbnQgaW1wbGVtZW50cyBEZXBsb3llZEJhY2tlbmRDbGllbnQge1xuICAvKipcbiAgICogQ29uc3RydWN0b3IgZm9yIGRlcGxveW1lbnQgY2xpZW50XG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNmbkNsaWVudDogQ2xvdWRGb3JtYXRpb25DbGllbnQsXG4gICAgcHJpdmF0ZSByZWFkb25seSBzM0NsaWVudDogUzNDbGllbnQsXG4gICAgcHJpdmF0ZSByZWFkb25seSBiYWNrZW5kT3V0cHV0Q2xpZW50OiBCYWNrZW5kT3V0cHV0Q2xpZW50LFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZGVwbG95ZWRSZXNvdXJjZXNFbnVtZXJhdG9yOiBEZXBsb3llZFJlc291cmNlc0VudW1lcmF0b3IsXG4gICAgcHJpdmF0ZSByZWFkb25seSBzdGFja1N0YXR1c01hcHBlcjogU3RhY2tTdGF0dXNNYXBwZXIsXG4gICAgcHJpdmF0ZSByZWFkb25seSBhcm5QYXJzZXI6IEFyblBhcnNlcixcbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBEZWxldGVzIGEgc2FuZGJveCB3aXRoIHRoZSBzcGVjaWZpZWQgaWRcbiAgICovXG4gIGRlbGV0ZVNhbmRib3ggPSBhc3luYyAoXG4gICAgc2FuZGJveEJhY2tlbmRJZGVudGlmaWVyOiBPbWl0PEJhY2tlbmRJZGVudGlmaWVyLCAndHlwZSc+LFxuICApOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICBjb25zdCBzdGFja05hbWUgPSBCYWNrZW5kSWRlbnRpZmllckNvbnZlcnNpb25zLnRvU3RhY2tOYW1lKHtcbiAgICAgIC4uLnNhbmRib3hCYWNrZW5kSWRlbnRpZmllcixcbiAgICAgIHR5cGU6ICdzYW5kYm94JyxcbiAgICB9KTtcbiAgICBhd2FpdCB0aGlzLmNmbkNsaWVudC5zZW5kKG5ldyBEZWxldGVTdGFja0NvbW1hbmQoeyBTdGFja05hbWU6IHN0YWNrTmFtZSB9KSk7XG4gIH07XG4gIC8qKlxuICAgKiBGZXRjaGVzIGFsbCBiYWNrZW5kIG1ldGFkYXRhIGZvciBhIHNwZWNpZmllZCBiYWNrZW5kXG4gICAqL1xuICBnZXRCYWNrZW5kTWV0YWRhdGEgPSBhc3luYyAoXG4gICAgYmFja2VuZElkOiBCYWNrZW5kSWRlbnRpZmllcixcbiAgKTogUHJvbWlzZTxCYWNrZW5kTWV0YWRhdGE+ID0+IHtcbiAgICBjb25zdCBzdGFja05hbWUgPSBCYWNrZW5kSWRlbnRpZmllckNvbnZlcnNpb25zLnRvU3RhY2tOYW1lKGJhY2tlbmRJZCk7XG4gICAgcmV0dXJuIHRoaXMuYnVpbGRCYWNrZW5kTWV0YWRhdGEoc3RhY2tOYW1lKTtcbiAgfTtcblxuICBsaXN0QmFja2VuZHMgPSAoXG4gICAgbGlzdEJhY2tlbmRzUmVxdWVzdD86IExpc3RCYWNrZW5kc1JlcXVlc3QsXG4gICk6IExpc3RCYWNrZW5kc1Jlc3BvbnNlID0+IHtcbiAgICBjb25zdCBiYWNrZW5kcyA9IHRoaXMubGlzdEJhY2tlbmRzSW50ZXJuYWwobGlzdEJhY2tlbmRzUmVxdWVzdCk7XG4gICAgcmV0dXJuIHtcbiAgICAgIGdldEJhY2tlbmRTdW1tYXJ5QnlQYWdlOiAoKSA9PiBiYWNrZW5kcyxcbiAgICB9O1xuICB9O1xuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGEgbGlzdCBvZiBzdGFja3MgZm9yIHNwZWNpZmljIGRlcGxveW1lbnQgdHlwZSBhbmQgc3RhdHVzXG4gICAqIEB5aWVsZHNcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgKmxpc3RCYWNrZW5kc0ludGVybmFsKFxuICAgIGxpc3RCYWNrZW5kc1JlcXVlc3Q/OiBMaXN0QmFja2VuZHNSZXF1ZXN0LFxuICApIHtcbiAgICBjb25zdCBzdGFja01ldGFkYXRhOiBCYWNrZW5kU3VtbWFyeU1ldGFkYXRhW10gPSBbXTtcbiAgICBsZXQgbmV4dFRva2VuO1xuICAgIGNvbnN0IGRlcGxveW1lbnRUeXBlID0gbGlzdEJhY2tlbmRzUmVxdWVzdD8uZGVwbG95bWVudFR5cGU7XG4gICAgY29uc3Qgc3RhdHVzRmlsdGVyID0gbGlzdEJhY2tlbmRzUmVxdWVzdD8uYmFja2VuZFN0YXR1c0ZpbHRlcnNcbiAgICAgID8gbGlzdEJhY2tlbmRzUmVxdWVzdD8uYmFja2VuZFN0YXR1c0ZpbHRlcnNcbiAgICAgIDogW107XG4gICAgZG8ge1xuICAgICAgY29uc3QgbGlzdFN0YWNrc1Jlc3BvbnNlID0gYXdhaXQgdGhpcy5saXN0U3RhY2tzKG5leHRUb2tlbiwgc3RhdHVzRmlsdGVyKTtcblxuICAgICAgY29uc3Qgc3RhY2tNZXRhZGF0YVByb21pc2VzID0gbGlzdFN0YWNrc1Jlc3BvbnNlLnN0YWNrU3VtbWFyaWVzXG4gICAgICAgIC5maWx0ZXIoKHN0YWNrU3VtbWFyeTogU3RhY2tTdW1tYXJ5KSA9PiB7XG4gICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIHRoaXMuZ2V0QmFja2VuZFN0YWNrVHlwZShzdGFja1N1bW1hcnkuU3RhY2tOYW1lKSA9PT0gZGVwbG95bWVudFR5cGVcbiAgICAgICAgICApO1xuICAgICAgICB9KVxuICAgICAgICAubWFwKGFzeW5jIChzdGFja1N1bW1hcnk6IFN0YWNrU3VtbWFyeSkgPT4ge1xuICAgICAgICAgIGNvbnN0IGRlcGxveW1lbnRUeXBlID0gYXdhaXQgdGhpcy50cnlHZXREZXBsb3ltZW50VHlwZShzdGFja1N1bW1hcnkpO1xuXG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIG5hbWU6IHN0YWNrU3VtbWFyeS5TdGFja05hbWUgYXMgc3RyaW5nLFxuICAgICAgICAgICAgYmFja2VuZElkOiBCYWNrZW5kSWRlbnRpZmllckNvbnZlcnNpb25zLmZyb21TdGFja05hbWUoXG4gICAgICAgICAgICAgIHN0YWNrU3VtbWFyeS5TdGFja05hbWUsXG4gICAgICAgICAgICApLFxuICAgICAgICAgICAgbGFzdFVwZGF0ZWQ6XG4gICAgICAgICAgICAgIHN0YWNrU3VtbWFyeS5MYXN0VXBkYXRlZFRpbWUgPz8gc3RhY2tTdW1tYXJ5LkNyZWF0aW9uVGltZSxcbiAgICAgICAgICAgIHN0YXR1czogdGhpcy5zdGFja1N0YXR1c01hcHBlci50cmFuc2xhdGVTdGFja1N0YXR1cyhcbiAgICAgICAgICAgICAgc3RhY2tTdW1tYXJ5LlN0YWNrU3RhdHVzLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIGRlcGxveW1lbnRUeXBlLFxuICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuXG4gICAgICBjb25zdCBzdGFja01ldGFkYXRhUmVzb2x2ZWRQcm9taXNlcyA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgICBzdGFja01ldGFkYXRhUHJvbWlzZXMsXG4gICAgICApO1xuICAgICAgY29uc3QgZmlsdGVyZWRNZXRhZGF0YSA9IHN0YWNrTWV0YWRhdGFSZXNvbHZlZFByb21pc2VzLmZpbHRlcihcbiAgICAgICAgKHN0YWNrTWV0YWRhdGEpID0+IHN0YWNrTWV0YWRhdGEuZGVwbG95bWVudFR5cGUgPT09IGRlcGxveW1lbnRUeXBlLFxuICAgICAgKTtcblxuICAgICAgc3RhY2tNZXRhZGF0YS5wdXNoKC4uLmZpbHRlcmVkTWV0YWRhdGEpO1xuICAgICAgbmV4dFRva2VuID0gbGlzdFN0YWNrc1Jlc3BvbnNlLm5leHRUb2tlbjtcblxuICAgICAgaWYgKHN0YWNrTWV0YWRhdGEubGVuZ3RoICE9PSAwKSB7XG4gICAgICAgIHlpZWxkIHN0YWNrTWV0YWRhdGE7XG4gICAgICB9XG4gICAgfSB3aGlsZSAoc3RhY2tNZXRhZGF0YS5sZW5ndGggPT09IDAgJiYgbmV4dFRva2VuKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0QmFja2VuZFN0YWNrVHlwZSA9IChcbiAgICBzdGFja05hbWU6IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgKTogc3RyaW5nIHwgdW5kZWZpbmVkID0+IHtcbiAgICBjb25zdCBiYWNrZW5kSWRlbnRpZmllciA9XG4gICAgICBCYWNrZW5kSWRlbnRpZmllckNvbnZlcnNpb25zLmZyb21TdGFja05hbWUoc3RhY2tOYW1lKTtcbiAgICByZXR1cm4gYmFja2VuZElkZW50aWZpZXI/LnR5cGU7XG4gIH07XG5cbiAgcHJpdmF0ZSB0cnlHZXREZXBsb3ltZW50VHlwZSA9IGFzeW5jIChcbiAgICBzdGFja1N1bW1hcnk6IFN0YWNrU3VtbWFyeSxcbiAgKTogUHJvbWlzZTxEZXBsb3ltZW50VHlwZSB8IHVuZGVmaW5lZD4gPT4ge1xuICAgIGNvbnN0IHN0YWNrRGVzY3JpcHRpb24gPSBhd2FpdCB0aGlzLmNmbkNsaWVudC5zZW5kKFxuICAgICAgbmV3IERlc2NyaWJlU3RhY2tzQ29tbWFuZCh7IFN0YWNrTmFtZTogc3RhY2tTdW1tYXJ5LlN0YWNrTmFtZSB9KSxcbiAgICApO1xuXG4gICAgcmV0dXJuIHN0YWNrRGVzY3JpcHRpb24uU3RhY2tzPy5bMF0uVGFncz8uZmluZChcbiAgICAgICh0YWcpID0+IHRhZy5LZXkgPT09ICdhbXBsaWZ5OmRlcGxveW1lbnQtdHlwZScsXG4gICAgKT8uVmFsdWUgYXMgRGVwbG95bWVudFR5cGU7XG4gIH07XG5cbiAgcHJpdmF0ZSBsaXN0U3RhY2tzID0gYXN5bmMgKFxuICAgIG5leHRUb2tlbjogc3RyaW5nIHwgdW5kZWZpbmVkLFxuICAgIHN0YWNrU3RhdHVzRmlsdGVyOiBCYWNrZW5kU3RhdHVzW10sXG4gICk6IFByb21pc2U8e1xuICAgIHN0YWNrU3VtbWFyaWVzOiBTdGFja1N1bW1hcnlbXTtcbiAgICBuZXh0VG9rZW46IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgfT4gPT4ge1xuICAgIGNvbnN0IHN0YWNrczogTGlzdFN0YWNrc0NvbW1hbmRPdXRwdXQgPSBhd2FpdCB0aGlzLmNmbkNsaWVudC5zZW5kKFxuICAgICAgbmV3IExpc3RTdGFja3NDb21tYW5kKHtcbiAgICAgICAgTmV4dFRva2VuOiBuZXh0VG9rZW4sXG4gICAgICAgIFN0YWNrU3RhdHVzRmlsdGVyOlxuICAgICAgICAgIHN0YWNrU3RhdHVzRmlsdGVyLmxlbmd0aCA+IDBcbiAgICAgICAgICAgID8gc3RhY2tTdGF0dXNGaWx0ZXJcbiAgICAgICAgICAgIDogT2JqZWN0LnZhbHVlcyhTdGFja1N0YXR1cykuZmlsdGVyKFxuICAgICAgICAgICAgICAgIChzdGF0dXMpID0+IHN0YXR1cyAhPT0gU3RhY2tTdGF0dXMuREVMRVRFX0NPTVBMRVRFLFxuICAgICAgICAgICAgICApLFxuICAgICAgfSksXG4gICAgKTtcbiAgICBuZXh0VG9rZW4gPSBzdGFja3MuTmV4dFRva2VuO1xuICAgIHJldHVybiB7IHN0YWNrU3VtbWFyaWVzOiBzdGFja3MuU3RhY2tTdW1tYXJpZXMgPz8gW10sIG5leHRUb2tlbiB9O1xuICB9O1xuXG4gIHByaXZhdGUgYnVpbGRCYWNrZW5kTWV0YWRhdGEgPSBhc3luYyAoXG4gICAgc3RhY2tOYW1lOiBzdHJpbmcsXG4gICk6IFByb21pc2U8QmFja2VuZE1ldGFkYXRhPiA9PiB7XG4gICAgY29uc3Qgc3RhY2tCYWNrZW5kSWRlbnRpZmllciA9IHtcbiAgICAgIHN0YWNrTmFtZSxcbiAgICB9O1xuXG4gICAgY29uc3QgYmFja2VuZE91dHB1dDogQmFja2VuZE91dHB1dCA9XG4gICAgICBhd2FpdCB0aGlzLmJhY2tlbmRPdXRwdXRDbGllbnQuZ2V0T3V0cHV0KHN0YWNrQmFja2VuZElkZW50aWZpZXIpO1xuICAgIGNvbnN0IHN0YWNrRGVzY3JpcHRpb24gPSBhd2FpdCB0aGlzLmNmbkNsaWVudC5zZW5kKFxuICAgICAgbmV3IERlc2NyaWJlU3RhY2tzQ29tbWFuZCh7IFN0YWNrTmFtZTogc3RhY2tOYW1lIH0pLFxuICAgICk7XG4gICAgY29uc3Qgc3RhY2sgPSBzdGFja0Rlc2NyaXB0aW9uPy5TdGFja3M/LlswXTtcbiAgICBjb25zdCBzdGF0dXMgPSB0aGlzLnN0YWNrU3RhdHVzTWFwcGVyLnRyYW5zbGF0ZVN0YWNrU3RhdHVzKFxuICAgICAgc3RhY2s/LlN0YWNrU3RhdHVzLFxuICAgICk7XG4gICAgY29uc3QgbGFzdFVwZGF0ZWQgPSBzdGFjaz8uTGFzdFVwZGF0ZWRUaW1lID8/IHN0YWNrPy5DcmVhdGlvblRpbWU7XG5cbiAgICBjb25zdCBzdGFja1Jlc291cmNlcyA9IGF3YWl0IHRoaXMuY2ZuQ2xpZW50LnNlbmQoXG4gICAgICBuZXcgTGlzdFN0YWNrUmVzb3VyY2VzQ29tbWFuZCh7XG4gICAgICAgIFN0YWNrTmFtZTogc3RhY2tOYW1lLFxuICAgICAgfSksXG4gICAgKTtcbiAgICBjb25zdCBjaGlsZFN0YWNrUHJvbWlzZXM6IFByb21pc2U8U3RhY2sgfCB1bmRlZmluZWQ+W10gPVxuICAgICAgc3RhY2tSZXNvdXJjZXMuU3RhY2tSZXNvdXJjZVN1bW1hcmllcz8uZmlsdGVyKFxuICAgICAgICAoc3RhY2tSZXNvdXJjZVN1bW1hcnk6IFN0YWNrUmVzb3VyY2VTdW1tYXJ5KSA9PiB7XG4gICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIHN0YWNrUmVzb3VyY2VTdW1tYXJ5LlJlc291cmNlVHlwZSA9PT0gJ0FXUzo6Q2xvdWRGb3JtYXRpb246OlN0YWNrJ1xuICAgICAgICAgICk7XG4gICAgICAgIH0sXG4gICAgICApLm1hcChhc3luYyAoc3RhY2tSZXNvdXJjZVN1bW1hcnk6IFN0YWNrUmVzb3VyY2VTdW1tYXJ5KSA9PiB7XG4gICAgICAgIC8vIGFybjphd3M6e3NlcnZpY2V9OntyZWdpb259OnthY2NvdW50fTpzdGFjay97c3RhY2tOYW1lfS97YWRkaXRpb25hbEZpZWxkc31cbiAgICAgICAgY29uc3QgYXJuUGFydHMgPSBzdGFja1Jlc291cmNlU3VtbWFyeS5QaHlzaWNhbFJlc291cmNlSWQ/LnNwbGl0KCcvJyk7XG4gICAgICAgIGNvbnN0IGNoaWxkU3RhY2tOYW1lID0gYXJuUGFydHM/LlsxXTtcbiAgICAgICAgaWYgKCFjaGlsZFN0YWNrTmFtZSkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBzdGFja0Rlc2NyaXB0aW9uID0gYXdhaXQgdGhpcy5jZm5DbGllbnQuc2VuZChcbiAgICAgICAgICBuZXcgRGVzY3JpYmVTdGFja3NDb21tYW5kKHsgU3RhY2tOYW1lOiBjaGlsZFN0YWNrTmFtZSB9KSxcbiAgICAgICAgKTtcblxuICAgICAgICBjb25zdCBzdGFjayA9IHN0YWNrRGVzY3JpcHRpb24/LlN0YWNrcz8uWzBdO1xuICAgICAgICByZXR1cm4gc3RhY2s7XG4gICAgICB9KSA/PyBbXTtcblxuICAgIGNvbnN0IGNoaWxkU3RhY2tzID0gYXdhaXQgUHJvbWlzZS5hbGwoY2hpbGRTdGFja1Byb21pc2VzKTtcbiAgICBjb25zdCBhdXRoU3RhY2sgPSBjaGlsZFN0YWNrcy5maW5kKFxuICAgICAgKG5lc3RlZFN0YWNrOiBTdGFja1N1bW1hcnkgfCB1bmRlZmluZWQpID0+XG4gICAgICAgIG5lc3RlZFN0YWNrPy5TdGFja05hbWU/LmluY2x1ZGVzKCdhdXRoJyksXG4gICAgKTtcbiAgICBjb25zdCBzdG9yYWdlU3RhY2sgPSBjaGlsZFN0YWNrcy5maW5kKFxuICAgICAgKG5lc3RlZFN0YWNrOiBTdGFja1N1bW1hcnkgfCB1bmRlZmluZWQpID0+XG4gICAgICAgIG5lc3RlZFN0YWNrPy5TdGFja05hbWU/LmluY2x1ZGVzKCdzdG9yYWdlJyksXG4gICAgKTtcbiAgICBjb25zdCBhcGlTdGFjayA9IGNoaWxkU3RhY2tzLmZpbmQoKG5lc3RlZFN0YWNrOiBTdGFja1N1bW1hcnkgfCB1bmRlZmluZWQpID0+XG4gICAgICBuZXN0ZWRTdGFjaz8uU3RhY2tOYW1lPy5pbmNsdWRlcygnZGF0YScpLFxuICAgICk7XG4gICAgY29uc3QgZnVuY3Rpb25TdGFjayA9IGNoaWxkU3RhY2tzLmZpbmQoXG4gICAgICAobmVzdGVkU3RhY2s6IFN0YWNrU3VtbWFyeSB8IHVuZGVmaW5lZCkgPT5cbiAgICAgICAgbmVzdGVkU3RhY2s/LlN0YWNrTmFtZT8uaW5jbHVkZXMoJ2Z1bmN0aW9uJyksXG4gICAgKTtcblxuICAgIC8vIHN0YWNrPy5TdGFja0lkIGlzIHRoZSBBUk4gb2YgdGhlIHN0YWNrXG4gICAgY29uc3QgeyBhY2NvdW50SWQsIHJlZ2lvbiB9ID0gdGhpcy5hcm5QYXJzZXIudHJ5UGFyc2VBcm4oXG4gICAgICBzdGFjaz8uU3RhY2tJZCBhcyBzdHJpbmcsXG4gICAgKTtcbiAgICBjb25zdCByZXNvdXJjZXMgPVxuICAgICAgYXdhaXQgdGhpcy5kZXBsb3llZFJlc291cmNlc0VudW1lcmF0b3IubGlzdERlcGxveWVkUmVzb3VyY2VzKFxuICAgICAgICB0aGlzLmNmbkNsaWVudCxcbiAgICAgICAgc3RhY2tOYW1lLFxuICAgICAgICBhY2NvdW50SWQsXG4gICAgICAgIHJlZ2lvbixcbiAgICAgICk7XG5cbiAgICBjb25zdCBiYWNrZW5kTWV0YWRhdGFPYmplY3Q6IEJhY2tlbmRNZXRhZGF0YSA9IHtcbiAgICAgIGRlcGxveW1lbnRUeXBlOiBiYWNrZW5kT3V0cHV0W3BsYXRmb3JtT3V0cHV0S2V5XS5wYXlsb2FkXG4gICAgICAgIC5kZXBsb3ltZW50VHlwZSBhcyBEZXBsb3ltZW50VHlwZSxcbiAgICAgIGxhc3RVcGRhdGVkLFxuICAgICAgc3RhdHVzLFxuICAgICAgbmFtZTogc3RhY2tOYW1lLFxuICAgICAgcmVzb3VyY2VzLFxuICAgIH07XG5cbiAgICBpZiAoYXV0aFN0YWNrKSB7XG4gICAgICBiYWNrZW5kTWV0YWRhdGFPYmplY3QuYXV0aENvbmZpZ3VyYXRpb24gPSB7XG4gICAgICAgIHN0YXR1czogdGhpcy5zdGFja1N0YXR1c01hcHBlci50cmFuc2xhdGVTdGFja1N0YXR1cyhcbiAgICAgICAgICBhdXRoU3RhY2suU3RhY2tTdGF0dXMsXG4gICAgICAgICksXG4gICAgICAgIGxhc3RVcGRhdGVkOiBhdXRoU3RhY2suTGFzdFVwZGF0ZWRUaW1lID8/IGF1dGhTdGFjay5DcmVhdGlvblRpbWUsXG4gICAgICAgIHVzZXJQb29sSWQ6IGJhY2tlbmRPdXRwdXRbYXV0aE91dHB1dEtleV0/LnBheWxvYWQudXNlclBvb2xJZCBhcyBzdHJpbmcsXG4gICAgICB9O1xuICAgIH1cblxuICAgIGlmIChzdG9yYWdlU3RhY2spIHtcbiAgICAgIGJhY2tlbmRNZXRhZGF0YU9iamVjdC5zdG9yYWdlQ29uZmlndXJhdGlvbiA9IHtcbiAgICAgICAgc3RhdHVzOiB0aGlzLnN0YWNrU3RhdHVzTWFwcGVyLnRyYW5zbGF0ZVN0YWNrU3RhdHVzKFxuICAgICAgICAgIHN0b3JhZ2VTdGFjay5TdGFja1N0YXR1cyxcbiAgICAgICAgKSxcbiAgICAgICAgbGFzdFVwZGF0ZWQ6IHN0b3JhZ2VTdGFjay5MYXN0VXBkYXRlZFRpbWUgPz8gc3RvcmFnZVN0YWNrLkNyZWF0aW9uVGltZSxcbiAgICAgICAgczNCdWNrZXROYW1lOiBiYWNrZW5kT3V0cHV0W3N0b3JhZ2VPdXRwdXRLZXldPy5wYXlsb2FkXG4gICAgICAgICAgLmJ1Y2tldE5hbWUgYXMgc3RyaW5nLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAoYXBpU3RhY2spIHtcbiAgICAgIGNvbnN0IGFkZGl0aW9uYWxBdXRoVHlwZXNTdHJpbmcgPSBiYWNrZW5kT3V0cHV0W2dyYXBocWxPdXRwdXRLZXldPy5wYXlsb2FkXG4gICAgICAgIC5hd3NBcHBzeW5jQWRkaXRpb25hbEF1dGhlbnRpY2F0aW9uVHlwZXMgYXMgc3RyaW5nO1xuICAgICAgY29uc3QgYWRkaXRpb25hbEF1dGhUeXBlcyA9IGFkZGl0aW9uYWxBdXRoVHlwZXNTdHJpbmdcbiAgICAgICAgPyAoYWRkaXRpb25hbEF1dGhUeXBlc1N0cmluZy5zcGxpdCgnLCcpIGFzIEFwaUF1dGhUeXBlW10pXG4gICAgICAgIDogW107XG4gICAgICBiYWNrZW5kTWV0YWRhdGFPYmplY3QuYXBpQ29uZmlndXJhdGlvbiA9IHtcbiAgICAgICAgc3RhdHVzOiB0aGlzLnN0YWNrU3RhdHVzTWFwcGVyLnRyYW5zbGF0ZVN0YWNrU3RhdHVzKFxuICAgICAgICAgIGFwaVN0YWNrLlN0YWNrU3RhdHVzLFxuICAgICAgICApLFxuICAgICAgICBsYXN0VXBkYXRlZDogYXBpU3RhY2suTGFzdFVwZGF0ZWRUaW1lID8/IGFwaVN0YWNrLkNyZWF0aW9uVGltZSxcbiAgICAgICAgZ3JhcGhxbEVuZHBvaW50OiBiYWNrZW5kT3V0cHV0W2dyYXBocWxPdXRwdXRLZXldPy5wYXlsb2FkXG4gICAgICAgICAgLmF3c0FwcHN5bmNBcGlFbmRwb2ludCBhcyBzdHJpbmcsXG4gICAgICAgIGRlZmF1bHRBdXRoVHlwZTogYmFja2VuZE91dHB1dFtncmFwaHFsT3V0cHV0S2V5XT8ucGF5bG9hZFxuICAgICAgICAgIC5hd3NBcHBzeW5jQXV0aGVudGljYXRpb25UeXBlIGFzIEFwaUF1dGhUeXBlLFxuICAgICAgICBhZGRpdGlvbmFsQXV0aFR5cGVzLFxuICAgICAgICBjb25mbGljdFJlc29sdXRpb25Nb2RlOiBiYWNrZW5kT3V0cHV0W2dyYXBocWxPdXRwdXRLZXldPy5wYXlsb2FkXG4gICAgICAgICAgLmF3c0FwcHN5bmNDb25mbGljdFJlc29sdXRpb25Nb2RlIGFzIENvbmZsaWN0UmVzb2x1dGlvbk1vZGUsXG4gICAgICAgIGFwaUlkOiBiYWNrZW5kT3V0cHV0W2dyYXBocWxPdXRwdXRLZXldPy5wYXlsb2FkXG4gICAgICAgICAgLmF3c0FwcHN5bmNBcGlJZCBhcyBzdHJpbmcsXG4gICAgICAgIG1vZGVsU2NoZW1hUzNVcmk6IGJhY2tlbmRPdXRwdXRbZ3JhcGhxbE91dHB1dEtleV0/LnBheWxvYWRcbiAgICAgICAgICAuYW1wbGlmeUFwaU1vZGVsU2NoZW1hUzNVcmkgYXMgc3RyaW5nLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAoZnVuY3Rpb25TdGFjaykge1xuICAgICAgY29uc3QgZnVuY3Rpb25SZXNvdXJjZXMgPSByZXNvdXJjZXMuZmlsdGVyKFxuICAgICAgICAocmVzb3VyY2UpID0+IHJlc291cmNlLnJlc291cmNlVHlwZSA9PT0gJ0FXUzo6TGFtYmRhOjpGdW5jdGlvbicsXG4gICAgICApO1xuICAgICAgY29uc3QgZnVuY3Rpb25Db25maWd1cmF0aW9uczogRnVuY3Rpb25Db25maWd1cmF0aW9uW10gPSBbXTtcbiAgICAgIGNvbnN0IGRlZmluZWRGdW5jdGlvbnNTdHJpbmcgPVxuICAgICAgICBiYWNrZW5kT3V0cHV0W2Z1bmN0aW9uT3V0cHV0S2V5XT8ucGF5bG9hZC5kZWZpbmVkRnVuY3Rpb25zO1xuICAgICAgY29uc3QgY3VzdG9tZXJGdW5jdGlvbk5hbWVzID0gZGVmaW5lZEZ1bmN0aW9uc1N0cmluZ1xuICAgICAgICA/IChKU09OLnBhcnNlKGRlZmluZWRGdW5jdGlvbnNTdHJpbmcgYXMgc3RyaW5nKSBhcyBzdHJpbmdbXSlcbiAgICAgICAgOiBbXTtcblxuICAgICAgY3VzdG9tZXJGdW5jdGlvbk5hbWVzLmZvckVhY2goKGZ1bmN0aW9uTmFtZSkgPT4ge1xuICAgICAgICBjb25zdCByZXNvdXJjZSA9IGZ1bmN0aW9uUmVzb3VyY2VzLmZpbmQoXG4gICAgICAgICAgKGZ1bmMpID0+IGZ1bmMucGh5c2ljYWxSZXNvdXJjZUlkID09PSBmdW5jdGlvbk5hbWUsXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKHJlc291cmNlKSB7XG4gICAgICAgICAgZnVuY3Rpb25Db25maWd1cmF0aW9ucy5wdXNoKHtcbiAgICAgICAgICAgIHN0YXR1czogdGhpcy5zdGFja1N0YXR1c01hcHBlci50cmFuc2xhdGVTdGFja1N0YXR1cyhcbiAgICAgICAgICAgICAgcmVzb3VyY2UucmVzb3VyY2VTdGF0dXMsXG4gICAgICAgICAgICApLFxuICAgICAgICAgICAgbGFzdFVwZGF0ZWQ6XG4gICAgICAgICAgICAgIHJlc291cmNlLmxhc3RVcGRhdGVkID8/XG4gICAgICAgICAgICAgIGZ1bmN0aW9uU3RhY2suTGFzdFVwZGF0ZWRUaW1lID8/XG4gICAgICAgICAgICAgIGZ1bmN0aW9uU3RhY2suQ3JlYXRpb25UaW1lLFxuICAgICAgICAgICAgZnVuY3Rpb25OYW1lLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgYmFja2VuZE1ldGFkYXRhT2JqZWN0LmZ1bmN0aW9uQ29uZmlndXJhdGlvbnMgPSBmdW5jdGlvbkNvbmZpZ3VyYXRpb25zO1xuICAgIH1cblxuICAgIHJldHVybiBiYWNrZW5kTWV0YWRhdGFPYmplY3Q7XG4gIH07XG5cbiAgcHJpdmF0ZSBmZXRjaFNjaGVtYSA9IGFzeW5jIChcbiAgICBzY2hlbWFTM1VyaTogc3RyaW5nIHwgdW5kZWZpbmVkLFxuICApOiBQcm9taXNlPHN0cmluZz4gPT4ge1xuICAgIGlmICghc2NoZW1hUzNVcmkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignc2NoZW1hUzNVcmkgb3V0cHV0IGlzIG5vdCBhdmFpbGFibGUnKTtcbiAgICB9XG5cbiAgICAvLyBzMzovL3tidWNrZXROYW1lfS97ZmlsZU5hbWV9XG4gICAgY29uc3QgdXJpUGFydHMgPSBzY2hlbWFTM1VyaS5zcGxpdCgnLycpO1xuICAgIGNvbnN0IGJ1Y2tldE5hbWUgPSB1cmlQYXJ0c1syXTtcbiAgICBjb25zdCBvYmplY3RQYXRoID0gdXJpUGFydHMuc2xpY2UoMywgdXJpUGFydHMubGVuZ3RoKS5qb2luKCcvJyk7XG5cbiAgICBpZiAoIWJ1Y2tldE5hbWUgfHwgIW9iamVjdFBhdGgpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignc2NoZW1hUzNVcmkgaXMgbm90IHZhbGlkJyk7XG4gICAgfVxuXG4gICAgY29uc3QgczNSZXNwb25zZSA9IGF3YWl0IHRoaXMuczNDbGllbnQuc2VuZChcbiAgICAgIG5ldyBHZXRPYmplY3RDb21tYW5kKHsgQnVja2V0OiBidWNrZXROYW1lLCBLZXk6IG9iamVjdFBhdGggfSksXG4gICAgKTtcblxuICAgIGlmICghczNSZXNwb25zZS5Cb2R5KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYHMzUmVzcG9uc2UgZnJvbSAke3NjaGVtYVMzVXJpfSBkb2VzIG5vdCBjb250YWluIGEgQm9keWApO1xuICAgIH1cblxuICAgIHJldHVybiBhd2FpdCBzM1Jlc3BvbnNlLkJvZHk/LnRyYW5zZm9ybVRvU3RyaW5nKCk7XG4gIH07XG59XG4iXX0=