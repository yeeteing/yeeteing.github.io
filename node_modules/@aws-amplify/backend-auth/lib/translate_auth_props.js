/**
 * Translate an Auth factory's loginWith to its Auth construct counterpart. Backend secret fields will be resolved
 * to an CFN token and map to the required construct type. Note that not all construct secret fields are of sdk
 * SecretValue type, many are (wrongly) of type string as well.
 */
export const translateToAuthConstructLoginWith = (authFactoryLoginWith, backendSecretResolver) => {
    const result = authFactoryLoginWith;
    if (!authFactoryLoginWith.externalProviders) {
        return result;
    }
    const externalProviders = authFactoryLoginWith.externalProviders;
    result.externalProviders = {
        ...externalProviders,
    };
    const amazonProps = translateAmazonProps(backendSecretResolver, externalProviders.loginWithAmazon);
    if (amazonProps) {
        result.externalProviders.loginWithAmazon = amazonProps;
    }
    const appleProps = translateAppleProps(backendSecretResolver, externalProviders.signInWithApple);
    if (appleProps) {
        result.externalProviders.signInWithApple = appleProps;
    }
    const facebookProps = translateFacebookProps(backendSecretResolver, externalProviders.facebook);
    if (facebookProps) {
        result.externalProviders.facebook = facebookProps;
    }
    const oidcProps = translateOidcProps(backendSecretResolver, externalProviders.oidc);
    if (oidcProps) {
        result.externalProviders.oidc = oidcProps;
    }
    const googleProps = translateGoogleProps(backendSecretResolver, externalProviders.google);
    if (googleProps) {
        result.externalProviders.google = googleProps;
    }
    return result;
};
/**
 * Translates the senders property from AmplifyAuthProps to AuthProps format.
 * @param senders - The senders object from AmplifyAuthProps.
 * @param getInstanceProps - Properties used to get an instance of the sender.
 * @returns The translated senders object in AuthProps format, or undefined if no valid sender is provided.
 * @description
 * This function handles the translation of the 'senders' property, specifically for email and sms senders.
 * If no senders are provided, it returns undefined.
 * If a sender has a 'getInstance' method, it retrieves the Lambda function and returns it.
 * Otherwise, it returns the sender as is.
 */
export const translateToAuthConstructSenders = (senders, getInstanceProps) => {
    if (!senders || !(senders.email || senders.sms)) {
        return undefined;
    }
    const authConstructSenders = {};
    // Handle CustomEmailSender type
    if (senders.email && 'handler' in senders.email) {
        const lambda = 'getInstance' in senders.email.handler
            ? senders.email.handler.getInstance(getInstanceProps).resources.lambda
            : senders.email.handler;
        authConstructSenders.email = {
            handler: lambda,
            kmsKeyArn: senders.email.kmsKeyArn,
        };
    }
    else if (senders.email && 'fromEmail' in senders.email) {
        // Handle SES configuration
        authConstructSenders.email = { ...senders.email };
    }
    // Handle CustomSmsSender type
    if (senders.sms && 'handler' in senders.sms) {
        const lambda = 'getInstance' in senders.sms.handler
            ? senders.sms.handler.getInstance(getInstanceProps).resources.lambda
            : senders.sms.handler;
        authConstructSenders.sms = {
            handler: lambda,
            kmsKeyArn: senders.sms.kmsKeyArn,
        };
    }
    else if (senders.sms) {
        // Handle SNS configuration
        authConstructSenders.sms = { ...senders.sms };
    }
    return authConstructSenders;
};
const translateAmazonProps = (backendSecretResolver, amazonProviderProps) => {
    if (!amazonProviderProps) {
        return undefined;
    }
    const { clientId, clientSecret, ...noSecretProps } = amazonProviderProps;
    return {
        ...noSecretProps,
        clientId: backendSecretResolver.resolveSecret(clientId).unsafeUnwrap(),
        clientSecret: backendSecretResolver
            .resolveSecret(clientSecret)
            .unsafeUnwrap(),
    };
};
const translateAppleProps = (backendSecretResolver, amazonProviderProps) => {
    if (!amazonProviderProps) {
        return undefined;
    }
    const { clientId, teamId, keyId, privateKey, ...noSecretProps } = amazonProviderProps;
    return {
        ...noSecretProps,
        clientId: backendSecretResolver.resolveSecret(clientId).unsafeUnwrap(),
        teamId: backendSecretResolver.resolveSecret(teamId).unsafeUnwrap(),
        keyId: backendSecretResolver.resolveSecret(keyId).unsafeUnwrap(),
        privateKey: backendSecretResolver.resolveSecret(privateKey).unsafeUnwrap(),
    };
};
const translateFacebookProps = (backendSecretResolver, facebookProviderProps) => {
    if (!facebookProviderProps) {
        return undefined;
    }
    const { clientId, clientSecret, ...noSecretProps } = facebookProviderProps;
    return {
        ...noSecretProps,
        clientId: backendSecretResolver.resolveSecret(clientId).unsafeUnwrap(),
        clientSecret: backendSecretResolver
            .resolveSecret(clientSecret)
            .unsafeUnwrap(),
    };
};
const translateOidcProps = (backendSecretResolver, oidcProviderProps) => {
    if (!oidcProviderProps || oidcProviderProps.length === 0) {
        return undefined;
    }
    const result = [];
    for (const provider of oidcProviderProps) {
        const { clientId, clientSecret, ...noSecretProps } = provider;
        result.push({
            ...noSecretProps,
            clientId: backendSecretResolver.resolveSecret(clientId).unsafeUnwrap(),
            clientSecret: backendSecretResolver
                .resolveSecret(clientSecret)
                .unsafeUnwrap(),
        });
    }
    return result;
};
const translateGoogleProps = (backendSecretResolver, googleProviderProps) => {
    if (!googleProviderProps) {
        return undefined;
    }
    const { clientId, clientSecret: clientSecretValue, ...noSecretProps } = googleProviderProps;
    return {
        ...noSecretProps,
        clientId: backendSecretResolver.resolveSecret(clientId).unsafeUnwrap(),
        clientSecret: backendSecretResolver.resolveSecret(clientSecretValue),
    };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNsYXRlX2F1dGhfcHJvcHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdHJhbnNsYXRlX2F1dGhfcHJvcHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBd0JBOzs7O0dBSUc7QUFDSCxNQUFNLENBQUMsTUFBTSxpQ0FBaUMsR0FBRyxDQUMvQyxvQkFBK0MsRUFDL0MscUJBQTRDLEVBQ3BCLEVBQUU7SUFDMUIsTUFBTSxNQUFNLEdBQ1Ysb0JBQThDLENBQUM7SUFDakQsSUFBSSxDQUFDLG9CQUFvQixDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFDNUMsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQUVELE1BQU0saUJBQWlCLEdBQUcsb0JBQW9CLENBQUMsaUJBQWlCLENBQUM7SUFDakUsTUFBTSxDQUFDLGlCQUFpQixHQUFHO1FBQ3pCLEdBQUksaUJBQXlEO0tBQzlELENBQUM7SUFFRixNQUFNLFdBQVcsR0FBRyxvQkFBb0IsQ0FDdEMscUJBQXFCLEVBQ3JCLGlCQUFpQixDQUFDLGVBQWUsQ0FDbEMsQ0FBQztJQUNGLElBQUksV0FBVyxFQUFFLENBQUM7UUFDaEIsTUFBTSxDQUFDLGlCQUFpQixDQUFDLGVBQWUsR0FBRyxXQUFXLENBQUM7SUFDekQsQ0FBQztJQUVELE1BQU0sVUFBVSxHQUFHLG1CQUFtQixDQUNwQyxxQkFBcUIsRUFDckIsaUJBQWlCLENBQUMsZUFBZSxDQUNsQyxDQUFDO0lBQ0YsSUFBSSxVQUFVLEVBQUUsQ0FBQztRQUNmLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxlQUFlLEdBQUcsVUFBVSxDQUFDO0lBQ3hELENBQUM7SUFFRCxNQUFNLGFBQWEsR0FBRyxzQkFBc0IsQ0FDMUMscUJBQXFCLEVBQ3JCLGlCQUFpQixDQUFDLFFBQVEsQ0FDM0IsQ0FBQztJQUNGLElBQUksYUFBYSxFQUFFLENBQUM7UUFDbEIsTUFBTSxDQUFDLGlCQUFpQixDQUFDLFFBQVEsR0FBRyxhQUFhLENBQUM7SUFDcEQsQ0FBQztJ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QUFpQixFQUMvQixHQUFHLGFBQWEsRUFDakIsR0FBRyxtQkFBbUIsQ0FBQztJQUN4QixPQUFPO1FBQ0wsR0FBRyxhQUFhO1FBQ2hCLFFBQVEsRUFBRSxxQkFBcUIsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUMsWUFBWSxFQUFFO1FBQ3RFLFlBQVksRUFBRSxxQkFBcUIsQ0FBQyxhQUFhLENBQUMsaUJBQWlCLENBQUM7S0FDckUsQ0FBQztBQUNKLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEFtYXpvblByb3ZpZGVyUHJvcHMsXG4gIEFwcGxlUHJvdmlkZXJQcm9wcyxcbiAgQXV0aFByb3BzLFxuICBGYWNlYm9va1Byb3ZpZGVyUHJvcHMsXG4gIEdvb2dsZVByb3ZpZGVyUHJvcHMsXG4gIE9pZGNQcm92aWRlclByb3BzLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvYXV0aC1jb25zdHJ1Y3QnO1xuaW1wb3J0IHtcbiAgQmFja2VuZFNlY3JldFJlc29sdmVyLFxuICBDb25zdHJ1Y3RGYWN0b3J5R2V0SW5zdGFuY2VQcm9wcyxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQge1xuICBBbWF6b25Qcm92aWRlckZhY3RvcnlQcm9wcyxcbiAgQXBwbGVQcm92aWRlckZhY3RvcnlQcm9wcyxcbiAgQXV0aExvZ2luV2l0aEZhY3RvcnlQcm9wcyxcbiAgRXh0ZXJuYWxQcm92aWRlckdlbmVyYWxGYWN0b3J5UHJvcHMsXG4gIEZhY2Vib29rUHJvdmlkZXJGYWN0b3J5UHJvcHMsXG4gIEdvb2dsZVByb3ZpZGVyRmFjdG9yeVByb3BzLFxuICBPaWRjUHJvdmlkZXJGYWN0b3J5UHJvcHMsXG59IGZyb20gJy4vdHlwZXMuanMnO1xuaW1wb3J0IHsgSUZ1bmN0aW9uIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBBbXBsaWZ5QXV0aFByb3BzIH0gZnJvbSAnLi9mYWN0b3J5LmpzJztcblxuLyoqXG4gKiBUcmFuc2xhdGUgYW4gQXV0aCBmYWN0b3J5J3MgbG9naW5XaXRoIHRvIGl0cyBBdXRoIGNvbnN0cnVjdCBjb3VudGVycGFydC4gQmFja2VuZCBzZWNyZXQgZmllbGRzIHdpbGwgYmUgcmVzb2x2ZWRcbiAqIHRvIGFuIENGTiB0b2tlbiBhbmQgbWFwIHRvIHRoZSByZXF1aXJlZCBjb25zdHJ1Y3QgdHlwZS4gTm90ZSB0aGF0IG5vdCBhbGwgY29uc3RydWN0IHNlY3JldCBmaWVsZHMgYXJlIG9mIHNka1xuICogU2VjcmV0VmFsdWUgdHlwZSwgbWFueSBhcmUgKHdyb25nbHkpIG9mIHR5cGUgc3RyaW5nIGFzIHdlbGwuXG4gKi9cbmV4cG9ydCBjb25zdCB0cmFuc2xhdGVUb0F1dGhDb25zdHJ1Y3RMb2dpbldpdGggPSAoXG4gIGF1dGhGYWN0b3J5TG9naW5XaXRoOiBBdXRoTG9naW5XaXRoRmFjdG9yeVByb3BzLFxuICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXI6IEJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbik6IEF1dGhQcm9wc1snbG9naW5XaXRoJ10gPT4ge1xuICBjb25zdCByZXN1bHQ6IEF1dGhQcm9wc1snbG9naW5XaXRoJ10gPVxuICAgIGF1dGhGYWN0b3J5TG9naW5XaXRoIGFzIEF1dGhQcm9wc1snbG9naW5XaXRoJ107XG4gIGlmICghYXV0aEZhY3RvcnlMb2dpbldpdGguZXh0ZXJuYWxQcm92aWRlcnMpIHtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgY29uc3QgZXh0ZXJuYWxQcm92aWRlcnMgPSBhdXRoRmFjdG9yeUxvZ2luV2l0aC5leHRlcm5hbFByb3ZpZGVycztcbiAgcmVzdWx0LmV4dGVybmFsUHJvdmlkZXJzID0ge1xuICAgIC4uLihleHRlcm5hbFByb3ZpZGVycyBhcyBFeHRlcm5hbFByb3ZpZGVyR2VuZXJhbEZhY3RvcnlQcm9wcyksXG4gIH07XG5cbiAgY29uc3QgYW1hem9uUHJvcHMgPSB0cmFuc2xhdGVBbWF6b25Qcm9wcyhcbiAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gICAgZXh0ZXJuYWxQcm92aWRlcnMubG9naW5XaXRoQW1hem9uLFxuICApO1xuICBpZiAoYW1hem9uUHJvcHMpIHtcbiAgICByZXN1bHQuZXh0ZXJuYWxQcm92aWRlcnMubG9naW5XaXRoQW1hem9uID0gYW1hem9uUHJvcHM7XG4gIH1cblxuICBjb25zdCBhcHBsZVByb3BzID0gdHJhbnNsYXRlQXBwbGVQcm9wcyhcbiAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gICAgZXh0ZXJuYWxQcm92aWRlcnMuc2lnbkluV2l0aEFwcGxlLFxuICApO1xuICBpZiAoYXBwbGVQcm9wcykge1xuICAgIHJlc3VsdC5leHRlcm5hbFByb3ZpZGVycy5zaWduSW5XaXRoQXBwbGUgPSBhcHBsZVByb3BzO1xuICB9XG5cbiAgY29uc3QgZmFjZWJvb2tQcm9wcyA9IHRyYW5zbGF0ZUZhY2Vib29rUHJvcHMoXG4gICAgYmFja2VuZFNlY3JldFJlc29sdmVyLFxuICAgIGV4dGVybmFsUHJvdmlkZXJzLmZhY2Vib29rLFxuICApO1xuICBpZiAoZmFjZWJvb2tQcm9wcykge1xuICAgIHJlc3VsdC5leHRlcm5hbFByb3ZpZGVycy5mYWNlYm9vayA9IGZhY2Vib29rUHJvcHM7XG4gIH1cblxuICBjb25zdCBvaWRjUHJvcHMgPSB0cmFuc2xhdGVPaWRjUHJvcHMoXG4gICAgYmFja2VuZFNlY3JldFJlc29sdmVyLFxuICAgIGV4dGVybmFsUHJvdmlkZXJzLm9pZGMsXG4gICk7XG4gIGlmIChvaWRjUHJvcHMpIHtcbiAgICByZXN1bHQuZXh0ZXJuYWxQcm92aWRlcnMub2lkYyA9IG9pZGNQcm9wcztcbiAgfVxuXG4gIGNvbnN0IGdvb2dsZVByb3BzID0gdHJhbnNsYXRlR29vZ2xlUHJvcHMoXG4gICAgYmFja2VuZFNlY3JldFJlc29sdmVyLFxuICAgIGV4dGVybmFsUHJvdmlkZXJzLmdvb2dsZSxcbiAgKTtcbiAgaWYgKGdvb2dsZVByb3BzKSB7XG4gICAgcmVzdWx0LmV4dGVybmFsUHJvdmlkZXJzLmdvb2dsZSA9IGdvb2dsZVByb3BzO1xuICB9XG5cbiAgcmV0dXJuIHJlc3VsdDtcbn07XG4vKipcbiAqIFRyYW5zbGF0ZXMgdGhlIHNlbmRlcnMgcHJvcGVydHkgZnJvbSBBbXBsaWZ5QXV0aFByb3BzIHRvIEF1dGhQcm9wcyBmb3JtYXQuXG4gKiBAcGFyYW0gc2VuZGVycyAtIFRoZSBzZW5kZXJzIG9iamVjdCBmcm9tIEFtcGxpZnlBdXRoUHJvcHMuXG4gKiBAcGFyYW0gZ2V0SW5zdGFuY2VQcm9wcyAtIFByb3BlcnRpZXMgdXNlZCB0byBnZXQgYW4gaW5zdGFuY2Ugb2YgdGhlIHNlbmRlci5cbiAqIEByZXR1cm5zIFRoZSB0cmFuc2xhdGVkIHNlbmRlcnMgb2JqZWN0IGluIEF1dGhQcm9wcyBmb3JtYXQsIG9yIHVuZGVmaW5lZCBpZiBubyB2YWxpZCBzZW5kZXIgaXMgcHJvdmlkZWQuXG4gKiBAZGVzY3JpcHRpb25cbiAqIFRoaXMgZnVuY3Rpb24gaGFuZGxlcyB0aGUgdHJhbnNsYXRpb24gb2YgdGhlICdzZW5kZXJzJyBwcm9wZXJ0eSwgc3BlY2lmaWNhbGx5IGZvciBlbWFpbCBhbmQgc21zIHNlbmRlcnMuXG4gKiBJZiBubyBzZW5kZXJzIGFyZSBwcm92aWRlZCwgaXQgcmV0dXJucyB1bmRlZmluZWQuXG4gKiBJZiBhIHNlbmRlciBoYXMgYSAnZ2V0SW5zdGFuY2UnIG1ldGhvZCwgaXQgcmV0cmlldmVzIHRoZSBMYW1iZGEgZnVuY3Rpb24gYW5kIHJldHVybnMgaXQuXG4gKiBPdGhlcndpc2UsIGl0IHJldHVybnMgdGhlIHNlbmRlciBhcyBpcy5cbiAqL1xuZXhwb3J0IGNvbnN0IHRyYW5zbGF0ZVRvQXV0aENvbnN0cnVjdFNlbmRlcnMgPSAoXG4gIHNlbmRlcnM6IEFtcGxpZnlBdXRoUHJvcHNbJ3NlbmRlcnMnXSB8IHVuZGVmaW5lZCxcbiAgZ2V0SW5zdGFuY2VQcm9wczogQ29uc3RydWN0RmFjdG9yeUdldEluc3RhbmNlUHJvcHMsXG4pOiBBdXRoUHJvcHNbJ3NlbmRlcnMnXSB8IHVuZGVmaW5lZCA9PiB7XG4gIGlmICghc2VuZGVycyB8fCAhKHNlbmRlcnMuZW1haWwgfHwgc2VuZGVycy5zbXMpKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIGNvbnN0IGF1dGhDb25zdHJ1Y3RTZW5kZXJzOiBBdXRoUHJvcHNbJ3NlbmRlcnMnXSA9IHt9O1xuXG4gIC8vIEhhbmRsZSBDdXN0b21FbWFpbFNlbmRlciB0eXBlXG4gIGlmIChzZW5kZXJzLmVtYWlsICYmICdoYW5kbGVyJyBpbiBzZW5kZXJzLmVtYWlsKSB7XG4gICAgY29uc3QgbGFtYmRhOiBJRnVuY3Rpb24gPVxuICAgICAgJ2dldEluc3RhbmNlJyBpbiBzZW5kZXJzLmVtYWlsLmhhbmRsZXJcbiAgICAgICAgPyBzZW5kZXJzLmVtYWlsLmhhbmRsZXIuZ2V0SW5zdGFuY2UoZ2V0SW5zdGFuY2VQcm9wcykucmVzb3VyY2VzLmxhbWJkYVxuICAgICAgICA6IHNlbmRlcnMuZW1haWwuaGFuZGxlcjtcblxuICAgIGF1dGhDb25zdHJ1Y3RTZW5kZXJzLmVtYWlsID0ge1xuICAgICAgaGFuZGxlcjogbGFtYmRhLFxuICAgICAga21zS2V5QXJuOiBzZW5kZXJzLmVtYWlsLmttc0tleUFybixcbiAgICB9O1xuICB9IGVsc2UgaWYgKHNlbmRlcnMuZW1haWwgJiYgJ2Zyb21FbWFpbCcgaW4gc2VuZGVycy5lbWFpbCkge1xuICAgIC8vIEhhbmRsZSBTRVMgY29uZmlndXJhdGlvblxuICAgIGF1dGhDb25zdHJ1Y3RTZW5kZXJzLmVtYWlsID0geyAuLi5zZW5kZXJzLmVtYWlsIH07XG4gIH1cblxuICAvLyBIYW5kbGUgQ3VzdG9tU21zU2VuZGVyIHR5cGVcbiAgaWYgKHNlbmRlcnMuc21zICYmICdoYW5kbGVyJyBpbiBzZW5kZXJzLnNtcykge1xuICAgIGNvbnN0IGxhbWJkYTogSUZ1bmN0aW9uID1cbiAgICAgICdnZXRJbnN0YW5jZScgaW4gc2VuZGVycy5zbXMuaGFuZGxlclxuICAgICAgICA/IHNlbmRlcnMuc21zLmhhbmRsZXIuZ2V0SW5zdGFuY2UoZ2V0SW5zdGFuY2VQcm9wcykucmVzb3VyY2VzLmxhbWJkYVxuICAgICAgICA6IHNlbmRlcnMuc21zLmhhbmRsZXI7XG5cbiAgICBhdXRoQ29uc3RydWN0U2VuZGVycy5zbXMgPSB7XG4gICAgICBoYW5kbGVyOiBsYW1iZGEsXG4gICAgICBrbXNLZXlBcm46IHNlbmRlcnMuc21zLmttc0tleUFybixcbiAgICB9O1xuICB9IGVsc2UgaWYgKHNlbmRlcnMuc21zKSB7XG4gICAgLy8gSGFuZGxlIFNOUyBjb25maWd1cmF0aW9uXG4gICAgYXV0aENvbnN0cnVjdFNlbmRlcnMuc21zID0geyAuLi5zZW5kZXJzLnNtcyB9O1xuICB9XG4gIHJldHVybiBhdXRoQ29uc3RydWN0U2VuZGVycztcbn07XG5cbmNvbnN0IHRyYW5zbGF0ZUFtYXpvblByb3BzID0gKFxuICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXI6IEJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgYW1hem9uUHJvdmlkZXJQcm9wcz86IEFtYXpvblByb3ZpZGVyRmFjdG9yeVByb3BzLFxuKTogQW1hem9uUHJvdmlkZXJQcm9wcyB8IHVuZGVmaW5lZCA9PiB7XG4gIGlmICghYW1hem9uUHJvdmlkZXJQcm9wcykge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBjb25zdCB7IGNsaWVudElkLCBjbGllbnRTZWNyZXQsIC4uLm5vU2VjcmV0UHJvcHMgfSA9IGFtYXpvblByb3ZpZGVyUHJvcHM7XG4gIHJldHVybiB7XG4gICAgLi4ubm9TZWNyZXRQcm9wcyxcbiAgICBjbGllbnRJZDogYmFja2VuZFNlY3JldFJlc29sdmVyLnJlc29sdmVTZWNyZXQoY2xpZW50SWQpLnVuc2FmZVVud3JhcCgpLFxuICAgIGNsaWVudFNlY3JldDogYmFja2VuZFNlY3JldFJlc29sdmVyXG4gICAgICAucmVzb2x2ZVNlY3JldChjbGllbnRTZWNyZXQpXG4gICAgICAudW5zYWZlVW53cmFwKCksXG4gIH07XG59O1xuXG5jb25zdCB0cmFuc2xhdGVBcHBsZVByb3BzID0gKFxuICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXI6IEJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgYW1hem9uUHJvdmlkZXJQcm9wcz86IEFwcGxlUHJvdmlkZXJGYWN0b3J5UHJvcHMsXG4pOiBBcHBsZVByb3ZpZGVyUHJvcHMgfCB1bmRlZmluZWQgPT4ge1xuICBpZiAoIWFtYXpvblByb3ZpZGVyUHJvcHMpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgY29uc3QgeyBjbGllbnRJZCwgdGVhbUlkLCBrZXlJZCwgcHJpdmF0ZUtleSwgLi4ubm9TZWNyZXRQcm9wcyB9ID1cbiAgICBhbWF6b25Qcm92aWRlclByb3BzO1xuICByZXR1cm4ge1xuICAgIC4uLm5vU2VjcmV0UHJvcHMsXG4gICAgY2xpZW50SWQ6IGJhY2tlbmRTZWNyZXRSZXNvbHZlci5yZXNvbHZlU2VjcmV0KGNsaWVudElkKS51bnNhZmVVbndyYXAoKSxcbiAgICB0ZWFtSWQ6IGJhY2tlbmRTZWNyZXRSZXNvbHZlci5yZXNvbHZlU2VjcmV0KHRlYW1JZCkudW5zYWZlVW53cmFwKCksXG4gICAga2V5SWQ6IGJhY2tlbmRTZWNyZXRSZXNvbHZlci5yZXNvbHZlU2VjcmV0KGtleUlkKS51bnNhZmVVbndyYXAoKSxcbiAgICBwcml2YXRlS2V5OiBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIucmVzb2x2ZVNlY3JldChwcml2YXRlS2V5KS51bnNhZmVVbndyYXAoKSxcbiAgfTtcbn07XG5cbmNvbnN0IHRyYW5zbGF0ZUZhY2Vib29rUHJvcHMgPSAoXG4gIGJhY2tlbmRTZWNyZXRSZXNvbHZlcjogQmFja2VuZFNlY3JldFJlc29sdmVyLFxuICBmYWNlYm9va1Byb3ZpZGVyUHJvcHM/OiBGYWNlYm9va1Byb3ZpZGVyRmFjdG9yeVByb3BzLFxuKTogRmFjZWJvb2tQcm92aWRlclByb3BzIHwgdW5kZWZpbmVkID0+IHtcbiAgaWYgKCFmYWNlYm9va1Byb3ZpZGVyUHJvcHMpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgY29uc3QgeyBjbGllbnRJZCwgY2xpZW50U2VjcmV0LCAuLi5ub1NlY3JldFByb3BzIH0gPSBmYWNlYm9va1Byb3ZpZGVyUHJvcHM7XG4gIHJldHVybiB7XG4gICAgLi4ubm9TZWNyZXRQcm9wcyxcbiAgICBjbGllbnRJZDogYmFja2VuZFNlY3JldFJlc29sdmVyLnJlc29sdmVTZWNyZXQoY2xpZW50SWQpLnVuc2FmZVVud3JhcCgpLFxuICAgIGNsaWVudFNlY3JldDogYmFja2VuZFNlY3JldFJlc29sdmVyXG4gICAgICAucmVzb2x2ZVNlY3JldChjbGllbnRTZWNyZXQpXG4gICAgICAudW5zYWZlVW53cmFwKCksXG4gIH07XG59O1xuXG5jb25zdCB0cmFuc2xhdGVPaWRjUHJvcHMgPSAoXG4gIGJhY2tlbmRTZWNyZXRSZXNvbHZlcjogQmFja2VuZFNlY3JldFJlc29sdmVyLFxuICBvaWRjUHJvdmlkZXJQcm9wcz86IE9pZGNQcm92aWRlckZhY3RvcnlQcm9wc1tdLFxuKTogT2lkY1Byb3ZpZGVyUHJvcHNbXSB8IHVuZGVmaW5lZCA9PiB7XG4gIGlmICghb2lkY1Byb3ZpZGVyUHJvcHMgfHwgb2lkY1Byb3ZpZGVyUHJvcHMubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIGNvbnN0IHJlc3VsdCA9IFtdO1xuICBmb3IgKGNvbnN0IHByb3ZpZGVyIG9mIG9pZGNQcm92aWRlclByb3BzKSB7XG4gICAgY29uc3QgeyBjbGllbnRJZCwgY2xpZW50U2VjcmV0LCAuLi5ub1NlY3JldFByb3BzIH0gPSBwcm92aWRlcjtcbiAgICByZXN1bHQucHVzaCh7XG4gICAgICAuLi5ub1NlY3JldFByb3BzLFxuICAgICAgY2xpZW50SWQ6IGJhY2tlbmRTZWNyZXRSZXNvbHZlci5yZXNvbHZlU2VjcmV0KGNsaWVudElkKS51bnNhZmVVbndyYXAoKSxcbiAgICAgIGNsaWVudFNlY3JldDogYmFja2VuZFNlY3JldFJlc29sdmVyXG4gICAgICAgIC5yZXNvbHZlU2VjcmV0KGNsaWVudFNlY3JldClcbiAgICAgICAgLnVuc2FmZVVud3JhcCgpLFxuICAgIH0pO1xuICB9XG5cbiAgcmV0dXJuIHJlc3VsdDtcbn07XG5cbmNvbnN0IHRyYW5zbGF0ZUdvb2dsZVByb3BzID0gKFxuICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXI6IEJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgZ29vZ2xlUHJvdmlkZXJQcm9wcz86IEdvb2dsZVByb3ZpZGVyRmFjdG9yeVByb3BzLFxuKTogR29vZ2xlUHJvdmlkZXJQcm9wcyB8IHVuZGVmaW5lZCA9PiB7XG4gIGlmICghZ29vZ2xlUHJvdmlkZXJQcm9wcykge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBjb25zdCB7XG4gICAgY2xpZW50SWQsXG4gICAgY2xpZW50U2VjcmV0OiBjbGllbnRTZWNyZXRWYWx1ZSxcbiAgICAuLi5ub1NlY3JldFByb3BzXG4gIH0gPSBnb29nbGVQcm92aWRlclByb3BzO1xuICByZXR1cm4ge1xuICAgIC4uLm5vU2VjcmV0UHJvcHMsXG4gICAgY2xpZW50SWQ6IGJhY2tlbmRTZWNyZXRSZXNvbHZlci5yZXNvbHZlU2VjcmV0KGNsaWVudElkKS51bnNhZmVVbndyYXAoKSxcbiAgICBjbGllbnRTZWNyZXQ6IGJhY2tlbmRTZWNyZXRSZXNvbHZlci5yZXNvbHZlU2VjcmV0KGNsaWVudFNlY3JldFZhbHVlKSxcbiAgfTtcbn07XG4iXX0=