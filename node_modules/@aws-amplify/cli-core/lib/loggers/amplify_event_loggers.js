import { LogLevel } from '../printer/printer.js';
import { printer as globalPrinter, minimumLogLevel } from '../printer.js';
import { format } from '../format/format.js';
import { CfnDeploymentProgressLogger, } from './cfn-deployment-progress/cfn_deployment_progress_logger.js';
import { WriteStream } from 'node:tty';
import { RewritableBlock } from './cfn-deployment-progress/rewritable_block.js';
import { EOL } from 'node:os';
import { context as openTelemetryContext, trace as openTelemetryTrace, } from '@opentelemetry/api';
import { setSpanAttributes } from '@aws-amplify/platform-core';
/**
 * Amplify events logger class. Implements several loggers that connect
 * to the amplify_io_event_bridge for showing relevant information to customers
 */
export class AmplifyEventLogger {
    printer;
    amplifyIOEventsBridgeSingletonFactory;
    cfnDeploymentProgressLogger;
    outputs = {};
    isHotSwap = false;
    /**
     * a logger instance to be used for CDK events
     */
    constructor(printer = globalPrinter, amplifyIOEventsBridgeSingletonFactory) {
        this.printer = printer;
        this.amplifyIOEventsBridgeSingletonFactory = amplifyIOEventsBridgeSingletonFactory;
    }
    getEventLoggers = () => {
        if (minimumLogLevel === LogLevel.DEBUG) {
            return {
                notify: [this.debug],
            };
        }
        const loggers = [this.amplifyNotifications, this.cdkDeploymentProgress];
        if (this.printer.ttyEnabled) {
            loggers.push(this.fancyCfnDeploymentProgress);
        }
        else {
            loggers.push(this.nonTtyCfnDeploymentProgress);
        }
        return {
            notify: loggers,
        };
    };
    /**
     * Log debug messages
     */
    debug = (msg) => {
        if (msg.level === 'trace' || msg.level === 'debug') {
            if (msg.data &&
                typeof msg.data === 'object' &&
                'sdkLevel' in msg.data &&
                'content' in msg.data &&
                Array.isArray(msg.data.content)) {
                msg.data.content.forEach((trace) => {
                    this.printer.log(`AWS SDK Call ${trace.clientName}: ${trace.commandName}`, LogLevel.DEBUG);
                });
            }
            else {
                this.printer.log(`[${msg.action}: ${msg.code}] ${msg.message}`, LogLevel.DEBUG);
            }
        }
        else {
            this.printer.log(`[${format.color(`${msg.action}: ${msg.code}`, msg.level === 'error'
                ? 'Red'
                : msg.level === 'warn'
                    ? 'Yellow'
                    : 'Green')}] ${format.note(msg.time.toLocaleTimeString())} ${msg.message.trim()} ${msg.data ? this.safeJsonStringifyForDebug(msg.data) : ''}`, LogLevel.DEBUG);
        }
        return Promise.resolve();
    };
    amplifyNotifications = async (msg) => {
        if (msg.action !== 'amplify') {
            return;
        }
        switch (msg.code) {
            case 'TS_STARTED':
                this.printer.startSpinner('Running type checks...');
                return;
            case 'TS_FINISHED':
                this.printer.stopSpinner();
                break;
            case 'SYNTH_STARTED':
                this.printer.startSpinner('Synthesizing backend...');
                return;
            case 'SYNTH_FINISHED':
                this.printer.stopSpinner();
                break;
            case 'DEPLOY_STARTED':
                this.printer.stopSpinner();
                break;
            case 'DEPLOY_FAILED':
                this.isHotSwap = false;
                return;
            case 'AMPLIFY_CFN_PROGRESS_UPDATE':
                if (!this.printer.isSpinnerRunning()) {
                    this.printer.startSpinner('Deployment in progress...');
                }
                this.printer.updateSpinner({ prefixText: msg.message });
                return;
            default:
                return;
        }
        this.printer.log(msg.level === 'result'
            ? `${format.success('✔')} ${msg.message}`
            : msg.level === 'error'
                ? format.error(msg.message)
                : msg.message, msg.level === 'error' ? LogLevel.ERROR : LogLevel.INFO);
    };
    cdkDeploymentProgress = async (msg) => {
        // Asset publishing if any.
        if (msg.message.includes('Checking for previously published assets')) {
            if (!this.printer.isSpinnerRunning()) {
                this.printer.startSpinner('Building and publishing assets...');
            }
            return Promise.resolve();
        }
        // Hot swap deployment
        if (msg.code === 'CDK_TOOLKIT_I5403') {
            const hotswappedResources = this.extractResourceNameFromHotSwapMessage(msg.data);
            let message = msg.message;
            if (hotswappedResources && hotswappedResources.length > 0) {
                this.isHotSwap = true;
                message = hotswappedResources
                    .map((resource) => `${format.success('✔')} Updated ${resource.resourceType} ${resource.resourceName}`)
                    .join(EOL);
            }
            if (this.printer.isSpinnerRunning()) {
                this.printer.stopSpinner();
                this.printer.log(message);
                this.printer.startSpinner('Deployment in progress...');
            }
            else {
                this.printer.log(message);
            }
        }
        // CFN Outputs we care about. CDK_TOOLKIT_I5900 code represents outputs message.
        // We save it so we can display at the end of the deployment.
        if (msg.code === 'CDK_TOOLKIT_I5900') {
            if (msg.data &&
                typeof msg.data === 'object' &&
                'outputs' in msg.data &&
                msg.data.outputs &&
                typeof msg.data.outputs === 'object') {
                this.outputs = msg.data.outputs;
            }
        }
        // Successful deployment or destruction with timing
        if (msg.code === 'CDK_TOOLKIT_I5000' || msg.code === 'CDK_TOOLKIT_I7000') {
            if (msg.data &&
                typeof msg.data === 'object' &&
                'duration' in msg.data &&
                msg.data.duration &&
                typeof msg.data.duration === 'number') {
                this.printer.log(`${format.success('✔')} Deployment completed in ${msg.data.duration / 1000} seconds`);
                if (this.outputs &&
                    'awsAppsyncApiEndpoint' in this.outputs &&
                    this.outputs.awsAppsyncApiEndpoint) {
                    this.printer.log(`AppSync API endpoint = ${format.link(this.outputs.awsAppsyncApiEndpoint)}`);
                }
                const span = openTelemetryTrace.getSpan(openTelemetryContext.active());
                if (this.isHotSwap && span) {
                    setSpanAttributes(span, {
                        latency: {
                            hotSwap: msg.data.duration,
                        },
                    });
                    this.isHotSwap = false;
                }
                else if (span) {
                    setSpanAttributes(span, {
                        latency: {
                            deployment: msg.data.duration,
                        },
                    });
                }
            }
        }
    };
    /**
     * Displays pretty print of cfn deployment progress. Disabled if debug logging is turned on
     * @param msg a CDK event
     */
    fancyCfnDeploymentProgress = async (msg) => {
        // 5100 -> Deployment starts 7100 -> Destroy starts
        if ((msg.code === 'CDK_TOOLKIT_I5100' || msg.code === 'CDK_TOOLKIT_I7100') &&
            !this.cfnDeploymentProgressLogger) {
            if (msg.code === 'CDK_TOOLKIT_I5100') {
                // Mark assets published. We use "deploy started" as a cue to mark that all assets have been published
                await this.amplifyIOEventsBridgeSingletonFactory.getInstance().notify({
                    message: `Built and published assets`,
                    code: 'DEPLOY_STARTED',
                    action: 'amplify',
                    time: new Date(),
                    level: 'result',
                    data: undefined,
                });
            }
            // Start deployment progress display
            this.cfnDeploymentProgressLogger = this.getNewCfnDeploymentProgressLogger(this.printer);
            this.printer.startSpinner('Deployment in progress...', {
                timeoutSeconds: 300,
            });
        }
        // Stop deployment progress display
        // 5000 includes deployment time
        // 5503 is when the deployment is completed (not emitted for some updates but emitted for destroy and fails)
        // 5900 includes the stack outputs
        // 7900 is when the stack is destroyed
        if (msg.code === 'CDK_TOOLKIT_I5000' ||
            msg.code === 'CDK_TOOLKIT_I5503' ||
            msg.code === 'CDK_TOOLKIT_I5900' ||
            msg.code === 'CDK_TOOLKIT_I7900') {
            if (this.cfnDeploymentProgressLogger) {
                this.printer.stopSpinner();
                this.cfnDeploymentProgressLogger = undefined;
            }
        }
        // CFN Deployment progress events information
        if (msg.code === 'CDK_TOOLKIT_I5502' &&
            msg.data &&
            typeof msg.data === 'object' &&
            'event' in msg.data) {
            const event = msg.data;
            this.cfnDeploymentProgressLogger?.addActivity(event);
        }
        // CDK Marker that deployment is still in progress, we take this opportunity
        // to display the aggregated events
        if (msg.code === 'CDK_TOOLKIT_I0000' &&
            msg.message.includes('has an ongoing operation in progress')) {
            await this.cfnDeploymentProgressLogger?.print();
        }
        return Promise.resolve();
    };
    /**
     * Non fancy cfn deployment progress for ci/cd or files
     */
    nonTtyCfnDeploymentProgress = async (msg) => {
        if (msg.code === 'CDK_TOOLKIT_I5100') {
            await this.amplifyIOEventsBridgeSingletonFactory.getInstance().notify({
                message: `Built and published assets`,
                code: 'DEPLOY_STARTED',
                action: 'amplify',
                time: new Date(),
                level: 'result',
                data: undefined,
            });
        }
        if (msg.code === 'CDK_TOOLKIT_I5502') {
            // CDKs formatted cfn deployment progress
            this.printer.print(msg.message);
        }
    };
    getNewCfnDeploymentProgressLogger = (printer) => {
        const getBlockWidth = () => printer.stdout instanceof WriteStream ? printer.stdout.columns : 600;
        const getBlockHeight = () => printer.stdout instanceof WriteStream ? printer.stdout.rows : 100;
        return new CfnDeploymentProgressLogger({
            getBlockWidth,
            rewritableBlock: new RewritableBlock(getBlockWidth, getBlockHeight, this.amplifyIOEventsBridgeSingletonFactory.getInstance()),
        });
    };
    extractResourceNameFromHotSwapMessage = (data) => {
        if (data &&
            typeof data === 'object' &&
            'resources' in data &&
            Array.isArray(data.resources)) {
            return data.resources.map((resource) => {
                return {
                    resourceName: resource?.metadata?.constructPath ?? resource.logicalId,
                    resourceType: resource.resourceType,
                };
            });
        }
        return undefined;
    };
    safeJsonStringifyForDebug = (data) => {
        try {
            return JSON.stringify(data, null, 2);
        }
        catch {
            return 'Failed to deserialize data';
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW1wbGlmeV9ldmVudF9sb2dnZXJzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2xvZ2dlcnMvYW1wbGlmeV9ldmVudF9sb2dnZXJzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQVcsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsT0FBTyxJQUFJLGFBQWEsRUFBRSxlQUFlLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDMUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzdDLE9BQU8sRUFDTCwyQkFBMkIsR0FFNUIsTUFBTSw2REFBNkQsQ0FBQztBQUVyRSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSwrQ0FBK0MsQ0FBQztBQUVoRixPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQzlCLE9BQU8sRUFDTCxPQUFPLElBQUksb0JBQW9CLEVBQy9CLEtBQUssSUFBSSxrQkFBa0IsR0FDNUIsTUFBTSxvQkFBb0IsQ0FBQztBQUM1QixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUUvRDs7O0dBR0c7QUFDSCxNQUFNLE9BQU8sa0JBQWtCO0lBU1Y7SUFDQTtJQVRYLDJCQUEyQixDQUEwQztJQUNyRSxPQUFPLEdBQUcsRUFBRSxDQUFDO0lBQ2IsU0FBUyxHQUFHLEtBQUssQ0FBQztJQUUxQjs7T0FFRztJQUNILFlBQ21CLFVBQW1CLGFBQWEsRUFDaEMscUNBQTRFO1FBRDVFLFlBQU8sR0FBUCxPQUFPLENBQXlCO1FBQ2hDLDBDQUFxQyxHQUFyQyxxQ0FBcUMsQ0FBdUM7SUFDNUYsQ0FBQztJQUVKLGVBQWUsR0FBRyxHQUFHLEVBQUU7UUFDckIsSUFBSSxlQUFlLEtBQUssUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ3ZDLE9BQU87Z0JB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QztRQUNKLENBQUM7UUFDRCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDLENBQUM7SUFFTSx5QkFBeUIsR0FBRyxDQUFDLElBQWEsRUFBRSxFQUFFO1FBQ3BELElBQUksQ0FBQztZQUNILE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3ZDLENBQUM7UUFBQyxNQUFNLENBQUM7WUFDUCxPQUFPLDRCQUE0QixDQUFDO1FBQ3RDLENBQUM7SUFDSCxDQUFDLENBQUM7Q0FDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExvZ0xldmVsLCBQcmludGVyIH0gZnJvbSAnLi4vcHJpbnRlci9wcmludGVyLmpzJztcbmltcG9ydCB7IHByaW50ZXIgYXMgZ2xvYmFsUHJpbnRlciwgbWluaW11bUxvZ0xldmVsIH0gZnJvbSAnLi4vcHJpbnRlci5qcyc7XG5pbXBvcnQgeyBmb3JtYXQgfSBmcm9tICcuLi9mb3JtYXQvZm9ybWF0LmpzJztcbmltcG9ydCB7XG4gIENmbkRlcGxveW1lbnRQcm9ncmVzc0xvZ2dlcixcbiAgQ2ZuRGVwbG95bWVudFN0YWNrRXZlbnQsXG59IGZyb20gJy4vY2ZuLWRlcGxveW1lbnQtcHJvZ3Jlc3MvY2ZuX2RlcGxveW1lbnRfcHJvZ3Jlc3NfbG9nZ2VyLmpzJztcbmltcG9ydCB7IEFtcGxpZnlJb0hvc3RFdmVudE1lc3NhZ2UgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7IFdyaXRlU3RyZWFtIH0gZnJvbSAnbm9kZTp0dHknO1xuaW1wb3J0IHsgUmV3cml0YWJsZUJsb2NrIH0gZnJvbSAnLi9jZm4tZGVwbG95bWVudC1wcm9ncmVzcy9yZXdyaXRhYmxlX2Jsb2NrLmpzJztcbmltcG9ydCB7IEFtcGxpZnlJT0V2ZW50c0JyaWRnZVNpbmdsZXRvbkZhY3RvcnkgfSBmcm9tICcuL2FtcGxpZnlfaW9fZXZlbnRzX2JyaWRnZV9zaW5nbGV0b25fZmFjdG9yeS5qcyc7XG5pbXBvcnQgeyBFT0wgfSBmcm9tICdub2RlOm9zJztcbmltcG9ydCB7XG4gIGNvbnRleHQgYXMgb3BlblRlbGVtZXRyeUNvbnRleHQsXG4gIHRyYWNlIGFzIG9wZW5UZWxlbWV0cnlUcmFjZSxcbn0gZnJvbSAnQG9wZW50ZWxlbWV0cnkvYXBpJztcbmltcG9ydCB7IHNldFNwYW5BdHRyaWJ1dGVzIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsYXRmb3JtLWNvcmUnO1xuXG4vKipcbiAqIEFtcGxpZnkgZXZlbnRzIGxvZ2dlciBjbGFzcy4gSW1wbGVtZW50cyBzZXZlcmFsIGxvZ2dlcnMgdGhhdCBjb25uZWN0XG4gKiB0byB0aGUgYW1wbGlmeV9pb19ldmVudF9icmlkZ2UgZm9yIHNob3dpbmcgcmVsZXZhbnQgaW5mb3JtYXRpb24gdG8gY3VzdG9tZXJzXG4gKi9cbmV4cG9ydCBjbGFzcyBBbXBsaWZ5RXZlbnRMb2dnZXIge1xuICBwcml2YXRlIGNmbkRlcGxveW1lbnRQcm9ncmVzc0xvZ2dlcjogQ2ZuRGVwbG95bWVudFByb2dyZXNzTG9nZ2VyIHwgdW5kZWZpbmVkO1xuICBwcml2YXRlIG91dHB1dHMgPSB7fTtcbiAgcHJpdmF0ZSBpc0hvdFN3YXAgPSBmYWxzZTtcblxuICAvKipcbiAgICogYSBsb2dnZXIgaW5zdGFuY2UgdG8gYmUgdXNlZCBmb3IgQ0RLIGV2ZW50c1xuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcmludGVyOiBQcmludGVyID0gZ2xvYmFsUHJpbnRlcixcbiAgICBwcml2YXRlIHJlYWRvbmx5IGFtcGxpZnlJT0V2ZW50c0JyaWRnZVNpbmdsZXRvbkZhY3Rvcnk6IEFtcGxpZnlJT0V2ZW50c0JyaWRnZVNpbmdsZXRvbkZhY3RvcnksXG4gICkge31cblxuICBnZXRFdmVudExvZ2dlcnMgPSAoKSA9PiB7XG4gICAgaWYgKG1pbmltdW1Mb2dMZXZlbCA9PT0gTG9nTGV2ZWwuREVCVUcpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIG5vdGlmeTogW3RoaXMuZGVidWddLFxuICAgICAgfTtcbiAgICB9XG4gICAgY29uc3QgbG9nZ2VycyA9IFt0aGlzLmFtcGxpZnlOb3RpZmljYXRpb25zLCB0aGlzLmNka0RlcGxveW1lbnRQcm9ncmVzc107XG4gICAgaWYgKHRoaXMucHJpbnRlci50dHlFbmFibGVkKSB7XG4gICAgICBsb2dnZXJzLnB1c2godGhpcy5mYW5jeUNmbkRlcGxveW1lbnRQcm9ncmVzcyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZ2dlcnMucHVzaCh0aGlzLm5vblR0eUNmbkRlcGxveW1lbnRQcm9ncmVzcyk7XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICBub3RpZnk6IGxvZ2dlcnMsXG4gICAgfTtcbiAgfTtcblxuICAvKipcbiAgICogTG9nIGRlYnVnIG1lc3NhZ2VzXG4gICAqL1xuICBkZWJ1ZyA9IDxUPihtc2c6IEFtcGxpZnlJb0hvc3RFdmVudE1lc3NhZ2U8VD4pOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICBpZiAobXNnLmxldmVsID09PSAndHJhY2UnIHx8IG1zZy5sZXZlbCA9PT0gJ2RlYnVnJykge1xuICAgICAgaWYgKFxuICAgICAgICBtc2cuZGF0YSAmJlxuICAgICAgICB0eXBlb2YgbXNnLmRhdGEgPT09ICdvYmplY3QnICYmXG4gICAgICAgICdzZGtMZXZlbCcgaW4gbXNnLmRhdGEgJiZcbiAgICAgICAgJ2NvbnRlbnQnIGluIG1zZy5kYXRhICYmXG4gICAgICAgIEFycmF5LmlzQXJyYXkobXNnLmRhdGEuY29udGVudClcbiAgICAgICkge1xuICAgICAgICBtc2cuZGF0YS5jb250ZW50LmZvckVhY2goXG4gICAgICAgICAgKHRyYWNlOiB7IGNsaWVudE5hbWU6IHN0cmluZzsgY29tbWFuZE5hbWU6IHN0cmluZyB9KSA9PiB7XG4gICAgICAgICAgICB0aGlzLnByaW50ZXIubG9nKFxuICAgICAgICAgICAgICBgQVdTIFNESyBDYWxsICR7dHJhY2UuY2xpZW50TmFtZX06ICR7dHJhY2UuY29tbWFuZE5hbWV9YCxcbiAgICAgICAgICAgICAgTG9nTGV2ZWwuREVCVUcsXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0sXG4gICAgICAgICk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnByaW50ZXIubG9nKFxuICAgICAgICAgIGBbJHttc2cuYWN0aW9ufTogJHttc2cuY29kZX1dICR7bXNnLm1lc3NhZ2V9YCxcbiAgICAgICAgICBMb2dMZXZlbC5ERUJVRyxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5wcmludGVyLmxvZyhcbiAgICAgICAgYFske2Zvcm1hdC5jb2xvcihcbiAgICAgICAgICBgJHttc2cuYWN0aW9ufTogJHttc2cuY29kZX1gLFxuICAgICAgICAgIG1zZy5sZXZlbCA9PT0gJ2Vycm9yJ1xuICAgICAgICAgICAgPyAnUmVkJ1xuICAgICAgICAgICAgOiBtc2cubGV2ZWwgPT09ICd3YXJuJ1xuICAgICAgICAgICAgICA/ICdZZWxsb3cnXG4gICAgICAgICAgICAgIDogJ0dyZWVuJyxcbiAgICAgICAgKX1dICR7Zm9ybWF0Lm5vdGUoXG4gICAgICAgICAgbXNnLnRpbWUudG9Mb2NhbGVUaW1lU3RyaW5nKCksXG4gICAgICAgICl9ICR7bXNnLm1lc3NhZ2UudHJpbSgpfSAke1xuICAgICAgICAgIG1zZy5kYXRhID8gdGhpcy5zYWZlSnNvblN0cmluZ2lmeUZvckRlYnVnKG1zZy5kYXRhKSA6ICcnXG4gICAgICAgIH1gLFxuICAgICAgICBMb2dMZXZlbC5ERUJVRyxcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgfTtcblxuICBhbXBsaWZ5Tm90aWZpY2F0aW9ucyA9IGFzeW5jIDxUPihcbiAgICBtc2c6IEFtcGxpZnlJb0hvc3RFdmVudE1lc3NhZ2U8VD4sXG4gICk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIGlmIChtc2cuYWN0aW9uICE9PSAnYW1wbGlmeScpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgc3dpdGNoIChtc2cuY29kZSkge1xuICAgICAgY2FzZSAnVFNfU1RBUlRFRCc6XG4gICAgICAgIHRoaXMucHJpbnRlci5zdGFydFNwaW5uZXIoJ1J1bm5pbmcgdHlwZSBjaGVja3MuLi4nKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgY2FzZSAnVFNfRklOSVNIRUQnOlxuICAgICAgICB0aGlzLnByaW50ZXIuc3RvcFNwaW5uZXIoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdTWU5USF9TVEFSVEVEJzpcbiAgICAgICAgdGhpcy5wcmludGVyLnN0YXJ0U3Bpbm5lcignU3ludGhlc2l6aW5nIGJhY2tlbmQuLi4nKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgY2FzZSAnU1lOVEhfRklOSVNIRUQnOlxuICAgICAgICB0aGlzLnByaW50ZXIuc3RvcFNwaW5uZXIoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdERVBMT1lfU1RBUlRFRCc6XG4gICAgICAgIHRoaXMucHJpbnRlci5zdG9wU3Bpbm5lcigpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ0RFUExPWV9GQUlMRUQnOlxuICAgICAgICB0aGlzLmlzSG90U3dhcCA9IGZhbHNlO1xuICAgICAgICByZXR1cm47XG4gICAgICBjYXNlICdBTVBMSUZZX0NGTl9QUk9HUkVTU19VUERBVEUnOlxuICAgICAgICBpZiAoIXRoaXMucHJpbnRlci5pc1NwaW5uZXJSdW5uaW5nKCkpIHtcbiAgICAgICAgICB0aGlzLnByaW50ZXIuc3RhcnRTcGlubmVyKCdEZXBsb3ltZW50IGluIHByb2dyZXNzLi4uJyk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5wcmludGVyLnVwZGF0ZVNwaW5uZXIoeyBwcmVmaXhUZXh0OiBtc2cubWVzc2FnZSB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLnByaW50ZXIubG9nKFxuICAgICAgbXNnLmxldmVsID09PSAncmVzdWx0J1xuICAgICAgICA/IGAke2Zvcm1hdC5zdWNjZXNzKCfinJQnKX0gJHttc2cubWVzc2FnZX1gXG4gICAgICAgIDogbXNnLmxldmVsID09PSAnZXJyb3InXG4gICAgICAgICAgPyBmb3JtYXQuZXJyb3IobXNnLm1lc3NhZ2UpXG4gICAgICAgICAgOiBtc2cubWVzc2FnZSxcbiAgICAgIG1zZy5sZXZlbCA9PT0gJ2Vycm9yJyA/IExvZ0xldmVsLkVSUk9SIDogTG9nTGV2ZWwuSU5GTyxcbiAgICApO1xuICB9O1xuXG4gIGNka0RlcGxveW1lbnRQcm9ncmVzcyA9IGFzeW5jIDxUPihcbiAgICBtc2c6IEFtcGxpZnlJb0hvc3RFdmVudE1lc3NhZ2U8VD4sXG4gICk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIC8vIEFzc2V0IHB1Ymxpc2hpbmcgaWYgYW55LlxuICAgIGlmIChtc2cubWVzc2FnZS5pbmNsdWRlcygnQ2hlY2tpbmcgZm9yIHByZXZpb3VzbHkgcHVibGlzaGVkIGFzc2V0cycpKSB7XG4gICAgICBpZiAoIXRoaXMucHJpbnRlci5pc1NwaW5uZXJSdW5uaW5nKCkpIHtcbiAgICAgICAgdGhpcy5wcmludGVyLnN0YXJ0U3Bpbm5lcignQnVpbGRpbmcgYW5kIHB1Ymxpc2hpbmcgYXNzZXRzLi4uJyk7XG4gICAgICB9XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfVxuXG4gICAgLy8gSG90IHN3YXAgZGVwbG95bWVudFxuICAgIGlmIChtc2cuY29kZSA9PT0gJ0NES19UT09MS0lUX0k1NDAzJykge1xuICAgICAgY29uc3QgaG90c3dhcHBlZFJlc291cmNlcyA9IHRoaXMuZXh0cmFjdFJlc291cmNlTmFtZUZyb21Ib3RTd2FwTWVzc2FnZShcbiAgICAgICAgbXNnLmRhdGEsXG4gICAgICApO1xuICAgICAgbGV0IG1lc3NhZ2UgPSBtc2cubWVzc2FnZTtcbiAgICAgIGlmIChob3Rzd2FwcGVkUmVzb3VyY2VzICYmIGhvdHN3YXBwZWRSZXNvdXJjZXMubGVuZ3RoID4gMCkge1xuICAgICAgICB0aGlzLmlzSG90U3dhcCA9IHRydWU7XG4gICAgICAgIG1lc3NhZ2UgPSBob3Rzd2FwcGVkUmVzb3VyY2VzXG4gICAgICAgICAgLm1hcChcbiAgICAgICAgICAgIChyZXNvdXJjZSkgPT5cbiAgICAgICAgICAgICAgYCR7Zm9ybWF0LnN1Y2Nlc3MoJ+KclCcpfSBVcGRhdGVkICR7cmVzb3VyY2UucmVzb3VyY2VUeXBlfSAke3Jlc291cmNlLnJlc291cmNlTmFtZX1gLFxuICAgICAgICAgIClcbiAgICAgICAgICAuam9pbihFT0wpO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMucHJpbnRlci5pc1NwaW5uZXJSdW5uaW5nKCkpIHtcbiAgICAgICAgdGhpcy5wcmludGVyLnN0b3BTcGlubmVyKCk7XG4gICAgICAgIHRoaXMucHJpbnRlci5sb2cobWVzc2FnZSk7XG4gICAgICAgIHRoaXMucHJpbnRlci5zdGFydFNwaW5uZXIoJ0RlcGxveW1lbnQgaW4gcHJvZ3Jlc3MuLi4nKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMucHJpbnRlci5sb2cobWVzc2FnZSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gQ0ZOIE91dHB1dHMgd2UgY2FyZSBhYm91dC4gQ0RLX1RPT0xLSVRfSTU5MDAgY29kZSByZXByZXNlbnRzIG91dHB1dHMgbWVzc2FnZS5cbiAgICAvLyBXZSBzYXZlIGl0IHNvIHdlIGNhbiBkaXNwbGF5IGF0IHRoZSBlbmQgb2YgdGhlIGRlcGxveW1lbnQuXG4gICAgaWYgKG1zZy5jb2RlID09PSAnQ0RLX1RPT0xLSVRfSTU5MDAnKSB7XG4gICAgICBpZiAoXG4gICAgICAgIG1zZy5kYXRhICYmXG4gICAgICAgIHR5cGVvZiBtc2cuZGF0YSA9PT0gJ29iamVjdCcgJiZcbiAgICAgICAgJ291dHB1dHMnIGluIG1zZy5kYXRhICYmXG4gICAgICAgIG1zZy5kYXRhLm91dHB1dHMgJiZcbiAgICAgICAgdHlwZW9mIG1zZy5kYXRhLm91dHB1dHMgPT09ICdvYmplY3QnXG4gICAgICApIHtcbiAgICAgICAgdGhpcy5vdXRwdXRzID0gbXNnLmRhdGEub3V0cHV0cztcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBTdWNjZXNzZnVsIGRlcGxveW1lbnQgb3IgZGVzdHJ1Y3Rpb24gd2l0aCB0aW1pbmdcbiAgICBpZiAobXNnLmNvZGUgPT09ICdDREtfVE9PTEtJVF9JNTAwMCcgfHwgbXNnLmNvZGUgPT09ICdDREtfVE9PTEtJVF9JNzAwMCcpIHtcbiAgICAgIGlmIChcbiAgICAgICAgbXNnLmRhdGEgJiZcbiAgICAgICAgdHlwZW9mIG1zZy5kYXRhID09PSAnb2JqZWN0JyAmJlxuICAgICAgICAnZHVyYXRpb24nIGluIG1zZy5kYXRhICYmXG4gICAgICAgIG1zZy5kYXRhLmR1cmF0aW9uICYmXG4gICAgICAgIHR5cGVvZiBtc2cuZGF0YS5kdXJhdGlvbiA9PT0gJ251bWJlcidcbiAgICAgICkge1xuICAgICAgICB0aGlzLnByaW50ZXIubG9nKFxuICAgICAgICAgIGAke2Zvcm1hdC5zdWNjZXNzKCfinJQnKX0gRGVwbG95bWVudCBjb21wbGV0ZWQgaW4gJHtcbiAgICAgICAgICAgIG1zZy5kYXRhLmR1cmF0aW9uIC8gMTAwMFxuICAgICAgICAgIH0gc2Vjb25kc2AsXG4gICAgICAgICk7XG4gICAgICAgIGlmIChcbiAgICAgICAgICB0aGlzLm91dHB1dHMgJiZcbiAgICAgICAgICAnYXdzQXBwc3luY0FwaUVuZHBvaW50JyBpbiB0aGlzLm91dHB1dHMgJiZcbiAgICAgICAgICB0aGlzLm91dHB1dHMuYXdzQXBwc3luY0FwaUVuZHBvaW50XG4gICAgICAgICkge1xuICAgICAgICAgIHRoaXMucHJpbnRlci5sb2coXG4gICAgICAgICAgICBgQXBwU3luYyBBUEkgZW5kcG9pbnQgPSAke2Zvcm1hdC5saW5rKFxuICAgICAgICAgICAgICB0aGlzLm91dHB1dHMuYXdzQXBwc3luY0FwaUVuZHBvaW50IGFzIHN0cmluZyxcbiAgICAgICAgICAgICl9YCxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHNwYW4gPSBvcGVuVGVsZW1ldHJ5VHJhY2UuZ2V0U3BhbihvcGVuVGVsZW1ldHJ5Q29udGV4dC5hY3RpdmUoKSk7XG4gICAgICAgIGlmICh0aGlzLmlzSG90U3dhcCAmJiBzcGFuKSB7XG4gICAgICAgICAgc2V0U3BhbkF0dHJpYnV0ZXMoc3Bhbiwge1xuICAgICAgICAgICAgbGF0ZW5jeToge1xuICAgICAgICAgICAgICBob3RTd2FwOiBtc2cuZGF0YS5kdXJhdGlvbixcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgdGhpcy5pc0hvdFN3YXAgPSBmYWxzZTtcbiAgICAgICAgfSBlbHNlIGlmIChzcGFuKSB7XG4gICAgICAgICAgc2V0U3BhbkF0dHJpYnV0ZXMoc3Bhbiwge1xuICAgICAgICAgICAgbGF0ZW5jeToge1xuICAgICAgICAgICAgICBkZXBsb3ltZW50OiBtc2cuZGF0YS5kdXJhdGlvbixcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH07XG5cbiAgLyoqXG4gICAqIERpc3BsYXlzIHByZXR0eSBwcmludCBvZiBjZm4gZGVwbG95bWVudCBwcm9ncmVzcy4gRGlzYWJsZWQgaWYgZGVidWcgbG9nZ2luZyBpcyB0dXJuZWQgb25cbiAgICogQHBhcmFtIG1zZyBhIENESyBldmVudFxuICAgKi9cbiAgZmFuY3lDZm5EZXBsb3ltZW50UHJvZ3Jlc3MgPSBhc3luYyA8VD4oXG4gICAgbXNnOiBBbXBsaWZ5SW9Ib3N0RXZlbnRNZXNzYWdlPFQ+LFxuICApOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICAvLyA1MTAwIC0+IERlcGxveW1lbnQgc3RhcnRzIDcxMDAgLT4gRGVzdHJveSBzdGFydHNcbiAgICBpZiAoXG4gICAgICAobXNnLmNvZGUgPT09ICdDREtfVE9PTEtJVF9JNTEwMCcgfHwgbXNnLmNvZGUgPT09ICdDREtfVE9PTEtJVF9JNzEwMCcpICYmXG4gICAgICAhdGhpcy5jZm5EZXBsb3ltZW50UHJvZ3Jlc3NMb2dnZXJcbiAgICApIHtcbiAgICAgIGlmIChtc2cuY29kZSA9PT0gJ0NES19UT09MS0lUX0k1MTAwJykge1xuICAgICAgICAvLyBNYXJrIGFzc2V0cyBwdWJsaXNoZWQuIFdlIHVzZSBcImRlcGxveSBzdGFydGVkXCIgYXMgYSBjdWUgdG8gbWFyayB0aGF0IGFsbCBhc3NldHMgaGF2ZSBiZWVuIHB1Ymxpc2hlZFxuICAgICAgICBhd2FpdCB0aGlzLmFtcGxpZnlJT0V2ZW50c0JyaWRnZVNpbmdsZXRvbkZhY3RvcnkuZ2V0SW5zdGFuY2UoKS5ub3RpZnkoe1xuICAgICAgICAgIG1lc3NhZ2U6IGBCdWlsdCBhbmQgcHVibGlzaGVkIGFzc2V0c2AsXG4gICAgICAgICAgY29kZTogJ0RFUExPWV9TVEFSVEVEJyxcbiAgICAgICAgICBhY3Rpb246ICdhbXBsaWZ5JyxcbiAgICAgICAgICB0aW1lOiBuZXcgRGF0ZSgpLFxuICAgICAgICAgIGxldmVsOiAncmVzdWx0JyxcbiAgICAgICAgICBkYXRhOiB1bmRlZmluZWQsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBTdGFydCBkZXBsb3ltZW50IHByb2dyZXNzIGRpc3BsYXlcbiAgICAgIHRoaXMuY2ZuRGVwbG95bWVudFByb2dyZXNzTG9nZ2VyID0gdGhpcy5nZXROZXdDZm5EZXBsb3ltZW50UHJvZ3Jlc3NMb2dnZXIoXG4gICAgICAgIHRoaXMucHJpbnRlcixcbiAgICAgICk7XG4gICAgICB0aGlzLnByaW50ZXIuc3RhcnRTcGlubmVyKCdEZXBsb3ltZW50IGluIHByb2dyZXNzLi4uJywge1xuICAgICAgICB0aW1lb3V0U2Vjb25kczogMzAwLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gU3RvcCBkZXBsb3ltZW50IHByb2dyZXNzIGRpc3BsYXlcbiAgICAvLyA1MDAwIGluY2x1ZGVzIGRlcGxveW1lbnQgdGltZVxuICAgIC8vIDU1MDMgaXMgd2hlbiB0aGUgZGVwbG95bWVudCBpcyBjb21wbGV0ZWQgKG5vdCBlbWl0dGVkIGZvciBzb21lIHVwZGF0ZXMgYnV0IGVtaXR0ZWQgZm9yIGRlc3Ryb3kgYW5kIGZhaWxzKVxuICAgIC8vIDU5MDAgaW5jbHVkZXMgdGhlIHN0YWNrIG91dHB1dHNcbiAgICAvLyA3OTAwIGlzIHdoZW4gdGhlIHN0YWNrIGlzIGRlc3Ryb3llZFxuICAgIGlmIChcbiAgICAgIG1zZy5jb2RlID09PSAnQ0RLX1RPT0xLSVRfSTUwMDAnIHx8XG4gICAgICBtc2cuY29kZSA9PT0gJ0NES19UT09MS0lUX0k1NTAzJyB8fFxuICAgICAgbXNnLmNvZGUgPT09ICdDREtfVE9PTEtJVF9JNTkwMCcgfHxcbiAgICAgIG1zZy5jb2RlID09PSAnQ0RLX1RPT0xLSVRfSTc5MDAnXG4gICAgKSB7XG4gICAgICBpZiAodGhpcy5jZm5EZXBsb3ltZW50UHJvZ3Jlc3NMb2dnZXIpIHtcbiAgICAgICAgdGhpcy5wcmludGVyLnN0b3BTcGlubmVyKCk7XG4gICAgICAgIHRoaXMuY2ZuRGVwbG95bWVudFByb2dyZXNzTG9nZ2VyID0gdW5kZWZpbmVkO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIENGTiBEZXBsb3ltZW50IHByb2dyZXNzIGV2ZW50cyBpbmZvcm1hdGlvblxuICAgIGlmIChcbiAgICAgIG1zZy5jb2RlID09PSAnQ0RLX1RPT0xLSVRfSTU1MDInICYmXG4gICAgICBtc2cuZGF0YSAmJlxuICAgICAgdHlwZW9mIG1zZy5kYXRhID09PSAnb2JqZWN0JyAmJlxuICAgICAgJ2V2ZW50JyBpbiBtc2cuZGF0YVxuICAgICkge1xuICAgICAgY29uc3QgZXZlbnQgPSBtc2cuZGF0YSBhcyBDZm5EZXBsb3ltZW50U3RhY2tFdmVudDtcbiAgICAgIHRoaXMuY2ZuRGVwbG95bWVudFByb2dyZXNzTG9nZ2VyPy5hZGRBY3Rpdml0eShldmVudCk7XG4gICAgfVxuXG4gICAgLy8gQ0RLIE1hcmtlciB0aGF0IGRlcGxveW1lbnQgaXMgc3RpbGwgaW4gcHJvZ3Jlc3MsIHdlIHRha2UgdGhpcyBvcHBvcnR1bml0eVxuICAgIC8vIHRvIGRpc3BsYXkgdGhlIGFnZ3JlZ2F0ZWQgZXZlbnRzXG4gICAgaWYgKFxuICAgICAgbXNnLmNvZGUgPT09ICdDREtfVE9PTEtJVF9JMDAwMCcgJiZcbiAgICAgIG1zZy5tZXNzYWdlLmluY2x1ZGVzKCdoYXMgYW4gb25nb2luZyBvcGVyYXRpb24gaW4gcHJvZ3Jlc3MnKVxuICAgICkge1xuICAgICAgYXdhaXQgdGhpcy5jZm5EZXBsb3ltZW50UHJvZ3Jlc3NMb2dnZXI/LnByaW50KCk7XG4gICAgfVxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgfTtcblxuICAvKipcbiAgICogTm9uIGZhbmN5IGNmbiBkZXBsb3ltZW50IHByb2dyZXNzIGZvciBjaS9jZCBvciBmaWxlc1xuICAgKi9cbiAgbm9uVHR5Q2ZuRGVwbG95bWVudFByb2dyZXNzID0gYXN5bmMgPFQ+KFxuICAgIG1zZzogQW1wbGlmeUlvSG9zdEV2ZW50TWVzc2FnZTxUPixcbiAgKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgaWYgKG1zZy5jb2RlID09PSAnQ0RLX1RPT0xLSVRfSTUxMDAnKSB7XG4gICAgICBhd2FpdCB0aGlzLmFtcGxpZnlJT0V2ZW50c0JyaWRnZVNpbmdsZXRvbkZhY3RvcnkuZ2V0SW5zdGFuY2UoKS5ub3RpZnkoe1xuICAgICAgICBtZXNzYWdlOiBgQnVpbHQgYW5kIHB1Ymxpc2hlZCBhc3NldHNgLFxuICAgICAgICBjb2RlOiAnREVQTE9ZX1NUQVJURUQnLFxuICAgICAgICBhY3Rpb246ICdhbXBsaWZ5JyxcbiAgICAgICAgdGltZTogbmV3IERhdGUoKSxcbiAgICAgICAgbGV2ZWw6ICdyZXN1bHQnLFxuICAgICAgICBkYXRhOiB1bmRlZmluZWQsXG4gICAgICB9KTtcbiAgICB9XG4gICAgaWYgKG1zZy5jb2RlID09PSAnQ0RLX1RPT0xLSVRfSTU1MDInKSB7XG4gICAgICAvLyBDREtzIGZvcm1hdHRlZCBjZm4gZGVwbG95bWVudCBwcm9ncmVzc1xuICAgICAgdGhpcy5wcmludGVyLnByaW50KG1zZy5tZXNzYWdlKTtcbiAgICB9XG4gIH07XG5cbiAgcHJpdmF0ZSBnZXROZXdDZm5EZXBsb3ltZW50UHJvZ3Jlc3NMb2dnZXIgPSAocHJpbnRlcjogUHJpbnRlcikgPT4ge1xuICAgIGNvbnN0IGdldEJsb2NrV2lkdGggPSAoKSA9PlxuICAgICAgcHJpbnRlci5zdGRvdXQgaW5zdGFuY2VvZiBXcml0ZVN0cmVhbSA/IHByaW50ZXIuc3Rkb3V0LmNvbHVtbnMgOiA2MDA7XG4gICAgY29uc3QgZ2V0QmxvY2tIZWlnaHQgPSAoKSA9PlxuICAgICAgcHJpbnRlci5zdGRvdXQgaW5zdGFuY2VvZiBXcml0ZVN0cmVhbSA/IHByaW50ZXIuc3Rkb3V0LnJvd3MgOiAxMDA7XG4gICAgcmV0dXJuIG5ldyBDZm5EZXBsb3ltZW50UHJvZ3Jlc3NMb2dnZXIoe1xuICAgICAgZ2V0QmxvY2tXaWR0aCxcbiAgICAgIHJld3JpdGFibGVCbG9jazogbmV3IFJld3JpdGFibGVCbG9jayhcbiAgICAgICAgZ2V0QmxvY2tXaWR0aCxcbiAgICAgICAgZ2V0QmxvY2tIZWlnaHQsXG4gICAgICAgIHRoaXMuYW1wbGlmeUlPRXZlbnRzQnJpZGdlU2luZ2xldG9uRmFjdG9yeS5nZXRJbnN0YW5jZSgpLFxuICAgICAgKSxcbiAgICB9KTtcbiAgfTtcblxuICBwcml2YXRlIGV4dHJhY3RSZXNvdXJjZU5hbWVGcm9tSG90U3dhcE1lc3NhZ2UgPSAoXG4gICAgZGF0YTogdW5rbm93bixcbiAgKTogeyByZXNvdXJjZVR5cGU6IHN0cmluZzsgcmVzb3VyY2VOYW1lOiBzdHJpbmcgfVtdIHwgdW5kZWZpbmVkID0+IHtcbiAgICBpZiAoXG4gICAgICBkYXRhICYmXG4gICAgICB0eXBlb2YgZGF0YSA9PT0gJ29iamVjdCcgJiZcbiAgICAgICdyZXNvdXJjZXMnIGluIGRhdGEgJiZcbiAgICAgIEFycmF5LmlzQXJyYXkoZGF0YS5yZXNvdXJjZXMpXG4gICAgKSB7XG4gICAgICByZXR1cm4gZGF0YS5yZXNvdXJjZXMubWFwKFxuICAgICAgICAocmVzb3VyY2U6IHtcbiAgICAgICAgICBsb2dpY2FsSWQ6IHN0cmluZztcbiAgICAgICAgICByZXNvdXJjZVR5cGU6IHN0cmluZztcbiAgICAgICAgICBtZXRhZGF0YT86IHsgY29uc3RydWN0UGF0aD86IHN0cmluZyB9O1xuICAgICAgICB9KSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHJlc291cmNlTmFtZTpcbiAgICAgICAgICAgICAgcmVzb3VyY2U/Lm1ldGFkYXRhPy5jb25zdHJ1Y3RQYXRoID8/IHJlc291cmNlLmxvZ2ljYWxJZCxcbiAgICAgICAgICAgIHJlc291cmNlVHlwZTogcmVzb3VyY2UucmVzb3VyY2VUeXBlLFxuICAgICAgICAgIH07XG4gICAgICAgIH0sXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9O1xuXG4gIHByaXZhdGUgc2FmZUpzb25TdHJpbmdpZnlGb3JEZWJ1ZyA9IChkYXRhOiB1bmtub3duKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShkYXRhLCBudWxsLCAyKTtcbiAgICB9IGNhdGNoIHtcbiAgICAgIHJldHVybiAnRmFpbGVkIHRvIGRlc2VyaWFsaXplIGRhdGEnO1xuICAgIH1cbiAgfTtcbn1cbiJdfQ==