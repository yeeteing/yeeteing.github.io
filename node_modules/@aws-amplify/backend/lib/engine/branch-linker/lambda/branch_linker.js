import { randomUUID } from 'node:crypto';
import { AmplifyClient, GetBranchCommand, NotFoundException, UpdateBranchCommand, } from '@aws-sdk/client-amplify';
/**
 * Handles custom resource events.
 */
export class AmplifyBranchLinkerCustomResourceEventHandler {
    amplifyClient;
    /**
     * Creates the custom resource events handler.
     */
    constructor(amplifyClient) {
        this.amplifyClient = amplifyClient;
    }
    handleCustomResourceEvent = async (event) => {
        console.info(`Received '${event.RequestType}' event`);
        const physicalId = event.RequestType === 'Create' ? randomUUID() : event.PhysicalResourceId;
        const props = event.ResourceProperties;
        switch (event.RequestType) {
            case 'Create':
            case 'Update':
                console.info(`Setting stack reference for appId=${props.appId},branchName=${props.branchName} to ${event.StackId}`);
                await this.updateOrUnsetStackReference(props.appId, props.branchName, event.StackId);
                break;
            case 'Delete':
                console.info(`Un-setting stack reference for appId=${props.appId},branchName=${props.branchName}`);
                try {
                    await this.updateOrUnsetStackReference(props.appId, props.branchName, undefined);
                }
                catch (e) {
                    if (e instanceof NotFoundException) {
                        console.info(`Branch branchName=${props.branchName} of appId=${props.appId} was not found while handling delete event`);
                    }
                    else {
                        throw e;
                    }
                }
                break;
        }
        return {
            RequestId: event.RequestId,
            LogicalResourceId: event.LogicalResourceId,
            PhysicalResourceId: physicalId,
            StackId: event.StackId,
            Status: 'SUCCESS',
        };
    };
    updateOrUnsetStackReference = async (appId, branchName, stackId) => {
        // Stack id is in ARN format.
        if (stackId && !stackId?.startsWith('arn:')) {
            throw new Error(`Provided stackId ${stackId} is not in ARN format`);
        }
        const branch = await this.getBranch(appId, branchName);
        console.info(`Received details of branchName=${branchName} of appId=${appId}`);
        // Populate update command input with existing values, so we don't lose them.
        const updateBranchCommandInput = {
            appId,
            ...branch,
        };
        // This is a known bug in the service. I.e. branch can be created without stage
        // but service returns 'NONE' instead of undefined which is not part of
        // Stage enum...
        if (updateBranchCommandInput.stage === 'NONE') {
            updateBranchCommandInput.stage = undefined;
        }
        // Set or unset stackId
        if (stackId) {
            if (!updateBranchCommandInput.backend) {
                updateBranchCommandInput.backend = {};
            }
            updateBranchCommandInput.backend.stackArn = stackId;
        }
        else {
            if (updateBranchCommandInput.backend?.stackArn) {
                delete updateBranchCommandInput.backend.stackArn;
            }
        }
        console.info(`Sending update of branchName=${branchName} of appId=${appId}`);
        await this.amplifyClient.send(new UpdateBranchCommand(updateBranchCommandInput));
    };
    getBranch = async (appId, branchName) => {
        const branch = (await this.amplifyClient.send(new GetBranchCommand({ appId, branchName }))).branch;
        if (!branch) {
            throw new Error(`Unable to get branch ${branchName} for app ${appId}`);
        }
        return branch;
    };
}
const customResourceEventHandler = new AmplifyBranchLinkerCustomResourceEventHandler(new AmplifyClient());
/**
 * Entry point for the lambda-backend custom resource to link deployment to branch.
 */
export const handler = (event) => {
    return customResourceEventHandler.handleCustomResourceEvent(event);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnJhbmNoX2xpbmtlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9lbmdpbmUvYnJhbmNoLWxpbmtlci9sYW1iZGEvYnJhbmNoX2xpbmtlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFJQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3pDLE9BQU8sRUFDTCxhQUFhLEVBRWIsZ0JBQWdCLEVBQ2hCLGlCQUFpQixFQUNqQixtQkFBbUIsR0FFcEIsTUFBTSx5QkFBeUIsQ0FBQztBQUdqQzs7R0FFRztBQUNILE1BQU0sT0FBTyw2Q0FBNkM7SUFJM0I7SUFIN0I7O09BRUc7SUFDSCxZQUE2QixhQUE0QjtRQUE1QixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtJQUFHLENBQUM7SUFFN0QseUJBQXlCLEdBQUcsS0FBSyxFQUMvQixLQUF3QyxFQUNjLEVBQUU7UUFDeEQsT0FBTyxDQUFDLElBQUksQ0FBQyxhQUFhLEtBQUssQ0FBQyxXQUFXLFNBQVMsQ0FBQyxDQUFDO1FBRXRELE1BQU0sVUFBVSxHQUNkLEtBQUssQ0FBQyxXQUFXLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDO1FBRTNFLE1BQU0sS0FBSyxHQUNULEtBQUssQ0FBQyxrQkFBdUUsQ0FBQztRQUVoRixRQUFRLEtBQUssQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUMxQixLQUFLLFFBQVEsQ0FBQztZQUNkLEtBQUssUUFBUTtnQkFDWCxPQUFPLENBQUMsSUFBSSxDQUNWLHFDQUFxQyxLQUFLLENBQUMsS0FBSyxlQUFlLEtBQUssQ0FBQyxVQUFVLE9BQU8sS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUN0RyxDQUFDO2dCQUNGLE1BQU0sSUFBSSxDQUFDLDJCQUEyQixDQUNwQyxLQUFLLENBQUMsS0FBSyxFQUNYLEtBQUssQ0FBQyxVQUFVLEVBQ2hCLEtBQUssQ0FBQyxP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QWdCLENBQUMsRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLENBQUMsQ0FBQyxDQUMzRSxDQUFDLE1BQU0sQ0FBQztRQUNULElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNaLE1BQU0sSUFBSSxLQUFLLENBQUMsd0JBQXdCLFVBQVUsWUFBWSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQ3pFLENBQUM7UUFDRCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDLENBQUM7Q0FDSDtBQUVELE1BQU0sMEJBQTBCLEdBQzlCLElBQUksNkNBQTZDLENBQUMsSUFBSSxhQUFhLEVBQUUsQ0FBQyxDQUFDO0FBRXpFOztHQUVHO0FBQ0gsTUFBTSxDQUFDLE1BQU0sT0FBTyxHQUFHLENBQ3JCLEtBQXdDLEVBQ2MsRUFBRTtJQUN4RCxPQUFPLDBCQUEwQixDQUFDLHlCQUF5QixDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ3JFLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VFdmVudCxcbiAgQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZVN1Y2Nlc3NSZXNwb25zZSxcbn0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyByYW5kb21VVUlEIH0gZnJvbSAnbm9kZTpjcnlwdG8nO1xuaW1wb3J0IHtcbiAgQW1wbGlmeUNsaWVudCxcbiAgQnJhbmNoLFxuICBHZXRCcmFuY2hDb21tYW5kLFxuICBOb3RGb3VuZEV4Y2VwdGlvbixcbiAgVXBkYXRlQnJhbmNoQ29tbWFuZCxcbiAgVXBkYXRlQnJhbmNoQ29tbWFuZElucHV0LFxufSBmcm9tICdAYXdzLXNkay9jbGllbnQtYW1wbGlmeSc7XG5pbXBvcnQgeyBBbXBsaWZ5QnJhbmNoTGlua2VyQ3VzdG9tUmVzb3VyY2VQcm9wcyB9IGZyb20gJy4vYnJhbmNoX2xpbmtlcl90eXBlcy5qcyc7XG5cbi8qKlxuICogSGFuZGxlcyBjdXN0b20gcmVzb3VyY2UgZXZlbnRzLlxuICovXG5leHBvcnQgY2xhc3MgQW1wbGlmeUJyYW5jaExpbmtlckN1c3RvbVJlc291cmNlRXZlbnRIYW5kbGVyIHtcbiAgLyoqXG4gICAqIENyZWF0ZXMgdGhlIGN1c3RvbSByZXNvdXJjZSBldmVudHMgaGFuZGxlci5cbiAgICovXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgYW1wbGlmeUNsaWVudDogQW1wbGlmeUNsaWVudCkge31cblxuICBoYW5kbGVDdXN0b21SZXNvdXJjZUV2ZW50ID0gYXN5bmMgKFxuICAgIGV2ZW50OiBDbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlRXZlbnQsXG4gICk6IFByb21pc2U8Q2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZVN1Y2Nlc3NSZXNwb25zZT4gPT4ge1xuICAgIGNvbnNvbGUuaW5mbyhgUmVjZWl2ZWQgJyR7ZXZlbnQuUmVxdWVzdFR5cGV9JyBldmVudGApO1xuXG4gICAgY29uc3QgcGh5c2ljYWxJZCA9XG4gICAgICBldmVudC5SZXF1ZXN0VHlwZSA9PT0gJ0NyZWF0ZScgPyByYW5kb21VVUlEKCkgOiBldmVudC5QaHlzaWNhbFJlc291cmNlSWQ7XG5cbiAgICBjb25zdCBwcm9wcyA9XG4gICAgICBldmVudC5SZXNvdXJjZVByb3BlcnRpZXMgYXMgdW5rbm93biBhcyBBbXBsaWZ5QnJhbmNoTGlua2VyQ3VzdG9tUmVzb3VyY2VQcm9wcztcblxuICAgIHN3aXRjaCAoZXZlbnQuUmVxdWVzdFR5cGUpIHtcbiAgICAgIGNhc2UgJ0NyZWF0ZSc6XG4gICAgICBjYXNlICdVcGRhdGUnOlxuICAgICAgICBjb25zb2xlLmluZm8oXG4gICAgICAgICAgYFNldHRpbmcgc3RhY2sgcmVmZXJlbmNlIGZvciBhcHBJZD0ke3Byb3BzLmFwcElkfSxicmFuY2hOYW1lPSR7cHJvcHMuYnJhbmNoTmFtZX0gdG8gJHtldmVudC5TdGFja0lkfWAsXG4gICAgICAgICk7XG4gICAgICAgIGF3YWl0IHRoaXMudXBkYXRlT3JVbnNldFN0YWNrUmVmZXJlbmNlKFxuICAgICAgICAgIHByb3BzLmFwcElkLFxuICAgICAgICAgIHByb3BzLmJyYW5jaE5hbWUsXG4gICAgICAgICAgZXZlbnQuU3RhY2tJZCxcbiAgICAgICAgKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdEZWxldGUnOlxuICAgICAgICBjb25zb2xlLmluZm8oXG4gICAgICAgICAgYFVuLXNldHRpbmcgc3RhY2sgcmVmZXJlbmNlIGZvciBhcHBJZD0ke3Byb3BzLmFwcElkfSxicmFuY2hOYW1lPSR7cHJvcHMuYnJhbmNoTmFtZX1gLFxuICAgICAgICApO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IHRoaXMudXBkYXRlT3JVbnNldFN0YWNrUmVmZXJlbmNlKFxuICAgICAgICAgICAgcHJvcHMuYXBwSWQsXG4gICAgICAgICAgICBwcm9wcy5icmFuY2hOYW1lLFxuICAgICAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgICAgICk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICBpZiAoZSBpbnN0YW5jZW9mIE5vdEZvdW5kRXhjZXB0aW9uKSB7XG4gICAgICAgICAgICBjb25zb2xlLmluZm8oXG4gICAgICAgICAgICAgIGBCcmFuY2ggYnJhbmNoTmFtZT0ke3Byb3BzLmJyYW5jaE5hbWV9IG9mIGFwcElkPSR7cHJvcHMuYXBwSWR9IHdhcyBub3QgZm91bmQgd2hpbGUgaGFuZGxpbmcgZGVsZXRlIGV2ZW50YCxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IGU7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBSZXF1ZXN0SWQ6IGV2ZW50LlJlcXVlc3RJZCxcbiAgICAgIExvZ2ljYWxSZXNvdXJjZUlkOiBldmVudC5Mb2dpY2FsUmVzb3VyY2VJZCxcbiAgICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogcGh5c2ljYWxJZCxcbiAgICAgIFN0YWNrSWQ6IGV2ZW50LlN0YWNrSWQsXG4gICAgICBTdGF0dXM6ICdTVUNDRVNTJyxcbiAgICB9IGFzIENsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VTdWNjZXNzUmVzcG9uc2U7XG4gIH07XG5cbiAgcHJpdmF0ZSB1cGRhdGVPclVuc2V0U3RhY2tSZWZlcmVuY2UgPSBhc3luYyAoXG4gICAgYXBwSWQ6IHN0cmluZyxcbiAgICBicmFuY2hOYW1lOiBzdHJpbmcsXG4gICAgc3RhY2tJZDogc3RyaW5nIHwgdW5kZWZpbmVkLFxuICApOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICAvLyBTdGFjayBpZCBpcyBpbiBBUk4gZm9ybWF0LlxuICAgIGlmIChzdGFja0lkICYmICFzdGFja0lkPy5zdGFydHNXaXRoKCdhcm46JykpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgUHJvdmlkZWQgc3RhY2tJZCAke3N0YWNrSWR9IGlzIG5vdCBpbiBBUk4gZm9ybWF0YCk7XG4gICAgfVxuXG4gICAgY29uc3QgYnJhbmNoOiBCcmFuY2ggPSBhd2FpdCB0aGlzLmdldEJyYW5jaChhcHBJZCwgYnJhbmNoTmFtZSk7XG4gICAgY29uc29sZS5pbmZvKFxuICAgICAgYFJlY2VpdmVkIGRldGFpbHMgb2YgYnJhbmNoTmFtZT0ke2JyYW5jaE5hbWV9IG9mIGFwcElkPSR7YXBwSWR9YCxcbiAgICApO1xuICAgIC8vIFBvcHVsYXRlIHVwZGF0ZSBjb21tYW5kIGlucHV0IHdpdGggZXhpc3RpbmcgdmFsdWVzLCBzbyB3ZSBkb24ndCBsb3NlIHRoZW0uXG4gICAgY29uc3QgdXBkYXRlQnJhbmNoQ29tbWFuZElucHV0OiBVcGRhdGVCcmFuY2hDb21tYW5kSW5wdXQgPSB7XG4gICAgICBhcHBJZCxcbiAgICAgIC4uLmJyYW5jaCxcbiAgICB9O1xuXG4gICAgLy8gVGhpcyBpcyBhIGtub3duIGJ1ZyBpbiB0aGUgc2VydmljZS4gSS5lLiBicmFuY2ggY2FuIGJlIGNyZWF0ZWQgd2l0aG91dCBzdGFnZVxuICAgIC8vIGJ1dCBzZXJ2aWNlIHJldHVybnMgJ05PTkUnIGluc3RlYWQgb2YgdW5kZWZpbmVkIHdoaWNoIGlzIG5vdCBwYXJ0IG9mXG4gICAgLy8gU3RhZ2UgZW51bS4uLlxuICAgIGlmICgodXBkYXRlQnJhbmNoQ29tbWFuZElucHV0LnN0YWdlIGFzIHN0cmluZykgPT09ICdOT05FJykge1xuICAgICAgdXBkYXRlQnJhbmNoQ29tbWFuZElucHV0LnN0YWdlID0gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIC8vIFNldCBvciB1bnNldCBzdGFja0lkXG4gICAgaWYgKHN0YWNrSWQpIHtcbiAgICAgIGlmICghdXBkYXRlQnJhbmNoQ29tbWFuZElucHV0LmJhY2tlbmQpIHtcbiAgICAgICAgdXBkYXRlQnJhbmNoQ29tbWFuZElucHV0LmJhY2tlbmQgPSB7fTtcbiAgICAgIH1cbiAgICAgIHVwZGF0ZUJyYW5jaENvbW1hbmRJbnB1dC5iYWNrZW5kLnN0YWNrQXJuID0gc3RhY2tJZDtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHVwZGF0ZUJyYW5jaENvbW1hbmRJbnB1dC5iYWNrZW5kPy5zdGFja0Fybikge1xuICAgICAgICBkZWxldGUgdXBkYXRlQnJhbmNoQ29tbWFuZElucHV0LmJhY2tlbmQuc3RhY2tBcm47XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc29sZS5pbmZvKFxuICAgICAgYFNlbmRpbmcgdXBkYXRlIG9mIGJyYW5jaE5hbWU9JHticmFuY2hOYW1lfSBvZiBhcHBJZD0ke2FwcElkfWAsXG4gICAgKTtcbiAgICBhd2FpdCB0aGlzLmFtcGxpZnlDbGllbnQuc2VuZChcbiAgICAgIG5ldyBVcGRhdGVCcmFuY2hDb21tYW5kKHVwZGF0ZUJyYW5jaENvbW1hbmRJbnB1dCksXG4gICAgKTtcbiAgfTtcblxuICBwcml2YXRlIGdldEJyYW5jaCA9IGFzeW5jIChcbiAgICBhcHBJZDogc3RyaW5nLFxuICAgIGJyYW5jaE5hbWU6IHN0cmluZyxcbiAgKTogUHJvbWlzZTxCcmFuY2g+ID0+IHtcbiAgICBjb25zdCBicmFuY2g6IEJyYW5jaCB8IHVuZGVmaW5lZCA9IChcbiAgICAgIGF3YWl0IHRoaXMuYW1wbGlmeUNsaWVudC5zZW5kKG5ldyBHZXRCcmFuY2hDb21tYW5kKHsgYXBwSWQsIGJyYW5jaE5hbWUgfSkpXG4gICAgKS5icmFuY2g7XG4gICAgaWYgKCFicmFuY2gpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5hYmxlIHRvIGdldCBicmFuY2ggJHticmFuY2hOYW1lfSBmb3IgYXBwICR7YXBwSWR9YCk7XG4gICAgfVxuICAgIHJldHVybiBicmFuY2g7XG4gIH07XG59XG5cbmNvbnN0IGN1c3RvbVJlc291cmNlRXZlbnRIYW5kbGVyID1cbiAgbmV3IEFtcGxpZnlCcmFuY2hMaW5rZXJDdXN0b21SZXNvdXJjZUV2ZW50SGFuZGxlcihuZXcgQW1wbGlmeUNsaWVudCgpKTtcblxuLyoqXG4gKiBFbnRyeSBwb2ludCBmb3IgdGhlIGxhbWJkYS1iYWNrZW5kIGN1c3RvbSByZXNvdXJjZSB0byBsaW5rIGRlcGxveW1lbnQgdG8gYnJhbmNoLlxuICovXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IChcbiAgZXZlbnQ6IENsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VFdmVudCxcbik6IFByb21pc2U8Q2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZVN1Y2Nlc3NSZXNwb25zZT4gPT4ge1xuICByZXR1cm4gY3VzdG9tUmVzb3VyY2VFdmVudEhhbmRsZXIuaGFuZGxlQ3VzdG9tUmVzb3VyY2VFdmVudChldmVudCk7XG59O1xuIl19