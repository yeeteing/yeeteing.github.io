"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.AmplifyError = void 0;
const _1 = require(".");
/**
 * Base class for all Amplify errors or faults
 */
class AmplifyError extends Error {
    name;
    classification;
    options;
    cause;
    serializedError;
    message;
    resolution;
    details;
    link;
    code;
    /**
     * You should use AmplifyUserError or AmplifyLibraryFault to throw an error.
     * @param name - a user friendly name for the exception
     * @param classification - LibraryFault or UserError
     * @param options - error stack, resolution steps, details, or help links
     * @param cause If you are throwing this exception from within a catch block,
     * you must provide the exception that was caught.
     * @example
     * try {
     *  ...
     * } catch (error){
     *    throw new AmplifyError(...,...,error);
     * }
     */
    constructor(name, classification, options, cause) {
        // If an AmplifyError was already thrown, we must allow it to reach the user.
        // This ensures that resolution steps, and the original error are bubbled up.
        super(options.message, { cause });
        this.name = name;
        this.classification = classification;
        this.options = options;
        this.cause = cause;
        // https://github.com/Microsoft/TypeScript-wiki/blob/main/Breaking-Changes.md#extending-built-ins-like-error-array-and-map-may-no-longer-work
        Object.setPrototypeOf(this, AmplifyError.prototype);
        this.message = options.message;
        this.details = options.details;
        this.resolution = options.resolution;
        this.code = options.code;
        this.link = options.link;
        if (cause && AmplifyError.isAmplifyError(cause)) {
            cause.serializedError = undefined;
        }
        this.serializedError = Buffer.from(JSON.stringify({
            name,
            classification,
            options,
            cause,
        }, errorSerializer)).toString('base64');
    }
    static fromStderr = (_stderr) => {
        try {
            const serializedString = tryFindSerializedErrorJSONString(_stderr);
            if (!serializedString) {
                return undefined;
            }
            const { name, classification, options, cause } = JSON.parse(serializedString);
            let serializedCause = cause;
            if (cause && ErrorSerializerDeserializer.isSerializedErrorType(cause)) {
                serializedCause = ErrorSerializerDeserializer.deserialize(cause);
            }
            return classification === 'ERROR'
                ? new _1.AmplifyUserError(name, options, serializedCause)
                : new _1.AmplifyFault(name, options, serializedCause);
        }
        catch {
            // cannot deserialize
            return undefined;
        }
    };
    /**
     * This function is a type predicate for AmplifyError.
     * See https://www.typescriptlang.org/docs/handbook/2/narrowing.html#using-type-predicates.
     *
     * Checks if error is an AmplifyError by inspecting if required properties are set.
     * This is recommended instead of instanceof operator.
     * The instance of operator does not work as expected if AmplifyError class is loaded
     * from multiple sources, for example when package manager decides to not de-duplicate dependencies.
     * See https://github.com/nodejs/node/issues/17943.
     */
    static isAmplifyError = (error) => {
        return (error instanceof Error &&
            'classification' in error &&
            (error.classification === 'ERROR' || error.classification === 'FAULT') &&
            typeof error.name === 'string' &&
            typeof error.message === 'string');
    };
    static fromError = (error) => {
        if (AmplifyError.isAmplifyError(error)) {
            return error;
        }
        const errorMessage = error instanceof Error
            ? `${error.name}: ${error.message}`
            : 'An unknown error happened. Check downstream error';
        if (error instanceof Error && isCredentialsError(error)) {
            return new _1.AmplifyUserError('CredentialsError', {
                message: errorMessage,
                resolution: 'Ensure your AWS credentials are correctly set and refreshed.',
            }, error);
        }
        if (error instanceof Error && isPermissionsError(error)) {
            return new _1.AmplifyUserError('AccessDeniedError', {
                message: errorMessage,
                resolution: 'Ensure your IAM role has the AmplifyBackendDeployFullAccess policy along with any additional permissions required for this operation.',
            }, error);
        }
        if (error instanceof Error && isRequestSignatureError(error)) {
            return new _1.AmplifyUserError('RequestSignatureError', {
                message: errorMessage,
                resolution: 'You can retry your last request, check if your system time is synchronized (clock skew) or ensure your AWS credentials are correctly set and refreshed.',
            }, error);
        }
        if (error instanceof Error && isYargsValidationError(error)) {
            return new _1.AmplifyUserError('InvalidCommandInputError', {
                message: errorMessage,
                resolution: 'Please see the underlying error message for resolution.',
            }, error);
        }
        if (error instanceof Error && isENotFoundError(error)) {
            return new _1.AmplifyUserError('DomainNotFoundError', {
                message: 'Unable to establish a connection to a domain',
                resolution: 'Ensure domain name is correct and network connection is stable.',
            }, error);
        }
        /**
         * catches SyntaxErrors that were somehow not instances of AmplifyError
         * this can be removed once we can properly identify where AmplifyError is being stripped off
         */
        if (error instanceof Error && isSyntaxError(error)) {
            return new _1.AmplifyUserError('SyntaxError', {
                message: error.message,
                resolution: 'Check your backend definition in the `amplify` folder for syntax and type errors.',
            }, error);
        }
        if (error instanceof Error && isInsufficientDiskSpaceError(error)) {
            return new _1.AmplifyUserError('InsufficientDiskSpaceError', {
                message: error.message,
                resolution: 'There appears to be insufficient space on your system to finish. Clear up some disk space and try again.',
            }, error);
        }
        if (error instanceof Error && isOutOfMemoryError(error)) {
            return new _1.AmplifyUserError('InsufficientMemorySpaceError', {
                message: error.message,
                resolution: 'There appears to be insufficient memory on your system to finish. Close other applications or restart your system and try again.',
            }, error);
        }
        if (error instanceof Error && isInotifyError(error)) {
            return new _1.AmplifyUserError('InsufficientInotifyWatchersError', {
                message: error.message,
                resolution: 'There appears to be an insufficient number of inotify watchers. To increase the amount of inotify watchers, change the `fs.inotify.max_user_watches` setting in your system config files to a higher value.',
            }, error);
        }
        return new _1.AmplifyFault('UnknownFault', {
            message: errorMessage,
        }, error instanceof Error ? error : new Error(String(error)));
    };
}
exports.AmplifyError = AmplifyError;
const tryFindSerializedErrorJSONString = (_stderr) => {
    let errorJSONString = tryFindSerializedErrorJSONStringV2(_stderr);
    if (!errorJSONString) {
        errorJSONString = tryFindSerializedErrorJSONStringV1(_stderr);
    }
    return errorJSONString;
};
/**
 * Tries to find serialized string assuming that it is in a form of serialized JSON encoded with base64.
 */
const tryFindSerializedErrorJSONStringV2 = (_stderr) => {
    /**
     * `["']?serializedError["']?:[ ]?` captures the start of the serialized error. The quotes depend on which OS is being used
     * `(?:`([a-zA-Z0-9+/=]+?)`|'([a-zA-Z0-9+/=]+?)'|"([a-zA-Z0-9+/=]+?)")` captures the rest of the serialized string enclosed in either single quote,
     * double quotes or back-ticks.
     */
    const extractionRegex = /["']?serializedError["']?:[ ]?(?:`([a-zA-Z0-9+/=]+?)`|'([a-zA-Z0-9+/=]+?)'|"([a-zA-Z0-9+/=]+?)")/;
    const serialized = _stderr.match(extractionRegex);
    if (serialized && serialized.length === 4) {
        // 4 because 1 match and 3 capturing groups
        const base64SerializedString = serialized
            .slice(1)
            .find((item) => item && item.length > 0);
        if (base64SerializedString) {
            return Buffer.from(base64SerializedString, 'base64').toString('utf-8');
        }
    }
    return undefined;
};
/**
 * Tries to find serialized string assuming that it is in a form of serialized JSON.
 * @deprecated This is old format left for backwards compatibility in case that synth-time components are using older version of platform-core.
 */
const tryFindSerializedErrorJSONStringV1 = (_stderr) => {
    /**
     * `["']?serializedError["']?:[ ]?` captures the start of the serialized error. The quotes depend on which OS is being used
     * `(?:`(.+?)`|'(.+?)'|"((?:\\"|[^"])*?)")` captures the rest of the serialized string enclosed in either single quote,
     * double quotes or back-ticks.
     */
    const extractionRegex = /["']?serializedError["']?:[ ]?(?:`(.+?)`|'(.+?)'|"((?:\\"|[^"])*?)")/;
    const serialized = _stderr.match(extractionRegex);
    if (serialized && serialized.length === 4) {
        // 4 because 1 match and 3 capturing groups
        return serialized
            .slice(1)
            .find((item) => item && item.length > 0)
            ?.replaceAll('\\"', '"')
            .replaceAll("\\'", "'");
    }
    return undefined;
};
const isCredentialsError = (err) => {
    return (!!err &&
        [
            'ExpiredToken',
            'ExpiredTokenException',
            'CredentialsProviderError',
            'InvalidClientTokenId',
            'CredentialsError',
        ].includes(err.name));
};
const isPermissionsError = (err) => {
    return !!err && ['AccessDeniedException', 'AccessDenied'].includes(err.name);
};
const isRequestSignatureError = (err) => {
    return (!!err &&
        ['InvalidSignatureException', 'SignatureDoesNotMatch'].includes(err.name));
};
// These validation messages are taken from https://github.com/yargs/yargs/blob/0c95f9c79e1810cf9c8964fbf7d139009412f7e7/lib/validation.ts
const isYargsValidationError = (err) => {
    return (!!err &&
        ([
            'Unknown command',
            'Unknown argument',
            'Did you mean',
            'Not enough non-option arguments',
            'Too many non-option arguments',
            'Missing required argument',
            'Invalid values:',
            'Missing dependent arguments',
            'Implications failed',
        ].some((message) => err.message.startsWith(message)) ||
            err.message.endsWith('are mutually exclusive')));
};
const isENotFoundError = (err) => {
    return !!err && err.message.includes('getaddrinfo ENOTFOUND');
};
const isSyntaxError = (err) => {
    return !!err && err.name === 'SyntaxError';
};
const isInsufficientDiskSpaceError = (err) => {
    return (!!err &&
        ['ENOSPC: no space left on device', 'code ENOSPC'].some((message) => err.message.includes(message)));
};
const isOutOfMemoryError = (err) => {
    return (!!err &&
        (err.message.includes('process out of memory') ||
            err.message.includes('connect ENOMEM')));
};
const isInotifyError = (err) => {
    return !!err && err.message.includes('inotify_add_watch');
};
const errorSerializer = (_, value) => {
    if (value instanceof Error) {
        return ErrorSerializerDeserializer.serialize(value);
    }
    return value;
};
class ErrorSerializerDeserializer {
    static serialize = (error) => {
        const serializedError = {
            name: error.name,
            message: error.message,
        };
        return serializedError;
    };
    static deserialize = (deserialized) => {
        const error = new Error(deserialized.message);
        error.name = deserialized.name;
        return error;
    };
    static isSerializedErrorType = (obj) => {
        if (obj &&
            obj.name &&
            obj.message)
            return true;
        return false;
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW1wbGlmeV9lcnJvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9lcnJvcnMvYW1wbGlmeV9lcnJvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSx3QkFBbUQ7QUFFbkQ7O0dBRUc7QUFDSCxNQUFzQixZQUF3QyxTQUFRLEtBQUs7SUF1QnZEO0lBQ0E7SUFDQztJQUNEO0lBekJYLGVBQWUsQ0FBVTtJQUNoQixPQUFPLENBQVM7SUFDaEIsVUFBVSxDQUFVO0lBQ3BCLE9BQU8sQ0FBVTtJQUNqQixJQUFJLENBQVU7SUFDZCxJQUFJLENBQVU7SUFFOUI7Ozs7Ozs7Ozs7Ozs7T0FhRztJQUNILFlBQ2tCLElBQU8sRUFDUCxjQUEwQyxFQUN6QyxPQUE0QixFQUM3QixLQUFhO1FBRTdCLDZFQUE2RTtRQUM3RSw2RUFBNkU7UUFDN0UsS0FBSyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBUGxCLFNBQUksR0FBSixJQUFJLENBQUc7UUFDUCxtQkFBYyxHQUFkLGNBQWMsQ0FBNEI7UUFDekMsWUFBTyxHQUFQLE9BQU8sQ0FBcUI7UUFDN0IsVUFBSyxHQUFMLEtBQUssQ0FBUTtRQU03Qiw2SUFBNkk7UUFDN0ksTUFBTSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRXBELElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQztRQUMvQixJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUM7UUFDL0IsSUFBSSxDQUFDLFVBQVUsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDO1FBQ3JDLElBQUksQ0FBQyxJQUFJLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQztRQUN6QixJQUFJLENBQUMsSUFBSSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUM7UUFFekIsSUFBSSxLQUFLLElBQUksWUFBWSxDQUFDLGNB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QzVELENBQUMsQ0FBQztBQTRCRixNQUFNLGVBQWUsR0FBRyxDQUFDLENBQVUsRUFBRSxLQUFjLEVBQUUsRUFBRTtJQUNyRCxJQUFJLEtBQUssWUFBWSxLQUFLLEVBQUUsQ0FBQztRQUMzQixPQUFPLDJCQUEyQixDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN0RCxDQUFDO0lBQ0QsT0FBTyxLQUFLLENBQUM7QUFDZixDQUFDLENBQUM7QUFDRixNQUFNLDJCQUEyQjtJQUMvQixNQUFNLENBQUMsU0FBUyxHQUFHLENBQUMsS0FBWSxFQUFFLEVBQUU7UUFDbEMsTUFBTSxlQUFlLEdBQXdCO1lBQzNDLElBQUksRUFBRSxLQUFLLENBQUMsSUFBSTtZQUNoQixPQUFPLEVBQUUsS0FBSyxDQUFDLE9BQU87U0FDdkIsQ0FBQztRQUNGLE9BQU8sZUFBZSxDQUFDO0lBQ3pCLENBQUMsQ0FBQztJQUVGLE1BQU0sQ0FBQyxXQUFXLEdBQUcsQ0FBQyxZQUFpQyxFQUFFLEVBQUU7UUFDekQsTUFBTSxLQUFLLEdBQUcsSUFBSSxLQUFLLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzlDLEtBQUssQ0FBQyxJQUFJLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQztRQUMvQixPQUFPLEtBQUssQ0FBQztJQUNmLENBQUMsQ0FBQztJQUVGLE1BQU0sQ0FBQyxxQkFBcUIsR0FBRyxDQUFDLEdBQVksRUFBOEIsRUFBRTtRQUMxRSxJQUNFLEdBQUc7WUFDRixHQUEyQixDQUFDLElBQUk7WUFDaEMsR0FBMkIsQ0FBQyxPQUFPO1lBRXBDLE9BQU8sSUFBSSxDQUFDO1FBQ2QsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBbXBsaWZ5RmF1bHQsIEFtcGxpZnlVc2VyRXJyb3IgfSBmcm9tICcuJztcblxuLyoqXG4gKiBCYXNlIGNsYXNzIGZvciBhbGwgQW1wbGlmeSBlcnJvcnMgb3IgZmF1bHRzXG4gKi9cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBBbXBsaWZ5RXJyb3I8VCBleHRlbmRzIHN0cmluZyA9IHN0cmluZz4gZXh0ZW5kcyBFcnJvciB7XG4gIHB1YmxpYyBzZXJpYWxpemVkRXJyb3I/OiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSBtZXNzYWdlOiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSByZXNvbHV0aW9uPzogc3RyaW5nO1xuICBwdWJsaWMgcmVhZG9ubHkgZGV0YWlscz86IHN0cmluZztcbiAgcHVibGljIHJlYWRvbmx5IGxpbms/OiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSBjb2RlPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBZb3Ugc2hvdWxkIHVzZSBBbXBsaWZ5VXNlckVycm9yIG9yIEFtcGxpZnlMaWJyYXJ5RmF1bHQgdG8gdGhyb3cgYW4gZXJyb3IuXG4gICAqIEBwYXJhbSBuYW1lIC0gYSB1c2VyIGZyaWVuZGx5IG5hbWUgZm9yIHRoZSBleGNlcHRpb25cbiAgICogQHBhcmFtIGNsYXNzaWZpY2F0aW9uIC0gTGlicmFyeUZhdWx0IG9yIFVzZXJFcnJvclxuICAgKiBAcGFyYW0gb3B0aW9ucyAtIGVycm9yIHN0YWNrLCByZXNvbHV0aW9uIHN0ZXBzLCBkZXRhaWxzLCBvciBoZWxwIGxpbmtzXG4gICAqIEBwYXJhbSBjYXVzZSBJZiB5b3UgYXJlIHRocm93aW5nIHRoaXMgZXhjZXB0aW9uIGZyb20gd2l0aGluIGEgY2F0Y2ggYmxvY2ssXG4gICAqIHlvdSBtdXN0IHByb3ZpZGUgdGhlIGV4Y2VwdGlvbiB0aGF0IHdhcyBjYXVnaHQuXG4gICAqIEBleGFtcGxlXG4gICAqIHRyeSB7XG4gICAqICAuLi5cbiAgICogfSBjYXRjaCAoZXJyb3Ipe1xuICAgKiAgICB0aHJvdyBuZXcgQW1wbGlmeUVycm9yKC4uLiwuLi4sZXJyb3IpO1xuICAgKiB9XG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgcmVhZG9ubHkgbmFtZTogVCxcbiAgICBwdWJsaWMgcmVhZG9ubHkgY2xhc3NpZmljYXRpb246IEFtcGxpZnlFcnJvckNsYXNzaWZpY2F0aW9uLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgb3B0aW9uczogQW1wbGlmeUVycm9yT3B0aW9ucyxcbiAgICBwdWJsaWMgcmVhZG9ubHkgY2F1c2U/OiBFcnJvcixcbiAgKSB7XG4gICAgLy8gSWYgYW4gQW1wbGlmeUVycm9yIHdhcyBhbHJlYWR5IHRocm93biwgd2UgbXVzdCBhbGxvdyBpdCB0byByZWFjaCB0aGUgdXNlci5cbiAgICAvLyBUaGlzIGVuc3VyZXMgdGhhdCByZXNvbHV0aW9uIHN0ZXBzLCBhbmQgdGhlIG9yaWdpbmFsIGVycm9yIGFyZSBidWJibGVkIHVwLlxuICAgIHN1cGVyKG9wdGlvbnMubWVzc2FnZSwgeyBjYXVzZSB9KTtcblxuICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9NaWNyb3NvZnQvVHlwZVNjcmlwdC13aWtpL2Jsb2IvbWFpbi9CcmVha2luZy1DaGFuZ2VzLm1kI2V4dGVuZGluZy1idWlsdC1pbnMtbGlrZS1lcnJvci1hcnJheS1hbmQtbWFwLW1heS1uby1sb25nZXItd29ya1xuICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZih0aGlzLCBBbXBsaWZ5RXJyb3IucHJvdG90eXBlKTtcblxuICAgIHRoaXMubWVzc2FnZSA9IG9wdGlvbnMubWVzc2FnZTtcbiAgICB0aGlzLmRldGFpbHMgPSBvcHRpb25zLmRldGFpbHM7XG4gICAgdGhpcy5yZXNvbHV0aW9uID0gb3B0aW9ucy5yZXNvbHV0aW9uO1xuICAgIHRoaXMuY29kZSA9IG9wdGlvbnMuY29kZTtcbiAgICB0aGlzLmxpbmsgPSBvcHRpb25zLmxpbms7XG5cbiAgICBpZiAoY2F1c2UgJiYgQW1wbGlmeUVycm9yLmlzQW1wbGlmeUVycm9yKGNhdXNlKSkge1xuICAgICAgY2F1c2Uuc2VyaWFsaXplZEVycm9yID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgICB0aGlzLnNlcmlhbGl6ZWRFcnJvciA9IEJ1ZmZlci5mcm9tKFxuICAgICAgSlNPTi5zdHJpbmdpZnkoXG4gICAgICAgIHtcbiAgICAgICAgICBuYW1lLFxuICAgICAgICAgIGNsYXNzaWZpY2F0aW9uLFxuICAgICAgICAgIG9wdGlvbnMsXG4gICAgICAgICAgY2F1c2UsXG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yU2VyaWFsaXplcixcbiAgICAgICksXG4gICAgKS50b1N0cmluZygnYmFzZTY0Jyk7XG4gIH1cblxuICBzdGF0aWMgZnJvbVN0ZGVyciA9IChfc3RkZXJyOiBzdHJpbmcpOiBBbXBsaWZ5RXJyb3IgfCB1bmRlZmluZWQgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzZXJpYWxpemVkU3RyaW5nID0gdHJ5RmluZFNlcmlhbGl6ZWRFcnJvckpTT05TdHJpbmcoX3N0ZGVycik7XG5cbiAgICAgIGlmICghc2VyaWFsaXplZFN0cmluZykge1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB7IG5hbWUsIGNsYXNzaWZpY2F0aW9uLCBvcHRpb25zLCBjYXVzZSB9ID1cbiAgICAgICAgSlNPTi5wYXJzZShzZXJpYWxpemVkU3RyaW5nKTtcblxuICAgICAgbGV0IHNlcmlhbGl6ZWRDYXVzZSA9IGNhdXNlO1xuICAgICAgaWYgKGNhdXNlICYmIEVycm9yU2VyaWFsaXplckRlc2VyaWFsaXplci5pc1NlcmlhbGl6ZWRFcnJvclR5cGUoY2F1c2UpKSB7XG4gICAgICAgIHNlcmlhbGl6ZWRDYXVzZSA9IEVycm9yU2VyaWFsaXplckRlc2VyaWFsaXplci5kZXNlcmlhbGl6ZShjYXVzZSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gY2xhc3NpZmljYXRpb24gPT09ICdFUlJPUidcbiAgICAgICAgPyBuZXcgQW1wbGlmeVVzZXJFcnJvcihuYW1lLCBvcHRpb25zLCBzZXJpYWxpemVkQ2F1c2UpXG4gICAgICAgIDogbmV3IEFtcGxpZnlGYXVsdChuYW1lLCBvcHRpb25zLCBzZXJpYWxpemVkQ2F1c2UpO1xuICAgIH0gY2F0Y2gge1xuICAgICAgLy8gY2Fubm90IGRlc2VyaWFsaXplXG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgfTtcblxuICAvKipcbiAgICogVGhpcyBmdW5jdGlvbiBpcyBhIHR5cGUgcHJlZGljYXRlIGZvciBBbXBsaWZ5RXJyb3IuXG4gICAqIFNlZSBodHRwczovL3d3dy50eXBlc2NyaXB0bGFuZy5vcmcvZG9jcy9oYW5kYm9vay8yL25hcnJvd2luZy5odG1sI3VzaW5nLXR5cGUtcHJlZGljYXRlcy5cbiAgICpcbiAgICogQ2hlY2tzIGlmIGVycm9yIGlzIGFuIEFtcGxpZnlFcnJvciBieSBpbnNwZWN0aW5nIGlmIHJlcXVpcmVkIHByb3BlcnRpZXMgYXJlIHNldC5cbiAgICogVGhpcyBpcyByZWNvbW1lbmRlZCBpbnN0ZWFkIG9mIGluc3RhbmNlb2Ygb3BlcmF0b3IuXG4gICAqIFRoZSBpbnN0YW5jZSBvZiBvcGVyYXRvciBkb2VzIG5vdCB3b3JrIGFzIGV4cGVjdGVkIGlmIEFtcGxpZnlFcnJvciBjbGFzcyBpcyBsb2FkZWRcbiAgICogZnJvbSBtdWx0aXBsZSBzb3VyY2VzLCBmb3IgZXhhbXBsZSB3aGVuIHBhY2thZ2UgbWFuYWdlciBkZWNpZGVzIHRvIG5vdCBkZS1kdXBsaWNhdGUgZGVwZW5kZW5jaWVzLlxuICAgKiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL25vZGVqcy9ub2RlL2lzc3Vlcy8xNzk0My5cbiAgICovXG4gIHN0YXRpYyBpc0FtcGxpZnlFcnJvciA9IChlcnJvcjogdW5rbm93bik6IGVycm9yIGlzIEFtcGxpZnlFcnJvciA9PiB7XG4gICAgcmV0dXJuIChcbiAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgJiZcbiAgICAgICdjbGFzc2lmaWNhdGlvbicgaW4gZXJyb3IgJiZcbiAgICAgIChlcnJvci5jbGFzc2lmaWNhdGlvbiA9PT0gJ0VSUk9SJyB8fCBlcnJvci5jbGFzc2lmaWNhdGlvbiA9PT0gJ0ZBVUxUJykgJiZcbiAgICAgIHR5cGVvZiBlcnJvci5uYW1lID09PSAnc3RyaW5nJyAmJlxuICAgICAgdHlwZW9mIGVycm9yLm1lc3NhZ2UgPT09ICdzdHJpbmcnXG4gICAgKTtcbiAgfTtcblxuICBzdGF0aWMgZnJvbUVycm9yID0gKGVycm9yOiB1bmtub3duKTogQW1wbGlmeUVycm9yID0+IHtcbiAgICBpZiAoQW1wbGlmeUVycm9yLmlzQW1wbGlmeUVycm9yKGVycm9yKSkge1xuICAgICAgcmV0dXJuIGVycm9yO1xuICAgIH1cblxuICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9XG4gICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yXG4gICAgICAgID8gYCR7ZXJyb3IubmFtZX06ICR7ZXJyb3IubWVzc2FnZX1gXG4gICAgICAgIDogJ0FuIHVua25vd24gZXJyb3IgaGFwcGVuZWQuIENoZWNrIGRvd25zdHJlYW0gZXJyb3InO1xuXG4gICAgaWYgKGVycm9yIGluc3RhbmNlb2YgRXJyb3IgJiYgaXNDcmVkZW50aWFsc0Vycm9yKGVycm9yKSkge1xuICAgICAgcmV0dXJuIG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAnQ3JlZGVudGlhbHNFcnJvcicsXG4gICAgICAgIHtcbiAgICAgICAgICBtZXNzYWdlOiBlcnJvck1lc3NhZ2UsXG4gICAgICAgICAgcmVzb2x1dGlvbjpcbiAgICAgICAgICAgICdFbnN1cmUgeW91ciBBV1MgY3JlZGVudGlhbHMgYXJlIGNvcnJlY3RseSBzZXQgYW5kIHJlZnJlc2hlZC4nLFxuICAgICAgICB9LFxuICAgICAgICBlcnJvcixcbiAgICAgICk7XG4gICAgfVxuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yICYmIGlzUGVybWlzc2lvbnNFcnJvcihlcnJvcikpIHtcbiAgICAgIHJldHVybiBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgJ0FjY2Vzc0RlbmllZEVycm9yJyxcbiAgICAgICAge1xuICAgICAgICAgIG1lc3NhZ2U6IGVycm9yTWVzc2FnZSxcbiAgICAgICAgICByZXNvbHV0aW9uOlxuICAgICAgICAgICAgJ0Vuc3VyZSB5b3VyIElBTSByb2xlIGhhcyB0aGUgQW1wbGlmeUJhY2tlbmREZXBsb3lGdWxsQWNjZXNzIHBvbGljeSBhbG9uZyB3aXRoIGFueSBhZGRpdGlvbmFsIHBlcm1pc3Npb25zIHJlcXVpcmVkIGZvciB0aGlzIG9wZXJhdGlvbi4nLFxuICAgICAgICB9LFxuICAgICAgICBlcnJvcixcbiAgICAgICk7XG4gICAgfVxuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yICYmIGlzUmVxdWVzdFNpZ25hdHVyZUVycm9yKGVycm9yKSkge1xuICAgICAgcmV0dXJuIG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAnUmVxdWVzdFNpZ25hdHVyZUVycm9yJyxcbiAgICAgICAge1xuICAgICAgICAgIG1lc3NhZ2U6IGVycm9yTWVzc2FnZSxcbiAgICAgICAgICByZXNvbHV0aW9uOlxuICAgICAgICAgICAgJ1lvdSBjYW4gcmV0cnkgeW91ciBsYXN0IHJlcXVlc3QsIGNoZWNrIGlmIHlvdXIgc3lzdGVtIHRpbWUgaXMgc3luY2hyb25pemVkIChjbG9jayBza2V3KSBvciBlbnN1cmUgeW91ciBBV1MgY3JlZGVudGlhbHMgYXJlIGNvcnJlY3RseSBzZXQgYW5kIHJlZnJlc2hlZC4nLFxuICAgICAgICB9LFxuICAgICAgICBlcnJvcixcbiAgICAgICk7XG4gICAgfVxuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yICYmIGlzWWFyZ3NWYWxpZGF0aW9uRXJyb3IoZXJyb3IpKSB7XG4gICAgICByZXR1cm4gbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICdJbnZhbGlkQ29tbWFuZElucHV0RXJyb3InLFxuICAgICAgICB7XG4gICAgICAgICAgbWVzc2FnZTogZXJyb3JNZXNzYWdlLFxuICAgICAgICAgIHJlc29sdXRpb246ICdQbGVhc2Ugc2VlIHRoZSB1bmRlcmx5aW5nIGVycm9yIG1lc3NhZ2UgZm9yIHJlc29sdXRpb24uJyxcbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3IsXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBFcnJvciAmJiBpc0VOb3RGb3VuZEVycm9yKGVycm9yKSkge1xuICAgICAgcmV0dXJuIG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAnRG9tYWluTm90Rm91bmRFcnJvcicsXG4gICAgICAgIHtcbiAgICAgICAgICBtZXNzYWdlOiAnVW5hYmxlIHRvIGVzdGFibGlzaCBhIGNvbm5lY3Rpb24gdG8gYSBkb21haW4nLFxuICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAnRW5zdXJlIGRvbWFpbiBuYW1lIGlzIGNvcnJlY3QgYW5kIG5ldHdvcmsgY29ubmVjdGlvbiBpcyBzdGFibGUuJyxcbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3IsXG4gICAgICApO1xuICAgIH1cbiAgICAvKipcbiAgICAgKiBjYXRjaGVzIFN5bnRheEVycm9ycyB0aGF0IHdlcmUgc29tZWhvdyBub3QgaW5zdGFuY2VzIG9mIEFtcGxpZnlFcnJvclxuICAgICAqIHRoaXMgY2FuIGJlIHJlbW92ZWQgb25jZSB3ZSBjYW4gcHJvcGVybHkgaWRlbnRpZnkgd2hlcmUgQW1wbGlmeUVycm9yIGlzIGJlaW5nIHN0cmlwcGVkIG9mZlxuICAgICAqL1xuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yICYmIGlzU3ludGF4RXJyb3IoZXJyb3IpKSB7XG4gICAgICByZXR1cm4gbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICdTeW50YXhFcnJvcicsXG4gICAgICAgIHtcbiAgICAgICAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlLFxuICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAnQ2hlY2sgeW91ciBiYWNrZW5kIGRlZmluaXRpb24gaW4gdGhlIGBhbXBsaWZ5YCBmb2xkZXIgZm9yIHN5bnRheCBhbmQgdHlwZSBlcnJvcnMuJyxcbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3IsXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBFcnJvciAmJiBpc0luc3VmZmljaWVudERpc2tTcGFjZUVycm9yKGVycm9yKSkge1xuICAgICAgcmV0dXJuIG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAnSW5zdWZmaWNpZW50RGlza1NwYWNlRXJyb3InLFxuICAgICAgICB7XG4gICAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSxcbiAgICAgICAgICByZXNvbHV0aW9uOlxuICAgICAgICAgICAgJ1RoZXJlIGFwcGVhcnMgdG8gYmUgaW5zdWZmaWNpZW50IHNwYWNlIG9uIHlvdXIgc3lzdGVtIHRvIGZpbmlzaC4gQ2xlYXIgdXAgc29tZSBkaXNrIHNwYWNlIGFuZCB0cnkgYWdhaW4uJyxcbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3IsXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBFcnJvciAmJiBpc091dE9mTWVtb3J5RXJyb3IoZXJyb3IpKSB7XG4gICAgICByZXR1cm4gbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICdJbnN1ZmZpY2llbnRNZW1vcnlTcGFjZUVycm9yJyxcbiAgICAgICAge1xuICAgICAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UsXG4gICAgICAgICAgcmVzb2x1dGlvbjpcbiAgICAgICAgICAgICdUaGVyZSBhcHBlYXJzIHRvIGJlIGluc3VmZmljaWVudCBtZW1vcnkgb24geW91ciBzeXN0ZW0gdG8gZmluaXNoLiBDbG9zZSBvdGhlciBhcHBsaWNhdGlvbnMgb3IgcmVzdGFydCB5b3VyIHN5c3RlbSBhbmQgdHJ5IGFnYWluLicsXG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yLFxuICAgICAgKTtcbiAgICB9XG4gICAgaWYgKGVycm9yIGluc3RhbmNlb2YgRXJyb3IgJiYgaXNJbm90aWZ5RXJyb3IoZXJyb3IpKSB7XG4gICAgICByZXR1cm4gbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICdJbnN1ZmZpY2llbnRJbm90aWZ5V2F0Y2hlcnNFcnJvcicsXG4gICAgICAgIHtcbiAgICAgICAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlLFxuICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAnVGhlcmUgYXBwZWFycyB0byBiZSBhbiBpbnN1ZmZpY2llbnQgbnVtYmVyIG9mIGlub3RpZnkgd2F0Y2hlcnMuIFRvIGluY3JlYXNlIHRoZSBhbW91bnQgb2YgaW5vdGlmeSB3YXRjaGVycywgY2hhbmdlIHRoZSBgZnMuaW5vdGlmeS5tYXhfdXNlcl93YXRjaGVzYCBzZXR0aW5nIGluIHlvdXIgc3lzdGVtIGNvbmZpZyBmaWxlcyB0byBhIGhpZ2hlciB2YWx1ZS4nLFxuICAgICAgICB9LFxuICAgICAgICBlcnJvcixcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBuZXcgQW1wbGlmeUZhdWx0KFxuICAgICAgJ1Vua25vd25GYXVsdCcsXG4gICAgICB7XG4gICAgICAgIG1lc3NhZ2U6IGVycm9yTWVzc2FnZSxcbiAgICAgIH0sXG4gICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IgOiBuZXcgRXJyb3IoU3RyaW5nKGVycm9yKSksXG4gICAgKTtcbiAgfTtcbn1cblxuY29uc3QgdHJ5RmluZFNlcmlhbGl6ZWRFcnJvckpTT05TdHJpbmcgPSAoXG4gIF9zdGRlcnI6IHN0cmluZyxcbik6IHN0cmluZyB8IHVuZGVmaW5lZCA9PiB7XG4gIGxldCBlcnJvckpTT05TdHJpbmcgPSB0cnlGaW5kU2VyaWFsaXplZEVycm9ySlNPTlN0cmluZ1YyKF9zdGRlcnIpO1xuICBpZiAoIWVycm9ySlNPTlN0cmluZykge1xuICAgIGVycm9ySlNPTlN0cmluZyA9IHRyeUZpbmRTZXJpYWxpemVkRXJyb3JKU09OU3RyaW5nVjEoX3N0ZGVycik7XG4gIH1cbiAgcmV0dXJuIGVycm9ySlNPTlN0cmluZztcbn07XG5cbi8qKlxuICogVHJpZXMgdG8gZmluZCBzZXJpYWxpemVkIHN0cmluZyBhc3N1bWluZyB0aGF0IGl0IGlzIGluIGEgZm9ybSBvZiBzZXJpYWxpemVkIEpTT04gZW5jb2RlZCB3aXRoIGJhc2U2NC5cbiAqL1xuY29uc3QgdHJ5RmluZFNlcmlhbGl6ZWRFcnJvckpTT05TdHJpbmdWMiA9IChcbiAgX3N0ZGVycjogc3RyaW5nLFxuKTogc3RyaW5nIHwgdW5kZWZpbmVkID0+IHtcbiAgLyoqXG4gICAqIGBbXCInXT9zZXJpYWxpemVkRXJyb3JbXCInXT86WyBdP2AgY2FwdHVyZXMgdGhlIHN0YXJ0IG9mIHRoZSBzZXJpYWxpemVkIGVycm9yLiBUaGUgcXVvdGVzIGRlcGVuZCBvbiB3aGljaCBPUyBpcyBiZWluZyB1c2VkXG4gICAqIGAoPzpgKFthLXpBLVowLTkrLz1dKz8pYHwnKFthLXpBLVowLTkrLz1dKz8pJ3xcIihbYS16QS1aMC05Ky89XSs/KVwiKWAgY2FwdHVyZXMgdGhlIHJlc3Qgb2YgdGhlIHNlcmlhbGl6ZWQgc3RyaW5nIGVuY2xvc2VkIGluIGVpdGhlciBzaW5nbGUgcXVvdGUsXG4gICAqIGRvdWJsZSBxdW90ZXMgb3IgYmFjay10aWNrcy5cbiAgICovXG4gIGNvbnN0IGV4dHJhY3Rpb25SZWdleCA9XG4gICAgL1tcIiddP3NlcmlhbGl6ZWRFcnJvcltcIiddPzpbIF0/KD86YChbYS16QS1aMC05Ky89XSs/KWB8JyhbYS16QS1aMC05Ky89XSs/KSd8XCIoW2EtekEtWjAtOSsvPV0rPylcIikvO1xuICBjb25zdCBzZXJpYWxpemVkID0gX3N0ZGVyci5tYXRjaChleHRyYWN0aW9uUmVnZXgpO1xuICBpZiAoc2VyaWFsaXplZCAmJiBzZXJpYWxpemVkLmxlbmd0aCA9PT0gNCkge1xuICAgIC8vIDQgYmVjYXVzZSAxIG1hdGNoIGFuZCAzIGNhcHR1cmluZyBncm91cHNcbiAgICBjb25zdCBiYXNlNjRTZXJpYWxpemVkU3RyaW5nID0gc2VyaWFsaXplZFxuICAgICAgLnNsaWNlKDEpXG4gICAgICAuZmluZCgoaXRlbSkgPT4gaXRlbSAmJiBpdGVtLmxlbmd0aCA+IDApO1xuICAgIGlmIChiYXNlNjRTZXJpYWxpemVkU3RyaW5nKSB7XG4gICAgICByZXR1cm4gQnVmZmVyLmZyb20oYmFzZTY0U2VyaWFsaXplZFN0cmluZywgJ2Jhc2U2NCcpLnRvU3RyaW5nKCd1dGYtOCcpO1xuICAgIH1cbiAgfVxuICByZXR1cm4gdW5kZWZpbmVkO1xufTtcblxuLyoqXG4gKiBUcmllcyB0byBmaW5kIHNlcmlhbGl6ZWQgc3RyaW5nIGFzc3VtaW5nIHRoYXQgaXQgaXMgaW4gYSBmb3JtIG9mIHNlcmlhbGl6ZWQgSlNPTi5cbiAqIEBkZXByZWNhdGVkIFRoaXMgaXMgb2xkIGZvcm1hdCBsZWZ0IGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSBpbiBjYXNlIHRoYXQgc3ludGgtdGltZSBjb21wb25lbnRzIGFyZSB1c2luZyBvbGRlciB2ZXJzaW9uIG9mIHBsYXRmb3JtLWNvcmUuXG4gKi9cbmNvbnN0IHRyeUZpbmRTZXJpYWxpemVkRXJyb3JKU09OU3RyaW5nVjEgPSAoXG4gIF9zdGRlcnI6IHN0cmluZyxcbik6IHN0cmluZyB8IHVuZGVmaW5lZCA9PiB7XG4gIC8qKlxuICAgKiBgW1wiJ10/c2VyaWFsaXplZEVycm9yW1wiJ10/OlsgXT9gIGNhcHR1cmVzIHRoZSBzdGFydCBvZiB0aGUgc2VyaWFsaXplZCBlcnJvci4gVGhlIHF1b3RlcyBkZXBlbmQgb24gd2hpY2ggT1MgaXMgYmVpbmcgdXNlZFxuICAgKiBgKD86YCguKz8pYHwnKC4rPyknfFwiKCg/OlxcXFxcInxbXlwiXSkqPylcIilgIGNhcHR1cmVzIHRoZSByZXN0IG9mIHRoZSBzZXJpYWxpemVkIHN0cmluZyBlbmNsb3NlZCBpbiBlaXRoZXIgc2luZ2xlIHF1b3RlLFxuICAgKiBkb3VibGUgcXVvdGVzIG9yIGJhY2stdGlja3MuXG4gICAqL1xuICBjb25zdCBleHRyYWN0aW9uUmVnZXggPVxuICAgIC9bXCInXT9zZXJpYWxpemVkRXJyb3JbXCInXT86WyBdPyg/OmAoLis/KWB8JyguKz8pJ3xcIigoPzpcXFxcXCJ8W15cIl0pKj8pXCIpLztcbiAgY29uc3Qgc2VyaWFsaXplZCA9IF9zdGRlcnIubWF0Y2goZXh0cmFjdGlvblJlZ2V4KTtcbiAgaWYgKHNlcmlhbGl6ZWQgJiYgc2VyaWFsaXplZC5sZW5ndGggPT09IDQpIHtcbiAgICAvLyA0IGJlY2F1c2UgMSBtYXRjaCBhbmQgMyBjYXB0dXJpbmcgZ3JvdXBzXG4gICAgcmV0dXJuIHNlcmlhbGl6ZWRcbiAgICAgIC5zbGljZSgxKVxuICAgICAgLmZpbmQoKGl0ZW0pID0+IGl0ZW0gJiYgaXRlbS5sZW5ndGggPiAwKVxuICAgICAgPy5yZXBsYWNlQWxsKCdcXFxcXCInLCAnXCInKVxuICAgICAgLnJlcGxhY2VBbGwoXCJcXFxcJ1wiLCBcIidcIik7XG4gIH1cbiAgcmV0dXJuIHVuZGVmaW5lZDtcbn07XG5cbmNvbnN0IGlzQ3JlZGVudGlhbHNFcnJvciA9IChlcnI/OiBFcnJvcik6IGJvb2xlYW4gPT4ge1xuICByZXR1cm4gKFxuICAgICEhZXJyICYmXG4gICAgW1xuICAgICAgJ0V4cGlyZWRUb2tlbicsXG4gICAgICAnRXhwaXJlZFRva2VuRXhjZXB0aW9uJyxcbiAgICAgICdDcmVkZW50aWFsc1Byb3ZpZGVyRXJyb3InLFxuICAgICAgJ0ludmFsaWRDbGllbnRUb2tlbklkJyxcbiAgICAgICdDcmVkZW50aWFsc0Vycm9yJyxcbiAgICBdLmluY2x1ZGVzKGVyci5uYW1lKVxuICApO1xufTtcblxuY29uc3QgaXNQZXJtaXNzaW9uc0Vycm9yID0gKGVycj86IEVycm9yKTogYm9vbGVhbiA9PiB7XG4gIHJldHVybiAhIWVyciAmJiBbJ0FjY2Vzc0RlbmllZEV4Y2VwdGlvbicsICdBY2Nlc3NEZW5pZWQnXS5pbmNsdWRlcyhlcnIubmFtZSk7XG59O1xuXG5jb25zdCBpc1JlcXVlc3RTaWduYXR1cmVFcnJvciA9IChlcnI/OiBFcnJvcik6IGJvb2xlYW4gPT4ge1xuICByZXR1cm4gKFxuICAgICEhZXJyICYmXG4gICAgWydJbnZhbGlkU2lnbmF0dXJlRXhjZXB0aW9uJywgJ1NpZ25hdHVyZURvZXNOb3RNYXRjaCddLmluY2x1ZGVzKGVyci5uYW1lKVxuICApO1xufTtcblxuLy8gVGhlc2UgdmFsaWRhdGlvbiBtZXNzYWdlcyBhcmUgdGFrZW4gZnJvbSBodHRwczovL2dpdGh1Yi5jb20veWFyZ3MveWFyZ3MvYmxvYi8wYzk1ZjljNzllMTgxMGNmOWM4OTY0ZmJmN2QxMzkwMDk0MTJmN2U3L2xpYi92YWxpZGF0aW9uLnRzXG5jb25zdCBpc1lhcmdzVmFsaWRhdGlvbkVycm9yID0gKGVycj86IEVycm9yKTogYm9vbGVhbiA9PiB7XG4gIHJldHVybiAoXG4gICAgISFlcnIgJiZcbiAgICAoW1xuICAgICAgJ1Vua25vd24gY29tbWFuZCcsXG4gICAgICAnVW5rbm93biBhcmd1bWVudCcsXG4gICAgICAnRGlkIHlvdSBtZWFuJyxcbiAgICAgICdOb3QgZW5vdWdoIG5vbi1vcHRpb24gYXJndW1lbnRzJyxcbiAgICAgICdUb28gbWFueSBub24tb3B0aW9uIGFyZ3VtZW50cycsXG4gICAgICAnTWlzc2luZyByZXF1aXJlZCBhcmd1bWVudCcsXG4gICAgICAnSW52YWxpZCB2YWx1ZXM6JyxcbiAgICAgICdNaXNzaW5nIGRlcGVuZGVudCBhcmd1bWVudHMnLFxuICAgICAgJ0ltcGxpY2F0aW9ucyBmYWlsZWQnLFxuICAgIF0uc29tZSgobWVzc2FnZSkgPT4gZXJyLm1lc3NhZ2Uuc3RhcnRzV2l0aChtZXNzYWdlKSkgfHxcbiAgICAgIGVyci5tZXNzYWdlLmVuZHNXaXRoKCdhcmUgbXV0dWFsbHkgZXhjbHVzaXZlJykpXG4gICk7XG59O1xuXG5jb25zdCBpc0VOb3RGb3VuZEVycm9yID0gKGVycj86IEVycm9yKTogYm9vbGVhbiA9PiB7XG4gIHJldHVybiAhIWVyciAmJiBlcnIubWVzc2FnZS5pbmNsdWRlcygnZ2V0YWRkcmluZm8gRU5PVEZPVU5EJyk7XG59O1xuXG5jb25zdCBpc1N5bnRheEVycm9yID0gKGVycj86IEVycm9yKTogYm9vbGVhbiA9PiB7XG4gIHJldHVybiAhIWVyciAmJiBlcnIubmFtZSA9PT0gJ1N5bnRheEVycm9yJztcbn07XG5cbmNvbnN0IGlzSW5zdWZmaWNpZW50RGlza1NwYWNlRXJyb3IgPSAoZXJyPzogRXJyb3IpOiBib29sZWFuID0+IHtcbiAgcmV0dXJuIChcbiAgICAhIWVyciAmJlxuICAgIFsnRU5PU1BDOiBubyBzcGFjZSBsZWZ0IG9uIGRldmljZScsICdjb2RlIEVOT1NQQyddLnNvbWUoKG1lc3NhZ2UpID0+XG4gICAgICBlcnIubWVzc2FnZS5pbmNsdWRlcyhtZXNzYWdlKSxcbiAgICApXG4gICk7XG59O1xuXG5jb25zdCBpc091dE9mTWVtb3J5RXJyb3IgPSAoZXJyPzogRXJyb3IpOiBib29sZWFuID0+IHtcbiAgcmV0dXJuIChcbiAgICAhIWVyciAmJlxuICAgIChlcnIubWVzc2FnZS5pbmNsdWRlcygncHJvY2VzcyBvdXQgb2YgbWVtb3J5JykgfHxcbiAgICAgIGVyci5tZXNzYWdlLmluY2x1ZGVzKCdjb25uZWN0IEVOT01FTScpKVxuICApO1xufTtcblxuY29uc3QgaXNJbm90aWZ5RXJyb3IgPSAoZXJyPzogRXJyb3IpOiBib29sZWFuID0+IHtcbiAgcmV0dXJuICEhZXJyICYmIGVyci5tZXNzYWdlLmluY2x1ZGVzKCdpbm90aWZ5X2FkZF93YXRjaCcpO1xufTtcblxuLyoqXG4gKiBBbXBsaWZ5IGV4Y2VwdGlvbiBjbGFzc2lmaWNhdGlvbnNcbiAqL1xuZXhwb3J0IHR5cGUgQW1wbGlmeUVycm9yQ2xhc3NpZmljYXRpb24gPSAnRkFVTFQnIHwgJ0VSUk9SJztcblxuLyoqXG4gKiBBbXBsaWZ5IEVycm9yIG9wdGlvbnMgb2JqZWN0XG4gKi9cbmV4cG9ydCB0eXBlIEFtcGxpZnlFcnJvck9wdGlvbnMgPSB7XG4gIG1lc3NhZ2U6IHN0cmluZztcbiAgZGV0YWlscz86IHN0cmluZztcbiAgcmVzb2x1dGlvbj86IHN0cmluZztcbiAgbGluaz86IHN0cmluZztcblxuICAvLyBDbG91ZEZvcm1hdGlvbiBvciBOb2RlSlMgZXJyb3IgY29kZXNcbiAgY29kZT86IHN0cmluZztcbn07XG5cbi8qKlxuICogU2FtZSBhcyBBbXBsaWZ5RXJyb3JPcHRpb25zIGV4Y2VwdCByZXNvbHV0aW9uIGlzIHJlcXVpcmVkXG4gKi9cbmV4cG9ydCB0eXBlIEFtcGxpZnlVc2VyRXJyb3JPcHRpb25zID0gT21pdDxcbiAgQW1wbGlmeUVycm9yT3B0aW9ucyxcbiAgJ3Jlc29sdXRpb24nXG4+ICYgeyByZXNvbHV0aW9uOiBzdHJpbmcgfTtcblxuY29uc3QgZXJyb3JTZXJpYWxpemVyID0gKF86IHVua25vd24sIHZhbHVlOiB1bmtub3duKSA9PiB7XG4gIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgcmV0dXJuIEVycm9yU2VyaWFsaXplckRlc2VyaWFsaXplci5zZXJpYWxpemUodmFsdWUpO1xuICB9XG4gIHJldHVybiB2YWx1ZTtcbn07XG5jbGFzcyBFcnJvclNlcmlhbGl6ZXJEZXNlcmlhbGl6ZXIge1xuICBzdGF0aWMgc2VyaWFsaXplID0gKGVycm9yOiBFcnJvcikgPT4ge1xuICAgIGNvbnN0IHNlcmlhbGl6ZWRFcnJvcjogU2VyaWFsaXplZEVycm9yVHlwZSA9IHtcbiAgICAgIG5hbWU6IGVycm9yLm5hbWUsXG4gICAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlLFxuICAgIH07XG4gICAgcmV0dXJuIHNlcmlhbGl6ZWRFcnJvcjtcbiAgfTtcblxuICBzdGF0aWMgZGVzZXJpYWxpemUgPSAoZGVzZXJpYWxpemVkOiBTZXJpYWxpemVkRXJyb3JUeXBlKSA9PiB7XG4gICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoZGVzZXJpYWxpemVkLm1lc3NhZ2UpO1xuICAgIGVycm9yLm5hbWUgPSBkZXNlcmlhbGl6ZWQubmFtZTtcbiAgICByZXR1cm4gZXJyb3I7XG4gIH07XG5cbiAgc3RhdGljIGlzU2VyaWFsaXplZEVycm9yVHlwZSA9IChvYmo6IHVua25vd24pOiBvYmogaXMgU2VyaWFsaXplZEVycm9yVHlwZSA9PiB7XG4gICAgaWYgKFxuICAgICAgb2JqICYmXG4gICAgICAob2JqIGFzIFNlcmlhbGl6ZWRFcnJvclR5cGUpLm5hbWUgJiZcbiAgICAgIChvYmogYXMgU2VyaWFsaXplZEVycm9yVHlwZSkubWVzc2FnZVxuICAgIClcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfTtcbn1cbnR5cGUgU2VyaWFsaXplZEVycm9yVHlwZSA9IHtcbiAgbmFtZTogc3RyaW5nO1xuICBtZXNzYWdlOiBzdHJpbmc7XG59O1xuIl19