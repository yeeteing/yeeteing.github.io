import { Tags } from 'aws-cdk-lib';
import { AmplifyStack } from './engine/amplify_stack.js';
/**
 * Creates stacks that are tied to a given project environment via an SSM parameter
 */
export class ProjectEnvironmentMainStackCreator {
    scope;
    backendId;
    mainStack = undefined;
    /**
     * Initialize with a project environment
     */
    constructor(scope, backendId) {
        this.scope = scope;
        this.backendId = backendId;
    }
    /**
     * Get a stack for this environment in the provided CDK scope
     */
    getOrCreateMainStack = () => {
        if (this.mainStack === undefined) {
            this.mainStack = new AmplifyStack(this.scope, this.backendId);
        }
        const deploymentType = this.backendId.type;
        Tags.of(this.mainStack).add('created-by', 'amplify');
        if (deploymentType === 'branch') {
            Tags.of(this.mainStack).add('amplify:app-id', this.backendId.namespace);
            Tags.of(this.mainStack).add('amplify:branch-name', this.backendId.name);
            Tags.of(this.mainStack).add('amplify:deployment-type', 'branch');
        }
        else if (deploymentType === 'sandbox') {
            Tags.of(this.mainStack).add('amplify:deployment-type', 'sandbox');
        }
        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
        return this.mainStack;
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvamVjdF9lbnZpcm9ubWVudF9tYWluX3N0YWNrX2NyZWF0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcHJvamVjdF9lbnZpcm9ubWVudF9tYWluX3N0YWNrX2NyZWF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFTLElBQUksRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUMxQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFFekQ7O0dBRUc7QUFDSCxNQUFNLE9BQU8sa0NBQWtDO0lBTTFCO0lBQ0E7SUFOWCxTQUFTLEdBQXNCLFNBQVMsQ0FBQztJQUNqRDs7T0FFRztJQUNILFlBQ21CLEtBQWdCLEVBQ2hCLFNBQTRCO1FBRDVCLFVBQUssR0FBTCxLQUFLLENBQVc7UUFDaEIsY0FBUyxHQUFULFNBQVMsQ0FBbUI7SUFDNUMsQ0FBQztJQUVKOztPQUVHO0lBQ0gsb0JBQW9CLEdBQUcsR0FBVSxFQUFFO1FBQ2pDLElBQUksSUFBSSxDQUFDLFNBQVMsS0FBSyxTQUFTLEVBQUUsQ0FBQztZQUNqQyxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksWUFBWSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ2hFLENBQUM7UUFFRCxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQztRQUMzQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ3JELElBQUksY0FBYyxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQ2hDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3hFLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3hFLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyx5QkFBeUIsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUNuRSxDQUFDO2FBQU0sSUFBSSxjQUFjLEtBQUssU0FBUyxFQUFFLENBQUM7WUFDeEMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBRyxDQUFDLHlCQUF5QixFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ3BFLENBQUM7UUFDRCxvRUFBb0U7UUFDcEUsT0FBTyxJQUFJLENBQUMsU0FBVSxDQUFDO0lBQ3pCLENBQUMsQ0FBQztDQUNIIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQmFja2VuZElkZW50aWZpZXIsIE1haW5TdGFja0NyZWF0b3IgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgU3RhY2ssIFRhZ3MgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgeyBBbXBsaWZ5U3RhY2sgfSBmcm9tICcuL2VuZ2luZS9hbXBsaWZ5X3N0YWNrLmpzJztcblxuLyoqXG4gKiBDcmVhdGVzIHN0YWNrcyB0aGF0IGFyZSB0aWVkIHRvIGEgZ2l2ZW4gcHJvamVjdCBlbnZpcm9ubWVudCB2aWEgYW4gU1NNIHBhcmFtZXRlclxuICovXG5leHBvcnQgY2xhc3MgUHJvamVjdEVudmlyb25tZW50TWFpblN0YWNrQ3JlYXRvciBpbXBsZW1lbnRzIE1haW5TdGFja0NyZWF0b3Ige1xuICBwcml2YXRlIG1haW5TdGFjazogU3RhY2sgfCB1bmRlZmluZWQgPSB1bmRlZmluZWQ7XG4gIC8qKlxuICAgKiBJbml0aWFsaXplIHdpdGggYSBwcm9qZWN0IGVudmlyb25tZW50XG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgcHJpdmF0ZSByZWFkb25seSBiYWNrZW5kSWQ6IEJhY2tlbmRJZGVudGlmaWVyLFxuICApIHt9XG5cbiAgLyoqXG4gICAqIEdldCBhIHN0YWNrIGZvciB0aGlzIGVudmlyb25tZW50IGluIHRoZSBwcm92aWRlZCBDREsgc2NvcGVcbiAgICovXG4gIGdldE9yQ3JlYXRlTWFpblN0YWNrID0gKCk6IFN0YWNrID0+IHtcbiAgICBpZiAodGhpcy5tYWluU3RhY2sgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5tYWluU3RhY2sgPSBuZXcgQW1wbGlmeVN0YWNrKHRoaXMuc2NvcGUsIHRoaXMuYmFja2VuZElkKTtcbiAgICB9XG5cbiAgICBjb25zdCBkZXBsb3ltZW50VHlwZSA9IHRoaXMuYmFja2VuZElkLnR5cGU7XG4gICAgVGFncy5vZih0aGlzLm1haW5TdGFjaykuYWRkKCdjcmVhdGVkLWJ5JywgJ2FtcGxpZnknKTtcbiAgICBpZiAoZGVwbG95bWVudFR5cGUgPT09ICdicmFuY2gnKSB7XG4gICAgICBUYWdzLm9mKHRoaXMubWFpblN0YWNrKS5hZGQoJ2FtcGxpZnk6YXBwLWlkJywgdGhpcy5iYWNrZW5kSWQubmFtZXNwYWNlKTtcbiAgICAgIFRhZ3Mub2YodGhpcy5tYWluU3RhY2spLmFkZCgnYW1wbGlmeTpicmFuY2gtbmFtZScsIHRoaXMuYmFja2VuZElkLm5hbWUpO1xuICAgICAgVGFncy5vZih0aGlzLm1haW5TdGFjaykuYWRkKCdhbXBsaWZ5OmRlcGxveW1lbnQtdHlwZScsICdicmFuY2gnKTtcbiAgICB9IGVsc2UgaWYgKGRlcGxveW1lbnRUeXBlID09PSAnc2FuZGJveCcpIHtcbiAgICAgIFRhZ3Mub2YodGhpcy5tYWluU3RhY2spLmFkZCgnYW1wbGlmeTpkZXBsb3ltZW50LXR5cGUnLCAnc2FuZGJveCcpO1xuICAgIH1cbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLW5vbi1udWxsLWFzc2VydGlvblxuICAgIHJldHVybiB0aGlzLm1haW5TdGFjayE7XG4gIH07XG59XG4iXX0=