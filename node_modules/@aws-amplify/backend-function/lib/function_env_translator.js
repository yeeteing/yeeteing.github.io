import { Arn, Lazy, Stack } from 'aws-cdk-lib';
import { Effect, PolicyStatement } from 'aws-cdk-lib/aws-iam';
import { AmplifyUserError } from '@aws-amplify/platform-core';
import { amplifySsmEnvConfigKey, ssmValuePlaceholderText, } from './constants.js';
/**
 * Translates function environment props into appropriate environment records and builds a policy statement
 * in order to resolve secrets in environment props.
 */
export class FunctionEnvironmentTranslator {
    lambda;
    functionEnvironmentProp;
    backendSecretResolver;
    functionEnvironmentTypeGenerator;
    ssmPaths = [];
    ssmEnvVars = {};
    // List of environment variable names for typed shim generation
    amplifyBackendEnvVarNames = [];
    /**
     * Initialize translated environment variable records
     */
    constructor(lambda, // we need to use a specific type here so that we have all the method goodies
    functionEnvironmentProp, backendSecretResolver, functionEnvironmentTypeGenerator) {
        this.lambda = lambda;
        this.functionEnvironmentProp = functionEnvironmentProp;
        this.backendSecretResolver = backendSecretResolver;
        this.functionEnvironmentTypeGenerator = functionEnvironmentTypeGenerator;
        for (const [key, value] of Object.entries(this.functionEnvironmentProp)) {
            this.addEnvironmentEntry(key, value);
        }
        // add an environment variable for ssm parameter metadata that is resolved after initialization but before synth is finalized
        this.lambda.addEnvironment(amplifySsmEnvConfigKey, Lazy.string({
            produce: () => JSON.stringify(this.ssmEnvVars),
        }));
        this.lambda.node.addValidation({
            validate: () => {
                // only add the ssm access policy if there are ssm paths
                if (this.ssmPaths.length > 0) {
                    const ssmAccessPolicy = new PolicyStatement({
                        effect: Effect.ALLOW,
                        actions: ['ssm:GetParameters'],
                        resources: this.ssmPaths
                            .map((path) => (path.startsWith('/') ? path.slice(1) : path)) // the Arn formatter will add a leading slash between the resource and resourceName
                            .map((path) => Arn.format({
                            service: 'ssm',
                            resource: 'parameter',
                            resourceName: path,
                        }, Stack.of(this.lambda))),
                    });
                    this.lambda.grantPrincipal.addToPrincipalPolicy(ssmAccessPolicy);
                }
                return [];
            },
        });
        // Using CDK validation mechanism as a way to generate a typed process.env shim file at the end of synthesis
        this.lambda.node.addValidation({
            validate: () => {
                this.functionEnvironmentTypeGenerator.generateTypedProcessEnvShim(this.amplifyBackendEnvVarNames);
                return [];
            },
        });
    }
    /**
     * Adds an environment variable to the lambda to be used at runtime
     * @param key The environment variable name
     * @param value envVar value that can be a plain text or a secret
     */
    addEnvironmentEntry = (key, value) => {
        if (key === amplifySsmEnvConfigKey) {
            throw new AmplifyUserError('FunctionReservedEnvironmentVariableError', {
                message: `${amplifySsmEnvConfigKey} is a reserved environment variable name`,
                resolution: 'Please use a non-reserved environment variable name.',
            });
        }
        if (typeof value === 'undefined') {
            throw new AmplifyUserError('InvalidFunctionConfigurationError', {
                message: `The value of environment variable ${key} is undefined.`,
                resolution: `Ensure that all defineFunction environment variables are defined.`,
            });
        }
        else if (typeof value === 'string') {
            this.lambda.addEnvironment(key, value);
        }
        else {
            const { branchSecretPath, sharedSecretPath } = this.backendSecretResolver.resolvePath(value);
            this.lambda.addEnvironment(key, ssmValuePlaceholderText);
            this.ssmEnvVars[key] = {
                path: branchSecretPath,
                sharedPath: sharedSecretPath,
            };
            this.ssmPaths.push(branchSecretPath, sharedSecretPath);
        }
        this.amplifyBackendEnvVarNames.push(key);
    };
    /**
     * Adds an environment variable to the lambda whose value will be fetched from SSM at runtime
     * @param name The environment variable name
     * @param ssmPath The SSM path where the value is stored
     */
    addSsmEnvironmentEntry = (name, ssmPath) => {
        this.lambda.addEnvironment(name, ssmValuePlaceholderText);
        this.ssmPaths.push(ssmPath);
        this.ssmEnvVars[name] = { path: ssmPath };
        this.amplifyBackendEnvVarNames.push(name);
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnVuY3Rpb25fZW52X3RyYW5zbGF0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZnVuY3Rpb25fZW52X3RyYW5zbGF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBSUEsT0FBTyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRy9DLE9BQU8sRUFBRSxNQUFNLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFOUQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDOUQsT0FBTyxFQUNMLHNCQUFzQixFQUN0Qix1QkFBdUIsR0FDeEIsTUFBTSxnQkFBZ0IsQ0FBQztBQUV4Qjs7O0dBR0c7QUFDSCxNQUFNLE9BQU8sNkJBQTZCO0lBV3JCO0lBQ0E7SUFDQTtJQUNBO0lBYkYsUUFBUSxHQUFhLEVBQUUsQ0FBQztJQUN4QixVQUFVLEdBQWUsRUFBRSxDQUFDO0lBRTdDLCtEQUErRDtJQUM5Qyx5QkFBeUIsR0FBYSxFQUFFLENBQUM7SUFFMUQ7O09BRUc7SUFDSCxZQUNtQixNQUFzQixFQUFFLDZFQUE2RTtJQUNyRyx1QkFBK0QsRUFDL0QscUJBQTRDLEVBQzVDLGdDQUFrRTtRQUhsRSxXQUFNLEdBQU4sTUFBTSxDQUFnQjtRQUN0Qiw0QkFBdUIsR0FBdkIsdUJBQXVCLENBQXdDO1FBQy9ELDBCQUFxQixHQUFyQixxQkFBcUIsQ0FBdUI7UUFDNUMscUNBQWdDLEdBQWhDLGdDQUFnQyxDQUFrQztRQUVuRixLQUFLLE1BQU0sQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsdUJBQXVCLENBQUMsRUFBRSxDQUFDO1lBQ3hFLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDdkMsQ0FBQztRQUVELDZIQUE2SDtRQUM3SCxJQUFJLENBQUMsTUFBTSxD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QUFVLENBQUMsR0FBRyxDQUFDLEdBQUc7Z0JBQ3JCLElBQUksRUFBRSxnQkFBZ0I7Z0JBQ3RCLFVBQVUsRUFBRSxnQkFBZ0I7YUFDN0IsQ0FBQztZQUNGLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLGdCQUFnQixDQUFDLENBQUM7UUFDekQsQ0FBQztRQUNELElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDM0MsQ0FBQyxDQUFDO0lBRUY7Ozs7T0FJRztJQUNILHNCQUFzQixHQUFHLENBQUMsSUFBWSxFQUFFLE9BQWUsRUFBRSxFQUFFO1FBQ3pELElBQUksQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSx1QkFBdUIsQ0FBQyxDQUFDO1FBQzFELElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzVCLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLENBQUM7UUFDMUMsSUFBSSxDQUFDLHlCQUF5QixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM1QyxDQUFDLENBQUM7Q0FDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEJhY2tlbmRTZWNyZXQsXG4gIEJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQgeyBBcm4sIExhenksIFN0YWNrIH0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgRnVuY3Rpb25Qcm9wcyB9IGZyb20gJy4vZmFjdG9yeS5qcyc7XG5pbXBvcnQgeyBOb2RlanNGdW5jdGlvbiB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEtbm9kZWpzJztcbmltcG9ydCB7IEVmZmVjdCwgUG9saWN5U3RhdGVtZW50IH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWlhbSc7XG5pbXBvcnQgeyBGdW5jdGlvbkVudmlyb25tZW50VHlwZUdlbmVyYXRvciB9IGZyb20gJy4vZnVuY3Rpb25fZW52X3R5cGVfZ2VuZXJhdG9yLmpzJztcbmltcG9ydCB7IEFtcGxpZnlVc2VyRXJyb3IgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5pbXBvcnQge1xuICBhbXBsaWZ5U3NtRW52Q29uZmlnS2V5LFxuICBzc21WYWx1ZVBsYWNlaG9sZGVyVGV4dCxcbn0gZnJvbSAnLi9jb25zdGFudHMuanMnO1xuXG4vKipcbiAqIFRyYW5zbGF0ZXMgZnVuY3Rpb24gZW52aXJvbm1lbnQgcHJvcHMgaW50byBhcHByb3ByaWF0ZSBlbnZpcm9ubWVudCByZWNvcmRzIGFuZCBidWlsZHMgYSBwb2xpY3kgc3RhdGVtZW50XG4gKiBpbiBvcmRlciB0byByZXNvbHZlIHNlY3JldHMgaW4gZW52aXJvbm1lbnQgcHJvcHMuXG4gKi9cbmV4cG9ydCBjbGFzcyBGdW5jdGlvbkVudmlyb25tZW50VHJhbnNsYXRvciB7XG4gIHByaXZhdGUgcmVhZG9ubHkgc3NtUGF0aHM6IHN0cmluZ1tdID0gW107XG4gIHByaXZhdGUgcmVhZG9ubHkgc3NtRW52VmFyczogU3NtRW52VmFycyA9IHt9O1xuXG4gIC8vIExpc3Qgb2YgZW52aXJvbm1lbnQgdmFyaWFibGUgbmFtZXMgZm9yIHR5cGVkIHNoaW0gZ2VuZXJhdGlvblxuICBwcml2YXRlIHJlYWRvbmx5IGFtcGxpZnlCYWNrZW5kRW52VmFyTmFtZXM6IHN0cmluZ1tdID0gW107XG5cbiAgLyoqXG4gICAqIEluaXRpYWxpemUgdHJhbnNsYXRlZCBlbnZpcm9ubWVudCB2YXJpYWJsZSByZWNvcmRzXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IGxhbWJkYTogTm9kZWpzRnVuY3Rpb24sIC8vIHdlIG5lZWQgdG8gdXNlIGEgc3BlY2lmaWMgdHlwZSBoZXJlIHNvIHRoYXQgd2UgaGF2ZSBhbGwgdGhlIG1ldGhvZCBnb29kaWVzXG4gICAgcHJpdmF0ZSByZWFkb25seSBmdW5jdGlvbkVudmlyb25tZW50UHJvcDogUmVxdWlyZWQ8RnVuY3Rpb25Qcm9wcz5bJ2Vudmlyb25tZW50J10sXG4gICAgcHJpdmF0ZSByZWFkb25seSBiYWNrZW5kU2VjcmV0UmVzb2x2ZXI6IEJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgICBwcml2YXRlIHJlYWRvbmx5IGZ1bmN0aW9uRW52aXJvbm1lbnRUeXBlR2VuZXJhdG9yOiBGdW5jdGlvbkVudmlyb25tZW50VHlwZUdlbmVyYXRvcixcbiAgKSB7XG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXModGhpcy5mdW5jdGlvbkVudmlyb25tZW50UHJvcCkpIHtcbiAgICAgIHRoaXMuYWRkRW52aXJvbm1lbnRFbnRyeShrZXksIHZhbHVlKTtcbiAgICB9XG5cbiAgICAvLyBhZGQgYW4gZW52aXJvbm1lbnQgdmFyaWFibGUgZm9yIHNzbSBwYXJhbWV0ZXIgbWV0YWRhdGEgdGhhdCBpcyByZXNvbHZlZCBhZnRlciBpbml0aWFsaXphdGlvbiBidXQgYmVmb3JlIHN5bnRoIGlzIGZpbmFsaXplZFxuICAgIHRoaXMubGFtYmRhLmFkZEVudmlyb25tZW50KFxuICAgICAgYW1wbGlmeVNzbUVudkNvbmZpZ0tleSxcbiAgICAgIExhenkuc3RyaW5nKHtcbiAgICAgICAgcHJvZHVjZTogKCkgPT4gSlNPTi5zdHJpbmdpZnkodGhpcy5zc21FbnZWYXJzKSxcbiAgICAgIH0pLFxuICAgICk7XG5cbiAgICB0aGlzLmxhbWJkYS5ub2RlLmFkZFZhbGlkYXRpb24oe1xuICAgICAgdmFsaWRhdGU6ICgpID0+IHtcbiAgICAgICAgLy8gb25seSBhZGQgdGhlIHNzbSBhY2Nlc3MgcG9saWN5IGlmIHRoZXJlIGFyZSBzc20gcGF0aHNcbiAgICAgICAgaWYgKHRoaXMuc3NtUGF0aHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgIGNvbnN0IHNzbUFjY2Vzc1BvbGljeSA9IG5ldyBQb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgICAgZWZmZWN0OiBFZmZlY3QuQUxMT1csXG4gICAgICAgICAgICBhY3Rpb25zOiBbJ3NzbTpHZXRQYXJhbWV0ZXJzJ10sXG4gICAgICAgICAgICByZXNvdXJjZXM6IHRoaXMuc3NtUGF0aHNcbiAgICAgICAgICAgICAgLm1hcCgocGF0aCkgPT4gKHBhdGguc3RhcnRzV2l0aCgnLycpID8gcGF0aC5zbGljZSgxKSA6IHBhdGgpKSAvLyB0aGUgQXJuIGZvcm1hdHRlciB3aWxsIGFkZCBhIGxlYWRpbmcgc2xhc2ggYmV0d2VlbiB0aGUgcmVzb3VyY2UgYW5kIHJlc291cmNlTmFtZVxuICAgICAgICAgICAgICAubWFwKChwYXRoKSA9PlxuICAgICAgICAgICAgICAgIEFybi5mb3JtYXQoXG4gICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIHNlcnZpY2U6ICdzc20nLFxuICAgICAgICAgICAgICAgICAgICByZXNvdXJjZTogJ3BhcmFtZXRlcicsXG4gICAgICAgICAgICAgICAgICAgIHJlc291cmNlTmFtZTogcGF0aCxcbiAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICBTdGFjay5vZih0aGlzLmxhbWJkYSksXG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgKSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgICB0aGlzLmxhbWJkYS5ncmFudFByaW5jaXBhbC5hZGRUb1ByaW5jaXBhbFBvbGljeShzc21BY2Nlc3NQb2xpY3kpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBbXTtcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBVc2luZyBDREsgdmFsaWRhdGlvbiBtZWNoYW5pc20gYXMgYSB3YXkgdG8gZ2VuZXJhdGUgYSB0eXBlZCBwcm9jZXNzLmVudiBzaGltIGZpbGUgYXQgdGhlIGVuZCBvZiBzeW50aGVzaXNcbiAgICB0aGlzLmxhbWJkYS5ub2RlLmFkZFZhbGlkYXRpb24oe1xuICAgICAgdmFsaWRhdGU6ICgpOiBzdHJpbmdbXSA9PiB7XG4gICAgICAgIHRoaXMuZnVuY3Rpb25FbnZpcm9ubWVudFR5cGVHZW5lcmF0b3IuZ2VuZXJhdGVUeXBlZFByb2Nlc3NFbnZTaGltKFxuICAgICAgICAgIHRoaXMuYW1wbGlmeUJhY2tlbmRFbnZWYXJOYW1lcyxcbiAgICAgICAgKTtcbiAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGRzIGFuIGVudmlyb25tZW50IHZhcmlhYmxlIHRvIHRoZSBsYW1iZGEgdG8gYmUgdXNlZCBhdCBydW50aW1lXG4gICAqIEBwYXJhbSBrZXkgVGhlIGVudmlyb25tZW50IHZhcmlhYmxlIG5hbWVcbiAgICogQHBhcmFtIHZhbHVlIGVudlZhciB2YWx1ZSB0aGF0IGNhbiBiZSBhIHBsYWluIHRleHQgb3IgYSBzZWNyZXRcbiAgICovXG4gIGFkZEVudmlyb25tZW50RW50cnkgPSAoa2V5OiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcgfCBCYWNrZW5kU2VjcmV0KSA9PiB7XG4gICAgaWYgKGtleSA9PT0gYW1wbGlmeVNzbUVudkNvbmZpZ0tleSkge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoJ0Z1bmN0aW9uUmVzZXJ2ZWRFbnZpcm9ubWVudFZhcmlhYmxlRXJyb3InLCB7XG4gICAgICAgIG1lc3NhZ2U6IGAke2FtcGxpZnlTc21FbnZDb25maWdLZXl9IGlzIGEgcmVzZXJ2ZWQgZW52aXJvbm1lbnQgdmFyaWFibGUgbmFtZWAsXG4gICAgICAgIHJlc29sdXRpb246ICdQbGVhc2UgdXNlIGEgbm9uLXJlc2VydmVkIGVudmlyb25tZW50IHZhcmlhYmxlIG5hbWUuJyxcbiAgICAgIH0pO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAndW5kZWZpbmVkJykge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoJ0ludmFsaWRGdW5jdGlvbkNvbmZpZ3VyYXRpb25FcnJvcicsIHtcbiAgICAgICAgbWVzc2FnZTogYFRoZSB2YWx1ZSBvZiBlbnZpcm9ubWVudCB2YXJpYWJsZSAke2tleX0gaXMgdW5kZWZpbmVkLmAsXG4gICAgICAgIHJlc29sdXRpb246IGBFbnN1cmUgdGhhdCBhbGwgZGVmaW5lRnVuY3Rpb24gZW52aXJvbm1lbnQgdmFyaWFibGVzIGFyZSBkZWZpbmVkLmAsXG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHRoaXMubGFtYmRhLmFkZEVudmlyb25tZW50KGtleSwgdmFsdWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCB7IGJyYW5jaFNlY3JldFBhdGgsIHNoYXJlZFNlY3JldFBhdGggfSA9XG4gICAgICAgIHRoaXMuYmFja2VuZFNlY3JldFJlc29sdmVyLnJlc29sdmVQYXRoKHZhbHVlKTtcbiAgICAgIHRoaXMubGFtYmRhLmFkZEVudmlyb25tZW50KGtleSwgc3NtVmFsdWVQbGFjZWhvbGRlclRleHQpO1xuICAgICAgdGhpcy5zc21FbnZWYXJzW2tleV0gPSB7XG4gICAgICAgIHBhdGg6IGJyYW5jaFNlY3JldFBhdGgsXG4gICAgICAgIHNoYXJlZFBhdGg6IHNoYXJlZFNlY3JldFBhdGgsXG4gICAgICB9O1xuICAgICAgdGhpcy5zc21QYXRocy5wdXNoKGJyYW5jaFNlY3JldFBhdGgsIHNoYXJlZFNlY3JldFBhdGgpO1xuICAgIH1cbiAgICB0aGlzLmFtcGxpZnlCYWNrZW5kRW52VmFyTmFtZXMucHVzaChrZXkpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBBZGRzIGFuIGVudmlyb25tZW50IHZhcmlhYmxlIHRvIHRoZSBsYW1iZGEgd2hvc2UgdmFsdWUgd2lsbCBiZSBmZXRjaGVkIGZyb20gU1NNIGF0IHJ1bnRpbWVcbiAgICogQHBhcmFtIG5hbWUgVGhlIGVudmlyb25tZW50IHZhcmlhYmxlIG5hbWVcbiAgICogQHBhcmFtIHNzbVBhdGggVGhlIFNTTSBwYXRoIHdoZXJlIHRoZSB2YWx1ZSBpcyBzdG9yZWRcbiAgICovXG4gIGFkZFNzbUVudmlyb25tZW50RW50cnkgPSAobmFtZTogc3RyaW5nLCBzc21QYXRoOiBzdHJpbmcpID0+IHtcbiAgICB0aGlzLmxhbWJkYS5hZGRFbnZpcm9ubWVudChuYW1lLCBzc21WYWx1ZVBsYWNlaG9sZGVyVGV4dCk7XG4gICAgdGhpcy5zc21QYXRocy5wdXNoKHNzbVBhdGgpO1xuICAgIHRoaXMuc3NtRW52VmFyc1tuYW1lXSA9IHsgcGF0aDogc3NtUGF0aCB9O1xuICAgIHRoaXMuYW1wbGlmeUJhY2tlbmRFbnZWYXJOYW1lcy5wdXNoKG5hbWUpO1xuICB9O1xufVxuXG4vKipcbiAqIERlZmluZXMgbWV0YWRhdGEgYXJvdW5kIGVudmlyb25tZW50IHZhcmlhYmxlIHZhbHVlcyB0aGF0IGFyZSBmZXRjaGVkIGZyb20gU1NNIGR1cmluZyBydW50aW1lIG9mIHRoZSBsYW1iZGEgZnVuY3Rpb25cbiAqL1xuZXhwb3J0IHR5cGUgU3NtRW52VmFycyA9IHtcbiAgLyoqXG4gICAqIFRoZSBlbnZpcm9ubWVudCB2YXJpYWJsZSBuYW1lIHRvIHBsYWNlIHRoZSByZXNvbHZlZCB2YWx1ZSBpblxuICAgKi9cbiAgW25hbWU6IHN0cmluZ106IHtcbiAgICAvKipcbiAgICAgKiBUaGUgcmVjb3JkIGtleSBuYW1lcyBhcmUgdGhlIGJyYW5jaC9zYW5kYm94IHNwZWNpZmljIFNTTSBwYXRocyB0byBmZXRjaCB0aGUgdmFsdWUgZnJvbVxuICAgICAqL1xuICAgIHBhdGg6IHN0cmluZztcbiAgICAvKipcbiAgICAgKiBBbiBvcHRpb25hbCBcImZhbGxiYWNrXCIgU1NNIHBhdGggd2hlcmUgdGhlIHZhbHVlIHdpbGwgYmUgbG9va2VkIHVwIGlmIG5vdCBmb3VuZCBhdCB0aGUgYnJhbmNoLXNwZWNpZmljIHBhdGhcbiAgICAgKi9cbiAgICBzaGFyZWRQYXRoPzogc3RyaW5nO1xuICB9O1xufTtcbiJdfQ==