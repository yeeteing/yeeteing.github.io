"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Database = void 0;
const entity_1 = require("./entity");
const relationship_1 = require("./relationship");
class Database {
    static entitiesOnly(entities) {
        return new Database(entities, relationship_1.NO_RELATIONSHIPS);
    }
    constructor(entities, relationships) {
        this.idCtr = 0;
        this.schema = {
            ...entities,
            ...relationships({
                relationship: (fromKey, toKey) => (0, relationship_1.relationshipCollection)((id) => this.get(fromKey, id), (id) => this.get(toKey, id)),
            }),
        };
    }
    id() {
        return `${this.idCtr++}`;
    }
    /**
     * Allocate an ID and store
     */
    allocate(key, entity) {
        return this.store(key, this.e(entity));
    }
    /**
     * Store with a preallocated ID
     */
    store(key, entity) {
        const coll = this.schema[key];
        coll.add(entity);
        return entity;
    }
    /**
     * Get an entity by key
     */
    get(key, id) {
        const coll = this.schema[key];
        const ret = coll.entities.get(typeof id === 'string' ? id : id.$ref);
        if (!ret) {
            throw new Error(`No such ${String(key)}: ${id}`);
        }
        return ret;
    }
    /**
     * All entities of a given type
     */
    all(key) {
        const coll = this.schema[key];
        return Array.from(coll.entities.values());
    }
    /**
     * Lookup an entity by index
     */
    lookup(key, index, lookup, value) {
        const coll = this.schema[key];
        const ids = coll.indexes[index].lookups[lookup](value);
        return addOnlyMethod(ids.map((id) => coll.entities.get(id)), `${String(key)} with ${String(index)} ${String(lookup)} ${JSON.stringify(value)}`);
    }
    /**
     * Allocate an ID and store if the entity does not yet exist
     */
    findOrAllocate(key, index, lookup, entity) {
        const res = this.lookup(key, index, lookup, entity[index]);
        if (res.length) {
            return res.only();
        }
        return this.allocate(key, entity);
    }
    link(key, from, to, attributes) {
        const col = this.schema[key];
        col.add(from, to, attributes);
    }
    /**
     * Follow a link
     */
    follow(key, from) {
        var _a;
        const col = this.schema[key];
        const toLinks = (_a = col.forward.get(from.$id)) !== null && _a !== void 0 ? _a : [];
        const ret = toLinks.map((i) => ({ entity: col.toColl(i.$id), ...removeId(i) }));
        return addOnlyMethod(ret, `${String(key)} from ${from}`);
    }
    /**
     * Follow incoming links backwards
     */
    incoming(key, to) {
        var _a;
        const col = this.schema[key];
        const fromIds = (_a = col.backward.get(to.$id)) !== null && _a !== void 0 ? _a : [];
        const ret = fromIds.map((i) => ({ entity: col.fromColl(i.$id), ...removeId(i) }));
        return addOnlyMethod(ret, `${String(key)} to ${to}`);
    }
    e(entity) {
        return {
            $id: this.id(),
            ...entity,
        };
    }
    /**
     * Turn the current database collection into something that can be stored.
     */
    save() {
        return {
            idCtr: this.idCtr,
            schema: dehydrate(this.schema),
        };
        function dehydrate(x) {
            if ((0, entity_1.isEntityCollection)(x)) {
                return x.dehydrate();
            }
            if ((0, relationship_1.isRelationshipCollection)(x)) {
                return x.dehydrate();
            }
            if (Array.isArray(x)) {
                return x.map(dehydrate);
            }
            if (!!x && typeof x === 'object') {
                return Object.fromEntries(Object.entries(x).map(([k, v]) => [k, dehydrate(v)]));
            }
            return x;
        }
    }
    load(db) {
        this.idCtr = db.idCtr;
        hydrate(this.schema, db.schema);
        function hydrate(proto, x) {
            if ((0, entity_1.isEntityCollection)(proto)) {
                proto.hydrateFrom(x);
            }
            if ((0, relationship_1.isRelationshipCollection)(proto)) {
                proto.hydrateFrom(x);
            }
            if (Array.isArray(x)) {
                x.forEach(hydrate);
            }
            if (!!proto && typeof proto === 'object' && !!x && typeof x === 'object') {
                for (const [k, v] of Object.entries(proto)) {
                    hydrate(v, x[k]);
                }
            }
        }
    }
}
exports.Database = Database;
function removeId(x) {
    const ret = { ...x };
    delete ret.$id;
    return ret;
}
function addOnlyMethod(xs, description) {
    return Object.defineProperties(xs, {
        only: {
            enumerable: false,
            value: () => {
                if (xs.length !== 1) {
                    throw new Error(`Expected exactly 1 ${description}, found ${xs.length}`);
                }
                return xs[0];
            },
        },
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWJhc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZGF0YWJhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEscUNBQXVHO0FBQ3ZHLGlEQU13QjtBQVN4QixNQUFhLFFBQVE7SUFDWixNQUFNLENBQUMsWUFBWSxDQUFvQixRQUFZO1FBQ3hELE9BQU8sSUFBSSxRQUFRLENBQUMsUUFBUSxFQUFFLCtCQUFnQixDQUFDLENBQUM7SUFDbEQsQ0FBQztJQUtELFlBQVksUUFBWSxFQUFFLGFBQWtEO1FBRnBFLFVBQUssR0FBRyxDQUFDLENBQUM7UUFHaEIsSUFBSSxDQUFDLE1BQU0sR0FBRztZQUNaLEdBQUcsUUFBUTtZQUNYLEdBQUcsYUFBYSxDQUFDO2dCQUNmLFlBQVksRUFBRSxDQUFDLE9BQU8sRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUMvQixJQUFBLHFDQUFzQixFQUNwQixDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLEVBQzdCLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FDNUI7YUFDSixDQUFDO1NBQ0gsQ0FBQztJQUNKLENBQUM7SUFFTSxFQUFFO1FBQ1AsT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDO0lBQzNCLENBQUM7SUFFRDs7T0FFRztJQUNJLFFBQVEsQ0FBcUIsR0FBTSxFQUFFLE1BQWdDO1FBQzFFLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQ3pDLENBQUM7SUFFRDs7T0FFRztJQUNJLEtBQUssQ0FBcUIsR0FBTSxFQUFFLE1BQXlCO1FBQ2hFLE1BQU0sSUFBSSxHQUEwQixJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBUSxDQUFD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bnQiOlsiaW1wb3J0IHsgRW50aXR5LCBFbnRpdHlDb2xsZWN0aW9uLCBFbnRpdHlJbmRleCwgaXNFbnRpdHlDb2xsZWN0aW9uLCBQbGFpbiwgUmVmZXJlbmNlIH0gZnJvbSAnLi9lbnRpdHknO1xuaW1wb3J0IHtcbiAgaXNSZWxhdGlvbnNoaXBDb2xsZWN0aW9uLFxuICBOT19SRUxBVElPTlNISVBTLFxuICBSZWxhdGlvbnNoaXAsXG4gIHJlbGF0aW9uc2hpcENvbGxlY3Rpb24sXG4gIFJlbGF0aW9uc2hpcENvbGxlY3Rpb24sXG59IGZyb20gJy4vcmVsYXRpb25zaGlwJztcblxuZXhwb3J0IGludGVyZmFjZSBSZWxhdGlvbnNoaXBzQnVpbGRlcjxFUyBleHRlbmRzIG9iamVjdD4ge1xuICByZWxhdGlvbnNoaXA8UiBleHRlbmRzIFJlbGF0aW9uc2hpcDxhbnksIGFueSwgYW55Pj4oXG4gICAgZnJvbUtleTogS2V5c0ZvcjxFUywgRW50aXR5Q29sbGVjdGlvbjxSWydmcm9tJ10sIGFueT4+LFxuICAgIHRvS2V5OiBLZXlzRm9yPEVTLCBFbnRpdHlDb2xsZWN0aW9uPFJbJ3RvJ10sIGFueT4+LFxuICApOiBSZWxhdGlvbnNoaXBDb2xsZWN0aW9uPFI+O1xufVxuXG5leHBvcnQgY2xhc3MgRGF0YWJhc2U8RVMgZXh0ZW5kcyBvYmplY3QsIFJTIGV4dGVuZHMgb2JqZWN0PiB7XG4gIHB1YmxpYyBzdGF0aWMgZW50aXRpZXNPbmx5PEVTIGV4dGVuZHMgb2JqZWN0PihlbnRpdGllczogRVMpOiBEYXRhYmFzZTxFUywge30+IHtcbiAgICByZXR1cm4gbmV3IERhdGFiYXNlKGVudGl0aWVzLCBOT19SRUxBVElPTlNISVBTKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVhZG9ubHkgc2NoZW1hOiBFUyAmIFJTO1xuICBwcml2YXRlIGlkQ3RyID0gMDtcblxuICBjb25zdHJ1Y3RvcihlbnRpdGllczogRVMsIHJlbGF0aW9uc2hpcHM6ICh4OiBSZWxhdGlvbnNoaXBzQnVpbGRlcjxFUz4pID0+IFJTKSB7XG4gICAgdGhpcy5zY2hlbWEgPSB7XG4gICAgICAuLi5lbnRpdGllcyxcbiAgICAgIC4uLnJlbGF0aW9uc2hpcHMoe1xuICAgICAgICByZWxhdGlvbnNoaXA6IChmcm9tS2V5LCB0b0tleSkgPT5cbiAgICAgICAgICByZWxhdGlvbnNoaXBDb2xsZWN0aW9uKFxuICAgICAgICAgICAgKGlkKSA9PiB0aGlzLmdldChmcm9tS2V5LCBpZCksXG4gICAgICAgICAgICAoaWQpID0+IHRoaXMuZ2V0KHRvS2V5LCBpZCksXG4gICAgICAgICAgKSxcbiAgICAgIH0pLFxuICAgIH07XG4gIH1cblxuICBwdWJsaWMgaWQoKSB7XG4gICAgcmV0dXJuIGAke3RoaXMuaWRDdHIrK31gO1xuICB9XG5cbiAgLyoqXG4gICAqIEFsbG9jYXRlIGFuIElEIGFuZCBzdG9yZVxuICAgKi9cbiAgcHVibGljIGFsbG9jYXRlPEsgZXh0ZW5kcyBrZXlvZiBFUz4oa2V5OiBLLCBlbnRpdHk6IFBsYWluPEVudGl0eVR5cGU8RVNbS10+Pik6IEVudGl0eVR5cGU8RVNbS10+IHtcbiAgICByZXR1cm4gdGhpcy5zdG9yZShrZXksIHRoaXMuZShlbnRpdHkpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdG9yZSB3aXRoIGEgcHJlYWxsb2NhdGVkIElEXG4gICAqL1xuICBwdWJsaWMgc3RvcmU8SyBleHRlbmRzIGtleW9mIEVTPihrZXk6IEssIGVudGl0eTogRW50aXR5VHlwZTxFU1tLXT4pOiBFbnRpdHlUeXBlPEVTW0tdPiB7XG4gICAgY29uc3QgY29sbDogRW50aXR5Q29sbGVjdGlvbjxhbnk+ID0gdGhpcy5zY2hlbWFba2V5XSBhcyBhbnk7XG4gICAgY29sbC5hZGQoZW50aXR5KTtcbiAgICByZXR1cm4gZW50aXR5IGFzIGFueTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYW4gZW50aXR5IGJ5IGtleVxuICAgKi9cbiAgcHVibGljIGdldDxLIGV4dGVuZHMga2V5b2YgRVM+KGtleTogSywgaWQ6IHN0cmluZyB8IFJlZmVyZW5jZTxFbnRpdHlUeXBlPEVTW0tdPj4pOiBFbnRpdHlUeXBlPEVTW0tdPiB7XG4gICAgY29uc3QgY29sbDogRW50aXR5Q29sbGVjdGlvbjxhbnk+ID0gdGhpcy5zY2hlbWFba2V5XSBhcyBhbnk7XG4gICAgY29uc3QgcmV0ID0gY29sbC5lbnRpdGllcy5nZXQodHlwZW9mIGlkID09PSAnc3RyaW5nJyA/IGlkIDogaWQuJHJlZik7XG4gICAgaWYgKCFyZXQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgTm8gc3VjaCAke1N0cmluZyhrZXkpfTogJHtpZH1gKTtcbiAgICB9XG4gICAgcmV0dXJuIHJldDtcbiAgfVxuXG4gIC8qKlxuICAgKiBBbGwgZW50aXRpZXMgb2YgYSBnaXZlbiB0eXBlXG4gICAqL1xuICBwdWJsaWMgYWxsPEsgZXh0ZW5kcyBrZXlvZiBFUz4oa2V5OiBLKTogQXJyYXk8RW50aXR5VHlwZTxFU1tLXT4+IHtcbiAgICBjb25zdCBjb2xsOiBFbnRpdHlDb2xsZWN0aW9uPGFueT4gPSB0aGlzLnNjaGVtYVtrZXldIGFzIGFueTtcbiAgICByZXR1cm4gQXJyYXkuZnJvbShjb2xsLmVudGl0aWVzLnZhbHVlcygpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBMb29rdXAgYW4gZW50aXR5IGJ5IGluZGV4XG4gICAqL1xuICBwdWJsaWMgbG9va3VwPEsgZXh0ZW5kcyBrZXlvZiBFUywgSSBleHRlbmRzIEluZGV4TmFtZXNPZjxFU1tLXT4+KFxuICAgIGtleTogSyxcbiAgICBpbmRleDogSSxcbiAgICBsb29rdXA6IEluZGV4T2Y8RVNbS10sIEk+Wydsb29rdXBzJ10sXG4gICAgdmFsdWU6IEluZGV4T2Y8RVNbS10sIEk+Wyd2YWx1ZVR5cGUnXSxcbiAgKTogUmljaFJlYWRvbmx5QXJyYXk8RW50aXR5VHlwZTxFU1tLXT4+IHtcbiAgICBjb25zdCBjb2xsOiBFbnRpdHlDb2xsZWN0aW9uPGFueT4gPSB0aGlzLnNjaGVtYVtrZXldIGFzIGFueTtcbiAgICBjb25zdCBpZHMgPSAoY29sbC5pbmRleGVzIGFzIGFueSlbaW5kZXhdLmxvb2t1cHNbbG9va3VwXSh2YWx1ZSk7XG4gICAgcmV0dXJuIGFkZE9ubHlNZXRob2QoXG4gICAgICBpZHMubWFwKChpZDogc3RyaW5nKSA9PiBjb2xsLmVudGl0aWVzLmdldChpZCkpLFxuICAgICAgYCR7U3RyaW5nKGtleSl9IHdpdGggJHtTdHJpbmcoaW5kZXgpfSAke1N0cmluZyhsb29rdXApfSAke0pTT04uc3RyaW5naWZ5KHZhbHVlKX1gLFxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogQWxsb2NhdGUgYW4gSUQgYW5kIHN0b3JlIGlmIHRoZSBlbnRpdHkgZG9lcyBub3QgeWV0IGV4aXN0XG4gICAqL1xuICBwdWJsaWMgZmluZE9yQWxsb2NhdGU8SyBleHRlbmRzIGtleW9mIEVTLCBJIGV4dGVuZHMga2V5b2YgUGxhaW48RW50aXR5VHlwZTxFU1tLXT4+ICYgSW5kZXhOYW1lc09mPEVTW0tdPj4oXG4gICAga2V5OiBLLFxuICAgIGluZGV4OiBJLFxuICAgIGxvb2t1cDogSW5kZXhPZjxFU1tLXSwgST5bJ2xvb2t1cHMnXSxcbiAgICBlbnRpdHk6IFBsYWluPEVudGl0eVR5cGU8RVNbS10+PixcbiAgKTogRW50aXR5VHlwZTxFU1tLXT4ge1xuICAgIGNvbnN0IHJlcyA9IHRoaXMubG9va3VwKGtleSwgaW5kZXgsIGxvb2t1cCwgZW50aXR5W2luZGV4XSk7XG4gICAgaWYgKHJlcy5sZW5ndGgpIHtcbiAgICAgIHJldHVybiByZXMub25seSgpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5hbGxvY2F0ZShrZXksIGVudGl0eSk7XG4gIH1cblxuICAvKipcbiAgICogUmVjb3JkIGEgcmVsYXRpb25zaGlwIGJldHdlZW4gdHdvIGVudGl0aWVzXG4gICAqXG4gICAqIE92ZXJsb2FkIHRvIGFjY291bnQgZm9yIHdoZXRoZXIgd2UgaGF2ZSBhdHRyaWJ1dGVzIG9yIG5vdC5cbiAgICovXG4gIHB1YmxpYyBsaW5rPEsgZXh0ZW5kcyBSZWxXQXR0cnM8UlM+PihcbiAgICBrZXk6IEssXG4gICAgZnJvbTogUmVsVHlwZTxSU1tLXT5bJ2Zyb20nXSxcbiAgICB0bzogUmVsVHlwZTxSU1tLXT5bJ3RvJ10sXG4gICAgYXR0cmlidXRlczogUmVsVHlwZTxSU1tLXT5bJ2F0dHInXSxcbiAgKTogdm9pZDtcbiAgcHVibGljIGxpbms8SyBleHRlbmRzIFJlbFdvQXR0cnM8UlM+PihrZXk6IEssIGZyb206IFJlbFR5cGU8UlNbS10+Wydmcm9tJ10sIHRvOiBSZWxUeXBlPFJTW0tdPlsndG8nXSk6IHZvaWQ7XG4gIHB1YmxpYyBsaW5rPEsgZXh0ZW5kcyBrZXlvZiBSUz4oXG4gICAga2V5OiBLLFxuICAgIGZyb206IFJlbFR5cGU8UlNbS10+Wydmcm9tJ10sXG4gICAgdG86IFJlbFR5cGU8UlNbS10+Wyd0byddLFxuICAgIGF0dHJpYnV0ZXM/OiBSZWxUeXBlPFJTW0tdPlsnYXR0ciddLFxuICApIHtcbiAgICBjb25zdCBjb2w6IFJlbGF0aW9uc2hpcENvbGxlY3Rpb248YW55PiA9IHRoaXMuc2NoZW1hW2tleV0gYXMgYW55O1xuICAgIGNvbC5hZGQoZnJvbSwgdG8sIGF0dHJpYnV0ZXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIEZvbGxvdyBhIGxpbmtcbiAgICovXG4gIHB1YmxpYyBmb2xsb3c8SyBleHRlbmRzIGtleW9mIFJTPihcbiAgICBrZXk6IEssXG4gICAgZnJvbTogUmVsVHlwZTxSU1tLXT5bJ2Zyb20nXSxcbiAgKTogUmljaFJlYWRvbmx5QXJyYXk8TGluazxSZWxUeXBlPFJTW0tdPlsndG8nXSwgUmVsVHlwZTxSU1tLXT5bJ2F0dHInXT4+IHtcbiAgICBjb25zdCBjb2w6IFJlbGF0aW9uc2hpcENvbGxlY3Rpb248YW55PiA9IHRoaXMuc2NoZW1hW2tleV0gYXMgYW55O1xuICAgIGNvbnN0IHRvTGlua3MgPSBjb2wuZm9yd2FyZC5nZXQoZnJvbS4kaWQpID8/IFtdO1xuICAgIGNvbnN0IHJldCA9IHRvTGlua3MubWFwKChpKSA9PiAoeyBlbnRpdHk6IGNvbC50b0NvbGwoaS4kaWQpLCAuLi5yZW1vdmVJZChpKSB9IGFzIGFueSkpO1xuXG4gICAgcmV0dXJuIGFkZE9ubHlNZXRob2QocmV0LCBgJHtTdHJpbmcoa2V5KX0gZnJvbSAke2Zyb219YCk7XG4gIH1cblxuICAvKipcbiAgICogRm9sbG93IGluY29taW5nIGxpbmtzIGJhY2t3YXJkc1xuICAgKi9cbiAgcHVibGljIGluY29taW5nPEsgZXh0ZW5kcyBrZXlvZiBSUz4oXG4gICAga2V5OiBLLFxuICAgIHRvOiBSZWxUeXBlPFJTW0tdPlsndG8nXSxcbiAgKTogUmljaFJlYWRvbmx5QXJyYXk8TGluazxSZWxUeXBlPFJTW0tdPlsnZnJvbSddLCBSZWxUeXBlPFJTW0tdPlsnYXR0ciddPj4ge1xuICAgIGNvbnN0IGNvbDogUmVsYXRpb25zaGlwQ29sbGVjdGlvbjxhbnk+ID0gdGhpcy5zY2hlbWFba2V5XSBhcyBhbnk7XG4gICAgY29uc3QgZnJvbUlkcyA9IGNvbC5iYWNrd2FyZC5nZXQodG8uJGlkKSA/PyBbXTtcbiAgICBjb25zdCByZXQgPSBmcm9tSWRzLm1hcCgoaSkgPT4gKHsgZW50aXR5OiBjb2wuZnJvbUNvbGwoaS4kaWQpLCAuLi5yZW1vdmVJZChpKSB9IGFzIGFueSkpO1xuXG4gICAgcmV0dXJuIGFkZE9ubHlNZXRob2QocmV0LCBgJHtTdHJpbmcoa2V5KX0gdG8gJHt0b31gKTtcbiAgfVxuXG4gIHB1YmxpYyBlPEUgZXh0ZW5kcyBFbnRpdHk+KGVudGl0eTogUGxhaW48RT4pOiBFIHtcbiAgICByZXR1cm4ge1xuICAgICAgJGlkOiB0aGlzLmlkKCksXG4gICAgICAuLi5lbnRpdHksXG4gICAgfSBhcyBhbnk7XG4gIH1cblxuICAvKipcbiAgICogVHVybiB0aGUgY3VycmVudCBkYXRhYmFzZSBjb2xsZWN0aW9uIGludG8gc29tZXRoaW5nIHRoYXQgY2FuIGJlIHN0b3JlZC5cbiAgICovXG4gIHB1YmxpYyBzYXZlKCk6IERlaHlkcmF0ZWREYXRhYmFzZSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGlkQ3RyOiB0aGlzLmlkQ3RyLFxuICAgICAgc2NoZW1hOiBkZWh5ZHJhdGUodGhpcy5zY2hlbWEpLFxuICAgIH07XG5cbiAgICBmdW5jdGlvbiBkZWh5ZHJhdGUoeDogdW5rbm93bik6IGFueSB7XG4gICAgICBpZiAoaXNFbnRpdHlDb2xsZWN0aW9uKHgpKSB7XG4gICAgICAgIHJldHVybiB4LmRlaHlkcmF0ZSgpO1xuICAgICAgfVxuICAgICAgaWYgKGlzUmVsYXRpb25zaGlwQ29sbGVjdGlvbih4KSkge1xuICAgICAgICByZXR1cm4geC5kZWh5ZHJhdGUoKTtcbiAgICAgIH1cbiAgICAgIGlmIChBcnJheS5pc0FycmF5KHgpKSB7XG4gICAgICAgIHJldHVybiB4Lm1hcChkZWh5ZHJhdGUpO1xuICAgICAgfVxuICAgICAgaWYgKCEheCAmJiB0eXBlb2YgeCA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgcmV0dXJuIE9iamVjdC5mcm9tRW50cmllcyhPYmplY3QuZW50cmllcyh4KS5tYXAoKFtrLCB2XSkgPT4gW2ssIGRlaHlkcmF0ZSh2KV0pKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB4O1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBsb2FkKGRiOiBEZWh5ZHJhdGVkRGF0YWJhc2UpIHtcbiAgICB0aGlzLmlkQ3RyID0gZGIuaWRDdHI7XG4gICAgaHlkcmF0ZSh0aGlzLnNjaGVtYSwgZGIuc2NoZW1hKTtcblxuICAgIGZ1bmN0aW9uIGh5ZHJhdGUocHJvdG86IHVua25vd24sIHg6IHVua25vd24pOiB2b2lkIHtcbiAgICAgIGlmIChpc0VudGl0eUNvbGxlY3Rpb24ocHJvdG8pKSB7XG4gICAgICAgIHByb3RvLmh5ZHJhdGVGcm9tKHgpO1xuICAgICAgfVxuICAgICAgaWYgKGlzUmVsYXRpb25zaGlwQ29sbGVjdGlvbihwcm90bykpIHtcbiAgICAgICAgcHJvdG8uaHlkcmF0ZUZyb20oeCk7XG4gICAgICB9XG4gICAgICBpZiAoQXJyYXkuaXNBcnJheSh4KSkge1xuICAgICAgICB4LmZvckVhY2goaHlkcmF0ZSk7XG4gICAgICB9XG4gICAgICBpZiAoISFwcm90byAmJiB0eXBlb2YgcHJvdG8gPT09ICdvYmplY3QnICYmICEheCAmJiB0eXBlb2YgeCA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgZm9yIChjb25zdCBbaywgdl0gb2YgT2JqZWN0LmVudHJpZXMocHJvdG8pKSB7XG4gICAgICAgICAgaHlkcmF0ZSh2LCAoeCBhcyBhbnkpW2tdKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5pbnRlcmZhY2UgRGVoeWRyYXRlZERhdGFiYXNlIHtcbiAgcmVhZG9ubHkgaWRDdHI6IG51bWJlcjtcbiAgcmVhZG9ubHkgc2NoZW1hOiBhbnk7XG59XG5cbmZ1bmN0aW9uIHJlbW92ZUlkPEEgZXh0ZW5kcyBvYmplY3Q+KHg6IEEpOiBPbWl0PEEsICckaWQnPiB7XG4gIGNvbnN0IHJldCA9IHsgLi4ueCB9O1xuICBkZWxldGUgKHJldCBhcyBhbnkpLiRpZDtcbiAgcmV0dXJuIHJldDtcbn1cblxuZXhwb3J0IHR5cGUgTGluazxFLCBBPiA9IHsgcmVhZG9ubHkgZW50aXR5OiBFIH0gJiBBO1xuXG50eXBlIFJlbFdBdHRyczxSUz4gPSB7IFtLIGluIGtleW9mIFJTXToge30gZXh0ZW5kcyBSZWxUeXBlPFJTW0tdPlsnYXR0ciddID8gbmV2ZXIgOiBLIH1ba2V5b2YgUlNdO1xudHlwZSBSZWxXb0F0dHJzPFJTPiA9IHsgW0sgaW4ga2V5b2YgUlNdOiB7fSBleHRlbmRzIFJlbFR5cGU8UlNbS10+WydhdHRyJ10gPyBLIDogbmV2ZXIgfVtrZXlvZiBSU107XG5cbi8vIE5lY2Vzc2FyeSBiZWNhdXNlIHRoaXMgdHlwZSBtaWdodCBiZSBhIHVuaW9uXG50eXBlIEluZGV4TmFtZXNPZjxBPiA9IEEgZXh0ZW5kcyBFbnRpdHlDb2xsZWN0aW9uPGFueT4gPyBLZXlzT2ZVbmlvbjxBWydpbmRleGVzJ10+IDogbmV2ZXI7XG5cbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBwcmV0dGllci9wcmV0dGllclxudHlwZSBJbmRleE9mPEVDLCBJIGV4dGVuZHMgSW5kZXhOYW1lc09mPEVDPj4gPVxuICBFQyBleHRlbmRzIEVudGl0eUNvbGxlY3Rpb248YW55PlxuICA/IEVDWydpbmRleGVzJ11bSV0gZXh0ZW5kcyBFbnRpdHlJbmRleDxhbnksIGluZmVyIEluZGV4VHlwZT5cbiAgICA/IHtcbiAgICAgICAgdmFsdWVUeXBlOiBJbmRleFR5cGU7XG4gICAgICAgIGxvb2t1cHM6IGtleW9mIEVDWydpbmRleGVzJ11bSV1bJ2xvb2t1cHMnXTtcbiAgICAgIH1cbiAgICA6IG5ldmVyXG4gIDogbmV2ZXI7XG5cbnR5cGUgRW50aXR5VHlwZTxBPiA9IEEgZXh0ZW5kcyBFbnRpdHlDb2xsZWN0aW9uPGluZmVyIEI+ID8gQiA6IG5ldmVyO1xuXG50eXBlIFJlbFR5cGU8QT4gPSBBIGV4dGVuZHMgUmVsYXRpb25zaGlwQ29sbGVjdGlvbjxpbmZlciBSPiA/IFIgOiBuZXZlcjtcblxudHlwZSBSZXNvbHZlVW5pb248VD4gPSBUIGV4dGVuZHMgVCA/IFQgOiBuZXZlcjtcblxudHlwZSBLZXlzT2ZVbmlvbjxUPiA9IGtleW9mIFJlc29sdmVVbmlvbjxUPjtcblxuZXhwb3J0IHR5cGUgRW50aXRpZXNPZjxEQj4gPSBEQiBleHRlbmRzIERhdGFiYXNlPGluZmVyIEVTLCBhbnk+ID8geyBbayBpbiBrZXlvZiBFU106IEVudGl0eVR5cGU8RVNba10+IH0gOiB7fTtcblxuZXhwb3J0IGludGVyZmFjZSBSaWNoUmVhZG9ubHlBcnJheTxBPiBleHRlbmRzIFJlYWRvbmx5QXJyYXk8QT4ge1xuICAvKipcbiAgICogUmV0dXJuIHRoZSBmaXJzdCBhbmQgb25seSBlbGVtZW50LCB0aHJvd2luZyBpZiB0aGVyZSBhcmUgIT0gMSBlbGVtZW50c1xuICAgKi9cbiAgb25seSgpOiBBO1xufVxuXG5mdW5jdGlvbiBhZGRPbmx5TWV0aG9kPEE+KHhzOiBBW10sIGRlc2NyaXB0aW9uOiBzdHJpbmcpOiBSaWNoUmVhZG9ubHlBcnJheTxBPiB7XG4gIHJldHVybiBPYmplY3QuZGVmaW5lUHJvcGVydGllcyh4cywge1xuICAgIG9ubHk6IHtcbiAgICAgIGVudW1lcmFibGU6IGZhbHNlLFxuICAgICAgdmFsdWU6ICgpID0+IHtcbiAgICAgICAgaWYgKHhzLmxlbmd0aCAhPT0gMSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgZXhhY3RseSAxICR7ZGVzY3JpcHRpb259LCBmb3VuZCAke3hzLmxlbmd0aH1gKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4geHNbMF07XG4gICAgICB9LFxuICAgIH0sXG4gIH0pIGFzIGFueTtcbn1cblxuLyoqXG4gKiBSZXR1cm4gdGhlIGtleXMgb2YgYW4gb2JqZWN0IHRoYXQgbWFwIHRvIGEgcGFydGljdWxhciB0eXBlXG4gKi9cbnR5cGUgS2V5c0ZvcjxPIGV4dGVuZHMgb2JqZWN0LCBUPiA9IHsgW2sgaW4ga2V5b2YgT106IE9ba10gZXh0ZW5kcyBUID8gayA6IG5ldmVyIH1ba2V5b2YgT107XG4iXX0=