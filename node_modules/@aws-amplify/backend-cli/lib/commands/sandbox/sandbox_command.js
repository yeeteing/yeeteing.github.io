import fs from 'fs';
import fsp from 'fs/promises';
import { format, printer } from '@aws-amplify/cli-core';
import { ClientConfigFormat, ClientConfigVersionOption, DEFAULT_CLIENT_CONFIG_VERSION, generateEmptyClientConfigToFile, getClientConfigFileName, getClientConfigPath, } from '@aws-amplify/client-config';
import { ClientConfigLifecycleHandler } from '../../client-config/client_config_lifecycle_handler.js';
import { AmplifyUserError } from '@aws-amplify/platform-core';
import { EOL } from 'os';
/**
 * Command that starts sandbox.
 */
export class SandboxCommand {
    sandboxFactory;
    sandboxSubCommands;
    clientConfigGeneratorAdapter;
    commandMiddleware;
    sandboxEventHandlerCreator;
    /**
     * @inheritDoc
     */
    command;
    /**
     * @inheritDoc
     */
    describe;
    sandboxIdentifier;
    profile;
    /**
     * Creates sandbox command.
     */
    constructor(sandboxFactory, sandboxSubCommands, clientConfigGeneratorAdapter, commandMiddleware, sandboxEventHandlerCreator) {
        this.sandboxFactory = sandboxFactory;
        this.sandboxSubCommands = sandboxSubCommands;
        this.clientConfigGeneratorAdapter = clientConfigGeneratorAdapter;
        this.commandMiddleware = commandMiddleware;
        this.sandboxEventHandlerCreator = sandboxEventHandlerCreator;
        this.command = 'sandbox';
        this.describe =
            'Starts sandbox, watch mode for Amplify backend deployments';
    }
    /**
     * @inheritDoc
     */
    handler = async (args) => {
        const sandbox = await this.sandboxFactory.getInstance();
        this.sandboxIdentifier = args.identifier;
        this.profile = args.profile;
        // attaching event handlers
        const clientConfigLifecycleHandler = new ClientConfigLifecycleHandler(this.clientConfigGeneratorAdapter, args.outputsVersion, args.outputsOutDir, args.outputsFormat);
        const eventHandlers = this.sandboxEventHandlerCreator?.({
            sandboxIdentifier: this.sandboxIdentifier,
            clientConfigLifecycleHandler,
        });
        if (eventHandlers) {
            Object.entries(eventHandlers).forEach(([event, handlers]) => {
                handlers.forEach((handler) => sandbox.on(event, handler));
            });
        }
        const watchExclusions = args.exclude ?? [];
        const fileName = getClientConfigFileName(args.outputsVersion);
        const clientConfigWritePath = await getClientConfigPath(fileName, args.outputsOutDir, args.outputsFormat);
        if (!fs.existsSync(clientConfigWritePath)) {
            await generateEmptyClientConfigToFile(args.outputsVersion, args.outputsOutDir, args.outputsFormat);
        }
        watchExclusions.push(clientConfigWritePath);
        let functionStreamingOptions = {
            enabled: false,
        };
        if (args.streamFunctionLogs) {
            // turn on function logs streaming
            functionStreamingOptions = {
                enabled: true,
                logsFilters: args.logsFilter,
                logsOutFile: args.logsOutFile,
            };
            if (args.logsOutFile) {
                watchExclusions.push(args.logsOutFile);
            }
        }
        await sandbox.start({
            dir: args.dirToWatch,
            exclude: watchExclusions,
            identifier: args.identifier,
            watchForChanges: !args.once,
            functionStreamingOptions,
        });
        process.once('SIGINT', () => void this.sigIntHandler());
    };
    /**
     * @inheritDoc
     */
    builder = (yargs) => {
        return (yargs
            // Cast to erase options types used in internal sub command implementation. Otherwise, compiler fails here.
            .command(this.sandboxSubCommands)
            .version(false)
            .option('dir-to-watch', {
            describe: 'Directory to watch for file changes. All subdirectories and files will be included. Defaults to the amplify directory.',
            type: 'string',
            array: false,
            global: false,
        })
            .option('exclude', {
            describe: 'An array of paths or glob patterns to ignore. Paths can be relative or absolute and can either be files or directories',
            type: 'string',
            array: true,
            global: false,
        })
            .option('identifier', {
            describe: 'An optional identifier to distinguish between different sandboxes. Default is the name of the system user executing the process',
            type: 'string',
            array: false,
        })
            .option('outputs-format', {
            describe: 'amplify_outputs file format',
            type: 'string',
            array: false,
            choices: Object.values(ClientConfigFormat),
            global: false,
        })
            .option('outputs-version', {
            describe: 'Version of the configuration. Version 0 represents classic amplify-cli config file amplify-configuration and 1 represents newer config file amplify_outputs',
            type: 'string',
            array: false,
            choices: Object.values(ClientConfigVersionOption),
            global: false,
            default: DEFAULT_CLIENT_CONFIG_VERSION,
        })
            .option('outputs-out-dir', {
            describe: 'A path to directory where amplify_outputs is written. If not provided defaults to current process working directory.',
            type: 'string',
            array: false,
            global: false,
        })
            .option('profile', {
            describe: 'An AWS profile name.',
            type: 'string',
            array: false,
        })
            .option('once', {
            describe: 'Execute a single sandbox deployment without watching for future file changes',
            boolean: true,
            global: false,
            conflicts: [
                'exclude',
                'dir-to-watch',
                'stream-function-logs',
                'logs-filter',
                'logs-out-file',
            ],
        })
            .option('stream-function-logs', {
            describe: 'Whether to stream function execution logs. Default: false. Use --logs-filter in addition to this flag to stream specific function logs',
            boolean: true,
            global: false,
            group: 'Logs streaming',
        })
            .option('logs-filter', {
            describe: `Regex pattern to filter logs from only matched functions. E.g. to stream logs for a function, specify it's name, and to stream logs from all functions starting with auth specify 'auth' Default: Stream all logs`,
            array: true,
            global: false,
            type: 'string',
            group: 'Logs streaming',
            implies: ['stream-function-logs'],
            requiresArg: true,
        })
            .option('logs-out-file', {
            describe: 'File to append the streaming logs. The file is created if it does not exist. Default: stdout',
            array: false,
            global: false,
            type: 'string',
            group: 'Logs streaming',
            implies: ['stream-function-logs'],
            requiresArg: true,
        })
            .check(async (argv) => {
            if (argv['dir-to-watch']) {
                await this.validateDirectory('dir-to-watch', argv['dir-to-watch']);
            }
            if (argv.identifier) {
                const identifierRegex = /^[a-zA-Z0-9-]{1,15}$/;
                if (!argv.identifier.match(identifierRegex)) {
                    throw new AmplifyUserError('InvalidCommandInputError', {
                        message: `Invalid --identifier provided: ${argv.identifier}`,
                        resolution: 'Use an identifier that matches [a-zA-Z0-9-] and is less than 15 characters.',
                    });
                }
            }
            return true;
        })
            .middleware([this.commandMiddleware.ensureAwsCredentialAndRegion]));
    };
    sigIntHandler = async () => {
        printer.print(`${EOL}Stopping the sandbox process. To delete the sandbox, run ${format.normalizeAmpxCommand('sandbox delete')}`);
    };
    validateDirectory = async (option, dir) => {
        let stats;
        try {
            stats = await fsp.stat(dir, {});
        }
        catch (e) {
            throw new Error(`--${option} ${dir} does not exist`, { cause: e });
        }
        if (!stats.isDirectory()) {
            throw new Error(`--${option} ${dir} is not a valid directory`);
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2FuZGJveF9jb21tYW5kLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbW1hbmRzL3NhbmRib3gvc2FuZGJveF9jb21tYW5kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxNQUFNLElBQUksQ0FBQztBQUNwQixPQUFPLEdBQUcsTUFBTSxhQUFhLENBQUM7QUFDOUIsT0FBTyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUt4RCxPQUFPLEVBQ0wsa0JBQWtCLEVBRWxCLHlCQUF5QixFQUN6Qiw2QkFBNkIsRUFDN0IsK0JBQStCLEVBQy9CLHVCQUF1QixFQUN2QixtQkFBbUIsR0FDcEIsTUFBTSw0QkFBNEIsQ0FBQztBQUNwQyxPQUFPLEVBQUUsNEJBQTRCLEVBQUUsTUFBTSx3REFBd0QsQ0FBQztBQUt0RyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBaUN6Qjs7R0FFRztBQUNILE1BQU0sT0FBTyxjQUFjO0lBb0JOO0lBQ0E7SUFDVDtJQUNBO0lBQ1M7SUFyQm5COztPQUVHO0lBQ00sT0FBTyxDQUFTO0lBRXpCOztPQUVHO0lBQ00sUUFBUSxDQUFTO0lBRWxCLGlCQUFpQixDQUFVO0lBQzNCLE9BQU8sQ0FBVTtJQUV6Qjs7T0FFRztJQUNILFlBQ21CLGNBQXVDLEVBQ3ZDLGtCQUFtQyxFQUM1Qyw0QkFBMEQsRUFDMUQsaUJBQW9DLEVBQzNCLDBCQUF1RDtRQUp2RCxtQkFBYyxHQUFkLGNBQWMsQ0FBeUI7UUFDdkMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFpQjtRQUM1QyxpQ0FBNEIsR0FBNUIsNEJBQTRCLENBQThCO1FBQzFELHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBbUI7UUFDM0IsK0JBQTBCLEdBQTFCLDBCQUEwQixDQUE2QjtRQUV4RSxJQUFJLENBQUMs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aUIsRUFBRSxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3JFLENBQUM7UUFDRCxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxFQUFFLENBQUM7WUFDekIsTUFBTSxJQUFJLEtBQUssQ0FBQyxLQUFLLE1BQU0sSUFBSSxHQUFHLDJCQUEyQixDQUFDLENBQUM7UUFDakUsQ0FBQztJQUNILENBQUMsQ0FBQztDQUNIIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXJndW1lbnRzQ2FtZWxDYXNlLCBBcmd2LCBDb21tYW5kTW9kdWxlIH0gZnJvbSAneWFyZ3MnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBmc3AgZnJvbSAnZnMvcHJvbWlzZXMnO1xuaW1wb3J0IHsgZm9ybWF0LCBwcmludGVyIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L2NsaS1jb3JlJztcbmltcG9ydCB7XG4gIFNhbmRib3hGdW5jdGlvblN0cmVhbWluZ09wdGlvbnMsXG4gIFNhbmRib3hTaW5nbGV0b25GYWN0b3J5LFxufSBmcm9tICdAYXdzLWFtcGxpZnkvc2FuZGJveCc7XG5pbXBvcnQge1xuICBDbGllbnRDb25maWdGb3JtYXQsXG4gIENsaWVudENvbmZpZ1ZlcnNpb24sXG4gIENsaWVudENvbmZpZ1ZlcnNpb25PcHRpb24sXG4gIERFRkFVTFRfQ0xJRU5UX0NPTkZJR19WRVJTSU9OLFxuICBnZW5lcmF0ZUVtcHR5Q2xpZW50Q29uZmlnVG9GaWxlLFxuICBnZXRDbGllbnRDb25maWdGaWxlTmFtZSxcbiAgZ2V0Q2xpZW50Q29uZmlnUGF0aCxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2NsaWVudC1jb25maWcnO1xuaW1wb3J0IHsgQ2xpZW50Q29uZmlnTGlmZWN5Y2xlSGFuZGxlciB9IGZyb20gJy4uLy4uL2NsaWVudC1jb25maWcvY2xpZW50X2NvbmZpZ19saWZlY3ljbGVfaGFuZGxlci5qcyc7XG5pbXBvcnQgeyBDbGllbnRDb25maWdHZW5lcmF0b3JBZGFwdGVyIH0gZnJvbSAnLi4vLi4vY2xpZW50LWNvbmZpZy9jbGllbnRfY29uZmlnX2dlbmVyYXRvcl9hZGFwdGVyLmpzJztcbmltcG9ydCB7IENvbW1hbmRNaWRkbGV3YXJlIH0gZnJvbSAnLi4vLi4vY29tbWFuZF9taWRkbGV3YXJlLmpzJztcbmltcG9ydCB7IFNhbmRib3hDb21tYW5kR2xvYmFsT3B0aW9ucyB9IGZyb20gJy4vb3B0aW9uX3R5cGVzLmpzJztcbmltcG9ydCB7IEFyZ3VtZW50c0tlYmFiQ2FzZSB9IGZyb20gJy4uLy4uL2tlYmFiX2Nhc2UuanMnO1xuaW1wb3J0IHsgQW1wbGlmeVVzZXJFcnJvciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcbmltcG9ydCB7IEVPTCB9IGZyb20gJ29zJztcblxuZXhwb3J0IHR5cGUgU2FuZGJveENvbW1hbmRPcHRpb25zS2ViYWJDYXNlID0gQXJndW1lbnRzS2ViYWJDYXNlPFxuICB7XG4gICAgZGlyVG9XYXRjaDogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgIGV4Y2x1ZGU6IHN0cmluZ1tdIHwgdW5kZWZpbmVkO1xuICAgIG91dHB1dHNGb3JtYXQ6IENsaWVudENvbmZpZ0Zvcm1hdCB8IHVuZGVmaW5lZDtcbiAgICBvdXRwdXRzT3V0RGlyOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgb3V0cHV0c1ZlcnNpb246IHN0cmluZztcbiAgICBvbmNlOiBib29sZWFuIHwgdW5kZWZpbmVkO1xuICAgIHN0cmVhbUZ1bmN0aW9uTG9nczogYm9vbGVhbiB8IHVuZGVmaW5lZDtcbiAgICBsb2dzRmlsdGVyOiBzdHJpbmdbXSB8IHVuZGVmaW5lZDtcbiAgICBsb2dzT3V0RmlsZTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICB9ICYgU2FuZGJveENvbW1hbmRHbG9iYWxPcHRpb25zXG4+O1xuXG5leHBvcnQgdHlwZSBFdmVudEhhbmRsZXIgPSAoLi4uYXJnczogdW5rbm93bltdKSA9PiB2b2lkO1xuXG5leHBvcnQgdHlwZSBTYW5kYm94RXZlbnRIYW5kbGVycyA9IHtcbiAgc3VjY2Vzc2Z1bERlcGxveW1lbnQ6IEV2ZW50SGFuZGxlcltdO1xuICBzdWNjZXNzZnVsRGVsZXRpb246IEV2ZW50SGFuZGxlcltdO1xuICBmYWlsZWREZXBsb3ltZW50OiBFdmVudEhhbmRsZXJbXTtcbn07XG5cbmV4cG9ydCB0eXBlIFNhbmRib3hFdmVudEhhbmRsZXJQYXJhbXMgPSB7XG4gIHNhbmRib3hJZGVudGlmaWVyPzogc3RyaW5nO1xuICBjbGllbnRDb25maWdMaWZlY3ljbGVIYW5kbGVyOiBDbGllbnRDb25maWdMaWZlY3ljbGVIYW5kbGVyO1xufTtcblxuZXhwb3J0IHR5cGUgU2FuZGJveEV2ZW50SGFuZGxlckNyZWF0b3IgPSAoXG4gIHBhcmFtczogU2FuZGJveEV2ZW50SGFuZGxlclBhcmFtcyxcbikgPT4gU2FuZGJveEV2ZW50SGFuZGxlcnM7XG5cbi8qKlxuICogQ29tbWFuZCB0aGF0IHN0YXJ0cyBzYW5kYm94LlxuICovXG5leHBvcnQgY2xhc3MgU2FuZGJveENvbW1hbmRcbiAgaW1wbGVtZW50cyBDb21tYW5kTW9kdWxlPG9iamVjdCwgU2FuZGJveENvbW1hbmRPcHRpb25zS2ViYWJDYXNlPlxue1xuICAvKipcbiAgICogQGluaGVyaXREb2NcbiAgICovXG4gIHJlYWRvbmx5IGNvbW1hbmQ6IHN0cmluZztcblxuICAvKipcbiAgICogQGluaGVyaXREb2NcbiAgICovXG4gIHJlYWRvbmx5IGRlc2NyaWJlOiBzdHJpbmc7XG5cbiAgcHJpdmF0ZSBzYW5kYm94SWRlbnRpZmllcj86IHN0cmluZztcbiAgcHJpdmF0ZSBwcm9maWxlPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBDcmVhdGVzIHNhbmRib3ggY29tbWFuZC5cbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgc2FuZGJveEZhY3Rvcnk6IFNhbmRib3hTaW5nbGV0b25GYWN0b3J5LFxuICAgIHByaXZhdGUgcmVhZG9ubHkgc2FuZGJveFN1YkNvbW1hbmRzOiBDb21tYW5kTW9kdWxlW10sXG4gICAgcHJpdmF0ZSBjbGllbnRDb25maWdHZW5lcmF0b3JBZGFwdGVyOiBDbGllbnRDb25maWdHZW5lcmF0b3JBZGFwdGVyLFxuICAgIHByaXZhdGUgY29tbWFuZE1pZGRsZXdhcmU6IENvbW1hbmRNaWRkbGV3YXJlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgc2FuZGJveEV2ZW50SGFuZGxlckNyZWF0b3I/OiBTYW5kYm94RXZlbnRIYW5kbGVyQ3JlYXRvcixcbiAgKSB7XG4gICAgdGhpcy5jb21tYW5kID0gJ3NhbmRib3gnO1xuICAgIHRoaXMuZGVzY3JpYmUgPVxuICAgICAgJ1N0YXJ0cyBzYW5kYm94LCB3YXRjaCBtb2RlIGZvciBBbXBsaWZ5IGJhY2tlbmQgZGVwbG95bWVudHMnO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0RG9jXG4gICAqL1xuICBoYW5kbGVyID0gYXN5bmMgKFxuICAgIGFyZ3M6IEFyZ3VtZW50c0NhbWVsQ2FzZTxTYW5kYm94Q29tbWFuZE9wdGlvbnNLZWJhYkNhc2U+LFxuICApOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICBjb25zdCBzYW5kYm94ID0gYXdhaXQgdGhpcy5zYW5kYm94RmFjdG9yeS5nZXRJbnN0YW5jZSgpO1xuICAgIHRoaXMuc2FuZGJveElkZW50aWZpZXIgPSBhcmdzLmlkZW50aWZpZXI7XG4gICAgdGhpcy5wcm9maWxlID0gYXJncy5wcm9maWxlO1xuXG4gICAgLy8gYXR0YWNoaW5nIGV2ZW50IGhhbmRsZXJzXG4gICAgY29uc3QgY2xpZW50Q29uZmlnTGlmZWN5Y2xlSGFuZGxlciA9IG5ldyBDbGllbnRDb25maWdMaWZlY3ljbGVIYW5kbGVyKFxuICAgICAgdGhpcy5jbGllbnRDb25maWdHZW5lcmF0b3JBZGFwdGVyLFxuICAgICAgYXJncy5vdXRwdXRzVmVyc2lvbiBhcyBDbGllbnRDb25maWdWZXJzaW9uLFxuICAgICAgYXJncy5vdXRwdXRzT3V0RGlyLFxuICAgICAgYXJncy5vdXRwdXRzRm9ybWF0LFxuICAgICk7XG4gICAgY29uc3QgZXZlbnRIYW5kbGVycyA9IHRoaXMuc2FuZGJveEV2ZW50SGFuZGxlckNyZWF0b3I/Lih7XG4gICAgICBzYW5kYm94SWRlbnRpZmllcjogdGhpcy5zYW5kYm94SWRlbnRpZmllcixcbiAgICAgIGNsaWVudENvbmZpZ0xpZmVjeWNsZUhhbmRsZXIsXG4gICAgfSk7XG4gICAgaWYgKGV2ZW50SGFuZGxlcnMpIHtcbiAgICAgIE9iamVjdC5lbnRyaWVzKGV2ZW50SGFuZGxlcnMpLmZvckVhY2goKFtldmVudCwgaGFuZGxlcnNdKSA9PiB7XG4gICAgICAgIGhhbmRsZXJzLmZvckVhY2goKGhhbmRsZXIpID0+IHNhbmRib3gub24oZXZlbnQsIGhhbmRsZXIpKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICBjb25zdCB3YXRjaEV4Y2x1c2lvbnMgPSBhcmdzLmV4Y2x1ZGUgPz8gW107XG4gICAgY29uc3QgZmlsZU5hbWUgPSBnZXRDbGllbnRDb25maWdGaWxlTmFtZShcbiAgICAgIGFyZ3Mub3V0cHV0c1ZlcnNpb24gYXMgQ2xpZW50Q29uZmlnVmVyc2lvbixcbiAgICApO1xuICAgIGNvbnN0IGNsaWVudENvbmZpZ1dyaXRlUGF0aCA9IGF3YWl0IGdldENsaWVudENvbmZpZ1BhdGgoXG4gICAgICBmaWxlTmFtZSxcbiAgICAgIGFyZ3Mub3V0cHV0c091dERpcixcbiAgICAgIGFyZ3Mub3V0cHV0c0Zvcm1hdCxcbiAgICApO1xuXG4gICAgaWYgKCFmcy5leGlzdHNTeW5jKGNsaWVudENvbmZpZ1dyaXRlUGF0aCkpIHtcbiAgICAgIGF3YWl0IGdlbmVyYXRlRW1wdHlDbGllbnRDb25maWdUb0ZpbGUoXG4gICAgICAgIGFyZ3Mub3V0cHV0c1ZlcnNpb24gYXMgQ2xpZW50Q29uZmlnVmVyc2lvbixcbiAgICAgICAgYXJncy5vdXRwdXRzT3V0RGlyLFxuICAgICAgICBhcmdzLm91dHB1dHNGb3JtYXQsXG4gICAgICApO1xuICAgIH1cblxuICAgIHdhdGNoRXhjbHVzaW9ucy5wdXNoKGNsaWVudENvbmZpZ1dyaXRlUGF0aCk7XG5cbiAgICBsZXQgZnVuY3Rpb25TdHJlYW1pbmdPcHRpb25zOiBTYW5kYm94RnVuY3Rpb25TdHJlYW1pbmdPcHRpb25zID0ge1xuICAgICAgZW5hYmxlZDogZmFsc2UsXG4gICAgfTtcbiAgICBpZiAoYXJncy5zdHJlYW1GdW5jdGlvbkxvZ3MpIHtcbiAgICAgIC8vIHR1cm4gb24gZnVuY3Rpb24gbG9ncyBzdHJlYW1pbmdcbiAgICAgIGZ1bmN0aW9uU3RyZWFtaW5nT3B0aW9ucyA9IHtcbiAgICAgICAgZW5hYmxlZDogdHJ1ZSxcbiAgICAgICAgbG9nc0ZpbHRlcnM6IGFyZ3MubG9nc0ZpbHRlcixcbiAgICAgICAgbG9nc091dEZpbGU6IGFyZ3MubG9nc091dEZpbGUsXG4gICAgICB9O1xuXG4gICAgICBpZiAoYXJncy5sb2dzT3V0RmlsZSkge1xuICAgICAgICB3YXRjaEV4Y2x1c2lvbnMucHVzaChhcmdzLmxvZ3NPdXRGaWxlKTtcbiAgICAgIH1cbiAgICB9XG4gICAgYXdhaXQgc2FuZGJveC5zdGFydCh7XG4gICAgICBkaXI6IGFyZ3MuZGlyVG9XYXRjaCxcbiAgICAgIGV4Y2x1ZGU6IHdhdGNoRXhjbHVzaW9ucyxcbiAgICAgIGlkZW50aWZpZXI6IGFyZ3MuaWRlbnRpZmllcixcbiAgICAgIHdhdGNoRm9yQ2hhbmdlczogIWFyZ3Mub25jZSxcbiAgICAgIGZ1bmN0aW9uU3RyZWFtaW5nT3B0aW9ucyxcbiAgICB9KTtcbiAgICBwcm9jZXNzLm9uY2UoJ1NJR0lOVCcsICgpID0+IHZvaWQgdGhpcy5zaWdJbnRIYW5kbGVyKCkpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBAaW5oZXJpdERvY1xuICAgKi9cbiAgYnVpbGRlciA9ICh5YXJnczogQXJndik6IEFyZ3Y8U2FuZGJveENvbW1hbmRPcHRpb25zS2ViYWJDYXNlPiA9PiB7XG4gICAgcmV0dXJuIChcbiAgICAgIHlhcmdzXG4gICAgICAgIC8vIENhc3QgdG8gZXJhc2Ugb3B0aW9ucyB0eXBlcyB1c2VkIGluIGludGVybmFsIHN1YiBjb21tYW5kIGltcGxlbWVudGF0aW9uLiBPdGhlcndpc2UsIGNvbXBpbGVyIGZhaWxzIGhlcmUuXG4gICAgICAgIC5jb21tYW5kKHRoaXMuc2FuZGJveFN1YkNvbW1hbmRzKVxuICAgICAgICAudmVyc2lvbihmYWxzZSlcbiAgICAgICAgLm9wdGlvbignZGlyLXRvLXdhdGNoJywge1xuICAgICAgICAgIGRlc2NyaWJlOlxuICAgICAgICAgICAgJ0RpcmVjdG9yeSB0byB3YXRjaCBmb3IgZmlsZSBjaGFuZ2VzLiBBbGwgc3ViZGlyZWN0b3JpZXMgYW5kIGZpbGVzIHdpbGwgYmUgaW5jbHVkZWQuIERlZmF1bHRzIHRvIHRoZSBhbXBsaWZ5IGRpcmVjdG9yeS4nLFxuICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICAgIGFycmF5OiBmYWxzZSxcbiAgICAgICAgICBnbG9iYWw6IGZhbHNlLFxuICAgICAgICB9KVxuICAgICAgICAub3B0aW9uKCdleGNsdWRlJywge1xuICAgICAgICAgIGRlc2NyaWJlOlxuICAgICAgICAgICAgJ0FuIGFycmF5IG9mIHBhdGhzIG9yIGdsb2IgcGF0dGVybnMgdG8gaWdub3JlLiBQYXRocyBjYW4gYmUgcmVsYXRpdmUgb3IgYWJzb2x1dGUgYW5kIGNhbiBlaXRoZXIgYmUgZmlsZXMgb3IgZGlyZWN0b3JpZXMnLFxuICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICAgIGFycmF5OiB0cnVlLFxuICAgICAgICAgIGdsb2JhbDogZmFsc2UsXG4gICAgICAgIH0pXG4gICAgICAgIC5vcHRpb24oJ2lkZW50aWZpZXInLCB7XG4gICAgICAgICAgZGVzY3JpYmU6XG4gICAgICAgICAgICAnQW4gb3B0aW9uYWwgaWRlbnRpZmllciB0byBkaXN0aW5ndWlzaCBiZXR3ZWVuIGRpZmZlcmVudCBzYW5kYm94ZXMuIERlZmF1bHQgaXMgdGhlIG5hbWUgb2YgdGhlIHN5c3RlbSB1c2VyIGV4ZWN1dGluZyB0aGUgcHJvY2VzcycsXG4gICAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgICAgYXJyYXk6IGZhbHNlLFxuICAgICAgICB9KVxuICAgICAgICAub3B0aW9uKCdvdXRwdXRzLWZvcm1hdCcsIHtcbiAgICAgICAgICBkZXNjcmliZTogJ2FtcGxpZnlfb3V0cHV0cyBmaWxlIGZvcm1hdCcsXG4gICAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgICAgYXJyYXk6IGZhbHNlLFxuICAgICAgICAgIGNob2ljZXM6IE9iamVjdC52YWx1ZXMoQ2xpZW50Q29uZmlnRm9ybWF0KSxcbiAgICAgICAgICBnbG9iYWw6IGZhbHNlLFxuICAgICAgICB9KVxuICAgICAgICAub3B0aW9uKCdvdXRwdXRzLXZlcnNpb24nLCB7XG4gICAgICAgICAgZGVzY3JpYmU6XG4gICAgICAgICAgICAnVmVyc2lvbiBvZiB0aGUgY29uZmlndXJhdGlvbi4gVmVyc2lvbiAwIHJlcHJlc2VudHMgY2xhc3NpYyBhbXBsaWZ5LWNsaSBjb25maWcgZmlsZSBhbXBsaWZ5LWNvbmZpZ3VyYXRpb24gYW5kIDEgcmVwcmVzZW50cyBuZXdlciBjb25maWcgZmlsZSBhbXBsaWZ5X291dHB1dHMnLFxuICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICAgIGFycmF5OiBmYWxzZSxcbiAgICAgICAgICBjaG9pY2VzOiBPYmplY3QudmFsdWVzKENsaWVudENvbmZpZ1ZlcnNpb25PcHRpb24pLFxuICAgICAgICAgIGdsb2JhbDogZmFsc2UsXG4gICAgICAgICAgZGVmYXVsdDogREVGQVVMVF9DTElFTlRfQ09ORklHX1ZFUlNJT04sXG4gICAgICAgIH0pXG4gICAgICAgIC5vcHRpb24oJ291dHB1dHMtb3V0LWRpcicsIHtcbiAgICAgICAgICBkZXNjcmliZTpcbiAgICAgICAgICAgICdBIHBhdGggdG8gZGlyZWN0b3J5IHdoZXJlIGFtcGxpZnlfb3V0cHV0cyBpcyB3cml0dGVuLiBJZiBub3QgcHJvdmlkZWQgZGVmYXVsdHMgdG8gY3VycmVudCBwcm9jZXNzIHdvcmtpbmcgZGlyZWN0b3J5LicsXG4gICAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgICAgYXJyYXk6IGZhbHNlLFxuICAgICAgICAgIGdsb2JhbDogZmFsc2UsXG4gICAgICAgIH0pXG4gICAgICAgIC5vcHRpb24oJ3Byb2ZpbGUnLCB7XG4gICAgICAgICAgZGVzY3JpYmU6ICdBbiBBV1MgcHJvZmlsZSBuYW1lLicsXG4gICAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgICAgYXJyYXk6IGZhbHNlLFxuICAgICAgICB9KVxuICAgICAgICAub3B0aW9uKCdvbmNlJywge1xuICAgICAgICAgIGRlc2NyaWJlOlxuICAgICAgICAgICAgJ0V4ZWN1dGUgYSBzaW5nbGUgc2FuZGJveCBkZXBsb3ltZW50IHdpdGhvdXQgd2F0Y2hpbmcgZm9yIGZ1dHVyZSBmaWxlIGNoYW5nZXMnLFxuICAgICAgICAgIGJvb2xlYW46IHRydWUsXG4gICAgICAgICAgZ2xvYmFsOiBmYWxzZSxcbiAgICAgICAgICBjb25mbGljdHM6IFtcbiAgICAgICAgICAgICdleGNsdWRlJyxcbiAgICAgICAgICAgICdkaXItdG8td2F0Y2gnLFxuICAgICAgICAgICAgJ3N0cmVhbS1mdW5jdGlvbi1sb2dzJyxcbiAgICAgICAgICAgICdsb2dzLWZpbHRlcicsXG4gICAgICAgICAgICAnbG9ncy1vdXQtZmlsZScsXG4gICAgICAgICAgXSxcbiAgICAgICAgfSlcbiAgICAgICAgLm9wdGlvbignc3RyZWFtLWZ1bmN0aW9uLWxvZ3MnLCB7XG4gICAgICAgICAgZGVzY3JpYmU6XG4gICAgICAgICAgICAnV2hldGhlciB0byBzdHJlYW0gZnVuY3Rpb24gZXhlY3V0aW9uIGxvZ3MuIERlZmF1bHQ6IGZhbHNlLiBVc2UgLS1sb2dzLWZpbHRlciBpbiBhZGRpdGlvbiB0byB0aGlzIGZsYWcgdG8gc3RyZWFtIHNwZWNpZmljIGZ1bmN0aW9uIGxvZ3MnLFxuICAgICAgICAgIGJvb2xlYW46IHRydWUsXG4gICAgICAgICAgZ2xvYmFsOiBmYWxzZSxcbiAgICAgICAgICBncm91cDogJ0xvZ3Mgc3RyZWFtaW5nJyxcbiAgICAgICAgfSlcbiAgICAgICAgLm9wdGlvbignbG9ncy1maWx0ZXInLCB7XG4gICAgICAgICAgZGVzY3JpYmU6IGBSZWdleCBwYXR0ZXJuIHRvIGZpbHRlciBsb2dzIGZyb20gb25seSBtYXRjaGVkIGZ1bmN0aW9ucy4gRS5nLiB0byBzdHJlYW0gbG9ncyBmb3IgYSBmdW5jdGlvbiwgc3BlY2lmeSBpdCdzIG5hbWUsIGFuZCB0byBzdHJlYW0gbG9ncyBmcm9tIGFsbCBmdW5jdGlvbnMgc3RhcnRpbmcgd2l0aCBhdXRoIHNwZWNpZnkgJ2F1dGgnIERlZmF1bHQ6IFN0cmVhbSBhbGwgbG9nc2AsXG4gICAgICAgICAgYXJyYXk6IHRydWUsXG4gICAgICAgICAgZ2xvYmFsOiBmYWxzZSxcbiAgICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgICBncm91cDogJ0xvZ3Mgc3RyZWFtaW5nJyxcbiAgICAgICAgICBpbXBsaWVzOiBbJ3N0cmVhbS1mdW5jdGlvbi1sb2dzJ10sXG4gICAgICAgICAgcmVxdWlyZXNBcmc6IHRydWUsXG4gICAgICAgIH0pXG4gICAgICAgIC5vcHRpb24oJ2xvZ3Mtb3V0LWZpbGUnLCB7XG4gICAgICAgICAgZGVzY3JpYmU6XG4gICAgICAgICAgICAnRmlsZSB0byBhcHBlbmQgdGhlIHN0cmVhbWluZyBsb2dzLiBUaGUgZmlsZSBpcyBjcmVhdGVkIGlmIGl0IGRvZXMgbm90IGV4aXN0LiBEZWZhdWx0OiBzdGRvdXQnLFxuICAgICAgICAgIGFycmF5OiBmYWxzZSxcbiAgICAgICAgICBnbG9iYWw6IGZhbHNlLFxuICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICAgIGdyb3VwOiAnTG9ncyBzdHJlYW1pbmcnLFxuICAgICAgICAgIGltcGxpZXM6IFsnc3RyZWFtLWZ1bmN0aW9uLWxvZ3MnXSxcbiAgICAgICAgICByZXF1aXJlc0FyZzogdHJ1ZSxcbiAgICAgICAgfSlcbiAgICAgICAgLmNoZWNrKGFzeW5jIChhcmd2KSA9PiB7XG4gICAgICAgICAgaWYgKGFyZ3ZbJ2Rpci10by13YXRjaCddKSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnZhbGlkYXRlRGlyZWN0b3J5KCdkaXItdG8td2F0Y2gnLCBhcmd2WydkaXItdG8td2F0Y2gnXSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChhcmd2LmlkZW50aWZpZXIpIHtcbiAgICAgICAgICAgIGNvbnN0IGlkZW50aWZpZXJSZWdleCA9IC9eW2EtekEtWjAtOS1dezEsMTV9JC87XG4gICAgICAgICAgICBpZiAoIWFyZ3YuaWRlbnRpZmllci5tYXRjaChpZGVudGlmaWVyUmVnZXgpKSB7XG4gICAgICAgICAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKCdJbnZhbGlkQ29tbWFuZElucHV0RXJyb3InLCB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZTogYEludmFsaWQgLS1pZGVudGlmaWVyIHByb3ZpZGVkOiAke2FyZ3YuaWRlbnRpZmllcn1gLFxuICAgICAgICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAgICAgICAnVXNlIGFuIGlkZW50aWZpZXIgdGhhdCBtYXRjaGVzIFthLXpBLVowLTktXSBhbmQgaXMgbGVzcyB0aGFuIDE1IGNoYXJhY3RlcnMuJyxcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9KVxuICAgICAgICAubWlkZGxld2FyZShbdGhpcy5jb21tYW5kTWlkZGxld2FyZS5lbnN1cmVBd3NDcmVkZW50aWFsQW5kUmVnaW9uXSlcbiAgICApO1xuICB9O1xuXG4gIHNpZ0ludEhhbmRsZXIgPSBhc3luYyAoKSA9PiB7XG4gICAgcHJpbnRlci5wcmludChcbiAgICAgIGAke0VPTH1TdG9wcGluZyB0aGUgc2FuZGJveCBwcm9jZXNzLiBUbyBkZWxldGUgdGhlIHNhbmRib3gsIHJ1biAke2Zvcm1hdC5ub3JtYWxpemVBbXB4Q29tbWFuZChcbiAgICAgICAgJ3NhbmRib3ggZGVsZXRlJyxcbiAgICAgICl9YCxcbiAgICApO1xuICB9O1xuXG4gIHByaXZhdGUgdmFsaWRhdGVEaXJlY3RvcnkgPSBhc3luYyAob3B0aW9uOiBzdHJpbmcsIGRpcjogc3RyaW5nKSA9PiB7XG4gICAgbGV0IHN0YXRzO1xuICAgIHRyeSB7XG4gICAgICBzdGF0cyA9IGF3YWl0IGZzcC5zdGF0KGRpciwge30pO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgLS0ke29wdGlvbn0gJHtkaXJ9IGRvZXMgbm90IGV4aXN0YCwgeyBjYXVzZTogZSB9KTtcbiAgICB9XG4gICAgaWYgKCFzdGF0cy5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYC0tJHtvcHRpb259ICR7ZGlyfSBpcyBub3QgYSB2YWxpZCBkaXJlY3RvcnlgKTtcbiAgICB9XG4gIH07XG59XG4iXX0=