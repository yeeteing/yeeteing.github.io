import { WriteStream } from 'node:tty';
import { EOL } from 'os';
import ora from 'ora';
import { format } from '../format/format.js';
import stripANSI from 'strip-ansi';
/**
 * The class that pretty prints to the output stream.
 */
export class Printer {
    minimumLogLevel;
    stdout;
    stderr;
    refreshRate;
    ttyEnabled;
    currentSpinner = {};
    /**
     * Sets default configs
     */
    constructor(minimumLogLevel, stdout = process.stdout, stderr = process.stderr, refreshRate = 100, ttyEnabled = process.env.CI
        ? false
        : stdout instanceof WriteStream
            ? stdout.isTTY
            : false) {
        this.minimumLogLevel = minimumLogLevel;
        this.stdout = stdout;
        this.stderr = stderr;
        this.refreshRate = refreshRate;
        this.ttyEnabled = ttyEnabled;
    }
    /**
     * Prints a given message to output stream followed by a newline.
     * If a spinner is running, honor it and keep the spinner at the cursor running
     */
    print = (message) => {
        message = this.stringify(message);
        if (this.isSpinnerRunning()) {
            this.printWhileSpinnerRunning(message);
            return;
        }
        if (!this.ttyEnabled) {
            message = stripANSI(message);
        }
        this.stdout.write(message);
        this.printNewLine();
    };
    /**
     * Prints a new line to output stream
     */
    printNewLine = () => {
        this.stdout.write(EOL);
    };
    /**
     * Logs a message to the output stream at the given log level followed by a newline
     */
    log = (message, level = LogLevel.INFO) => {
        message = this.stringify(message);
        const doLogMessage = level <= this.minimumLogLevel;
        if (!doLogMessage) {
            return;
        }
        this.print(this.prefixedMessage(message, level));
    };
    /**
     * Logs a message with animated spinner
     * If stdout is not a TTY, the message is logged at the info level without a spinner
     */
    indicateProgress = async (message, callback, successMessage) => {
        try {
            this.startSpinner(message, { timeoutSeconds: 3600 });
            await callback();
        }
        finally {
            this.stopSpinner(successMessage);
        }
    };
    /**
     * Start a spinner for the given message.
     * If stdout is not a TTY, the message is logged at the info level without a spinner
     */
    startSpinner = (message, options = { timeoutSeconds: 60 }) => {
        if (!this.ttyEnabled) {
            // Ora prints messages with a preceding `-` in non-tty console. We avoid it
            this.log(message);
            return;
        }
        // Can only run one spinner at a time.
        if (this.isSpinnerRunning()) {
            this.stopSpinner();
        }
        this.currentSpinner = {
            instance: ora({
                text: message,
                prefixText: this.getLogPrefix(),
                color: 'white',
                stream: this.stdout,
                spinner: 'dots',
                interval: this.refreshRate,
                discardStdin: false,
                hideCursor: false,
                isEnabled: this.ttyEnabled,
            }).start(),
            timeout: setTimeout(() => {
                this.stopSpinner();
            }, options.timeoutSeconds * 1000),
        };
    };
    isSpinnerRunning = () => {
        return this.currentSpinner.instance !== undefined;
    };
    /**
     * Stop the current running spinner
     */
    stopSpinner = (successMessage) => {
        if (this.currentSpinner.instance === undefined) {
            if (!this.ttyEnabled && successMessage) {
                this.print(`${format.success('âœ”')} ${successMessage}`);
            }
            return;
        }
        if (successMessage) {
            this.currentSpinner.instance.succeed(this.prefixedMessage(successMessage));
        }
        else {
            this.currentSpinner.instance.stop();
        }
        clearTimeout(this.currentSpinner.timeout);
        this.currentSpinner = {};
    };
    /**
     * Update the current running spinner options, e.g. message or prefixText
     */
    updateSpinner = (options) => {
        if (!this.ttyEnabled) {
            // prefix texts are not displayed in non-tty console by Ora and regular messages have a preceding `-`
            options.prefixText && this.log(options.prefixText);
            options.message && this.log(options.message);
            return;
        }
        if (this.currentSpinner.instance === undefined) {
            this.log(`No running spinner found.`, LogLevel.WARN);
            // // Maybe timed out? If the message was available, we start a new one
            if (options.message) {
                this.startSpinner(options.message);
                this.updateSpinner({ prefixText: options.prefixText });
            }
            return;
        }
        if (options.prefixText) {
            this.currentSpinner.instance.prefixText =
                options.prefixText + this.getLogPrefix();
        }
        else if (options.message) {
            this.currentSpinner.instance.text = options.message;
        }
        // Refresh the timer
        this.currentSpinner.timeout?.refresh();
    };
    /**
     * Clears the console
     */
    clearConsole = () => {
        if (!this.ttyEnabled) {
            return;
        }
        const lines = process.stdout.rows;
        this.stdout.write('\n'.repeat(process.stdout.rows));
        process.stdout.moveCursor(0, -lines);
    };
    printWhileSpinnerRunning = (message) => {
        if (!this.isSpinnerRunning()) {
            return;
        }
        const spinnerMessage = this.currentSpinner.instance?.text;
        this.currentSpinner.instance?.clear();
        this.stdout.write(message);
        this.printNewLine();
        this.currentSpinner.instance?.start(spinnerMessage);
    };
    stringify = (msg) => {
        if (typeof msg === 'string') {
            return msg;
        }
        else if (msg instanceof Error) {
            return msg.message;
        }
        try {
            return JSON.stringify(msg, null, 2);
        }
        catch {
            return String(msg);
        }
    };
    getLogPrefix = (level = LogLevel.INFO) => {
        let logPrefixFormatFn = format.dim;
        if (level <= LogLevel.WARN) {
            logPrefixFormatFn = (prefix) => {
                const prefixColor = level === LogLevel.ERROR ? 'Red' : 'Yellow';
                return format.bold(format.color(`${prefix} [${LogLevel[level]}]`, prefixColor));
            };
        }
        return logPrefixFormatFn(new Date().toLocaleTimeString());
    };
    prefixedMessage = (message, level = LogLevel.INFO) => {
        return message && [LogLevel.ERROR, LogLevel.DEBUG].includes(level)
            ? `${this.getLogPrefix(level)} ${message}`
            : message
                .split(EOL)
                .map((line) => `${this.getLogPrefix(level)} ${line}`)
                .join(EOL);
    };
}
export var LogLevel;
(function (LogLevel) {
    LogLevel[LogLevel["ERROR"] = 0] = "ERROR";
    LogLevel[LogLevel["WARN"] = 1] = "WARN";
    LogLevel[LogLevel["INFO"] = 2] = "INFO";
    LogLevel[LogLevel["DEBUG"] = 3] = "DEBUG";
})(LogLevel || (LogLevel = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJpbnRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wcmludGVyL3ByaW50ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUN2QyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQ3pCLE9BQU8sR0FBWSxNQUFNLEtBQUssQ0FBQztBQUMvQixPQUFPLEVBQWEsTUFBTSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDeEQsT0FBTyxTQUFTLE1BQU0sWUFBWSxDQUFDO0FBSW5DOztHQUVHO0FBQ0gsTUFBTSxPQUFPLE9BQU87SUFNQztJQUNSO0lBQ0E7SUFDUTtJQUNSO0lBVEgsY0FBYyxHQUFpRCxFQUFFLENBQUM7SUFDMUU7O09BRUc7SUFDSCxZQUNtQixlQUF5QixFQUNqQyxTQUE4QyxPQUFPLENBQUMsTUFBTSxFQUM1RCxTQUE4QyxPQUFPLENBQUMsTUFBTSxFQUNwRCxjQUFzQixHQUFHLEVBQ2pDLGFBQWEsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1FBQ2xDLENBQUMsQ0FBQyxLQUFLO1FBQ1AsQ0FBQyxDQUFDLE1BQU0sWUFBWSxXQUFXO1lBQzdCLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSztZQUNkLENBQUMsQ0FBQyxLQUFLO1FBUk0sb0JBQWUsR0FBZixlQUFlLENBQVU7UUFDakMsV0FBTSxHQUFOLE1BQU0sQ0FBc0Q7UUFDNUQsV0FBTSxHQUFOLE1BQU0sQ0FBc0Q7UUFDcEQsZ0JBQVcsR0FBWCxXQUFXLENBQWM7UUFDakMsZUFBVSxHQUFWLFVBQVUsQ0FJUjtJQUNWLENBQUM7SUFFSjs7O09BR0c7SUFDSCxLQUFLLEdBQUcsQ0FBQyxPQUFlLEVBQUUsRUFBRTtRQUMxQixPQUFPLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNsQyxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxFQUFFLENBQUM7WUFDNUIsSUFBSSxDQUFDLHdCQUF3QixDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3ZDLE9BQU87UUFDVCxDQUFDO1FBQ0QsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUNyQixPQUFPLEdBQUcsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQy9CLENBQUM7UUFDRCxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUMzQixJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDdEIsQ0FBQyxDQUFDO0lBRUY7O09BRUc7SUFDSCxZQUFZLEdBQUcsR0FBRyxFQUFFO1FBQ2xCLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3pCLENBQUMsQ0FBQztJQUVGOztPQUVHO0lBQ0gsR0FBRyxHQUFHLENBQUMsT0FBZSxFQUFFLFFBQWtCLFFBQVEsQ0FBQyxJQUFJLEVBQUUsRUFBRTtRQUN6RCxPQUFPLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNsQyxNQUFNLFlBQVksR0FBRyxLQUFLLElBQUksSUFBSSxDQUFDLGVBQWUsQ0FBQztRQUVuRCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7WUFDbEIsT0FBTztRQUNULENBQUM7UUFFRCxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDbkQsQ0FBQyxDQUFDO0lBRUY7OztPQUdHO0lBQ0gsZ0JBQWdCLEdBQUcsS0FBSyxFQUN0QixPQUFlLEVBQ2YsUUFBNkIsRUFDN0IsY0FBdUIsRUFDdkIsRUFBRTtRQUNGLElBQUksQ0FBQztZQUNILElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxFQUFFLEVBQUUsY0FBYyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7WUFDckQsTUFBTSxRQUFRLEVBQUUsQ0FBQztRQUNuQixDQUFDO2dCQUFTLENBQUM7WUFDVCxJQUFJLENBQUMsV0FBVyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQ25DLENBQUM7SUFDSCxDQUFDLENBQUM7SUFFRjs7O09BR0c7SUFDSCxZQUFZLEdBQUcsQ0FDYixPQUFlLEVBQ2YsVUFBc0MsRUFBRSxjQUFjLEVBQUUsRUFBRSxFQUFFLEVBQ3RELEVBQUU7UUFDUixJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQ3JCLDJFQUEyRTtZQUMzRSxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ2xCLE9BQU87UUFDVCxDQUFDO1FBQ0Qsc0NBQXNDO1FBQ3RDLElBQUksSUFBSSxDQUFDLGdCQUFnQixFQUFFLEVBQUUsQ0FBQztZQUM1QixJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDckIsQ0FBQztRQUNELElBQUksQ0FBQyxjQUFjLEdBQUc7WUFDcEIsUUFBUSxFQUFFLEdBQUcsQ0FBQztnQkFDWixJQUFJLEVBQUUsT0FBTztnQkFDYixVQUFVLEVBQUUsSUFBSSxDQUFDLFlBQVksRUFBRTtnQkFDL0IsS0FBSyxFQUFFLE9BQU87Z0JBQ2QsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNO2dCQUNuQixPQUFPLEVBQUUsTUFBTTtnQkFDZixRQUFRLEVBQUUsSUFBSSxDQUFDLFdBQVc7Z0JBQzFCLFlBQVksRUFBRSxLQUFLO2dCQUNuQixVQUFVLEVBQUUsS0FBSztnQkFDakIsU0FBUyxFQUFFLElBQUksQ0FBQyxVQUFVO2FBQzNCLENBQUMsQ0FBQyxLQUFLLEVBQUU7WUFDVixPQUFPLEVBQUUsVUFBVSxDQUFDLEdBQUcsRUFBRTtnQkFDdkIsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ3JCLENBQUMsRUFBRSxPQUFPLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQztTQUNsQyxDQUFDO0lBQ0osQ0FBQyxDQUFDO0lBRUYsZ0JBQWdCLEdBQUcsR0FBWSxFQUFFO1FBQy9CLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLEtBQUssU0FBUyxDQUFDO0lBQ3BELENBQUMsQ0FBQztJQUVGOztPQUVHO0lBQ0gsV0FBVyxHQUFHLENBQUMsY0FBdUIsRUFBUSxFQUFFO1FBQzlDLElBQUksSUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLEtBQUssU0FBUyxFQUFFLENBQUM7WUFDL0MsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLElBQUksY0FBYyxFQUFFLENBQUM7Z0JBQ3ZDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLGNBQWMsRUFBRSxDQUFDLENBQUM7WUFDekQsQ0FBQztZQUNELE9BQU87UUFDVCxDQUFDO1FBQ0QsSUFBSSxjQUFjLEVBQUUsQ0FBQztZQUNuQixJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQ2xDLElBQUksQ0FBQyxlQUFlLENBQUMsY0FBYyxDQUFDLENBQ3JDLENBQUM7UUFDSixDQUFDO2FBQU0sQ0FBQztZQUNOLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3RDLENBQUM7UUFDRCxZQUFZLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUMxQyxJQUFJLENBQUMsY0FBYyxHQUFHLEVBQUUsQ0FBQztJQUMzQixDQUFDLENBQUM7SUFFRjs7T0FFRztJQUNILGFBQWEsR0FBRyxDQUFDLE9BR2hCLEVBQVEsRUFBRTtRQUNULElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDckIscUdBQXFHO1lBQ3JHLE9BQU8sQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDbkQsT0FBTyxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUM3QyxPQUFPO1FBQ1QsQ0FBQztRQUVELElBQUksSUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLEtBQUssU0FBUyxFQUFFLENBQUM7WUFDL0MsSUFBSSxDQUFDLEdBQUcsQ0FBQywyQkFBMkIsRUFBRSxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDckQsdUVBQXVFO1lBQ3ZFLElBQUksT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO2dCQUNwQixJQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztnQkFDbkMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxFQUFFLFVBQVUsRUFBRSxPQUFPLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQztZQUN6RCxDQUFDO1lBQ0QsT0FBTztRQUNULENBQUM7UUFDRCxJQUFJLE9BQU8sQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUN2QixJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxVQUFVO2dCQUNyQyxPQUFPLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUM3QyxDQUFDO2FBQU0sSUFBSSxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDM0IsSUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsSUFBSSxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUM7UUFDdEQsQ0FBQztRQUNELG9CQUFvQjtRQUNwQixJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxPQUFPLEVBQUUsQ0FBQztJQUN6QyxDQUFDLENBQUM7SUFFRjs7T0FFRztJQUNILFlBQVksR0FBRyxHQUFHLEVBQUU7UUFDbEIsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUNyQixPQUFPO1FBQ1QsQ0FBQztRQUNELE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDO1FBQ2xDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ3BELE9BQU8sQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3ZDLENBQUMsQ0FBQztJQUVNLHdCQUF3QixHQUFHLENBQUMsT0FBZSxFQUFFLEVBQUU7UUFDckQsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxFQUFFLENBQUM7WUFDN0IsT0FBTztRQUNULENBQUM7UUFDRCxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUM7UUFDMUQsSUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLEVBQUUsS0FBSyxFQUFFLENBQUM7UUFDdEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDM0IsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ3BCLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUN0RCxDQUFDLENBQUM7SUFFTSxTQUFTLEdBQUcsQ0FBQyxHQUFZLEVBQVUsRUFBRTtRQUMzQyxJQUFJLE9BQU8sR0FBRyxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQzVCLE9BQU8sR0FBRyxDQUFDO1FBQ2IsQ0FBQzthQUFNLElBQUksR0FBRyxZQUFZLEtBQUssRUFBRSxDQUFDO1lBQ2hDLE9BQU8sR0FBRyxDQUFDLE9BQU8sQ0FBQztRQUNyQixDQUFDO1FBQ0QsSUFBSSxDQUFDO1lBQ0gsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDdEMsQ0FBQztRQUFDLE1BQU0sQ0FBQztZQUNQLE9BQU8sTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3JCLENBQUM7SUFDSCxDQUFDLENBQUM7SUFFTSxZQUFZLEdBQUcsQ0FBQyxLQUFLLEdBQUcsUUFBUSxDQUFDLElBQUksRUFBRSxFQUFFO1FBQy9DLElBQUksaUJBQWlCLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQztRQUNuQyxJQUFJLEtBQUssSUFBSSxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDM0IsaUJBQWlCLEdBQUcsQ0FBQyxNQUFjLEVBQUUsRUFBRTtnQkFDckMsTUFBTSxXQUFXLEdBQ2YsS0FBSyxLQUFLLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDO2dCQUM5QyxPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQ2hCLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxNQUFNLEtBQUssUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsV0FBVyxDQUFDLENBQzVELENBQUM7WUFDSixDQUFDLENBQUM7UUFDSixDQUFDO1FBQ0QsT0FBTyxpQkFBaUIsQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDLGtCQUFrQixFQUFFLENBQUMsQ0FBQztJQUM1RCxDQUFDLENBQUM7SUFFTSxlQUFlLEdBQUcsQ0FBQyxPQUFlLEVBQUUsS0FBSyxHQUFHLFFBQVEsQ0FBQyxJQUFJLEVBQUUsRUFBRTtRQUNuRSxPQUFPLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUM7WUFDaEUsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsSUFBSSxPQUFPLEVBQUU7WUFDMUMsQ0FBQyxDQUFDLE9BQU87aUJBQ0osS0FBSyxDQUFDLEdBQUcsQ0FBQztpQkFDVixHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQztpQkFDcEQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ25CLENBQUMsQ0FBQztDQUNIO0FBRUQsTUFBTSxDQUFOLElBQVksUUFLWDtBQUxELFdBQVksUUFBUTtJQUNsQix5Q0FBUyxDQUFBO0lBQ1QsdUNBQVEsQ0FBQTtJQUNSLHVDQUFRLENBQUE7SUFDUix5Q0FBUyxDQUFBO0FBQ1gsQ0FBQyxFQUxXLFFBQVEsS0FBUixRQUFRLFFBS25CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgV3JpdGVTdHJlYW0gfSBmcm9tICdub2RlOnR0eSc7XG5pbXBvcnQgeyBFT0wgfSBmcm9tICdvcyc7XG5pbXBvcnQgb3JhLCB7IE9yYSB9IGZyb20gJ29yYSc7XG5pbXBvcnQgeyBDb2xvck5hbWUsIGZvcm1hdCB9IGZyb20gJy4uL2Zvcm1hdC9mb3JtYXQuanMnO1xuaW1wb3J0IHN0cmlwQU5TSSBmcm9tICdzdHJpcC1hbnNpJztcblxuZXhwb3J0IHR5cGUgUmVjb3JkVmFsdWUgPSBzdHJpbmcgfCBudW1iZXIgfCBzdHJpbmdbXSB8IERhdGU7XG5cbi8qKlxuICogVGhlIGNsYXNzIHRoYXQgcHJldHR5IHByaW50cyB0byB0aGUgb3V0cHV0IHN0cmVhbS5cbiAqL1xuZXhwb3J0IGNsYXNzIFByaW50ZXIge1xuICBwcml2YXRlIGN1cnJlbnRTcGlubmVyOiB7IGluc3RhbmNlPzogT3JhOyB0aW1lb3V0PzogTm9kZUpTLlRpbWVvdXQgfSA9IHt9O1xuICAvKipcbiAgICogU2V0cyBkZWZhdWx0IGNvbmZpZ3NcbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgbWluaW11bUxvZ0xldmVsOiBMb2dMZXZlbCxcbiAgICByZWFkb25seSBzdGRvdXQ6IFdyaXRlU3RyZWFtIHwgTm9kZUpTLldyaXRhYmxlU3RyZWFtID0gcHJvY2Vzcy5zdGRvdXQsXG4gICAgcmVhZG9ubHkgc3RkZXJyOiBXcml0ZVN0cmVhbSB8IE5vZGVKUy5Xcml0YWJsZVN0cmVhbSA9IHByb2Nlc3Muc3RkZXJyLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcmVmcmVzaFJhdGU6IG51bWJlciA9IDEwMCxcbiAgICByZWFkb25seSB0dHlFbmFibGVkID0gcHJvY2Vzcy5lbnYuQ0lcbiAgICAgID8gZmFsc2VcbiAgICAgIDogc3Rkb3V0IGluc3RhbmNlb2YgV3JpdGVTdHJlYW1cbiAgICAgICAgPyBzdGRvdXQuaXNUVFlcbiAgICAgICAgOiBmYWxzZSxcbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBQcmludHMgYSBnaXZlbiBtZXNzYWdlIHRvIG91dHB1dCBzdHJlYW0gZm9sbG93ZWQgYnkgYSBuZXdsaW5lLlxuICAgKiBJZiBhIHNwaW5uZXIgaXMgcnVubmluZywgaG9ub3IgaXQgYW5kIGtlZXAgdGhlIHNwaW5uZXIgYXQgdGhlIGN1cnNvciBydW5uaW5nXG4gICAqL1xuICBwcmludCA9IChtZXNzYWdlOiBzdHJpbmcpID0+IHtcbiAgICBtZXNzYWdlID0gdGhpcy5zdHJpbmdpZnkobWVzc2FnZSk7XG4gICAgaWYgKHRoaXMuaXNTcGlubmVyUnVubmluZygpKSB7XG4gICAgICB0aGlzLnByaW50V2hpbGVTcGlubmVyUnVubmluZyhtZXNzYWdlKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKCF0aGlzLnR0eUVuYWJsZWQpIHtcbiAgICAgIG1lc3NhZ2UgPSBzdHJpcEFOU0kobWVzc2FnZSk7XG4gICAgfVxuICAgIHRoaXMuc3Rkb3V0LndyaXRlKG1lc3NhZ2UpO1xuICAgIHRoaXMucHJpbnROZXdMaW5lKCk7XG4gIH07XG5cbiAgLyoqXG4gICAqIFByaW50cyBhIG5ldyBsaW5lIHRvIG91dHB1dCBzdHJlYW1cbiAgICovXG4gIHByaW50TmV3TGluZSA9ICgpID0+IHtcbiAgICB0aGlzLnN0ZG91dC53cml0ZShFT0wpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBMb2dzIGEgbWVzc2FnZSB0byB0aGUgb3V0cHV0IHN0cmVhbSBhdCB0aGUgZ2l2ZW4gbG9nIGxldmVsIGZvbGxvd2VkIGJ5IGEgbmV3bGluZVxuICAgKi9cbiAgbG9nID0gKG1lc3NhZ2U6IHN0cmluZywgbGV2ZWw6IExvZ0xldmVsID0gTG9nTGV2ZWwuSU5GTykgPT4ge1xuICAgIG1lc3NhZ2UgPSB0aGlzLnN0cmluZ2lmeShtZXNzYWdlKTtcbiAgICBjb25zdCBkb0xvZ01lc3NhZ2UgPSBsZXZlbCA8PSB0aGlzLm1pbmltdW1Mb2dMZXZlbDtcblxuICAgIGlmICghZG9Mb2dNZXNzYWdlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5wcmludCh0aGlzLnByZWZpeGVkTWVzc2FnZShtZXNzYWdlLCBsZXZlbCkpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBMb2dzIGEgbWVzc2FnZSB3aXRoIGFuaW1hdGVkIHNwaW5uZXJcbiAgICogSWYgc3Rkb3V0IGlzIG5vdCBhIFRUWSwgdGhlIG1lc3NhZ2UgaXMgbG9nZ2VkIGF0IHRoZSBpbmZvIGxldmVsIHdpdGhvdXQgYSBzcGlubmVyXG4gICAqL1xuICBpbmRpY2F0ZVByb2dyZXNzID0gYXN5bmMgKFxuICAgIG1lc3NhZ2U6IHN0cmluZyxcbiAgICBjYWxsYmFjazogKCkgPT4gUHJvbWlzZTx2b2lkPixcbiAgICBzdWNjZXNzTWVzc2FnZT86IHN0cmluZyxcbiAgKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMuc3RhcnRTcGlubmVyKG1lc3NhZ2UsIHsgdGltZW91dFNlY29uZHM6IDM2MDAgfSk7XG4gICAgICBhd2FpdCBjYWxsYmFjaygpO1xuICAgIH0gZmluYWxseSB7XG4gICAgICB0aGlzLnN0b3BTcGlubmVyKHN1Y2Nlc3NNZXNzYWdlKTtcbiAgICB9XG4gIH07XG5cbiAgLyoqXG4gICAqIFN0YXJ0IGEgc3Bpbm5lciBmb3IgdGhlIGdpdmVuIG1lc3NhZ2UuXG4gICAqIElmIHN0ZG91dCBpcyBub3QgYSBUVFksIHRoZSBtZXNzYWdlIGlzIGxvZ2dlZCBhdCB0aGUgaW5mbyBsZXZlbCB3aXRob3V0IGEgc3Bpbm5lclxuICAgKi9cbiAgc3RhcnRTcGlubmVyID0gKFxuICAgIG1lc3NhZ2U6IHN0cmluZyxcbiAgICBvcHRpb25zOiB7IHRpbWVvdXRTZWNvbmRzOiBudW1iZXIgfSA9IHsgdGltZW91dFNlY29uZHM6IDYwIH0sXG4gICk6IHZvaWQgPT4ge1xuICAgIGlmICghdGhpcy50dHlFbmFibGVkKSB7XG4gICAgICAvLyBPcmEgcHJpbnRzIG1lc3NhZ2VzIHdpdGggYSBwcmVjZWRpbmcgYC1gIGluIG5vbi10dHkgY29uc29sZS4gV2UgYXZvaWQgaXRcbiAgICAgIHRoaXMubG9nKG1lc3NhZ2UpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICAvLyBDYW4gb25seSBydW4gb25lIHNwaW5uZXIgYXQgYSB0aW1lLlxuICAgIGlmICh0aGlzLmlzU3Bpbm5lclJ1bm5pbmcoKSkge1xuICAgICAgdGhpcy5zdG9wU3Bpbm5lcigpO1xuICAgIH1cbiAgICB0aGlzLmN1cnJlbnRTcGlubmVyID0ge1xuICAgICAgaW5zdGFuY2U6IG9yYSh7XG4gICAgICAgIHRleHQ6IG1lc3NhZ2UsXG4gICAgICAgIHByZWZpeFRleHQ6IHRoaXMuZ2V0TG9nUHJlZml4KCksXG4gICAgICAgIGNvbG9yOiAnd2hpdGUnLFxuICAgICAgICBzdHJlYW06IHRoaXMuc3Rkb3V0LFxuICAgICAgICBzcGlubmVyOiAnZG90cycsXG4gICAgICAgIGludGVydmFsOiB0aGlzLnJlZnJlc2hSYXRlLFxuICAgICAgICBkaXNjYXJkU3RkaW46IGZhbHNlLFxuICAgICAgICBoaWRlQ3Vyc29yOiBmYWxzZSxcbiAgICAgICAgaXNFbmFibGVkOiB0aGlzLnR0eUVuYWJsZWQsXG4gICAgICB9KS5zdGFydCgpLFxuICAgICAgdGltZW91dDogc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHRoaXMuc3RvcFNwaW5uZXIoKTtcbiAgICAgIH0sIG9wdGlvbnMudGltZW91dFNlY29uZHMgKiAxMDAwKSxcbiAgICB9O1xuICB9O1xuXG4gIGlzU3Bpbm5lclJ1bm5pbmcgPSAoKTogYm9vbGVhbiA9PiB7XG4gICAgcmV0dXJuIHRoaXMuY3VycmVudFNwaW5uZXIuaW5zdGFuY2UgIT09IHVuZGVmaW5lZDtcbiAgfTtcblxuICAvKipcbiAgICogU3RvcCB0aGUgY3VycmVudCBydW5uaW5nIHNwaW5uZXJcbiAgICovXG4gIHN0b3BTcGlubmVyID0gKHN1Y2Nlc3NNZXNzYWdlPzogc3RyaW5nKTogdm9pZCA9PiB7XG4gICAgaWYgKHRoaXMuY3VycmVudFNwaW5uZXIuaW5zdGFuY2UgPT09IHVuZGVmaW5lZCkge1xuICAgICAgaWYgKCF0aGlzLnR0eUVuYWJsZWQgJiYgc3VjY2Vzc01lc3NhZ2UpIHtcbiAgICAgICAgdGhpcy5wcmludChgJHtmb3JtYXQuc3VjY2Vzcygn4pyUJyl9ICR7c3VjY2Vzc01lc3NhZ2V9YCk7XG4gICAgICB9XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChzdWNjZXNzTWVzc2FnZSkge1xuICAgICAgdGhpcy5jdXJyZW50U3Bpbm5lci5pbnN0YW5jZS5zdWNjZWVkKFxuICAgICAgICB0aGlzLnByZWZpeGVkTWVzc2FnZShzdWNjZXNzTWVzc2FnZSksXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmN1cnJlbnRTcGlubmVyLmluc3RhbmNlLnN0b3AoKTtcbiAgICB9XG4gICAgY2xlYXJUaW1lb3V0KHRoaXMuY3VycmVudFNwaW5uZXIudGltZW91dCk7XG4gICAgdGhpcy5jdXJyZW50U3Bpbm5lciA9IHt9O1xuICB9O1xuXG4gIC8qKlxuICAgKiBVcGRhdGUgdGhlIGN1cnJlbnQgcnVubmluZyBzcGlubmVyIG9wdGlvbnMsIGUuZy4gbWVzc2FnZSBvciBwcmVmaXhUZXh0XG4gICAqL1xuICB1cGRhdGVTcGlubmVyID0gKG9wdGlvbnM6IHtcbiAgICBtZXNzYWdlPzogc3RyaW5nO1xuICAgIHByZWZpeFRleHQ/OiBzdHJpbmc7XG4gIH0pOiB2b2lkID0+IHtcbiAgICBpZiAoIXRoaXMudHR5RW5hYmxlZCkge1xuICAgICAgLy8gcHJlZml4IHRleHRzIGFyZSBub3QgZGlzcGxheWVkIGluIG5vbi10dHkgY29uc29sZSBieSBPcmEgYW5kIHJlZ3VsYXIgbWVzc2FnZXMgaGF2ZSBhIHByZWNlZGluZyBgLWBcbiAgICAgIG9wdGlvbnMucHJlZml4VGV4dCAmJiB0aGlzLmxvZyhvcHRpb25zLnByZWZpeFRleHQpO1xuICAgICAgb3B0aW9ucy5tZXNzYWdlICYmIHRoaXMubG9nKG9wdGlvbnMubWVzc2FnZSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuY3VycmVudFNwaW5uZXIuaW5zdGFuY2UgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5sb2coYE5vIHJ1bm5pbmcgc3Bpbm5lciBmb3VuZC5gLCBMb2dMZXZlbC5XQVJOKTtcbiAgICAgIC8vIC8vIE1heWJlIHRpbWVkIG91dD8gSWYgdGhlIG1lc3NhZ2Ugd2FzIGF2YWlsYWJsZSwgd2Ugc3RhcnQgYSBuZXcgb25lXG4gICAgICBpZiAob3B0aW9ucy5tZXNzYWdlKSB7XG4gICAgICAgIHRoaXMuc3RhcnRTcGlubmVyKG9wdGlvbnMubWVzc2FnZSk7XG4gICAgICAgIHRoaXMudXBkYXRlU3Bpbm5lcih7IHByZWZpeFRleHQ6IG9wdGlvbnMucHJlZml4VGV4dCB9KTtcbiAgICAgIH1cbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKG9wdGlvbnMucHJlZml4VGV4dCkge1xuICAgICAgdGhpcy5jdXJyZW50U3Bpbm5lci5pbnN0YW5jZS5wcmVmaXhUZXh0ID1cbiAgICAgICAgb3B0aW9ucy5wcmVmaXhUZXh0ICsgdGhpcy5nZXRMb2dQcmVmaXgoKTtcbiAgICB9IGVsc2UgaWYgKG9wdGlvbnMubWVzc2FnZSkge1xuICAgICAgdGhpcy5jdXJyZW50U3Bpbm5lci5pbnN0YW5jZS50ZXh0ID0gb3B0aW9ucy5tZXNzYWdlO1xuICAgIH1cbiAgICAvLyBSZWZyZXNoIHRoZSB0aW1lclxuICAgIHRoaXMuY3VycmVudFNwaW5uZXIudGltZW91dD8ucmVmcmVzaCgpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBDbGVhcnMgdGhlIGNvbnNvbGVcbiAgICovXG4gIGNsZWFyQ29uc29sZSA9ICgpID0+IHtcbiAgICBpZiAoIXRoaXMudHR5RW5hYmxlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBsaW5lcyA9IHByb2Nlc3Muc3Rkb3V0LnJvd3M7XG4gICAgdGhpcy5zdGRvdXQud3JpdGUoJ1xcbicucmVwZWF0KHByb2Nlc3Muc3Rkb3V0LnJvd3MpKTtcbiAgICBwcm9jZXNzLnN0ZG91dC5tb3ZlQ3Vyc29yKDAsIC1saW5lcyk7XG4gIH07XG5cbiAgcHJpdmF0ZSBwcmludFdoaWxlU3Bpbm5lclJ1bm5pbmcgPSAobWVzc2FnZTogc3RyaW5nKSA9PiB7XG4gICAgaWYgKCF0aGlzLmlzU3Bpbm5lclJ1bm5pbmcoKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBzcGlubmVyTWVzc2FnZSA9IHRoaXMuY3VycmVudFNwaW5uZXIuaW5zdGFuY2U/LnRleHQ7XG4gICAgdGhpcy5jdXJyZW50U3Bpbm5lci5pbnN0YW5jZT8uY2xlYXIoKTtcbiAgICB0aGlzLnN0ZG91dC53cml0ZShtZXNzYWdlKTtcbiAgICB0aGlzLnByaW50TmV3TGluZSgpO1xuICAgIHRoaXMuY3VycmVudFNwaW5uZXIuaW5zdGFuY2U/LnN0YXJ0KHNwaW5uZXJNZXNzYWdlKTtcbiAgfTtcblxuICBwcml2YXRlIHN0cmluZ2lmeSA9IChtc2c6IHVua25vd24pOiBzdHJpbmcgPT4ge1xuICAgIGlmICh0eXBlb2YgbXNnID09PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuIG1zZztcbiAgICB9IGVsc2UgaWYgKG1zZyBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgICByZXR1cm4gbXNnLm1lc3NhZ2U7XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkobXNnLCBudWxsLCAyKTtcbiAgICB9IGNhdGNoIHtcbiAgICAgIHJldHVybiBTdHJpbmcobXNnKTtcbiAgICB9XG4gIH07XG5cbiAgcHJpdmF0ZSBnZXRMb2dQcmVmaXggPSAobGV2ZWwgPSBMb2dMZXZlbC5JTkZPKSA9PiB7XG4gICAgbGV0IGxvZ1ByZWZpeEZvcm1hdEZuID0gZm9ybWF0LmRpbTtcbiAgICBpZiAobGV2ZWwgPD0gTG9nTGV2ZWwuV0FSTikge1xuICAgICAgbG9nUHJlZml4Rm9ybWF0Rm4gPSAocHJlZml4OiBzdHJpbmcpID0+IHtcbiAgICAgICAgY29uc3QgcHJlZml4Q29sb3I6IENvbG9yTmFtZSA9XG4gICAgICAgICAgbGV2ZWwgPT09IExvZ0xldmVsLkVSUk9SID8gJ1JlZCcgOiAnWWVsbG93JztcbiAgICAgICAgcmV0dXJuIGZvcm1hdC5ib2xkKFxuICAgICAgICAgIGZvcm1hdC5jb2xvcihgJHtwcmVmaXh9IFske0xvZ0xldmVsW2xldmVsXX1dYCwgcHJlZml4Q29sb3IpLFxuICAgICAgICApO1xuICAgICAgfTtcbiAgICB9XG4gICAgcmV0dXJuIGxvZ1ByZWZpeEZvcm1hdEZuKG5ldyBEYXRlKCkudG9Mb2NhbGVUaW1lU3RyaW5nKCkpO1xuICB9O1xuXG4gIHByaXZhdGUgcHJlZml4ZWRNZXNzYWdlID0gKG1lc3NhZ2U6IHN0cmluZywgbGV2ZWwgPSBMb2dMZXZlbC5JTkZPKSA9PiB7XG4gICAgcmV0dXJuIG1lc3NhZ2UgJiYgW0xvZ0xldmVsLkVSUk9SLCBMb2dMZXZlbC5ERUJVR10uaW5jbHVkZXMobGV2ZWwpXG4gICAgICA/IGAke3RoaXMuZ2V0TG9nUHJlZml4KGxldmVsKX0gJHttZXNzYWdlfWBcbiAgICAgIDogbWVzc2FnZVxuICAgICAgICAgIC5zcGxpdChFT0wpXG4gICAgICAgICAgLm1hcCgobGluZSkgPT4gYCR7dGhpcy5nZXRMb2dQcmVmaXgobGV2ZWwpfSAke2xpbmV9YClcbiAgICAgICAgICAuam9pbihFT0wpO1xuICB9O1xufVxuXG5leHBvcnQgZW51bSBMb2dMZXZlbCB7XG4gIEVSUk9SID0gMCxcbiAgV0FSTiA9IDEsXG4gIElORk8gPSAyLFxuICBERUJVRyA9IDMsXG59XG4iXX0=