"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DriftFormatter = void 0;
const node_util_1 = require("node:util");
const cxschema = require("@aws-cdk/cloud-assembly-schema");
const cloudformation_diff_1 = require("@aws-cdk/cloudformation-diff");
const client_cloudformation_1 = require("@aws-sdk/client-cloudformation");
const chalk = require("chalk");
/**
 * Class for formatting drift detection output
 */
class DriftFormatter {
    stackName;
    stack;
    resourceDriftResults;
    allStackResources;
    constructor(props) {
        this.stack = props.stack;
        this.stackName = props.stack.displayName ?? props.stack.stackName;
        this.resourceDriftResults = props.resourceDrifts;
        this.allStackResources = new Map();
        Object.keys(this.stack.template.Resources || {}).forEach(id => {
            const resource = this.stack.template.Resources[id];
            // always ignore the metadata resource
            if (resource.Type === 'AWS::CDK::Metadata') {
                return;
            }
            this.allStackResources.set(id, resource.Type);
        });
    }
    /**
     * Format the stack drift detection results
     */
    formatStackDrift() {
        const formatterOutput = this.formatStackDriftChanges(this.buildLogicalToPathMap());
        // we are only interested in actual drifts and always ignore the metadata resource
        const actualDrifts = this.resourceDriftResults.filter(d => d.StackResourceDriftStatus === 'MODIFIED' ||
            d.StackResourceDriftStatus === 'DELETED' ||
            d.ResourceType === 'AWS::CDK::Metadata');
        // must output the stack name if there are drifts
        const stackHeader = (0, node_util_1.format)(`Stack ${chalk.bold(this.stackName)}\n`);
        if (actualDrifts.length === 0) {
            const finalResult = chalk.green('No drift detected\n');
            return {
                numResourcesWithDrift: 0,
                numResourcesUnchecked: this.allStackResources.size - this.resourceDriftResults.length,
                stackHeader,
                summary: finalResult,
            };
        }
        const finalResult = chalk.yellow(`\n${actualDrifts.length} resource${actualDrifts.length === 1 ? '' : 's'} ${actualDrifts.length === 1 ? 'has' : 'have'} drifted from their expected configuration\n`);
        return {
            numResourcesWithDrift: actualDrifts.length,
            numResourcesUnchecked: this.allStackResources.size - this.resourceDriftResults.length,
            stackHeader,
            unchanged: formatterOutput.unchanged,
            unchecked: formatterOutput.unchecked,
            modified: formatterOutput.modified,
            deleted: formatterOutput.deleted,
            summary: finalResult,
        };
    }
    buildLogicalToPathMap() {
        const map = {};
        for (const md of this.stack.findMetadataByType(cxschema.ArtifactMetadataEntryType.LOGICAL_ID)) {
            map[md.data] = md.path;
        }
        return map;
    }
    /**
     * Renders stack drift information to the given stream
     *
     * @param driftResults - The stack resource drifts from CloudFormation
     * @param allStackResources - A map of all stack resources
     * @param verbose - Whether to output more verbose text (include undrifted resources)
     * @param logicalToPathMap - A map from logical ID to construct path
     */
    formatStackDriftChanges(logicalToPathMap = {}) {
        if (this.resourceDriftResults.length === 0) {
            return {};
        }
        let unchanged;
        let unchecked;
        let modified;
        let deleted;
        const drifts = this.resourceDriftResults;
        // Process unchanged resources
        const unchangedResources = drifts.filter(d => d.StackResourceDriftStatus === client_cloudformation_1.StackResourceDriftStatus.IN_SYNC);
        if (unchangedResources.length > 0) {
            unchanged = this.printSectionHeader('Resources In Sync');
            for (const drift of unchangedResources) {
                if (!drift.LogicalResourceId || !drift.ResourceType)
                    continue;
                unchanged += `${CONTEXT} ${this.formatValue(drift.ResourceType, chalk.cyan)} ${this.formatLogicalId(logicalToPathMap, drift.LogicalResourceId)}\n`;
            }
            unchanged += this.printSectionFooter();
        }
        // Process all unchecked resources
        if (this.allStackResources) {
            const uncheckedResources = Array.from(this.allStackResources.keys()).filter((logicalId) => {
                return !drifts.find((drift) => drift.LogicalResourceId === logicalId);
            });
            if (uncheckedResources.length > 0) {
                unchecked = this.printSectionHeader('Unchecked Resources');
                for (const logicalId of uncheckedResources) {
                    const resourceType = this.allStackResources.get(logicalId);
                    unchecked += `${CONTEXT} ${this.formatValue(resourceType, chalk.cyan)} ${this.formatLogicalId(logicalToPathMap, logicalId)}\n`;
                }
                unchecked += this.printSectionFooter();
            }
        }
        // Process modified resources
        const modifiedResources = drifts.filter(d => d.StackResourceDriftStatus === client_cloudformation_1.StackResourceDriftStatus.MODIFIED);
        if (modifiedResources.length > 0) {
            modified = this.printSectionHeader('Modified Resources');
            for (const drift of modifiedResources) {
                if (!drift.LogicalResourceId || !drift.ResourceType)
                    continue;
                if (modified === undefined)
                    modified = '';
                modified += `${UPDATE} ${this.formatValue(drift.ResourceType, chalk.cyan)} ${this.formatLogicalId(logicalToPathMap, drift.LogicalResourceId)}\n`;
                if (drift.PropertyDifferences) {
                    const propDiffs = drift.PropertyDifferences;
                    for (let i = 0; i < propDiffs.length; i++) {
                        const diff = propDiffs[i];
                        if (!diff.PropertyPath)
                            continue;
                        const difference = new cloudformation_diff_1.Difference(diff.ExpectedValue, diff.ActualValue);
                        modified += this.formatTreeDiff(diff.PropertyPath, difference, i === propDiffs.length - 1);
                    }
                }
            }
            modified += this.printSectionFooter();
        }
        // Process deleted resources
        const deletedResources = drifts.filter(d => d.StackResourceDriftStatus === client_cloudformation_1.StackResourceDriftStatus.DELETED);
        if (deletedResources.length > 0) {
            deleted = this.printSectionHeader('Deleted Resources');
            for (const drift of deletedResources) {
                if (!drift.LogicalResourceId || !drift.ResourceType)
                    continue;
                deleted += `${REMOVAL} ${this.formatValue(drift.ResourceType, chalk.cyan)} ${this.formatLogicalId(logicalToPathMap, drift.LogicalResourceId)}\n`;
            }
            deleted += this.printSectionFooter();
        }
        return { unchanged, unchecked, modified, deleted };
    }
    formatLogicalId(logicalToPathMap, logicalId) {
        const path = logicalToPathMap[logicalId];
        if (!path)
            return logicalId;
        let normalizedPath = path;
        if (normalizedPath.startsWith('/')) {
            normalizedPath = normalizedPath.slice(1);
        }
        let parts = normalizedPath.split('/');
        if (parts.length > 1) {
            parts = parts.slice(1);
            // remove the last component if it's "Resource" or "Default" (if we have more than a single component)
            if (parts.length > 1) {
                const last = parts[parts.length - 1];
                if (last === 'Resource' || last === 'Default') {
                    parts = parts.slice(0, parts.length - 1);
                }
            }
            normalizedPath = parts.join('/');
        }
        return `${normalizedPath} ${chalk.gray(logicalId)}`;
    }
    formatValue(value, colorFn) {
        if (value == null) {
            return '';
        }
        if (typeof value === 'string') {
            return colorFn(value);
        }
        return colorFn(JSON.stringify(value));
    }
    printSectionHeader(title) {
        return `${chalk.underline(chalk.bold(title))}\n`;
    }
    printSectionFooter() {
        return '\n';
    }
    formatTreeDiff(propertyPath, difference, isLast) {
        let result = (0, node_util_1.format)(' %s─ %s %s\n', isLast ? '└' : '├', difference.isAddition ? ADDITION :
            difference.isRemoval ? REMOVAL :
                UPDATE, propertyPath);
        if (difference.isUpdate) {
            result += (0, node_util_1.format)('     ├─ %s %s\n', REMOVAL, this.formatValue(difference.oldValue, chalk.red));
            result += (0, node_util_1.format)('     └─ %s %s\n', ADDITION, this.formatValue(difference.newValue, chalk.green));
        }
        return result;
    }
}
exports.DriftFormatter = DriftFormatter;
const ADDITION = chalk.green('[+]');
const CONTEXT = chalk.grey('[ ]');
const UPDATE = chalk.yellow('[~]');
const REMOVAL = chalk.red('[-]');
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJpZnQtZm9ybWF0dGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZHJpZnQtZm9ybWF0dGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHlDQUFtQztBQUNuQywyREFBMkQ7QUFDM0Qsc0VBQTBEO0FBRzFELDBFQUEwRTtBQUMxRSwrQkFBK0I7QUE4RC9COztHQUVHO0FBQ0gsTUFBYSxjQUFjO0lBQ1QsU0FBUyxDQUFTO0lBRWpCLEtBQUssQ0FBb0M7SUFDekMsb0JBQW9CLENBQXVCO0lBQzNDLGlCQUFpQixDQUFzQjtJQUV4RCxZQUFZLEtBQTBCO1FBQ3BDLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQztRQUN6QixJQUFJLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsV0FBVyxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDO1FBQ2xFLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxLQUFLLENBQUMsY0FBYyxDQUFDO1FBRWpELElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLEdBQUcsRUFBa0IsQ0FBQztRQUNuRCxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLFNBQVMsSUFBSSxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEVBQUU7WUFDNUQsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ25ELHNDQUFzQztZQUN0QyxJQUFJLFFBQVEsQ0FBQyxJQUFJLEtBQUssb0JBQW9CLEVBQUUsQ0FBQztnQkFDM0MsT0FBTztZQUNULENBQUM7WUFDRCxJQUFJLENBQUMsaUJBQWlCLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDaEQsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQ7O09B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LElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUMvRixNQUFNLElBQUksSUFBQSxrQkFBTSxFQUFDLGlCQUFpQixFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxRQUFRLEVBQUUsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDcEcsQ0FBQztRQUNELE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7Q0FDRjtBQXBORCx3Q0FvTkM7QUFFRCxNQUFNLFFBQVEsR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ3BDLE1BQU0sT0FBTyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDbEMsTUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUNuQyxNQUFNLE9BQU8sR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZm9ybWF0IH0gZnJvbSAnbm9kZTp1dGlsJztcbmltcG9ydCAqIGFzIGN4c2NoZW1hIGZyb20gJ0Bhd3MtY2RrL2Nsb3VkLWFzc2VtYmx5LXNjaGVtYSc7XG5pbXBvcnQgeyBEaWZmZXJlbmNlIH0gZnJvbSAnQGF3cy1jZGsvY2xvdWRmb3JtYXRpb24tZGlmZic7XG5pbXBvcnQgdHlwZSAqIGFzIGN4YXBpIGZyb20gJ0Bhd3MtY2RrL2N4LWFwaSc7XG5pbXBvcnQgdHlwZSB7IFN0YWNrUmVzb3VyY2VEcmlmdCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1jbG91ZGZvcm1hdGlvbic7XG5pbXBvcnQgeyBTdGFja1Jlc291cmNlRHJpZnRTdGF0dXMgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtY2xvdWRmb3JtYXRpb24nO1xuaW1wb3J0ICogYXMgY2hhbGsgZnJvbSAnY2hhbGsnO1xuaW1wb3J0IHR5cGUgeyBGb3JtYXR0ZWREcmlmdCB9IGZyb20gJy4uLy4uL2FjdGlvbnMvZHJpZnQnO1xuXG4vKipcbiAqIFByb3BzIGZvciB0aGUgRHJpZnQgRm9ybWF0dGVyXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRHJpZnRGb3JtYXR0ZXJQcm9wcyB7XG4gIC8qKlxuICAgKiBUaGUgQ2xvdWRGb3JtYXRpb24gc3RhY2sgYXJ0aWZhY3RcbiAgICovXG4gIHJlYWRvbmx5IHN0YWNrOiBjeGFwaS5DbG91ZEZvcm1hdGlvblN0YWNrQXJ0aWZhY3Q7XG5cbiAgLyoqXG4gICAqIFRoZSByZXN1bHRzIG9mIHN0YWNrIGRyaWZ0IGRldGVjdGlvblxuICAgKi9cbiAgcmVhZG9ubHkgcmVzb3VyY2VEcmlmdHM6IFN0YWNrUmVzb3VyY2VEcmlmdFtdO1xufVxuXG5pbnRlcmZhY2UgRHJpZnRGb3JtYXR0ZXJPdXRwdXQge1xuICAvKipcbiAgICogTnVtYmVyIG9mIHJlc291cmNlcyB3aXRoIGRyaWZ0LiBJZiB1bmRlZmluZWQsIHRoZW4gYW4gZXJyb3Igb2NjdXJyZWRcbiAgICogYW5kIHJlc291cmNlcyB3ZXJlIG5vdCBwcm9wZXJseSBjaGVja2VkIGZvciBkcmlmdC5cbiAgICovXG4gIHJlYWRvbmx5IG51bVJlc291cmNlc1dpdGhEcmlmdDogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBIb3cgbWFueSByZXNvdXJjZXMgd2VyZSBub3QgY2hlY2tlZCBmb3IgZHJpZnQuIElmIHVuZGVmaW5lZCwgdGhlbiBhblxuICAgKiBlcnJvciBvY2N1cnJlZCBhbmQgcmVzb3VyY2VzIHdlcmUgbm90IHByb3Blcmx5IGNoZWNrZWQgZm9yIGRyaWZ0LlxuICAgKi9cbiAgcmVhZG9ubHkgbnVtUmVzb3VyY2VzVW5jaGVja2VkOiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIFJlc291cmNlcyB0aGF0IGhhdmUgbm90IGNoYW5nZWRcbiAgICovXG4gIHJlYWRvbmx5IHVuY2hhbmdlZD86IHN0cmluZztcblxuICAvKipcbiAgICogUmVzb3VyY2VzIHRoYXQgd2VyZSBub3QgY2hlY2tlZCBmb3IgZHJpZnRcbiAgICovXG4gIHJlYWRvbmx5IHVuY2hlY2tlZD86IHN0cmluZztcblxuICAvKipcbiAgICogUmVzb3VyY2VzIHdpdGggZHJpZnRcbiAgICovXG4gIHJlYWRvbmx5IG1vZGlmaWVkPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBSZXNvdXJjZXMgdGhhdCBoYXZlIGJlZW4gZGVsZXRlZCAoZHJpZnQpXG4gICAqL1xuICByZWFkb25seSBkZWxldGVkPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgaGVhZGVyLCBjb250YWluaW5nIHRoZSBzdGFjayBuYW1lXG4gICAqL1xuICByZWFkb25seSBzdGFja0hlYWRlcjogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgZmluYWwgcmVzdWx0cyAoc3VtbWFyeSkgb2YgdGhlIGRyaWZ0IHJlc3VsdHNcbiAgICovXG4gIHJlYWRvbmx5IHN1bW1hcnk6IHN0cmluZztcbn1cblxuLyoqXG4gKiBDbGFzcyBmb3IgZm9ybWF0dGluZyBkcmlmdCBkZXRlY3Rpb24gb3V0cHV0XG4gKi9cbmV4cG9ydCBjbGFzcyBEcmlmdEZvcm1hdHRlciB7XG4gIHB1YmxpYyByZWFkb25seSBzdGFja05hbWU6IHN0cmluZztcblxuICBwcml2YXRlIHJlYWRvbmx5IHN0YWNrOiBjeGFwaS5DbG91ZEZvcm1hdGlvblN0YWNrQXJ0aWZhY3Q7XG4gIHByaXZhdGUgcmVhZG9ubHkgcmVzb3VyY2VEcmlmdFJlc3VsdHM6IFN0YWNrUmVzb3VyY2VEcmlmdFtdO1xuICBwcml2YXRlIHJlYWRvbmx5IGFsbFN0YWNrUmVzb3VyY2VzOiBNYXA8c3RyaW5nLCBzdHJpbmc+O1xuXG4gIGNvbnN0cnVjdG9yKHByb3BzOiBEcmlmdEZvcm1hdHRlclByb3BzKSB7XG4gICAgdGhpcy5zdGFjayA9IHByb3BzLnN0YWNrO1xuICAgIHRoaXMuc3RhY2tOYW1lID0gcHJvcHMuc3RhY2suZGlzcGxheU5hbWUgPz8gcHJvcHMuc3RhY2suc3RhY2tOYW1lO1xuICAgIHRoaXMucmVzb3VyY2VEcmlmdFJlc3VsdHMgPSBwcm9wcy5yZXNvdXJjZURyaWZ0cztcblxuICAgIHRoaXMuYWxsU3RhY2tSZXNvdXJjZXMgPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nPigpO1xuICAgIE9iamVjdC5rZXlzKHRoaXMuc3RhY2sudGVtcGxhdGUuUmVzb3VyY2VzIHx8IHt9KS5mb3JFYWNoKGlkID0+IHtcbiAgICAgIGNvbnN0IHJlc291cmNlID0gdGhpcy5zdGFjay50ZW1wbGF0ZS5SZXNvdXJjZXNbaWRdO1xuICAgICAgLy8gYWx3YXlzIGlnbm9yZSB0aGUgbWV0YWRhdGEgcmVzb3VyY2VcbiAgICAgIGlmIChyZXNvdXJjZS5UeXBlID09PSAnQVdTOjpDREs6Ok1ldGFkYXRhJykge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICB0aGlzLmFsbFN0YWNrUmVzb3VyY2VzLnNldChpZCwgcmVzb3VyY2UuVHlwZSk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogRm9ybWF0IHRoZSBzdGFjayBkcmlmdCBkZXRlY3Rpb24gcmVzdWx0c1xuICAgKi9cbiAgcHVibGljIGZvcm1hdFN0YWNrRHJpZnQoKTogRHJpZnRGb3JtYXR0ZXJPdXRwdXQge1xuICAgIGNvbnN0IGZvcm1hdHRlck91dHB1dCA9IHRoaXMuZm9ybWF0U3RhY2tEcmlmdENoYW5nZXModGhpcy5idWlsZExvZ2ljYWxUb1BhdGhNYXAoKSk7XG5cbiAgICAvLyB3ZSBhcmUgb25seSBpbnRlcmVzdGVkIGluIGFjdHVhbCBkcmlmdHMgYW5kIGFsd2F5cyBpZ25vcmUgdGhlIG1ldGFkYXRhIHJlc291cmNlXG4gICAgY29uc3QgYWN0dWFsRHJpZnRzID0gdGhpcy5yZXNvdXJjZURyaWZ0UmVzdWx0cy5maWx0ZXIoZCA9PlxuICAgICAgZC5TdGFja1Jlc291cmNlRHJpZnRTdGF0dXMgPT09ICdNT0RJRklFRCcgfHxcbiAgICAgIGQuU3RhY2tSZXNvdXJjZURyaWZ0U3RhdHVzID09PSAnREVMRVRFRCcgfHxcbiAgICAgIGQuUmVzb3VyY2VUeXBlID09PSAnQVdTOjpDREs6Ok1ldGFkYXRhJyxcbiAgICApO1xuXG4gICAgLy8gbXVzdCBvdXRwdXQgdGhlIHN0YWNrIG5hbWUgaWYgdGhlcmUgYXJlIGRyaWZ0c1xuICAgIGNvbnN0IHN0YWNrSGVhZGVyID0gZm9ybWF0KGBTdGFjayAke2NoYWxrLmJvbGQodGhpcy5zdGFja05hbWUpfVxcbmApO1xuXG4gICAgaWYgKGFjdHVhbERyaWZ0cy5sZW5ndGggPT09IDApIHtcbiAgICAgIGNvbnN0IGZpbmFsUmVzdWx0ID0gY2hhbGsuZ3JlZW4oJ05vIGRyaWZ0IGRldGVjdGVkXFxuJyk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBudW1SZXNvdXJjZXNXaXRoRHJpZnQ6IDAsXG4gICAgICAgIG51bVJlc291cmNlc1VuY2hlY2tlZDogdGhpcy5hbGxTdGFja1Jlc291cmNlcy5zaXplIC0gdGhpcy5yZXNvdXJjZURyaWZ0UmVzdWx0cy5sZW5ndGgsXG4gICAgICAgIHN0YWNrSGVhZGVyLFxuICAgICAgICBzdW1tYXJ5OiBmaW5hbFJlc3VsdCxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3QgZmluYWxSZXN1bHQgPSBjaGFsay55ZWxsb3coYFxcbiR7YWN0dWFsRHJpZnRzLmxlbmd0aH0gcmVzb3VyY2Uke2FjdHVhbERyaWZ0cy5sZW5ndGggPT09IDEgPyAnJyA6ICdzJ30gJHthY3R1YWxEcmlmdHMubGVuZ3RoID09PSAxID8gJ2hhcycgOiAnaGF2ZSd9IGRyaWZ0ZWQgZnJvbSB0aGVpciBleHBlY3RlZCBjb25maWd1cmF0aW9uXFxuYCk7XG4gICAgcmV0dXJuIHtcbiAgICAgIG51bVJlc291cmNlc1dpdGhEcmlmdDogYWN0dWFsRHJpZnRzLmxlbmd0aCxcbiAgICAgIG51bVJlc291cmNlc1VuY2hlY2tlZDogdGhpcy5hbGxTdGFja1Jlc291cmNlcy5zaXplIC0gdGhpcy5yZXNvdXJjZURyaWZ0UmVzdWx0cy5sZW5ndGgsXG4gICAgICBzdGFja0hlYWRlcixcbiAgICAgIHVuY2hhbmdlZDogZm9ybWF0dGVyT3V0cHV0LnVuY2hhbmdlZCxcbiAgICAgIHVuY2hlY2tlZDogZm9ybWF0dGVyT3V0cHV0LnVuY2hlY2tlZCxcbiAgICAgIG1vZGlmaWVkOiBmb3JtYXR0ZXJPdXRwdXQubW9kaWZpZWQsXG4gICAgICBkZWxldGVkOiBmb3JtYXR0ZXJPdXRwdXQuZGVsZXRlZCxcbiAgICAgIHN1bW1hcnk6IGZpbmFsUmVzdWx0LFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkTG9naWNhbFRvUGF0aE1hcCgpIHtcbiAgICBjb25zdCBtYXA6IHsgW2lkOiBzdHJpbmddOiBzdHJpbmcgfSA9IHt9O1xuICAgIGZvciAoY29uc3QgbWQgb2YgdGhpcy5zdGFjay5maW5kTWV0YWRhdGFCeVR5cGUoY3hzY2hlbWEuQXJ0aWZhY3RNZXRhZGF0YUVudHJ5VHlwZS5MT0dJQ0FMX0lEKSkge1xuICAgICAgbWFwW21kLmRhdGEgYXMgc3RyaW5nXSA9IG1kLnBhdGg7XG4gICAgfVxuICAgIHJldHVybiBtYXA7XG4gIH1cblxuICAvKipcbiAgICogUmVuZGVycyBzdGFjayBkcmlmdCBpbmZvcm1hdGlvbiB0byB0aGUgZ2l2ZW4gc3RyZWFtXG4gICAqXG4gICAqIEBwYXJhbSBkcmlmdFJlc3VsdHMgLSBUaGUgc3RhY2sgcmVzb3VyY2UgZHJpZnRzIGZyb20gQ2xvdWRGb3JtYXRpb25cbiAgICogQHBhcmFtIGFsbFN0YWNrUmVzb3VyY2VzIC0gQSBtYXAgb2YgYWxsIHN0YWNrIHJlc291cmNlc1xuICAgKiBAcGFyYW0gdmVyYm9zZSAtIFdoZXRoZXIgdG8gb3V0cHV0IG1vcmUgdmVyYm9zZSB0ZXh0IChpbmNsdWRlIHVuZHJpZnRlZCByZXNvdXJjZXMpXG4gICAqIEBwYXJhbSBsb2dpY2FsVG9QYXRoTWFwIC0gQSBtYXAgZnJvbSBsb2dpY2FsIElEIHRvIGNvbnN0cnVjdCBwYXRoXG4gICAqL1xuICBwcml2YXRlIGZvcm1hdFN0YWNrRHJpZnRDaGFuZ2VzKFxuICAgIGxvZ2ljYWxUb1BhdGhNYXA6IHsgW2xvZ2ljYWxJZDogc3RyaW5nXTogc3RyaW5nIH0gPSB7fSk6IEZvcm1hdHRlZERyaWZ0IHtcbiAgICBpZiAodGhpcy5yZXNvdXJjZURyaWZ0UmVzdWx0cy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiB7fTtcbiAgICB9XG5cbiAgICBsZXQgdW5jaGFuZ2VkO1xuICAgIGxldCB1bmNoZWNrZWQ7XG4gICAgbGV0IG1vZGlmaWVkO1xuICAgIGxldCBkZWxldGVkO1xuXG4gICAgY29uc3QgZHJpZnRzID0gdGhpcy5yZXNvdXJjZURyaWZ0UmVzdWx0cztcblxuICAgIC8vIFByb2Nlc3MgdW5jaGFuZ2VkIHJlc291cmNlc1xuICAgIGNvbnN0IHVuY2hhbmdlZFJlc291cmNlcyA9IGRyaWZ0cy5maWx0ZXIoZCA9PiBkLlN0YWNrUmVzb3VyY2VEcmlmdFN0YXR1cyA9PT0gU3RhY2tSZXNvdXJjZURyaWZ0U3RhdHVzLklOX1NZTkMpO1xuICAgIGlmICh1bmNoYW5nZWRSZXNvdXJjZXMubGVuZ3RoID4gMCkge1xuICAgICAgdW5jaGFuZ2VkID0gdGhpcy5wcmludFNlY3Rpb25IZWFkZXIoJ1Jlc291cmNlcyBJbiBTeW5jJyk7XG5cbiAgICAgIGZvciAoY29uc3QgZHJpZnQgb2YgdW5jaGFuZ2VkUmVzb3VyY2VzKSB7XG4gICAgICAgIGlmICghZHJpZnQuTG9naWNhbFJlc291cmNlSWQgfHwgIWRyaWZ0LlJlc291cmNlVHlwZSkgY29udGludWU7XG4gICAgICAgIHVuY2hhbmdlZCArPSBgJHtDT05URVhUfSAke3RoaXMuZm9ybWF0VmFsdWUoZHJpZnQuUmVzb3VyY2VUeXBlLCBjaGFsay5jeWFuKX0gJHt0aGlzLmZvcm1hdExvZ2ljYWxJZChsb2dpY2FsVG9QYXRoTWFwLCBkcmlmdC5Mb2dpY2FsUmVzb3VyY2VJZCl9XFxuYDtcbiAgICAgIH1cbiAgICAgIHVuY2hhbmdlZCArPSB0aGlzLnByaW50U2VjdGlvbkZvb3RlcigpO1xuICAgIH1cblxuICAgIC8vIFByb2Nlc3MgYWxsIHVuY2hlY2tlZCByZXNvdXJjZXNcbiAgICBpZiAodGhpcy5hbGxTdGFja1Jlc291cmNlcykge1xuICAgICAgY29uc3QgdW5jaGVja2VkUmVzb3VyY2VzID0gQXJyYXkuZnJvbSh0aGlzLmFsbFN0YWNrUmVzb3VyY2VzLmtleXMoKSkuZmlsdGVyKChsb2dpY2FsSWQpID0+IHtcbiAgICAgICAgcmV0dXJuICFkcmlmdHMuZmluZCgoZHJpZnQpID0+IGRyaWZ0LkxvZ2ljYWxSZXNvdXJjZUlkID09PSBsb2dpY2FsSWQpO1xuICAgICAgfSk7XG4gICAgICBpZiAodW5jaGVja2VkUmVzb3VyY2VzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgdW5jaGVja2VkID0gdGhpcy5wcmludFNlY3Rpb25IZWFkZXIoJ1VuY2hlY2tlZCBSZXNvdXJjZXMnKTtcbiAgICAgICAgZm9yIChjb25zdCBsb2dpY2FsSWQgb2YgdW5jaGVja2VkUmVzb3VyY2VzKSB7XG4gICAgICAgICAgY29uc3QgcmVzb3VyY2VUeXBlID0gdGhpcy5hbGxTdGFja1Jlc291cmNlcy5nZXQobG9naWNhbElkKTtcbiAgICAgICAgICB1bmNoZWNrZWQgKz0gYCR7Q09OVEVYVH0gJHt0aGlzLmZvcm1hdFZhbHVlKHJlc291cmNlVHlwZSwgY2hhbGsuY3lhbil9ICR7dGhpcy5mb3JtYXRMb2dpY2FsSWQobG9naWNhbFRvUGF0aE1hcCwgbG9naWNhbElkKX1cXG5gO1xuICAgICAgICB9XG4gICAgICAgIHVuY2hlY2tlZCArPSB0aGlzLnByaW50U2VjdGlvbkZvb3RlcigpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIFByb2Nlc3MgbW9kaWZpZWQgcmVzb3VyY2VzXG4gICAgY29uc3QgbW9kaWZpZWRSZXNvdXJjZXMgPSBkcmlmdHMuZmlsdGVyKGQgPT4gZC5TdGFja1Jlc291cmNlRHJpZnRTdGF0dXMgPT09IFN0YWNrUmVzb3VyY2VEcmlmdFN0YXR1cy5NT0RJRklFRCk7XG4gICAgaWYgKG1vZGlmaWVkUmVzb3VyY2VzLmxlbmd0aCA+IDApIHtcbiAgICAgIG1vZGlmaWVkID0gdGhpcy5wcmludFNlY3Rpb25IZWFkZXIoJ01vZGlmaWVkIFJlc291cmNlcycpO1xuXG4gICAgICBmb3IgKGNvbnN0IGRyaWZ0IG9mIG1vZGlmaWVkUmVzb3VyY2VzKSB7XG4gICAgICAgIGlmICghZHJpZnQuTG9naWNhbFJlc291cmNlSWQgfHwgIWRyaWZ0LlJlc291cmNlVHlwZSkgY29udGludWU7XG4gICAgICAgIGlmIChtb2RpZmllZCA9PT0gdW5kZWZpbmVkKSBtb2RpZmllZCA9ICcnO1xuICAgICAgICBtb2RpZmllZCArPSBgJHtVUERBVEV9ICR7dGhpcy5mb3JtYXRWYWx1ZShkcmlmdC5SZXNvdXJjZVR5cGUsIGNoYWxrLmN5YW4pfSAke3RoaXMuZm9ybWF0TG9naWNhbElkKGxvZ2ljYWxUb1BhdGhNYXAsIGRyaWZ0LkxvZ2ljYWxSZXNvdXJjZUlkKX1cXG5gO1xuICAgICAgICBpZiAoZHJpZnQuUHJvcGVydHlEaWZmZXJlbmNlcykge1xuICAgICAgICAgIGNvbnN0IHByb3BEaWZmcyA9IGRyaWZ0LlByb3BlcnR5RGlmZmVyZW5jZXM7XG4gICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwcm9wRGlmZnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGNvbnN0IGRpZmYgPSBwcm9wRGlmZnNbaV07XG4gICAgICAgICAgICBpZiAoIWRpZmYuUHJvcGVydHlQYXRoKSBjb250aW51ZTtcbiAgICAgICAgICAgIGNvbnN0IGRpZmZlcmVuY2UgPSBuZXcgRGlmZmVyZW5jZShkaWZmLkV4cGVjdGVkVmFsdWUsIGRpZmYuQWN0dWFsVmFsdWUpO1xuICAgICAgICAgICAgbW9kaWZpZWQgKz0gdGhpcy5mb3JtYXRUcmVlRGlmZihkaWZmLlByb3BlcnR5UGF0aCwgZGlmZmVyZW5jZSwgaSA9PT0gcHJvcERpZmZzLmxlbmd0aCAtIDEpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgbW9kaWZpZWQgKz0gdGhpcy5wcmludFNlY3Rpb25Gb290ZXIoKTtcbiAgICB9XG5cbiAgICAvLyBQcm9jZXNzIGRlbGV0ZWQgcmVzb3VyY2VzXG4gICAgY29uc3QgZGVsZXRlZFJlc291cmNlcyA9IGRyaWZ0cy5maWx0ZXIoZCA9PiBkLlN0YWNrUmVzb3VyY2VEcmlmdFN0YXR1cyA9PT0gU3RhY2tSZXNvdXJjZURyaWZ0U3RhdHVzLkRFTEVURUQpO1xuICAgIGlmIChkZWxldGVkUmVzb3VyY2VzLmxlbmd0aCA+IDApIHtcbiAgICAgIGRlbGV0ZWQgPSB0aGlzLnByaW50U2VjdGlvbkhlYWRlcignRGVsZXRlZCBSZXNvdXJjZXMnKTtcbiAgICAgIGZvciAoY29uc3QgZHJpZnQgb2YgZGVsZXRlZFJlc291cmNlcykge1xuICAgICAgICBpZiAoIWRyaWZ0LkxvZ2ljYWxSZXNvdXJjZUlkIHx8ICFkcmlmdC5SZXNvdXJjZVR5cGUpIGNvbnRpbnVlO1xuICAgICAgICBkZWxldGVkICs9IGAke1JFTU9WQUx9ICR7dGhpcy5mb3JtYXRWYWx1ZShkcmlmdC5SZXNvdXJjZVR5cGUsIGNoYWxrLmN5YW4pfSAke3RoaXMuZm9ybWF0TG9naWNhbElkKGxvZ2ljYWxUb1BhdGhNYXAsIGRyaWZ0LkxvZ2ljYWxSZXNvdXJjZUlkKX1cXG5gO1xuICAgICAgfVxuICAgICAgZGVsZXRlZCArPSB0aGlzLnByaW50U2VjdGlvbkZvb3RlcigpO1xuICAgIH1cblxuICAgIHJldHVybiB7IHVuY2hhbmdlZCwgdW5jaGVja2VkLCBtb2RpZmllZCwgZGVsZXRlZCB9O1xuICB9XG5cbiAgcHJpdmF0ZSBmb3JtYXRMb2dpY2FsSWQobG9naWNhbFRvUGF0aE1hcDogeyBbbG9naWNhbElkOiBzdHJpbmddOiBzdHJpbmcgfSwgbG9naWNhbElkOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGNvbnN0IHBhdGggPSBsb2dpY2FsVG9QYXRoTWFwW2xvZ2ljYWxJZF07XG4gICAgaWYgKCFwYXRoKSByZXR1cm4gbG9naWNhbElkO1xuXG4gICAgbGV0IG5vcm1hbGl6ZWRQYXRoID0gcGF0aDtcbiAgICBpZiAobm9ybWFsaXplZFBhdGguc3RhcnRzV2l0aCgnLycpKSB7XG4gICAgICBub3JtYWxpemVkUGF0aCA9IG5vcm1hbGl6ZWRQYXRoLnNsaWNlKDEpO1xuICAgIH1cblxuICAgIGxldCBwYXJ0cyA9IG5vcm1hbGl6ZWRQYXRoLnNwbGl0KCcvJyk7XG4gICAgaWYgKHBhcnRzLmxlbmd0aCA+IDEpIHtcbiAgICAgIHBhcnRzID0gcGFydHMuc2xpY2UoMSk7XG5cbiAgICAgIC8vIHJlbW92ZSB0aGUgbGFzdCBjb21wb25lbnQgaWYgaXQncyBcIlJlc291cmNlXCIgb3IgXCJEZWZhdWx0XCIgKGlmIHdlIGhhdmUgbW9yZSB0aGFuIGEgc2luZ2xlIGNvbXBvbmVudClcbiAgICAgIGlmIChwYXJ0cy5sZW5ndGggPiAxKSB7XG4gICAgICAgIGNvbnN0IGxhc3QgPSBwYXJ0c1twYXJ0cy5sZW5ndGggLSAxXTtcbiAgICAgICAgaWYgKGxhc3QgPT09ICdSZXNvdXJjZScgfHwgbGFzdCA9PT0gJ0RlZmF1bHQnKSB7XG4gICAgICAgICAgcGFydHMgPSBwYXJ0cy5zbGljZSgwLCBwYXJ0cy5sZW5ndGggLSAxKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBub3JtYWxpemVkUGF0aCA9IHBhcnRzLmpvaW4oJy8nKTtcbiAgICB9XG5cbiAgICByZXR1cm4gYCR7bm9ybWFsaXplZFBhdGh9ICR7Y2hhbGsuZ3JheShsb2dpY2FsSWQpfWA7XG4gIH1cblxuICBwcml2YXRlIGZvcm1hdFZhbHVlKHZhbHVlOiBhbnksIGNvbG9yRm46IChzdHI6IHN0cmluZykgPT4gc3RyaW5nKTogc3RyaW5nIHtcbiAgICBpZiAodmFsdWUgPT0gbnVsbCkge1xuICAgICAgcmV0dXJuICcnO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuIGNvbG9yRm4odmFsdWUpO1xuICAgIH1cbiAgICByZXR1cm4gY29sb3JGbihKU09OLnN0cmluZ2lmeSh2YWx1ZSkpO1xuICB9XG5cbiAgcHJpdmF0ZSBwcmludFNlY3Rpb25IZWFkZXIodGl0bGU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGAke2NoYWxrLnVuZGVybGluZShjaGFsay5ib2xkKHRpdGxlKSl9XFxuYDtcbiAgfVxuXG4gIHByaXZhdGUgcHJpbnRTZWN0aW9uRm9vdGVyKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuICdcXG4nO1xuICB9XG5cbiAgcHJpdmF0ZSBmb3JtYXRUcmVlRGlmZihwcm9wZXJ0eVBhdGg6IHN0cmluZywgZGlmZmVyZW5jZTogRGlmZmVyZW5jZTxhbnk+LCBpc0xhc3Q6IGJvb2xlYW4pOiBzdHJpbmcge1xuICAgIGxldCByZXN1bHQgPSBmb3JtYXQoJyAlc+KUgCAlcyAlc1xcbicsIGlzTGFzdCA/ICfilJQnIDogJ+KUnCcsXG4gICAgICBkaWZmZXJlbmNlLmlzQWRkaXRpb24gPyBBRERJVElPTiA6XG4gICAgICAgIGRpZmZlcmVuY2UuaXNSZW1vdmFsID8gUkVNT1ZBTCA6XG4gICAgICAgICAgVVBEQVRFLFxuICAgICAgcHJvcGVydHlQYXRoLFxuICAgICk7XG4gICAgaWYgKGRpZmZlcmVuY2UuaXNVcGRhdGUpIHtcbiAgICAgIHJlc3VsdCArPSBmb3JtYXQoJyAgICAg4pSc4pSAICVzICVzXFxuJywgUkVNT1ZBTCwgdGhpcy5mb3JtYXRWYWx1ZShkaWZmZXJlbmNlLm9sZFZhbHVlLCBjaGFsay5yZWQpKTtcbiAgICAgIHJlc3VsdCArPSBmb3JtYXQoJyAgICAg4pSU4pSAICVzICVzXFxuJywgQURESVRJT04sIHRoaXMuZm9ybWF0VmFsdWUoZGlmZmVyZW5jZS5uZXdWYWx1ZSwgY2hhbGsuZ3JlZW4pKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxufVxuXG5jb25zdCBBRERJVElPTiA9IGNoYWxrLmdyZWVuKCdbK10nKTtcbmNvbnN0IENPTlRFWFQgPSBjaGFsay5ncmV5KCdbIF0nKTtcbmNvbnN0IFVQREFURSA9IGNoYWxrLnllbGxvdygnW35dJyk7XG5jb25zdCBSRU1PVkFMID0gY2hhbGsucmVkKCdbLV0nKTtcbiJdfQ==